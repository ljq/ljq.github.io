<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jaco Liu Personal Site (ljq@GitHub).å®‰å…¨è´¯ç©¿äºè½¯ä»¶å¼€å‘å„ä¸ªç¯èŠ‚.</title>
  
  <subtitle>Jaco Liu Personal Site (ljq@GitHub)</subtitle>
  <link href="https://www.wdft.com/atom.xml" rel="self"/>
  
  <link href="https://www.wdft.com/"/>
  <updated>2026-02-05T09:31:30.173Z</updated>
  <id>https://www.wdft.com/</id>
  
  <author>
    <name>Jaco Liu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title></title>
    <link href="https://www.wdft.com/0.html"/>
    <id>https://www.wdft.com/0.html</id>
    <published>2026-02-05T07:39:16.203Z</published>
    <updated>2026-02-05T09:31:30.173Z</updated>
    
    
    
    
    
  </entry>
  
  <entry>
    <title>ã€sortã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“sortåŒ…è®¾è®¡åŸç†ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/9a6c398f.html"/>
    <id>https://www.wdft.com/9a6c398f.html</id>
    <published>2026-02-01T15:27:31.000Z</published>
    <updated>2026-02-02T18:20:20.364Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€sort-åŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°æ€»è§ˆå›¾"><a href="#ä¸€ã€sort-åŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°æ€»è§ˆå›¾" class="headerlink" title="ä¸€ã€sort åŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°æ€»è§ˆå›¾"></a>ä¸€ã€sort åŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°æ€»è§ˆå›¾</h2><p>sort åŒ…é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œæ ¸å¿ƒå›´ç»• <code>Interface</code> æ¥å£æ„å»ºé€šç”¨æ’åºèƒ½åŠ›ï¼ŒåŒæ—¶æä¾›é’ˆå¯¹åŸºæœ¬ç±»å‹çš„ä¼˜åŒ–å®ç°ã€‚ä¸‹å›¾å®Œæ•´å±•ç¤ºäº† sort åŒ…çš„å‡½æ•°ä½“ç³»åŠä¸­æ–‡åŠŸèƒ½è¯´æ˜ï¼š</p><span id="more"></span><pre class="mermaid">graph LR    A1["NewSource"] --> A2["Int63"]    A1 --> A3["Seed"]    B1["New"] --> B2["Int63"]    B1 --> B3["Int31"]    B1 --> B4["Float64"]    B1 --> B5["NormFloat64"]    B1 --> B6["ExpFloat64"]    B1 --> B7["Shuffle"]    B1 --> B8["Perm"]    B1 --> B9["Intn"]    B1 --> B10["Int31n"]    B1 --> B11["Readâ˜…"]    C1["Intn"] --> C2["Float64"]    C1 --> C3["Int"]    C1 --> C4["Int31"]    C1 --> C5["Int63"]    C1 --> C6["Seed"]    C1 --> C7["Shuffle"]    C1 --> C8["Perm"]    A2 --> B1    A3 --> B1    B2 --> C1    B3 --> C1    B4 --> C2    B9 --> C1    B10 --> C1</pre><h2 id="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"><a href="#äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ" class="headerlink" title="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"></a>äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ</h2><h3 id="2-1-æ’åºç®—æ³•æ¼”è¿›ï¼šä»-QuickSort-åˆ°-PDQSort"><a href="#2-1-æ’åºç®—æ³•æ¼”è¿›ï¼šä»-QuickSort-åˆ°-PDQSort" class="headerlink" title="2.1 æ’åºç®—æ³•æ¼”è¿›ï¼šä» QuickSort åˆ° PDQSort"></a>2.1 æ’åºç®—æ³•æ¼”è¿›ï¼šä» QuickSort åˆ° PDQSort</h3><p>Go 1.22+ ç‰ˆæœ¬å°†åº•å±‚æ’åºç®—æ³•ä»ä¼ ç»Ÿå¿«é€Ÿæ’åºå‡çº§ä¸º <strong>PDQSortï¼ˆPattern-Defeating QuickSortï¼‰</strong>ï¼Œè¿™æ˜¯ç”Ÿäº§çº§æ’åºçš„å…³é”®ä¼˜åŒ–ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç å±•ç¤º PDQSort æ ¸å¿ƒé€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pdqsort</span><span class="params">(data Interface, a, b, maxDepth <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> b-a &gt; <span class="number">12</span> &#123; <span class="comment">// å°æ•°ç»„ä½¿ç”¨æ’å…¥æ’åº</span></span><br><span class="line">        <span class="keyword">if</span> maxDepth == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// æ·±åº¦è¶…é™æ—¶åˆ‡æ¢ä¸ºå †æ’åºï¼Œé¿å…O(nÂ²)æœ€åæƒ…å†µ</span></span><br><span class="line">            heapsort(data, a, b)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        maxDepth--</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸‰è·¯åˆ’åˆ† + ä»‹è´¨é€‰æ‹©ï¼ˆmedian-of-threeï¼‰</span></span><br><span class="line">        pivot := medianOfThree(data, a, (a+b)/<span class="number">2</span>, b<span class="number">-1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æµ‹é‡å¤å…ƒç´ æ¨¡å¼ï¼Œè§¦å‘å—çŠ¶æ’åºä¼˜åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> isMostlySorted(data, a, b) &#123;</span><br><span class="line">            insertionSort(data, a, b)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†åŒºå¹¶é€’å½’</span></span><br><span class="line">        left, right := partition(data, a, b, pivot)</span><br><span class="line">        pdqsort(data, a, left, maxDepth)</span><br><span class="line">        a = right <span class="comment">// å°¾é€’å½’ä¼˜åŒ–</span></span><br><span class="line">    &#125;</span><br><span class="line">    insertionSort(data, a, b) <span class="comment">// å°æ•°ç»„æœ€ç»ˆä½¿ç”¨æ’å…¥æ’åº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>PDQSort ä¸‰å¤§ä¼˜åŠ¿</strong>ï¼š</p><ol><li><strong>æœ€åæƒ…å†µä¿éšœ</strong>ï¼šé€šè¿‡æ·±åº¦é™åˆ¶è‡ªåŠ¨åˆ‡æ¢å †æ’åºï¼Œæ—¶é—´å¤æ‚åº¦ç¨³å®šåœ¨ O(n log n)</li><li><strong>æ¨¡å¼è¯†åˆ«</strong>ï¼šæ£€æµ‹å·²æ’åº&#x2F;é€†åº&#x2F;é‡å¤å…ƒç´ æ¨¡å¼ï¼Œé’ˆå¯¹æ€§ä¼˜åŒ–ï¼ˆå¦‚å—çŠ¶æ’åºï¼‰</li><li><strong>ç¼“å­˜å‹å¥½</strong>ï¼šåˆ†åŒºç­–ç•¥ä¼˜åŒ–å†…å­˜å±€éƒ¨æ€§ï¼Œæ¯”ä¼ ç»Ÿå¿«æ’å¿« 20%~40%</li></ol><p>âš ï¸ æ³¨æ„ï¼š<code>sort.Sort</code> ä½¿ç”¨ PDQSortï¼ˆéç¨³å®šï¼‰ï¼Œ<code>sort.Stable</code> ä»ä½¿ç”¨å½’å¹¶æ’åºï¼ˆç¨³å®šä½†ç¨æ…¢ï¼‰</p><h3 id="2-2-ç¨³å®šæ’åºçš„ä»£ä»·ä¸é€‰æ‹©"><a href="#2-2-ç¨³å®šæ’åºçš„ä»£ä»·ä¸é€‰æ‹©" class="headerlink" title="2.2 ç¨³å®šæ’åºçš„ä»£ä»·ä¸é€‰æ‹©"></a>2.2 ç¨³å®šæ’åºçš„ä»£ä»·ä¸é€‰æ‹©</h3><p>ç¨³å®šæ’åºè¦æ±‚ï¼š<strong>ç›¸ç­‰å…ƒç´ çš„ç›¸å¯¹é¡ºåºåœ¨æ’åºå‰åä¿æŒä¸å˜</strong>ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹æ•°æ®: [&#123;name:&quot;Alice&quot;, age:30&#125;, &#123;name:&quot;Bob&quot;, age:30&#125;, &#123;name:&quot;Charlie&quot;, age:25&#125;]</span></span><br><span class="line"><span class="comment">// æŒ‰ age æ’åºå:</span></span><br><span class="line"><span class="comment">// éç¨³å®š: [&#123;Charlie,25&#125;, &#123;Bob,30&#125;, &#123;Alice,30&#125;]  // Bob å’Œ Alice é¡ºåºå¯èƒ½äº’æ¢</span></span><br><span class="line"><span class="comment">// ç¨³å®š:   [&#123;Charlie,25&#125;, &#123;Alice,30&#125;, &#123;Bob,30&#125;]   // ä¿æŒåŸå§‹ç›¸å¯¹é¡ºåº</span></span><br></pre></td></tr></table></figure><p><strong>ä½•æ—¶å¿…é¡»ç”¨ç¨³å®šæ’åº</strong>ï¼š</p><ul><li>å¤šçº§æ’åºï¼ˆå…ˆæŒ‰ A å­—æ®µæ’ï¼Œå†æŒ‰ B å­—æ®µæ’ï¼‰</li><li>ä¿æŒä¸šåŠ¡é€»è¾‘ä¸­çš„æ—¶åºå…³ç³»ï¼ˆå¦‚æ—¥å¿—æŒ‰æ—¶é—´+IDæ’åºï¼‰</li><li>æ¶‰åŠæµ®ç‚¹æ•°ç²¾åº¦æ¯”è¾ƒï¼ˆé¿å…èˆå…¥è¯¯å·®å¯¼è‡´é¡ºåºé¢ å€’ï¼‰</li></ul><p><strong>æ€§èƒ½å¯¹æ¯”</strong>ï¼ˆ100 ä¸‡å…ƒç´ åŸºå‡†æµ‹è¯•ï¼‰ï¼š</p><table><thead><tr><th>åœºæ™¯</th><th><code>Sort</code> (PDQSort)</th><th><code>Stable</code> (å½’å¹¶)</th><th>å·®å¼‚</th></tr></thead><tbody><tr><td>éšæœºæ•°æ®</td><td>120ms</td><td>180ms</td><td>+50%</td></tr><tr><td>å·²æ’åºæ•°æ®</td><td>8ms</td><td>45ms</td><td>+460%</td></tr><tr><td>é€†åºæ•°æ®</td><td>15ms</td><td>50ms</td><td>+233%</td></tr></tbody></table><p>ğŸ’¡ æœ€ä½³å®è·µï¼šé»˜è®¤ç”¨ <code>Sort</code>ï¼Œä»…åœ¨æ˜ç¡®éœ€è¦ç¨³å®šæ€§æ—¶ç”¨ <code>Stable</code>ï¼Œé¿å…æ— è°“æ€§èƒ½æŸå¤±</p><h3 id="2-3-äºŒåˆ†æŸ¥æ‰¾çš„æ­£ç¡®å§¿åŠ¿ï¼šSearch-ä¸-Find"><a href="#2-3-äºŒåˆ†æŸ¥æ‰¾çš„æ­£ç¡®å§¿åŠ¿ï¼šSearch-ä¸-Find" class="headerlink" title="2.3 äºŒåˆ†æŸ¥æ‰¾çš„æ­£ç¡®å§¿åŠ¿ï¼šSearch ä¸ Find"></a>2.3 äºŒåˆ†æŸ¥æ‰¾çš„æ­£ç¡®å§¿åŠ¿ï¼šSearch ä¸ Find</h3><h4 id="2-3-1-sort-Search-çš„é™·é˜±"><a href="#2-3-1-sort-Search-çš„é™·é˜±" class="headerlink" title="2.3.1 sort.Search çš„é™·é˜±"></a>2.3.1 <code>sort.Search</code> çš„é™·é˜±</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç”¨æ³•ï¼šç›´æ¥æŸ¥æ‰¾å…ƒç´ </span></span><br><span class="line">index := sort.Search(<span class="built_in">len</span>(data), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data[i] == target <span class="comment">// âŒ é”™è¯¯ï¼åº”è¿”å› &gt;= target</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ç”¨æ³•ï¼šæŸ¥æ‰¾ç¬¬ä¸€ä¸ª &gt;= target çš„ä½ç½®</span></span><br><span class="line">index := sort.Search(<span class="built_in">len</span>(data), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data[i] &gt;= target</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> index &lt; <span class="built_in">len</span>(data) &amp;&amp; data[index] == target &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;æ‰¾åˆ°:&quot;</span>, index)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;æœªæ‰¾åˆ°ï¼Œåº”æ’å…¥ä½ç½®:&quot;</span>, index)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒåŸç†</strong>ï¼š<code>Search</code> è¿”å›æ»¡è¶³ <code>f(i) == true</code> çš„æœ€å°ç´¢å¼• <code>i</code>ï¼Œè¦æ±‚ <code>f</code> åœ¨ <code>[0, n)</code> ä¸Šå•è°ƒéé€’å‡</p><h4 id="2-3-2-sort-Findï¼ˆGo-1-21-ï¼‰æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ"><a href="#2-3-2-sort-Findï¼ˆGo-1-21-ï¼‰æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ" class="headerlink" title="2.3.2 sort.Findï¼ˆGo 1.21+ï¼‰æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ"></a>2.3.2 <code>sort.Find</code>ï¼ˆGo 1.21+ï¼‰æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmp(i) è¿”å›: -1(å°äº), 0(ç­‰äº), +1(å¤§äº)</span></span><br><span class="line">index, found := sort.Find(<span class="built_in">len</span>(data), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> data[i] &lt; target &#123; <span class="keyword">return</span> <span class="number">-1</span> &#125;</span><br><span class="line">    <span class="keyword">if</span> data[i] &gt; target &#123; <span class="keyword">return</span> +<span class="number">1</span> &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¼˜åŠ¿ï¼šè¯­ä¹‰æ›´æ¸…æ™°ï¼Œé¿å… <code>Search</code> çš„å¸ƒå°”é€»è¾‘é™·é˜±ï¼Œç›´æ¥è¿”å›æ˜¯å¦æ‰¾åˆ°</p><h2 id="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰"><a href="#ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰" class="headerlink" title="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰"></a>ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰</h2><h3 id="3-1-NaN-åœ¨æµ®ç‚¹æ’åºä¸­çš„ç‰¹æ®Šè¡Œä¸º"><a href="#3-1-NaN-åœ¨æµ®ç‚¹æ’åºä¸­çš„ç‰¹æ®Šè¡Œä¸º" class="headerlink" title="3.1 NaN åœ¨æµ®ç‚¹æ’åºä¸­çš„ç‰¹æ®Šè¡Œä¸º"></a>3.1 NaN åœ¨æµ®ç‚¹æ’åºä¸­çš„ç‰¹æ®Šè¡Œä¸º</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">data := []<span class="type">float64</span>&#123;<span class="number">3.0</span>, math.NaN(), <span class="number">1.0</span>, <span class="number">2.0</span>&#125;</span><br><span class="line">sort.Float64s(data)</span><br><span class="line"><span class="comment">// ç»“æœ: [NaN, 1, 2, 3]  // NaN è¢«ç½®äºæœ€å‰ï¼</span></span><br><span class="line">fmt.Println(sort.Float64sAreSorted(data)) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰æ’åºéœ€æ˜¾å¼å¤„ç† NaN</span></span><br><span class="line">sort.Slice(data, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> math.IsNaN(data[i]) &#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;  <span class="comment">// NaN æ”¾å‰é¢</span></span><br><span class="line">    <span class="keyword">if</span> math.IsNaN(data[j]) &#123; <span class="keyword">return</span> <span class="literal">false</span> &#125; <span class="comment">// NaN æ”¾å‰é¢</span></span><br><span class="line">    <span class="keyword">return</span> data[i] &lt; data[j]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>å°¤å…¶æ³¨æ„</strong>ï¼šâš ï¸ IEEE 754 è§„å®š NaN ä¸ä»»ä½•å€¼ï¼ˆåŒ…æ‹¬è‡ªèº«ï¼‰æ¯”è¾ƒå‡è¿”å› falseï¼Œæ ‡å‡†åº“å°†æ‰€æœ‰ NaN è§†ä¸ºâ€æœ€å°å€¼â€ç½®äºå¼€å¤´ï¼</p><h3 id="3-2-åå°„æ’åºï¼ˆSliceï¼‰çš„æ€§èƒ½ä»£ä»·"><a href="#3-2-åå°„æ’åºï¼ˆSliceï¼‰çš„æ€§èƒ½ä»£ä»·" class="headerlink" title="3.2 åå°„æ’åºï¼ˆSliceï¼‰çš„æ€§èƒ½ä»£ä»·"></a>3.2 åå°„æ’åºï¼ˆSliceï¼‰çš„æ€§èƒ½ä»£ä»·</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½å¯¹æ¯”ï¼ˆ100 ä¸‡ int å…ƒç´ ï¼‰</span></span><br><span class="line">sort.Ints(data)          <span class="comment">// 85ms  (ä¸“ç”¨å‡½æ•°ï¼Œæ— åå°„)</span></span><br><span class="line">sort.Sort(sort.IntSlice(data)) <span class="comment">// 92ms (ç±»å‹æ–­è¨€)</span></span><br><span class="line">sort.Slice(data, <span class="function"><span class="keyword">func</span><span class="params">(i,j <span class="type">int</span>)</span></span><span class="type">bool</span>&#123;<span class="keyword">return</span> data[i]&lt;data[j]&#125;) <span class="comment">// 145ms (+57%)</span></span><br></pre></td></tr></table></figure><p><strong>å»ºè®®</strong>ï¼š</p><ul><li>åŸºæœ¬ç±»å‹ä¼˜å…ˆç”¨ <code>Ints/Strings/Float64s</code></li><li>è‡ªå®šä¹‰ç±»å‹è‹¥é¢‘ç¹æ’åºï¼Œå®ç° <code>sort.Interface</code> æ¯” <code>Slice</code> å¿« 30%+</li><li>ä»…åœ¨ä¸´æ—¶æ’åºæˆ–é—­åŒ…éœ€æ•è·å¤–éƒ¨å˜é‡æ—¶ç”¨ <code>Slice</code></li></ul><h3 id="3-3-å¹¶å‘å®‰å…¨è­¦å‘Š"><a href="#3-3-å¹¶å‘å®‰å…¨è­¦å‘Š" class="headerlink" title="3.3 å¹¶å‘å®‰å…¨è­¦å‘Š"></a>3.3 å¹¶å‘å®‰å…¨è­¦å‘Š</h3><p><strong>sort åŒ…æ‰€æœ‰å‡½æ•°å‡éå¹¶å‘å®‰å…¨</strong>ï¼å¯¹åŒä¸€åˆ‡ç‰‡å¹¶å‘è°ƒç”¨æ’åºä¼šå¯¼è‡´æ•°æ®ç«äº‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å±é™©ä»£ç </span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">wg.Add(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; sort.Ints(data); wg.Done() &#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; sort.Sort(sort.Reverse(sort.IntSlice(data))); wg.Done() &#125;()</span><br><span class="line">wg.Wait() <span class="comment">// å¯èƒ½ panic æˆ–æ•°æ®æŸå</span></span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ol><li>æ’åºå‰å¤åˆ¶åˆ‡ç‰‡ï¼š<code>copyData := make([]int, len(data)); copy(copyData, data)</code></li><li>ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«åˆ‡ç‰‡</li><li>é‡‡ç”¨ channel ä¸²è¡ŒåŒ–æ’åºæ“ä½œ</li></ol><h2 id="å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹"><a href="#å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹" class="headerlink" title="å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹"></a>å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹</h2><h3 id="4-1-å¤šçº§æ’åºï¼šå…ˆæŒ‰éƒ¨é—¨ï¼Œå†æŒ‰è–ªèµ„é™åº"><a href="#4-1-å¤šçº§æ’åºï¼šå…ˆæŒ‰éƒ¨é—¨ï¼Œå†æŒ‰è–ªèµ„é™åº" class="headerlink" title="4.1 å¤šçº§æ’åºï¼šå…ˆæŒ‰éƒ¨é—¨ï¼Œå†æŒ‰è–ªèµ„é™åº"></a>4.1 å¤šçº§æ’åºï¼šå…ˆæŒ‰éƒ¨é—¨ï¼Œå†æŒ‰è–ªèµ„é™åº</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Employee <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name   <span class="type">string</span></span><br><span class="line">    Dept   <span class="type">string</span></span><br><span class="line">    Salary <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">employees := []Employee&#123;</span><br><span class="line">    &#123;<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Eng&quot;</span>, <span class="number">90000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Sales&quot;</span>, <span class="number">80000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Charlie&quot;</span>, <span class="string">&quot;Eng&quot;</span>, <span class="number">95000</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;David&quot;</span>, <span class="string">&quot;Sales&quot;</span>, <span class="number">85000</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ¡ˆ1ï¼šå®ç° Interfaceï¼ˆæ¨èï¼Œæ€§èƒ½æœ€ä¼˜ï¼‰</span></span><br><span class="line"><span class="keyword">type</span> ByDeptSalary []Employee</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e ByDeptSalary)</span></span> Len() <span class="type">int</span> &#123; <span class="keyword">return</span> <span class="built_in">len</span>(e) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e ByDeptSalary)</span></span> Swap(i, j <span class="type">int</span>) &#123; e[i], e[j] = e[j], e[i] &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e ByDeptSalary)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> e[i].Dept != e[j].Dept &#123;</span><br><span class="line">        <span class="keyword">return</span> e[i].Dept &lt; e[j].Dept <span class="comment">// éƒ¨é—¨å‡åº</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> e[i].Salary &gt; e[j].Salary <span class="comment">// è–ªèµ„é™åº</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sort.Stable(ByDeptSalary(employees)) <span class="comment">// å¿…é¡»ç”¨ Stable ä¿è¯äºŒçº§æ’åºæœ‰æ•ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ¡ˆ2ï¼šä¸¤æ¬¡ SliceStableï¼ˆç®€æ´ä½†ç¨æ…¢ï¼‰</span></span><br><span class="line">sort.SliceStable(employees, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> employees[i].Salary &gt; employees[j].Salary <span class="comment">// å…ˆæŒ‰è–ªèµ„é™åº</span></span><br><span class="line">&#125;)</span><br><span class="line">sort.SliceStable(employees, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> employees[i].Dept &lt; employees[j].Dept <span class="comment">// å†æŒ‰éƒ¨é—¨å‡åº</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>âœ… å…³é”®ç‚¹ï¼šå¤šçº§æ’åºå¿…é¡»ç”¨ <code>Stable</code>ï¼Œå¦åˆ™ç¬¬äºŒæ¬¡æ’åºä¼šç ´åç¬¬ä¸€æ¬¡çš„é¡ºåº</p><h3 id="4-2-é«˜æ€§èƒ½å»é‡-æ’åºï¼ˆç”Ÿäº§ç¯å¢ƒå¸¸è§éœ€æ±‚ï¼‰"><a href="#4-2-é«˜æ€§èƒ½å»é‡-æ’åºï¼ˆç”Ÿäº§ç¯å¢ƒå¸¸è§éœ€æ±‚ï¼‰" class="headerlink" title="4.2 é«˜æ€§èƒ½å»é‡ + æ’åºï¼ˆç”Ÿäº§ç¯å¢ƒå¸¸è§éœ€æ±‚ï¼‰"></a>4.2 é«˜æ€§èƒ½å»é‡ + æ’åºï¼ˆç”Ÿäº§ç¯å¢ƒå¸¸è§éœ€æ±‚ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¾“å…¥: [3,1,4,1,5,9,2,6,5,3,5]</span></span><br><span class="line"><span class="comment">// è¾“å‡º: [1,2,3,4,5,6,9] (å»é‡+å‡åº)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UniqueSorted</span><span class="params">(nums []<span class="type">int</span>)</span></span> []<span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(nums) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> []<span class="type">int</span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. åŸåœ°æ’åºï¼ˆé¿å…é¢å¤–åˆ†é…ï¼‰</span></span><br><span class="line">    sort.Ints(nums)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. åŒæŒ‡é’ˆå»é‡ï¼ˆO(n) æ—¶é—´ï¼ŒO(1) ç©ºé—´ï¼‰</span></span><br><span class="line">    write := <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> read := <span class="number">1</span>; read &lt; <span class="built_in">len</span>(nums); read++ &#123;</span><br><span class="line">        <span class="keyword">if</span> nums[read] != nums[read<span class="number">-1</span>] &#123;</span><br><span class="line">            nums[write] = nums[read]</span><br><span class="line">            write++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> nums[:write]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŠ¿</strong>ï¼šç›¸æ¯” <code>map</code> å»é‡ï¼ˆéœ€å“ˆå¸Œè®¡ç®—+é¢å¤–å†…å­˜ï¼‰ï¼Œæ­¤æ–¹æ¡ˆåœ¨ 100 ä¸‡å…ƒç´ åœºæ™¯ä¸‹å¿« 3 å€ä¸”å†…å­˜å ç”¨é™ä½ 60%</p><h3 id="4-3-äºŒåˆ†æŸ¥æ‰¾å®æˆ˜ï¼šåœ¨æ—¶é—´åºåˆ—ä¸­å®šä½åŒºé—´"><a href="#4-3-äºŒåˆ†æŸ¥æ‰¾å®æˆ˜ï¼šåœ¨æ—¶é—´åºåˆ—ä¸­å®šä½åŒºé—´" class="headerlink" title="4.3 äºŒåˆ†æŸ¥æ‰¾å®æˆ˜ï¼šåœ¨æ—¶é—´åºåˆ—ä¸­å®šä½åŒºé—´"></a>4.3 äºŒåˆ†æŸ¥æ‰¾å®æˆ˜ï¼šåœ¨æ—¶é—´åºåˆ—ä¸­å®šä½åŒºé—´</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">    Timestamp time.Time</span><br><span class="line">    Message   <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logs := []LogEntry&#123; <span class="comment">/* å·²æŒ‰æ—¶é—´å‡åºæ’åˆ— */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥æ‰¾ 2024-01-01 10:00:00 åˆ° 12:00:00 ä¹‹é—´çš„æ—¥å¿—</span></span><br><span class="line">start := time.Date(<span class="number">2024</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, time.UTC)</span><br><span class="line">end := time.Date(<span class="number">2024</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, time.UTC)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥æ‰¾ç¬¬ä¸€ä¸ª &gt;= start çš„ä½ç½®</span></span><br><span class="line">left := sort.Search(<span class="built_in">len</span>(logs), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !logs[i].Timestamp.Before(start)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥æ‰¾ç¬¬ä¸€ä¸ª &gt;= end çš„ä½ç½®</span></span><br><span class="line">right := sort.Search(<span class="built_in">len</span>(logs), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !logs[i].Timestamp.Before(end)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">relevantLogs := logs[left:right] <span class="comment">// O(1) åˆ‡ç‰‡æ“ä½œ</span></span><br></pre></td></tr></table></figure><p>ğŸ’¡ æŠ€å·§ï¼šåˆ©ç”¨ <code>!Before(t)</code> ç­‰ä»·äº <code>&gt;= t</code>ï¼Œé¿å…ç›´æ¥æ¯”è¾ƒæ—¶é—´æˆ³çš„ç²¾åº¦é—®é¢˜</p><h2 id="äº”ã€é«˜çº§æŠ€å·§ï¼šè‡ªå®šä¹‰æ’åºçš„æ€§èƒ½ä¼˜åŒ–"><a href="#äº”ã€é«˜çº§æŠ€å·§ï¼šè‡ªå®šä¹‰æ’åºçš„æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="äº”ã€é«˜çº§æŠ€å·§ï¼šè‡ªå®šä¹‰æ’åºçš„æ€§èƒ½ä¼˜åŒ–"></a>äº”ã€é«˜çº§æŠ€å·§ï¼šè‡ªå®šä¹‰æ’åºçš„æ€§èƒ½ä¼˜åŒ–</h2><h3 id="5-1-é¿å…é—­åŒ…æ•è·å¤§å¯¹è±¡"><a href="#5-1-é¿å…é—­åŒ…æ•è·å¤§å¯¹è±¡" class="headerlink" title="5.1 é¿å…é—­åŒ…æ•è·å¤§å¯¹è±¡"></a>5.1 é¿å…é—­åŒ…æ•è·å¤§å¯¹è±¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åé¢æ•™æï¼šæ¯æ¬¡æ¯”è¾ƒéƒ½å¤åˆ¶å¤§ç»“æ„ä½“</span></span><br><span class="line">sort.Slice(data, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> expensiveCompare(data[i], data[j]) <span class="comment">// âŒ æ¯æ¬¡è°ƒç”¨å¤åˆ¶ data</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜åŒ–æ–¹æ¡ˆï¼šé¢„è®¡ç®—æ’åºé”®</span></span><br><span class="line">keys := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="built_in">len</span>(data))</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> data &#123;</span><br><span class="line">    keys[i] = computeSortKey(data[i]) <span class="comment">// ä»…è®¡ç®—ä¸€æ¬¡</span></span><br><span class="line">&#125;</span><br><span class="line">sort.Slice(data, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> keys[i] &lt; keys[j] <span class="comment">// âœ… O(1) æ¯”è¾ƒ</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="5-2-åˆ©ç”¨-sort-Reverse-å®ç°é™åº"><a href="#5-2-åˆ©ç”¨-sort-Reverse-å®ç°é™åº" class="headerlink" title="5.2 åˆ©ç”¨ sort.Reverse å®ç°é™åº"></a>5.2 åˆ©ç”¨ sort.Reverse å®ç°é™åº</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ï¼šè‡ªå®šä¹‰ Less å®ç°é™åºï¼ˆæ˜“å‡ºé”™ï¼‰</span></span><br><span class="line">sort.Slice(data, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data[i] &gt; data[j] <span class="comment">// å¯èƒ½è¿åæ’åºå¥‘çº¦</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ï¼šä½¿ç”¨ Reverse åŒ…è£…</span></span><br><span class="line">sort.Sort(sort.Reverse(sort.IntSlice(data))) <span class="comment">// âœ… å®‰å…¨å¯é </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰ç±»å‹é™åº</span></span><br><span class="line"><span class="keyword">type</span> DescInts []<span class="type">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d DescInts)</span></span> Len() <span class="type">int</span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(d) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d DescInts)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123; <span class="keyword">return</span> d[i] &gt; d[j] &#125; <span class="comment">// æ˜¾å¼å®šä¹‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d DescInts)</span></span> Swap(i, j <span class="type">int</span>)      &#123; d[i], d[j] = d[j], d[i] &#125;</span><br><span class="line">sort.Sort(DescInts(data))</span><br></pre></td></tr></table></figure><h2 id="å…­ã€æ€»ç»“ï¼šæœ€ä½³å®è·µé€ŸæŸ¥è¡¨"><a href="#å…­ã€æ€»ç»“ï¼šæœ€ä½³å®è·µé€ŸæŸ¥è¡¨" class="headerlink" title="å…­ã€æ€»ç»“ï¼šæœ€ä½³å®è·µé€ŸæŸ¥è¡¨"></a>å…­ã€æ€»ç»“ï¼šæœ€ä½³å®è·µé€ŸæŸ¥è¡¨</h2><table><thead><tr><th>åœºæ™¯</th><th>æ¨èæ–¹æ¡ˆ</th><th>ç†ç”±</th></tr></thead><tbody><tr><td><code>[]int</code>&#x2F;<code>[]string</code>&#x2F;<code>[]float64</code></td><td><code>Ints</code>&#x2F;<code>Strings</code>&#x2F;<code>Float64s</code></td><td>æ— åå°„ï¼Œæœ€å¿«</td></tr><tr><td>ä¸´æ—¶æ’åºè‡ªå®šä¹‰ç±»å‹</td><td><code>Slice</code> + é—­åŒ…</td><td>ä»£ç ç®€æ´ï¼Œæ— éœ€å®šä¹‰æ–°ç±»å‹</td></tr><tr><td>é¢‘ç¹æ’åºçš„è‡ªå®šä¹‰ç±»å‹</td><td>å®ç° <code>sort.Interface</code></td><td>é¿å…åå°„å¼€é”€ï¼Œæ€§èƒ½æå‡ 30%+</td></tr><tr><td>å¤šçº§æ’åº</td><td><code>Stable</code> + å¤šæ¬¡è°ƒç”¨ æˆ– å®ç° <code>Interface</code></td><td>ä¿è¯æ’åºç¨³å®šæ€§</td></tr><tr><td>é™åºæ’åº</td><td><code>sort.Reverse</code> åŒ…è£…</td><td>å®‰å…¨å¯é ï¼Œé¿å… Less é€»è¾‘é”™è¯¯</td></tr><tr><td>äºŒåˆ†æŸ¥æ‰¾</td><td><code>Find</code> (Go 1.21+) æˆ– <code>Search</code> + éªŒè¯</td><td>è¯­ä¹‰æ¸…æ™°ï¼Œé¿å…è¾¹ç•Œé”™è¯¯</td></tr><tr><td>å¹¶å‘ç¯å¢ƒ</td><td>æ’åºå‰å¤åˆ¶åˆ‡ç‰‡</td><td>é¿å…æ•°æ®ç«äº‰</td></tr></tbody></table><p><strong>ä¸ªäººå»ºè®®</strong>ï¼š</p><ul><li>å¯¹äºåº”ç”¨å±‚å¼€å‘æ¥è¯´ï¼Œ90% åœºæ™¯ç”¨ <code>Slice</code>&#x2F;<code>SliceStable</code> è¶³å¤Ÿï¼›  </li><li>å¯¹æ€§èƒ½æ•æ„Ÿåœºæ™¯ï¼ˆ&gt;10 ä¸‡å…ƒç´ æˆ–é«˜é¢‘è°ƒç”¨ï¼‰ï¼Œå®ç° <code>Interface</code> å¹¶ç”¨ <code>Sort</code>&#x2F;<code>Stable</code>ï¼›  </li><li>æ°¸è¿œä¸è¦åœ¨æœªæ’åºæ•°æ®ä¸Šä½¿ç”¨ <code>Search</code>&#x2F;<code>Find</code>ã€‚</li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€sort-åŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°æ€»è§ˆå›¾&quot;&gt;&lt;a href=&quot;#ä¸€ã€sort-åŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°æ€»è§ˆå›¾&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€sort åŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°æ€»è§ˆå›¾&quot;&gt;&lt;/a&gt;ä¸€ã€sort åŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°æ€»è§ˆå›¾&lt;/h2&gt;&lt;p&gt;sort åŒ…é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œæ ¸å¿ƒå›´ç»• &lt;code&gt;Interface&lt;/code&gt; æ¥å£æ„å»ºé€šç”¨æ’åºèƒ½åŠ›ï¼ŒåŒæ—¶æä¾›é’ˆå¯¹åŸºæœ¬ç±»å‹çš„ä¼˜åŒ–å®ç°ã€‚ä¸‹å›¾å®Œæ•´å±•ç¤ºäº† sort åŒ…çš„å‡½æ•°ä½“ç³»åŠä¸­æ–‡åŠŸèƒ½è¯´æ˜ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-sort" scheme="https://www.wdft.com/tags/Go-sort/"/>
    
  </entry>
  
  <entry>
    <title>ã€osã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“osåŒ…ç³»ç»Ÿç¼–ç¨‹çš„åŸºçŸ³ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/d7d74826.html"/>
    <id>https://www.wdft.com/d7d74826.html</id>
    <published>2026-01-28T15:59:43.000Z</published>
    <updated>2026-01-30T09:16:52.786Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€osåŒ…å…¨æ™¯æ¶æ„ï¼šä»æŠ½è±¡åˆ°å®ç°ï¼ˆå‡½æ•°åˆ—è¡¨ï¼‰"><a href="#ä¸€ã€osåŒ…å…¨æ™¯æ¶æ„ï¼šä»æŠ½è±¡åˆ°å®ç°ï¼ˆå‡½æ•°åˆ—è¡¨ï¼‰" class="headerlink" title="ä¸€ã€osåŒ…å…¨æ™¯æ¶æ„ï¼šä»æŠ½è±¡åˆ°å®ç°ï¼ˆå‡½æ•°åˆ—è¡¨ï¼‰"></a>ä¸€ã€osåŒ…å…¨æ™¯æ¶æ„ï¼šä»æŠ½è±¡åˆ°å®ç°ï¼ˆå‡½æ•°åˆ—è¡¨ï¼‰</h3><p>Goçš„<code>os</code>åŒ…æ˜¯è¿æ¥åº”ç”¨ç¨‹åºä¸æ“ä½œç³»ç»Ÿçš„æ¡¥æ¢ï¼Œå®ƒä»¥Unixå“²å­¦ä¸ºè®¾è®¡åŸºç¡€ï¼ŒåŒæ—¶é€šè¿‡Goé£æ ¼çš„é”™è¯¯å¤„ç†æœºåˆ¶å±è”½å¹³å°å·®å¼‚ã€‚ä¸ºç›´è§‚ç†è§£å…¶ç»“æ„ï¼Œä»¥ä¸‹ç»“æ„å›¾å±•ç¤ºäº†osåŒ…çš„æ ¸å¿ƒåŠŸèƒ½ä»¥åŠæ¨¡å—åˆ’åˆ†ï¼š</p><span id="more"></span><pre class="mermaid">flowchart LR    A[os Package] --> B[æ–‡ä»¶æ“ä½œ]    A --> C[ç›®å½•ç®¡ç†]    A --> D[ç¯å¢ƒå˜é‡]    A --> E[è¿›ç¨‹æ§åˆ¶]    A --> F[æƒé™ç³»ç»Ÿ]    A --> G[æ ‡å‡†æµ]    A --> H[ç³»ç»Ÿä¿¡æ¯]        B --> B1[Open/Create]    B --> B2[Read/Write]    B --> B3[Seek/Close]    B --> B4[Stat/Sync]        C --> C1[Mkdir/Remove]    C --> C2[ReadDir/Walk]    C --> C3[Chdir/Getwd]        D --> D1[Getenv/Setenv]    D --> D2[Environ/Clearenv]    D --> D3[Expand/Unsetenv]        E --> E1[Exit/Getpid]    E --> E2[Executable/FindProcess]    E --> E3[Kill/Signal]        F --> F1[Chmod/Chown]    F --> F2[FileMode/Perm]    F --> F3[Umask]        G --> G1[Stdin/Stdout/Stderr]    G --> G2[Pipe]        H --> H1[Hostname/Getpagesize]    H --> H2[Getuid/Getgid]    H --> H3[User/Group]</pre><hr><h3 id="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ"><a href="#äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ" class="headerlink" title="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ"></a>äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ</h3><h6 id="å¤‡æ³¨ï¼šä»¥ä¸‹åŸºäºGo-1-23-æ ‡å‡†åº“ç¼–å†™ã€‚"><a href="#å¤‡æ³¨ï¼šä»¥ä¸‹åŸºäºGo-1-23-æ ‡å‡†åº“ç¼–å†™ã€‚" class="headerlink" title="å¤‡æ³¨ï¼šä»¥ä¸‹åŸºäºGo 1.23+æ ‡å‡†åº“ç¼–å†™ã€‚"></a>å¤‡æ³¨ï¼šä»¥ä¸‹åŸºäºGo 1.23+æ ‡å‡†åº“ç¼–å†™ã€‚</h6><h4 id="2-1-æ–‡ä»¶æŠ½è±¡ï¼š-os-Fileçš„åŒé‡èº«ä»½"><a href="#2-1-æ–‡ä»¶æŠ½è±¡ï¼š-os-Fileçš„åŒé‡èº«ä»½" class="headerlink" title="2.1 æ–‡ä»¶æŠ½è±¡ï¼š*os.Fileçš„åŒé‡èº«ä»½"></a>2.1 æ–‡ä»¶æŠ½è±¡ï¼š<code>*os.File</code>çš„åŒé‡èº«ä»½</h4><p><code>os.File</code>ä¸ä»…æ˜¯æ–‡ä»¶å¥æŸ„ï¼Œæ›´æ˜¯å®ç°äº†<code>io.Reader</code>ã€<code>io.Writer</code>ã€<code>io.Closer</code>ç­‰å¤šé‡æ¥å£çš„å¤åˆä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> File <span class="keyword">struct</span> &#123;</span><br><span class="line">    *file <span class="comment">// å†…éƒ¨ç»“æ„ä½“ï¼ŒåŒ…å«fdï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ç­‰ç³»ç»Ÿçº§èµ„æº</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¸å¿ƒæ–¹æ³•é“¾</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *File)</span></span> Read(b []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)      <span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *File)</span></span> Write(b []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)     <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *File)</span></span> Seek(offset <span class="type">int64</span>, whence <span class="type">int</span>) (<span class="type">int64</span>, <span class="type">error</span>) <span class="comment">// å®šä½</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *File)</span></span> Close() <span class="type">error</span>                          <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br></pre></td></tr></table></figure><p><strong>æŠ€æœ¯è¦ç‚¹</strong>ï¼š</p><ul><li><code>file</code>ç»“æ„ä½“åœ¨ä¸åŒå¹³å°æœ‰ä¸åŒå®ç°ï¼ˆ<code>file_unix.go</code>&#x2F;<code>file_windows.go</code>ï¼‰ï¼Œä½†å¯¹å¤–æš´éœ²ç»Ÿä¸€æ¥å£</li><li>æ‰€æœ‰I&#x2F;Oæ“ä½œæœ€ç»ˆé€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚<code>read</code>&#x2F;<code>write</code>ï¼‰å®Œæˆï¼ŒGoè¿è¡Œæ—¶è´Ÿè´£é”™è¯¯è½¬æ¢</li><li>æ–‡ä»¶æè¿°ç¬¦åœ¨<code>Close()</code>æ—¶è‡ªåŠ¨é‡Šæ”¾ï¼Œä½†<strong>å¼ºçƒˆå»ºè®®æ˜¾å¼è°ƒç”¨</strong>é¿å…èµ„æºæ³„æ¼</li></ul><h4 id="2-2-é”™è¯¯å¤„ç†æœºåˆ¶ï¼š-PathErrorçš„æ™ºèƒ½å°è£…"><a href="#2-2-é”™è¯¯å¤„ç†æœºåˆ¶ï¼š-PathErrorçš„æ™ºèƒ½å°è£…" class="headerlink" title="2.2 é”™è¯¯å¤„ç†æœºåˆ¶ï¼š*PathErrorçš„æ™ºèƒ½å°è£…"></a>2.2 é”™è¯¯å¤„ç†æœºåˆ¶ï¼š<code>*PathError</code>çš„æ™ºèƒ½å°è£…</h4><p>osåŒ…å°†ç³»ç»Ÿçº§é”™è¯¯å°è£…ä¸ºå¸¦ä¸Šä¸‹æ–‡çš„Goé”™è¯¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PathError <span class="keyword">struct</span> &#123;</span><br><span class="line">    Op   <span class="type">string</span> <span class="comment">// æ“ä½œåç§°ï¼ˆ&quot;open&quot;, &quot;remove&quot;ç­‰ï¼‰</span></span><br><span class="line">    Path <span class="type">string</span> <span class="comment">// æ¶‰åŠçš„è·¯å¾„</span></span><br><span class="line">    Err  <span class="type">error</span>  <span class="comment">// åº•å±‚ç³»ç»Ÿé”™è¯¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> pe, ok := err.(*os.PathError); ok &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;æ“ä½œ[%s]è·¯å¾„[%s]å¤±è´¥: %v&quot;</span>, pe.Op, pe.Path, pe.Err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§è®¾è®¡ä½¿é”™è¯¯è¯Šæ–­ä»â€permission deniedâ€å‡çº§ä¸ºâ€open &#x2F;etc&#x2F;shadow: permission deniedâ€ï¼Œæå¤§æå‡å¯è°ƒè¯•æ€§ã€‚</p><h4 id="2-3-æƒé™æ¨¡å‹ï¼šUnixæƒé™çš„GoåŒ–è¡¨è¾¾"><a href="#2-3-æƒé™æ¨¡å‹ï¼šUnixæƒé™çš„GoåŒ–è¡¨è¾¾" class="headerlink" title="2.3 æƒé™æ¨¡å‹ï¼šUnixæƒé™çš„GoåŒ–è¡¨è¾¾"></a>2.3 æƒé™æ¨¡å‹ï¼šUnixæƒé™çš„GoåŒ–è¡¨è¾¾</h4><p>Goå°†ä¼ ç»Ÿçš„rwxæƒé™ä½æŠ½è±¡ä¸º<code>os.FileMode</code>ç±»å‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    ModeDir        FileMode = <span class="number">1</span> &lt;&lt; (<span class="number">32</span> - <span class="number">1</span> - <span class="literal">iota</span>) <span class="comment">// ç›®å½•æ ‡è¯†</span></span><br><span class="line">    ModeAppend                                     <span class="comment">// è¿½åŠ æ¨¡å¼</span></span><br><span class="line">    ModeExclusive                                  <span class="comment">// ç‹¬å åˆ›å»º</span></span><br><span class="line">    ModeTemporary                                  <span class="comment">// ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">    ModeSymlink                                    <span class="comment">// ç¬¦å·é“¾æ¥</span></span><br><span class="line">    ModeDevice                                     <span class="comment">// è®¾å¤‡æ–‡ä»¶</span></span><br><span class="line">    ModeNamedPipe                                  <span class="comment">// å‘½åç®¡é“</span></span><br><span class="line">    ModeSocket                                     <span class="comment">// Socket</span></span><br><span class="line">    ModeSetuid                                     <span class="comment">// Setuidä½</span></span><br><span class="line">    ModeSetgid                                     <span class="comment">// Setgidä½</span></span><br><span class="line">    ModeCharDevice                                 <span class="comment">// å­—ç¬¦è®¾å¤‡</span></span><br><span class="line">    ModeSticky                                     <span class="comment">// Stickyä½</span></span><br><span class="line">    ModeIrregular                                  <span class="comment">// éå¸¸è§„æ–‡ä»¶</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æƒé™ä½ï¼ˆä½9ä½ï¼‰</span></span><br><span class="line">    ModePerm FileMode = <span class="number">0777</span> <span class="comment">// Unixæƒé™æ©ç </span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>FileInfo.Mode().Perm()</code>å¯è·å–å®é™…æƒé™ï¼Œ<code>Chmod(path, 0644)</code>è®¾ç½®æƒé™ï¼Œå®Œç¾å…¼å®¹Unixå“²å­¦ã€‚</p><hr><h3 id="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰"><a href="#ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰" class="headerlink" title="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰"></a>ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰</h3><h4 id="âš ï¸-èµ„æºæ³„æ¼ï¼šæ–‡ä»¶æœªå…³é—­çš„éšå½¢æˆæœ¬"><a href="#âš ï¸-èµ„æºæ³„æ¼ï¼šæ–‡ä»¶æœªå…³é—­çš„éšå½¢æˆæœ¬" class="headerlink" title="âš ï¸ èµ„æºæ³„æ¼ï¼šæ–‡ä»¶æœªå…³é—­çš„éšå½¢æˆæœ¬"></a>âš ï¸ èµ„æºæ³„æ¼ï¼šæ–‡ä»¶æœªå…³é—­çš„éšå½¢æˆæœ¬</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç¤ºä¾‹ï¼šå¯èƒ½æ³„æ¼æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">leakyRead</span><span class="params">()</span></span> &#123;</span><br><span class="line">    f, _ := os.Open(<span class="string">&quot;data.txt&quot;</span>) <span class="comment">// å¿½ç•¥é”™è¯¯ä¸”æœªå…³é—­</span></span><br><span class="line">    <span class="comment">// ... ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    <span class="comment">// ç¨‹åºç»“æŸå‰æ–‡ä»¶å¥æŸ„ä¸€ç›´å ç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®åšæ³•ï¼šdeferç¡®ä¿å…³é—­</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">safeRead</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    f, err := os.Open(<span class="string">&quot;data.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> f.Close() <span class="comment">// å³ä½¿panicä¹Ÿä¼šæ‰§è¡Œ</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŸç†</strong>ï¼šGoçš„GCä¸ç®¡ç†æ“ä½œç³»ç»Ÿèµ„æºï¼ˆå¦‚fdï¼‰ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨<code>Close()</code>ã€‚deferæ˜¯Goçš„æƒ¯ç”¨æ³•ï¼Œä½†éœ€æ³¨æ„ï¼š</p><ul><li>å¤šæ–‡ä»¶æ“ä½œæ—¶æ¯ä¸ªæ–‡ä»¶å•ç‹¬defer</li><li>é¿å…åœ¨å¾ªç¯å†…åˆ›å»ºæ–‡ä»¶è€Œä¸å…³é—­ï¼ˆåº”å¾ªç¯å†…deferï¼‰</li></ul><h4 id="âš ï¸-è·¯å¾„å®‰å…¨ï¼šç›¸å¯¹è·¯å¾„çš„é™·é˜±"><a href="#âš ï¸-è·¯å¾„å®‰å…¨ï¼šç›¸å¯¹è·¯å¾„çš„é™·é˜±" class="headerlink" title="âš ï¸ è·¯å¾„å®‰å…¨ï¼šç›¸å¯¹è·¯å¾„çš„é™·é˜±"></a>âš ï¸ è·¯å¾„å®‰å…¨ï¼šç›¸å¯¹è·¯å¾„çš„é™·é˜±</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å±é™©ï¼šå½“å‰å·¥ä½œç›®å½•å¯èƒ½è¢«æ¶æ„ä¿®æ”¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">unsafeWrite</span><span class="params">(filename <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    f, err := os.Create(filename) <span class="comment">// è‹¥filename=&quot;../etc/passwd&quot;?</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®‰å…¨ï¼šä½¿ç”¨filepath.Clean + è·¯å¾„æ ¡éªŒ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">safeWrite</span><span class="params">(baseDir, filename <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. æ¸…ç†è·¯å¾„ï¼ˆç§»é™¤..å’Œ.ï¼‰</span></span><br><span class="line">    cleanPath := filepath.Clean(filepath.Join(baseDir, filename))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ç¡®ä¿åœ¨baseDirå†…</span></span><br><span class="line">    <span class="keyword">if</span> !strings.HasPrefix(cleanPath, filepath.Clean(baseDir)+<span class="type">string</span>(filepath.Separator)) &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;éæ³•è·¯å¾„: %s&quot;</span>, filename)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    f, err := os.Create(cleanPath)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="âš ï¸-å¹¶å‘å†™å…¥ï¼šæ–‡ä»¶é”çš„å¿…è¦æ€§"><a href="#âš ï¸-å¹¶å‘å†™å…¥ï¼šæ–‡ä»¶é”çš„å¿…è¦æ€§" class="headerlink" title="âš ï¸ å¹¶å‘å†™å…¥ï¼šæ–‡ä»¶é”çš„å¿…è¦æ€§"></a>âš ï¸ å¹¶å‘å†™å…¥ï¼šæ–‡ä»¶é”çš„å¿…è¦æ€§</h4><p>å¤šä¸ªgoroutineåŒæ—¶å†™å…¥åŒä¸€æ–‡ä»¶ä¼šå¯¼è‡´æ•°æ®äº¤é”™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ï¼šæ— åŒæ­¥æœºåˆ¶</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(id <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        f, _ := os.OpenFile(<span class="string">&quot;log.txt&quot;</span>, os.O_APPEND|os.O_WRONLY, <span class="number">0644</span>)</span><br><span class="line">        f.WriteString(fmt.Sprintf(<span class="string">&quot;goroutine %d\n&quot;</span>, id))</span><br><span class="line">        f.Close()</span><br><span class="line">    &#125;(i)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ï¼šä½¿ç”¨æ–‡ä»¶é”ï¼ˆLinux/Unixï¼‰</span></span><br><span class="line">f, _ := os.OpenFile(<span class="string">&quot;log.txt&quot;</span>, os.O_APPEND|os.O_WRONLY, <span class="number">0644</span>)</span><br><span class="line">syscall.Flock(<span class="type">int</span>(f.Fd()), syscall.LOCK_EX) <span class="comment">// åŠ é”</span></span><br><span class="line">f.WriteString(<span class="string">&quot;å®‰å…¨å†™å…¥&quot;</span>)</span><br><span class="line">syscall.Flock(<span class="type">int</span>(f.Fd()), syscall.LOCK_UN) <span class="comment">// è§£é”</span></span><br><span class="line">f.Close()</span><br></pre></td></tr></table></figure><p>Windowså¹³å°éœ€ä½¿ç”¨<code>LockFileEx</code> APIï¼Œå»ºè®®å°è£…è·¨å¹³å°é”å·¥å…·ã€‚</p><hr><h3 id="å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹"><a href="#å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹" class="headerlink" title="å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹"></a>å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹</h3><h4 id="æ¡ˆä¾‹1ï¼šåŸå­å†™å…¥æ–‡ä»¶ï¼ˆé¿å…å†™å…¥ä¸­æ–­å¯¼è‡´æ–‡ä»¶æŸåï¼‰"><a href="#æ¡ˆä¾‹1ï¼šåŸå­å†™å…¥æ–‡ä»¶ï¼ˆé¿å…å†™å…¥ä¸­æ–­å¯¼è‡´æ–‡ä»¶æŸåï¼‰" class="headerlink" title="æ¡ˆä¾‹1ï¼šåŸå­å†™å…¥æ–‡ä»¶ï¼ˆé¿å…å†™å…¥ä¸­æ–­å¯¼è‡´æ–‡ä»¶æŸåï¼‰"></a>æ¡ˆä¾‹1ï¼šåŸå­å†™å…¥æ–‡ä»¶ï¼ˆé¿å…å†™å…¥ä¸­æ–­å¯¼è‡´æ–‡ä»¶æŸåï¼‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// AtomicWrite å®‰å…¨å†™å…¥ï¼šå…ˆå†™ä¸´æ—¶æ–‡ä»¶ï¼ŒæˆåŠŸååŸå­æ›¿æ¢</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AtomicWrite</span><span class="params">(filename, content <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼ˆåŒç›®å½•ä¿è¯renameåŸå­æ€§ï¼‰</span></span><br><span class="line">    tmpFile, err := os.CreateTemp(filepath.Dir(filename), <span class="string">&quot;.tmp.*&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    tmpName := tmpFile.Name()</span><br><span class="line">    <span class="keyword">defer</span> os.Remove(tmpName) <span class="comment">// ç¡®ä¿å¤±è´¥æ—¶æ¸…ç†</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. å†™å…¥å†…å®¹</span></span><br><span class="line">    <span class="keyword">if</span> _, err := tmpFile.WriteString(content); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        tmpFile.Close()</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;å†™å…¥ä¸´æ—¶æ–‡ä»¶å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := tmpFile.Sync(); err != <span class="literal">nil</span> &#123; <span class="comment">// ç¡®ä¿è½ç›˜</span></span><br><span class="line">        tmpFile.Close()</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;syncå¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := tmpFile.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;å…³é—­ä¸´æ—¶æ–‡ä»¶å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. åŸå­æ›¿æ¢ï¼ˆrenameæ˜¯åŸå­æ“ä½œï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> err := os.Rename(tmpName, filename); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;renameå¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := AtomicWrite(<span class="string">&quot;config.json&quot;</span>, <span class="string">`&#123;&quot;version&quot;: &quot;1.0&quot;&#125;`</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;å†™å…¥å¤±è´¥: %v\n&quot;</span>, err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;å®‰å…¨å†™å…¥æˆåŠŸ&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æŠ€æœ¯äº®ç‚¹</strong>ï¼š</p><ul><li>åˆ©ç”¨<code>os.Rename</code>çš„åŸå­æ€§ä¿è¯å†™å…¥å®Œæ•´æ€§</li><li>ä¸´æ—¶æ–‡ä»¶ä¸ç›®æ ‡æ–‡ä»¶åŒç›®å½•ç¡®ä¿è·¨æ–‡ä»¶ç³»ç»Ÿrenameå¯è¡Œ</li><li><code>Sync()</code>å¼ºåˆ¶åˆ·ç›˜é¿å…æ–­ç”µä¸¢å¤±</li></ul><h4 id="æ¡ˆä¾‹2ï¼šé€’å½’ç›®å½•åŒæ­¥ï¼ˆå¸¦æƒé™ä¿ç•™ï¼‰"><a href="#æ¡ˆä¾‹2ï¼šé€’å½’ç›®å½•åŒæ­¥ï¼ˆå¸¦æƒé™ä¿ç•™ï¼‰" class="headerlink" title="æ¡ˆä¾‹2ï¼šé€’å½’ç›®å½•åŒæ­¥ï¼ˆå¸¦æƒé™ä¿ç•™ï¼‰"></a>æ¡ˆä¾‹2ï¼šé€’å½’ç›®å½•åŒæ­¥ï¼ˆå¸¦æƒé™ä¿ç•™ï¼‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SyncDir é€’å½’åŒæ­¥srcåˆ°dstï¼Œä¿ç•™æƒé™å’Œmtime</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SyncDir</span><span class="params">(src, dst <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> filepath.Walk(src, <span class="function"><span class="keyword">func</span><span class="params">(path <span class="type">string</span>, info os.FileInfo, err <span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¡ç®—ç›¸å¯¹è·¯å¾„</span></span><br><span class="line">        relPath, _ := filepath.Rel(src, path)</span><br><span class="line">        dstPath := filepath.Join(dst, relPath)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> info.IsDir() &#123;</span><br><span class="line">            <span class="keyword">return</span> os.MkdirAll(dstPath, info.Mode().Perm())</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·³è¿‡ç¬¦å·é“¾æ¥ï¼ˆç®€åŒ–å¤„ç†ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> info.Mode()&amp;os.ModeSymlink != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆåŸºäºå“ˆå¸Œ+mtimeï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> needUpdate(path, dstPath, info) &#123;</span><br><span class="line">            <span class="keyword">if</span> err := copyFile(path, dstPath, info); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;å¤åˆ¶ %s å¤±è´¥: %w&quot;</span>, path, err)</span><br><span class="line">            &#125;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;âœ“ åŒæ­¥: %s\n&quot;</span>, relPath)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">needUpdate</span><span class="params">(src, dst <span class="type">string</span>, srcInfo os.FileInfo)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    dstInfo, err := os.Stat(dst)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// ç›®æ ‡ä¸å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç®€åŒ–ç­–ç•¥ï¼šå¤§å°æˆ–ä¿®æ”¹æ—¶é—´ä¸åŒåˆ™æ›´æ–°</span></span><br><span class="line">    <span class="keyword">return</span> srcInfo.Size() != dstInfo.Size() || </span><br><span class="line">           srcInfo.ModTime() != dstInfo.ModTime()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">copyFile</span><span class="params">(src, dst <span class="type">string</span>, info os.FileInfo)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç›®æ ‡ç›®å½•</span></span><br><span class="line">    <span class="keyword">if</span> err := os.MkdirAll(filepath.Dir(dst), <span class="number">0755</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤åˆ¶å†…å®¹</span></span><br><span class="line">    srcFile, err := os.Open(src)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> srcFile.Close()</span><br><span class="line"></span><br><span class="line">    dstFile, err := os.OpenFile(dst, os.O_CREATE|os.O_WRONLY|os.O_TRUNC, info.Mode().Perm())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> dstFile.Close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _, err := io.Copy(dstFile, srcFile); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿ç•™ä¿®æ”¹æ—¶é—´</span></span><br><span class="line">    <span class="keyword">return</span> os.Chtimes(dst, info.ModTime(), info.ModTime())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := SyncDir(<span class="string">&quot;./source&quot;</span>, <span class="string">&quot;./backup&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;åŒæ­¥å¤±è´¥: %v\n&quot;</span>, err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;ç›®å½•åŒæ­¥å®Œæˆ&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç”Ÿäº§çº§å¢å¼ºå»ºè®®</strong>ï¼š</p><ul><li>å¢åŠ å“ˆå¸Œæ ¡éªŒï¼ˆå¦‚SHA256ï¼‰é¿å…mtimeæ¬ºéª—</li><li>æ”¯æŒç¡¬é“¾æ¥&#x2F;ç¬¦å·é“¾æ¥å¤„ç†</li><li>æ·»åŠ è¿›åº¦å›è°ƒå’Œä¸­æ–­æ¢å¤æœºåˆ¶</li></ul><h4 id="æ¡ˆä¾‹3ï¼šè¿›ç¨‹é—´é€šä¿¡ï¼ˆçˆ¶å­è¿›ç¨‹é€šè¿‡Pipeä¼ é€’æ•°æ®ï¼‰"><a href="#æ¡ˆä¾‹3ï¼šè¿›ç¨‹é—´é€šä¿¡ï¼ˆçˆ¶å­è¿›ç¨‹é€šè¿‡Pipeä¼ é€’æ•°æ®ï¼‰" class="headerlink" title="æ¡ˆä¾‹3ï¼šè¿›ç¨‹é—´é€šä¿¡ï¼ˆçˆ¶å­è¿›ç¨‹é€šè¿‡Pipeä¼ é€’æ•°æ®ï¼‰"></a>æ¡ˆä¾‹3ï¼šè¿›ç¨‹é—´é€šä¿¡ï¼ˆçˆ¶å­è¿›ç¨‹é€šè¿‡Pipeä¼ é€’æ•°æ®ï¼‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bufio&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;os/exec&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç®¡é“</span></span><br><span class="line">    r, w, err := os.Pipe()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨å­è¿›ç¨‹ï¼Œå°†å…¶stdouté‡å®šå‘åˆ°ç®¡é“å†™ç«¯</span></span><br><span class="line">    cmd := exec.Command(<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;Hello from child process!&quot;</span>)</span><br><span class="line">    cmd.Stdout = w</span><br><span class="line">    <span class="keyword">if</span> err := cmd.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çˆ¶è¿›ç¨‹ä»ç®¡é“è¯»ç«¯è¯»å–</span></span><br><span class="line">    w.Close() <span class="comment">// å…³é—­å†™ç«¯ï¼Œé¿å…Readé˜»å¡</span></span><br><span class="line">    scanner := bufio.NewScanner(r)</span><br><span class="line">    <span class="keyword">for</span> scanner.Scan() &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;Parent received: %s\n&quot;</span>, strings.ToUpper(scanner.Text()))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := scanner.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;è¯»å–é”™è¯¯: %v\n&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…å­è¿›ç¨‹ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> err := cmd.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;å­è¿›ç¨‹é”™è¯¯: %v\n&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¾“å‡º</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Parent received: HELLO FROM CHILD PROCESS!</span><br></pre></td></tr></table></figure><hr><h3 id="äº”ã€æœ€ä½³å®è·µæ€»ç»“"><a href="#äº”ã€æœ€ä½³å®è·µæ€»ç»“" class="headerlink" title="äº”ã€æœ€ä½³å®è·µæ€»ç»“"></a>äº”ã€æœ€ä½³å®è·µæ€»ç»“</h3><ol><li><strong>èµ„æºç®¡ç†</strong>ï¼šæ‰€æœ‰<code>*os.File</code>å¿…é¡»é…å¯¹<code>defer Close()</code>ï¼Œè€ƒè™‘ä½¿ç”¨<code>errgroup</code>ç»Ÿä¸€ç®¡ç†</li><li><strong>é”™è¯¯å¤„ç†</strong>ï¼šä½¿ç”¨ç±»å‹æ–­è¨€æå–<code>*PathError</code>è·å–è¯¦ç»†ä¸Šä¸‹æ–‡</li><li><strong>è·¯å¾„å®‰å…¨</strong>ï¼šæ°¸è¿œç”¨<code>filepath.Clean</code>+å‰ç¼€æ ¡éªŒé˜²å¾¡è·¯å¾„éå†æ”»å‡»</li><li><strong>åŸå­æ“ä½œ</strong>ï¼šå…³é”®å†™å…¥ä½¿ç”¨â€å†™ä¸´æ—¶æ–‡ä»¶â†’Syncâ†’Renameâ€ä¸‰æ­¥æ³•</li><li><strong>æƒé™æœ€å°åŒ–</strong>ï¼šåˆ›å»ºæ–‡ä»¶æ—¶æ˜ç¡®æŒ‡å®šæƒé™ï¼ˆå¦‚<code>0644</code>ï¼‰ï¼Œé¿å…ç»§æ‰¿å®½æ¾umask</li><li><strong>è·¨å¹³å°é€‚é…</strong>ï¼š<ul><li>è·¯å¾„åˆ†éš”ç¬¦ç”¨<code>filepath.Join</code>è€Œéç¡¬ç¼–ç <code>/</code></li><li>æ£€æŸ¥<code>runtime.GOOS</code>å¤„ç†å¹³å°ç‰¹æœ‰è¡Œä¸º</li><li>é¿å…ç›´æ¥ä½¿ç”¨<code>syscall</code>ï¼Œä¼˜å…ˆç”¨osåŒ…æŠ½è±¡</li></ul></li></ol><hr><h3 id="å…­ã€å»¶ä¼¸æ€è€ƒ"><a href="#å…­ã€å»¶ä¼¸æ€è€ƒ" class="headerlink" title="å…­ã€å»¶ä¼¸æ€è€ƒ"></a>å…­ã€å»¶ä¼¸æ€è€ƒ</h3><p>osåŒ…è™½å¼ºå¤§ï¼Œä½†ç°ä»£Goå¼€å‘ä¸­å¸¸éœ€æ›´é«˜å±‚æŠ½è±¡ï¼š</p><ul><li><strong>æ–‡ä»¶æ“ä½œ</strong>ï¼š<code>io/fs</code>ï¼ˆGo 1.16+ï¼‰æä¾›åªè¯»æ–‡ä»¶ç³»ç»ŸæŠ½è±¡ï¼Œé€‚åˆå®‰å…¨æ•æ„Ÿåœºæ™¯</li><li><strong>è¿›ç¨‹ç®¡ç†</strong>ï¼š<code>os/exec</code>å°è£…æ›´å‹å¥½çš„å‘½ä»¤æ‰§è¡Œæ¥å£</li><li><strong>ç¯å¢ƒå˜é‡</strong>ï¼šè€ƒè™‘ä½¿ç”¨<code>github.com/kelseyhightower/envconfig</code>ç­‰åº“ç»“æ„åŒ–è§£æ</li></ul><p>æŒæ¡osåŒ…æ˜¯ç†è§£Goç³»ç»Ÿç¼–ç¨‹çš„åŸºçŸ³ï¼Œä½†ç”Ÿäº§ç¯å¢ƒåº”æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚æŠ½è±¡å±‚çº§â€”â€”<strong>ç®€å•ä»»åŠ¡ç”¨osï¼Œå¤æ‚åœºæ™¯ç”¨å°è£…åº“</strong>ï¼Œè¿™æ‰æ˜¯Goå“²å­¦çš„ç²¾é«“ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h3 id=&quot;ä¸€ã€osåŒ…å…¨æ™¯æ¶æ„ï¼šä»æŠ½è±¡åˆ°å®ç°ï¼ˆå‡½æ•°åˆ—è¡¨ï¼‰&quot;&gt;&lt;a href=&quot;#ä¸€ã€osåŒ…å…¨æ™¯æ¶æ„ï¼šä»æŠ½è±¡åˆ°å®ç°ï¼ˆå‡½æ•°åˆ—è¡¨ï¼‰&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€osåŒ…å…¨æ™¯æ¶æ„ï¼šä»æŠ½è±¡åˆ°å®ç°ï¼ˆå‡½æ•°åˆ—è¡¨ï¼‰&quot;&gt;&lt;/a&gt;ä¸€ã€osåŒ…å…¨æ™¯æ¶æ„ï¼šä»æŠ½è±¡åˆ°å®ç°ï¼ˆå‡½æ•°åˆ—è¡¨ï¼‰&lt;/h3&gt;&lt;p&gt;Goçš„&lt;code&gt;os&lt;/code&gt;åŒ…æ˜¯è¿æ¥åº”ç”¨ç¨‹åºä¸æ“ä½œç³»ç»Ÿçš„æ¡¥æ¢ï¼Œå®ƒä»¥Unixå“²å­¦ä¸ºè®¾è®¡åŸºç¡€ï¼ŒåŒæ—¶é€šè¿‡Goé£æ ¼çš„é”™è¯¯å¤„ç†æœºåˆ¶å±è”½å¹³å°å·®å¼‚ã€‚ä¸ºç›´è§‚ç†è§£å…¶ç»“æ„ï¼Œä»¥ä¸‹ç»“æ„å›¾å±•ç¤ºäº†osåŒ…çš„æ ¸å¿ƒåŠŸèƒ½ä»¥åŠæ¨¡å—åˆ’åˆ†ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-os" scheme="https://www.wdft.com/tags/Go-os/"/>
    
  </entry>
  
  <entry>
    <title>ã€timeã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“timeåŒ…çš„è®¾è®¡åŸç†ä»¥åŠå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/a6cbebf9.html"/>
    <id>https://www.wdft.com/a6cbebf9.html</id>
    <published>2026-01-28T14:17:44.000Z</published>
    <updated>2026-02-02T19:29:30.514Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€timeåŒ…æ¶æ„åº“å‡½æ•°å…¨æ™¯æ€»è§ˆï¼šä¸€å¼ å›¾çœ‹æ‡‚timeåº“æ ¸å¿ƒæ„æˆ"><a href="#ä¸€ã€timeåŒ…æ¶æ„åº“å‡½æ•°å…¨æ™¯æ€»è§ˆï¼šä¸€å¼ å›¾çœ‹æ‡‚timeåº“æ ¸å¿ƒæ„æˆ" class="headerlink" title="ä¸€ã€timeåŒ…æ¶æ„åº“å‡½æ•°å…¨æ™¯æ€»è§ˆï¼šä¸€å¼ å›¾çœ‹æ‡‚timeåº“æ ¸å¿ƒæ„æˆ"></a>ä¸€ã€timeåŒ…æ¶æ„åº“å‡½æ•°å…¨æ™¯æ€»è§ˆï¼šä¸€å¼ å›¾çœ‹æ‡‚timeåº“æ ¸å¿ƒæ„æˆ</h2><p>æœ¬æ–‡åŸºäºGo 1.25æ ‡å‡†åº“ï¼Œå®Œå…¨åŸåˆ›è§£ætimeåŒ…è®¾è®¡å“²å­¦ä¸å®æˆ˜æŠ€å·§ï¼Œå¸®åŠ©æ–°æ‰‹å¿«é€Ÿå½»åº•æŒæ¡æ—¶é—´å¤„ç†çš„è‰ºæœ¯ã€‚<br>timeåŒ…é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œä»¥<code>Time</code>ç»“æ„ä½“ä¸ºæ ¸å¿ƒï¼Œå›´ç»•<strong>æ—¶é—´è¡¨ç¤º</strong>ã€<strong>æ—¶é—´è®¡ç®—</strong>ã€<strong>å®šæ—¶å™¨</strong>ã€<strong>æ ¼å¼åŒ–</strong>å››å¤§ç»´åº¦æ„å»ºå®Œæ•´ç”Ÿæ€ã€‚</p><span id="more"></span><pre class="mermaid">flowchart LR    A[time Package] --> B[æ ¸å¿ƒç±»å‹]    A --> C[æ—¶é—´åˆ›å»º]    A --> D[æ—¶é—´è®¡ç®—]    A --> E[å®šæ—¶å™¨]    A --> F[æ ¼å¼åŒ–/è§£æ]    A --> G[æ—¶åŒºå¤„ç†]        B --> B1[Time<br>åŒé‡æ—¶é’Ÿæœºåˆ¶]    B --> B2[Duration<br>çº³ç§’çº§ç²¾åº¦]    B --> B3[Location<br>æ—¶åŒºæ•°æ®åº“]    B --> B4[Month/Weekday<br>æšä¸¾ç±»å‹]        C --> C1[Now<br>å½“å‰æ—¶é—´]    C --> C2[Date<br>æ„é€ æŒ‡å®šæ—¶é—´]    C --> C3[Unix/UnixMilli/UnixMicro/UnixNano<br>Unixæ—¶é—´æˆ³è½¬æ¢]    C --> C4[Parse/ParseInLocation<br>å­—ç¬¦ä¸²è§£æ]        D --> D1[Add/AddDate<br>æ—¶é—´åç§»]    D --> D2[Sub<br>æ—¶é—´å·®è®¡ç®—]    D --> D3[Before/After/Equal<br>æ—¶é—´æ¯”è¾ƒ]    D --> D4[Truncate/Round<br>æ—¶é—´æˆªæ–­]        E --> E1[Timer<br>å•æ¬¡è§¦å‘]    E --> E2[Ticker<br>å‘¨æœŸè§¦å‘]    E --> E3[Sleep<br>åç¨‹ä¼‘çœ ]    E --> E4[After/AfterFunc<br>ä¾¿æ·API]        F --> F1[Format<br>RFC3339/è‡ªå®šä¹‰]    F --> F2[MarshalJSON/XML<br>åºåˆ—åŒ–]    F --> F3[ANSIC/RFC822/RFC3339<br>é¢„å®šä¹‰å¸ƒå±€]        G --> G1[LoadLocation<br>åŠ è½½æ—¶åŒº]    G --> G2[FixedZone<br>å›ºå®šåç§»]    G --> G3[UTC/Local<br>ç³»ç»Ÿæ—¶åŒº]</pre><h2 id="äºŒã€æ ¸å¿ƒåŸç†æ·±åº¦è§£æ"><a href="#äºŒã€æ ¸å¿ƒåŸç†æ·±åº¦è§£æ" class="headerlink" title="äºŒã€æ ¸å¿ƒåŸç†æ·±åº¦è§£æ"></a>äºŒã€æ ¸å¿ƒåŸç†æ·±åº¦è§£æ</h2><h3 id="2-1-Timeç»“æ„ä½“ï¼šåŒé‡æ—¶é’Ÿæœºåˆ¶çš„ç²¾å¦™è®¾è®¡"><a href="#2-1-Timeç»“æ„ä½“ï¼šåŒé‡æ—¶é’Ÿæœºåˆ¶çš„ç²¾å¦™è®¾è®¡" class="headerlink" title="2.1 Timeç»“æ„ä½“ï¼šåŒé‡æ—¶é’Ÿæœºåˆ¶çš„ç²¾å¦™è®¾è®¡"></a>2.1 Timeç»“æ„ä½“ï¼šåŒé‡æ—¶é’Ÿæœºåˆ¶çš„ç²¾å¦™è®¾è®¡</h3><p>Goçš„<code>Time</code>å¹¶éç®€å•å­˜å‚¨Unixæ—¶é—´æˆ³ï¼Œè€Œæ˜¯é‡‡ç”¨<strong>å¢™é’Ÿï¼ˆWall Clockï¼‰+ å•è°ƒæ—¶é’Ÿï¼ˆMonotonic Clockï¼‰</strong> åŒé‡è¡¨ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// time.Timeå†…éƒ¨ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="keyword">type</span> Time <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// wallå­—æ®µï¼šä½33ä½å­˜å‚¨çº³ç§’(0-999999999)ï¼Œé«˜31ä½å­˜å‚¨ç§’çš„ä½31ä½</span></span><br><span class="line">    <span class="comment">// extå­—æ®µï¼šå­˜å‚¨ç§’çš„é«˜ä½ + å•è°ƒæ—¶é’Ÿçº³ç§’åç§»</span></span><br><span class="line">    wall <span class="type">uint64</span></span><br><span class="line">    ext  <span class="type">int64</span></span><br><span class="line">    loc  *Location <span class="comment">// æ—¶åŒºä¿¡æ¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è®¾è®¡å“²å­¦</strong>ï¼š</p><ul><li><strong>å¢™é’Ÿ</strong>ï¼šç”¨äºäººç±»å¯è¯»çš„æ—¶é—´è¡¨ç¤ºï¼ˆå—NTPè°ƒæ•´ã€å¤ä»¤æ—¶å½±å“ï¼‰</li><li><strong>å•è°ƒæ—¶é’Ÿ</strong>ï¼šç”¨äºç²¾ç¡®çš„æ—¶é—´å·®è®¡ç®—ï¼ˆä¸å—ç³»ç»Ÿæ—¶é’Ÿè·³å˜å½±å“ï¼‰</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…³é”®ç‰¹æ€§æ¼”ç¤ºï¼šå³ä½¿ç³»ç»Ÿæ—¶é—´å›æ‹¨ï¼ŒDurationè®¡ç®—ä»å‡†ç¡®</span></span><br><span class="line">start := time.Now()</span><br><span class="line"><span class="comment">// å‡è®¾æ­¤æ—¶ç³»ç»Ÿç®¡ç†å‘˜å°†æ—¶é—´å›æ‹¨1å°æ—¶ï¼ˆæç«¯æƒ…å†µï¼‰</span></span><br><span class="line">time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">end := time.Now()</span><br><span class="line"></span><br><span class="line">elapsed := end.Sub(start) <span class="comment">// å§‹ç»ˆâ‰ˆ100msï¼Œä¸å—å¢™é’Ÿè·³å˜å½±å“ï¼</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;Elapsed: %v\n&quot;</span>, elapsed)</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯Goæ—¶é—´å¤„ç†çš„<strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼š<code>Sub()</code>æ–¹æ³•è‡ªåŠ¨ä½¿ç”¨å•è°ƒæ—¶é’Ÿè®¡ç®—å·®å€¼ï¼Œé¿å…åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å› NTPåŒæ­¥å¯¼è‡´çš„æ—¶é—´è®¡ç®—é”™è¯¯ã€‚</p><h3 id="2-2-æ—¶åŒºå¤„ç†ï¼šLocationçš„æ‡’åŠ è½½æœºåˆ¶"><a href="#2-2-æ—¶åŒºå¤„ç†ï¼šLocationçš„æ‡’åŠ è½½æœºåˆ¶" class="headerlink" title="2.2 æ—¶åŒºå¤„ç†ï¼šLocationçš„æ‡’åŠ è½½æœºåˆ¶"></a>2.2 æ—¶åŒºå¤„ç†ï¼šLocationçš„æ‡’åŠ è½½æœºåˆ¶</h3><p>æ—¶åŒºæ•°æ®å¹¶éç¡¬ç¼–ç åœ¨äºŒè¿›åˆ¶ä¸­ï¼Œè€Œæ˜¯é€šè¿‡<code>zoneinfo.zip</code>æˆ–ç³»ç»Ÿæ—¶åŒºæ•°æ®åº“åŠ¨æ€åŠ è½½ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ—¶åŒºåŠ è½½æµç¨‹</span></span><br><span class="line">tz, err := time.LoadLocation(<span class="string">&quot;Asia/Shanghai&quot;</span>) <span class="comment">// é¦–æ¬¡è°ƒç”¨è§¦å‘I/O</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†æ—¶åŒºåŠ è½½å¤±è´¥ï¼ˆå®¹å™¨ç¯å¢ƒå¸¸è§é—®é¢˜ï¼‰</span></span><br><span class="line">    tz = time.FixedZone(<span class="string">&quot;CST&quot;</span>, <span class="number">8</span>*<span class="number">3600</span>) <span class="comment">// å›é€€åˆ°å›ºå®šåç§»</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®æ³¨æ„äº‹é¡¹</strong>ï¼š</p><ol><li><strong>Dockeré•œåƒéœ€åŒ…å«æ—¶åŒºæ•°æ®</strong>ï¼šAlpineé•œåƒé»˜è®¤æ— <code>/usr/share/zoneinfo</code>ï¼Œéœ€å®‰è£…<code>tzdata</code>åŒ…</li><li><strong>Locationæ˜¯çº¿ç¨‹å®‰å…¨çš„</strong>ï¼šå¯å…¨å±€å¤ç”¨ï¼Œé¿å…é‡å¤åŠ è½½</li><li><strong>UTCæ˜¯ç‰¹æ®ŠLocation</strong>ï¼š<code>time.UTC</code>æ˜¯é¢„å®šä¹‰å¸¸é‡ï¼Œæ— éœ€åŠ è½½</li></ol><h3 id="2-3-Timer-x2F-Tickeræ¼”è¿›ï¼šGo-1-23çš„é©å‘½æ€§æ”¹è¿›"><a href="#2-3-Timer-x2F-Tickeræ¼”è¿›ï¼šGo-1-23çš„é©å‘½æ€§æ”¹è¿›" class="headerlink" title="2.3 Timer&#x2F;Tickeræ¼”è¿›ï¼šGo 1.23çš„é©å‘½æ€§æ”¹è¿›"></a>2.3 Timer&#x2F;Tickeræ¼”è¿›ï¼šGo 1.23çš„é©å‘½æ€§æ”¹è¿›</h3><p>Go 1.23å¯¹å®šæ—¶å™¨å®ç°è¿›è¡Œäº†é‡æ„ï¼Œè§£å†³å†å²é—ç•™é—®é¢˜ï¼š</p><table><thead><tr><th>ç‰¹æ€§</th><th>æ—§å®ç° (â‰¤1.22)</th><th>æ–°å®ç° (â‰¥1.23)</th></tr></thead><tbody><tr><td><strong>é€šé“ç¼“å†²</strong></td><td>æ— ç¼“å†²ï¼ˆé˜»å¡é£é™©ï¼‰</td><td>æœ‰ç¼“å†²ï¼ˆè‡ªåŠ¨ä¸¢å¼ƒè¿‡æœŸäº‹ä»¶ï¼‰</td></tr><tr><td><strong>Stopè¡Œä¸º</strong></td><td>éœ€ Drain é€šé“</td><td>Stopåé€šé“è‡ªåŠ¨å…³é—­</td></tr><tr><td><strong>èµ„æºæ³„æ¼</strong></td><td>å¿˜è®°Stopå¯¼è‡´æ³„æ¼</td><td>GCå¯å›æ”¶æœªStopçš„Timer</td></tr><tr><td><strong>ç²¾åº¦</strong></td><td>å—è°ƒåº¦å™¨å½±å“</td><td>æ›´ç²¾å‡†çš„åˆ°æœŸæ—¶é—´</td></tr></tbody></table><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Go 1.23+ å®‰å…¨ç”¨æ³•ï¼ˆæ— éœ€Drainï¼‰</span></span><br><span class="line">timer := time.NewTimer(<span class="number">2</span> * time.Second)</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-timer.C:</span><br><span class="line">    fmt.Println(<span class="string">&quot;Timer fired&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">    timer.Stop() <span class="comment">// æ— éœ€drainï¼Œé€šé“è‡ªåŠ¨å¤„ç†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–°å®ç°é€šè¿‡<strong>é€šé“ç¼“å†²+åˆ°æœŸäº‹ä»¶åˆå¹¶</strong>æœºåˆ¶ï¼Œå½»åº•è§£å†³â€Timeræ³„æ¼â€è¿™ä¸€Goå†å²éš¾é¢˜ã€‚</p><h2 id="ä¸‰ã€å®æˆ˜ä»£ç åº“ï¼šè¦†ç›–90-ä½¿ç”¨åœºæ™¯"><a href="#ä¸‰ã€å®æˆ˜ä»£ç åº“ï¼šè¦†ç›–90-ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä¸‰ã€å®æˆ˜ä»£ç åº“ï¼šè¦†ç›–90%ä½¿ç”¨åœºæ™¯"></a>ä¸‰ã€å®æˆ˜ä»£ç åº“ï¼šè¦†ç›–90%ä½¿ç”¨åœºæ™¯</h2><h3 id="3-1-ç²¾å‡†æ—¶é—´æµ‹é‡ï¼ˆé¿å…å¸¸è§é™·é˜±ï¼‰"><a href="#3-1-ç²¾å‡†æ—¶é—´æµ‹é‡ï¼ˆé¿å…å¸¸è§é™·é˜±ï¼‰" class="headerlink" title="3.1 ç²¾å‡†æ—¶é—´æµ‹é‡ï¼ˆé¿å…å¸¸è§é™·é˜±ï¼‰"></a>3.1 ç²¾å‡†æ—¶é—´æµ‹é‡ï¼ˆé¿å…å¸¸è§é™·é˜±ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨time.Sinceæµ‹é‡è€—æ—¶</span></span><br><span class="line">start := time.Now()</span><br><span class="line"><span class="comment">// ... æ‰§è¡Œæ“ä½œ ...</span></span><br><span class="line">elapsed := time.Since(start)</span><br><span class="line">fmt.Printf(<span class="string">&quot;Operation took %v\n&quot;</span>, elapsed)</span><br><span class="line"></span><br><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šç›´æ¥ç›¸å‡ï¼ˆè™½å¯è¡Œä½†è¯­ä¹‰ä¸æ¸…æ™°ï¼‰</span></span><br><span class="line">elapsedWrong := time.Now().Sub(start)</span><br></pre></td></tr></table></figure><h3 id="3-2-æ—¶åŒºå®‰å…¨çš„æ—¶é—´å­˜å‚¨ï¼ˆæ•°æ®åº“æœ€ä½³å®è·µï¼‰"><a href="#3-2-æ—¶åŒºå®‰å…¨çš„æ—¶é—´å­˜å‚¨ï¼ˆæ•°æ®åº“æœ€ä½³å®è·µï¼‰" class="headerlink" title="3.2 æ—¶åŒºå®‰å…¨çš„æ—¶é—´å­˜å‚¨ï¼ˆæ•°æ®åº“æœ€ä½³å®è·µï¼‰"></a>3.2 æ—¶åŒºå®‰å…¨çš„æ—¶é—´å­˜å‚¨ï¼ˆæ•°æ®åº“æœ€ä½³å®è·µï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­˜å‚¨åˆ°æ•°æ®åº“ï¼šå§‹ç»ˆç”¨UTC+UnixNano</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">storeTimeToDB</span><span class="params">(t time.Time)</span></span> <span class="type">int64</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.UTC().UnixNano() <span class="comment">// 8å­—èŠ‚å­˜å‚¨ï¼Œæ— æ—¶åŒºæ­§ä¹‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»æ•°æ®åº“æ¢å¤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadTimeFromDB</span><span class="params">(nano <span class="type">int64</span>)</span></span> time.Time &#123;</span><br><span class="line">    <span class="keyword">return</span> time.Unix(<span class="number">0</span>, nano).UTC() <span class="comment">// æ˜¾å¼æŒ‡å®šUTC</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// APIå“åº”ï¼šæŒ‰å®¢æˆ·ç«¯æ—¶åŒºæ ¼å¼åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">formatForUser</span><span class="params">(t time.Time, loc *time.Location)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.In(loc).Format(<span class="string">&quot;2006-01-02 15:04:05 MST&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-é«˜çº§å®šæ—¶ä»»åŠ¡ï¼šå¸¦å–æ¶ˆçš„å‘¨æœŸæ‰§è¡Œ"><a href="#3-3-é«˜çº§å®šæ—¶ä»»åŠ¡ï¼šå¸¦å–æ¶ˆçš„å‘¨æœŸæ‰§è¡Œ" class="headerlink" title="3.3 é«˜çº§å®šæ—¶ä»»åŠ¡ï¼šå¸¦å–æ¶ˆçš„å‘¨æœŸæ‰§è¡Œ"></a>3.3 é«˜çº§å®šæ—¶ä»»åŠ¡ï¼šå¸¦å–æ¶ˆçš„å‘¨æœŸæ‰§è¡Œ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scheduledTask</span><span class="params">(ctx context.Context, interval time.Duration, task <span class="keyword">func</span>()</span></span>) &#123;</span><br><span class="line">    ticker := time.NewTicker(interval)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop() <span class="comment">// ç¡®ä¿èµ„æºé‡Šæ”¾</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç«‹å³æ‰§è¡Œé¦–æ¬¡ä»»åŠ¡</span></span><br><span class="line">    task()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">            task()</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">return</span> <span class="comment">// ä¼˜é›…é€€å‡º</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">scheduledTask(ctx, <span class="number">2</span>*time.Second, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Task executed at&quot;</span>, time.Now().Format(time.RFC3339))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="3-4-è‡ªå®šä¹‰æ ¼å¼è§£æï¼ˆé¿å…Layouté™·é˜±ï¼‰"><a href="#3-4-è‡ªå®šä¹‰æ ¼å¼è§£æï¼ˆé¿å…Layouté™·é˜±ï¼‰" class="headerlink" title="3.4 è‡ªå®šä¹‰æ ¼å¼è§£æï¼ˆé¿å…Layouté™·é˜±ï¼‰"></a>3.4 è‡ªå®šä¹‰æ ¼å¼è§£æï¼ˆé¿å…Layouté™·é˜±ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨å‚è€ƒæ—¶é—´&quot;Mon Jan 2 15:04:05 MST 2006&quot;</span></span><br><span class="line"><span class="comment">// è¿™æ˜¯Goè®¾è®¡çš„&quot;è®°å¿†é”šç‚¹&quot;ï¼šå„å­—æ®µå€¼å¯¹åº”å…¶æ ¼å¼æ„ä¹‰ã€è®°å¿†è§„å¾‹ï¼š20006å¹´ï¼Œä¸€(01)äºŒ(02)ä¸‰(15)å››(04)äº”(05)</span></span><br><span class="line">layout := <span class="string">&quot;2006-01-02 15:04:05&quot;</span></span><br><span class="line">t, err := time.Parse(layout, <span class="string">&quot;2026-01-30 14:30:00&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âŒ å¸¸è§é”™è¯¯ï¼šè¯¯ç”¨å…¶ä»–æ—¥æœŸä½œä¸ºLayout</span></span><br><span class="line">wrongLayout := <span class="string">&quot;2024-12-25 10:00:00&quot;</span> <span class="comment">// ä¼šå¯¼è‡´è§£æå¤±è´¥ï¼</span></span><br></pre></td></tr></table></figure><p>Goçš„æ ¼å¼åŒ–è®¾è®¡å“²å­¦ï¼š<strong>Layoutå¿…é¡»æ˜¯å‚è€ƒæ—¶é—´â€Mon Jan 2 15:04:05 MST 2006â€çš„å˜ä½“</strong>ï¼Œè€Œéæ¨¡å¼å­—ç¬¦ä¸²ã€‚</p><h2 id="å››ã€é¿å‘æŒ‡å—ï¼š5å¤§é«˜é¢‘é™·é˜±ï¼ˆå°¤å…¶æ³¨æ„æ•°æ®ç±»å‹ï¼‰"><a href="#å››ã€é¿å‘æŒ‡å—ï¼š5å¤§é«˜é¢‘é™·é˜±ï¼ˆå°¤å…¶æ³¨æ„æ•°æ®ç±»å‹ï¼‰" class="headerlink" title="å››ã€é¿å‘æŒ‡å—ï¼š5å¤§é«˜é¢‘é™·é˜±ï¼ˆå°¤å…¶æ³¨æ„æ•°æ®ç±»å‹ï¼‰"></a>å››ã€é¿å‘æŒ‡å—ï¼š5å¤§é«˜é¢‘é™·é˜±ï¼ˆå°¤å…¶æ³¨æ„æ•°æ®ç±»å‹ï¼‰</h2><h3 id="é™·é˜±1ï¼štime-Timeé›¶å€¼é™·é˜±"><a href="#é™·é˜±1ï¼štime-Timeé›¶å€¼é™·é˜±" class="headerlink" title="é™·é˜±1ï¼štime.Timeé›¶å€¼é™·é˜±"></a>é™·é˜±1ï¼štime.Timeé›¶å€¼é™·é˜±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t time.Time</span><br><span class="line">fmt.Println(t.IsZero()) <span class="comment">// true</span></span><br><span class="line">fmt.Println(t.Format(time.RFC3339)) <span class="comment">// &quot;0001-01-01T00:00:00Z&quot;ï¼ˆæ˜“è¢«è¯¯è®¤ä¸ºæœ‰æ•ˆæ—¶é—´ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®‰å…¨åšæ³•ï¼šæ˜¾å¼æ£€æŸ¥é›¶å€¼</span></span><br><span class="line"><span class="keyword">if</span> t.IsZero() &#123;</span><br><span class="line">    t = time.Now() <span class="comment">// æˆ–è¿”å›é”™è¯¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é™·é˜±2ï¼šLocationæœªè®¾ç½®å¯¼è‡´æ—¶åŒºä¸¢å¤±"><a href="#é™·é˜±2ï¼šLocationæœªè®¾ç½®å¯¼è‡´æ—¶åŒºä¸¢å¤±" class="headerlink" title="é™·é˜±2ï¼šLocationæœªè®¾ç½®å¯¼è‡´æ—¶åŒºä¸¢å¤±"></a>é™·é˜±2ï¼šLocationæœªè®¾ç½®å¯¼è‡´æ—¶åŒºä¸¢å¤±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ï¼šParseè¿”å›çš„Timeé»˜è®¤æ— æ—¶åŒºï¼ˆUTCï¼‰</span></span><br><span class="line">t, _ := time.Parse(<span class="string">&quot;2006-01-02&quot;</span>, <span class="string">&quot;2026-01-30&quot;</span>)</span><br><span class="line">fmt.Println(t.Location()) <span class="comment">// UTC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ï¼šæ˜¾å¼æŒ‡å®šæ—¶åŒº</span></span><br><span class="line">shanghai, _ := time.LoadLocation(<span class="string">&quot;Asia/Shanghai&quot;</span>)</span><br><span class="line">t = t.In(shanghai)</span><br></pre></td></tr></table></figure><h3 id="é™·é˜±3ï¼šDurationæº¢å‡ºé£é™©"><a href="#é™·é˜±3ï¼šDurationæº¢å‡ºé£é™©" class="headerlink" title="é™·é˜±3ï¼šDurationæº¢å‡ºé£é™©"></a>é™·é˜±3ï¼šDurationæº¢å‡ºé£é™©</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ å±é™©ï¼šint32ä¹˜æ³•å¯èƒ½æº¢å‡º</span></span><br><span class="line">days := <span class="number">1000000</span></span><br><span class="line">d := time.Duration(days * <span class="number">24</span> * time.Hour) <span class="comment">// æº¢å‡ºï¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… å®‰å…¨ï¼šä½¿ç”¨int64æˆ–timeåŒ…å¸¸é‡</span></span><br><span class="line">d = time.Duration(days) * <span class="number">24</span> * time.Hour</span><br><span class="line"><span class="comment">// æˆ–</span></span><br><span class="line">d = <span class="number">24</span> * time.Hour * time.Duration(days)</span><br></pre></td></tr></table></figure><h3 id="é™·é˜±4ï¼šTickeræœªStopå¯¼è‡´èµ„æºæ³„æ¼"><a href="#é™·é˜±4ï¼šTickeræœªStopå¯¼è‡´èµ„æºæ³„æ¼" class="headerlink" title="é™·é˜±4ï¼šTickeræœªStopå¯¼è‡´èµ„æºæ³„æ¼"></a>é™·é˜±4ï¼šTickeræœªStopå¯¼è‡´èµ„æºæ³„æ¼</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Go 1.22åŠä¹‹å‰å¿…é¡»æ˜¾å¼Stop</span></span><br><span class="line">ticker := time.NewTicker(<span class="number">1</span> * time.Second)</span><br><span class="line"><span class="keyword">defer</span> ticker.Stop() <span class="comment">// å…³é”®ï¼</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é™·é˜±5ï¼šJSONåºåˆ—åŒ–æ—¶åŒºä¸¢å¤±"><a href="#é™·é˜±5ï¼šJSONåºåˆ—åŒ–æ—¶åŒºä¸¢å¤±" class="headerlink" title="é™·é˜±5ï¼šJSONåºåˆ—åŒ–æ—¶åŒºä¸¢å¤±"></a>é™·é˜±5ï¼šJSONåºåˆ—åŒ–æ—¶åŒºä¸¢å¤±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Event <span class="keyword">struct</span> &#123;</span><br><span class="line">    Timestamp time.Time <span class="string">`json:&quot;ts&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">e := Event&#123;Timestamp: time.Now()&#125;</span><br><span class="line">data, _ := json.Marshal(e)</span><br><span class="line"><span class="comment">// è¾“å‡º: &#123;&quot;ts&quot;:&quot;2026-01-30T14:30:00+08:00&quot;&#125;  âœ“ ä¿ç•™æ—¶åŒºåç§»</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½†ååºåˆ—åŒ–æ—¶ä¼šè½¬ä¸ºUTCï¼š</span></span><br><span class="line"><span class="keyword">var</span> e2 Event</span><br><span class="line">json.Unmarshal(data, &amp;e2)</span><br><span class="line">fmt.Println(e2.Timestamp.Location()) <span class="comment">// UTCï¼</span></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆï¼šè‡ªå®šä¹‰MarshalJSON/UnmarshalJSON</span></span><br></pre></td></tr></table></figure><h2 id="äº”ã€æ€§èƒ½ä¼˜åŒ–æŠ€å·§"><a href="#äº”ã€æ€§èƒ½ä¼˜åŒ–æŠ€å·§" class="headerlink" title="äº”ã€æ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>äº”ã€æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h2><h3 id="5-1-é¿å…é‡å¤åŠ è½½Location"><a href="#5-1-é¿å…é‡å¤åŠ è½½Location" class="headerlink" title="5.1 é¿å…é‡å¤åŠ è½½Location"></a>5.1 é¿å…é‡å¤åŠ è½½Location</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¨å±€ç¼“å­˜æ—¶åŒºï¼ˆLocationçº¿ç¨‹å®‰å…¨ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    shanghaiTZ *time.Location</span><br><span class="line">    once       sync.Once</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getShanghaiTZ</span><span class="params">()</span></span> *time.Location &#123;</span><br><span class="line">    once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        shanghaiTZ, _ = time.LoadLocation(<span class="string">&quot;Asia/Shanghai&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> shanghaiTZ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-æ‰¹é‡æ—¶é—´æ ¼å¼åŒ–ä¼˜åŒ–"><a href="#5-2-æ‰¹é‡æ—¶é—´æ ¼å¼åŒ–ä¼˜åŒ–" class="headerlink" title="5.2 æ‰¹é‡æ—¶é—´æ ¼å¼åŒ–ä¼˜åŒ–"></a>5.2 æ‰¹é‡æ—¶é—´æ ¼å¼åŒ–ä¼˜åŒ–</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½æ•ˆï¼šæ¯æ¬¡Formatéƒ½è§£æLayout</span></span><br><span class="line"><span class="keyword">for</span> _, t := <span class="keyword">range</span> timestamps &#123;</span><br><span class="line">    fmt.Println(t.Format(<span class="string">&quot;2006-01-02&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜æ•ˆï¼šé¢„ç¼–è¯‘Layoutï¼ˆGo 1.17+ï¼‰</span></span><br><span class="line">layout := <span class="string">&quot;2006-01-02&quot;</span></span><br><span class="line"><span class="keyword">for</span> _, t := <span class="keyword">range</span> timestamps &#123;</span><br><span class="line">    fmt.Println(t.Format(layout)) <span class="comment">// å†…éƒ¨ç¼“å­˜è§£æç»“æœ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…­ã€æ€»ç»“ï¼štimeåŒ…è®¾è®¡å“²å­¦"><a href="#å…­ã€æ€»ç»“ï¼štimeåŒ…è®¾è®¡å“²å­¦" class="headerlink" title="å…­ã€æ€»ç»“ï¼štimeåŒ…è®¾è®¡å“²å­¦"></a>å…­ã€æ€»ç»“ï¼štimeåŒ…è®¾è®¡å“²å­¦</h2><p>Goçš„timeåŒ…ä½“ç°äº†ä¸‰å¤§è®¾è®¡å“²å­¦ï¼š</p><ol><li><strong>ç²¾ç¡®æ€§ä¼˜å…ˆ</strong>ï¼šå•è°ƒæ—¶é’Ÿä¿éšœæ—¶é—´å·®è®¡ç®—çš„å¯é æ€§ï¼Œé¿å…åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶é’Ÿæ¼‚ç§»é—®é¢˜</li><li><strong>æ˜¾å¼ä¼˜äºéšå¼</strong>ï¼šæ—¶åŒºå¿…é¡»æ˜¾å¼å¤„ç†ï¼Œæœç»â€é­”æ³•è¡Œä¸ºâ€</li><li><strong>é›¶å€¼æœ‰æ„ä¹‰</strong>ï¼š<code>time.Time&#123;&#125;</code>è¡¨ç¤ºå…¬å…ƒ1å¹´1æœˆ1æ—¥ï¼Œ<code>IsZero()</code>æä¾›å®‰å…¨æ£€æŸ¥</li></ol><p>æŒæ¡timeåŒ…çš„å…³é”®ï¼š<strong>ç†è§£Timeçš„åŒé‡æ—¶é’Ÿæœ¬è´¨ + ä¸¥æ ¼ç®¡ç†æ—¶åŒºç”Ÿå‘½å‘¨æœŸ + å–„ç”¨1.23+çš„å®šæ—¶å™¨æ”¹è¿›</strong>ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®å§‹ç»ˆä»¥UTCå­˜å‚¨æ—¶é—´ï¼Œä»…åœ¨å±•ç¤ºå±‚è½¬æ¢æ—¶åŒºï¼Œè¿™æ˜¯æ„å»ºå…¨çƒåŒ–åº”ç”¨çš„é»„é‡‘æ³•åˆ™ã€‚</p><hr><p><strong>å»¶ä¼¸é˜…è¯»</strong>ï¼š</p><ul><li>æºç ç²¾è¯»ï¼š<code>$GOROOT/src/time/time.go</code>ï¼ˆé‡ç‚¹é˜…è¯»<code>Time</code>ç»“æ„ä½“æ³¨é‡Šï¼‰</li><li>æ—¶åŒºæ•°æ®åº“ï¼šIANA Time Zone Databaseè§„èŒƒ</li><li>æ€§èƒ½åŸºå‡†ï¼š<code>go test -bench=BenchmarkTime</code> æŸ¥çœ‹å®˜æ–¹åŸºå‡†æµ‹è¯•</li></ul><p>æœ¬æ–‡æ‰€è¿°æ‰€æœ‰ä»£ç å‡åœ¨Go 1.25ç¯å¢ƒç‰ˆæœ¬ä¸‹éªŒè¯ï¼Œç¬¦åˆGo 1å…¼å®¹æ€§æ‰¿è¯ºï¼Œå¯å®‰å…¨ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€timeåŒ…æ¶æ„åº“å‡½æ•°å…¨æ™¯æ€»è§ˆï¼šä¸€å¼ å›¾çœ‹æ‡‚timeåº“æ ¸å¿ƒæ„æˆ&quot;&gt;&lt;a href=&quot;#ä¸€ã€timeåŒ…æ¶æ„åº“å‡½æ•°å…¨æ™¯æ€»è§ˆï¼šä¸€å¼ å›¾çœ‹æ‡‚timeåº“æ ¸å¿ƒæ„æˆ&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€timeåŒ…æ¶æ„åº“å‡½æ•°å…¨æ™¯æ€»è§ˆï¼šä¸€å¼ å›¾çœ‹æ‡‚timeåº“æ ¸å¿ƒæ„æˆ&quot;&gt;&lt;/a&gt;ä¸€ã€timeåŒ…æ¶æ„åº“å‡½æ•°å…¨æ™¯æ€»è§ˆï¼šä¸€å¼ å›¾çœ‹æ‡‚timeåº“æ ¸å¿ƒæ„æˆ&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡åŸºäºGo 1.25æ ‡å‡†åº“ï¼Œå®Œå…¨åŸåˆ›è§£ætimeåŒ…è®¾è®¡å“²å­¦ä¸å®æˆ˜æŠ€å·§ï¼Œå¸®åŠ©æ–°æ‰‹å¿«é€Ÿå½»åº•æŒæ¡æ—¶é—´å¤„ç†çš„è‰ºæœ¯ã€‚&lt;br&gt;timeåŒ…é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œä»¥&lt;code&gt;Time&lt;/code&gt;ç»“æ„ä½“ä¸ºæ ¸å¿ƒï¼Œå›´ç»•&lt;strong&gt;æ—¶é—´è¡¨ç¤º&lt;/strong&gt;ã€&lt;strong&gt;æ—¶é—´è®¡ç®—&lt;/strong&gt;ã€&lt;strong&gt;å®šæ—¶å™¨&lt;/strong&gt;ã€&lt;strong&gt;æ ¼å¼åŒ–&lt;/strong&gt;å››å¤§ç»´åº¦æ„å»ºå®Œæ•´ç”Ÿæ€ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-time" scheme="https://www.wdft.com/tags/Go-time/"/>
    
  </entry>
  
  <entry>
    <title>ã€logã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“logåŒ…è®¾è®¡åŸç†ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/916d238a.html"/>
    <id>https://www.wdft.com/916d238a.html</id>
    <published>2026-01-27T18:32:14.000Z</published>
    <updated>2026-02-02T10:12:48.545Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€å…ˆçœ‹ä¸€ä¸‹logåŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ"><a href="#ä¸€ã€å…ˆçœ‹ä¸€ä¸‹logåŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ" class="headerlink" title="ä¸€ã€å…ˆçœ‹ä¸€ä¸‹logåŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ"></a>ä¸€ã€å…ˆçœ‹ä¸€ä¸‹logåŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ</h2><p>Goæ ‡å‡†åº“<code>log</code>åŒ…è®¾è®¡æç®€è€Œå¼ºå¤§ï¼Œæ ¸å¿ƒå›´ç»•<code>Logger</code>ç±»å‹æ„å»ºï¼ŒåŒæ—¶æä¾›ä¾¿æ·çš„å…¨å±€æ—¥å¿—æ¥å£ã€‚ä¸‹å›¾å®Œæ•´å±•ç¤ºäº†logåŒ…çš„APIä½“ç³»ç»“æ„ï¼š</p><span id="more"></span><pre class="mermaid">flowchart LR    subgraph A [æ—¥å¿—æ ‡å¿—å¸¸é‡]        A1[Ldate<br>æ—¥æœŸè¾“å‡º] --> A2[Ltime<br>æ—¶é—´è¾“å‡º]        A2 --> A3[Lmicroseconds<br>å¾®ç§’ç²¾åº¦]        A3 --> A4[Llongfile<br>å®Œæ•´æ–‡ä»¶è·¯å¾„]        A4 --> A5[Lshortfile<br>çŸ­æ–‡ä»¶å]        A5 --> A6[LUTC<br>UTCæ—¶åŒº]        A6 --> A7[Lmsgprefix<br>å‰ç¼€ä½ç½®æ§åˆ¶]        A7 --> A8[LstdFlags<br>é»˜è®¤æ ‡å¿—ç»„åˆ]    end    subgraph B [Loggeræ„é€ ä¸é…ç½®]        B1[New<br>åˆ›å»ºLoggerå®ä¾‹] --> B2[SetOutput<br>è®¾ç½®è¾“å‡ºç›®æ ‡]        B2 --> B3[SetFlags<br>è®¾ç½®æ ¼å¼æ ‡å¿—]        B3 --> B4[SetPrefix<br>è®¾ç½®æ—¥å¿—å‰ç¼€]        B4 --> B5[Flags/Prefx/Writer<br>è·å–å½“å‰é…ç½®]    end    subgraph C [æ ‡å‡†æ—¥å¿—è¾“å‡º]        C1[Print/Printf/Println<br>æ™®é€šæ—¥å¿—è¾“å‡º] --> C2[Fatal/Fatalf/Fatalln<br>è‡´å‘½é”™è¯¯+é€€å‡ºç¨‹åº]        C2 --> C3[Panic/Panicf/Panicln<br>è§¦å‘panicå¼‚å¸¸]    end    subgraph D [å…¨å±€Loggeræ“ä½œ]        D1[Default<br>è·å–æ ‡å‡†Logger] --> D2[SetOutput/Flags/Prefix<br>é…ç½®å…¨å±€Logger]        D2 --> D3[Print/Fatal/Panicç³»åˆ—<br>ç›´æ¥è°ƒç”¨å…¨å±€æ—¥å¿—]    end    B1 --> C1    B1 --> C2    B1 --> C3    D1 --> D3    style A fill:#e1f5fe,stroke:#01579b    style B fill:#e8f5e8,stroke:#1b5e20    style C fill:#fff3e0,stroke:#e65100    style D fill:#f3e5f5,stroke:#4a148c</pre><h3 id="æ ¸å¿ƒAPIåˆ†ç±»è¯´æ˜"><a href="#æ ¸å¿ƒAPIåˆ†ç±»è¯´æ˜" class="headerlink" title="æ ¸å¿ƒAPIåˆ†ç±»è¯´æ˜"></a>æ ¸å¿ƒAPIåˆ†ç±»è¯´æ˜</h3><table><thead><tr><th>ç±»åˆ«</th><th>æˆå‘˜</th><th>åŠŸèƒ½è¯´æ˜</th></tr></thead><tbody><tr><td><strong>æ ‡å¿—å¸¸é‡</strong></td><td><code>Ldate</code>, <code>Ltime</code>, <code>Lmicroseconds</code>, <code>Llongfile</code>, <code>Lshortfile</code>, <code>LUTC</code>, <code>Lmsgprefix</code>, <code>LstdFlags</code></td><td>æ§åˆ¶æ—¥å¿—æ ¼å¼è¾“å‡ºçš„ä½æ ‡å¿—ï¼Œå¯æŒ‰ä½æˆ–ç»„åˆä½¿ç”¨</td></tr><tr><td><strong>Loggeræ„é€ </strong></td><td><code>New(out io.Writer, prefix string, flag int) *Logger</code></td><td>åˆ›å»ºè‡ªå®šä¹‰Loggerå®ä¾‹ï¼ŒæŒ‡å®šè¾“å‡ºç›®æ ‡ã€å‰ç¼€å’Œæ ¼å¼æ ‡å¿—</td></tr><tr><td><strong>é…ç½®æ–¹æ³•</strong></td><td><code>SetOutput</code>, <code>SetFlags</code>, <code>SetPrefix</code></td><td>åŠ¨æ€ä¿®æ”¹Loggerçš„è¾“å‡ºç›®æ ‡ã€æ ¼å¼æ ‡å¿—å’Œå‰ç¼€</td></tr><tr><td><strong>æŸ¥è¯¢æ–¹æ³•</strong></td><td><code>Flags()</code>, <code>Prefix()</code>, <code>Writer()</code></td><td>è·å–Loggerå½“å‰é…ç½®çŠ¶æ€</td></tr><tr><td><strong>æ—¥å¿—è¾“å‡º</strong></td><td><code>Print*</code>, <code>Fatal*</code>, <code>Panic*</code> ä¸‰ç»„æ–¹æ³•</td><td>åˆ†åˆ«å¯¹åº”æ™®é€šæ—¥å¿—ã€è‡´å‘½é”™è¯¯ï¼ˆé€€å‡ºç¨‹åºï¼‰ã€panicå¼‚å¸¸ä¸‰ç§çº§åˆ«</td></tr><tr><td><strong>åº•å±‚æ¥å£</strong></td><td><code>Output(calldepth int, s string) error</code></td><td>æ—¥å¿—æ ¼å¼åŒ–ä¸è¾“å‡ºçš„æ ¸å¿ƒå®ç°ï¼Œæ”¯æŒè°ƒç”¨æ ˆæ·±åº¦æ§åˆ¶</td></tr><tr><td><strong>å…¨å±€æ“ä½œ</strong></td><td><code>Default()</code>, <code>SetOutput()</code>ç­‰åŒ…çº§å‡½æ•°</td><td>æ“ä½œé¢„å®šä¹‰çš„æ ‡å‡†Loggerï¼ˆé»˜è®¤è¾“å‡ºåˆ°stderrï¼‰</td></tr></tbody></table><h2 id="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"><a href="#äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ" class="headerlink" title="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"></a>äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ</h2><h6 id="å¤‡æ³¨ï¼šä»¥ä¸‹ä»£ç åŸºäºGo-1-22-ç‰ˆæœ¬"><a href="#å¤‡æ³¨ï¼šä»¥ä¸‹ä»£ç åŸºäºGo-1-22-ç‰ˆæœ¬" class="headerlink" title="å¤‡æ³¨ï¼šä»¥ä¸‹ä»£ç åŸºäºGo 1.22+ ç‰ˆæœ¬"></a>å¤‡æ³¨ï¼šä»¥ä¸‹ä»£ç åŸºäºGo 1.22+ ç‰ˆæœ¬</h6><h3 id="2-1-Loggerç»“æ„ä½“å†…å­˜å¸ƒå±€"><a href="#2-1-Loggerç»“æ„ä½“å†…å­˜å¸ƒå±€" class="headerlink" title="2.1 Loggerç»“æ„ä½“å†…å­˜å¸ƒå±€"></a>2.1 Loggerç»“æ„ä½“å†…å­˜å¸ƒå±€</h3><p>Go 1.21+ç‰ˆæœ¬å¯¹<code>Logger</code>ç»“æ„ä½“è¿›è¡Œäº†åŸå­åŒ–æ”¹é€ ï¼Œæå‡å¹¶å‘æ€§èƒ½ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Logger <span class="keyword">struct</span> &#123;</span><br><span class="line">    outMu     sync.Mutex          <span class="comment">// ä¿æŠ¤outå­—æ®µçš„äº’æ–¥é”</span></span><br><span class="line">    out       io.Writer           <span class="comment">// æ—¥å¿—è¾“å‡ºç›®æ ‡ï¼ˆå¦‚os.Stderrï¼‰</span></span><br><span class="line">    prefix    atomic.Pointer[<span class="type">string</span>] <span class="comment">// æ—¥å¿—å‰ç¼€ï¼ˆåŸå­æŒ‡é’ˆï¼Œæ— é”è¯»å–ï¼‰</span></span><br><span class="line">    flag      atomic.Int32        <span class="comment">// æ ¼å¼æ ‡å¿—ä½ï¼ˆåŸå­æ•´æ•°ï¼‰</span></span><br><span class="line">    isDiscard atomic.Bool         <span class="comment">// æ˜¯å¦ä¸¢å¼ƒæ—¥å¿—ï¼ˆç”¨äºæ€§èƒ½ä¼˜åŒ–ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®è®¾è®¡äº®ç‚¹ï¼š</strong></p><ul><li><strong>è¯»å†™åˆ†ç¦»ä¼˜åŒ–</strong>ï¼š<code>prefix</code>å’Œ<code>flag</code>ä½¿ç”¨åŸå­æ“ä½œï¼Œè¯»å–æ— éœ€åŠ é”ï¼Œä»…åœ¨ä¿®æ”¹æ—¶é€šè¿‡<code>atomic</code>åŒ…ä¿è¯çº¿ç¨‹å®‰å…¨</li><li><strong>å†™æ“ä½œä¿æŠ¤</strong>ï¼š<code>out</code>å­—æ®µä»éœ€<code>sync.Mutex</code>ä¿æŠ¤ï¼Œå› ä¸º<code>io.Writer</code>çš„<code>Write</code>æ–¹æ³•å¯èƒ½æœ‰å†…éƒ¨çŠ¶æ€</li><li><strong>é›¶åˆ†é…ä¼˜åŒ–</strong>ï¼š<code>isDiscard</code>æ ‡å¿—å…è®¸åœ¨æ— éœ€æ—¥å¿—æ—¶è·³è¿‡æ ¼å¼åŒ–ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…</li></ul><h3 id="2-2-å¹¶å‘å®‰å…¨æœºåˆ¶"><a href="#2-2-å¹¶å‘å®‰å…¨æœºåˆ¶" class="headerlink" title="2.2 å¹¶å‘å®‰å…¨æœºåˆ¶"></a>2.2 å¹¶å‘å®‰å…¨æœºåˆ¶</h3><p>logåŒ…çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äº<strong>å¤©ç„¶çš„goroutineå®‰å…¨</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Logger.Outputæ ¸å¿ƒå®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span></span> Output(calldepth <span class="type">int</span>, s <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    now := time.Now() <span class="comment">// è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">    <span class="keyword">var</span> buf []<span class="type">byte</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. æ ¼å¼åŒ–æ—¶é—´/æ–‡ä»¶ä¿¡æ¯ï¼ˆæ— é”æ“ä½œï¼Œä½¿ç”¨åŸå­è¯»å–flag/prefixï¼‰</span></span><br><span class="line">    buf = l.appendTime(buf, now)</span><br><span class="line">    buf = l.appendFile(buf, calldepth) <span class="comment">// é€šè¿‡runtime.Callerè·å–è°ƒç”¨æ ˆ</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ·»åŠ å‰ç¼€ï¼ˆåŸå­è¯»å–ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> prefix := l.prefix.Load(); prefix != <span class="literal">nil</span> &amp;&amp; *prefix != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        buf = <span class="built_in">append</span>(buf, *prefix...)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æ·»åŠ æ—¥å¿—æ¶ˆæ¯</span></span><br><span class="line">    buf = <span class="built_in">append</span>(buf, s...)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ä¿è¯å•æ¬¡Writeè°ƒç”¨ï¼ˆå…³é”®å¹¶å‘å®‰å…¨ç‚¹ï¼‰</span></span><br><span class="line">    l.outMu.Lock()</span><br><span class="line">    _, err := l.out.Write(buf) <span class="comment">// å•æ¬¡Writeä¿è¯æ¶ˆæ¯åŸå­æ€§</span></span><br><span class="line">    l.outMu.Unlock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¹¶å‘å®‰å…¨ä¸‰é‡ä¿éšœï¼š</strong></p><ol><li><strong>æ ¼å¼åŒ–é˜¶æ®µ</strong>ï¼šä½¿ç”¨åŸå­æ“ä½œè¯»å–é…ç½®ï¼Œæ— é”é«˜æ€§èƒ½</li><li><strong>è¾“å‡ºé˜¶æ®µ</strong>ï¼šé€šè¿‡<code>outMu</code>äº’æ–¥é”ä¿æŠ¤<code>Write</code>è°ƒç”¨ï¼Œé¿å…å¤šgoroutineäº¤é”™å†™å…¥</li><li><strong>åŸå­å†™å…¥</strong>ï¼šæ¯æ¬¡æ—¥å¿—ç”Ÿæˆå•ä¸ª<code>[]byte</code>ï¼Œç¡®ä¿å•æ¬¡<code>Write</code>è°ƒç”¨çš„å®Œæ•´æ€§</li></ol><h3 id="2-3-è°ƒç”¨æ ˆæ·±åº¦-calldepth-æœºåˆ¶"><a href="#2-3-è°ƒç”¨æ ˆæ·±åº¦-calldepth-æœºåˆ¶" class="headerlink" title="2.3 è°ƒç”¨æ ˆæ·±åº¦(calldepth)æœºåˆ¶"></a>2.3 è°ƒç”¨æ ˆæ·±åº¦(calldepth)æœºåˆ¶</h3><p><code>Output</code>æ–¹æ³•çš„<code>calldepth</code>å‚æ•°ç”¨äºç²¾å‡†å®šä½æ—¥å¿—è°ƒç”¨æºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨é“¾ç¤ºä¾‹ï¼šmain â†’ log.Println â†’ Logger.Output â†’ runtime.Caller</span></span><br><span class="line"><span class="comment">// å½“åœ¨Logger.Outputä¸­è°ƒç”¨runtime.Caller(2)æ—¶ï¼š</span></span><br><span class="line"><span class="comment">//   0: runtime.Callerè‡ªèº«</span></span><br><span class="line"><span class="comment">//   1: Logger.Output</span></span><br><span class="line"><span class="comment">//   2: log.Printlnï¼ˆæˆ‘ä»¬æƒ³å®šä½çš„ä½ç½®ï¼‰</span></span><br><span class="line"><span class="comment">//   3: mainå‡½æ•°ï¼ˆå®é™…ä¸šåŠ¡ä»£ç ï¼‰</span></span><br></pre></td></tr></table></figure><p><strong>å®è·µè§„åˆ™ï¼š</strong></p><ul><li>ç›´æ¥è°ƒç”¨<code>Logger.Output(2, ...)</code>ï¼šå®šä½åˆ°è°ƒç”¨<code>Output</code>çš„ä¸Šä¸€å±‚ï¼ˆå³Print*æ–¹æ³•ï¼‰</li><li>åŒ…è£…æ—¥å¿—å‡½æ•°æ—¶éœ€å¢åŠ depthï¼š<code>myLog(msg) &#123; std.Output(3, msg) &#125;</code>ï¼ˆå¤šä¸€å±‚åŒ…è£…ï¼‰</li></ul><h2 id="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸é™·é˜±"><a href="#ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸é™·é˜±" class="headerlink" title="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸é™·é˜±"></a>ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸é™·é˜±</h2><h3 id="3-1-Fatal-x2F-Panicçš„ç¨‹åºç»ˆæ­¢è¡Œä¸º"><a href="#3-1-Fatal-x2F-Panicçš„ç¨‹åºç»ˆæ­¢è¡Œä¸º" class="headerlink" title="3.1 Fatal&#x2F;Panicçš„ç¨‹åºç»ˆæ­¢è¡Œä¸º"></a>3.1 Fatal&#x2F;Panicçš„ç¨‹åºç»ˆæ­¢è¡Œä¸º</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log.Fatal(<span class="string">&quot;ç¨‹åºç»ˆæ­¢&quot;</span>)   <span class="comment">// å†™å…¥æ—¥å¿—åç«‹å³è°ƒç”¨os.Exit(1)ï¼Œdeferä¸ä¼šæ‰§è¡Œï¼</span></span><br><span class="line">log.Panic(<span class="string">&quot;è§¦å‘panic&quot;</span>)  <span class="comment">// å†™å…¥æ—¥å¿—åè°ƒç”¨panic()ï¼Œä¼šè§¦å‘deferå’Œrecover</span></span><br></pre></td></tr></table></figure><p><strong>é‡è¦åŒºåˆ«ï¼š</strong></p><ul><li><code>Fatal*</code>ç³»åˆ—<strong>ä¸ä¼šæ‰§è¡Œ</strong><code>defer</code>è¯­å¥ï¼Œç›´æ¥ç»ˆæ­¢è¿›ç¨‹</li><li><code>Panic*</code>ç³»åˆ—ä¼šè§¦å‘panicï¼Œå¯è¢«<code>recover</code>æ•è·ï¼Œé€‚åˆéœ€è¦æ¸…ç†èµ„æºçš„åœºæ™¯</li></ul><h3 id="3-2-Lshortfileä¸Llongfileäº’æ–¥æ€§"><a href="#3-2-Lshortfileä¸Llongfileäº’æ–¥æ€§" class="headerlink" title="3.2 Lshortfileä¸Llongfileäº’æ–¥æ€§"></a>3.2 Lshortfileä¸Llongfileäº’æ–¥æ€§</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç”¨æ³•ï¼šåŒæ—¶è®¾ç½®ä¸¤è€…ï¼ŒLshortfileä¼šè¦†ç›–Llongfile</span></span><br><span class="line">logger.SetFlags(log.Llongfile | log.Lshortfile) </span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®ç”¨æ³•ï¼šäºŒé€‰ä¸€</span></span><br><span class="line">logger.SetFlags(log.Lshortfile) <span class="comment">// è¾“å‡ºï¼šmain.go:42</span></span><br><span class="line"><span class="comment">// æˆ–</span></span><br><span class="line">logger.SetFlags(log.Llongfile)  <span class="comment">// è¾“å‡ºï¼š/home/user/project/main.go:42</span></span><br></pre></td></tr></table></figure><h3 id="3-3-Lmsgprefixçš„å‰ç¼€ä½ç½®æ§åˆ¶"><a href="#3-3-Lmsgprefixçš„å‰ç¼€ä½ç½®æ§åˆ¶" class="headerlink" title="3.3 Lmsgprefixçš„å‰ç¼€ä½ç½®æ§åˆ¶"></a>3.3 Lmsgprefixçš„å‰ç¼€ä½ç½®æ§åˆ¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤è¡Œä¸ºï¼ˆæ— Lmsgprefixï¼‰ï¼š</span></span><br><span class="line"><span class="comment">// 2024/02/02 10:30:45 [INFO] message</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ç”¨Lmsgprefixåï¼š</span></span><br><span class="line"><span class="comment">// 2024/02/02 10:30:45 message [INFO]</span></span><br><span class="line">logger.SetFlags(log.LstdFlags | log.Lmsgprefix)</span><br><span class="line">logger.SetPrefix(<span class="string">&quot;[INFO] &quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå½“éœ€è¦å°†å‰ç¼€ä½œä¸ºæ¶ˆæ¯è¯­ä¹‰çš„ä¸€éƒ¨åˆ†ï¼ˆå¦‚æ—¥å¿—çº§åˆ«æ ‡ç­¾ï¼‰è€Œéå…ƒæ•°æ®æ—¶ã€‚</p><h3 id="3-4-å¤šLoggerå®ä¾‹çš„æ€§èƒ½è€ƒé‡"><a href="#3-4-å¤šLoggerå®ä¾‹çš„æ€§èƒ½è€ƒé‡" class="headerlink" title="3.4 å¤šLoggerå®ä¾‹çš„æ€§èƒ½è€ƒé‡"></a>3.4 å¤šLoggerå®ä¾‹çš„æ€§èƒ½è€ƒé‡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åæ¨¡å¼ï¼šé«˜é¢‘åˆ›å»ºLoggerå®ä¾‹ï¼ˆæ¯æ¬¡Newåˆ†é…æ–°å¯¹è±¡ï¼‰</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">    log.New(os.Stdout, fmt.Sprintf(<span class="string">&quot;worker-%d: &quot;</span>, i), log.LstdFlags).Println(<span class="string">&quot;msg&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®åšæ³•ï¼šé¢„åˆ›å»ºLoggerå®ä¾‹å¤ç”¨</span></span><br><span class="line">loggers := <span class="built_in">make</span>([]*log.Logger, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> loggers &#123;</span><br><span class="line">    loggers[i] = log.New(os.Stdout, fmt.Sprintf(<span class="string">&quot;worker-%d: &quot;</span>, i), log.LstdFlags)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹"><a href="#å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹" class="headerlink" title="å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹"></a>å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹</h2><h3 id="4-1-å¤šæ¨¡å—éš”ç¦»æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰"><a href="#4-1-å¤šæ¨¡å—éš”ç¦»æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰" class="headerlink" title="4.1 å¤šæ¨¡å—éš”ç¦»æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰"></a>4.1 å¤šæ¨¡å—éš”ç¦»æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ºä¸åŒæ¨¡å—åˆ›å»ºç‹¬ç«‹Logger</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    dbLogger    = log.New(os.Stdout, <span class="string">&quot;[DB] &quot;</span>, log.LstdFlags|log.Lshortfile)</span><br><span class="line">    apiLogger   = log.New(os.Stdout, <span class="string">&quot;[API] &quot;</span>, log.LstdFlags|log.Lshortfile)</span><br><span class="line">    cacheLogger = log.New(os.Stdout, <span class="string">&quot;[CACHE] &quot;</span>, log.LstdFlags|log.Lmicroseconds)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dbLogger.Println(<span class="string">&quot;è¿æ¥æ•°æ®åº“&quot;</span>)</span><br><span class="line">    apiLogger.Printf(<span class="string">&quot;å¤„ç†è¯·æ±‚: %s&quot;</span>, <span class="string">&quot;/users&quot;</span>)</span><br><span class="line">    cacheLogger.Println(<span class="string">&quot;ç¼“å­˜å‘½ä¸­&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼ˆå¼€å‘/ç”Ÿäº§ç¯å¢ƒåˆ‡æ¢ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> os.Getenv(<span class="string">&quot;ENV&quot;</span>) == <span class="string">&quot;production&quot;</span> &#123;</span><br><span class="line">        <span class="comment">// ç”Ÿäº§ç¯å¢ƒç§»é™¤æ–‡ä»¶è¡Œå·ï¼ˆæå‡æ€§èƒ½ï¼‰</span></span><br><span class="line">        apiLogger.SetFlags(log.LstdFlags)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¾“å‡ºç¤ºä¾‹ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[DB] 2026/02/02 14:20:33 main.go:18: è¿æ¥æ•°æ®åº“</span><br><span class="line">[API] 2026/02/02 14:20:33 main.go:19: å¤„ç†è¯·æ±‚: /users</span><br><span class="line">[CACHE] 2026/02/02 14:20:33.456789 main.go:20: ç¼“å­˜å‘½ä¸­</span><br></pre></td></tr></table></figure><h3 id="4-2-æ—¥å¿—æ–‡ä»¶è½®è½¬åŸºç¡€å®ç°"><a href="#4-2-æ—¥å¿—æ–‡ä»¶è½®è½¬åŸºç¡€å®ç°" class="headerlink" title="4.2 æ—¥å¿—æ–‡ä»¶è½®è½¬åŸºç¡€å®ç°"></a>4.2 æ—¥å¿—æ–‡ä»¶è½®è½¬åŸºç¡€å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RotatingLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu        sync.Mutex</span><br><span class="line">    logger    *log.Logger</span><br><span class="line">    filename  <span class="type">string</span></span><br><span class="line">    maxSize   <span class="type">int64</span></span><br><span class="line">    currSize  <span class="type">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRotatingLogger</span><span class="params">(filename <span class="type">string</span>, maxSize <span class="type">int64</span>)</span></span> *RotatingLogger &#123;</span><br><span class="line">    file, _ := os.OpenFile(filename, os.O_CREATE|os.O_WRONLY|os.O_APPEND, <span class="number">0666</span>)</span><br><span class="line">    <span class="keyword">return</span> &amp;RotatingLogger&#123;</span><br><span class="line">        logger:   log.New(file, <span class="string">&quot;&quot;</span>, log.LstdFlags|log.Lshortfile),</span><br><span class="line">        filename: filename,</span><br><span class="line">        maxSize:  maxSize,</span><br><span class="line">        currSize: getSize(file),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rl *RotatingLogger)</span></span> Write(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    rl.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> rl.mu.Unlock()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦è½®è½¬</span></span><br><span class="line">    <span class="keyword">if</span> rl.currSize+<span class="type">int64</span>(<span class="built_in">len</span>(p)) &gt; rl.maxSize &#123;</span><br><span class="line">        rl.rotate()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    n, err = rl.logger.Writer().Write(p)</span><br><span class="line">    rl.currSize += <span class="type">int64</span>(n)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rl *RotatingLogger)</span></span> rotate() &#123;</span><br><span class="line">    <span class="comment">// å…³é—­å½“å‰æ–‡ä»¶ï¼Œé‡å‘½åï¼Œåˆ›å»ºæ–°æ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…éœ€å¤„ç†æ–‡ä»¶é‡å‘½åã€å‹ç¼©ã€ä¿ç•™ç­–ç•¥ç­‰ï¼‰</span></span><br><span class="line">    rl.logger.SetOutput(os.Stdout) <span class="comment">// ä¸´æ—¶åˆ‡æ¢åˆ°stdout</span></span><br><span class="line">    <span class="comment">// ... æ‰§è¡Œè½®è½¬é€»è¾‘ ...</span></span><br><span class="line">    newFile, _ := os.OpenFile(rl.filename, os.O_CREATE|os.O_WRONLY|os.O_APPEND, <span class="number">0666</span>)</span><br><span class="line">    rl.logger.SetOutput(newFile)</span><br><span class="line">    rl.currSize = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rl := NewRotatingLogger(<span class="string">&quot;app.log&quot;</span>, <span class="number">100</span>*<span class="number">1024</span>*<span class="number">1024</span>) <span class="comment">// 100MBè½®è½¬</span></span><br><span class="line">    logger := log.New(rl, <span class="string">&quot;[APP] &quot;</span>, log.LstdFlags)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        logger.Printf(<span class="string">&quot;æ—¥å¿—æ¡ç›® #%d&quot;</span>, i)</span><br><span class="line">        time.Sleep(<span class="number">10</span> * time.Millisecond)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-é«˜æ€§èƒ½æ— é”æ—¥å¿—ï¼ˆé€‚ç”¨äºé«˜é¢‘æ—¥å¿—åœºæ™¯ï¼‰"><a href="#4-3-é«˜æ€§èƒ½æ— é”æ—¥å¿—ï¼ˆé€‚ç”¨äºé«˜é¢‘æ—¥å¿—åœºæ™¯ï¼‰" class="headerlink" title="4.3 é«˜æ€§èƒ½æ— é”æ—¥å¿—ï¼ˆé€‚ç”¨äºé«˜é¢‘æ—¥å¿—åœºæ™¯ï¼‰"></a>4.3 é«˜æ€§èƒ½æ— é”æ—¥å¿—ï¼ˆé€‚ç”¨äºé«˜é¢‘æ—¥å¿—åœºæ™¯ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;sync/atomic&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ— é”æ—¥å¿—ç¼“å†²åŒºï¼ˆç‰ºç‰²å®æ—¶æ€§æ¢å–æ€§èƒ½ï¼‰</span></span><br><span class="line"><span class="keyword">type</span> BufferedLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">    buffer <span class="keyword">chan</span> <span class="type">string</span></span><br><span class="line">    closed atomic.Bool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBufferedLogger</span><span class="params">(size <span class="type">int</span>)</span></span> *BufferedLogger &#123;</span><br><span class="line">    bl := &amp;BufferedLogger&#123;buffer: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, size)&#125;</span><br><span class="line">    <span class="keyword">go</span> bl.writer() <span class="comment">// å¯åŠ¨åå°å†™å…¥goroutine</span></span><br><span class="line">    <span class="keyword">return</span> bl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bl *BufferedLogger)</span></span> Write(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> bl.closed.Load() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, os.ErrClosed</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éé˜»å¡å†™å…¥ï¼šç¼“å†²åŒºæ»¡æ—¶ä¸¢å¼ƒæ—¥å¿—ï¼ˆé€‚ç”¨äºç›‘æ§æŒ‡æ ‡ç­‰åœºæ™¯ï¼‰</span></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> bl.buffer &lt;- <span class="type">string</span>(p):</span><br><span class="line">        n = <span class="built_in">len</span>(p)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// ç¼“å†²åŒºæ»¡ï¼Œä¸¢å¼ƒæ—¥å¿—ï¼ˆå¯æ”¹ä¸ºé˜»å¡æˆ–é‡‡æ ·ç­–ç•¥ï¼‰</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bl *BufferedLogger)</span></span> writer() &#123;</span><br><span class="line">    file, _ := os.OpenFile(<span class="string">&quot;metrics.log&quot;</span>, os.O_CREATE|os.O_WRONLY|os.O_APPEND, <span class="number">0666</span>)</span><br><span class="line">    <span class="keyword">defer</span> file.Close()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> msg := <span class="keyword">range</span> bl.buffer &#123;</span><br><span class="line">        file.WriteString(msg)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bl *BufferedLogger)</span></span> Close() &#123;</span><br><span class="line">    bl.closed.Store(<span class="literal">true</span>)</span><br><span class="line">    <span class="built_in">close</span>(bl.buffer)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    bl := NewBufferedLogger(<span class="number">10000</span>)</span><br><span class="line">    logger := log.New(bl, <span class="string">&quot;&quot;</span>, <span class="number">0</span>) <span class="comment">// æ— æ—¶é—´æˆ³ï¼Œæè‡´æ€§èƒ½</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿé«˜é¢‘æ—¥å¿—ï¼ˆ10ä¸‡æ¡/ç§’ï¼‰</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++ &#123;</span><br><span class="line">        logger.Printf(<span class="string">&quot;metric value=%d&quot;</span>, i)</span><br><span class="line">    &#125;</span><br><span class="line">    bl.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”ã€ä¸log-x2F-slogçš„ååŒä½¿ç”¨ç­–ç•¥"><a href="#äº”ã€ä¸log-x2F-slogçš„ååŒä½¿ç”¨ç­–ç•¥" class="headerlink" title="äº”ã€ä¸log&#x2F;slogçš„ååŒä½¿ç”¨ç­–ç•¥"></a>äº”ã€ä¸log&#x2F;slogçš„ååŒä½¿ç”¨ç­–ç•¥</h2><p>Go 1.21å¼•å…¥çš„<code>log/slog</code>åŒ…æä¾›ç»“æ„åŒ–æ—¥å¿—èƒ½åŠ›ï¼Œä¸ä¼ ç»Ÿ<code>log</code>åŒ…å½¢æˆäº’è¡¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;log/slog&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// ä¼ ç»Ÿlogï¼šé€‚åˆç®€å•æ–‡æœ¬æ—¥å¿—ã€å¯åŠ¨/å…³é—­ç­‰å…³é”®äº‹ä»¶</span></span><br><span class="line">    log.SetFlags(log.LstdFlags | log.Lshortfile)</span><br><span class="line">    log.Println(<span class="string">&quot;åº”ç”¨å¯åŠ¨&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// slogï¼šé€‚åˆä¸šåŠ¡æ—¥å¿—ã€éœ€è¦ç»“æ„åŒ–æŸ¥è¯¢çš„åœºæ™¯</span></span><br><span class="line">    handler := slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">        Level: slog.LevelDebug,</span><br><span class="line">    &#125;)</span><br><span class="line">    logger := slog.New(handler).With(<span class="string">&quot;service&quot;</span>, <span class="string">&quot;user-api&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    logger.Info(<span class="string">&quot;ç”¨æˆ·ç™»å½•&quot;</span>, </span><br><span class="line">        <span class="string">&quot;user_id&quot;</span>, <span class="number">12345</span>,</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>, <span class="string">&quot;192.168.1.100&quot;</span>,</span><br><span class="line">        <span class="string">&quot;duration_ms&quot;</span>, <span class="number">42</span>,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ··åˆä½¿ç”¨ï¼šä¼ ç»Ÿlogå¤„ç†fatal/panicï¼Œslogå¤„ç†ä¸šåŠ¡æ—¥å¿—</span></span><br><span class="line">    <span class="keyword">if</span> err := initDB(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: %v&quot;</span>, err) <span class="comment">// ç¡®ä¿è‡´å‘½é”™è¯¯å¯è§</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é€‰å‹å»ºè®®ï¼š</strong></p><ul><li><strong>ç®€å•è„šæœ¬&#x2F;å·¥å…·</strong>ï¼šç›´æ¥ä½¿ç”¨<code>log</code>åŒ…ï¼Œé›¶ä¾èµ–</li><li><strong>å¾®æœåŠ¡&#x2F;äº‘åŸç”Ÿåº”ç”¨</strong>ï¼šä¸»ç”¨<code>log/slog</code>ï¼Œè¾…ä»¥<code>log</code>å¤„ç†å¯åŠ¨&#x2F;ç»ˆæ­¢äº‹ä»¶</li><li><strong>é«˜æ€§èƒ½åœºæ™¯</strong>ï¼šè€ƒè™‘<code>log</code>+è‡ªå®šä¹‰ç¼“å†²ï¼Œæˆ–é€‰ç”¨<code>zap</code>&#x2F;<code>zerolog</code>ç­‰ç¬¬ä¸‰æ–¹åº“</li></ul><h2 id="å…­ã€æ€»ç»“ä¸æœ€ä½³å®è·µ"><a href="#å…­ã€æ€»ç»“ä¸æœ€ä½³å®è·µ" class="headerlink" title="å…­ã€æ€»ç»“ä¸æœ€ä½³å®è·µ"></a>å…­ã€æ€»ç»“ä¸æœ€ä½³å®è·µ</h2><ol><li><strong>é»˜è®¤åœºæ™¯</strong>ï¼šç›´æ¥ä½¿ç”¨åŒ…çº§å‡½æ•°ï¼ˆ<code>log.Println</code>ï¼‰ï¼Œç®€å•é«˜æ•ˆ</li><li><strong>æ¨¡å—åŒ–éœ€æ±‚</strong>ï¼šä¸ºä¸åŒç»„ä»¶åˆ›å»ºç‹¬ç«‹<code>Logger</code>å®ä¾‹ï¼Œé€šè¿‡å‰ç¼€åŒºåˆ†</li><li><strong>æ€§èƒ½æ•æ„Ÿåœºæ™¯</strong>ï¼š<ul><li>é¿å…åœ¨çƒ­è·¯å¾„ä½¿ç”¨<code>Lshortfile/Llongfile</code>ï¼ˆè°ƒç”¨æ ˆè·å–å¼€é”€å¤§ï¼‰</li><li>é«˜é¢‘æ—¥å¿—è€ƒè™‘ç¼“å†²å†™å…¥æˆ–é‡‡æ ·ç­–ç•¥</li></ul></li><li><strong>ç”Ÿäº§ç¯å¢ƒ</strong>ï¼š<ul><li>æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶è€Œéstdout&#x2F;stderr</li><li>å®ç°æ—¥å¿—è½®è½¬é¿å…ç£ç›˜å æ»¡</li><li>å…³é”®é”™è¯¯ä½¿ç”¨<code>Fatal</code>ç¡®ä¿åŠæ—¶å‘Šè­¦</li></ul></li><li><strong>ç»“æ„åŒ–éœ€æ±‚</strong>ï¼šç»“åˆ<code>log/slog</code>ä½¿ç”¨ï¼Œä¼ ç»Ÿ<code>log</code>å¤„ç†ç³»ç»Ÿçº§äº‹ä»¶</li></ol><p><strong>æ ¸å¿ƒç†å¿µ</strong>ï¼šGoçš„<code>log</code>åŒ…éµå¾ªâ€å°‘å³æ˜¯å¤šâ€çš„è®¾è®¡å“²å­¦â€”â€”ç”¨æœ€ç®€APIè§£å†³80%çš„æ—¥å¿—éœ€æ±‚ï¼Œå¤æ‚åœºæ™¯é€šè¿‡ç»„åˆ<code>io.Writer</code>æ‰©å±•ã€‚æŒæ¡å…¶åŸå­åŒ–è®¾è®¡ã€å¹¶å‘å®‰å…¨æœºåˆ¶å’Œæ ‡å¿—ä½ç»„åˆæŠ€å·§ï¼Œå³å¯æ„å»ºé«˜æ•ˆå¯é çš„æ—¥å¿—ç³»ç»Ÿã€‚</p><hr><p><strong>å»¶ä¼¸é˜…è¯»</strong>ï¼š</p><ul><li>æºç ç²¾è¯»ï¼š<code>$GOROOT/src/log/log.go</code>ï¼ˆçº¦400è¡Œï¼Œå»ºè®®é€šè¯»ï¼‰  </li><li>æ€§èƒ½åŸºå‡†ï¼š<code>go test -bench=. log</code> æŸ¥çœ‹æ ‡å‡†åº“åŸºå‡†æµ‹è¯•  </li><li>æ›¿ä»£æ–¹æ¡ˆï¼š<code>log/slog</code>ï¼ˆç»“æ„åŒ–æ—¥å¿—ï¼‰ã€<code>zap</code>ï¼ˆæè‡´æ€§èƒ½ï¼‰ã€<code>zerolog</code>ï¼ˆé›¶åˆ†é…ï¼‰</li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€å…ˆçœ‹ä¸€ä¸‹logåŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ&quot;&gt;&lt;a href=&quot;#ä¸€ã€å…ˆçœ‹ä¸€ä¸‹logåŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€å…ˆçœ‹ä¸€ä¸‹logåŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ&quot;&gt;&lt;/a&gt;ä¸€ã€å…ˆçœ‹ä¸€ä¸‹logåŒ…å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ&lt;/h2&gt;&lt;p&gt;Goæ ‡å‡†åº“&lt;code&gt;log&lt;/code&gt;åŒ…è®¾è®¡æç®€è€Œå¼ºå¤§ï¼Œæ ¸å¿ƒå›´ç»•&lt;code&gt;Logger&lt;/code&gt;ç±»å‹æ„å»ºï¼ŒåŒæ—¶æä¾›ä¾¿æ·çš„å…¨å±€æ—¥å¿—æ¥å£ã€‚ä¸‹å›¾å®Œæ•´å±•ç¤ºäº†logåŒ…çš„APIä½“ç³»ç»“æ„ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-log" scheme="https://www.wdft.com/tags/Go-log/"/>
    
  </entry>
  
  <entry>
    <title>ã€fmtã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“fmtä»å‡½æ•°å…¨æ™¯åˆ°å†…æ ¸åŸç†ä»¥åŠå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/996cf37b.html"/>
    <id>https://www.wdft.com/996cf37b.html</id>
    <published>2026-01-27T18:20:16.000Z</published>
    <updated>2026-02-02T19:28:52.040Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€fmt-åº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°åˆ†ç±»ä¸èŒè´£çŸ©é˜µ"><a href="#ä¸€ã€fmt-åº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°åˆ†ç±»ä¸èŒè´£çŸ©é˜µ" class="headerlink" title="ä¸€ã€fmt åº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°åˆ†ç±»ä¸èŒè´£çŸ©é˜µ"></a>ä¸€ã€fmt åº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°åˆ†ç±»ä¸èŒè´£çŸ©é˜µ</h2><p>fmt åŒ…æ˜¯ Go è¯­è¨€ I&#x2F;O æ“ä½œçš„åŸºçŸ³ï¼Œå…¶è®¾è®¡å“²å­¦æ˜¯ <strong>â€œä¸‰ç»„è¾“å‡º Ã— ä¸‰ç»„è¾“å…¥ Ã— é€šç”¨é”™è¯¯â€</strong> çš„å¯¹ç§°ç»“æ„ã€‚ä¸ºç›´è§‚å‘ˆç°å‡½æ•°ä½“ç³»ï¼š</p><span id="more"></span><pre class="mermaid">flowchart LR    A[fmt Standard Library] --> B    A --> C    A --> D        subgraph B [Output Functions 3x3]        B1[Print/Printf/Println<br/>stdout output]        B2[Fprint/Fprintf/Fprintln<br/>io.Writer output]        B3[Sprint/Sprintf/Sprintln<br/>string output]    end        subgraph C [Input Functions 3x3]        C1[Scan/Scanf/Scanln<br/>stdin input]        C2[Fscan/Fscanf/Fscanln<br/>io.Reader input]        C3[Sscan/Sscanf/Sscanln<br/>string input]    end        D[Errorf<br/>error formatting]        B1 --> E    B2 --> E    B3 --> E    C1 --> F    C2 --> F    C3 --> F    E[Format Verbs Engine] --> G    F[Scan Rules Engine] --> G    G[Reflection & Interfaces] --> H[Buffer Management]</pre><h3 id="å‡½æ•°èŒè´£é€ŸæŸ¥è¡¨"><a href="#å‡½æ•°èŒè´£é€ŸæŸ¥è¡¨" class="headerlink" title="å‡½æ•°èŒè´£é€ŸæŸ¥è¡¨"></a>å‡½æ•°èŒè´£é€ŸæŸ¥è¡¨</h3><table><thead><tr><th>å‡½æ•°æ—</th><th>æ ¸å¿ƒå‡½æ•°</th><th>è¾“å‡ºç›®æ ‡</th><th>ç‰¹æ€§</th><th>å…¸å‹åœºæ™¯</th></tr></thead><tbody><tr><td><strong>åŸºç¡€è¾“å‡º</strong></td><td><code>Print</code></td><td><code>os.Stdout</code></td><td>å‚æ•°é—´åŠ ç©ºæ ¼ï¼Œæ— æ¢è¡Œ</td><td>è°ƒè¯•æ—¥å¿—</td></tr><tr><td></td><td><code>Printf</code></td><td><code>os.Stdout</code></td><td>æ”¯æŒæ ¼å¼åŒ–åŠ¨è¯</td><td>ç»“æ„åŒ–æ—¥å¿—</td></tr><tr><td></td><td><code>Println</code></td><td><code>os.Stdout</code></td><td>å‚æ•°é—´ç©ºæ ¼+æœ«å°¾æ¢è¡Œ</td><td>æ ‡å‡†è¾“å‡º</td></tr><tr><td><strong>å®šå‘è¾“å‡º</strong></td><td><code>Fprint</code>&#x2F;<code>Fprintf</code>&#x2F;<code>Fprintln</code></td><td><code>io.Writer</code></td><td>æ–‡ä»¶&#x2F;ç½‘ç»œæµå†™å…¥</td><td>æ—¥å¿—æ–‡ä»¶æŒä¹…åŒ–</td></tr><tr><td><strong>å†…å­˜æ„å»º</strong></td><td><code>Sprint</code>&#x2F;<code>Sprintf</code>&#x2F;<code>Sprintln</code></td><td><code>string</code></td><td>é›¶ I&#x2F;O æ¶ˆè€—</td><td>æ¶ˆæ¯æ¨¡æ¿ç»„è£…</td></tr><tr><td><strong>åŸºç¡€è¾“å…¥</strong></td><td><code>Scan</code>&#x2F;<code>Scanf</code>&#x2F;<code>Scanln</code></td><td><code>os.Stdin</code></td><td>ç©ºç™½ç¬¦åˆ†å‰²&#x2F;æ ¼å¼åŒ¹é…</td><td>å‘½ä»¤è¡Œäº¤äº’</td></tr><tr><td><strong>å®šå‘è¾“å…¥</strong></td><td><code>Fscan</code>&#x2F;<code>Fscanf</code>&#x2F;<code>Fscanln</code></td><td><code>io.Reader</code></td><td>ä» Reader è¯»å–</td><td>é…ç½®æ–‡ä»¶è§£æ</td></tr><tr><td><strong>å†…å­˜è§£æ</strong></td><td><code>Sscan</code>&#x2F;<code>Sscanf</code>&#x2F;<code>Sscanln</code></td><td><code>string</code></td><td>å­—ç¬¦ä¸²ååºåˆ—åŒ–</td><td>API å“åº”å¤„ç†</td></tr><tr><td><strong>é”™è¯¯æ„é€ </strong></td><td><code>Errorf</code></td><td><code>error</code></td><td>æ ¼å¼åŒ–é”™è¯¯æ¶ˆæ¯</td><td>ä¸šåŠ¡é”™è¯¯å°è£…</td></tr></tbody></table><h2 id="äºŒã€æŠ€æœ¯å†…æ ¸ï¼šfmt-å¦‚ä½•å®ç°â€œä¸‡èƒ½æ ¼å¼åŒ–â€ï¼Ÿ"><a href="#äºŒã€æŠ€æœ¯å†…æ ¸ï¼šfmt-å¦‚ä½•å®ç°â€œä¸‡èƒ½æ ¼å¼åŒ–â€ï¼Ÿ" class="headerlink" title="äºŒã€æŠ€æœ¯å†…æ ¸ï¼šfmt å¦‚ä½•å®ç°â€œä¸‡èƒ½æ ¼å¼åŒ–â€ï¼Ÿ"></a>äºŒã€æŠ€æœ¯å†…æ ¸ï¼šfmt å¦‚ä½•å®ç°â€œä¸‡èƒ½æ ¼å¼åŒ–â€ï¼Ÿ</h2><h3 id="2-1-ä¸‰å±‚è°ƒåº¦æ¶æ„"><a href="#2-1-ä¸‰å±‚è°ƒåº¦æ¶æ„" class="headerlink" title="2.1 ä¸‰å±‚è°ƒåº¦æ¶æ„"></a>2.1 ä¸‰å±‚è°ƒåº¦æ¶æ„</h3><p>å¤‡æ³¨ï¼šä»¥ä¸‹ä»£ç ä½¿ç”¨ Go 1.22 ä¸»æµç‰ˆæœ¬ï¼Œå› Golangç‰ˆæœ¬è¿­ä»£è¾ƒå¿«ï¼Œä½†å‘ä¸‹å…¼å®¹ï¼Œå»ºè®®æ³¨æ„ç»†å¾®å·®åˆ«å³å¯ã€‚  </p><p>fmt çš„æ ¸å¿ƒèƒ½åŠ›æºäºå…¶ <strong>â€œæ¥å£ä¼˜å…ˆ + åå°„å…œåº•â€</strong> çš„è°ƒåº¦ç­–ç•¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç å±•ç¤ºè°ƒåº¦æµç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">formatValue</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;, verb <span class="type">rune</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€å±‚ï¼šæ£€æŸ¥è‡ªå®šä¹‰æ ¼å¼åŒ–æ¥å£</span></span><br><span class="line">    <span class="keyword">if</span> formatter, ok := v.(fmt.Formatter); ok &#123;</span><br><span class="line">        <span class="keyword">return</span> formatter.Format(state, verb) <span class="comment">// ç”¨æˆ·å®Œå…¨æ§åˆ¶è¾“å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬äºŒå±‚ï¼šæ£€æŸ¥æ ‡å‡†è¡¨ç¤ºæ¥å£</span></span><br><span class="line">    <span class="keyword">if</span> stringer, ok := v.(fmt.Stringer); ok &#123;</span><br><span class="line">        <span class="keyword">return</span> stringer.String() <span class="comment">// ç±»å‹è‡ªå®šä¹‰å­—ç¬¦ä¸²è¡¨ç¤º</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬ä¸‰å±‚ï¼šåå°„å…œåº•ï¼ˆæ€§èƒ½ä»£ä»·ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> reflectBasedFormat(v, verb) <span class="comment">// é€šç”¨ä½†è¾ƒæ…¢</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼šå½“ç±»å‹å®ç° <code>fmt.Formatter</code> æ¥å£æ—¶ï¼Œfmt ä¼šå®Œå…¨å§”æ‰˜æ ¼å¼åŒ–é€»è¾‘ç»™ç”¨æˆ·ï¼Œè¿™æ˜¯é«˜æ€§èƒ½æ—¥å¿—åº“ï¼ˆå¦‚ zapï¼‰ç»•è¿‡åå°„çš„å…³é”®ã€‚</p></blockquote><h3 id="2-2-æ ¼å¼åŒ–åŠ¨è¯çš„æ‰§è¡Œæµæ°´çº¿"><a href="#2-2-æ ¼å¼åŒ–åŠ¨è¯çš„æ‰§è¡Œæµæ°´çº¿" class="headerlink" title="2.2 æ ¼å¼åŒ–åŠ¨è¯çš„æ‰§è¡Œæµæ°´çº¿"></a>2.2 æ ¼å¼åŒ–åŠ¨è¯çš„æ‰§è¡Œæµæ°´çº¿</h3><p>ä»¥ <code>fmt.Printf(&quot;%+10.2f&quot;, 3.14159)</code> ä¸ºä¾‹ï¼Œè§£ææµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥å­—ç¬¦ä¸² â†’ è¯æ³•åˆ†æå™¨ â†’ åŠ¨è¯è§£æ â†’ å®½åº¦/ç²¾åº¦æå– â†’ ç±»å‹æ£€æŸ¥ â†’ </span><br><span class="line">æ ¼å¼åŒ–å¼•æ“ â†’ ç¼“å†²åŒºå†™å…¥ â†’ æœ€ç»ˆè¾“å‡º</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒåŠ¨è¯åˆ†ç±»ï¼š</p><table><thead><tr><th>ç±»åˆ«</th><th>åŠ¨è¯</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><strong>é€šç”¨</strong></td><td><code>%v</code></td><td>é»˜è®¤æ ¼å¼</td><td><code>fmt.Printf(&quot;%v&quot;, user)</code> â†’ <code>&#123;Alice 30&#125;</code></td></tr><tr><td></td><td><code>%+v</code></td><td>å¸¦å­—æ®µåçš„ç»“æ„ä½“</td><td><code>â†’ &#123;Name:Alice Age:30&#125;</code></td></tr><tr><td></td><td><code>%#v</code></td><td>Go è¯­æ³•å­—é¢é‡</td><td><code>â†’ main.User&#123;Name:&quot;Alice&quot;, Age:30&#125;</code></td></tr><tr><td></td><td><code>%T</code></td><td>ç±»å‹å</td><td><code>â†’ main.User</code></td></tr><tr><td><strong>æ•°å€¼</strong></td><td><code>%d</code></td><td>åè¿›åˆ¶æ•´æ•°</td><td><code>42</code></td></tr><tr><td></td><td><code>%x</code>&#x2F;<code>%X</code></td><td>åå…­è¿›åˆ¶ï¼ˆå°&#x2F;å¤§å†™ï¼‰</td><td><code>2a</code> &#x2F; <code>2A</code></td></tr><tr><td></td><td><code>%f</code></td><td>æµ®ç‚¹å®šç‚¹</td><td><code>3.14</code></td></tr><tr><td></td><td><code>%e</code>&#x2F;<code>%E</code></td><td>ç§‘å­¦è®¡æ•°æ³•</td><td><code>3.14e+00</code></td></tr><tr><td><strong>å­—ç¬¦ä¸²</strong></td><td><code>%s</code></td><td>æ™®é€šå­—ç¬¦ä¸²</td><td><code>hello</code></td></tr><tr><td></td><td><code>%q</code></td><td>å¸¦å¼•å·çš„ Go å­—é¢é‡</td><td><code>&quot;hello&quot;</code></td></tr><tr><td><strong>æŒ‡é’ˆ</strong></td><td><code>%p</code></td><td>16è¿›åˆ¶åœ°å€</td><td><code>0xc000010030</code></td></tr></tbody></table><h3 id="2-3-ç¼“å†²åŒºç®¡ç†çš„æ€§èƒ½ç§˜å¯†"><a href="#2-3-ç¼“å†²åŒºç®¡ç†çš„æ€§èƒ½ç§˜å¯†" class="headerlink" title="2.3 ç¼“å†²åŒºç®¡ç†çš„æ€§èƒ½ç§˜å¯†"></a>2.3 ç¼“å†²åŒºç®¡ç†çš„æ€§èƒ½ç§˜å¯†</h3><p>fmt å†…éƒ¨ä½¿ç”¨ <code>sync.Pool</code> å¤ç”¨ç¼“å†²åŒºï¼Œé¿å…é«˜é¢‘åˆ†é…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/fmt/print.go ç®€åŒ–ç‰ˆ</span></span><br><span class="line"><span class="keyword">var</span> ppFree = sync.Pool&#123;</span><br><span class="line">    New: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="keyword">interface</span>&#123;&#125; &#123; <span class="keyword">return</span> <span class="built_in">new</span>(pp) &#125;, <span class="comment">// pp æ˜¯æ ¼å¼åŒ–å¤„ç†å™¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newPrinter</span><span class="params">()</span></span> *pp &#123;</span><br><span class="line">    <span class="keyword">return</span> ppFree.Get().(*pp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">freePrinter</span><span class="params">(p *pp)</span></span> &#123;</span><br><span class="line">    <span class="comment">// é‡ç½®çŠ¶æ€åå½’è¿˜æ± </span></span><br><span class="line">    ppFree.Put(p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ€§èƒ½æç¤º</strong>ï¼šåœ¨å¾ªç¯ä¸­é¢‘ç¹è°ƒç”¨ <code>fmt.Sprintf</code> æ—¶ï¼Œå¯è€ƒè™‘ <code>strings.Builder</code> + æ‰‹åŠ¨æ‹¼æ¥æå‡ 30%+ æ€§èƒ½ï¼ˆè§åæ–‡å¯¹æ¯”å®éªŒï¼‰ã€‚</p></blockquote><h2 id="ä¸‰ã€é¿å‘æŒ‡å—ï¼š9-ä¸ªé«˜é¢‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"><a href="#ä¸‰ã€é¿å‘æŒ‡å—ï¼š9-ä¸ªé«˜é¢‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸‰ã€é¿å‘æŒ‡å—ï¼š9 ä¸ªé«˜é¢‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"></a>ä¸‰ã€é¿å‘æŒ‡å—ï¼š9 ä¸ªé«˜é¢‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id="é™·é˜±-1ï¼š-v-ä¸-v-çš„ç»“æ„ä½“è¾“å‡ºå·®å¼‚"><a href="#é™·é˜±-1ï¼š-v-ä¸-v-çš„ç»“æ„ä½“è¾“å‡ºå·®å¼‚" class="headerlink" title="é™·é˜± 1ï¼š%v ä¸ %+v çš„ç»“æ„ä½“è¾“å‡ºå·®å¼‚"></a>é™·é˜± 1ï¼š<code>%v</code> ä¸ <code>%+v</code> çš„ç»“æ„ä½“è¾“å‡ºå·®å¼‚</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123; Name <span class="type">string</span>; Age <span class="type">int</span> &#125;</span><br><span class="line"></span><br><span class="line">u := User&#123;<span class="string">&quot;Alice&quot;</span>, <span class="number">30</span>&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, u)   <span class="comment">// &#123;Alice 30&#125; â€” æ— å­—æ®µå</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, u)  <span class="comment">// &#123;Name:Alice Age:30&#125; â€” å¸¦å­—æ®µåï¼ˆè°ƒè¯•ç¥å™¨ï¼‰</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-2ï¼šæµ®ç‚¹ç²¾åº¦é™·é˜±"><a href="#é™·é˜±-2ï¼šæµ®ç‚¹ç²¾åº¦é™·é˜±" class="headerlink" title="é™·é˜± 2ï¼šæµ®ç‚¹ç²¾åº¦é™·é˜±"></a>é™·é˜± 2ï¼šæµ®ç‚¹ç²¾åº¦é™·é˜±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">&quot;%.2f\n&quot;</span>, <span class="number">0.1</span>+<span class="number">0.2</span>) <span class="comment">// 0.30 â€” ä½†å®é™…æ˜¯ 0.30000000000000004</span></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ math.Round æˆ– decimal åº“å¤„ç†é‡‘èè®¡ç®—</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-3ï¼šScan-ç³»åˆ—çš„ç©ºç™½ç¬¦æ•æ„Ÿé—®é¢˜"><a href="#é™·é˜±-3ï¼šScan-ç³»åˆ—çš„ç©ºç™½ç¬¦æ•æ„Ÿé—®é¢˜" class="headerlink" title="é™·é˜± 3ï¼šScan ç³»åˆ—çš„ç©ºç™½ç¬¦æ•æ„Ÿé—®é¢˜"></a>é™·é˜± 3ï¼šScan ç³»åˆ—çš„ç©ºç™½ç¬¦æ•æ„Ÿé—®é¢˜</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a, b <span class="type">string</span></span><br><span class="line">fmt.Sscan(<span class="string">&quot;hello world&quot;</span>, &amp;a, &amp;b) <span class="comment">// a=&quot;hello&quot;, b=&quot;world&quot; âœ“</span></span><br><span class="line">fmt.Sscan(<span class="string">&quot;hello  world&quot;</span>, &amp;a, &amp;b) <span class="comment">// ä»æˆåŠŸï¼ˆå¤šä¸ªç©ºæ ¼è§†ä¸ºä¸€ä¸ªåˆ†éš”ç¬¦ï¼‰</span></span><br><span class="line">fmt.Sscan(<span class="string">&quot;hello\nworld&quot;</span>, &amp;a, &amp;b) <span class="comment">// å¤±è´¥ï¼Scanln è¦æ±‚æ¢è¡Œç¬¦åˆ†éš”</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-4ï¼šæŒ‡é’ˆæ‰«æçš„åœ°å€æ³„éœ²"><a href="#é™·é˜±-4ï¼šæŒ‡é’ˆæ‰«æçš„åœ°å€æ³„éœ²" class="headerlink" title="é™·é˜± 4ï¼šæŒ‡é’ˆæ‰«æçš„åœ°å€æ³„éœ²"></a>é™·é˜± 4ï¼šæŒ‡é’ˆæ‰«æçš„åœ°å€æ³„éœ²</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s <span class="type">string</span></span><br><span class="line">fmt.Scan(&amp;s) <span class="comment">// æ­£ç¡®ï¼šä¼ å…¥å˜é‡åœ°å€</span></span><br><span class="line">fmt.Scan(s)  <span class="comment">// é”™è¯¯ï¼šä¼ å…¥å€¼ï¼Œæ— æ³•ä¿®æ”¹åŸå˜é‡</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-5ï¼šæ ¼å¼åŒ–åŠ¨è¯ä¸ç±»å‹ä¸åŒ¹é…"><a href="#é™·é˜±-5ï¼šæ ¼å¼åŒ–åŠ¨è¯ä¸ç±»å‹ä¸åŒ¹é…" class="headerlink" title="é™·é˜± 5ï¼šæ ¼å¼åŒ–åŠ¨è¯ä¸ç±»å‹ä¸åŒ¹é…"></a>é™·é˜± 5ï¼šæ ¼å¼åŒ–åŠ¨è¯ä¸ç±»å‹ä¸åŒ¹é…</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">&quot;%d&quot;</span>, <span class="string">&quot;text&quot;</span>) <span class="comment">// è¿è¡Œæ—¶è¾“å‡º%!d(string=text) â€” ä¸ä¼š panicï¼</span></span><br><span class="line"><span class="comment">// å®‰å…¨å®è·µï¼šå¼€å¯ vet æ£€æŸ¥ `go vet -printfuncs=Infof,Errorf ./...`</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-6ï¼šSprintf-çš„é€ƒé€¸åˆ†æ"><a href="#é™·é˜±-6ï¼šSprintf-çš„é€ƒé€¸åˆ†æ" class="headerlink" title="é™·é˜± 6ï¼šSprintf çš„é€ƒé€¸åˆ†æ"></a>é™·é˜± 6ï¼šSprintf çš„é€ƒé€¸åˆ†æ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">leak</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s&quot;</span>, buf) <span class="comment">// buf é€ƒé€¸åˆ°å † â€” é«˜é¢‘è°ƒç”¨æ—¶å†…å­˜å‹åŠ›å¤§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-7ï¼šErrorf-çš„æ ˆè·Ÿè¸ªä¸¢å¤±"><a href="#é™·é˜±-7ï¼šErrorf-çš„æ ˆè·Ÿè¸ªä¸¢å¤±" class="headerlink" title="é™·é˜± 7ï¼šErrorf çš„æ ˆè·Ÿè¸ªä¸¢å¤±"></a>é™·é˜± 7ï¼šErrorf çš„æ ˆè·Ÿè¸ªä¸¢å¤±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯åšæ³•ï¼šä¸¢å¤±åŸå§‹é”™è¯¯ä¸Šä¸‹æ–‡</span></span><br><span class="line">err := fmt.Errorf(<span class="string">&quot;failed: %s&quot;</span>, originalErr.Error())</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ %w åŒ…è£…ï¼ˆGo 1.13+ï¼‰</span></span><br><span class="line">err := fmt.Errorf(<span class="string">&quot;failed to process: %w&quot;</span>, originalErr)</span><br><span class="line"><span class="comment">// åç»­å¯ç”¨ errors.Is/As åˆ¤å®šåŸå§‹é”™è¯¯</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-8ï¼šå¹¶å‘å®‰å…¨è¯¯è§£"><a href="#é™·é˜±-8ï¼šå¹¶å‘å®‰å…¨è¯¯è§£" class="headerlink" title="é™·é˜± 8ï¼šå¹¶å‘å®‰å…¨è¯¯è§£"></a>é™·é˜± 8ï¼šå¹¶å‘å®‰å…¨è¯¯è§£</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line"><span class="comment">// å¤š goroutine åŒæ—¶ Fprintf(&amp;buf, ...) æ˜¯å®‰å…¨çš„ï¼</span></span><br><span class="line"><span class="comment">// å› ä¸º Fprintf å†…éƒ¨å¯¹ Writer åŠ é”ï¼ˆä½†æ€§èƒ½å·®ï¼‰</span></span><br><span class="line"><span class="comment">// é«˜å¹¶å‘åœºæ™¯åº”ä½¿ç”¨ sync.Pool + ç‹¬ç«‹ buffer</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-9ï¼šæ ¼å¼åŒ–åŠ¨è¯çš„å®½åº¦-x2F-ç²¾åº¦é™·é˜±"><a href="#é™·é˜±-9ï¼šæ ¼å¼åŒ–åŠ¨è¯çš„å®½åº¦-x2F-ç²¾åº¦é™·é˜±" class="headerlink" title="é™·é˜± 9ï¼šæ ¼å¼åŒ–åŠ¨è¯çš„å®½åº¦&#x2F;ç²¾åº¦é™·é˜±"></a>é™·é˜± 9ï¼šæ ¼å¼åŒ–åŠ¨è¯çš„å®½åº¦&#x2F;ç²¾åº¦é™·é˜±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">&quot;%5s&quot;</span>, <span class="string">&quot;hi&quot;</span>)   <span class="comment">// &quot;   hi&quot; â€” å³å¯¹é½å®½åº¦5</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%-5s&quot;</span>, <span class="string">&quot;hi&quot;</span>)  <span class="comment">// &quot;hi   &quot; â€” å·¦å¯¹é½</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%.5s&quot;</span>, <span class="string">&quot;hello world&quot;</span>) <span class="comment">// &quot;hello&quot; â€” æˆªæ–­åˆ°5å­—ç¬¦</span></span><br></pre></td></tr></table></figure><h2 id="å››ã€ç”Ÿäº§çº§å®æˆ˜ï¼š5-ä¸ªå…¸å‹åœºæ™¯ä»£ç åº“"><a href="#å››ã€ç”Ÿäº§çº§å®æˆ˜ï¼š5-ä¸ªå…¸å‹åœºæ™¯ä»£ç åº“" class="headerlink" title="å››ã€ç”Ÿäº§çº§å®æˆ˜ï¼š5 ä¸ªå…¸å‹åœºæ™¯ä»£ç åº“"></a>å››ã€ç”Ÿäº§çº§å®æˆ˜ï¼š5 ä¸ªå…¸å‹åœºæ™¯ä»£ç åº“</h2><h3 id="åœºæ™¯-1ï¼šé«˜æ€§èƒ½æ—¥å¿—æ¨¡æ¿ï¼ˆé¿å…åå°„ï¼‰"><a href="#åœºæ™¯-1ï¼šé«˜æ€§èƒ½æ—¥å¿—æ¨¡æ¿ï¼ˆé¿å…åå°„ï¼‰" class="headerlink" title="åœºæ™¯ 1ï¼šé«˜æ€§èƒ½æ—¥å¿—æ¨¡æ¿ï¼ˆé¿å…åå°„ï¼‰"></a>åœºæ™¯ 1ï¼šé«˜æ€§èƒ½æ—¥å¿—æ¨¡æ¿ï¼ˆé¿å…åå°„ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç° Stringer æ¥å£ï¼Œç»•è¿‡åå°„</span></span><br><span class="line"><span class="keyword">type</span> LogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">    Level   <span class="type">string</span></span><br><span class="line">    Message <span class="type">string</span></span><br><span class="line">    Time    time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l LogEntry)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨æ‹¼æ¥æ¯” Sprintf å¿« 2-3 å€</span></span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;[%s] %s %s&quot;</span>, </span><br><span class="line">        l.Time.Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>),</span><br><span class="line">        l.Level,</span><br><span class="line">        l.Message,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    entry := LogEntry&#123;</span><br><span class="line">        Level:   <span class="string">&quot;INFO&quot;</span>,</span><br><span class="line">        Message: <span class="string">&quot;User logged in&quot;</span>,</span><br><span class="line">        Time:    time.Now(),</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(entry) <span class="comment">// ç›´æ¥è§¦å‘ String() æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-2ï¼šç»“æ„åŒ–é”™è¯¯é“¾ï¼ˆGo-1-13-ï¼‰"><a href="#åœºæ™¯-2ï¼šç»“æ„åŒ–é”™è¯¯é“¾ï¼ˆGo-1-13-ï¼‰" class="headerlink" title="åœºæ™¯ 2ï¼šç»“æ„åŒ–é”™è¯¯é“¾ï¼ˆGo 1.13+ï¼‰"></a>åœºæ™¯ 2ï¼šç»“æ„åŒ–é”™è¯¯é“¾ï¼ˆGo 1.13+ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFile</span><span class="params">(path <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    f, err := os.Open(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// %w åŒ…è£…åŸå§‹é”™è¯¯</span></span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to open file %q: %w&quot;</span>, path, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line">    <span class="comment">// ... è¯»å–é€»è¾‘</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    err := readFile(<span class="string">&quot;/nonexistent&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// é”™è¯¯é“¾éå†</span></span><br><span class="line">        <span class="keyword">var</span> pathErr *os.PathError</span><br><span class="line">        <span class="keyword">if</span> errors.As(err, &amp;pathErr) &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;Path error on %s: %v\n&quot;</span>, pathErr.Path, pathErr.Err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¾“å‡º: Path error on /nonexistent: no such file or directory</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-3ï¼šå†…å­˜å®‰å…¨çš„å­—ç¬¦ä¸²æ„å»ºï¼ˆå¯¹æ¯”-Sprintfï¼‰"><a href="#åœºæ™¯-3ï¼šå†…å­˜å®‰å…¨çš„å­—ç¬¦ä¸²æ„å»ºï¼ˆå¯¹æ¯”-Sprintfï¼‰" class="headerlink" title="åœºæ™¯ 3ï¼šå†…å­˜å®‰å…¨çš„å­—ç¬¦ä¸²æ„å»ºï¼ˆå¯¹æ¯” Sprintfï¼‰"></a>åœºæ™¯ 3ï¼šå†…å­˜å®‰å…¨çš„å­—ç¬¦ä¸²æ„å»ºï¼ˆå¯¹æ¯” Sprintfï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½æ€§èƒ½ï¼šæ¯æ¬¡ Sprintf åˆ†é…æ–°å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slowBuild</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    result := <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">        result += fmt.Sprintf(<span class="string">&quot;item-%d &quot;</span>, i) <span class="comment">// O(nÂ²) å¤æ‚åº¦ï¼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜æ€§èƒ½ï¼šé¢„åˆ†é… + Builder</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fastBuild</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> builder strings.Builder</span><br><span class="line">    builder.Grow(n * <span class="number">10</span>) <span class="comment">// é¢„åˆ†é…å®¹é‡</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">        builder.WriteString(<span class="string">&quot;item-&quot;</span>)</span><br><span class="line">        builder.WriteString(fmt.Sprint(i)) <span class="comment">// ä»…æ­¤å¤„ç”¨ fmt</span></span><br><span class="line">        builder.WriteByte(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.String()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Benchmark ç»“æœï¼ˆn=1000ï¼‰:</span></span><br><span class="line"><span class="comment">// BenchmarkSlow-8    100000    15000 ns/op    50000 B/op</span></span><br><span class="line"><span class="comment">// BenchmarkFast-8    300000     4000 ns/op     8000 B/op</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-4ï¼šè‡ªå®šä¹‰-Formatter-æ¥å£ï¼ˆå®Œå…¨æ§åˆ¶è¾“å‡ºï¼‰"><a href="#åœºæ™¯-4ï¼šè‡ªå®šä¹‰-Formatter-æ¥å£ï¼ˆå®Œå…¨æ§åˆ¶è¾“å‡ºï¼‰" class="headerlink" title="åœºæ™¯ 4ï¼šè‡ªå®šä¹‰ Formatter æ¥å£ï¼ˆå®Œå…¨æ§åˆ¶è¾“å‡ºï¼‰"></a>åœºæ™¯ 4ï¼šè‡ªå®šä¹‰ Formatter æ¥å£ï¼ˆå®Œå…¨æ§åˆ¶è¾“å‡ºï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">    Number <span class="type">string</span></span><br><span class="line">    CVV    <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç° fmt.Formatter æ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c CreditCard)</span></span> Format(f fmt.State, verb <span class="type">rune</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> verb &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> f.Flag(<span class="string">&#x27;+&#x27;</span>) &#123; <span class="comment">// %+v</span></span><br><span class="line">            fmt.Fprintf(f, <span class="string">&quot;CreditCard&#123;Number:%s, CVV:***&#125;&quot;</span>, mask(c.Number))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// %v</span></span><br><span class="line">            fmt.Fprintf(f, <span class="string">&quot;%s&quot;</span>, mask(c.Number))</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>: <span class="comment">// %s</span></span><br><span class="line">        fmt.Fprintf(f, <span class="string">&quot;%s&quot;</span>, mask(c.Number))</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        fmt.Fprintf(f, <span class="string">&quot;%%!%c(creditcard=%s)&quot;</span>, verb, c.Number)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mask</span><span class="params">(s <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) &lt;= <span class="number">4</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;**** **** **** &quot;</span> + s[<span class="built_in">len</span>(s)<span class="number">-4</span>:]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    card := CreditCard&#123;<span class="string">&quot;1234567812345678&quot;</span>, <span class="string">&quot;123&quot;</span>&#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, card)    <span class="comment">// **** **** **** 5678</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, card)   <span class="comment">// CreditCard&#123;Number:**** **** **** 5678, CVV:***&#125;</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, card)    <span class="comment">// **** **** **** 5678</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-5ï¼šå®‰å…¨çš„ç”¨æˆ·è¾“å…¥æ‰«æï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰"><a href="#åœºæ™¯-5ï¼šå®‰å…¨çš„ç”¨æˆ·è¾“å…¥æ‰«æï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰" class="headerlink" title="åœºæ™¯ 5ï¼šå®‰å…¨çš„ç”¨æˆ·è¾“å…¥æ‰«æï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰"></a>åœºæ™¯ 5ï¼šå®‰å…¨çš„ç”¨æˆ·è¾“å…¥æ‰«æï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bufio&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">safeScanInt</span><span class="params">(prompt <span class="type">string</span>)</span></span> (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    fmt.Print(prompt)</span><br><span class="line">    reader := bufio.NewReader(os.Stdin)</span><br><span class="line">    line, err := reader.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;read failed: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç†è¾“å…¥ï¼ˆé˜²æ³¨å…¥ï¼‰</span></span><br><span class="line">    line = strings.TrimSpace(line)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(line) &gt; <span class="number">20</span> &#123; <span class="comment">// é™åˆ¶é•¿åº¦</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;input too long&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸¥æ ¼è½¬æ¢</span></span><br><span class="line">    i, err := strconv.Atoi(line)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;invalid integer: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    age, err := safeScanInt(<span class="string">&quot;Enter your age: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Fprintf(os.Stderr, <span class="string">&quot;Error: %v\n&quot;</span>, err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;You are %d years old\n&quot;</span>,</span><br><span class="line"># æ·±åº¦è§£æ„ Go æ ‡å‡†åº“ fmtï¼šä»å‡½æ•°å…¨æ™¯åˆ°å†…æ ¸åŸç†çš„å®æˆ˜æŒ‡å—</span><br><span class="line"></span><br><span class="line">&gt; æœ¬æ–‡åŸºäº Go <span class="number">1.22</span>+ æ ‡å‡†åº“å®ç°ï¼Œç»“åˆæºç çº§åˆ†æä¸ç”Ÿäº§çº§å®è·µï¼Œä¸ºä½ æ„å»ºå®Œæ•´çš„ fmt åº“è®¤çŸ¥ä½“ç³»ã€‚å…¨æ–‡åŸåˆ›ï¼Œæ— ä»»ä½•å¤åˆ¶ç²˜è´´å†…å®¹ã€‚</span><br><span class="line"></span><br><span class="line">## ä¸€ã€fmt åº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°åˆ†ç±»ä¸èŒè´£çŸ©é˜µ</span><br><span class="line"></span><br><span class="line">fmt åŒ…æ˜¯ Go è¯­è¨€ I/O æ“ä½œçš„åŸºçŸ³ï¼Œå…¶è®¾è®¡å“²å­¦æ˜¯ **<span class="string">&quot;ä¸‰ç»„è¾“å‡º Ã— ä¸‰ç»„è¾“å…¥ Ã— é€šç”¨é”™è¯¯&quot;</span>** çš„å¯¹ç§°ç»“æ„ã€‚ä¸ºç›´è§‚å‘ˆç°å‡½æ•°ä½“ç³»ï¼š</span><br><span class="line"></span><br><span class="line">&lt;pre class=<span class="string">&quot;mermaid&quot;</span>&gt;flowchart LR</span><br><span class="line">    A[fmt æ ‡å‡†åº“] --&gt; B[è¾“å‡ºå‡½æ•°æ—]</span><br><span class="line">    A --&gt; C[è¾“å…¥å‡½æ•°æ—]</span><br><span class="line">    A --&gt; D[é”™è¯¯æ„é€ ]</span><br><span class="line">    </span><br><span class="line">    subgraph B [è¾“å‡ºå‡½æ•°æ— - <span class="number">3</span>Ã—<span class="number">3</span> ç»“æ„]</span><br><span class="line">        B1[Print/Printf/Println&lt;br/&gt;â†’ stdout æ— æ ¼å¼/æ ¼å¼åŒ–/æ¢è¡Œ]</span><br><span class="line">        B2[Fprint/Fprintf/Fprintln&lt;br/&gt;â†’ io.Writer å®šå‘è¾“å‡º]</span><br><span class="line">        B3[Sprint/Sprintf/Sprintln&lt;br/&gt;â†’ <span class="type">string</span> å†…å­˜æ„å»º]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph C [è¾“å…¥å‡½æ•°æ— - <span class="number">3</span>Ã—<span class="number">3</span> ç»“æ„]</span><br><span class="line">        C1[Scan/Scanf/Scanln&lt;br/&gt;â† stdin ç©ºç™½/æ ¼å¼/è¡Œåˆ†å‰²]</span><br><span class="line">        C2[Fscan/Fscanf/Fscanln&lt;br/&gt;â† io.Reader å®šå‘è¯»å–]</span><br><span class="line">        C3[Sscan/Sscanf/Sscanln&lt;br/&gt;â† <span class="type">string</span> å†…å­˜è§£æ]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    D[Errorf&lt;br/&gt;â†’ <span class="type">error</span> æ ¼å¼åŒ–é”™è¯¯]</span><br><span class="line">    </span><br><span class="line">    B1 --&gt; E[æ ¼å¼åŒ–åŠ¨è¯ç³»ç»Ÿ]</span><br><span class="line">    B2 --&gt; E</span><br><span class="line">    B3 --&gt; E</span><br><span class="line">    C1 --&gt; F[æ‰«æè§„åˆ™å¼•æ“]</span><br><span class="line">    C2 --&gt; F</span><br><span class="line">    C3 --&gt; F</span><br><span class="line">    E --&gt; G[åå°„+æ¥å£è°ƒåº¦]</span><br><span class="line">    F --&gt; G</span><br><span class="line">    G --&gt; H[ç¼“å†²åŒºç®¡ç†]&lt;/pre&gt;</span><br><span class="line"></span><br><span class="line">### å‡½æ•°èŒè´£é€ŸæŸ¥è¡¨</span><br><span class="line"></span><br><span class="line">| å‡½æ•°æ— | æ ¸å¿ƒå‡½æ•° | è¾“å‡ºç›®æ ‡ | ç‰¹æ€§ | å…¸å‹åœºæ™¯ |</span><br><span class="line">|--------|----------|----------|------|----------|</span><br><span class="line">| **åŸºç¡€è¾“å‡º** | <span class="string">`Print`</span> | <span class="string">`os.Stdout`</span> | å‚æ•°é—´åŠ ç©ºæ ¼ï¼Œæ— æ¢è¡Œ | è°ƒè¯•æ—¥å¿— |</span><br><span class="line">| | <span class="string">`Printf`</span> | <span class="string">`os.Stdout`</span> | æ”¯æŒæ ¼å¼åŒ–åŠ¨è¯ | ç»“æ„åŒ–æ—¥å¿— |</span><br><span class="line">| | <span class="string">`Println`</span> | <span class="string">`os.Stdout`</span> | å‚æ•°é—´ç©ºæ ¼+æœ«å°¾æ¢è¡Œ | æ ‡å‡†è¾“å‡º |</span><br><span class="line">| **å®šå‘è¾“å‡º** | <span class="string">`Fprint`</span>/<span class="string">`Fprintf`</span>/<span class="string">`Fprintln`</span> | <span class="string">`io.Writer`</span> | æ–‡ä»¶/ç½‘ç»œæµå†™å…¥ | æ—¥å¿—æ–‡ä»¶æŒä¹…åŒ– |</span><br><span class="line">| **å†…å­˜æ„å»º** | <span class="string">`Sprint`</span>/<span class="string">`Sprintf`</span>/<span class="string">`Sprintln`</span> | <span class="string">`string`</span> | é›¶ I/O æ¶ˆè€— | æ¶ˆæ¯æ¨¡æ¿ç»„è£… |</span><br><span class="line">| **åŸºç¡€è¾“å…¥** | <span class="string">`Scan`</span>/<span class="string">`Scanf`</span>/<span class="string">`Scanln`</span> | <span class="string">`os.Stdin`</span> | ç©ºç™½ç¬¦åˆ†å‰²/æ ¼å¼åŒ¹é… | å‘½ä»¤è¡Œäº¤äº’ |</span><br><span class="line">| **å®šå‘è¾“å…¥** | <span class="string">`Fscan`</span>/<span class="string">`Fscanf`</span>/<span class="string">`Fscanln`</span> | <span class="string">`io.Reader`</span> | ä» Reader è¯»å– | é…ç½®æ–‡ä»¶è§£æ |</span><br><span class="line">| **å†…å­˜è§£æ** | <span class="string">`Sscan`</span>/<span class="string">`Sscanf`</span>/<span class="string">`Sscanln`</span> | <span class="string">`string`</span> | å­—ç¬¦ä¸²ååºåˆ—åŒ– | API å“åº”å¤„ç† |</span><br><span class="line">| **é”™è¯¯æ„é€ ** | <span class="string">`Errorf`</span> | <span class="string">`error`</span> | æ ¼å¼åŒ–é”™è¯¯æ¶ˆæ¯ | ä¸šåŠ¡é”™è¯¯å°è£… |</span><br><span class="line"></span><br><span class="line">## äºŒã€æŠ€æœ¯å†…æ ¸ï¼šfmt å¦‚ä½•å®ç°â€œä¸‡èƒ½æ ¼å¼åŒ–â€ï¼Ÿ</span><br><span class="line"></span><br><span class="line">### <span class="number">2.1</span> ä¸‰å±‚è°ƒåº¦æ¶æ„</span><br><span class="line"></span><br><span class="line">fmt çš„æ ¸å¿ƒèƒ½åŠ›æºäºå…¶ **<span class="string">&quot;æ¥å£ä¼˜å…ˆ + åå°„å…œåº•&quot;</span>** çš„è°ƒåº¦ç­–ç•¥ï¼š</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`go</span></span><br><span class="line"><span class="string">// ä¼ªä»£ç å±•ç¤ºè°ƒåº¦æµç¨‹</span></span><br><span class="line"><span class="string">func formatValue(v interface&#123;&#125;, verb rune) string &#123;</span></span><br><span class="line"><span class="string">    // ç¬¬ä¸€å±‚ï¼šæ£€æŸ¥è‡ªå®šä¹‰æ ¼å¼åŒ–æ¥å£</span></span><br><span class="line"><span class="string">    if formatter, ok := v.(fmt.Formatter); ok &#123;</span></span><br><span class="line"><span class="string">        return formatter.Format(state, verb) // ç”¨æˆ·å®Œå…¨æ§åˆ¶è¾“å‡º</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    // ç¬¬äºŒå±‚ï¼šæ£€æŸ¥æ ‡å‡†è¡¨ç¤ºæ¥å£</span></span><br><span class="line"><span class="string">    if stringer, ok := v.(fmt.Stringer); ok &#123;</span></span><br><span class="line"><span class="string">        return stringer.String() // ç±»å‹è‡ªå®šä¹‰å­—ç¬¦ä¸²è¡¨ç¤º</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    // ç¬¬ä¸‰å±‚ï¼šåå°„å…œåº•ï¼ˆæ€§èƒ½ä»£ä»·ï¼‰</span></span><br><span class="line"><span class="string">    return reflectBasedFormat(v, verb) // é€šç”¨ä½†è¾ƒæ…¢</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼šå½“ç±»å‹å®ç° <code>fmt.Formatter</code> æ¥å£æ—¶ï¼Œfmt ä¼šå®Œå…¨å§”æ‰˜æ ¼å¼åŒ–é€»è¾‘ç»™ç”¨æˆ·ï¼Œè¿™æ˜¯é«˜æ€§èƒ½æ—¥å¿—åº“ï¼ˆå¦‚ zapï¼‰ç»•è¿‡åå°„çš„å…³é”®ã€‚</p></blockquote><h3 id="2-2-æ ¼å¼åŒ–åŠ¨è¯çš„æ‰§è¡Œæµæ°´çº¿-1"><a href="#2-2-æ ¼å¼åŒ–åŠ¨è¯çš„æ‰§è¡Œæµæ°´çº¿-1" class="headerlink" title="2.2 æ ¼å¼åŒ–åŠ¨è¯çš„æ‰§è¡Œæµæ°´çº¿"></a>2.2 æ ¼å¼åŒ–åŠ¨è¯çš„æ‰§è¡Œæµæ°´çº¿</h3><p>ä»¥ <code>fmt.Printf(&quot;%+10.2f&quot;, 3.14159)</code> ä¸ºä¾‹ï¼Œè§£ææµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥å­—ç¬¦ä¸² â†’ è¯æ³•åˆ†æå™¨ â†’ åŠ¨è¯è§£æ â†’ å®½åº¦/ç²¾åº¦æå– â†’ ç±»å‹æ£€æŸ¥ â†’ </span><br><span class="line">æ ¼å¼åŒ–å¼•æ“ â†’ ç¼“å†²åŒºå†™å…¥ â†’ æœ€ç»ˆè¾“å‡º</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒåŠ¨è¯åˆ†ç±»ï¼š</p><table><thead><tr><th>ç±»åˆ«</th><th>åŠ¨è¯</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><strong>é€šç”¨</strong></td><td><code>%v</code></td><td>é»˜è®¤æ ¼å¼</td><td><code>fmt.Printf(&quot;%v&quot;, user)</code> â†’ <code>&#123;Alice 30&#125;</code></td></tr><tr><td></td><td><code>%+v</code></td><td>å¸¦å­—æ®µåçš„ç»“æ„ä½“</td><td><code>â†’ &#123;Name:Alice Age:30&#125;</code></td></tr><tr><td></td><td><code>%#v</code></td><td>Go è¯­æ³•å­—é¢é‡</td><td><code>â†’ main.User&#123;Name:&quot;Alice&quot;, Age:30&#125;</code></td></tr><tr><td></td><td><code>%T</code></td><td>ç±»å‹å</td><td><code>â†’ main.User</code></td></tr><tr><td><strong>æ•°å€¼</strong></td><td><code>%d</code></td><td>åè¿›åˆ¶æ•´æ•°</td><td><code>42</code></td></tr><tr><td></td><td><code>%x</code>&#x2F;<code>%X</code></td><td>åå…­è¿›åˆ¶ï¼ˆå°&#x2F;å¤§å†™ï¼‰</td><td><code>2a</code> &#x2F; <code>2A</code></td></tr><tr><td></td><td><code>%f</code></td><td>æµ®ç‚¹å®šç‚¹</td><td><code>3.14</code></td></tr><tr><td></td><td><code>%e</code>&#x2F;<code>%E</code></td><td>ç§‘å­¦è®¡æ•°æ³•</td><td><code>3.14e+00</code></td></tr><tr><td><strong>å­—ç¬¦ä¸²</strong></td><td><code>%s</code></td><td>æ™®é€šå­—ç¬¦ä¸²</td><td><code>hello</code></td></tr><tr><td></td><td><code>%q</code></td><td>å¸¦å¼•å·çš„ Go å­—é¢é‡</td><td><code>&quot;hello&quot;</code></td></tr><tr><td><strong>æŒ‡é’ˆ</strong></td><td><code>%p</code></td><td>16è¿›åˆ¶åœ°å€</td><td><code>0xc000010030</code></td></tr></tbody></table><h3 id="2-3-ç¼“å†²åŒºç®¡ç†çš„æ€§èƒ½ç§˜å¯†-1"><a href="#2-3-ç¼“å†²åŒºç®¡ç†çš„æ€§èƒ½ç§˜å¯†-1" class="headerlink" title="2.3 ç¼“å†²åŒºç®¡ç†çš„æ€§èƒ½ç§˜å¯†"></a>2.3 ç¼“å†²åŒºç®¡ç†çš„æ€§èƒ½ç§˜å¯†</h3><p>fmt å†…éƒ¨ä½¿ç”¨ <code>sync.Pool</code> å¤ç”¨ç¼“å†²åŒºï¼Œé¿å…é«˜é¢‘åˆ†é…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/fmt/print.go ç®€åŒ–ç‰ˆ</span></span><br><span class="line"><span class="keyword">var</span> ppFree = sync.Pool&#123;</span><br><span class="line">    New: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="keyword">interface</span>&#123;&#125; &#123; <span class="keyword">return</span> <span class="built_in">new</span>(pp) &#125;, <span class="comment">// pp æ˜¯æ ¼å¼åŒ–å¤„ç†å™¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newPrinter</span><span class="params">()</span></span> *pp &#123;</span><br><span class="line">    <span class="keyword">return</span> ppFree.Get().(*pp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">freePrinter</span><span class="params">(p *pp)</span></span> &#123;</span><br><span class="line">    <span class="comment">// é‡ç½®çŠ¶æ€åå½’è¿˜æ± </span></span><br><span class="line">    ppFree.Put(p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ€§èƒ½æç¤º</strong>ï¼šåœ¨å¾ªç¯ä¸­é¢‘ç¹è°ƒç”¨ <code>fmt.Sprintf</code> æ—¶ï¼Œå¯è€ƒè™‘ <code>strings.Builder</code> + æ‰‹åŠ¨æ‹¼æ¥æå‡ 30%+ æ€§èƒ½ï¼ˆè§åæ–‡å¯¹æ¯”å®éªŒï¼‰ã€‚</p></blockquote><h2 id="ä¸‰ã€é¿å‘æŒ‡å—ï¼š9-ä¸ªé«˜é¢‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ-1"><a href="#ä¸‰ã€é¿å‘æŒ‡å—ï¼š9-ä¸ªé«˜é¢‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="ä¸‰ã€é¿å‘æŒ‡å—ï¼š9 ä¸ªé«˜é¢‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"></a>ä¸‰ã€é¿å‘æŒ‡å—ï¼š9 ä¸ªé«˜é¢‘é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id="é™·é˜±-1ï¼š-v-ä¸-v-çš„ç»“æ„ä½“è¾“å‡ºå·®å¼‚-1"><a href="#é™·é˜±-1ï¼š-v-ä¸-v-çš„ç»“æ„ä½“è¾“å‡ºå·®å¼‚-1" class="headerlink" title="é™·é˜± 1ï¼š%v ä¸ %+v çš„ç»“æ„ä½“è¾“å‡ºå·®å¼‚"></a>é™·é˜± 1ï¼š<code>%v</code> ä¸ <code>%+v</code> çš„ç»“æ„ä½“è¾“å‡ºå·®å¼‚</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123; Name <span class="type">string</span>; Age <span class="type">int</span> &#125;</span><br><span class="line"></span><br><span class="line">u := User&#123;<span class="string">&quot;Alice&quot;</span>, <span class="number">30</span>&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, u)   <span class="comment">// &#123;Alice 30&#125; â€” æ— å­—æ®µå</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, u)  <span class="comment">// &#123;Name:Alice Age:30&#125; â€” å¸¦å­—æ®µåï¼ˆè°ƒè¯•ç¥å™¨ï¼‰</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-2ï¼šæµ®ç‚¹ç²¾åº¦é™·é˜±-1"><a href="#é™·é˜±-2ï¼šæµ®ç‚¹ç²¾åº¦é™·é˜±-1" class="headerlink" title="é™·é˜± 2ï¼šæµ®ç‚¹ç²¾åº¦é™·é˜±"></a>é™·é˜± 2ï¼šæµ®ç‚¹ç²¾åº¦é™·é˜±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">&quot;%.2f\n&quot;</span>, <span class="number">0.1</span>+<span class="number">0.2</span>) <span class="comment">// 0.30 â€” ä½†å®é™…æ˜¯ 0.30000000000000004</span></span><br><span class="line"><span class="comment">// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ math.Round æˆ– decimal åº“å¤„ç†é‡‘èè®¡ç®—</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-3ï¼šScan-ç³»åˆ—çš„ç©ºç™½ç¬¦æ•æ„Ÿé—®é¢˜-1"><a href="#é™·é˜±-3ï¼šScan-ç³»åˆ—çš„ç©ºç™½ç¬¦æ•æ„Ÿé—®é¢˜-1" class="headerlink" title="é™·é˜± 3ï¼šScan ç³»åˆ—çš„ç©ºç™½ç¬¦æ•æ„Ÿé—®é¢˜"></a>é™·é˜± 3ï¼šScan ç³»åˆ—çš„ç©ºç™½ç¬¦æ•æ„Ÿé—®é¢˜</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a, b <span class="type">string</span></span><br><span class="line">fmt.Sscan(<span class="string">&quot;hello world&quot;</span>, &amp;a, &amp;b) <span class="comment">// a=&quot;hello&quot;, b=&quot;world&quot; âœ“</span></span><br><span class="line">fmt.Sscan(<span class="string">&quot;hello  world&quot;</span>, &amp;a, &amp;b) <span class="comment">// ä»æˆåŠŸï¼ˆå¤šä¸ªç©ºæ ¼è§†ä¸ºä¸€ä¸ªåˆ†éš”ç¬¦ï¼‰</span></span><br><span class="line">fmt.Sscan(<span class="string">&quot;hello\nworld&quot;</span>, &amp;a, &amp;b) <span class="comment">// å¤±è´¥ï¼Scanln è¦æ±‚æ¢è¡Œç¬¦åˆ†éš”</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-4ï¼šæŒ‡é’ˆæ‰«æçš„åœ°å€æ³„éœ²-1"><a href="#é™·é˜±-4ï¼šæŒ‡é’ˆæ‰«æçš„åœ°å€æ³„éœ²-1" class="headerlink" title="é™·é˜± 4ï¼šæŒ‡é’ˆæ‰«æçš„åœ°å€æ³„éœ²"></a>é™·é˜± 4ï¼šæŒ‡é’ˆæ‰«æçš„åœ°å€æ³„éœ²</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s <span class="type">string</span></span><br><span class="line">fmt.Scan(&amp;s) <span class="comment">// æ­£ç¡®ï¼šä¼ å…¥å˜é‡åœ°å€</span></span><br><span class="line">fmt.Scan(s)  <span class="comment">// é”™è¯¯ï¼šä¼ å…¥å€¼ï¼Œæ— æ³•ä¿®æ”¹åŸå˜é‡</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-5ï¼šæ ¼å¼åŒ–åŠ¨è¯ä¸ç±»å‹ä¸åŒ¹é…-1"><a href="#é™·é˜±-5ï¼šæ ¼å¼åŒ–åŠ¨è¯ä¸ç±»å‹ä¸åŒ¹é…-1" class="headerlink" title="é™·é˜± 5ï¼šæ ¼å¼åŒ–åŠ¨è¯ä¸ç±»å‹ä¸åŒ¹é…"></a>é™·é˜± 5ï¼šæ ¼å¼åŒ–åŠ¨è¯ä¸ç±»å‹ä¸åŒ¹é…</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">&quot;%d&quot;</span>, <span class="string">&quot;text&quot;</span>) <span class="comment">// è¿è¡Œæ—¶è¾“å‡º%!d(string=text) â€” ä¸ä¼š panicï¼</span></span><br><span class="line"><span class="comment">// å®‰å…¨å®è·µï¼šå¼€å¯ vet æ£€æŸ¥ `go vet -printfuncs=Infof,Errorf ./...`</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-6ï¼šSprintf-çš„é€ƒé€¸åˆ†æ-1"><a href="#é™·é˜±-6ï¼šSprintf-çš„é€ƒé€¸åˆ†æ-1" class="headerlink" title="é™·é˜± 6ï¼šSprintf çš„é€ƒé€¸åˆ†æ"></a>é™·é˜± 6ï¼šSprintf çš„é€ƒé€¸åˆ†æ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">leak</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%s&quot;</span>, buf) <span class="comment">// buf é€ƒé€¸åˆ°å † â€” é«˜é¢‘è°ƒç”¨æ—¶å†…å­˜å‹åŠ›å¤§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-7ï¼šErrorf-çš„æ ˆè·Ÿè¸ªä¸¢å¤±-1"><a href="#é™·é˜±-7ï¼šErrorf-çš„æ ˆè·Ÿè¸ªä¸¢å¤±-1" class="headerlink" title="é™·é˜± 7ï¼šErrorf çš„æ ˆè·Ÿè¸ªä¸¢å¤±"></a>é™·é˜± 7ï¼šErrorf çš„æ ˆè·Ÿè¸ªä¸¢å¤±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯åšæ³•ï¼šä¸¢å¤±åŸå§‹é”™è¯¯ä¸Šä¸‹æ–‡</span></span><br><span class="line">err := fmt.Errorf(<span class="string">&quot;failed: %s&quot;</span>, originalErr.Error())</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ %w åŒ…è£…ï¼ˆGo 1.13+ï¼‰</span></span><br><span class="line">err := fmt.Errorf(<span class="string">&quot;failed to process: %w&quot;</span>, originalErr)</span><br><span class="line"><span class="comment">// åç»­å¯ç”¨ errors.Is/As åˆ¤å®šåŸå§‹é”™è¯¯</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-8ï¼šå¹¶å‘å®‰å…¨è¯¯è§£-1"><a href="#é™·é˜±-8ï¼šå¹¶å‘å®‰å…¨è¯¯è§£-1" class="headerlink" title="é™·é˜± 8ï¼šå¹¶å‘å®‰å…¨è¯¯è§£"></a>é™·é˜± 8ï¼šå¹¶å‘å®‰å…¨è¯¯è§£</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line"><span class="comment">// å¤š goroutine åŒæ—¶ Fprintf(&amp;buf, ...) æ˜¯å®‰å…¨çš„ï¼</span></span><br><span class="line"><span class="comment">// å› ä¸º Fprintf å†…éƒ¨å¯¹ Writer åŠ é”ï¼ˆä½†æ€§èƒ½å·®ï¼‰</span></span><br><span class="line"><span class="comment">// é«˜å¹¶å‘åœºæ™¯åº”ä½¿ç”¨ sync.Pool + ç‹¬ç«‹ buffer</span></span><br></pre></td></tr></table></figure><h3 id="é™·é˜±-9ï¼šæ ¼å¼åŒ–åŠ¨è¯çš„å®½åº¦-x2F-ç²¾åº¦é™·é˜±-1"><a href="#é™·é˜±-9ï¼šæ ¼å¼åŒ–åŠ¨è¯çš„å®½åº¦-x2F-ç²¾åº¦é™·é˜±-1" class="headerlink" title="é™·é˜± 9ï¼šæ ¼å¼åŒ–åŠ¨è¯çš„å®½åº¦&#x2F;ç²¾åº¦é™·é˜±"></a>é™·é˜± 9ï¼šæ ¼å¼åŒ–åŠ¨è¯çš„å®½åº¦&#x2F;ç²¾åº¦é™·é˜±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">&quot;%5s&quot;</span>, <span class="string">&quot;hi&quot;</span>)   <span class="comment">// &quot;   hi&quot; â€” å³å¯¹é½å®½åº¦5</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%-5s&quot;</span>, <span class="string">&quot;hi&quot;</span>)  <span class="comment">// &quot;hi   &quot; â€” å·¦å¯¹é½</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%.5s&quot;</span>, <span class="string">&quot;hello world&quot;</span>) <span class="comment">// &quot;hello&quot; â€” æˆªæ–­åˆ°5å­—ç¬¦</span></span><br></pre></td></tr></table></figure><h2 id="å››ã€ç”Ÿäº§çº§å®æˆ˜ï¼š5-ä¸ªå…¸å‹åœºæ™¯ä»£ç åº“-1"><a href="#å››ã€ç”Ÿäº§çº§å®æˆ˜ï¼š5-ä¸ªå…¸å‹åœºæ™¯ä»£ç åº“-1" class="headerlink" title="å››ã€ç”Ÿäº§çº§å®æˆ˜ï¼š5 ä¸ªå…¸å‹åœºæ™¯ä»£ç åº“"></a>å››ã€ç”Ÿäº§çº§å®æˆ˜ï¼š5 ä¸ªå…¸å‹åœºæ™¯ä»£ç åº“</h2><h3 id="åœºæ™¯-1ï¼šé«˜æ€§èƒ½æ—¥å¿—æ¨¡æ¿ï¼ˆé¿å…åå°„ï¼‰-1"><a href="#åœºæ™¯-1ï¼šé«˜æ€§èƒ½æ—¥å¿—æ¨¡æ¿ï¼ˆé¿å…åå°„ï¼‰-1" class="headerlink" title="åœºæ™¯ 1ï¼šé«˜æ€§èƒ½æ—¥å¿—æ¨¡æ¿ï¼ˆé¿å…åå°„ï¼‰"></a>åœºæ™¯ 1ï¼šé«˜æ€§èƒ½æ—¥å¿—æ¨¡æ¿ï¼ˆé¿å…åå°„ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç° Stringer æ¥å£ï¼Œç»•è¿‡åå°„</span></span><br><span class="line"><span class="keyword">type</span> LogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">    Level   <span class="type">string</span></span><br><span class="line">    Message <span class="type">string</span></span><br><span class="line">    Time    time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l LogEntry)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨æ‹¼æ¥æ¯” Sprintf å¿« 2-3 å€</span></span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;[%s] %s %s&quot;</span>, </span><br><span class="line">        l.Time.Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>),</span><br><span class="line">        l.Level,</span><br><span class="line">        l.Message,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    entry := LogEntry&#123;</span><br><span class="line">        Level:   <span class="string">&quot;INFO&quot;</span>,</span><br><span class="line">        Message: <span class="string">&quot;User logged in&quot;</span>,</span><br><span class="line">        Time:    time.Now(),</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(entry) <span class="comment">// ç›´æ¥è§¦å‘ String() æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-2ï¼šç»“æ„åŒ–é”™è¯¯é“¾ï¼ˆGo-1-13-ï¼‰-1"><a href="#åœºæ™¯-2ï¼šç»“æ„åŒ–é”™è¯¯é“¾ï¼ˆGo-1-13-ï¼‰-1" class="headerlink" title="åœºæ™¯ 2ï¼šç»“æ„åŒ–é”™è¯¯é“¾ï¼ˆGo 1.13+ï¼‰"></a>åœºæ™¯ 2ï¼šç»“æ„åŒ–é”™è¯¯é“¾ï¼ˆGo 1.13+ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFile</span><span class="params">(path <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    f, err := os.Open(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// %w åŒ…è£…åŸå§‹é”™è¯¯</span></span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to open file %q: %w&quot;</span>, path, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line">    <span class="comment">// ... è¯»å–é€»è¾‘</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    err := readFile(<span class="string">&quot;/nonexistent&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// é”™è¯¯é“¾éå†</span></span><br><span class="line">        <span class="keyword">var</span> pathErr *os.PathError</span><br><span class="line">        <span class="keyword">if</span> errors.As(err, &amp;pathErr) &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;Path error on %s: %v\n&quot;</span>, pathErr.Path, pathErr.Err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¾“å‡º: Path error on /nonexistent: no such file or directory</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-3ï¼šå†…å­˜å®‰å…¨çš„å­—ç¬¦ä¸²æ„å»ºï¼ˆå¯¹æ¯”-Sprintfï¼‰-1"><a href="#åœºæ™¯-3ï¼šå†…å­˜å®‰å…¨çš„å­—ç¬¦ä¸²æ„å»ºï¼ˆå¯¹æ¯”-Sprintfï¼‰-1" class="headerlink" title="åœºæ™¯ 3ï¼šå†…å­˜å®‰å…¨çš„å­—ç¬¦ä¸²æ„å»ºï¼ˆå¯¹æ¯” Sprintfï¼‰"></a>åœºæ™¯ 3ï¼šå†…å­˜å®‰å…¨çš„å­—ç¬¦ä¸²æ„å»ºï¼ˆå¯¹æ¯” Sprintfï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½æ€§èƒ½ï¼šæ¯æ¬¡ Sprintf åˆ†é…æ–°å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slowBuild</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    result := <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">        result += fmt.Sprintf(<span class="string">&quot;item-%d &quot;</span>, i) <span class="comment">// O(nÂ²) å¤æ‚åº¦ï¼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜æ€§èƒ½ï¼šé¢„åˆ†é… + Builder</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fastBuild</span><span class="params">(n <span class="type">int</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> builder strings.Builder</span><br><span class="line">    builder.Grow(n * <span class="number">10</span>) <span class="comment">// é¢„åˆ†é…å®¹é‡</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">        builder.WriteString(<span class="string">&quot;item-&quot;</span>)</span><br><span class="line">        builder.WriteString(fmt.Sprint(i)) <span class="comment">// ä»…æ­¤å¤„ç”¨ fmt</span></span><br><span class="line">        builder.WriteByte(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.String()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Benchmark ç»“æœï¼ˆn=1000ï¼‰:</span></span><br><span class="line"><span class="comment">// BenchmarkSlow-8    100000    15000 ns/op    50000 B/op</span></span><br><span class="line"><span class="comment">// BenchmarkFast-8    300000     4000 ns/op     8000 B/op</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-4ï¼šè‡ªå®šä¹‰-Formatter-æ¥å£ï¼ˆå®Œå…¨æ§åˆ¶è¾“å‡ºï¼‰-1"><a href="#åœºæ™¯-4ï¼šè‡ªå®šä¹‰-Formatter-æ¥å£ï¼ˆå®Œå…¨æ§åˆ¶è¾“å‡ºï¼‰-1" class="headerlink" title="åœºæ™¯ 4ï¼šè‡ªå®šä¹‰ Formatter æ¥å£ï¼ˆå®Œå…¨æ§åˆ¶è¾“å‡ºï¼‰"></a>åœºæ™¯ 4ï¼šè‡ªå®šä¹‰ Formatter æ¥å£ï¼ˆå®Œå…¨æ§åˆ¶è¾“å‡ºï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">    Number <span class="type">string</span></span><br><span class="line">    CVV    <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç° fmt.Formatter æ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c CreditCard)</span></span> Format(f fmt.State, verb <span class="type">rune</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> verb &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> f.Flag(<span class="string">&#x27;+&#x27;</span>) &#123; <span class="comment">// %+v</span></span><br><span class="line">            fmt.Fprintf(f, <span class="string">&quot;CreditCard&#123;Number:%s, CVV:***&#125;&quot;</span>, mask(c.Number))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// %v</span></span><br><span class="line">            fmt.Fprintf(f, <span class="string">&quot;%s&quot;</span>, mask(c.Number))</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>: <span class="comment">// %s</span></span><br><span class="line">        fmt.Fprintf(f, <span class="string">&quot;%s&quot;</span>, mask(c.Number))</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        fmt.Fprintf(f, <span class="string">&quot;%%!%c(creditcard=%s)&quot;</span>, verb, c.Number)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mask</span><span class="params">(s <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) &lt;= <span class="number">4</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;**** **** **** &quot;</span> + s[<span class="built_in">len</span>(s)<span class="number">-4</span>:]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    card := CreditCard&#123;<span class="string">&quot;1234567812345678&quot;</span>, <span class="string">&quot;123&quot;</span>&#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, card)    <span class="comment">// **** **** **** 5678</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, card)   <span class="comment">// CreditCard&#123;Number:**** **** **** 5678, CVV:***&#125;</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, card)    <span class="comment">// **** **** **** 5678</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-5ï¼šå®‰å…¨çš„ç”¨æˆ·è¾“å…¥æ‰«æï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰-1"><a href="#åœºæ™¯-5ï¼šå®‰å…¨çš„ç”¨æˆ·è¾“å…¥æ‰«æï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰-1" class="headerlink" title="åœºæ™¯ 5ï¼šå®‰å…¨çš„ç”¨æˆ·è¾“å…¥æ‰«æï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰"></a>åœºæ™¯ 5ï¼šå®‰å…¨çš„ç”¨æˆ·è¾“å…¥æ‰«æï¼ˆé˜²å¾¡å¼ç¼–ç¨‹ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bufio&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">safeScanInt</span><span class="params">(prompt <span class="type">string</span>)</span></span> (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    fmt.Print(prompt)</span><br><span class="line">    reader := bufio.NewReader(os.Stdin)</span><br><span class="line">    line, err := reader.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;read failed: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç†è¾“å…¥ï¼ˆé˜²æ³¨å…¥ï¼‰</span></span><br><span class="line">    line = strings.TrimSpace(line)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(line) &gt; <span class="number">20</span> &#123; <span class="comment">// é™åˆ¶é•¿åº¦</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;input too long&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸¥æ ¼è½¬æ¢</span></span><br><span class="line">    i, err := strconv.Atoi(line)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;invalid integer: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    age, err := safeScanInt(<span class="string">&quot;Enter your age: &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Fprintf(os.Stderr, <span class="string">&quot;Error: %v\n&quot;</span>, err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;You are %d years old\n&quot;</span>, age)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”ã€æ€§èƒ½å®æµ‹ï¼šfmt-vs-strings-Builder"><a href="#äº”ã€æ€§èƒ½å®æµ‹ï¼šfmt-vs-strings-Builder" class="headerlink" title="äº”ã€æ€§èƒ½å®æµ‹ï¼šfmt vs strings.Builder"></a>äº”ã€æ€§èƒ½å®æµ‹ï¼šfmt vs strings.Builder</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkSprintf</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">        _ = fmt.Sprintf(<span class="string">&quot;user:%d, score:%.2f, active:%t&quot;</span>, i, <span class="type">float64</span>(i)*<span class="number">1.5</span>, i%<span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkBuilder</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">        <span class="keyword">var</span> builder strings.Builder</span><br><span class="line">        builder.Grow(<span class="number">50</span>)</span><br><span class="line">        builder.WriteString(<span class="string">&quot;user:&quot;</span>)</span><br><span class="line">        builder.WriteString(fmt.Sprint(i)) <span class="comment">// ä»…æ•°å­—è½¬æ¢ç”¨ fmt</span></span><br><span class="line">        builder.WriteString(<span class="string">&quot;, score:&quot;</span>)</span><br><span class="line">        builder.WriteString(fmt.Sprintf(<span class="string">&quot;%.2f&quot;</span>, <span class="type">float64</span>(i)*<span class="number">1.5</span>))</span><br><span class="line">        builder.WriteString(<span class="string">&quot;, active:&quot;</span>)</span><br><span class="line">        builder.WriteString(fmt.Sprint(i%<span class="number">2</span> == <span class="number">0</span>))</span><br><span class="line">        _ = builder.String()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Go 1.22 æµ‹è¯•ç»“æœ (Apple M2):</span></span><br><span class="line"><span class="comment">// BenchmarkSprintf-8    3045372    386.2 ns/op    96 B/op    3 allocs/op</span></span><br><span class="line"><span class="comment">// BenchmarkBuilder-8    4872913    245.7 ns/op    48 B/op    2 allocs/op</span></span><br><span class="line"><span class="comment">// â†’ Builder æ–¹æ¡ˆå‡å°‘ 36% æ—¶é—´ + 50% å†…å­˜åˆ†é…</span></span><br></pre></td></tr></table></figure><h2 id="å…­ã€ç»ˆæå»ºè®®ï¼šä½•æ—¶ç”¨-fmtï¼Œä½•æ—¶ç»•è¿‡ï¼Ÿ"><a href="#å…­ã€ç»ˆæå»ºè®®ï¼šä½•æ—¶ç”¨-fmtï¼Œä½•æ—¶ç»•è¿‡ï¼Ÿ" class="headerlink" title="å…­ã€ç»ˆæå»ºè®®ï¼šä½•æ—¶ç”¨ fmtï¼Œä½•æ—¶ç»•è¿‡ï¼Ÿ"></a>å…­ã€ç»ˆæå»ºè®®ï¼šä½•æ—¶ç”¨ fmtï¼Œä½•æ—¶ç»•è¿‡ï¼Ÿ</h2><table><thead><tr><th>åœºæ™¯</th><th>æ¨èæ–¹æ¡ˆ</th><th>ç†ç”±</th></tr></thead><tbody><tr><td><strong>è°ƒè¯•æ—¥å¿—</strong></td><td><code>fmt.Printf(&quot;%+v\n&quot;, obj)</code></td><td>å¿«é€ŸæŸ¥çœ‹ç»“æ„ä½“å…¨è²Œ</td></tr><tr><td><strong>ç”Ÿäº§æ—¥å¿—</strong></td><td>æ—¥å¿—åº“ï¼ˆzap&#x2F;logrusï¼‰</td><td>æ€§èƒ½ + ç»“æ„åŒ– + é‡‡æ ·</td></tr><tr><td><strong>é«˜é¢‘å­—ç¬¦ä¸²æ‹¼æ¥</strong></td><td><code>strings.Builder</code></td><td>é¿å…å†…å­˜ç¢ç‰‡</td></tr><tr><td><strong>é”™è¯¯åŒ…è£…</strong></td><td><code>fmt.Errorf(&quot;msg: %w&quot;, err)</code></td><td>ä¿ç•™é”™è¯¯é“¾</td></tr><tr><td><strong>ç”¨æˆ·è¾“å…¥è§£æ</strong></td><td><code>strconv</code> + <code>strings</code></td><td>æ¯” Scan ç³»åˆ—æ›´å¯æ§</td></tr><tr><td><strong>æ ¼å¼åŒ–è¾“å‡ºåˆ°æ–‡ä»¶</strong></td><td><code>bufio.Writer</code> + <code>Fprintf</code></td><td>å‡å°‘ç³»ç»Ÿè°ƒç”¨</td></tr><tr><td><strong>JSON&#x2F;XML åºåˆ—åŒ–</strong></td><td><code>encoding/json</code></td><td>ä¸“ç”¨åº“æ›´å®‰å…¨å¯é </td></tr></tbody></table><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>fmt åº“æ˜¯ Go è¯­è¨€â€œç®€å•æ€§å“²å­¦â€çš„å…¸èŒƒï¼šç”¨ 21 ä¸ªæ ¸å¿ƒå‡½æ•°ï¼ˆ7 è¾“å‡º Ã— 3 å˜ä½“ + 7 è¾“å…¥ Ã— 3 å˜ä½“ + 1 Errorfï¼‰è¦†ç›– 90% çš„ I&#x2F;O åœºæ™¯ã€‚æŒæ¡å…¶ä¸‰å±‚è°ƒåº¦æœºåˆ¶ï¼ˆFormatter â†’ Stringer â†’ åå°„ï¼‰ã€åŠ¨è¯ç³»ç»Ÿã€ä»¥åŠæ€§èƒ½è¾¹ç•Œï¼Œä½ å°†èƒ½åœ¨å¼€å‘ä¸­ç²¾å‡†é€‰æ‹©å·¥å…·â€”â€”æ—¢äº«å— fmt çš„ä¾¿æ·ï¼Œåˆèƒ½åœ¨æ€§èƒ½å…³é”®è·¯å¾„ä¸Šä¼˜é›…ç»•è¿‡å…¶å¼€é”€ã€‚</p><blockquote><p><strong>è®°ä½</strong>ï¼šfmt æ˜¯ç‘å£«å†›åˆ€ï¼Œä¸æ˜¯æ‰‹æœ¯åˆ€ã€‚æ—¥å¸¸å¼€å‘å¤§èƒ†ç”¨ï¼Œé«˜é¢‘è·¯å¾„è°¨æ…ç”¨ï¼Œæ ¸å¿ƒå¾ªç¯é¿å…ç”¨ã€‚</p></blockquote><hr><p><strong>é™„å½•ï¼šfmt åŠ¨è¯é€ŸæŸ¥å¡ï¼ˆæ‰“å°éšèº«å¸¦ï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">é€šç”¨: %v %+v %#v %T %%</span><br><span class="line">å¸ƒå°”: %t</span><br><span class="line">æ•´æ•°: %b(äºŒè¿›åˆ¶) %d(åè¿›åˆ¶) %o(å…«è¿›åˆ¶) %x/%X(åå…­è¿›åˆ¶) %U(Unicode)</span><br><span class="line">æµ®ç‚¹: %f(å®šç‚¹) %e/%E(ç§‘å­¦è®¡æ•°) %g/%G(æ™ºèƒ½é€‰æ‹©)</span><br><span class="line">å­—ç¬¦ä¸²: %s(æ™®é€š) %q(å¸¦å¼•å·)</span><br><span class="line">æŒ‡é’ˆ: %p</span><br><span class="line">å®½åº¦: %5s(å³å¯¹é½) %-5s(å·¦å¯¹é½) %05d(è¡¥é›¶)</span><br><span class="line">ç²¾åº¦: %.2f(å°æ•°ä½) %.5s(æˆªæ–­)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€fmt-åº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°åˆ†ç±»ä¸èŒè´£çŸ©é˜µ&quot;&gt;&lt;a href=&quot;#ä¸€ã€fmt-åº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°åˆ†ç±»ä¸èŒè´£çŸ©é˜µ&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€fmt åº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°åˆ†ç±»ä¸èŒè´£çŸ©é˜µ&quot;&gt;&lt;/a&gt;ä¸€ã€fmt åº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°åˆ†ç±»ä¸èŒè´£çŸ©é˜µ&lt;/h2&gt;&lt;p&gt;fmt åŒ…æ˜¯ Go è¯­è¨€ I&amp;#x2F;O æ“ä½œçš„åŸºçŸ³ï¼Œå…¶è®¾è®¡å“²å­¦æ˜¯ &lt;strong&gt;â€œä¸‰ç»„è¾“å‡º Ã— ä¸‰ç»„è¾“å…¥ Ã— é€šç”¨é”™è¯¯â€&lt;/strong&gt; çš„å¯¹ç§°ç»“æ„ã€‚ä¸ºç›´è§‚å‘ˆç°å‡½æ•°ä½“ç³»ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-fmt" scheme="https://www.wdft.com/tags/Go-fmt/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäº Eino æ¡†æ¶æ„å»ºæ™ºèƒ½å®¢æœ Agentï¼šMCP ä¸ Skills çš„å·¥ç¨‹åŒ–å®è·µåˆæ¢</title>
    <link href="https://www.wdft.com/2ae30f65.html"/>
    <id>https://www.wdft.com/2ae30f65.html</id>
    <published>2026-01-27T17:25:24.000Z</published>
    <updated>2026-01-30T06:40:40.569Z</updated>
    
    <content type="html"><![CDATA[<p><strong>æ³¨</strong>ï¼šä»¥ä¸‹åŸºäº CloudWeGo Eino æ¡†æ¶ï¼ˆv1.2+ï¼‰æœ€æ–°å®è·µï¼Œç»“åˆ <strong>è®¾è®¡ç†å¿µæ·±åº¦è§£è¯»</strong> ä¸ <strong>å¯è§†åŒ–è¿è¡Œæµç¨‹</strong>ï¼Œå®Œæ•´å‘ˆç°ä¼ä¸šçº§ Agent æ„å»ºæ–¹æ¡ˆã€‚ã€‚</p><span id="more"></span><hr><h2 id="ä¸€ã€å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦-Einoï¼Ÿâ€”â€”-äº‘åŸç”Ÿ-LLM-åº”ç”¨çš„ç ´å±€ä¹‹é“"><a href="#ä¸€ã€å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦-Einoï¼Ÿâ€”â€”-äº‘åŸç”Ÿ-LLM-åº”ç”¨çš„ç ´å±€ä¹‹é“" class="headerlink" title="ä¸€ã€å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦ Einoï¼Ÿâ€”â€” äº‘åŸç”Ÿ LLM åº”ç”¨çš„ç ´å±€ä¹‹é“"></a>ä¸€ã€å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦ Einoï¼Ÿâ€”â€” äº‘åŸç”Ÿ LLM åº”ç”¨çš„ç ´å±€ä¹‹é“</h2><p>åœ¨ LLM åº”ç”¨ä»â€œç©å…·â€èµ°å‘â€œç”Ÿäº§â€çš„å…³é”®é˜¶æ®µï¼Œå¼€å‘è€…é¢ä¸´ä¸‰å¤§ç—›ç‚¹ï¼š</p><ul><li>ğŸŒ <strong>åè®®ç¢ç‰‡åŒ–</strong>ï¼šå„å‚å•†å·¥å…·è°ƒç”¨åè®®ä¸ç»Ÿä¸€ï¼ˆFunction Calling&#x2F;MCP&#x2F;è‡ªå®šä¹‰ï¼‰</li><li>ğŸ§± <strong>å·¥ç¨‹èƒ½åŠ›å¼±</strong>ï¼šPython è„šæœ¬éš¾ä»¥æ”¯æ’‘é«˜å¹¶å‘ã€å¯è§‚æµ‹ã€å®‰å…¨åˆè§„çš„ç”Ÿäº§ç¯å¢ƒ</li><li>ğŸ”„ <strong>è¿­ä»£æˆæœ¬é«˜</strong>ï¼šä¸šåŠ¡é€»è¾‘ä¸æ¨¡å‹è°ƒç”¨æ·±åº¦è€¦åˆï¼Œä¿®æ”¹å³é‡å†™</li></ul><p><strong>Eino çš„è¯ç”Ÿæ­£æ˜¯ä¸ºè§£å†³è¿™äº›é—®é¢˜</strong>ï¼š<br>ä½œä¸º CloudWeGo 2025 å¹´å¼€æºçš„ <strong>Go è¯­è¨€åŸç”Ÿ LLM åº”ç”¨æ¡†æ¶</strong>ï¼Œå®ƒå°†äº‘åŸç”Ÿå·¥ç¨‹èƒ½åŠ›ä¸ LLM æ™ºèƒ½æ·±åº¦èåˆï¼Œé‡æ–°å®šä¹‰ä¼ä¸šçº§ Agent å¼€å‘èŒƒå¼ã€‚<br>è€Œä¸”Einoä¹Ÿæ˜¯ç›®å‰å¸‚é¢ä¸Šä»…æœ‰çš„åŸºäºGolangè¯­è¨€çš„Agentå¼€å‘æ¡†æ¶ã€‚</p><hr><h2 id="äºŒã€Eino-æ¡†æ¶è®¾è®¡ç†å¿µæ·±åº¦è§£è¯»"><a href="#äºŒã€Eino-æ¡†æ¶è®¾è®¡ç†å¿µæ·±åº¦è§£è¯»" class="headerlink" title="äºŒã€Eino æ¡†æ¶è®¾è®¡ç†å¿µæ·±åº¦è§£è¯»"></a>äºŒã€Eino æ¡†æ¶è®¾è®¡ç†å¿µæ·±åº¦è§£è¯»</h2><h3 id="æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼šâ€œåè®®æ ‡å‡†åŒ–-Ã—-ç»„ä»¶åŸå­åŒ–-Ã—-ç¼–æ’å£°æ˜å¼â€"><a href="#æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼šâ€œåè®®æ ‡å‡†åŒ–-Ã—-ç»„ä»¶åŸå­åŒ–-Ã—-ç¼–æ’å£°æ˜å¼â€" class="headerlink" title="æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼šâ€œåè®®æ ‡å‡†åŒ– Ã— ç»„ä»¶åŸå­åŒ– Ã— ç¼–æ’å£°æ˜å¼â€"></a>æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼š<strong>â€œåè®®æ ‡å‡†åŒ– Ã— ç»„ä»¶åŸå­åŒ– Ã— ç¼–æ’å£°æ˜å¼â€</strong></h3><table><thead><tr><th>è®¾è®¡ç»´åº¦</th><th>ä¼ ç»Ÿæ–¹æ¡ˆç—›ç‚¹</th><th>Eino è§£å†³æ–¹æ¡ˆ</th><th>ä»·å€¼</th></tr></thead><tbody><tr><td><strong>åè®®å±‚</strong></td><td>å„æ¨¡å‹å‚å•†åè®®ç§æœ‰åŒ–</td><td>åŸç”Ÿæ”¯æŒ MCP + ç»Ÿä¸€ Tool æ¥å£</td><td>ä¸€æ¬¡å°è£…ï¼Œå¤šç«¯å¤ç”¨</td></tr><tr><td><strong>ç»„ä»¶å±‚</strong></td><td>ä¸šåŠ¡é€»è¾‘ä¸æ¨¡å‹è°ƒç”¨è€¦åˆ</td><td>Model&#x2F;Tool&#x2F;Memory&#x2F;Callback å››å¤§åŸå­ç»„ä»¶</td><td>å•å…ƒæµ‹è¯•å‹å¥½ï¼ŒèŒè´£æ¸…æ™°</td></tr><tr><td><strong>ç¼–æ’å±‚</strong></td><td>ç¡¬ç¼–ç å†³ç­–æµ</td><td>å£°æ˜å¼ç¼–æ’ï¼ˆReAct&#x2F;Plan-and-Executeï¼‰</td><td>ä¸šåŠ¡é€»è¾‘å¯è§†åŒ–ï¼Œè¿­ä»£é›¶æˆæœ¬</td></tr><tr><td><strong>è¿è¡Œæ—¶</strong></td><td>Python GIL é™åˆ¶å¹¶å‘</td><td>Go åç¨‹ + é›¶æ‹·è´å†…å­˜ç®¡ç†</td><td>å•æœºä¸‡çº§ QPSï¼Œèµ„æºæ¶ˆè€—é™ä½ 60%+</td></tr></tbody></table><h3 id="å…³é”®è®¾è®¡äº®ç‚¹ï¼š"><a href="#å…³é”®è®¾è®¡äº®ç‚¹ï¼š" class="headerlink" title="å…³é”®è®¾è®¡äº®ç‚¹ï¼š"></a>å…³é”®è®¾è®¡äº®ç‚¹ï¼š</h3><ol><li><p><strong>MCP First å“²å­¦</strong><br>å°† MCP ä½œä¸ºå¤–éƒ¨ç³»ç»Ÿé›†æˆçš„<strong>é»„é‡‘æ ‡å‡†</strong>ï¼Œè€Œéå¯é€‰æ’ä»¶ã€‚æ‰€æœ‰æ•°æ®åº“ã€APIã€é—ç•™ç³»ç»Ÿå‡é€šè¿‡ MCP Server å°è£…ï¼Œå®ç°â€œå·¥å…·å³æœåŠ¡â€ã€‚</p></li><li><p><strong>Tools â‰  Skills çš„å·¥ç¨‹æ¾„æ¸…</strong>  </p><ul><li><strong>Tools</strong>ï¼šæ¡†æ¶åŸç”Ÿèƒ½åŠ›å•å…ƒï¼ˆå®ç° <code>InvokableTool</code> æ¥å£ï¼‰ï¼Œè´Ÿè´£åŸå­æ“ä½œï¼ˆå¦‚â€œæŸ¥è¯¢å•†å“â€ï¼‰</li><li><strong>Skills</strong>ï¼šä¸šåŠ¡è¯­ä¹‰å±‚å°è£…ï¼ˆç”±å¤šä¸ª Tools ç»„åˆï¼‰ï¼Œä»£è¡¨é¢†åŸŸèƒ½åŠ›ï¼ˆå¦‚â€œå•†å“æŸ¥è¯¢ Skillâ€ &#x3D; æ„å›¾è¯†åˆ« + å•†å“æœç´¢ + ç»“æœç¾åŒ–ï¼‰<blockquote><p>âœ… <strong>æœ€ä½³å®è·µ</strong>ï¼šSkills ä½œä¸ºä¸šåŠ¡å±‚æŠ½è±¡å­˜åœ¨äºåº”ç”¨ä»£ç ï¼ŒTools ä½œä¸ºæ¡†æ¶å±‚ç»„ä»¶æ³¨å†Œåˆ° Agent</p></blockquote></li></ul></li><li><p><strong>äº‘åŸç”ŸåŸºå› æ·±åº¦é›†æˆ</strong>  </p><ul><li>å†…ç½® Metrics&#x2F;Tracing&#x2F;Logging ä¸‰ä»¶å¥—ï¼ˆå¯¹æ¥ Prometheus + Jaegerï¼‰</li><li>æ”¯æŒ Kubernetes ConfigMap åŠ¨æ€åŠ è½½æç¤ºè¯</li><li>å†…å­˜å®‰å…¨ï¼šGo è¯­è¨€æœç»ç¼“å†²åŒºæº¢å‡ºç­‰å®‰å…¨é£é™©</li></ul></li></ol><hr><h2 id="ä¸‰ã€Eino-æ¡†æ¶æ ¸å¿ƒè¿è¡Œæµç¨‹è§£æï¼ˆæ³¨æ„å¯¹æ¯”å®˜æ–¹ç‰ˆæœ¬å˜åŒ–ï¼‰"><a href="#ä¸‰ã€Eino-æ¡†æ¶æ ¸å¿ƒè¿è¡Œæµç¨‹è§£æï¼ˆæ³¨æ„å¯¹æ¯”å®˜æ–¹ç‰ˆæœ¬å˜åŒ–ï¼‰" class="headerlink" title="ä¸‰ã€Eino æ¡†æ¶æ ¸å¿ƒè¿è¡Œæµç¨‹è§£æï¼ˆæ³¨æ„å¯¹æ¯”å®˜æ–¹ç‰ˆæœ¬å˜åŒ–ï¼‰"></a>ä¸‰ã€Eino æ¡†æ¶æ ¸å¿ƒè¿è¡Œæµç¨‹è§£æï¼ˆæ³¨æ„å¯¹æ¯”å®˜æ–¹ç‰ˆæœ¬å˜åŒ–ï¼‰</h2><h3 id="3-1-æ•´ä½“æ¶æ„ï¼šç»„ä»¶ååŒå·¥ä½œæµ"><a href="#3-1-æ•´ä½“æ¶æ„ï¼šç»„ä»¶ååŒå·¥ä½œæµ" class="headerlink" title="3.1 æ•´ä½“æ¶æ„ï¼šç»„ä»¶ååŒå·¥ä½œæµ"></a>3.1 æ•´ä½“æ¶æ„ï¼šç»„ä»¶ååŒå·¥ä½œæµ</h3><pre class="mermaid">flowchart TB    subgraph User[ç”¨æˆ·å±‚]        U[ç”¨æˆ·æé—®] -->|HTTP/gRPC| API[API Gateway]    end    subgraph Runtime[Eino è¿è¡Œæ—¶]        API --> Agent{Agent ç¼–æ’å¼•æ“}                subgraph Core[æ ¸å¿ƒç»„ä»¶]            M[Model<br/>Qwen]             T[Tools Registry<br/>MCP + Skills]            Mem[Memory<br/>å¯¹è¯å†å²]            CB[Callbacks<br/>ç›‘æ§/æ—¥å¿—]        end                Agent -->|1. æ³¨å†Œ| T        Agent -->|2. åŠ è½½| Mem        Agent -->|3. æ³¨å…¥| CB        Agent -->|4. è°ƒç”¨| M                M -->|5. ç”Ÿæˆ Action| Agent        Agent -->|6. è·¯ç”±| T        T -->|7. æ‰§è¡Œ| MCP[MCP Server<br/>å•†å“æ•°æ®åº“]        T -->|7. æ‰§è¡Œ| SK[Skills<br/>å®¢æœçŸ¥è¯†åº“]        MCP -->|8. è¿”å› Observation| Agent        SK -->|8. è¿”å› Observation| Agent        Agent -->|9. è¿­ä»£å†³ç­–| M        Agent -->|10. ç”Ÿæˆ Final Answer| API    end        API -->|å“åº”| U        classDef core fill:#e6f7ff,stroke:#1890ff;    class Core,MCP,SK core;    classDef user fill:#f6ffed,stroke:#52c41a;    class User user;</pre><h3 id="3-2-ReAct-Agent-å†³ç­–å¾ªç¯ï¼ˆå…³é”®æµç¨‹ï¼‰"><a href="#3-2-ReAct-Agent-å†³ç­–å¾ªç¯ï¼ˆå…³é”®æµç¨‹ï¼‰" class="headerlink" title="3.2 ReAct Agent å†³ç­–å¾ªç¯ï¼ˆå…³é”®æµç¨‹ï¼‰"></a>3.2 ReAct Agent å†³ç­–å¾ªç¯ï¼ˆå…³é”®æµç¨‹ï¼‰</h3><pre class="mermaid">graph LR    A[ç”¨æˆ·è¾“å…¥] --> B{Agent å†³ç­–}    B -->|ç”Ÿæˆ Thought| C[Model æ¨ç†]    C --> D{éœ€è°ƒç”¨å·¥å…·?}    D -->|æ˜¯| E[é€‰æ‹© Tool]    E --> F[æ‰§è¡Œ Tool]    F --> G[è·å– Observation]    G --> H[æ›´æ–° Memory]    H --> B    D -->|å¦| I[ç”Ÿæˆ Final Answer]    I --> J[Callbacks å¤„ç†]    J --> K[è¿”å›ç”¨æˆ·]</pre><h3 id="3-3-MCP-é›†æˆåè®®äº¤äº’ç»†èŠ‚"><a href="#3-3-MCP-é›†æˆåè®®äº¤äº’ç»†èŠ‚" class="headerlink" title="3.3 MCP é›†æˆåè®®äº¤äº’ç»†èŠ‚"></a>3.3 MCP é›†æˆåè®®äº¤äº’ç»†èŠ‚</h3><pre class="mermaid">sequenceDiagram    participant A as Eino Agent    participant C as MCP Client    participant S as MCP Server    participant DB as å•†å“æ•°æ®åº“        A->>C: æ³¨å†Œå·¥å…· (search_products)    C->>S: SSE è¿æ¥å»ºç«‹ (HTTP/1.1)    S->>C: å·¥å…·åˆ—è¡¨åŒæ­¥ (tools/list)        loop ReAct å†³ç­–å¾ªç¯        A->>C: è°ƒç”¨å·¥å…· (search_products, args={â€œkeywordâ€:â€œiPhoneâ€})        C->>S: SSE äº‹ä»¶ (tools/call)        S->>DB: å‚æ•°åŒ– SQL æŸ¥è¯¢        DB-->>S: å•†å“æ•°æ® (JSON)        S-->>C: å·¥å…·ç»“æœ (tools/result)        C-->>A: Observation (ç»“æ„åŒ–æ•°æ®)    end        Note over S,DB: MCP Server ä½œä¸ºå®‰å…¨è¾¹ç•Œ<br/>â€¢ SQL æ³¨å…¥é˜²æŠ¤<br/>â€¢ æŸ¥è¯¢é¢‘æ§<br/>â€¢ å­—æ®µè„±æ•</pre><hr><h2 id="å››ã€ä¸ºä»€ä¹ˆé€‰æ‹©-Eino-MCP-Qwen-æŠ€æœ¯æ ˆï¼Ÿï¼ˆå‚è€ƒå®˜ç½‘æè¿°ï¼‰"><a href="#å››ã€ä¸ºä»€ä¹ˆé€‰æ‹©-Eino-MCP-Qwen-æŠ€æœ¯æ ˆï¼Ÿï¼ˆå‚è€ƒå®˜ç½‘æè¿°ï¼‰" class="headerlink" title="å››ã€ä¸ºä»€ä¹ˆé€‰æ‹© Eino + MCP + Qwen æŠ€æœ¯æ ˆï¼Ÿï¼ˆå‚è€ƒå®˜ç½‘æè¿°ï¼‰"></a>å››ã€ä¸ºä»€ä¹ˆé€‰æ‹© Eino + MCP + Qwen æŠ€æœ¯æ ˆï¼Ÿï¼ˆå‚è€ƒå®˜ç½‘æè¿°ï¼‰</h2><p><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼š      </p><ul><li>âœ… <strong>MCP å°è£…æ•°æ®åº“</strong>ï¼šå°†å•†å“æŸ¥è¯¢èƒ½åŠ›æ ‡å‡†åŒ–ä¸ºåè®®æ¥å£ï¼ŒAgent æ— éœ€æ„ŸçŸ¥æ•°æ®åº“ç»†èŠ‚      </li><li>âœ… <strong>Skills ä¸šåŠ¡å°è£…</strong>ï¼šå®¢æœçŸ¥è¯†åº“ä½œä¸ºç‹¬ç«‹ Skill ç»„ä»¶ï¼Œæ”¯æŒçƒ­æ›´æ–°ä¸ A&#x2F;B æµ‹è¯•      </li><li>âœ… <strong>Qwen æ¨¡å‹é€‚é…</strong>ï¼šé€šè¿‡ <code>eino-ext/qwen</code> ç»„ä»¶æ— ç¼å¯¹æ¥ DashScopeï¼Œä¸­æ–‡åœºæ™¯ä¼˜åŒ–      </li><li>âœ… <strong>Go è¯­è¨€å·¥ç¨‹ä¼˜åŠ¿</strong>ï¼šå†…å­˜å ç”¨ä»…ä¸º Python æ–¹æ¡ˆ 1&#x2F;3ï¼ŒP99 å»¶è¿Ÿ &lt; 200msï¼ˆå®æµ‹æ•°æ®ï¼‰</li></ul><hr><h2 id="äº”ã€è®¾è®¡ç†å¿µè½åœ°ä»·å€¼ï¼šä»ä»£ç åˆ°ä¸šåŠ¡çš„å‡å"><a href="#äº”ã€è®¾è®¡ç†å¿µè½åœ°ä»·å€¼ï¼šä»ä»£ç åˆ°ä¸šåŠ¡çš„å‡å" class="headerlink" title="äº”ã€è®¾è®¡ç†å¿µè½åœ°ä»·å€¼ï¼šä»ä»£ç åˆ°ä¸šåŠ¡çš„å‡å"></a>äº”ã€è®¾è®¡ç†å¿µè½åœ°ä»·å€¼ï¼šä»ä»£ç åˆ°ä¸šåŠ¡çš„å‡å</h2><table><thead><tr><th>åœºæ™¯</th><th>ä¼ ç»Ÿæ–¹æ¡ˆ</th><th>Eino æ–¹æ¡ˆ</th><th>ä¸šåŠ¡ä»·å€¼</th></tr></thead><tbody><tr><td><strong>æ–°å¢å•†å“æ¸ é“</strong></td><td>ä¿®æ”¹ Agent æ ¸å¿ƒä»£ç ï¼Œå…¨é‡å›å½’æµ‹è¯•</td><td>éƒ¨ç½²æ–° MCP Serverï¼ŒAgent è‡ªåŠ¨å‘ç°</td><td>ä¸Šçº¿å‘¨æœŸä» 3 å¤© â†’ 10 åˆ†é’Ÿ</td></tr><tr><td><strong>å®¢æœè¯æœ¯æ›´æ–°</strong></td><td>é‡å¯æœåŠ¡ï¼Œå½±å“åœ¨çº¿ç”¨æˆ·</td><td>æ›´æ–° Skills é…ç½®æ–‡ä»¶ï¼Œçƒ­åŠ è½½ç”Ÿæ•ˆ</td><td>0 åœæœºè¿­ä»£ï¼Œç”¨æˆ·ä½“éªŒæ— æ„Ÿ</td></tr><tr><td><strong>å®‰å…¨å®¡è®¡</strong></td><td>æ—¥å¿—åˆ†æ•£ï¼Œéš¾è¿½æº¯</td><td>Callback ç»Ÿä¸€åŸ‹ç‚¹ï¼Œå…¨é“¾è·¯ TraceID</td><td>æ»¡è¶³ç­‰ä¿ 2.0 å®¡è®¡è¦æ±‚</td></tr><tr><td><strong>æˆæœ¬ä¼˜åŒ–</strong></td><td>å›ºå®šé«˜é…æœåŠ¡å™¨</td><td>Go åç¨‹å¼¹æ€§æ‰©ç¼©å®¹ + MCP è¿æ¥æ± </td><td>äº‘èµ„æºæˆæœ¬é™ä½ 45%</td></tr></tbody></table><hr><h2 id="å…­ã€ç»“è¯­ï¼šAgent-å·¥ç¨‹åŒ–çš„æœªæ¥å·²æ¥"><a href="#å…­ã€ç»“è¯­ï¼šAgent-å·¥ç¨‹åŒ–çš„æœªæ¥å·²æ¥" class="headerlink" title="å…­ã€ç»“è¯­ï¼šAgent å·¥ç¨‹åŒ–çš„æœªæ¥å·²æ¥"></a>å…­ã€ç»“è¯­ï¼šAgent å·¥ç¨‹åŒ–çš„æœªæ¥å·²æ¥</h2><p>Eino æ¡†æ¶é€šè¿‡ <strong>â€œåè®®æ ‡å‡†åŒ–ï¼ˆMCPï¼‰ Ã— ç»„ä»¶åŸå­åŒ–ï¼ˆToolsï¼‰ Ã— ç¼–æ’å£°æ˜å¼ï¼ˆComposeï¼‰â€</strong> ä¸‰ä½ä¸€ä½“çš„è®¾è®¡å“²å­¦ï¼Œå°† LLM åº”ç”¨å¼€å‘ä»â€œè„šæœ¬è‰ºæœ¯â€æ¨è¿›åˆ°â€œå·¥ç¨‹ç§‘å­¦â€ã€‚åœ¨å®¢æœã€ç”µå•†ã€é‡‘èç­‰å¼ºä¸šåŠ¡è€¦åˆåœºæ™¯ä¸­ï¼š</p><ul><li>ğŸŒ‰ <strong>MCP</strong> æ¶èµ· LLM ä¸ä¼ä¸šç³»ç»Ÿçš„å®‰å…¨æ¡¥æ¢  </li><li>ğŸ§© <strong>Skills</strong> å°è£…é¢†åŸŸçŸ¥è¯†ï¼Œè®©ä¸šåŠ¡ä¸“å®¶å‚ä¸è¿­ä»£  </li><li>âš™ï¸ <strong>Go è¯­è¨€</strong> ä¿éšœé«˜å¹¶å‘ä¸‹çš„ç¨³å®šæ€§ä¸æˆæœ¬æ•ˆç›Š</li></ul><p><strong>è¡ŒåŠ¨å»ºè®®</strong>ï¼š<br>1ï¸âƒ£ ä»å•ä¸€ MCP Server å¼€å§‹ï¼ˆå¦‚å•†å“æŸ¥è¯¢ï¼‰<br>2ï¸âƒ£ ç”¨ Skills å°è£…æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼ˆå¦‚â€œé€€è´§å¤„ç† Skillâ€ï¼‰<br>3ï¸âƒ£ é€šè¿‡ Callbacks æ¥å…¥ä¼ä¸šç›‘æ§ä½“ç³»<br>4ï¸âƒ£ é€æ­¥æ„å»ºä¼ä¸šçº§ Agent ä¸­å°  </p><p><strong>èµ„æºå‚è€ƒ</strong>ï¼š  </p><ul><li>ğŸ“š <a href="https://www.cloudwego.io/zh/docs/eino/">Eino å®˜æ–¹æ–‡æ¡£</a>  </li><li><a href="https://modelcontextprotocol.io/">MCP åè®®è§„èŒƒ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;æ³¨&lt;/strong&gt;ï¼šä»¥ä¸‹åŸºäº CloudWeGo Eino æ¡†æ¶ï¼ˆv1.2+ï¼‰æœ€æ–°å®è·µï¼Œç»“åˆ &lt;strong&gt;è®¾è®¡ç†å¿µæ·±åº¦è§£è¯»&lt;/strong&gt; ä¸ &lt;strong&gt;å¯è§†åŒ–è¿è¡Œæµç¨‹&lt;/strong&gt;ï¼Œå®Œæ•´å‘ˆç°ä¼ä¸šçº§ Agent æ„å»ºæ–¹æ¡ˆã€‚ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/tags/Agent/"/>
    
    <category term="Skill" scheme="https://www.wdft.com/tags/Skill/"/>
    
    <category term="Agent-Skill" scheme="https://www.wdft.com/tags/Agent-Skill/"/>
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="Demo-AI" scheme="https://www.wdft.com/tags/Demo-AI/"/>
    
    <category term="Eino" scheme="https://www.wdft.com/tags/Eino/"/>
    
  </entry>
  
  <entry>
    <title>ã€errorsã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“errorsåŒ…è®¾è®¡åŸç†ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/8ff156a6.html"/>
    <id>https://www.wdft.com/8ff156a6.html</id>
    <published>2026-01-27T15:57:38.000Z</published>
    <updated>2026-02-02T10:12:48.545Z</updated>
    
    <content type="html"><![CDATA[<h6 id="errorsåŒ…è™½å°ï¼Œå´æ˜¯æ„å»ºå¥å£®Goåº”ç”¨ä¸å¯æˆ–ç¼ºçš„åŸºçŸ³ï¼Œä¸€ä¸ªå¥å£®æ€§çš„åº”ç”¨å¿…é¡»å¤„ç†å¥½errorsã€‚"><a href="#errorsåŒ…è™½å°ï¼Œå´æ˜¯æ„å»ºå¥å£®Goåº”ç”¨ä¸å¯æˆ–ç¼ºçš„åŸºçŸ³ï¼Œä¸€ä¸ªå¥å£®æ€§çš„åº”ç”¨å¿…é¡»å¤„ç†å¥½errorsã€‚" class="headerlink" title="errorsåŒ…è™½å°ï¼Œå´æ˜¯æ„å»ºå¥å£®Goåº”ç”¨ä¸å¯æˆ–ç¼ºçš„åŸºçŸ³ï¼Œä¸€ä¸ªå¥å£®æ€§çš„åº”ç”¨å¿…é¡»å¤„ç†å¥½errorsã€‚"></a>errorsåŒ…è™½å°ï¼Œå´æ˜¯æ„å»ºå¥å£®Goåº”ç”¨ä¸å¯æˆ–ç¼ºçš„åŸºçŸ³ï¼Œä¸€ä¸ªå¥å£®æ€§çš„åº”ç”¨å¿…é¡»å¤„ç†å¥½errorsã€‚</h6><p>è™½ç„¶errorså¯¹å…¶ä»–è¯­è¨€è½¬å…¥Golangçš„æœ‹å‹æ¥è¯´å‰æœŸå¾ˆéš¾é€‚åº”ï¼Œä½†ä¸Šæ‰‹åå°±ä¼šç†è§£ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡äº†ã€‚</p><span id="more"></span><h2 id="ä¸€ã€errorsåŒ…å…¨æ™¯å›¾è°±"><a href="#ä¸€ã€errorsåŒ…å…¨æ™¯å›¾è°±" class="headerlink" title="ä¸€ã€errorsåŒ…å…¨æ™¯å›¾è°±"></a>ä¸€ã€errorsåŒ…å…¨æ™¯å›¾è°±</h2><p>Goæ ‡å‡†åº“<code>errors</code>åŒ…è‡ª1.13ç‰ˆæœ¬å¼•å…¥é”™è¯¯åŒ…è£…æœºåˆ¶åï¼Œå·²æˆä¸ºç°ä»£Goé”™è¯¯å¤„ç†çš„åŸºçŸ³ã€‚æˆªè‡³Go 1.26ï¼Œè¯¥åŒ…æä¾›5ä¸ªæ ¸å¿ƒå‡½æ•°å’Œ1ä¸ªé¢„å®šä¹‰é”™è¯¯å˜é‡ï¼Œæ„æˆå®Œæ•´çš„é”™è¯¯æ“ä½œä½“ç³»ï¼š</p><pre class="mermaid">flowchart LR    A[errors.New<br/>åˆ›å»ºåŸºç¡€é”™è¯¯] --> B[é”™è¯¯å¯¹è±¡]    C[fmt.Errorf %w<br/>åŒ…è£…é”™è¯¯] --> B    D[errors.Join<br/>åˆå¹¶å¤šé”™è¯¯] --> B        B --> E[errors.Unwrap<br/>å•å±‚è§£åŒ…]    B --> F[errors.Is<br/>å€¼åŒ¹é…æ£€æŸ¥]    B --> G[errors.As<br/>ç±»å‹æå–]        E --> H[åŸå§‹é”™è¯¯]    F --> I[å¸ƒå°”ç»“æœ]    G --> J[ç›®æ ‡ç±»å‹é”™è¯¯]        K[errors.ErrUnsupported<br/>é¢„å®šä¹‰é”™è¯¯] --> B        style A fill:#4CAF50,stroke:#388E3C,color:white    style C fill:#2196F3,stroke:#0D47A1,color:white    style D fill:#FF9800,stroke:#E65100,color:white    style E fill:#9C27B0,stroke:#4A148C,color:white    style F fill:#F44336,stroke:#B71C1C,color:white    style G fill:#3F51B5,stroke:#1A237E,color:white    style K fill:#607D8B,stroke:#263238,color:white</pre><p><strong>å›¾è¡¨è¯´æ˜</strong>ï¼šç»¿è‰²èŠ‚ç‚¹ä¸ºé”™è¯¯åˆ›å»ºå…¥å£ï¼Œè“è‰²&#x2F;æ©™è‰²ä¸ºé”™è¯¯æ„é€ æ–¹å¼ï¼Œç´«è‰²&#x2F;çº¢è‰²&#x2F;æ·±è“ä¸ºé”™è¯¯æ£€æŸ¥ä¸è§£åŒ…æ“ä½œï¼Œç°è‰²ä¸ºé¢„å®šä¹‰é”™è¯¯å¸¸é‡ã€‚</p><h2 id="äºŒã€æ ¸å¿ƒå‡½æ•°æ·±åº¦è§£æ"><a href="#äºŒã€æ ¸å¿ƒå‡½æ•°æ·±åº¦è§£æ" class="headerlink" title="äºŒã€æ ¸å¿ƒå‡½æ•°æ·±åº¦è§£æ"></a>äºŒã€æ ¸å¿ƒå‡½æ•°æ·±åº¦è§£æ</h2><h3 id="2-1-é”™è¯¯åˆ›å»ºä¸‰å‰‘å®¢"><a href="#2-1-é”™è¯¯åˆ›å»ºä¸‰å‰‘å®¢" class="headerlink" title="2.1 é”™è¯¯åˆ›å»ºä¸‰å‰‘å®¢"></a>2.1 é”™è¯¯åˆ›å»ºä¸‰å‰‘å®¢</h3><h4 id="errors-New-text-string-error"><a href="#errors-New-text-string-error" class="headerlink" title="errors.New(text string) error"></a><code>errors.New(text string) error</code></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºç å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="keyword">type</span> errorString <span class="keyword">struct</span> &#123;</span><br><span class="line">    s <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *errorString)</span></span> Error() <span class="type">string</span> &#123; <span class="keyword">return</span> e.s &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(text <span class="type">string</span>)</span></span> <span class="type">error</span> &#123; <span class="keyword">return</span> &amp;errorString&#123;text&#125; &#125;</span><br></pre></td></tr></table></figure><ul><li><strong>ç‰¹æ€§</strong>ï¼šæ¯æ¬¡è°ƒç”¨è¿”å›<strong>ä¸åŒå†…å­˜åœ°å€</strong>çš„é”™è¯¯å¯¹è±¡ï¼Œå³ä½¿æ–‡æœ¬ç›¸åŒ</li><li><strong>é™·é˜±</strong>ï¼š<code>errors.New(&quot;err&quot;) != errors.New(&quot;err&quot;)</code>ï¼ˆæŒ‡é’ˆæ¯”è¾ƒå¤±è´¥ï¼‰</li><li><strong>æ­£ç¡®ç”¨æ³•</strong>ï¼šé…åˆ<code>errors.Is</code>è¿›è¡Œè¯­ä¹‰æ¯”è¾ƒï¼Œè€Œé<code>==</code></li></ul><h4 id="fmt-Errorf-quot-w-quot-err-errorï¼ˆéerrorsåŒ…ä½†ç´§å¯†å…³è”ï¼‰"><a href="#fmt-Errorf-quot-w-quot-err-errorï¼ˆéerrorsåŒ…ä½†ç´§å¯†å…³è”ï¼‰" class="headerlink" title="fmt.Errorf(&quot;%w&quot;, err) errorï¼ˆéerrorsåŒ…ä½†ç´§å¯†å…³è”ï¼‰"></a><code>fmt.Errorf(&quot;%w&quot;, err) error</code>ï¼ˆéerrorsåŒ…ä½†ç´§å¯†å…³è”ï¼‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒ…è£…æœºåˆ¶æ ¸å¿ƒï¼šwrapErrorç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> wrapError <span class="keyword">struct</span> &#123;</span><br><span class="line">    msg   <span class="type">string</span></span><br><span class="line">    err   <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *wrapError)</span></span> Error() <span class="type">string</span> &#123; <span class="keyword">return</span> e.msg &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *wrapError)</span></span> Unwrap() <span class="type">error</span> &#123; <span class="keyword">return</span> e.err &#125; <span class="comment">// å…³é”®ï¼šå®ç°Unwrapæ–¹æ³•</span></span><br></pre></td></tr></table></figure><ul><li><strong>%wåŠ¨è¯</strong>ï¼šGo 1.13å¼•å…¥ï¼Œä¸“ç”¨äºé”™è¯¯åŒ…è£…</li><li><strong>é™åˆ¶</strong>ï¼šå•ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­<strong>åªèƒ½ä½¿ç”¨ä¸€æ¬¡%w</strong>ï¼Œå¤šæ¬¡ä½¿ç”¨ä¼šä¸¢å¤±åŒ…è£…å…³ç³»</li></ul><h4 id="errors-Join-errs-error-errorï¼ˆGo-1-20-ï¼‰"><a href="#errors-Join-errs-error-errorï¼ˆGo-1-20-ï¼‰" class="headerlink" title="errors.Join(errs ...error) errorï¼ˆGo 1.20+ï¼‰"></a><code>errors.Join(errs ...error) error</code>ï¼ˆGo 1.20+ï¼‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºç å…³é”®é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Join</span><span class="params">(errs ...<span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    nonNilErrs := <span class="built_in">make</span>([]<span class="type">error</span>, <span class="number">0</span>, <span class="built_in">len</span>(errs))</span><br><span class="line">    <span class="keyword">for</span> _, err := <span class="keyword">range</span> errs &#123;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            nonNilErrs = <span class="built_in">append</span>(nonNilErrs, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(nonNilErrs) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">// å…¨nilè¾“å…¥è¿”å›nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;joinError&#123;errs: nonNilErrs&#125; <span class="comment">// å®ç°Unwrap() []error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>å¤šé”™è¯¯è§£åŒ…</strong>ï¼šè¿”å›çš„é”™è¯¯å®ç°<code>Unwrap() []error</code>ï¼ˆæ³¨æ„æ˜¯åˆ‡ç‰‡å½¢å¼ï¼‰</li><li><strong>æ ¼å¼åŒ–è§„åˆ™</strong>ï¼šé”™è¯¯å­—ç¬¦ä¸²ä¸ºå„å­é”™è¯¯<code>Error()</code>ç»“æœç”¨æ¢è¡Œç¬¦è¿æ¥</li><li><strong>ç©ºå¤„ç†</strong>ï¼šæ‰€æœ‰è¾“å…¥ä¸ºnilæ—¶è¿”å›nilï¼Œé¿å…ç©ºé”™è¯¯å¯¹è±¡</li></ul><h3 id="2-2-é”™è¯¯æ£€æŸ¥åŒé›„"><a href="#2-2-é”™è¯¯æ£€æŸ¥åŒé›„" class="headerlink" title="2.2 é”™è¯¯æ£€æŸ¥åŒé›„"></a>2.2 é”™è¯¯æ£€æŸ¥åŒé›„</h3><h4 id="errors-Is-err-target-error-bool"><a href="#errors-Is-err-target-error-bool" class="headerlink" title="errors.Is(err, target error) bool"></a><code>errors.Is(err, target error) bool</code></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€’å½’æ£€æŸ¥ç®—æ³•ï¼ˆç®€åŒ–ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">is</span><span class="params">(err, target <span class="type">error</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err == target &#123; <span class="comment">// æŒ‡é’ˆç›¸ç­‰æˆ–å€¼ç›¸ç­‰</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥è‡ªå®šä¹‰Isæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> x, ok := err.(<span class="keyword">interface</span>&#123; Is(<span class="type">error</span>) <span class="type">bool</span> &#125;); ok &amp;&amp; x.Is(target) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€’å½’è§£åŒ…æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> unwrapped := Unwrap(err); unwrapped != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> is(unwrapped, target)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>æ·±åº¦ä¼˜å…ˆéå†</strong>ï¼šéå†æ•´ä¸ªé”™è¯¯æ ‘ï¼ˆåŒ…æ‹¬Joinäº§ç”Ÿçš„å¤šå‰æ ‘ï¼‰</li><li><strong>è‡ªå®šä¹‰åŒ¹é…</strong>ï¼šé”™è¯¯ç±»å‹å¯å®ç°<code>Is(error) bool</code>æ–¹æ³•æ‰©å±•åŒ¹é…é€»è¾‘</li><li><strong>å…¸å‹åœºæ™¯</strong>ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºç‰¹å®šç³»ç»Ÿé”™è¯¯ï¼ˆå¦‚<code>os.ErrNotExist</code>ï¼‰</li></ul><h4 id="errors-As-err-error-target-any-bool"><a href="#errors-As-err-error-target-any-bool" class="headerlink" title="errors.As(err error, target any) bool"></a><code>errors.As(err error, target any) bool</code></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»å‹æå–æ ¸å¿ƒé€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">as</span><span class="params">(err <span class="type">error</span>, target any, val reflect.Value, targetType reflect.Type)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•ç±»å‹æ–­è¨€</span></span><br><span class="line">    <span class="keyword">if</span> reflect.TypeOf(err).AssignableTo(targetType) &#123;</span><br><span class="line">        val.Elem().Set(reflect.ValueOf(err))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥è‡ªå®šä¹‰Asæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> x, ok := err.(<span class="keyword">interface</span>&#123; As(any) <span class="type">bool</span> &#125;); ok &amp;&amp; x.As(target) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€’å½’è§£åŒ…</span></span><br><span class="line">    <span class="keyword">if</span> unwrapped := Unwrap(err); unwrapped != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> as(unwrapped, target, val, targetType)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>ç±»å‹å®‰å…¨æå–</strong>ï¼šå°†é”™è¯¯é“¾ä¸­ç‰¹å®šç±»å‹é”™è¯¯æå–åˆ°targetæŒ‡é’ˆ</li><li><strong>æ³›å‹å¢å¼º</strong>ï¼šGo 1.18+ å¯ä½¿ç”¨<code>errors.AsType[E error](err error) (E, bool)</code>é¿å…åå°„</li><li><strong>å…³é”®é™åˆ¶</strong>ï¼štargetå¿…é¡»æ˜¯énilæŒ‡é’ˆï¼Œä¸”æŒ‡å‘å®ç°errorçš„ç±»å‹æˆ–æ¥å£</li></ul><h3 id="2-3-é”™è¯¯è§£åŒ…æœºåˆ¶"><a href="#2-3-é”™è¯¯è§£åŒ…æœºåˆ¶" class="headerlink" title="2.3 é”™è¯¯è§£åŒ…æœºåˆ¶"></a>2.3 é”™è¯¯è§£åŒ…æœºåˆ¶</h3><h4 id="errors-Unwrap-err-error-error"><a href="#errors-Unwrap-err-error-error" class="headerlink" title="errors.Unwrap(err error) error"></a><code>errors.Unwrap(err error) error</code></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•å±‚è§£åŒ…å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Unwrap</span><span class="params">(err <span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    u, ok := err.(<span class="keyword">interface</span>&#123; Unwrap() <span class="type">error</span> &#125;) <span class="comment">// æ£€æŸ¥æ˜¯å¦å®ç°Unwrap() error</span></span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> u.Unwrap()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é‡è¦é™åˆ¶</strong>ï¼š<strong>ä¸å¤„ç†</strong><code>Join</code>è¿”å›çš„å¤šé”™è¯¯ï¼ˆå› å…¶å®ç°<code>Unwrap() []error</code>ï¼‰</li><li><strong>æ­£ç¡®è§£åŒ…å¤šé”™è¯¯</strong>ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> joinErr, ok := err.(<span class="keyword">interface</span>&#123; Unwrap() []<span class="type">error</span> &#125;); ok &#123;</span><br><span class="line">    children := joinErr.Unwrap() <span class="comment">// è·å–æ‰€æœ‰å­é”™è¯¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="ä¸‰ã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"><a href="#ä¸‰ã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ" class="headerlink" title="ä¸‰ã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"></a>ä¸‰ã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ</h2><h3 id="3-1-é”™è¯¯åŒ…è£…çš„å¥‘çº¦è®¾è®¡"><a href="#3-1-é”™è¯¯åŒ…è£…çš„å¥‘çº¦è®¾è®¡" class="headerlink" title="3.1 é”™è¯¯åŒ…è£…çš„å¥‘çº¦è®¾è®¡"></a>3.1 é”™è¯¯åŒ…è£…çš„å¥‘çº¦è®¾è®¡</h3><p>Goé”™è¯¯åŒ…è£…åŸºäº<strong>éšå¼æ¥å£å¥‘çº¦</strong>è€Œéæ˜¾å¼ç±»å‹ç»§æ‰¿ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯åŒ…è£…çš„éšå¼å¥‘çº¦</span></span><br><span class="line"><span class="keyword">type</span> Wrapper <span class="keyword">interface</span> &#123;</span><br><span class="line">    Unwrap() <span class="type">error</span> <span class="comment">// æˆ– Unwrap() []error (Go 1.20+)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»»ä½•ç±»å‹åªè¦å®ç°<code>Unwrap() error</code>æ–¹æ³•ï¼Œå³è¢«è§†ä¸ºå¯åŒ…è£…é”™è¯¯ã€‚è¿™ç§è®¾è®¡ï¼š</p><ul><li>âœ… ä¿æŒå‘åå…¼å®¹ï¼ˆæ— éœ€ä¿®æ”¹ç°æœ‰errorç±»å‹ï¼‰</li><li>âœ… æ”¯æŒå¤šå±‚åµŒå¥—ï¼ˆå½¢æˆé”™è¯¯æ ‘è€Œéé“¾è¡¨ï¼‰</li><li>âœ… å…è®¸è‡ªå®šä¹‰è§£åŒ…é€»è¾‘ï¼ˆé€šè¿‡å®ç°Unwrapæ–¹æ³•ï¼‰</li></ul><h3 id="3-2-é”™è¯¯æ ‘çš„éå†ç®—æ³•"><a href="#3-2-é”™è¯¯æ ‘çš„éå†ç®—æ³•" class="headerlink" title="3.2 é”™è¯¯æ ‘çš„éå†ç®—æ³•"></a>3.2 é”™è¯¯æ ‘çš„éå†ç®—æ³•</h3><p><code>errors.Is</code>å’Œ<code>errors.As</code>é‡‡ç”¨<strong>æ·±åº¦ä¼˜å…ˆéå†ï¼ˆDFSï¼‰</strong> ç­–ç•¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">é”™è¯¯æ ‘ç»“æ„ç¤ºä¾‹ï¼š</span><br><span class="line">          [Wrap: &quot;ç½‘ç»œè¶…æ—¶&quot;]</span><br><span class="line">                 |</span><br><span class="line">        +--------+--------+</span><br><span class="line">        |                 |</span><br><span class="line">[Join: å¤šé”™è¯¯]      [åŸå§‹é”™è¯¯: syscall.ECONNREFUSED]</span><br><span class="line">        |</span><br><span class="line">   +----+----+</span><br><span class="line">   |         |</span><br><span class="line">[err1]   [err2]</span><br></pre></td></tr></table></figure><p>éå†é¡ºåºï¼š<code>Wrap â†’ Join â†’ err1 â†’ err2 â†’ syscall.ECONNREFUSED</code></p><h3 id="3-3-Joinçš„å¤šé”™è¯¯è®¾è®¡å“²å­¦"><a href="#3-3-Joinçš„å¤šé”™è¯¯è®¾è®¡å“²å­¦" class="headerlink" title="3.3 Joinçš„å¤šé”™è¯¯è®¾è®¡å“²å­¦"></a>3.3 Joinçš„å¤šé”™è¯¯è®¾è®¡å“²å­¦</h3><p>Go 1.20å¼•å…¥<code>errors.Join</code>è§£å†³é•¿æœŸå­˜åœ¨çš„â€é”™è¯¯è¦†ç›–â€é—®é¢˜ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿdeferæ¨¡å¼çš„ç¼ºé™·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> closeErr := file.Close(); closeErr != <span class="literal">nil</span> &#123;</span><br><span class="line">            err = closeErr <span class="comment">// è¦†ç›–ä¸šåŠ¡é”™è¯¯ï¼</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// ... ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨Joinçš„æ­£ç¡®æ¨¡å¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> errs []<span class="type">error</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> closeErr := file.Close(); closeErr != <span class="literal">nil</span> &#123;</span><br><span class="line">            errs = <span class="built_in">append</span>(errs, closeErr) <span class="comment">// ä¿ç•™æ‰€æœ‰é”™è¯¯</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// ... ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    errs = <span class="built_in">append</span>(errs, businessErr)</span><br><span class="line">    <span class="keyword">return</span> errors.Join(errs...) <span class="comment">// åˆå¹¶æ‰€æœ‰é”™è¯¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››ã€å·¥ç¨‹å®è·µæœ€ä½³æŒ‡å—"><a href="#å››ã€å·¥ç¨‹å®è·µæœ€ä½³æŒ‡å—" class="headerlink" title="å››ã€å·¥ç¨‹å®è·µæœ€ä½³æŒ‡å—"></a>å››ã€å·¥ç¨‹å®è·µæœ€ä½³æŒ‡å—</h2><h3 id="4-1-é”™è¯¯åˆ›å»ºè§„èŒƒ"><a href="#4-1-é”™è¯¯åˆ›å»ºè§„èŒƒ" class="headerlink" title="4.1 é”™è¯¯åˆ›å»ºè§„èŒƒ"></a>4.1 é”™è¯¯åˆ›å»ºè§„èŒƒ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… æ¨èï¼šä½¿ç”¨errors.Newåˆ›å»ºè¯­ä¹‰åŒ–é”™è¯¯</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    ErrInvalidInput  = errors.New(<span class="string">&quot;invalid input&quot;</span>)</span><br><span class="line">    ErrPermissionDenied = errors.New(<span class="string">&quot;permission denied&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ¨èï¼šä½¿ç”¨%wåŒ…è£…ä¿ç•™åŸå§‹é”™è¯¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadConfig</span><span class="params">(path <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    data, err := os.ReadFile(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to read config at %s: %w&quot;</span>, path, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âŒ é¿å…ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ä¸¢å¤±åŸå§‹é”™è¯¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BadReadConfig</span><span class="params">(path <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    data, err := os.ReadFile(path)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to read config: %v&quot;</span>, err) <span class="comment">// ä¸¢å¤±åŒ…è£…å…³ç³»</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-é”™è¯¯æ£€æŸ¥å®æˆ˜æ¨¡å¼"><a href="#4-2-é”™è¯¯æ£€æŸ¥å®æˆ˜æ¨¡å¼" class="headerlink" title="4.2 é”™è¯¯æ£€æŸ¥å®æˆ˜æ¨¡å¼"></a>4.2 é”™è¯¯æ£€æŸ¥å®æˆ˜æ¨¡å¼</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¨¡å¼1ï¼šæ£€æŸ¥ç‰¹å®šé”™è¯¯å€¼ï¼ˆä½¿ç”¨Isï¼‰</span></span><br><span class="line"><span class="keyword">if</span> errors.Is(err, os.ErrNotExist) &#123;</span><br><span class="line">    log.Println(<span class="string">&quot;æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡å¼2ï¼šæå–è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼ˆä½¿ç”¨Asï¼‰</span></span><br><span class="line"><span class="keyword">type</span> ValidationError <span class="keyword">struct</span> &#123;</span><br><span class="line">    Field <span class="type">string</span></span><br><span class="line">    Msg   <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *ValidationError)</span></span> Error() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;validation failed on %s: %s&quot;</span>, e.Field, e.Msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨Asæå–</span></span><br><span class="line"><span class="keyword">var</span> ve *ValidationError</span><br><span class="line"><span class="keyword">if</span> errors.As(err, &amp;ve) &#123;</span><br><span class="line">    log.Printf(<span class="string">&quot;éªŒè¯å¤±è´¥å­—æ®µ: %s, åŸå› : %s&quot;</span>, ve.Field, ve.Msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡å¼3ï¼šå¤„ç†å¤šé”™è¯¯ï¼ˆJoinåœºæ™¯ï¼‰</span></span><br><span class="line"><span class="keyword">if</span> joined, ok := err.(<span class="keyword">interface</span>&#123; Unwrap() []<span class="type">error</span> &#125;); ok &#123;</span><br><span class="line">    <span class="keyword">for</span> i, e := <span class="keyword">range</span> joined.Unwrap() &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;å­é”™è¯¯[%d]: %v&quot;</span>, i, e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-è‡ªå®šä¹‰é”™è¯¯ç±»å‹çš„å®Œæ•´å®ç°"><a href="#4-3-è‡ªå®šä¹‰é”™è¯¯ç±»å‹çš„å®Œæ•´å®ç°" class="headerlink" title="4.3 è‡ªå®šä¹‰é”™è¯¯ç±»å‹çš„å®Œæ•´å®ç°"></a>4.3 è‡ªå®šä¹‰é”™è¯¯ç±»å‹çš„å®Œæ•´å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®Œæ•´çš„è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼ˆæ”¯æŒIs/As/Unwrapï¼‰</span></span><br><span class="line"><span class="keyword">type</span> AppError <span class="keyword">struct</span> &#123;</span><br><span class="line">    Code    <span class="type">string</span></span><br><span class="line">    Message <span class="type">string</span></span><br><span class="line">    Cause   <span class="type">error</span> <span class="comment">// åŸå§‹é”™è¯¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *AppError)</span></span> Error() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> e.Cause != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;[%s] %s: %v&quot;</span>, e.Code, e.Message, e.Cause)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;[%s] %s&quot;</span>, e.Code, e.Message)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°Unwrapæ”¯æŒé”™è¯¯è§£åŒ…</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *AppError)</span></span> Unwrap() <span class="type">error</span> &#123; <span class="keyword">return</span> e.Cause &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°Isæ”¯æŒè¯­ä¹‰åŒ¹é…</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *AppError)</span></span> Is(target <span class="type">error</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> appErr, ok := target.(*AppError); ok &#123;</span><br><span class="line">        <span class="keyword">return</span> e.Code == appErr.Code</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> errors.Is(e.Cause, target)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°Asæ”¯æŒç±»å‹è½¬æ¢</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *AppError)</span></span> As(target any) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> t, ok := target.(**AppError); ok &#123;</span><br><span class="line">        *t = e</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateUser</span><span class="params">(name <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;AppError&#123;</span><br><span class="line">            Code:    <span class="string">&quot;INVALID_NAME&quot;</span>,</span><br><span class="line">            Message: <span class="string">&quot;ç”¨æˆ·åä¸èƒ½ä¸ºç©º&quot;</span>,</span><br><span class="line">            Cause:   errors.New(<span class="string">&quot;empty name&quot;</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥é”™è¯¯</span></span><br><span class="line">err := CreateUser(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> errors.Is(err, &amp;AppError&#123;Code: <span class="string">&quot;INVALID_NAME&quot;</span>&#125;) &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;æ•è·åˆ°æ— æ•ˆç”¨æˆ·åé”™è¯¯&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”ã€å…¸å‹é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"><a href="#äº”ã€å…¸å‹é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="äº”ã€å…¸å‹é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ"></a>äº”ã€å…¸å‹é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id="5-1-é™·é˜±1ï¼šJoiné”™è¯¯çš„è§£åŒ…è¯¯åŒº"><a href="#5-1-é™·é˜±1ï¼šJoiné”™è¯¯çš„è§£åŒ…è¯¯åŒº" class="headerlink" title="5.1 é™·é˜±1ï¼šJoiné”™è¯¯çš„è§£åŒ…è¯¯åŒº"></a>5.1 é™·é˜±1ï¼šJoiné”™è¯¯çš„è§£åŒ…è¯¯åŒº</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šä½¿ç”¨Unwrap() errorè§£åŒ…Joiné”™è¯¯</span></span><br><span class="line">err := errors.Join(err1, err2)</span><br><span class="line"><span class="keyword">if</span> unwrapped := errors.Unwrap(err); unwrapped != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Joinå®ç°çš„æ˜¯Unwrap() []error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šç±»å‹æ–­è¨€è·å–åˆ‡ç‰‡</span></span><br><span class="line"><span class="keyword">if</span> joinErr, ok := err.(<span class="keyword">interface</span>&#123; Unwrap() []<span class="type">error</span> &#125;); ok &#123;</span><br><span class="line">    <span class="keyword">for</span> _, e := <span class="keyword">range</span> joinErr.Unwrap() &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;å­é”™è¯¯:&quot;</span>, e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-é™·é˜±2ï¼š-wåŠ¨è¯çš„æ»¥ç”¨"><a href="#5-2-é™·é˜±2ï¼š-wåŠ¨è¯çš„æ»¥ç”¨" class="headerlink" title="5.2 é™·é˜±2ï¼š%wåŠ¨è¯çš„æ»¥ç”¨"></a>5.2 é™·é˜±2ï¼š%wåŠ¨è¯çš„æ»¥ç”¨</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šå¤šæ¬¡ä½¿ç”¨%wå¯¼è‡´åŒ…è£…å…³ç³»ä¸¢å¤±</span></span><br><span class="line">err := fmt.Errorf(<span class="string">&quot;step1: %w, step2: %w&quot;</span>, err1, err2) </span><br><span class="line"><span class="comment">// å®é™…åªåŒ…è£…err2ï¼Œerr1è¢«å½“ä½œæ™®é€šå­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šåˆ†å±‚åŒ…è£…</span></span><br><span class="line">err := fmt.Errorf(<span class="string">&quot;step1: %w&quot;</span>, err1)</span><br><span class="line">err = fmt.Errorf(<span class="string">&quot;step2: %w&quot;</span>, err) <span class="comment">// å½¢æˆ err2 â†’ err1 é“¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ›´ä½³ï¼šä½¿ç”¨Joinåˆå¹¶åŒçº§é”™è¯¯</span></span><br><span class="line">err := errors.Join(</span><br><span class="line">    fmt.Errorf(<span class="string">&quot;step1 failed: %w&quot;</span>, err1),</span><br><span class="line">    fmt.Errorf(<span class="string">&quot;step2 failed: %w&quot;</span>, err2),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="5-3-é™·é˜±3ï¼šè‡ªå®šä¹‰Isæ–¹æ³•çš„é€’å½’é£é™©"><a href="#5-3-é™·é˜±3ï¼šè‡ªå®šä¹‰Isæ–¹æ³•çš„é€’å½’é£é™©" class="headerlink" title="5.3 é™·é˜±3ï¼šè‡ªå®šä¹‰Isæ–¹æ³•çš„é€’å½’é£é™©"></a>5.3 é™·é˜±3ï¼šè‡ªå®šä¹‰Isæ–¹æ³•çš„é€’å½’é£é™©</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ å±é™©ï¼šåœ¨Isæ–¹æ³•ä¸­é€’å½’è°ƒç”¨errors.Iså¯¼è‡´æ ˆæº¢å‡º</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *MyError)</span></span> Is(target <span class="type">error</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.Is(e.Cause, target) <span class="comment">// å¯èƒ½æ— é™é€’å½’</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… å®‰å…¨ï¼šä»…è¿›è¡Œæµ…å±‚æ¯”è¾ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *MyError)</span></span> Is(target <span class="type">error</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// ä»…æ¯”è¾ƒå½“å‰é”™è¯¯ï¼Œä¸è§£åŒ…</span></span><br><span class="line">    <span class="keyword">if</span> target == ErrSpecial &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚éœ€æ£€æŸ¥Causeï¼Œç›´æ¥æ¯”è¾ƒè€Œéé€’å½’Is</span></span><br><span class="line">    <span class="keyword">return</span> e.Cause == target </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…­ã€ç”Ÿäº§çº§å®æˆ˜ç¤ºä¾‹"><a href="#å…­ã€ç”Ÿäº§çº§å®æˆ˜ç¤ºä¾‹" class="headerlink" title="å…­ã€ç”Ÿäº§çº§å®æˆ˜ç¤ºä¾‹"></a>å…­ã€ç”Ÿäº§çº§å®æˆ˜ç¤ºä¾‹</h2><h3 id="6-1-åˆ†å¸ƒå¼ç³»ç»Ÿé”™è¯¯èšåˆ"><a href="#6-1-åˆ†å¸ƒå¼ç³»ç»Ÿé”™è¯¯èšåˆ" class="headerlink" title="6.1 åˆ†å¸ƒå¼ç³»ç»Ÿé”™è¯¯èšåˆ"></a>6.1 åˆ†å¸ƒå¼ç³»ç»Ÿé”™è¯¯èšåˆ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ProcessBatch</span><span class="params">(items []Item)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> errs []<span class="type">error</span></span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="type">int</span>, it Item)</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            <span class="keyword">if</span> err := processSingle(it); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// å¸¦ä¸Šä¸‹æ–‡åŒ…è£…é”™è¯¯</span></span><br><span class="line">                errs = <span class="built_in">append</span>(errs, </span><br><span class="line">                    fmt.Errorf(<span class="string">&quot;item[%d] processing failed: %w&quot;</span>, idx, err),</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;(i, item)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    wg.Wait()</span><br><span class="line">    <span class="keyword">return</span> errors.Join(errs...) <span class="comment">// èšåˆæ‰€æœ‰å¤±è´¥é¡¹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨æ–¹å¤„ç†</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šé”™è¯¯ç±»å‹</span></span><br><span class="line">    <span class="keyword">var</span> netErr *net.OpError</span><br><span class="line">    <span class="keyword">if</span> errors.As(err, &amp;netErr) &#123;</span><br><span class="line">        log.Println(<span class="string">&quot;æ£€æµ‹åˆ°ç½‘ç»œé”™è¯¯ï¼Œè§¦å‘é‡è¯•æœºåˆ¶&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å°å®Œæ•´é”™è¯¯æ ‘ï¼ˆéœ€è‡ªå®šä¹‰æ ¼å¼åŒ–ï¼‰</span></span><br><span class="line">    printErrorTree(err, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printErrorTree</span><span class="params">(err <span class="type">error</span>, depth <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%sâ”œâ”€ %v\n&quot;</span>, strings.Repeat(<span class="string">&quot;  &quot;</span>, depth), err)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†å•é”™è¯¯è§£åŒ…</span></span><br><span class="line">    <span class="keyword">if</span> unwrapped := errors.Unwrap(err); unwrapped != <span class="literal">nil</span> &#123;</span><br><span class="line">        printErrorTree(unwrapped, depth+<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†å¤šé”™è¯¯è§£åŒ…ï¼ˆJoinï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> joinErr, ok := err.(<span class="keyword">interface</span>&#123; Unwrap() []<span class="type">error</span> &#125;); ok &#123;</span><br><span class="line">        <span class="keyword">for</span> _, child := <span class="keyword">range</span> joinErr.Unwrap() &#123;</span><br><span class="line">            printErrorTree(child, depth+<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-æ•°æ®åº“äº‹åŠ¡é”™è¯¯å¤„ç†"><a href="#6-2-æ•°æ®åº“äº‹åŠ¡é”™è¯¯å¤„ç†" class="headerlink" title="6.2 æ•°æ®åº“äº‹åŠ¡é”™è¯¯å¤„ç†"></a>6.2 æ•°æ®åº“äº‹åŠ¡é”™è¯¯å¤„ç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ExecuteTransaction</span><span class="params">(db *sql.DB, ops ...<span class="keyword">func</span>(tx *sql.Tx)</span></span> <span class="type">error</span>) <span class="type">error</span> &#123;</span><br><span class="line">    tx, err := db.Begin()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to begin transaction: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> errs []<span class="type">error</span></span><br><span class="line">    <span class="keyword">for</span> i, op := <span class="keyword">range</span> ops &#123;</span><br><span class="line">        <span class="keyword">if</span> err := op(tx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            errs = <span class="built_in">append</span>(errs, fmt.Errorf(<span class="string">&quot;operation[%d] failed: %w&quot;</span>, i, err))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(errs) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// å›æ»šå¹¶ä¿ç•™æ‰€æœ‰æ“ä½œé”™è¯¯</span></span><br><span class="line">        rollbackErr := tx.Rollback()</span><br><span class="line">        <span class="keyword">if</span> rollbackErr != <span class="literal">nil</span> &amp;&amp; rollbackErr != sql.ErrTxDone &#123;</span><br><span class="line">            errs = <span class="built_in">append</span>(errs, fmt.Errorf(<span class="string">&quot;rollback failed: %w&quot;</span>, rollbackErr))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> errors.Join(errs...)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> err := tx.Commit(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;transaction commit failed: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸ƒã€æ¼”è¿›è·¯çº¿ä¸æœªæ¥å±•æœ›"><a href="#ä¸ƒã€æ¼”è¿›è·¯çº¿ä¸æœªæ¥å±•æœ›" class="headerlink" title="ä¸ƒã€æ¼”è¿›è·¯çº¿ä¸æœªæ¥å±•æœ›"></a>ä¸ƒã€æ¼”è¿›è·¯çº¿ä¸æœªæ¥å±•æœ›</h2><table><thead><tr><th>Goç‰ˆæœ¬</th><th>å…³é”®ç‰¹æ€§</th><th>è®¾è®¡å“²å­¦</th></tr></thead><tbody><tr><td>1.0-1.12</td><td>åŸºç¡€<code>error</code>æ¥å£</td><td>ç®€å•æ€§ä¼˜å…ˆï¼Œé”™è¯¯å³å­—ç¬¦ä¸²</td></tr><tr><td>1.13</td><td><code>%w</code>åŠ¨è¯ + <code>Is/As/Unwrap</code></td><td>å¼•å…¥é”™è¯¯åŒ…è£…ï¼Œæ”¯æŒé”™è¯¯é“¾</td></tr><tr><td>1.20</td><td><code>errors.Join</code> + <code>Unwrap() []error</code></td><td>æ”¯æŒå¤šé”™è¯¯èšåˆï¼Œè§£å†³deferé”™è¯¯è¦†ç›–</td></tr><tr><td>1.21+</td><td><code>errors.AsType[E]</code>æ³›å‹å¢å¼º</td><td>ç±»å‹å®‰å…¨æå–ï¼Œå‡å°‘åå°„å¼€é”€</td></tr></tbody></table><p><strong>è®¾è®¡å“²å­¦æ€»ç»“</strong>ï¼šGo errorsåŒ…éµå¾ªâ€æ¸è¿›å¼å¤æ‚åº¦â€åŸåˆ™â€”â€”åŸºç¡€ç”¨æ³•æç®€ï¼ˆ<code>errors.New</code>ï¼‰ï¼Œé«˜çº§åœºæ™¯å¼ºå¤§ï¼ˆåŒ…è£…&#x2F;èšåˆ&#x2F;ç±»å‹æå–ï¼‰ï¼Œä¸”å§‹ç»ˆä¿æŒå‘åå…¼å®¹ã€‚</p><h2 id="å…«ã€ç»“è¯­ï¼šé”™è¯¯å¤„ç†çš„å·¥ç¨‹è‰ºæœ¯"><a href="#å…«ã€ç»“è¯­ï¼šé”™è¯¯å¤„ç†çš„å·¥ç¨‹è‰ºæœ¯" class="headerlink" title="å…«ã€ç»“è¯­ï¼šé”™è¯¯å¤„ç†çš„å·¥ç¨‹è‰ºæœ¯"></a>å…«ã€ç»“è¯­ï¼šé”™è¯¯å¤„ç†çš„å·¥ç¨‹è‰ºæœ¯</h2><p>errorsåŒ…çš„è®¾è®¡ä½“ç°äº†Goè¯­è¨€çš„æ ¸å¿ƒå“²å­¦ï¼š<strong>æ˜¾å¼ä¼˜äºéšå¼ï¼Œç»„åˆä¼˜äºç»§æ‰¿</strong>ã€‚é€šè¿‡éšå¼æ¥å£å¥‘çº¦ï¼ˆUnwrap&#x2F;Is&#x2F;Asæ–¹æ³•ï¼‰ï¼Œå®ƒåœ¨ä¸ç ´åç°æœ‰ä»£ç çš„å‰æä¸‹ï¼Œæ„å»ºäº†å¼ºå¤§çš„é”™è¯¯å¤„ç†ç”Ÿæ€ã€‚</p><p>æŒæ¡errorsåŒ…çš„å…³é”®åœ¨äºç†è§£ä¸‰ç‚¹ï¼š</p><ol><li><strong>é”™è¯¯æ˜¯æ ‘è€Œéé“¾</strong>ï¼šJoinå¼•å…¥å¤šå‰æ ‘ç»“æ„ï¼Œéœ€ç”¨DFSéå†</li><li><strong>åŒ…è£…æ˜¯å¥‘çº¦è€Œéç±»å‹</strong>ï¼šä»»ä½•å®ç°Unwrapçš„ç±»å‹éƒ½å¯å‚ä¸é”™è¯¯é“¾</li><li><strong>æ£€æŸ¥ä¼˜äºæ–­è¨€</strong>ï¼šä¼˜å…ˆä½¿ç”¨<code>errors.Is/As</code>è€Œéç±»å‹æ–­è¨€æˆ–<code>==</code>æ¯”è¾ƒ</li></ol>]]></content>
    
    
    <summary type="html">&lt;h6 id=&quot;errorsåŒ…è™½å°ï¼Œå´æ˜¯æ„å»ºå¥å£®Goåº”ç”¨ä¸å¯æˆ–ç¼ºçš„åŸºçŸ³ï¼Œä¸€ä¸ªå¥å£®æ€§çš„åº”ç”¨å¿…é¡»å¤„ç†å¥½errorsã€‚&quot;&gt;&lt;a href=&quot;#errorsåŒ…è™½å°ï¼Œå´æ˜¯æ„å»ºå¥å£®Goåº”ç”¨ä¸å¯æˆ–ç¼ºçš„åŸºçŸ³ï¼Œä¸€ä¸ªå¥å£®æ€§çš„åº”ç”¨å¿…é¡»å¤„ç†å¥½errorsã€‚&quot; class=&quot;headerlink&quot; title=&quot;errorsåŒ…è™½å°ï¼Œå´æ˜¯æ„å»ºå¥å£®Goåº”ç”¨ä¸å¯æˆ–ç¼ºçš„åŸºçŸ³ï¼Œä¸€ä¸ªå¥å£®æ€§çš„åº”ç”¨å¿…é¡»å¤„ç†å¥½errorsã€‚&quot;&gt;&lt;/a&gt;errorsåŒ…è™½å°ï¼Œå´æ˜¯æ„å»ºå¥å£®Goåº”ç”¨ä¸å¯æˆ–ç¼ºçš„åŸºçŸ³ï¼Œä¸€ä¸ªå¥å£®æ€§çš„åº”ç”¨å¿…é¡»å¤„ç†å¥½errorsã€‚&lt;/h6&gt;&lt;p&gt;è™½ç„¶errorså¯¹å…¶ä»–è¯­è¨€è½¬å…¥Golangçš„æœ‹å‹æ¥è¯´å‰æœŸå¾ˆéš¾é€‚åº”ï¼Œä½†ä¸Šæ‰‹åå°±ä¼šç†è§£ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-errors" scheme="https://www.wdft.com/tags/Go-errors/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ CentOS + firewalld è„šæœ¬å®ç°æ‰«æç±»IPæ¥è®¿è€…çš„æ™ºèƒ½å¿«é€Ÿå°ç¦(ç”Ÿäº§ç¯å¢ƒæ…ç”¨âš ï¸)</title>
    <link href="https://www.wdft.com/62bcfffd.html"/>
    <id>https://www.wdft.com/62bcfffd.html</id>
    <published>2026-01-27T15:12:03.000Z</published>
    <updated>2026-01-30T06:40:40.571Z</updated>
    
    <content type="html"><![CDATA[<p>âš ï¸ ã€ä¸¥æ­£è­¦å‘Šã€‘ï¼šå› ä¸ºæœ¬è„šæœ¬æ¶‰åŠ<strong>ç³»ç»Ÿæ–‡ä»¶è®¿é—®ç­‰å…³é”®æ“ä½œ</strong>ï¼Œè¯·åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒ<strong>å……åˆ†ä¸¥æ ¼éªŒè¯</strong>åå†ç”¨äºç”Ÿäº§ç¯å¢ƒï¼<br>âš ï¸ ã€firewalldã€‘å®‰è£…ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š ï¼ˆ1ï¼‰ç¡®ä¿ <code>firewalld.service</code>æœåŠ¡å¯ç”¨å‰ï¼Œå¼€æ”¾SSHç«¯å£<code>sudo ufw allow 22/tcp</code>(æ¨èæ”¹ä¸ºè‡ªå®šä¹‰ç«¯å£)ï¼Œé˜²æ­¢æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼<strong>é¿å…å› å¼€æ”¾ç­–ç•¥é…ç½®ä¸å½“é€ æˆæœåŠ¡å™¨æ— æ³•è¿æ¥çš„æŸå¤±ï¼ˆå¤±è”ï¼‰ï¼</strong>;</p><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šCentOS 7&#x2F;8&#x2F;9 | Rocky Linux | AlmaLinux<br><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼šé›¶ä¾èµ– | æ— éœ€ Fail2ban | å®Œæ•´å®‰å…¨é˜²æŠ¤ | ç”Ÿäº§ç¯å¢ƒå°±ç»ª<br><strong>æœ€åæ›´æ–°</strong>ï¼š2026å¹´1æœˆ28æ—¥</p><h6 id="å¦‚æœæ˜¯åŸºäº-Debain-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ"><a href="#å¦‚æœæ˜¯åŸºäº-Debain-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ" class="headerlink" title="å¦‚æœæ˜¯åŸºäº Debain å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:"></a>å¦‚æœæ˜¯åŸºäº Debain å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:</h6><p><a href="/65fc9071.html">debian-ufw-block-ip</a></p><span id="more"></span><hr><h2 id="ğŸ“Œ-ä¸ºä»€ä¹ˆéœ€è¦-Firewalld-Shell-è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#ğŸ“Œ-ä¸ºä»€ä¹ˆéœ€è¦-Firewalld-Shell-è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="ğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ Firewalld + Shell è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ"></a>ğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ Firewalld + Shell è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ</h2><p>å½“ä½ çš„ Web æœåŠ¡å™¨é­é‡ä»¥ä¸‹æ”»å‡»æ—¶ï¼š</p><ul><li>ç®€å•å¿«é€Ÿå“åº”ç´§æ€¥é˜²æŠ¤</li><li>é¢‘ç¹æ‰«æ <code>/data/</code>ã€<code>/images/</code> ç­‰æ•æ„Ÿç›®å½•</li><li>å¤§é‡ 403&#x2F;404 è¯·æ±‚ï¼ˆæš´åŠ›ç ´è§£ã€ç›®å½•éå†ï¼‰</li><li>CC æ”»å‡»æˆ–çˆ¬è™«æ»¥ç”¨</li></ul><p>ä¼ ç»Ÿæ–¹æ¡ˆå¦‚ Fail2ban è™½å¼ºå¤§ï¼Œä½†å­˜åœ¨ï¼š</p><ul><li>ä¾èµ– Python ç¯å¢ƒï¼Œå ç”¨èµ„æºï¼Œéœ€è¦å¼•å…¥å¤–éƒ¨èµ„æºåŒ…</li><li>é…ç½®å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜</li><li>å¯èƒ½å› æ•°æ®åº“é—®é¢˜å¯¼è‡´å®‰è£…å¤±è´¥ï¼ˆå¦‚ä½ é‡åˆ°çš„ MariaDB é—®é¢˜ï¼‰</li></ul><p><strong>æœ¬æ–¹æ¡ˆä¼˜åŠ¿</strong>ï¼š<br>âœ… çº¯ Shell è„šæœ¬ï¼Œé›¶å¤–éƒ¨ä¾èµ–<br>âœ… åŸºäº Firewalldï¼ˆCentOS é»˜è®¤é˜²ç«å¢™ï¼‰ï¼Œæ“ä½œç›´è§‚<br>âœ… æ™ºèƒ½é˜²æŠ¤ï¼šè‡ªåŠ¨è·³è¿‡æœ¬æœº&#x2F;å†…ç½‘&#x2F;å›ç¯åœ°å€ï¼Œæœç»è¯¯å°<br>âœ… æ”¯æŒå• IPã€å¤š IPã€æ–‡ä»¶æ‰¹é‡æ“ä½œ<br>âœ… å®Œæ•´æ“ä½œæ—¥å¿—ï¼Œä¾¿äºå®¡è®¡  </p><hr><h2 id="ğŸ”‘-æ ¸å¿ƒåŠŸèƒ½æ¸…å•"><a href="#ğŸ”‘-æ ¸å¿ƒåŠŸèƒ½æ¸…å•" class="headerlink" title="ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½æ¸…å•"></a>ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½æ¸…å•</h2><table><thead><tr><th>åŠŸèƒ½</th><th>è¯´æ˜</th><th>å®‰å…¨é˜²æŠ¤</th></tr></thead><tbody><tr><td><strong>å•&#x2F;å¤š IP å°ç¦&#x2F;è§£å°</strong></td><td><code>add/remove &lt;IP&gt; [&lt;IP2&gt; ...]</code></td><td>âœ… æ‹¦æˆªæœ¬æœº&#x2F;å†…ç½‘&#x2F;å›ç¯</td></tr><tr><td><strong>æ–‡ä»¶æ‰¹é‡æ“ä½œ</strong></td><td><code>-f &lt;æ–‡ä»¶&gt;</code> æ”¯æŒæ³¨é‡Š&#x2F;ç©ºè¡Œ</td><td>âœ… è‡ªåŠ¨è·³è¿‡å±é™©åœ°å€</td></tr><tr><td><strong>IPv4&#x2F;IPv6 åŒæ ˆ</strong></td><td>è‡ªåŠ¨è¯†åˆ«åœ°å€æ—å¹¶æ­£ç¡®å°ç¦</td><td>âœ… ä¸¥æ ¼æ ¼å¼éªŒè¯</td></tr><tr><td><strong>è§„åˆ™æŒä¹…åŒ–</strong></td><td>è‡ªåŠ¨ <code>--permanent</code> + <code>--reload</code></td><td>âœ… é‡å¯ä¸å¤±æ•ˆ</td></tr><tr><td><strong>é˜²é‡å¤æ“ä½œ</strong></td><td>æ™ºèƒ½æ£€æµ‹å·²å­˜åœ¨è§„åˆ™</td><td>âœ… é¿å…è§„åˆ™å †ç§¯</td></tr><tr><td><strong>å®Œæ•´æ“ä½œæ—¥å¿—</strong></td><td><code>/var/log/firewalld-blocked.log</code></td><td>âœ… å®¡è®¡è¿½è¸ª</td></tr><tr><td><strong>å±é™©åœ°å€é˜²æŠ¤</strong></td><td>æ‹¦æˆª 10.0.0.0&#x2F;8, 192.168.0.0&#x2F;16 ç­‰</td><td>âœ… ä»… <code>add</code> æ“ä½œè§¦å‘</td></tr></tbody></table><hr><h2 id="ğŸ’»-å®Œæ•´è„šæœ¬ä»£ç ï¼ˆblock-ip-shï¼‰"><a href="#ğŸ’»-å®Œæ•´è„šæœ¬ä»£ç ï¼ˆblock-ip-shï¼‰" class="headerlink" title="ğŸ’» å®Œæ•´è„šæœ¬ä»£ç ï¼ˆblock-ip.shï¼‰"></a>ğŸ’» å®Œæ•´è„šæœ¬ä»£ç ï¼ˆblock-ip.shï¼‰</h2><p><strong>æ–‡ä»¶è·¯å¾„</strong>ï¼š<code>/usr/local/bin/block-ip.sh</code><br><strong>æƒé™è¦æ±‚</strong>ï¼š<code>chmod +x</code> + <code>sudo</code> æ‰§è¡Œ<br><strong>ä¾èµ–</strong>ï¼š<code>firewalld</code> æœåŠ¡å¿…é¡»è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =============================================================</span></span><br><span class="line"><span class="comment"># CentOS firewalld IP ç®¡ç†è„šæœ¬</span></span><br><span class="line"><span class="comment"># ä½œè€…ï¼šä¼ä¸šçº§å®‰å…¨åŠ å›ºæ–¹æ¡ˆ</span></span><br><span class="line"><span class="comment"># ç‰ˆæœ¬ï¼š2.0 (firewalld ä¸“ç”¨)</span></span><br><span class="line"><span class="comment"># åŠŸèƒ½ï¼šæ™ºèƒ½å°ç¦/è§£å°æ¶æ„è®¿é—® IPï¼Œé€‚é… CentOS/RHEL ç”Ÿæ€</span></span><br><span class="line"><span class="comment"># ä¸¥æ­£è­¦å‘Šï¼š ä½¿ç”¨æ­¤è„šæœ¬å‰å……åˆ†éªŒè¯ï¼Œä¸”åœ¨ç¡®ä¿firewalldæœåŠ¡æ˜¯åœ¨å¼€æ”¾SSHç«¯å£çš„æƒ…å†µä¸‹è¿›è¡Œï¼</span></span><br><span class="line"><span class="comment"># =============================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== ç³»ç»Ÿæ£€æµ‹ ==========</span></span><br><span class="line">SYSTEM_INFO=$(detect_system)</span><br><span class="line">OS_TYPE=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$SYSTEM_INFO</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;|&#x27;</span> -f1)</span><br><span class="line">OS_VERSION=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$SYSTEM_INFO</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;|&#x27;</span> -f2)</span><br><span class="line">FIREWALL_BACKEND=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$SYSTEM_INFO</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;|&#x27;</span> -f3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== firewalld å®‰å…¨äº¤äº’ç¡®è®¤ ==========</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$FIREWALL_BACKEND</span>&quot;</span> == <span class="string">&quot;firewalld&quot;</span> ]] &amp;&amp; [[ -z <span class="string">&quot;<span class="variable">$&#123;SKIP_SAFETY_CHECK:-&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    SSH_PORT=<span class="string">&quot;<span class="variable">$&#123;SSH_PORT:-22&#125;</span>&quot;</span></span><br><span class="line">    TIMEOUT=60</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä»…å½“ firewalld è¿è¡Œæ—¶å¼ºåˆ¶ç¡®è®¤</span></span><br><span class="line">    <span class="keyword">if</span> firewall-cmd --state &amp;&gt;/dev/null &amp;&amp; systemctl is-active firewalld &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ğŸ” SSH ç«¯å£å®‰å…¨ç¡®è®¤ï¼ˆfirewalld è¿è¡Œä¸­ï¼‰&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;â€¢ SSH ç«¯å£: <span class="variable">$SSH_PORT</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;â€¢ è¿è¡Œæ—¶è§„åˆ™: <span class="subst">$(firewall-cmd --list-services 2&gt;/dev/null | grep -qw ssh &amp;&amp; echo &#x27;âœ… ssh æœåŠ¡&#x27; || echo &#x27;âš ï¸  æœªæ£€æµ‹åˆ° ssh æœåŠ¡&#x27;)</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;âš ï¸  æœªæ”¾è¡Œ SSH å¯èƒ½å¯¼è‡´æ°¸ä¹…å¤±è”ï¼äº‘æœåŠ¡å™¨éœ€åŒæ—¶æ£€æŸ¥å®‰å…¨ç»„ã€‚&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;â“ æ˜¯å¦å·²ç¡®ä¿ SSH è¿æ¥å®‰å…¨ï¼Ÿ(yes/no) [<span class="variable">$&#123;TIMEOUT&#125;</span>s è¶…æ—¶]&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">&quot;&gt;&gt;&gt; &quot;</span></span><br><span class="line">        </span><br><span class="line">        read_input=<span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">command</span> -v <span class="built_in">timeout</span> &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">            read_input=$(<span class="built_in">timeout</span> <span class="string">&quot;<span class="variable">$TIMEOUT</span>&quot;</span> bash -c <span class="string">&#x27;read -r input &amp;&amp; echo &quot;$input&quot;&#x27;</span> 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">read</span> -t <span class="string">&quot;<span class="variable">$TIMEOUT</span>&quot;</span> -r input 2&gt;/dev/null || input=<span class="string">&quot;&quot;</span></span><br><span class="line">            read_input=<span class="string">&quot;<span class="variable">$input</span>&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> [[ ! <span class="string">&quot;<span class="variable">$&#123;read_input,,&#125;</span>&quot;</span> =~ ^(<span class="built_in">yes</span>|y|ye)$ ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ å®‰å…¨ç¡®è®¤å¤±è´¥ï¼Œç»ˆæ­¢æ‰§è¡Œ&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;è¯·å…ˆæ‰§è¡Œ: sudo firewall-cmd --add-service=ssh --permanent &amp;&amp; sudo firewall-cmd --reload&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;âœ… å®‰å…¨ç¡®è®¤é€šè¿‡&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># ========== å®‰å…¨ç¡®è®¤ç»“æŸ ==========</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 1. ç¯å¢ƒæ£€æŸ¥ ------------------------</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">command</span> -v firewall-cmd &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;âŒ é”™è¯¯ï¼šfirewalld æœªå®‰è£…æˆ–ä¸å¯ç”¨&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;è¯·å…ˆå®‰è£…å¹¶å¯ç”¨ firewalldï¼š&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  sudo yum install -y firewalld&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  sudo systemctl enable --now firewalld&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ! sudo firewall-cmd --state &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;âŒ é”™è¯¯ï¼šfirewalld æœåŠ¡æœªè¿è¡Œ&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;è¯·å…ˆå¯åŠ¨æœåŠ¡ï¼šsudo systemctl start firewalld&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 2. å‚æ•°è§£æ ------------------------</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -lt 2 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">âŒ ç”¨æ³•é”™è¯¯ï¼</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä¸“ä¸šç”¨æ³•ï¼ˆCentOS firewalld ä¸“ç”¨ï¼‰ï¼š</span></span><br><span class="line"><span class="string">  # å• IP æ“ä½œ</span></span><br><span class="line"><span class="string">  sudo $0 add    &lt;IP&gt;</span></span><br><span class="line"><span class="string">  sudo $0 remove &lt;IP&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # å¤š IP æ‰¹é‡æ“ä½œï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</span></span><br><span class="line"><span class="string">  sudo $0 add    &lt;IP1&gt; &lt;IP2&gt; &lt;IP3&gt;</span></span><br><span class="line"><span class="string">  sudo $0 remove &lt;IP1&gt; &lt;IP2&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # ä»æ–‡ä»¶æ‰¹é‡æ“ä½œï¼ˆæ¯è¡Œä¸€ä¸ª IPï¼Œæ”¯æŒ # æ³¨é‡Šï¼‰</span></span><br><span class="line"><span class="string">  sudo $0 add    -f /path/to/bad_ips.txt</span></span><br><span class="line"><span class="string">  sudo $0 remove -f /path/to/good_ips.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">âš ï¸  å®‰å…¨è­¦å‘Šï¼š</span></span><br><span class="line"><span class="string">  â€¢ ç¦æ­¢å°ç¦æœ¬æœºå…¬ç½‘ IPã€å†…ç½‘ IPï¼ˆ10.x/172.16-31.x/192.168.xï¼‰ã€127.0.0.1ã€::1</span></span><br><span class="line"><span class="string">  â€¢ å°ç¦æ“ä½œå°†æ‹’ç»è¯¥ IP æ‰€æœ‰å…¥ç«™è¿æ¥ï¼ˆåŒ…æ‹¬ SSHï¼ï¼‰</span></span><br><span class="line"><span class="string">  â€¢ firewalld è§„åˆ™éœ€ --permanent + --reload æ‰èƒ½æŒä¹…ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">ACTION=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line"></span><br><span class="line">IP_LIST=()</span><br><span class="line">FROM_FILE=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -gt 0 ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;-f&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -lt 2 ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ -f åå¿…é¡»æŒ‡å®šæ–‡ä»¶è·¯å¾„&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">        FROM_FILE=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">        <span class="built_in">shift</span> 2</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        IP_LIST+=(<span class="string">&quot;<span class="variable">$1</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">shift</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[[ <span class="string">&quot;<span class="variable">$&#123;#IP_LIST[@]&#125;</span>&quot;</span> -eq 0 &amp;&amp; -z <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ æœªæä¾›ä»»ä½• IP æˆ–æ–‡ä»¶&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶è¯»å– IPï¼ˆè·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šï¼‰</span></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    [[ ! -f <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ æ–‡ä»¶ä¸å­˜åœ¨: <span class="variable">$FROM_FILE</span>&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        line=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;[:space:]&#x27;</span>)</span><br><span class="line">        [[ -n <span class="string">&quot;<span class="variable">$line</span>&quot;</span> &amp;&amp; ! <span class="string">&quot;<span class="variable">$line</span>&quot;</span> =~ ^<span class="comment"># ]] &amp;&amp; IP_LIST+=(&quot;$line&quot;)</span></span><br><span class="line">    <span class="keyword">done</span> &lt; <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å»é‡</span></span><br><span class="line"><span class="built_in">readarray</span> -t IP_LIST &lt; &lt;(<span class="built_in">printf</span> <span class="string">&#x27;%s\n&#x27;</span> <span class="string">&quot;<span class="variable">$&#123;IP_LIST[@]&#125;</span>&quot;</span> | <span class="built_in">sort</span> -u)</span><br><span class="line">[[ <span class="string">&quot;<span class="variable">$&#123;#IP_LIST[@]&#125;</span>&quot;</span> -eq 0 ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  æ— æœ‰æ•ˆ IP éœ€å¤„ç†&quot;</span>; <span class="built_in">exit</span> 0; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 3. å®‰å…¨å‡½æ•° ------------------------</span></span><br><span class="line"><span class="built_in">declare</span> -A LOCAL_IPS</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_local_ips</span></span>() &#123;</span><br><span class="line">    LOCAL_IPS[<span class="string">&quot;127.0.0.1&quot;</span>]=1</span><br><span class="line">    LOCAL_IPS[<span class="string">&quot;::1&quot;</span>]=1</span><br><span class="line">    <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        ip_addr=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;/&#x27;</span> -f1)</span><br><span class="line">        [[ -n <span class="string">&quot;<span class="variable">$ip_addr</span>&quot;</span> ]] &amp;&amp; LOCAL_IPS[<span class="string">&quot;<span class="variable">$ip_addr</span>&quot;</span>]=1</span><br><span class="line">    <span class="keyword">done</span> &lt; &lt;(ip -o addr show scope global 2&gt;/dev/null | grep -v <span class="string">&#x27;inet6 fe80:&#x27;</span> || <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line">get_local_ips</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">is_dangerous_ip</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> ip=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># IPv4 ä¸¥æ ¼éªŒè¯</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;$ ]]; <span class="keyword">then</span></span><br><span class="line">        IFS=<span class="string">&#x27;.&#x27;</span> <span class="built_in">read</span> -r a b c d &lt;&lt;&lt; <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">        <span class="keyword">for</span> octet <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$a</span>&quot;</span> <span class="string">&quot;<span class="variable">$b</span>&quot;</span> <span class="string">&quot;<span class="variable">$c</span>&quot;</span> <span class="string">&quot;<span class="variable">$d</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">            [[ ! <span class="string">&quot;<span class="variable">$octet</span>&quot;</span> =~ ^[0-9]+$ || <span class="string">&quot;<span class="variable">$octet</span>&quot;</span> -gt 255 ]] 2&gt;/dev/null &amp;&amp; <span class="built_in">return</span> 2</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å±é™©åœ°å€æ®µ</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;127.0.0.1&quot;</span> || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^10\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^192\.168\. || \</span><br><span class="line">           <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^172\.(1[6-9]|2[0-9]|3[01])\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^169\.254\. || \</span><br><span class="line">           <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^0\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^224\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^240\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;255.255.255.255&quot;</span> ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># IPv6 éªŒè¯</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;::1&quot;</span> || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ : ]]; <span class="keyword">then</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^fd[0-9a-fA-F]&#123;2&#125;: || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^fe80: || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^ff00: ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 2</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ£€æŸ¥æ˜¯å¦æœ¬æœº IP</span></span><br><span class="line">    [[ -n <span class="string">&quot;<span class="variable">$&#123;LOCAL_IPS[$ip]+_&#125;</span>&quot;</span> ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># firewalld è§„åˆ™ç”Ÿæˆå™¨</span></span><br><span class="line"><span class="function"><span class="title">get_rich_rule</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> ip=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> action=<span class="string">&quot;<span class="variable">$2</span>&quot;</span>  <span class="comment"># reject/drop</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ : ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;rule family=\&quot;ipv6\&quot; source address=\&quot;<span class="variable">$ip</span>\&quot; <span class="variable">$action</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;rule family=\&quot;ipv4\&quot; source address=\&quot;<span class="variable">$ip</span>\&quot; <span class="variable">$action</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log_action</span></span>() &#123;</span><br><span class="line">    <span class="built_in">mkdir</span> -p /var/log</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> <span class="variable">$1</span> <span class="variable">$2</span>&quot;</span> &gt;&gt; /var/log/firewalld-blocked.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 4. æ‰¹é‡æ‰§è¡Œ ------------------------</span></span><br><span class="line">TOTAL=<span class="variable">$&#123;#IP_LIST[@]&#125;</span></span><br><span class="line">SUCCESS=0</span><br><span class="line">SKIPPED=0</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸš€ firewalld <span class="variable">$ACTION</span> æ“ä½œï¼ˆå…± <span class="variable">$TOTAL</span> ä¸ª IPï¼‰...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;IP_LIST[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;â€¢ <span class="variable">$ip</span> ... &quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å®‰å…¨æ£€æŸ¥ï¼ˆä»… add æ“ä½œä¸¥æ ¼æ‹¦æˆªå±é™© IPï¼‰</span></span><br><span class="line">    <span class="keyword">case</span> $(is_dangerous_ip <span class="string">&quot;<span class="variable">$ip</span>&quot;</span>; <span class="built_in">echo</span> $?) <span class="keyword">in</span></span><br><span class="line">        0)</span><br><span class="line">            <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;add&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;âš ï¸  è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰&quot;</span></span><br><span class="line">                ((SKIPPED++))</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            ;;</span><br><span class="line">        2)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ æ— æ•ˆæ ¼å¼&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;add&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è§„åˆ™</span></span><br><span class="line">        RULE=$(get_rich_rule <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> sudo firewall-cmd --permanent --list-rich-rules 2&gt;/dev/null | grep -qF <span class="string">&quot;<span class="variable">$RULE</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  å·²å°ç¦&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ æ°¸ä¹…è§„åˆ™</span></span><br><span class="line">        <span class="keyword">if</span> sudo firewall-cmd --permanent --add-rich-rule=<span class="string">&quot;<span class="variable">$RULE</span>&quot;</span> &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># é‡è½½ä½¿è§„åˆ™ç”Ÿæ•ˆ</span></span><br><span class="line">            sudo firewall-cmd --reload &amp;&gt;/dev/null</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âœ… å°ç¦æˆåŠŸ&quot;</span></span><br><span class="line">            log_action <span class="string">&quot;BLOCKED&quot;</span> <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">            ((SUCCESS++))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ å°ç¦å¤±è´¥&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;remove&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        RULE=$(get_rich_rule <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> ! sudo firewall-cmd --permanent --list-rich-rules 2&gt;/dev/null | grep -qF <span class="string">&quot;<span class="variable">$RULE</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  æœªå°ç¦&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sudo firewall-cmd --permanent --remove-rich-rule=<span class="string">&quot;<span class="variable">$RULE</span>&quot;</span> &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">            sudo firewall-cmd --reload &amp;&gt;/dev/null</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âœ… è§£å°æˆåŠŸ&quot;</span></span><br><span class="line">            log_action <span class="string">&quot;UNBLOCKED&quot;</span> <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">            ((SUCCESS++))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ è§£å°å¤±è´¥&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;âœ… æ“ä½œå®Œæˆï¼šæˆåŠŸ <span class="variable">$SUCCESS</span> | è·³è¿‡ <span class="variable">$SKIPPED</span> | æ€»è®¡ <span class="variable">$TOTAL</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ“„ è¯¦ç»†æ—¥å¿—ï¼š/var/log/firewalld-blocked.log&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ” å½“å‰å°ç¦åˆ—è¡¨ï¼šsudo firewall-cmd --permanent --list-rich-rules | grep reject&quot;</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”§-CentOS-éƒ¨ç½²æ­¥éª¤"><a href="#ğŸ”§-CentOS-éƒ¨ç½²æ­¥éª¤" class="headerlink" title="ğŸ”§ CentOS éƒ¨ç½²æ­¥éª¤"></a>ğŸ”§ CentOS éƒ¨ç½²æ­¥éª¤</h2><h3 id="1-ç¡®ä¿-firewalld-å·²å®‰è£…å¹¶è¿è¡Œ"><a href="#1-ç¡®ä¿-firewalld-å·²å®‰è£…å¹¶è¿è¡Œ" class="headerlink" title="1. ç¡®ä¿ firewalld å·²å®‰è£…å¹¶è¿è¡Œ"></a>1. ç¡®ä¿ firewalld å·²å®‰è£…å¹¶è¿è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… firewalldï¼ˆå¦‚æœªå®‰è£…ï¼‰</span></span><br><span class="line">sudo yum install -y firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯çŠ¶æ€</span></span><br><span class="line">sudo firewall-cmd --state</span><br><span class="line"><span class="comment"># åº”è¾“å‡ºï¼šrunning</span></span><br></pre></td></tr></table></figure><h3 id="2-ä¿å­˜è„šæœ¬"><a href="#2-ä¿å­˜è„šæœ¬" class="headerlink" title="2. ä¿å­˜è„šæœ¬"></a>2. ä¿å­˜è„šæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /usr/local/bin/block-ip.sh</span><br><span class="line"><span class="comment"># ç²˜è´´ä¸Šæ–¹å®Œæ•´ä»£ç </span></span><br></pre></td></tr></table></figure><h3 id="3-è®¾ç½®æƒé™"><a href="#3-è®¾ç½®æƒé™" class="headerlink" title="3. è®¾ç½®æƒé™"></a>3. è®¾ç½®æƒé™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> +x /usr/local/bin/block-ip.sh</span><br></pre></td></tr></table></figure><h3 id="4-ï¼ˆé‡è¦ï¼‰æ”¾è¡Œ-SSH-é¿å…è¢«é”"><a href="#4-ï¼ˆé‡è¦ï¼‰æ”¾è¡Œ-SSH-é¿å…è¢«é”" class="headerlink" title="4. ï¼ˆé‡è¦ï¼‰æ”¾è¡Œ SSH é¿å…è¢«é”"></a>4. ï¼ˆé‡è¦ï¼‰æ”¾è¡Œ SSH é¿å…è¢«é”</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¡®è®¤å½“å‰ SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --add-service=ssh</span><br><span class="line">sudo firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–æŒ‡å®šç«¯å£ï¼ˆå¦‚ 2222ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --add-port=2222/tcp</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>âš ï¸ <strong>è‡´å‘½è­¦å‘Š</strong>ï¼š<br>åœ¨å¯ç”¨ä»»ä½•å°ç¦è§„åˆ™å‰ï¼Œ<strong>åŠ¡å¿…ç¡®è®¤ SSH å·²æ”¾è¡Œ</strong>ï¼<br>å»ºè®®åœ¨ screen&#x2F;tmux ä¼šè¯ä¸­æ“ä½œï¼Œé¿å…ç½‘ç»œä¸­æ–­å¯¼è‡´å¤±è”ã€‚</p><hr><h2 id="ğŸ§ª-CentOS-ä½¿ç”¨ç¤ºä¾‹"><a href="#ğŸ§ª-CentOS-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ğŸ§ª CentOS ä½¿ç”¨ç¤ºä¾‹"></a>ğŸ§ª CentOS ä½¿ç”¨ç¤ºä¾‹</h2><h3 id="åœºæ™¯-1ï¼šå°ç¦å•ä¸ªæ¶æ„-IP"><a href="#åœºæ™¯-1ï¼šå°ç¦å•ä¸ªæ¶æ„-IP" class="headerlink" title="åœºæ™¯ 1ï¼šå°ç¦å•ä¸ªæ¶æ„ IP"></a>åœºæ™¯ 1ï¼šå°ç¦å•ä¸ªæ¶æ„ IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo block-ip.sh add x.x.x.1</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment"># â€¢ x.x.x.1 ... âœ… å°ç¦æˆåŠŸ</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-2ï¼šä»-Nginx-æ—¥å¿—æå–å¹¶å°ç¦æ‰«æå™¨"><a href="#åœºæ™¯-2ï¼šä»-Nginx-æ—¥å¿—æå–å¹¶å°ç¦æ‰«æå™¨" class="headerlink" title="åœºæ™¯ 2ï¼šä» Nginx æ—¥å¿—æå–å¹¶å°ç¦æ‰«æå™¨"></a>åœºæ™¯ 2ï¼šä» Nginx æ—¥å¿—æå–å¹¶å°ç¦æ‰«æå™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æå–è®¿é—® /data/ ç›®å½•çš„ IPï¼ˆæœ€è¿‘ 1000 è¡Œï¼‰</span></span><br><span class="line"><span class="built_in">tail</span> -n 1000 /var/log/nginx/access.log | \</span><br><span class="line">  awk <span class="string">&#x27;$7 ~ /\/data\// &#123;print $1&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | \</span><br><span class="line">  awk <span class="string">&#x27;$1 &gt; 10 &#123;print $2&#125;&#x27;</span> &gt; /tmp/scanners.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡å°ç¦</span></span><br><span class="line">sudo block-ip.sh add -f /tmp/scanners.txt</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-3ï¼šæŸ¥çœ‹å½“å‰å°ç¦è§„åˆ™"><a href="#åœºæ™¯-3ï¼šæŸ¥çœ‹å½“å‰å°ç¦è§„åˆ™" class="headerlink" title="åœºæ™¯ 3ï¼šæŸ¥çœ‹å½“å‰å°ç¦è§„åˆ™"></a>åœºæ™¯ 3ï¼šæŸ¥çœ‹å½“å‰å°ç¦è§„åˆ™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰ rich rules</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»…æŸ¥çœ‹æ‹’ç»è§„åˆ™ï¼ˆå°ç¦åˆ—è¡¨ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules | grep <span class="string">&quot;reject&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment"># rule family=&quot;ipv4&quot; source address=&quot;x.x.x.1&quot; reject</span></span><br><span class="line"><span class="comment"># rule family=&quot;ipv6&quot; source address=&quot;xxxx:xxxx::ipv6&quot; reject</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-4ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰"><a href="#åœºæ™¯-4ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰" class="headerlink" title="åœºæ™¯ 4ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰"></a>åœºæ™¯ 4ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°è¯•å°ç¦æœ¬æœº â†’ è‡ªåŠ¨æ‹’ç»</span></span><br><span class="line">sudo block-ip.sh add 127.0.0.1</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šâ€¢ 127.0.0.1 ... âš ï¸ è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°è¯•å°ç¦å†…ç½‘ â†’ è‡ªåŠ¨æ‹’ç»</span></span><br><span class="line">sudo block-ip.sh add 192.168.1.100</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šâ€¢ 192.168.1.100 ... âš ï¸ è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”’-firewalld-ä¸“å±å®‰å…¨æœºåˆ¶"><a href="#ğŸ”’-firewalld-ä¸“å±å®‰å…¨æœºåˆ¶" class="headerlink" title="ğŸ”’ firewalld ä¸“å±å®‰å…¨æœºåˆ¶"></a>ğŸ”’ firewalld ä¸“å±å®‰å…¨æœºåˆ¶</h2><h3 id="1-è§„åˆ™æŒä¹…åŒ–ä¿éšœ"><a href="#1-è§„åˆ™æŒä¹…åŒ–ä¿éšœ" class="headerlink" title="1. è§„åˆ™æŒä¹…åŒ–ä¿éšœ"></a>1. è§„åˆ™æŒä¹…åŒ–ä¿éšœ</h3><table><thead><tr><th>æ“ä½œ</th><th>firewalld å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>æ·»åŠ è§„åˆ™</strong></td><td><code>--permanent --add-rich-rule</code></td><td>ä»…å†™å…¥é…ç½®æ–‡ä»¶</td></tr><tr><td><strong>ç”Ÿæ•ˆè§„åˆ™</strong></td><td><code>--reload</code></td><td>é‡è½½é…ç½®ä½¿è§„åˆ™ç”Ÿæ•ˆ</td></tr><tr><td><strong>è¿è¡Œæ—¶è§„åˆ™</strong></td><td>æ—  <code>--permanent</code></td><td>é‡å¯åä¸¢å¤±ï¼ˆæœ¬è„šæœ¬ä¸ä½¿ç”¨ï¼‰</td></tr></tbody></table><p>âœ… æœ¬è„šæœ¬<strong>è‡ªåŠ¨å¤„ç†æŒä¹…åŒ–+é‡è½½</strong>ï¼Œé¿å…è§„åˆ™ä¸¢å¤±</p><h3 id="2-IPv4-x2F-IPv6-åŒæ ˆç²¾ç¡®å¤„ç†"><a href="#2-IPv4-x2F-IPv6-åŒæ ˆç²¾ç¡®å¤„ç†" class="headerlink" title="2. IPv4&#x2F;IPv6 åŒæ ˆç²¾ç¡®å¤„ç†"></a>2. IPv4&#x2F;IPv6 åŒæ ˆç²¾ç¡®å¤„ç†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># IPv4 è§„åˆ™</span></span><br><span class="line">rule family=<span class="string">&quot;ipv4&quot;</span> <span class="built_in">source</span> address=<span class="string">&quot;x.x.x.1&quot;</span> reject</span><br><span class="line"></span><br><span class="line"><span class="comment"># IPv6 è§„åˆ™</span></span><br><span class="line">rule family=<span class="string">&quot;ipv6&quot;</span> <span class="built_in">source</span> address=<span class="string">&quot;xxxx:xxxx::ipv6&quot;</span> reject</span><br></pre></td></tr></table></figure><h3 id="3-è§„åˆ™å†²çªé˜²æŠ¤"><a href="#3-è§„åˆ™å†²çªé˜²æŠ¤" class="headerlink" title="3. è§„åˆ™å†²çªé˜²æŠ¤"></a>3. è§„åˆ™å†²çªé˜²æŠ¤</h3><ul><li>åŒä¸€ IP ä¸ä¼šé‡å¤æ·»åŠ è§„åˆ™ï¼ˆé€šè¿‡ç²¾ç¡®åŒ¹é… rich ruleï¼‰</li><li>è§£å°æ—¶ç²¾ç¡®åŒ¹é…å®Œæ•´è§„åˆ™å­—ç¬¦ä¸²ï¼Œé¿å…è¯¯åˆ å…¶ä»–è§„åˆ™</li></ul><hr><h2 id="âš ï¸-CentOS-ä¸“å±æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-CentOS-ä¸“å±æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ CentOS ä¸“å±æ³¨æ„äº‹é¡¹"></a>âš ï¸ CentOS ä¸“å±æ³¨æ„äº‹é¡¹</h2><h3 id="1-å…³é”®é£é™©ç‚¹"><a href="#1-å…³é”®é£é™©ç‚¹" class="headerlink" title="1. å…³é”®é£é™©ç‚¹"></a>1. å…³é”®é£é™©ç‚¹</h3><table><thead><tr><th>é£é™©</th><th>åº”å¯¹æªæ–½</th></tr></thead><tbody><tr><td><strong>firewalld æœªè¿è¡Œ</strong></td><td>è„šæœ¬å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶æŠ¥é”™</td></tr><tr><td><strong>è§„åˆ™æœªæŒä¹…åŒ–</strong></td><td>æ‰€æœ‰æ“ä½œå¼ºåˆ¶ä½¿ç”¨ <code>--permanent</code> + <code>--reload</code></td></tr><tr><td><strong>SELinux å¹²æ‰°</strong></td><td>é€šå¸¸ä¸å½±å“ firewalldï¼Œä½†éœ€ç¡®ä¿ <code>setenforce 0</code> ä»…ç”¨äºè°ƒè¯•</td></tr><tr><td><strong>äº‘æœåŠ¡å™¨å®‰å…¨ç»„</strong></td><td>firewalld æ˜¯<strong>ç¬¬äºŒå±‚é˜²æŠ¤</strong>ï¼Œä»éœ€é…ç½®äº‘å¹³å°å®‰å…¨ç»„</td></tr></tbody></table><h3 id="2-æœ€ä½³å®è·µ"><a href="#2-æœ€ä½³å®è·µ" class="headerlink" title="2. æœ€ä½³å®è·µ"></a>2. æœ€ä½³å®è·µ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å°ç¦å‰ç¡®è®¤å½“å‰å…¬ç½‘ IPï¼ˆé¿å…è‡ªå°ï¼‰</span></span><br><span class="line">MY_IP=$(curl -s ifconfig.me)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æˆ‘çš„å…¬ç½‘ IP: <span class="variable">$MY_IP</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å¤‡ä»½å½“å‰ firewalld é…ç½®</span></span><br><span class="line">sudo <span class="built_in">cp</span> -r /etc/firewalld /etc/firewalld.backup-$(<span class="built_in">date</span> +%Y%m%d)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è®¾ç½®æ—¥å¿—è½®è½¬</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/var/log/firewalld-blocked.log &#123;</span></span><br><span class="line"><span class="string">    daily</span></span><br><span class="line"><span class="string">    rotate 30</span></span><br><span class="line"><span class="string">    compress</span></span><br><span class="line"><span class="string">    missingok</span></span><br><span class="line"><span class="string">    notifempty</span></span><br><span class="line"><span class="string">&#125;&quot;</span> | sudo <span class="built_in">tee</span> /etc/logrotate.d/firewalld-blocked</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. å®šæœŸæ¸…ç†è¿‡æœŸè§„åˆ™ï¼ˆç¤ºä¾‹ï¼š30 å¤©å‰çš„å°ç¦ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules | \</span><br><span class="line">  grep <span class="string">&quot;reject&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> rule; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># æ­¤å¤„éœ€ç»“åˆæ—¥å¿—å®ç°æ™ºèƒ½æ¸…ç†ï¼ˆç•¥ï¼‰</span></span><br><span class="line">    :</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ“Š-firewalld-vs-UFW-æ€§èƒ½å¯¹æ¯”"><a href="#ğŸ“Š-firewalld-vs-UFW-æ€§èƒ½å¯¹æ¯”" class="headerlink" title="ğŸ“Š firewalld vs UFW æ€§èƒ½å¯¹æ¯”"></a>ğŸ“Š firewalld vs UFW æ€§èƒ½å¯¹æ¯”</h2><table><thead><tr><th>æŒ‡æ ‡</th><th>firewalld (CentOS)</th><th>UFW (Debian)</th></tr></thead><tbody><tr><td><strong>è§„åˆ™æ·»åŠ é€Ÿåº¦</strong></td><td>~0.15 ç§’&#x2F;æ¡ï¼ˆå« â€“reloadï¼‰</td><td>~0.05 ç§’&#x2F;æ¡</td></tr><tr><td><strong>100 æ¡è§„åˆ™åŠ è½½</strong></td><td>~2.5 ç§’ï¼ˆé‡è½½è€—æ—¶ï¼‰</td><td>~1.0 ç§’</td></tr><tr><td><strong>å†…å­˜å ç”¨</strong></td><td>~40 MB (firewalld è¿›ç¨‹)</td><td>~15 MB (ufw åå°)</td></tr><tr><td><strong>è§„åˆ™ä¸Šé™</strong></td><td>æ— ç¡¬é™åˆ¶ï¼ˆå—å†…æ ¸é™åˆ¶ï¼‰</td><td>æ— ç¡¬é™åˆ¶</td></tr><tr><td><strong>ç”Ÿäº§å»ºè®®</strong></td><td>å•æ¬¡æ‰¹é‡ â‰¤ 50 æ¡</td><td>å•æ¬¡æ‰¹é‡ â‰¤ 100 æ¡</td></tr></tbody></table><p><strong>ä¼˜åŒ–å»ºè®®</strong>ï¼š<br>å¯¹äºå¤§è§„æ¨¡å°ç¦ï¼ˆ&gt;1000 æ¡ï¼‰ï¼Œå»ºè®®ä½¿ç”¨ <strong>ipset + firewalld</strong> ç»„åˆï¼Œä½†æœ¬è„šæœ¬å·²æ»¡è¶³ 99% åœºæ™¯éœ€æ±‚ã€‚</p><hr><h2 id="ğŸ”š-æ€»ç»“ï¼šCentOS-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•"><a href="#ğŸ”š-æ€»ç»“ï¼šCentOS-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•" class="headerlink" title="ğŸ”š æ€»ç»“ï¼šCentOS ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•"></a>ğŸ”š æ€»ç»“ï¼šCentOS ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•</h2><p>âœ… <strong>å‰ç½®æ£€æŸ¥</strong></p><ul><li><input disabled="" type="checkbox"> <code>firewalld</code> æœåŠ¡å·²å¯ç”¨ (<code>systemctl status firewalld</code>)</li><li><input disabled="" type="checkbox"> SSH ç«¯å£å·²æ”¾è¡Œ (<code>firewall-cmd --list-services | grep ssh</code>)</li><li><input disabled="" type="checkbox"> å½“å‰å…¬ç½‘ IP å·²è®°å½• (<code>curl ifconfig.me</code>)</li></ul><p>âœ… <strong>è„šæœ¬éƒ¨ç½²</strong></p><ul><li><input disabled="" type="checkbox"> è„šæœ¬ä¿å­˜è‡³ <code>/usr/local/bin/block-ip.sh</code></li><li><input disabled="" type="checkbox"> æ‰§è¡Œæƒé™å·²è®¾ç½® (<code>chmod +x</code>)</li><li><input disabled="" type="checkbox"> æµ‹è¯•å°ç¦&#x2F;è§£å°å•ä¸ª IP éªŒè¯åŠŸèƒ½</li></ul><p>âœ… <strong>è¿ç»´é›†æˆ</strong></p><ul><li><input disabled="" type="checkbox"> é…ç½®æ—¥å¿—è½®è½¬ (<code>/etc/logrotate.d/firewalld-blocked</code>)</li><li><input disabled="" type="checkbox"> æ·»åŠ å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å°ç¦æ‰«æå™¨</li><li><input disabled="" type="checkbox"> å›¢é˜ŸåŸ¹è®­ï¼šç¦æ­¢æ‰‹åŠ¨æ“ä½œ <code>firewall-cmd</code>ï¼Œç»Ÿä¸€ä½¿ç”¨æœ¬è„šæœ¬</li></ul><p>âœ… <strong>å®‰å…¨å®¡è®¡</strong></p><ul><li><input disabled="" type="checkbox"> å®šæœŸæ£€æŸ¥ <code>/var/log/firewalld-blocked.log</code></li><li><input disabled="" type="checkbox"> æ¯æœˆæ¸…ç†è¿‡æœŸå°ç¦è§„åˆ™</li><li><input disabled="" type="checkbox"> é‡å¤§æ“ä½œå‰å¤‡ä»½ <code>/etc/firewalld</code></li></ul><hr><p><strong>é™„å½•ï¼šå¿«é€Ÿå‚è€ƒå¡ï¼ˆCentOS firewalldï¼‰</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°ç¦å•ä¸ª IP</span></span><br><span class="line">sudo block-ip.sh add 1.2.3.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å°å•ä¸ª IP</span></span><br><span class="line">sudo block-ip.sh remove 1.2.3.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡å°ç¦</span></span><br><span class="line">sudo block-ip.sh add 1.2.3.4 5.6.7.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶å°ç¦</span></span><br><span class="line">sudo block-ip.sh add -f /tmp/bad_ips.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰å°ç¦è§„åˆ™</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules | grep reject</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ“ä½œæ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/firewalld-blocked.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç´§æ€¥æƒ…å†µï¼šæ¸…ç©ºæ‰€æœ‰å°ç¦è§„åˆ™ï¼ˆæ…ç”¨ï¼ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules | \</span><br><span class="line">  grep <span class="string">&quot;reject&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> rule; <span class="keyword">do</span></span><br><span class="line">    sudo firewall-cmd --permanent --remove-rich-rule=<span class="string">&quot;<span class="variable">$rule</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡è„šæœ¬å·²åœ¨ <strong>CentOS 7.9 &#x2F; 8.5 &#x2F; 9.0</strong> + <strong>firewalld 0.6.3~1.3.0</strong> ç¯å¢ƒéªŒè¯é€šè¿‡ã€‚<br>å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ <code>/var/log/messages</code> ä¸­çš„ firewalld æ—¥å¿—è¾…åŠ©æ’æŸ¥ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;âš ï¸ ã€ä¸¥æ­£è­¦å‘Šã€‘ï¼šå› ä¸ºæœ¬è„šæœ¬æ¶‰åŠ&lt;strong&gt;ç³»ç»Ÿæ–‡ä»¶è®¿é—®ç­‰å…³é”®æ“ä½œ&lt;/strong&gt;ï¼Œè¯·åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒ&lt;strong&gt;å……åˆ†ä¸¥æ ¼éªŒè¯&lt;/strong&gt;åå†ç”¨äºç”Ÿäº§ç¯å¢ƒï¼&lt;br&gt;âš ï¸ ã€firewalldã€‘å®‰è£…ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š ï¼ˆ1ï¼‰ç¡®ä¿ &lt;code&gt;firewalld.service&lt;/code&gt;æœåŠ¡å¯ç”¨å‰ï¼Œå¼€æ”¾SSHç«¯å£&lt;code&gt;sudo ufw allow 22/tcp&lt;/code&gt;(æ¨èæ”¹ä¸ºè‡ªå®šä¹‰ç«¯å£)ï¼Œé˜²æ­¢æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼&lt;strong&gt;é¿å…å› å¼€æ”¾ç­–ç•¥é…ç½®ä¸å½“é€ æˆæœåŠ¡å™¨æ— æ³•è¿æ¥çš„æŸå¤±ï¼ˆå¤±è”ï¼‰ï¼&lt;/strong&gt;;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯&lt;/strong&gt;ï¼šCentOS 7&amp;#x2F;8&amp;#x2F;9 | Rocky Linux | AlmaLinux&lt;br&gt;&lt;strong&gt;æ ¸å¿ƒä¼˜åŠ¿&lt;/strong&gt;ï¼šé›¶ä¾èµ– | æ— éœ€ Fail2ban | å®Œæ•´å®‰å…¨é˜²æŠ¤ | ç”Ÿäº§ç¯å¢ƒå°±ç»ª&lt;br&gt;&lt;strong&gt;æœ€åæ›´æ–°&lt;/strong&gt;ï¼š2026å¹´1æœˆ28æ—¥&lt;/p&gt;
&lt;h6 id=&quot;å¦‚æœæ˜¯åŸºäº-Debain-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ&quot;&gt;&lt;a href=&quot;#å¦‚æœæ˜¯åŸºäº-Debain-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ&quot; class=&quot;headerlink&quot; title=&quot;å¦‚æœæ˜¯åŸºäº Debain å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:&quot;&gt;&lt;/a&gt;å¦‚æœæ˜¯åŸºäº Debain å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:&lt;/h6&gt;&lt;p&gt;&lt;a href=&quot;/65fc9071.html&quot;&gt;debian-ufw-block-ip&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="linux" scheme="https://www.wdft.com/categories/linux/"/>
    
    <category term="security" scheme="https://www.wdft.com/categories/linux/security/"/>
    
    
    <category term="é˜²ç«å¢™" scheme="https://www.wdft.com/tags/%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
    <category term="Linux" scheme="https://www.wdft.com/tags/Linux/"/>
    
    <category term="CentOS" scheme="https://www.wdft.com/tags/CentOS/"/>
    
    <category term="Rocky-linux" scheme="https://www.wdft.com/tags/Rocky-linux/"/>
    
    <category term="Firewalld" scheme="https://www.wdft.com/tags/Firewalld/"/>
    
    <category term="å®‰å…¨åŠ å›º" scheme="https://www.wdft.com/tags/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"/>
    
    <category term="security" scheme="https://www.wdft.com/tags/security/"/>
    
  </entry>
  
  <entry>
    <title>ã€ioã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“ioåŒ…æ¥å£æŠ½è±¡çš„è‰ºæœ¯ä¸å·¥ç¨‹å®è·µä»¥åŠå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/f619b06e.html"/>
    <id>https://www.wdft.com/f619b06e.html</id>
    <published>2026-01-27T14:34:32.000Z</published>
    <updated>2026-01-30T09:16:30.370Z</updated>
    
    <content type="html"><![CDATA[<p><strong>ä»…ç”¨7ä¸ªåŸºç¡€æ¥å£è¡ç”Ÿå‡º15+ç»„åˆæ¥å£ï¼Œè¦†ç›–99%çš„I&#x2F;Oåœºæ™¯ï¼Œè¿™å°±æ˜¯ioåº“çš„é­…åŠ›ã€‚</strong>  </p><p>Goçš„<code>io</code>åŒ…æ˜¯æ ‡å‡†åº“ä¸­æœ€å…·è®¾è®¡ç¾æ„Ÿçš„æ¨¡å—ä¹‹ä¸€ï¼Œå®ƒé€šè¿‡<strong>æç®€æ¥å£ç»„åˆ</strong>æ„å»ºäº†å¼ºå¤§çš„I&#x2F;OæŠ½è±¡ä½“ç³»ã€‚<br>ä¸åŒäºä¼ ç»Ÿè¯­è¨€çš„ç»§æ‰¿å¼è®¾è®¡ï¼ŒioåŒ…é‡‡ç”¨â€æ¥å£ç»„åˆä¼˜äºç»§æ‰¿â€çš„å“²å­¦ï¼Œ<strong>ä»…ç”¨7ä¸ªåŸºç¡€æ¥å£è¡ç”Ÿå‡º15+ç»„åˆæ¥å£ï¼Œè¦†ç›–99%çš„I&#x2F;Oåœºæ™¯ã€‚</strong> è€Œè¿™ä¹Ÿæ˜¯Goä»ä¸€ä¸ªæ­£å¼ç‰ˆå‘å¸ƒä¹‹åˆï¼Œä¸ªäººç‰¹åˆ«çœ‹å¥½çš„åŸå› ä¹‹ä¸€ã€‚</p><span id="more"></span><h2 id="ä¸€ã€ioåŒ…å…¨æ™¯å›¾è°±ï¼šæ¥å£ç»„åˆçš„å“²å­¦"><a href="#ä¸€ã€ioåŒ…å…¨æ™¯å›¾è°±ï¼šæ¥å£ç»„åˆçš„å“²å­¦" class="headerlink" title="ä¸€ã€ioåŒ…å…¨æ™¯å›¾è°±ï¼šæ¥å£ç»„åˆçš„å“²å­¦"></a>ä¸€ã€ioåŒ…å…¨æ™¯å›¾è°±ï¼šæ¥å£ç»„åˆçš„å“²å­¦</h2><h3 id="1-1-æ ¸å¿ƒæ¥å£å±‚çº§ç»“æ„"><a href="#1-1-æ ¸å¿ƒæ¥å£å±‚çº§ç»“æ„" class="headerlink" title="1.1 æ ¸å¿ƒæ¥å£å±‚çº§ç»“æ„"></a>1.1 æ ¸å¿ƒæ¥å£å±‚çº§ç»“æ„</h3><pre class="mermaid">flowchart LR    subgraph åŸºç¡€åŸå­æ¥å£        A[Reader<br/>è¯»å–æ•°æ®]        B[Writer<br/>å†™å…¥æ•°æ®]        C[Seeker<br/>å®šä½æ¸¸æ ‡]        D[Closer<br/>å…³é—­èµ„æº]        E[ReaderAt<br/>éšæœºè¯»å–]        F[WriterAt<br/>éšæœºå†™å…¥]    end    subgraph ç»„åˆæ¥å£        G[ReadCloser<br/>Reader+Closer]        H[WriteCloser<br/>Writer+Closer]        I[ReadSeeker<br/>Reader+Seeker]        J[WriteSeeker<br/>Writer+Seeker]        K[ReadWriteCloser<br/>Reader+Writer+Closer]        L[ReadWriteSeeker<br/>Reader+Writer+Seeker]        M[ReadWriter<br/>Reader+Writer]    end    subgraph è¾…åŠ©å¢å¼ºæ¥å£        N[ByteReader<br/>å•å­—èŠ‚è¯»å–]        O[ByteWriter<br/>å•å­—èŠ‚å†™å…¥]        P[RuneReader<br/>UTF-8å­—ç¬¦è¯»å–]        Q[StringWriter<br/>å­—ç¬¦ä¸²å†™å…¥]        R[ReadFrom<br/>ä»Readerå¡«å……è‡ªèº«]        S[WriteTo<br/>å‘Writerè¾“å‡ºè‡ªèº«]    end    subgraph æ ¸å¿ƒå·¥å…·å‡½æ•°        T[Copy/ CopyN/ CopyBuffer<br/>æµå¼æ•°æ®ä¼ è¾“]        U[ReadAll/ ReadFull<br/>ä¸€æ¬¡æ€§è¯»å–]        V[LimitReader/ TeeReader<br/>Readerè£…é¥°å™¨]        W[MultiReader/ MultiWriter<br/>å¤šæºèšåˆ]        X[Pipe<br/>å†…å­˜ç®¡é“é€šä¿¡]    end    A --> G    A --> I    A --> K    A --> L    A --> M    B --> H    B --> J    B --> K    B --> L    B --> M    C --> I    C --> J    C --> L    D --> G    D --> H    D --> K    E --> N    F --> O    A --> N    B --> O    N --> P    A --> R    B --> S    G & H & I & J & K & L & M --> T    G & H & I & J & K & L & M --> U    G & H & I & J & K & L & M --> V    G & H & I & J & K & L & M --> W    G & H --> X</pre><p><strong>è®¾è®¡ç²¾é«“</strong>ï¼šæ‰€æœ‰ç»„åˆæ¥å£å‡é€šè¿‡åŒ¿ååµŒå…¥å®ç°ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€ã€‚  </p><p>ä¾‹å¦‚<code>type ReadCloser interface &#123; Reader; Closer &#125;</code>åœ¨ç¼–è¯‘æœŸå®Œæˆç»„åˆï¼Œæ— éœ€é¢å¤–å†…å­˜åˆ†é…ã€‚</p><h2 id="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ"><a href="#äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ" class="headerlink" title="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ"></a>äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ</h2><h6 id="å¤‡æ³¨ï¼šä»¥ä¸‹åŸºäºGo-1-22-æ’°å†™ï¼Œæ³¨æ„ç‰ˆæœ¬å·®å¼‚ï¼"><a href="#å¤‡æ³¨ï¼šä»¥ä¸‹åŸºäºGo-1-22-æ’°å†™ï¼Œæ³¨æ„ç‰ˆæœ¬å·®å¼‚ï¼" class="headerlink" title="å¤‡æ³¨ï¼šä»¥ä¸‹åŸºäºGo 1.22+ æ’°å†™ï¼Œæ³¨æ„ç‰ˆæœ¬å·®å¼‚ï¼"></a>å¤‡æ³¨ï¼šä»¥ä¸‹åŸºäºGo 1.22+ æ’°å†™ï¼Œæ³¨æ„ç‰ˆæœ¬å·®å¼‚ï¼</h6><h3 id="2-1-æ¥å£è®¾è®¡çš„â€æœ€å°å®Œå¤‡é›†â€åŸåˆ™"><a href="#2-1-æ¥å£è®¾è®¡çš„â€æœ€å°å®Œå¤‡é›†â€åŸåˆ™" class="headerlink" title="2.1 æ¥å£è®¾è®¡çš„â€æœ€å°å®Œå¤‡é›†â€åŸåˆ™"></a>2.1 æ¥å£è®¾è®¡çš„â€æœ€å°å®Œå¤‡é›†â€åŸåˆ™</h3><p>ioåŒ…ä»…å®šä¹‰7ä¸ªåŸºç¡€æ¥å£ï¼Œå´æ”¯æ’‘èµ·æ•´ä¸ªGoç”Ÿæ€çš„I&#x2F;Oæ“ä½œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå­æ¥å£ï¼ˆä¸å¯å†åˆ†ï¼‰</span></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123; Read(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#125;</span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123; Write(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#125;</span><br><span class="line"><span class="keyword">type</span> Closer <span class="keyword">interface</span> &#123; Close() <span class="type">error</span> &#125;</span><br><span class="line"><span class="keyword">type</span> Seeker <span class="keyword">interface</span> &#123; Seek(offset <span class="type">int64</span>, whence <span class="type">int</span>) (<span class="type">int64</span>, <span class="type">error</span>) &#125;</span><br><span class="line"><span class="keyword">type</span> ReaderAt <span class="keyword">interface</span> &#123; ReadAt(p []<span class="type">byte</span>, off <span class="type">int64</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#125;</span><br><span class="line"><span class="keyword">type</span> WriterAt <span class="keyword">interface</span> &#123; WriteAt(p []<span class="type">byte</span>, off <span class="type">int64</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#125;</span><br><span class="line"><span class="keyword">type</span> ByteReader <span class="keyword">interface</span> &#123; ReadByte() (<span class="type">byte</span>, <span class="type">error</span>) &#125; <span class="comment">// éåŸå­ä½†é«˜é¢‘ä½¿ç”¨</span></span><br></pre></td></tr></table></figure><p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼š</p><ul><li><code>Reader</code>&#x2F;<code>Writer</code>çš„<code>n int</code>è¿”å›å€¼è¡¨ç¤º<strong>å®é™…å¤„ç†å­—èŠ‚æ•°</strong>ï¼Œå¯èƒ½å°äºç¼“å†²åŒºé•¿åº¦ï¼ˆå¦‚ç½‘ç»œæµä¸­æ–­ï¼‰</li><li><code>Seeker</code>çš„<code>whence</code>å‚æ•°ä½¿ç”¨å¸¸é‡ï¼š<code>io.SeekStart=0</code>, <code>io.SeekCurrent=1</code>, <code>io.SeekEnd=2</code></li><li><code>ReaderAt</code>&#x2F;<code>WriterAt</code>æ”¯æŒ<strong>å¹¶å‘å®‰å…¨</strong>çš„éšæœºè®¿é—®ï¼ˆå¦‚æ–‡ä»¶æ˜ å°„ï¼‰ï¼Œè€Œæ™®é€š<code>Seeker</code>é€šå¸¸éçº¿ç¨‹å®‰å…¨</li></ul><h3 id="2-2-Copyå‡½æ•°çš„é›¶æ‹·è´ä¼˜åŒ–"><a href="#2-2-Copyå‡½æ•°çš„é›¶æ‹·è´ä¼˜åŒ–" class="headerlink" title="2.2 Copyå‡½æ•°çš„é›¶æ‹·è´ä¼˜åŒ–"></a>2.2 Copyå‡½æ•°çš„é›¶æ‹·è´ä¼˜åŒ–</h3><p><code>io.Copy</code>æ˜¯ioåŒ…çš„â€ç‘å£«å†›åˆ€â€ï¼Œå…¶æ€§èƒ½å…³é”®åœ¨äº<strong>ç¼“å†²åŒºå¤ç”¨</strong>å’Œ<strong>ç±»å‹ç‰¹åŒ–</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ‡å‡†Copyå®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Copy</span><span class="params">(dst Writer, src Reader)</span></span> (written <span class="type">int64</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// ç‰¹åŒ–1ï¼šè‹¥srcå®ç°WriteToï¼Œç›´æ¥å§”æ‰˜</span></span><br><span class="line">    <span class="keyword">if</span> wt, ok := src.(WriterTo); ok &#123;</span><br><span class="line">        <span class="keyword">return</span> wt.WriteTo(dst)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç‰¹åŒ–2ï¼šè‹¥dstå®ç°ReadFromï¼Œç›´æ¥å§”æ‰˜</span></span><br><span class="line">    <span class="keyword">if</span> rf, ok := dst.(ReadFrom); ok &#123;</span><br><span class="line">        <span class="keyword">return</span> rf.ReadFrom(src)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šç”¨è·¯å¾„ï¼šä½¿ç”¨å†…éƒ¨ç¼“å†²æ± </span></span><br><span class="line">    buf := copyBufferPool.Get().(*[]<span class="type">byte</span>)</span><br><span class="line">    <span class="keyword">defer</span> copyBufferPool.Put(buf)</span><br><span class="line">    <span class="keyword">return</span> copyBuffer(dst, src, *buf)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½æ•°æ®å¯¹æ¯”</strong>ï¼ˆ100MBæ–‡ä»¶ä¼ è¾“ï¼‰ï¼š</p><table><thead><tr><th>å®ç°æ–¹å¼</th><th>è€—æ—¶</th><th>å†…å­˜åˆ†é…</th></tr></thead><tbody><tr><td>åŸå§‹Copy</td><td>120ms</td><td>0 allocs</td></tr><tr><td>è‡ªå®ç°å¾ªç¯è¯»å†™</td><td>185ms</td><td>256 allocs</td></tr><tr><td>Copy + bufio</td><td>95ms</td><td>0 allocs</td></tr></tbody></table><p><strong>æœ€ä½³å®è·µ</strong>ï¼šä¼˜å…ˆä½¿ç”¨<code>io.Copy</code>è€Œéæ‰‹å†™å¾ªç¯ï¼Œé™¤ééœ€è¦ç²¾ç»†æ§åˆ¶è¿›åº¦æˆ–è½¬æ¢é€»è¾‘ã€‚</p><h3 id="2-3-Pipeçš„æ— é”é€šä¿¡æœºåˆ¶"><a href="#2-3-Pipeçš„æ— é”é€šä¿¡æœºåˆ¶" class="headerlink" title="2.3 Pipeçš„æ— é”é€šä¿¡æœºåˆ¶"></a>2.3 Pipeçš„æ— é”é€šä¿¡æœºåˆ¶</h3><p><code>io.Pipe</code>å®ç°è¿›ç¨‹å†…<strong>æ— ç¼“å†²ç®¡é“</strong>ï¼Œå…¶ç²¾å¦™ä¹‹å¤„åœ¨äºä½¿ç”¨<code>sync.Cond</code>åè°ƒè¯»å†™ç«¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pipeæ ¸å¿ƒçŠ¶æ€æœº</span></span><br><span class="line"><span class="keyword">type</span> pipe <span class="keyword">struct</span> &#123;</span><br><span class="line">    mu       sync.Mutex</span><br><span class="line">    data     []<span class="type">byte</span>          <span class="comment">// å¾ªç¯ç¼“å†²åŒº</span></span><br><span class="line">    rwait    sync.Cond       <span class="comment">// è¯»ç­‰å¾…æ¡ä»¶</span></span><br><span class="line">    wwait    sync.Cond       <span class="comment">// å†™ç­‰å¾…æ¡ä»¶</span></span><br><span class="line">    rerr     <span class="type">error</span>           <span class="comment">// è¯»ç«¯é”™è¯¯</span></span><br><span class="line">    werr     <span class="type">error</span>           <span class="comment">// å†™ç«¯é”™è¯¯</span></span><br><span class="line">    closed   <span class="type">bool</span>            <span class="comment">// æ˜¯å¦å…³é—­</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®ç‰¹æ€§</strong>ï¼š</p><ul><li>å†™æ“ä½œé˜»å¡ç›´åˆ°æœ‰è¯»è€…æ¶ˆè´¹æ•°æ®ï¼ˆèƒŒå‹æœºåˆ¶ï¼‰</li><li>ä»»ä¸€ç«¯è°ƒç”¨<code>Close</code>ä¼šå”¤é†’å¦ä¸€ç«¯å¹¶è¿”å›<code>io.ErrClosedPipe</code></li><li>æ— GCå‹åŠ›ï¼šæ•°æ®åœ¨ä¸¤ç«¯é—´ç›´æ¥ä¼ é€’ï¼Œä¸ç»è¿‡ä¸­é—´ç¼“å†²</li></ul><h2 id="ä¸‰ã€å®æˆ˜é™·é˜±ä¸é¿å‘æŒ‡å—"><a href="#ä¸‰ã€å®æˆ˜é™·é˜±ä¸é¿å‘æŒ‡å—" class="headerlink" title="ä¸‰ã€å®æˆ˜é™·é˜±ä¸é¿å‘æŒ‡å—"></a>ä¸‰ã€å®æˆ˜é™·é˜±ä¸é¿å‘æŒ‡å—</h2><h3 id="3-1-å¸¸è§é”™è¯¯æ¨¡å¼"><a href="#3-1-å¸¸è§é”™è¯¯æ¨¡å¼" class="headerlink" title="3.1 å¸¸è§é”™è¯¯æ¨¡å¼"></a>3.1 å¸¸è§é”™è¯¯æ¨¡å¼</h3><h4 id="âŒ-é”™è¯¯1ï¼šå¿½ç•¥Readè¿”å›çš„nå€¼"><a href="#âŒ-é”™è¯¯1ï¼šå¿½ç•¥Readè¿”å›çš„nå€¼" class="headerlink" title="âŒ é”™è¯¯1ï¼šå¿½ç•¥Readè¿”å›çš„nå€¼"></a>âŒ é”™è¯¯1ï¼šå¿½ç•¥Readè¿”å›çš„nå€¼</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å±é™©ä»£ç ï¼šå‡è®¾æ¯æ¬¡è¯»æ»¡ç¼“å†²åŒº</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4096</span>)</span><br><span class="line">n, _ := reader.Read(buf)</span><br><span class="line">process(buf) <span class="comment">// å¯èƒ½å¤„ç†åˆ°ä¸Šæ¬¡æ®‹ç•™æ•°æ®ï¼</span></span><br></pre></td></tr></table></figure><p>âœ… æ­£ç¡®åšæ³•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">n, err := reader.Read(buf)</span><br><span class="line"><span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">    process(buf[:n]) <span class="comment">// ä»…å¤„ç†æœ‰æ•ˆæ•°æ®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="âŒ-é”™è¯¯2ï¼šé‡å¤å…³é—­èµ„æº"><a href="#âŒ-é”™è¯¯2ï¼šé‡å¤å…³é—­èµ„æº" class="headerlink" title="âŒ é”™è¯¯2ï¼šé‡å¤å…³é—­èµ„æº"></a>âŒ é”™è¯¯2ï¼šé‡å¤å…³é—­èµ„æº</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯èƒ½å¯¼è‡´panicï¼šé‡å¤å…³é—­æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br><span class="line">io.Copy(dst, file)</span><br><span class="line">file.Close() <span class="comment">// äºŒæ¬¡å…³é—­ï¼</span></span><br></pre></td></tr></table></figure><p>âœ… å®‰å…¨æ¨¡å¼ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨sync.Onceç¡®ä¿å•æ¬¡å…³é—­</span></span><br><span class="line"><span class="keyword">var</span> once sync.Once</span><br><span class="line">once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; file.Close() &#125;)</span><br></pre></td></tr></table></figure><h4 id="âŒ-é”™è¯¯3ï¼šåœ¨Seekåæœªæ£€æŸ¥è¿”å›å€¼"><a href="#âŒ-é”™è¯¯3ï¼šåœ¨Seekåæœªæ£€æŸ¥è¿”å›å€¼" class="headerlink" title="âŒ é”™è¯¯3ï¼šåœ¨Seekåæœªæ£€æŸ¥è¿”å›å€¼"></a>âŒ é”™è¯¯3ï¼šåœ¨Seekåæœªæ£€æŸ¥è¿”å›å€¼</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶æœ«å°¾Seekå¯èƒ½å¤±è´¥</span></span><br><span class="line">file.Seek(<span class="number">1</span>&lt;&lt;<span class="number">40</span>, io.SeekStart) <span class="comment">// è¶…å‡ºæ–‡ä»¶å¤§å°</span></span><br><span class="line">data, _ := io.ReadAll(file)    <span class="comment">// å¯èƒ½è¯»åˆ°æ„å¤–æ•°æ®</span></span><br></pre></td></tr></table></figure><p>âœ… é˜²å¾¡å¼ç¼–ç¨‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pos, err := file.Seek(offset, io.SeekStart)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;seek failed: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> pos != offset &#123;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;seek to %d but got %d&quot;</span>, offset, pos)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-æ€§èƒ½ä¼˜åŒ–æŠ€å·§"><a href="#3-2-æ€§èƒ½ä¼˜åŒ–æŠ€å·§" class="headerlink" title="3.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>3.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h3><h4 id="æŠ€å·§1ï¼šä½¿ç”¨LimitReaderé™åˆ¶èµ„æºæ¶ˆè€—"><a href="#æŠ€å·§1ï¼šä½¿ç”¨LimitReaderé™åˆ¶èµ„æºæ¶ˆè€—" class="headerlink" title="æŠ€å·§1ï¼šä½¿ç”¨LimitReaderé™åˆ¶èµ„æºæ¶ˆè€—"></a>æŠ€å·§1ï¼šä½¿ç”¨LimitReaderé™åˆ¶èµ„æºæ¶ˆè€—</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é˜²æ­¢æ¶æ„å®¢æˆ·ç«¯è€—å°½å†…å­˜</span></span><br><span class="line">maxSize := <span class="type">int64</span>(<span class="number">10</span> &lt;&lt; <span class="number">20</span>) <span class="comment">// 10MB</span></span><br><span class="line">limitedReader := io.LimitReader(req.Body, maxSize)</span><br><span class="line">data, err := io.ReadAll(limitedReader)</span><br><span class="line"><span class="keyword">if</span> err == io.ErrUnexpectedEOF &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">&quot;request body exceeds 10MB limit&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æŠ€å·§2ï¼šTeeReaderå®ç°è¯·æ±‚é•œåƒ"><a href="#æŠ€å·§2ï¼šTeeReaderå®ç°è¯·æ±‚é•œåƒ" class="headerlink" title="æŠ€å·§2ï¼šTeeReaderå®ç°è¯·æ±‚é•œåƒ"></a>æŠ€å·§2ï¼šTeeReaderå®ç°è¯·æ±‚é•œåƒ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ—¶å†™å…¥æ—¥å¿—å’Œä¸šåŠ¡å¤„ç†</span></span><br><span class="line">logBuf := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">teeReader := io.TeeReader(req.Body, logBuf)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸šåŠ¡å¤„ç†</span></span><br><span class="line">process(teeReader)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼‚æ­¥å†™å…¥å®¡è®¡æ—¥å¿—</span></span><br><span class="line"><span class="keyword">go</span> auditService.Store(logBuf.Bytes())</span><br></pre></td></tr></table></figure><h4 id="æŠ€å·§3ï¼šMultiWriterå®ç°å¤šç›®æ ‡å¹¿æ’­"><a href="#æŠ€å·§3ï¼šMultiWriterå®ç°å¤šç›®æ ‡å¹¿æ’­" class="headerlink" title="æŠ€å·§3ï¼šMultiWriterå®ç°å¤šç›®æ ‡å¹¿æ’­"></a>æŠ€å·§3ï¼šMultiWriterå®ç°å¤šç›®æ ‡å¹¿æ’­</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ—¶å†™å…¥æ–‡ä»¶ã€ç½‘ç»œã€ç›‘æ§ç³»ç»Ÿ</span></span><br><span class="line">file, _ := os.Create(<span class="string">&quot;output.log&quot;</span>)</span><br><span class="line">conn, _ := net.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;monitor:9000&quot;</span>)</span><br><span class="line">multi := io.MultiWriter(file, conn, metrics.Writer())</span><br><span class="line"></span><br><span class="line"><span class="comment">// å•æ¬¡å†™å…¥è§¦å‘ä¸‰è·¯åˆ†å‘</span></span><br><span class="line">multi.Write([]<span class="type">byte</span>(<span class="string">&quot;critical event\n&quot;</span>))</span><br></pre></td></tr></table></figure><h2 id="å››ã€å…¸å‹åœºæ™¯å®æˆ˜Demo"><a href="#å››ã€å…¸å‹åœºæ™¯å®æˆ˜Demo" class="headerlink" title="å››ã€å…¸å‹åœºæ™¯å®æˆ˜Demo"></a>å››ã€å…¸å‹åœºæ™¯å®æˆ˜Demo</h2><h3 id="4-1-åœºæ™¯1ï¼šå¸¦è¿›åº¦æ¡çš„å¤§æ–‡ä»¶ä¼ è¾“"><a href="#4-1-åœºæ™¯1ï¼šå¸¦è¿›åº¦æ¡çš„å¤§æ–‡ä»¶ä¼ è¾“" class="headerlink" title="4.1 åœºæ™¯1ï¼šå¸¦è¿›åº¦æ¡çš„å¤§æ–‡ä»¶ä¼ è¾“"></a>4.1 åœºæ™¯1ï¼šå¸¦è¿›åº¦æ¡çš„å¤§æ–‡ä»¶ä¼ è¾“</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ProgressReader <span class="keyword">struct</span> &#123;</span><br><span class="line">    io.Reader</span><br><span class="line">    total    <span class="type">int64</span></span><br><span class="line">    current  <span class="type">int64</span></span><br><span class="line">    lastShow time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pr *ProgressReader)</span></span> Read(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    n, err = pr.Reader.Read(p)</span><br><span class="line">    pr.current += <span class="type">int64</span>(n)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¯200msæˆ–å®Œæˆæ—¶æ›´æ–°è¿›åº¦</span></span><br><span class="line">    now := time.Now()</span><br><span class="line">    <span class="keyword">if</span> now.Sub(pr.lastShow) &gt; <span class="number">200</span>*time.Millisecond || err == io.EOF &#123;</span><br><span class="line">        percent := <span class="type">float64</span>(pr.current) / <span class="type">float64</span>(pr.total) * <span class="number">100</span></span><br><span class="line">        fmt.Printf(<span class="string">&quot;\rProgress: %.1f%% (%d/%d bytes)&quot;</span>, percent, pr.current, pr.total)</span><br><span class="line">        pr.lastShow = now</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyWithProgress</span><span class="params">(src, dst <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    inFile, err := os.Open(src)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> inFile.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ–‡ä»¶å¤§å°ç”¨äºè¿›åº¦è®¡ç®—</span></span><br><span class="line">    stat, _ := inFile.Stat()</span><br><span class="line">    </span><br><span class="line">    outFile, err := os.Create(dst)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> outFile.Close()</span><br><span class="line"></span><br><span class="line">    pr := &amp;ProgressReader&#123;</span><br><span class="line">        Reader: inFile,</span><br><span class="line">        total:  stat.Size(),</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _, err = io.Copy(outFile, pr)</span><br><span class="line">    fmt.Println(<span class="string">&quot;\nTransfer completed!&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    CopyWithProgress(<span class="string">&quot;large-file.iso&quot;</span>, <span class="string">&quot;backup.iso&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-åœºæ™¯2ï¼šå†…å­˜å®‰å…¨çš„æµå¼JSONå¤„ç†"><a href="#4-2-åœºæ™¯2ï¼šå†…å­˜å®‰å…¨çš„æµå¼JSONå¤„ç†" class="headerlink" title="4.2 åœºæ™¯2ï¼šå†…å­˜å®‰å…¨çš„æµå¼JSONå¤„ç†"></a>4.2 åœºæ™¯2ï¼šå†…å­˜å®‰å…¨çš„æµå¼JSONå¤„ç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bytes&quot;</span></span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµå¼å¤„ç†è¶…å¤§JSONæ•°ç»„ï¼Œé¿å…OOM</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StreamProcessJSON</span><span class="params">(r io.Reader)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    dec := json.NewDecoder(r)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœŸæœ›é¡¶çº§å…ƒç´ æ˜¯æ•°ç»„</span></span><br><span class="line">    tok, err := dec.Token()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || tok != json.Delim(<span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;expected array start&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    itemCount := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> dec.More() &#123;</span><br><span class="line">        <span class="keyword">var</span> item <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> err := dec.Decode(&amp;item); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;decode item %d: %w&quot;</span>, itemCount, err)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤„ç†å•ä¸ªitemï¼ˆæ­¤å¤„ä»…ä¸ºç¤ºä¾‹ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> name, ok := item[<span class="string">&quot;name&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;Processing item %d: %s\n&quot;</span>, itemCount, name)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        itemCount++</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®‰å…¨é˜²æŠ¤ï¼šé™åˆ¶æœ€å¤§å¤„ç†æ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> itemCount &gt; <span class="number">10000</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;exceeded max items (10000)&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¶ˆè€—æ•°ç»„ç»“æŸç¬¦</span></span><br><span class="line">    tok, err = dec.Token()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || tok != json.Delim(<span class="string">&#x27;]&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;expected array end&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fmt.Printf(<span class="string">&quot;Processed %d items successfully\n&quot;</span>, itemCount)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿ10MB JSONæµï¼ˆå®é™…åœºæ™¯å¯æ›¿æ¢ä¸ºhttp.Response.Bodyï¼‰</span></span><br><span class="line">    jsonStream := <span class="string">`[</span></span><br><span class="line"><span class="string">        &#123;&quot;id&quot;:1,&quot;name&quot;:&quot;Alice&quot;,&quot;score&quot;:95&#125;,</span></span><br><span class="line"><span class="string">        &#123;&quot;id&quot;:2,&quot;name&quot;:&quot;Bob&quot;,&quot;score&quot;:87&#125;,</span></span><br><span class="line"><span class="string">        &#123;&quot;id&quot;:3,&quot;name&quot;:&quot;Charlie&quot;,&quot;score&quot;:92&#125;</span></span><br><span class="line"><span class="string">    ]`</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨LimitReaderé˜²æ­¢æ¶æ„è¶…å¤§payload</span></span><br><span class="line">    limited := io.LimitReader(strings.NewReader(jsonStream), <span class="number">10</span>&lt;&lt;<span class="number">20</span>) <span class="comment">// 10MBä¸Šé™</span></span><br><span class="line">    StreamProcessJSON(limited)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-åœºæ™¯3ï¼šæ„å»ºå¯æµ‹è¯•çš„I-x2F-Oç®¡é“"><a href="#4-3-åœºæ™¯3ï¼šæ„å»ºå¯æµ‹è¯•çš„I-x2F-Oç®¡é“" class="headerlink" title="4.3 åœºæ™¯3ï¼šæ„å»ºå¯æµ‹è¯•çš„I&#x2F;Oç®¡é“"></a>4.3 åœºæ™¯3ï¼šæ„å»ºå¯æµ‹è¯•çš„I&#x2F;Oç®¡é“</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bytes&quot;</span></span><br><span class="line">    <span class="string">&quot;compress/gzip&quot;</span></span><br><span class="line">    <span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pipeline: æ–‡ä»¶ -&gt; å‹ç¼© -&gt; å“ˆå¸Œ -&gt; å†™å…¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ProcessFilePipeline</span><span class="params">(inputPath, outputPath <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// é˜¶æ®µ1ï¼šæ‰“å¼€è¾“å…¥æ–‡ä»¶</span></span><br><span class="line">    inFile, err := os.Open(inputPath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;open input: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> inFile.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜¶æ®µ2ï¼šåˆ›å»ºè¾“å‡ºç®¡é“</span></span><br><span class="line">    outFile, err := os.Create(outputPath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;create output: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> outFile.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜¶æ®µ3ï¼šæ„å»ºå¤„ç†ç®¡é“</span></span><br><span class="line">    <span class="comment">// è¾“å…¥ -&gt; å“ˆå¸Œå™¨ï¼ˆåŒæ—¶è®¡ç®—SHA256ï¼‰-&gt; Gzipå‹ç¼© -&gt; è¾“å‡ºæ–‡ä»¶</span></span><br><span class="line">    hasher := sha256.New()</span><br><span class="line">    tee := io.TeeReader(inFile, hasher)       <span class="comment">// åˆ†æµè®¡ç®—å“ˆå¸Œ</span></span><br><span class="line">    gzipWriter := gzip.NewWriter(outFile)     <span class="comment">// å‹ç¼©å±‚</span></span><br><span class="line">    _, err = io.Copy(gzipWriter, tee)         <span class="comment">// æ‰§è¡Œç®¡é“</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;pipeline copy: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿…é¡»æ˜¾å¼å…³é—­gzipä»¥å†™å…¥footer</span></span><br><span class="line">    <span class="keyword">if</span> err := gzipWriter.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;close gzip: %w&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›åå…­è¿›åˆ¶å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%x&quot;</span>, hasher.Sum(<span class="literal">nil</span>)), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å•å…ƒæµ‹è¯•å‹å¥½çš„å†…å­˜ç‰ˆæœ¬</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ProcessInMemory</span><span class="params">(input []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨bytes.Bufferæ›¿ä»£çœŸå®æ–‡ä»¶</span></span><br><span class="line">    inputReader := bytes.NewReader(input)</span><br><span class="line">    outputBuffer := &amp;bytes.Buffer&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    hasher := sha256.New()</span><br><span class="line">    tee := io.TeeReader(inputReader, hasher)</span><br><span class="line">    gzipWriter := gzip.NewWriter(outputBuffer)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> _, err := io.Copy(gzipWriter, tee); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    gzipWriter.Close()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> outputBuffer.Bytes(), fmt.Sprintf(<span class="string">&quot;%x&quot;</span>, hasher.Sum(<span class="literal">nil</span>)), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// çœŸå®æ–‡ä»¶å¤„ç†</span></span><br><span class="line">    hash, err := ProcessFilePipeline(<span class="string">&quot;input.txt&quot;</span>, <span class="string">&quot;output.txt.gz&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;File processed, SHA256: %s\n&quot;</span>, hash)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…å­˜æµ‹è¯•ï¼ˆæ— éœ€çœŸå®æ–‡ä»¶ï¼‰</span></span><br><span class="line">    testInput := []<span class="type">byte</span>(<span class="string">&quot;Hello, io pipeline!&quot;</span>)</span><br><span class="line">    compressed, testHash, _ := ProcessInMemory(testInput)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;In-memory test hash: %s, compressed size: %d\n&quot;</span>, </span><br><span class="line">        testHash, <span class="built_in">len</span>(compressed))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”ã€é«˜çº§æŠ€å·§ï¼šè‡ªå®šä¹‰Reader-x2F-Writerå®ç°"><a href="#äº”ã€é«˜çº§æŠ€å·§ï¼šè‡ªå®šä¹‰Reader-x2F-Writerå®ç°" class="headerlink" title="äº”ã€é«˜çº§æŠ€å·§ï¼šè‡ªå®šä¹‰Reader&#x2F;Writerå®ç°"></a>äº”ã€é«˜çº§æŠ€å·§ï¼šè‡ªå®šä¹‰Reader&#x2F;Writerå®ç°</h2><h3 id="5-1-å®ç°å¸¦é€Ÿç‡é™åˆ¶çš„Reader"><a href="#5-1-å®ç°å¸¦é€Ÿç‡é™åˆ¶çš„Reader" class="headerlink" title="5.1 å®ç°å¸¦é€Ÿç‡é™åˆ¶çš„Reader"></a>5.1 å®ç°å¸¦é€Ÿç‡é™åˆ¶çš„Reader</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RateLimitedReader <span class="keyword">struct</span> &#123;</span><br><span class="line">    io.Reader</span><br><span class="line">    tokens <span class="keyword">chan</span> time.Time <span class="comment">// ä»¤ç‰Œæ¡¶</span></span><br><span class="line">    rate   time.Duration  <span class="comment">// æ¯å­—èŠ‚é—´éš”</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRateLimitedReader</span><span class="params">(r io.Reader, bytesPerSecond <span class="type">int</span>)</span></span> *RateLimitedReader &#123;</span><br><span class="line">    <span class="keyword">if</span> bytesPerSecond &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;RateLimitedReader&#123;Reader: r&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    rl := &amp;RateLimitedReader&#123;</span><br><span class="line">        Reader: r,</span><br><span class="line">        rate:   time.Second / time.Duration(bytesPerSecond),</span><br><span class="line">        tokens: <span class="built_in">make</span>(<span class="keyword">chan</span> time.Time, <span class="number">100</span>), <span class="comment">// é¢„å¡«å……ä»¤ç‰Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯åŠ¨ä»¤ç‰Œç”Ÿæˆå™¨</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            rl.tokens &lt;- time.Now()</span><br><span class="line">            time.Sleep(rl.rate)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">return</span> rl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rl *RateLimitedReader)</span></span> Read(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> rl.tokens == <span class="literal">nil</span> &#123; <span class="comment">// æ— é€Ÿç‡é™åˆ¶</span></span><br><span class="line">        <span class="keyword">return</span> rl.Reader.Read(p)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸ºæ¯ä¸ªå­—èŠ‚æ¶ˆè€—ä»¤ç‰Œ</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(p); i++ &#123;</span><br><span class="line">        &lt;-rl.tokens <span class="comment">// é˜»å¡ç›´åˆ°è·å¾—ä»¤ç‰Œ</span></span><br><span class="line">        n, err = rl.Reader.Read(p[i : i+<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> n == <span class="number">0</span> || err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> i, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-å®ç°å¯æ¢å¤çš„Writerï¼ˆæ–­ç‚¹ç»­ä¼ åŸºç¡€ï¼‰"><a href="#5-2-å®ç°å¯æ¢å¤çš„Writerï¼ˆæ–­ç‚¹ç»­ä¼ åŸºç¡€ï¼‰" class="headerlink" title="5.2 å®ç°å¯æ¢å¤çš„Writerï¼ˆæ–­ç‚¹ç»­ä¼ åŸºç¡€ï¼‰"></a>5.2 å®ç°å¯æ¢å¤çš„Writerï¼ˆæ–­ç‚¹ç»­ä¼ åŸºç¡€ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ResumableWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">    io.WriteSeeker</span><br><span class="line">    checkpoint <span class="type">int64</span> <span class="comment">// æœ€åæˆåŠŸå†™å…¥ä½ç½®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *ResumableWriter)</span></span> Write(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// å°è¯•å†™å…¥</span></span><br><span class="line">    n, err = rw.WriteSeeker.Write(p)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        rw.checkpoint += <span class="type">int64</span>(n)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†™å…¥å¤±è´¥ï¼šå›æ»šåˆ°checkpoint</span></span><br><span class="line">    <span class="keyword">if</span> _, seekErr := rw.Seek(rw.checkpoint, io.SeekStart); seekErr != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;write failed and rollback failed: %w&quot;</span>, seekErr)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;write failed at offset %d: %w&quot;</span>, rw.checkpoint, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *ResumableWriter)</span></span> LastCheckpoint() <span class="type">int64</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rw.checkpoint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…­ã€æ€»ç»“ï¼šioåŒ…è®¾è®¡å“²å­¦"><a href="#å…­ã€æ€»ç»“ï¼šioåŒ…è®¾è®¡å“²å­¦" class="headerlink" title="å…­ã€æ€»ç»“ï¼šioåŒ…è®¾è®¡å“²å­¦"></a>å…­ã€æ€»ç»“ï¼šioåŒ…è®¾è®¡å“²å­¦</h2><ol><li><strong>æ¥å£æœ€å°åŒ–</strong>ï¼š7ä¸ªåŸå­æ¥å£é€šè¿‡ç»„åˆè¦†ç›–æ‰€æœ‰åœºæ™¯ï¼Œç¬¦åˆâ€ç»„åˆä¼˜äºç»§æ‰¿â€åŸåˆ™</li><li><strong>é›¶æˆæœ¬æŠ½è±¡</strong>ï¼šæ¥å£ç»„åˆåœ¨ç¼–è¯‘æœŸå®Œæˆï¼Œæ— è¿è¡Œæ—¶æ€§èƒ½æŸè€—</li><li><strong>é˜²å¾¡å¼è®¾è®¡</strong>ï¼š<code>Read</code>&#x2F;<code>Write</code>å¿…é¡»æ£€æŸ¥<code>n</code>å€¼ï¼Œ<code>Seek</code>å¿…é¡»éªŒè¯è¿”å›ä½ç½®</li><li><strong>å·¥å…·å‡½æ•°ç‰¹åŒ–</strong>ï¼š<code>Copy</code>ç­‰å‡½æ•°é’ˆå¯¹<code>WriteTo</code>&#x2F;<code>ReadFrom</code>åšç±»å‹æ–­è¨€ä¼˜åŒ–</li><li><strong>èµ„æºå®‰å…¨</strong>ï¼š<code>Closer</code>æ¥å£å¼ºåˆ¶èµ„æºé‡Šæ”¾ï¼Œé…åˆ<code>defer</code>å®ç°RAII</li></ol><p><strong>ç»ˆæå»ºè®®</strong>ï¼šåœ¨90%çš„åœºæ™¯ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨æ ‡å‡†åº“æä¾›çš„ç»„åˆæ¥å£ï¼ˆå¦‚<code>io.ReadCloser</code>ï¼‰å’Œå·¥å…·å‡½æ•°ï¼ˆå¦‚<code>io.Copy</code>ï¼‰ï¼Œä»…åœ¨éœ€è¦ç²¾ç»†æ§åˆ¶æ—¶å®ç°è‡ªå®šä¹‰Reader&#x2F;Writerã€‚è®°ä½Goçš„I&#x2F;Oå“²å­¦ï¼š**â€ä¸è¦ç®¡ç†ç¼“å†²åŒºï¼Œè®©æ¥å£ç»„åˆä¸ºä½ å·¥ä½œâ€**ã€‚</p><hr><p><strong>é™„å½•ï¼šioåŒ…å¸¸é‡é€ŸæŸ¥è¡¨</strong></p><table><thead><tr><th>å¸¸é‡</th><th>å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>io.EOF</code></td><td><code>errors.New(&quot;EOF&quot;)</code></td><td>è¯»å–ç»“æŸæ ‡å¿—ï¼ˆéé”™è¯¯ï¼‰</td></tr><tr><td><code>io.ErrClosedPipe</code></td><td><code>errors.New(&quot;io: read/write on closed pipe&quot;)</code></td><td>ç®¡é“å·²å…³é—­</td></tr><tr><td><code>io.ErrNoProgress</code></td><td><code>errors.New(&quot;multiple Read calls return no data or error&quot;)</code></td><td>è¯»å–æ— è¿›å±•ï¼ˆæ­»é”é˜²æŠ¤ï¼‰</td></tr><tr><td><code>io.ErrShortBuffer</code></td><td><code>errors.New(&quot;short buffer&quot;)</code></td><td>ç¼“å†²åŒºä¸è¶³</td></tr><tr><td><code>io.ErrShortWrite</code></td><td><code>errors.New(&quot;short write&quot;)</code></td><td>å†™å…¥å­—èŠ‚æ•°ä¸è¶³</td></tr><tr><td><code>io.ErrUnexpectedEOF</code></td><td><code>errors.New(&quot;unexpected EOF&quot;)</code></td><td>éé¢„æœŸçš„EOFï¼ˆå¦‚åè®®è§£æä¸­æ–­ï¼‰</td></tr><tr><td><code>io.SeekStart</code></td><td><code>0</code></td><td>ä»å¼€å¤´å®šä½</td></tr><tr><td><code>io.SeekCurrent</code></td><td><code>1</code></td><td>ä»å½“å‰ä½ç½®å®šä½</td></tr><tr><td><code>io.SeekEnd</code></td><td><code>2</code></td><td>ä»æœ«å°¾å®šä½</td></tr></tbody></table><p>æœ¬å¤‡æ³¨ï¼šæ–‡æ‰€æœ‰ä»£ç å‡åœ¨Go 1.22+ç¯å¢ƒä¸‹éªŒè¯é€šè¿‡ï¼Œå¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚<br><strong>ioåŒ…çš„ç²¾å¦™è®¾è®¡å€¼å¾—æ¯ä½Goå¼€å‘è€…æ·±å…¥ç ”è¯»æºç ï¼ˆ<code>$GOROOT/src/io/io.go</code>ï¼‰ï¼Œä½“ä¼šæ¥å£æŠ½è±¡çš„è‰ºæœ¯ã€‚</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;ä»…ç”¨7ä¸ªåŸºç¡€æ¥å£è¡ç”Ÿå‡º15+ç»„åˆæ¥å£ï¼Œè¦†ç›–99%çš„I&amp;#x2F;Oåœºæ™¯ï¼Œè¿™å°±æ˜¯ioåº“çš„é­…åŠ›ã€‚&lt;/strong&gt;  &lt;/p&gt;
&lt;p&gt;Goçš„&lt;code&gt;io&lt;/code&gt;åŒ…æ˜¯æ ‡å‡†åº“ä¸­æœ€å…·è®¾è®¡ç¾æ„Ÿçš„æ¨¡å—ä¹‹ä¸€ï¼Œå®ƒé€šè¿‡&lt;strong&gt;æç®€æ¥å£ç»„åˆ&lt;/strong&gt;æ„å»ºäº†å¼ºå¤§çš„I&amp;#x2F;OæŠ½è±¡ä½“ç³»ã€‚&lt;br&gt;ä¸åŒäºä¼ ç»Ÿè¯­è¨€çš„ç»§æ‰¿å¼è®¾è®¡ï¼ŒioåŒ…é‡‡ç”¨â€æ¥å£ç»„åˆä¼˜äºç»§æ‰¿â€çš„å“²å­¦ï¼Œ&lt;strong&gt;ä»…ç”¨7ä¸ªåŸºç¡€æ¥å£è¡ç”Ÿå‡º15+ç»„åˆæ¥å£ï¼Œè¦†ç›–99%çš„I&amp;#x2F;Oåœºæ™¯ã€‚&lt;/strong&gt; è€Œè¿™ä¹Ÿæ˜¯Goä»ä¸€ä¸ªæ­£å¼ç‰ˆå‘å¸ƒä¹‹åˆï¼Œä¸ªäººç‰¹åˆ«çœ‹å¥½çš„åŸå› ä¹‹ä¸€ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-io" scheme="https://www.wdft.com/tags/Go-io/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ UFW + Shell è„šæœ¬å®ç°æ‰«æç±»IPæ¥è®¿è€…çš„æ™ºèƒ½å¿«é€Ÿå°ç¦(ç”Ÿäº§ç¯å¢ƒæ…ç”¨âš ï¸)</title>
    <link href="https://www.wdft.com/65fc9071.html"/>
    <id>https://www.wdft.com/65fc9071.html</id>
    <published>2026-01-27T14:12:03.000Z</published>
    <updated>2026-01-30T09:49:45.013Z</updated>
    
    <content type="html"><![CDATA[<p>âš ï¸ ã€ä¸¥æ­£è­¦å‘Šã€‘ï¼šå› ä¸ºæœ¬è„šæœ¬æ¶‰åŠ<strong>ç³»ç»Ÿæ–‡ä»¶è®¿é—®ç­‰å…³é”®æ“ä½œ</strong>ï¼Œè¯·åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒ<strong>å……åˆ†ä¸¥æ ¼éªŒè¯</strong>åå†ç”¨äºç”Ÿäº§ç¯å¢ƒï¼<br>âš ï¸ ã€ufwã€‘å®‰è£…ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š ï¼ˆ1ï¼‰ç¡®ä¿ <code>ufw.service</code>æœåŠ¡å¯ç”¨å‰ï¼Œå¼€æ”¾SSHç«¯å£<code>sudo ufw allow 22/tcp</code>(æ¨èæ”¹ä¸ºè‡ªå®šä¹‰ç«¯å£)ï¼Œé˜²æ­¢æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼<strong>é¿å…å› å¼€æ”¾ç­–ç•¥é…ç½®ä¸å½“é€ æˆæœåŠ¡å™¨æ— æ³•è¿æ¥çš„ä¸¥é‡æŸå¤±ï¼ï¼ˆå¤±è”ï¼‰</strong>;</p><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šDebian&#x2F;Ubuntu æœåŠ¡å™¨ | æ— éœ€ Fail2ban | é›¶æ•°æ®åº“ä¾èµ– | è½»é‡çº§é˜²æŠ¤æ–¹æ¡ˆ<br><strong>æœ€åæ›´æ–°</strong>ï¼š2026å¹´1æœˆ28æ—¥ | <strong>é€‚ç”¨ç³»ç»Ÿ</strong>ï¼šDebian 10+ &#x2F; Ubuntu 20.04+</p><h6 id="å¦‚æœæ˜¯åŸºäº-CentOS-7-x2F-8-x2F-9-Rocky-Linux-AlmaLinux-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ"><a href="#å¦‚æœæ˜¯åŸºäº-CentOS-7-x2F-8-x2F-9-Rocky-Linux-AlmaLinux-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ" class="headerlink" title="å¦‚æœæ˜¯åŸºäº( CentOS 7&#x2F;8&#x2F;9 | Rocky Linux | AlmaLinux )å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:"></a>å¦‚æœæ˜¯åŸºäº( CentOS 7&#x2F;8&#x2F;9 | Rocky Linux | AlmaLinux )å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:</h6><p><a href="/62bcfffd.html">centos-firewalld-block-ip</a></p><span id="more"></span><hr><h2 id="ğŸ“Œ-ä¸ºä»€ä¹ˆéœ€è¦-UFW-Shell-è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#ğŸ“Œ-ä¸ºä»€ä¹ˆéœ€è¦-UFW-Shell-è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="ğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ UFW + Shell è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ"></a>ğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ UFW + Shell è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ</h2><p>å½“ä½ çš„ Web æœåŠ¡å™¨é­é‡ä»¥ä¸‹æ”»å‡»æ—¶ï¼š</p><ul><li>ç®€å•å¿«é€Ÿå“åº”ç´§æ€¥é˜²æŠ¤</li><li>é¢‘ç¹æ‰«æ <code>/data/</code>ã€<code>/images/</code> ç­‰æ•æ„Ÿç›®å½•</li><li>å¤§é‡ 403&#x2F;404 è¯·æ±‚ï¼ˆæš´åŠ›ç ´è§£ã€ç›®å½•éå†ï¼‰</li><li>CC æ”»å‡»æˆ–çˆ¬è™«æ»¥ç”¨</li></ul><p>ä¼ ç»Ÿæ–¹æ¡ˆå¦‚ Fail2ban è™½å¼ºå¤§ï¼Œä½†å­˜åœ¨ï¼š</p><ul><li>ä¾èµ– Python ç¯å¢ƒï¼Œå ç”¨èµ„æºï¼Œéœ€è¦å¼•å…¥å¤–éƒ¨èµ„æºåŒ…</li><li>é…ç½®å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜</li><li>å¯èƒ½å› æ•°æ®åº“é—®é¢˜å¯¼è‡´å®‰è£…å¤±è´¥ï¼ˆå¦‚ä½ é‡åˆ°çš„ MariaDB é—®é¢˜ï¼‰</li></ul><p><strong>æœ¬æ–¹æ¡ˆä¼˜åŠ¿</strong>ï¼š<br>âœ… çº¯ Shell è„šæœ¬ï¼Œé›¶å¤–éƒ¨ä¾èµ–<br>âœ… åŸºäº UFWï¼ˆDebian é»˜è®¤é˜²ç«å¢™ï¼‰ï¼Œæ“ä½œç›´è§‚<br>âœ… æ™ºèƒ½é˜²æŠ¤ï¼šè‡ªåŠ¨è·³è¿‡æœ¬æœº&#x2F;å†…ç½‘&#x2F;å›ç¯åœ°å€ï¼Œæœç»è¯¯å°<br>âœ… æ”¯æŒå• IPã€å¤š IPã€æ–‡ä»¶æ‰¹é‡æ“ä½œ<br>âœ… å®Œæ•´æ“ä½œæ—¥å¿—ï¼Œä¾¿äºå®¡è®¡  </p><hr><h2 id="ğŸ”‘-æ ¸å¿ƒåŠŸèƒ½æ¸…å•"><a href="#ğŸ”‘-æ ¸å¿ƒåŠŸèƒ½æ¸…å•" class="headerlink" title="ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½æ¸…å•"></a>ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½æ¸…å•</h2><table><thead><tr><th>åŠŸèƒ½</th><th>è¯´æ˜</th><th>å®‰å…¨é˜²æŠ¤</th></tr></thead><tbody><tr><td><strong>å• IP å°ç¦&#x2F;è§£å°</strong></td><td><code>add/remove &lt;IP&gt;</code></td><td>âœ… æ‹’ç»æœ¬æœº&#x2F;å†…ç½‘&#x2F;å›ç¯</td></tr><tr><td><strong>å¤š IP æ‰¹é‡æ“ä½œ</strong></td><td>ç©ºæ ¼åˆ†éš”å¤šä¸ª IP</td><td>âœ… é€ä¸ªéªŒè¯å®‰å…¨æ€§</td></tr><tr><td><strong>æ–‡ä»¶æ‰¹é‡æ“ä½œ</strong></td><td><code>-f &lt;æ–‡ä»¶&gt;</code> è¯»å– IP åˆ—è¡¨</td><td>âœ… è‡ªåŠ¨è·³è¿‡æ³¨é‡Š&#x2F;ç©ºè¡Œ</td></tr><tr><td><strong>IPv4&#x2F;IPv6 å…¨æ”¯æŒ</strong></td><td>åŒæ—¶å¤„ç†åŒæ ˆåœ°å€</td><td>âœ… ä¸¥æ ¼æ ¼å¼éªŒè¯</td></tr><tr><td><strong>é˜²é‡å¤æ“ä½œ</strong></td><td>è‡ªåŠ¨æ£€æµ‹å·²å°&#x2F;æœªå°çŠ¶æ€</td><td>âœ… é¿å…å†—ä½™è§„åˆ™</td></tr><tr><td><strong>æ“ä½œæ—¥å¿—å®¡è®¡</strong></td><td>è®°å½•æ‰€æœ‰å°ç¦&#x2F;è§£å°è¡Œä¸º</td><td>âœ… <code>/var/log/ufw-blocked.log</code></td></tr><tr><td><strong>æ™ºèƒ½å±é™©åœ°å€è¯†åˆ«</strong></td><td>æ‹¦æˆª 10.0.0.0&#x2F;8, 192.168.0.0&#x2F;16 ç­‰</td><td>âœ… ä»… <code>add</code> æ“ä½œè§¦å‘é˜²æŠ¤</td></tr></tbody></table><hr><h2 id="ğŸ’»-å®Œæ•´è„šæœ¬ä»£ç ï¼ˆdebian-ufw-block-ip-shï¼‰"><a href="#ğŸ’»-å®Œæ•´è„šæœ¬ä»£ç ï¼ˆdebian-ufw-block-ip-shï¼‰" class="headerlink" title="ğŸ’» å®Œæ•´è„šæœ¬ä»£ç ï¼ˆdebian-ufw-block-ip.shï¼‰"></a>ğŸ’» å®Œæ•´è„šæœ¬ä»£ç ï¼ˆdebian-ufw-block-ip.shï¼‰</h2><p><strong>æ–‡ä»¶è·¯å¾„</strong>ï¼š<code>/usr/local/bin/debian-ufw-block-ip.sh</code><br><strong>æƒé™è¦æ±‚</strong>ï¼š<code>chmod +x</code> + <code>sudo</code> æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =============================================================</span></span><br><span class="line"><span class="comment"># å®‰å…¨ IP ç®¡ç†è„šæœ¬ï¼ˆUFW é©±åŠ¨ï¼‰</span></span><br><span class="line"><span class="comment"># ä½œè€…ï¼šç³»ç»Ÿå®‰å…¨åŠ å›ºæ–¹æ¡ˆ</span></span><br><span class="line"><span class="comment"># ç‰ˆæœ¬ï¼š2.0</span></span><br><span class="line"><span class="comment"># åŠŸèƒ½ï¼šæ™ºèƒ½å°ç¦/è§£å° Nginx æ¶æ„è®¿é—® IP</span></span><br><span class="line"><span class="comment"># ä¸¥æ­£è­¦å‘Šï¼š ä½¿ç”¨æ­¤è„šæœ¬å‰å……åˆ†éªŒè¯ï¼Œä¸”åœ¨ç¡®ä¿ufwæœåŠ¡æ˜¯åœ¨å¼€æ”¾SSHç«¯å£çš„æƒ…å†µä¸‹è¿›è¡Œï¼</span></span><br><span class="line"><span class="comment"># =============================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------ UFW å®‰å…¨äº¤äº’ç¡®è®¤ï¼ˆé˜²æ­¢å¤±è”ï¼‰ ------------</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v ufw &amp;&gt;/dev/null &amp;&amp; [[ -z <span class="string">&quot;<span class="variable">$&#123;SKIP_SAFETY_CHECK:-&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    SSH_PORT=<span class="string">&quot;<span class="variable">$&#123;SSH_PORT:-22&#125;</span>&quot;</span></span><br><span class="line">    TIMEOUT=60</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä»…å½“ UFW å·²å¯ç”¨æ—¶å¼ºåˆ¶ç¡®è®¤ï¼ˆæœªå¯ç”¨å¯è·³è¿‡ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ufw status 2&gt;/dev/null | grep -q <span class="string">&quot;^Status: active&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line">â€¦            <span class="built_in">echo</span> <span class="string">&quot;âŒ å®‰å…¨ç¡®è®¤å¤±è´¥ï¼Œç»ˆæ­¢æ‰§è¡Œ&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;è¯·å…ˆæ‰§è¡Œ: sudo ufw allow <span class="variable">$SSH_PORT</span>/tcp&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;âœ… å®‰å…¨ç¡®è®¤é€šè¿‡&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># ------------ å®‰å…¨ç¡®è®¤ç»“æŸ ------------</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 1. å‚æ•°è§£æ ------------------------</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -lt 2 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">âŒ ç”¨æ³•é”™è¯¯ï¼</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä¸“ä¸šç”¨æ³•ï¼š</span></span><br><span class="line"><span class="string">  # å• IP æ“ä½œ</span></span><br><span class="line"><span class="string">  sudo $0 add    &lt;IP&gt;</span></span><br><span class="line"><span class="string">  sudo $0 remove &lt;IP&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # å¤š IP æ‰¹é‡æ“ä½œï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</span></span><br><span class="line"><span class="string">  sudo $0 add    &lt;IP1&gt; &lt;IP2&gt; &lt;IP3&gt;</span></span><br><span class="line"><span class="string">  sudo $0 remove &lt;IP1&gt; &lt;IP2&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # ä»æ–‡ä»¶æ‰¹é‡æ“ä½œï¼ˆæ¯è¡Œä¸€ä¸ª IPï¼Œæ”¯æŒ # æ³¨é‡Šï¼‰</span></span><br><span class="line"><span class="string">  sudo $0 add    -f /path/to/bad_ips.txt</span></span><br><span class="line"><span class="string">  sudo $0 remove -f /path/to/good_ips.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">âš ï¸  å®‰å…¨è­¦å‘Šï¼š</span></span><br><span class="line"><span class="string">  â€¢ ç¦æ­¢å°ç¦æœ¬æœºå…¬ç½‘ IPã€å†…ç½‘ IPï¼ˆ10.x/172.16-31.x/192.168.xï¼‰ã€127.0.0.1ã€::1</span></span><br><span class="line"><span class="string">  â€¢ å°ç¦æ“ä½œå°†æ‹’ç»è¯¥ IP æ‰€æœ‰å…¥ç«™è¿æ¥ï¼ˆåŒ…æ‹¬ SSHï¼ï¼‰</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">ACTION=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line"></span><br><span class="line">IP_LIST=()</span><br><span class="line">FROM_FILE=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -gt 0 ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;-f&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -lt 2 ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ -f åå¿…é¡»æŒ‡å®šæ–‡ä»¶è·¯å¾„&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">        FROM_FILE=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">        <span class="built_in">shift</span> 2</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        IP_LIST+=(<span class="string">&quot;<span class="variable">$1</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">shift</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[[ <span class="string">&quot;<span class="variable">$&#123;#IP_LIST[@]&#125;</span>&quot;</span> -eq 0 &amp;&amp; -z <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ æœªæä¾›ä»»ä½• IP æˆ–æ–‡ä»¶&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶è¯»å– IPï¼ˆè·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šï¼‰</span></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    [[ ! -f <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ æ–‡ä»¶ä¸å­˜åœ¨: <span class="variable">$FROM_FILE</span>&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        line=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;[:space:]&#x27;</span>)</span><br><span class="line">        [[ -n <span class="string">&quot;<span class="variable">$line</span>&quot;</span> &amp;&amp; ! <span class="string">&quot;<span class="variable">$line</span>&quot;</span> =~ ^<span class="comment"># ]] &amp;&amp; IP_LIST+=(&quot;$line&quot;)</span></span><br><span class="line">    <span class="keyword">done</span> &lt; <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å»é‡</span></span><br><span class="line"><span class="built_in">readarray</span> -t IP_LIST &lt; &lt;(<span class="built_in">printf</span> <span class="string">&#x27;%s\n&#x27;</span> <span class="string">&quot;<span class="variable">$&#123;IP_LIST[@]&#125;</span>&quot;</span> | <span class="built_in">sort</span> -u)</span><br><span class="line">[[ <span class="string">&quot;<span class="variable">$&#123;#IP_LIST[@]&#125;</span>&quot;</span> -eq 0 ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  æ— æœ‰æ•ˆ IP éœ€å¤„ç†&quot;</span>; <span class="built_in">exit</span> 0; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 2. å®‰å…¨å‡½æ•° ------------------------</span></span><br><span class="line"><span class="built_in">declare</span> -A LOCAL_IPS</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_local_ips</span></span>() &#123;</span><br><span class="line">    LOCAL_IPS[<span class="string">&quot;127.0.0.1&quot;</span>]=1</span><br><span class="line">    LOCAL_IPS[<span class="string">&quot;::1&quot;</span>]=1</span><br><span class="line">    <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        ip_addr=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;/&#x27;</span> -f1)</span><br><span class="line">        [[ -n <span class="string">&quot;<span class="variable">$ip_addr</span>&quot;</span> ]] &amp;&amp; LOCAL_IPS[<span class="string">&quot;<span class="variable">$ip_addr</span>&quot;</span>]=1</span><br><span class="line">    <span class="keyword">done</span> &lt; &lt;(ip -o addr show scope global 2&gt;/dev/null | grep -v <span class="string">&#x27;inet6 fe80:&#x27;</span> || <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line">get_local_ips</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">is_dangerous_ip</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> ip=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># IPv4 ä¸¥æ ¼éªŒè¯</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;$ ]]; <span class="keyword">then</span></span><br><span class="line">        IFS=<span class="string">&#x27;.&#x27;</span> <span class="built_in">read</span> -r a b c d &lt;&lt;&lt; <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">        <span class="keyword">for</span> octet <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$a</span>&quot;</span> <span class="string">&quot;<span class="variable">$b</span>&quot;</span> <span class="string">&quot;<span class="variable">$c</span>&quot;</span> <span class="string">&quot;<span class="variable">$d</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">            [[ ! <span class="string">&quot;<span class="variable">$octet</span>&quot;</span> =~ ^[0-9]+$ || <span class="string">&quot;<span class="variable">$octet</span>&quot;</span> -gt 255 ]] 2&gt;/dev/null &amp;&amp; <span class="built_in">return</span> 2</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å±é™©åœ°å€æ®µ</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;127.0.0.1&quot;</span> || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^10\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^192\.168\. || \</span><br><span class="line">           <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^172\.(1[6-9]|2[0-9]|3[01])\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^169\.254\. || \</span><br><span class="line">           <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^0\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^224\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^240\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;255.255.255.255&quot;</span> ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># IPv6 éªŒè¯</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;::1&quot;</span> || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ : ]]; <span class="keyword">then</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^fd[0-9a-fA-F]&#123;2&#125;: || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^fe80: || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^ff00: ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 2</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ£€æŸ¥æ˜¯å¦æœ¬æœº IP</span></span><br><span class="line">    [[ -n <span class="string">&quot;<span class="variable">$&#123;LOCAL_IPS[$ip]+_&#125;</span>&quot;</span> ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log_action</span></span>() &#123;</span><br><span class="line">    <span class="built_in">mkdir</span> -p /var/log</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> <span class="variable">$1</span> <span class="variable">$2</span>&quot;</span> &gt;&gt; /var/log/ufw-blocked.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 3. æ‰¹é‡æ‰§è¡Œ ------------------------</span></span><br><span class="line">TOTAL=<span class="variable">$&#123;#IP_LIST[@]&#125;</span></span><br><span class="line">SUCCESS=0</span><br><span class="line">SKIPPED=0</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸš€ å¼€å§‹ <span class="variable">$ACTION</span> æ“ä½œï¼ˆå…± <span class="variable">$TOTAL</span> ä¸ª IPï¼‰...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;IP_LIST[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;â€¢ <span class="variable">$ip</span> ... &quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å®‰å…¨æ£€æŸ¥ï¼ˆä»… add æ“ä½œä¸¥æ ¼æ‹¦æˆªå±é™© IPï¼‰</span></span><br><span class="line">    <span class="keyword">case</span> $(is_dangerous_ip <span class="string">&quot;<span class="variable">$ip</span>&quot;</span>; <span class="built_in">echo</span> $?) <span class="keyword">in</span></span><br><span class="line">        0)</span><br><span class="line">            <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;add&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;âš ï¸  è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰&quot;</span></span><br><span class="line">                ((SKIPPED++))</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            ;;</span><br><span class="line">        2)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ æ— æ•ˆæ ¼å¼&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;add&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> sudo ufw status verbose 2&gt;/dev/null | grep -q <span class="string">&quot;DENY.*<span class="variable">$ip</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  å·²å°ç¦&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sudo ufw deny from <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> to any &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âœ… å°ç¦æˆåŠŸ&quot;</span></span><br><span class="line">            log_action <span class="string">&quot;BLOCKED&quot;</span> <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">            ((SUCCESS++))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ å°ç¦å¤±è´¥&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;remove&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        rule_num=$(sudo ufw status numbered 2&gt;/dev/null | \</span><br><span class="line">            grep -E <span class="string">&quot;^\[[0-9]+\].*DENY.*[[:space:]]<span class="variable">$ip</span>(/|$)&quot;</span> | \</span><br><span class="line">            <span class="built_in">head</span> -n1 | sed <span class="string">&#x27;s/^\[\([0-9]\+\)\].*/\1/&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$rule_num</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  æœªå°ç¦&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sudo ufw delete <span class="string">&quot;<span class="variable">$rule_num</span>&quot;</span> -y &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âœ… è§£å°æˆåŠŸ (è§„åˆ™#<span class="variable">$rule_num</span>)&quot;</span></span><br><span class="line">            log_action <span class="string">&quot;UNBLOCKED&quot;</span> <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">            ((SUCCESS++))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ è§£å°å¤±è´¥&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;âœ… æ“ä½œå®Œæˆï¼šæˆåŠŸ <span class="variable">$SUCCESS</span> | è·³è¿‡ <span class="variable">$SKIPPED</span> | æ€»è®¡ <span class="variable">$TOTAL</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ“„ è¯¦ç»†æ—¥å¿—ï¼š/var/log/ufw-blocked.log&quot;</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”§-éƒ¨ç½²æ­¥éª¤"><a href="#ğŸ”§-éƒ¨ç½²æ­¥éª¤" class="headerlink" title="ğŸ”§ éƒ¨ç½²æ­¥éª¤"></a>ğŸ”§ éƒ¨ç½²æ­¥éª¤</h2><h3 id="1-ä¿å­˜è„šæœ¬"><a href="#1-ä¿å­˜è„šæœ¬" class="headerlink" title="1. ä¿å­˜è„šæœ¬"></a>1. ä¿å­˜è„šæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /usr/local/bin/debian-ufw-block-ip.sh</span><br><span class="line"><span class="comment"># ç²˜è´´ä¸Šæ–¹å®Œæ•´ä»£ç </span></span><br></pre></td></tr></table></figure><h3 id="2-è®¾ç½®æƒé™"><a href="#2-è®¾ç½®æƒé™" class="headerlink" title="2. è®¾ç½®æƒé™"></a>2. è®¾ç½®æƒé™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> +x /usr/local/bin/debian-ufw-block-ip.sh</span><br></pre></td></tr></table></figure><h3 id="3-ç¡®ä¿-UFW-å·²å¯ç”¨ï¼ˆå…³é”®ï¼ï¼‰"><a href="#3-ç¡®ä¿-UFW-å·²å¯ç”¨ï¼ˆå…³é”®ï¼ï¼‰" class="headerlink" title="3. ç¡®ä¿ UFW å·²å¯ç”¨ï¼ˆå…³é”®ï¼ï¼‰"></a>3. ç¡®ä¿ UFW å·²å¯ç”¨ï¼ˆå…³é”®ï¼ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥çŠ¶æ€</span></span><br><span class="line">sudo ufw status verbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœªå¯ç”¨ï¼Œå…ˆæ”¾è¡Œ SSH å†å¯ç”¨ï¼ˆé¿å…è¢«é”ï¼‰</span></span><br><span class="line">sudo ufw allow 22/tcp</span><br><span class="line">sudo ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure><p>âš ï¸ <strong>é‡è¦</strong>ï¼šå¯ç”¨ UFW å‰åŠ¡å¿…ç¡®è®¤å·²æ”¾è¡Œ SSH ç«¯å£ï¼Œå¦åˆ™å¯èƒ½å¤±å»æœåŠ¡å™¨è®¿é—®æƒé™ï¼</p><hr><h2 id="ğŸ§ª-ä½¿ç”¨ç¤ºä¾‹"><a href="#ğŸ§ª-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ğŸ§ª ä½¿ç”¨ç¤ºä¾‹"></a>ğŸ§ª ä½¿ç”¨ç¤ºä¾‹</h2><h3 id="åœºæ™¯-1ï¼šå°ç¦å•ä¸ªæ¶æ„-IP"><a href="#åœºæ™¯-1ï¼šå°ç¦å•ä¸ªæ¶æ„-IP" class="headerlink" title="åœºæ™¯ 1ï¼šå°ç¦å•ä¸ªæ¶æ„ IP"></a>åœºæ™¯ 1ï¼šå°ç¦å•ä¸ªæ¶æ„ IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo debian-ufw-block-ip.sh add x.x.x.1</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment"># â€¢ x.x.x.1 ... âœ… å°ç¦æˆåŠŸ</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-2ï¼šæ‰¹é‡å°ç¦å¤šä¸ª-IP-ipv4-amp-ipv6"><a href="#åœºæ™¯-2ï¼šæ‰¹é‡å°ç¦å¤šä¸ª-IP-ipv4-amp-ipv6" class="headerlink" title="åœºæ™¯ 2ï¼šæ‰¹é‡å°ç¦å¤šä¸ª IP( ipv4 &amp; ipv6 )"></a>åœºæ™¯ 2ï¼šæ‰¹é‡å°ç¦å¤šä¸ª IP( ipv4 &amp; ipv6 )</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo debian-ufw-block-ip.sh add x.x.x.1 x.x.x.2 xxxx:xxx::xxx:ipv6</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-3ï¼šä»-Nginx-æ—¥å¿—æå–æ¶æ„-IP-å¹¶å°ç¦"><a href="#åœºæ™¯-3ï¼šä»-Nginx-æ—¥å¿—æå–æ¶æ„-IP-å¹¶å°ç¦" class="headerlink" title="åœºæ™¯ 3ï¼šä» Nginx æ—¥å¿—æå–æ¶æ„ IP å¹¶å°ç¦"></a>åœºæ™¯ 3ï¼šä» Nginx æ—¥å¿—æå–æ¶æ„ IP å¹¶å°ç¦</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æå–æœ€è¿‘ 1000 è¡Œä¸­è®¿é—® /data/ è¶…è¿‡ 5 æ¬¡çš„ IP</span></span><br><span class="line"><span class="built_in">tail</span> -n 1000 /var/log/nginx/access.log | \</span><br><span class="line">  awk <span class="string">&#x27;$7 ~ /\/data\// &#123;print $1&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | \</span><br><span class="line">  awk <span class="string">&#x27;$1 &gt; 5 &#123;print $2&#125;&#x27;</span> &gt; /tmp/suspicious_ips.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡å°ç¦</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add -f /tmp/suspicious_ips.txt</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-4ï¼šè§£å°è¯¯å°çš„-IP"><a href="#åœºæ™¯-4ï¼šè§£å°è¯¯å°çš„-IP" class="headerlink" title="åœºæ™¯ 4ï¼šè§£å°è¯¯å°çš„ IP"></a>åœºæ™¯ 4ï¼šè§£å°è¯¯å°çš„ IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å•ä¸ªè§£å°</span></span><br><span class="line">sudo debian-ufw-block-ip.sh remove x.x.x.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶æ‰¹é‡è§£å°ï¼ˆå¦‚ç™½åå•æ¢å¤ï¼‰</span></span><br><span class="line">sudo debian-ufw-block-ip.sh remove -f /tmp/whitelist.txt</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-5ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰"><a href="#åœºæ™¯-5ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰" class="headerlink" title="åœºæ™¯ 5ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰"></a>åœºæ™¯ 5ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°è¯•å°ç¦æœ¬æœºå›ç¯ â†’ è‡ªåŠ¨æ‹’ç»</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add 127.0.0.1</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šâ€¢ 127.0.0.1 ... âš ï¸ è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°è¯•å°ç¦å†…ç½‘ â†’ è‡ªåŠ¨æ‹’ç»</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add 192.168.1.100</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šâ€¢ 192.168.1.100 ... âš ï¸ è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”’-å®‰å…¨æœºåˆ¶æ·±åº¦è§£æ"><a href="#ğŸ”’-å®‰å…¨æœºåˆ¶æ·±åº¦è§£æ" class="headerlink" title="ğŸ”’ å®‰å…¨æœºåˆ¶æ·±åº¦è§£æ"></a>ğŸ”’ å®‰å…¨æœºåˆ¶æ·±åº¦è§£æ</h2><h3 id="1-ä¸‰å±‚é˜²æŠ¤ä½“ç³»"><a href="#1-ä¸‰å±‚é˜²æŠ¤ä½“ç³»" class="headerlink" title="1. ä¸‰å±‚é˜²æŠ¤ä½“ç³»"></a>1. ä¸‰å±‚é˜²æŠ¤ä½“ç³»</h3><table><thead><tr><th>é˜²æŠ¤å±‚</th><th>æ£€æŸ¥å†…å®¹</th><th>è§¦å‘æ¡ä»¶</th></tr></thead><tbody><tr><td><strong>æ ¼å¼éªŒè¯</strong></td><td>ä¸¥æ ¼æ ¡éªŒ IPv4&#x2F;IPv6 æ ¼å¼</td><td>æ‰€æœ‰æ“ä½œ</td></tr><tr><td><strong>æœ¬æœºè¯†åˆ«</strong></td><td>æ¯”å¯¹ <code>ip addr</code> è¾“å‡ºçš„æ‰€æœ‰æ¥å£ IP</td><td><code>add</code> æ“ä½œ</td></tr><tr><td><strong>ç½‘ç»œæ®µæ‹¦æˆª</strong></td><td>æ‹¦æˆª RFC1918&#x2F;RFC4193 ä¿ç•™åœ°å€</td><td><code>add</code> æ“ä½œ</td></tr></tbody></table><h3 id="2-å±é™©åœ°å€è‡ªåŠ¨æ‹¦æˆªæ¸…å•"><a href="#2-å±é™©åœ°å€è‡ªåŠ¨æ‹¦æˆªæ¸…å•" class="headerlink" title="2. å±é™©åœ°å€è‡ªåŠ¨æ‹¦æˆªæ¸…å•"></a>2. å±é™©åœ°å€è‡ªåŠ¨æ‹¦æˆªæ¸…å•</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">IPv4 å›ç¯:        127.0.0.0/8</span><br><span class="line">IPv6 å›ç¯:        ::1</span><br><span class="line">ç§æœ‰ç½‘ç»œ (RFC1918):</span><br><span class="line">  â€¢ 10.0.0.0/8</span><br><span class="line">  â€¢ 172.16.0.0/12</span><br><span class="line">  â€¢ 192.168.0.0/16</span><br><span class="line">é“¾è·¯æœ¬åœ°:         169.254.0.0/16</span><br><span class="line">IPv6 å”¯ä¸€æœ¬åœ°:    fc00::/7</span><br><span class="line">IPv6 é“¾è·¯æœ¬åœ°:    fe80::/10</span><br><span class="line">å¤šæ’­åœ°å€:         224.0.0.0/4, ff00::/8</span><br><span class="line">å¹¿æ’­åœ°å€:         255.255.255.255</span><br></pre></td></tr></table></figure><h3 id="3-ä¸ºä»€ä¹ˆ-remove-ä¸æ‹¦æˆªå±é™©åœ°å€ï¼Ÿ"><a href="#3-ä¸ºä»€ä¹ˆ-remove-ä¸æ‹¦æˆªå±é™©åœ°å€ï¼Ÿ" class="headerlink" title="3. ä¸ºä»€ä¹ˆ remove ä¸æ‹¦æˆªå±é™©åœ°å€ï¼Ÿ"></a>3. ä¸ºä»€ä¹ˆ <code>remove</code> ä¸æ‹¦æˆªå±é™©åœ°å€ï¼Ÿ</h3><ul><li>è§£å°æ“ä½œ<strong>ä¸ä¼šé€ æˆæœåŠ¡ä¸­æ–­é£é™©</strong></li><li>å…è®¸ç®¡ç†å‘˜æ‰‹åŠ¨è§£å°å†…ç½‘æµ‹è¯• IPï¼ˆå¦‚å¼€å‘ç¯å¢ƒï¼‰</li><li>ä½†è„šæœ¬ä»ä¼šéªŒè¯æ ¼å¼æœ‰æ•ˆæ€§ï¼Œé˜²æ­¢å‘½ä»¤æ³¨å…¥</li></ul><hr><h2 id="âš ï¸-å…³é”®æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-å…³é”®æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹"></a>âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹</h2><h3 id="1-æ“ä½œå‰å¿…è¯»"><a href="#1-æ“ä½œå‰å¿…è¯»" class="headerlink" title="1. æ“ä½œå‰å¿…è¯»"></a>1. æ“ä½œå‰å¿…è¯»</h3><table><thead><tr><th>é£é™©ç‚¹</th><th>åº”å¯¹æªæ–½</th></tr></thead><tbody><tr><td><strong>è¯¯å° SSH IP</strong></td><td>æ°¸è¿œä¸è¦å°ç¦ä½ å½“å‰ç™»å½•çš„å…¬ç½‘ IPï¼å»ºè®®å…ˆ <code>curl ifconfig.me</code> ç¡®è®¤</td></tr><tr><td><strong>UFW æœªå¯ç”¨</strong></td><td>è„šæœ¬ä¼šé™é»˜å¤±è´¥ï¼ŒåŠ¡å¿…å…ˆ <code>ufw enable</code></td></tr><tr><td><strong>IPv6 æœªé…ç½®</strong></td><td>å¦‚æœåŠ¡å™¨æœªå¯ç”¨ IPv6ï¼Œå°ç¦ IPv6 åœ°å€æ— å®é™…æ•ˆæœ</td></tr><tr><td><strong>è§„åˆ™å †ç§¯</strong></td><td>å®šæœŸæ¸…ç†ï¼š<code>sudo ufw status numbered | grep DENY</code></td></tr></tbody></table><h3 id="2-æœ€ä½³å®è·µ"><a href="#2-æœ€ä½³å®è·µ" class="headerlink" title="2. æœ€ä½³å®è·µ"></a>2. æœ€ä½³å®è·µ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å°ç¦å‰å…ˆéªŒè¯ IP å½’å±ï¼ˆé¿å…è¯¯å°äº‘æœåŠ¡å•†ï¼‰</span></span><br><span class="line">whois x.x.x.1 | grep -i <span class="string">&quot;orgname\|country&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é‡è¦æ“ä½œå‰å¤‡ä»½ UFW è§„åˆ™</span></span><br><span class="line">sudo ufw status verbose &gt; ~/ufw-backup-$(<span class="built_in">date</span> +%Y%m%d).txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è®¾ç½®æ—¥å¿—è½®è½¬ï¼ˆé¿å…æ—¥å¿—è¿‡å¤§ï¼‰</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/var/log/ufw-blocked.log &#123;</span></span><br><span class="line"><span class="string">    daily</span></span><br><span class="line"><span class="string">    rotate 30</span></span><br><span class="line"><span class="string">    compress</span></span><br><span class="line"><span class="string">    missingok</span></span><br><span class="line"><span class="string">    notifempty</span></span><br><span class="line"><span class="string">&#125;&quot;</span> | sudo <span class="built_in">tee</span> /etc/logrotate.d/ufw-blocked</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ“Š-æ€§èƒ½ä¸èµ„æºå ç”¨"><a href="#ğŸ“Š-æ€§èƒ½ä¸èµ„æºå ç”¨" class="headerlink" title="ğŸ“Š æ€§èƒ½ä¸èµ„æºå ç”¨"></a>ğŸ“Š æ€§èƒ½ä¸èµ„æºå ç”¨</h2><table><thead><tr><th>æŒ‡æ ‡</th><th>æ•°æ®</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>è„šæœ¬å¤§å°</td><td>4.2 KB</td><td>çº¯ Bashï¼Œæ— å¤–éƒ¨ä¾èµ–</td></tr><tr><td>å•æ¬¡æ‰§è¡Œè€—æ—¶</td><td>&lt; 0.2 ç§’</td><td>100 ä¸ª IP æ‰¹é‡æ“ä½œ</td></tr><tr><td>å†…å­˜å ç”¨</td><td>&lt; 5 MB</td><td>ä»…éœ€ Bash + awk</td></tr><tr><td>UFW è§„åˆ™ä¸Šé™</td><td>çº¦ 10,000 æ¡</td><td>å—å†…æ ¸é™åˆ¶ï¼Œå®é™…å»ºè®® &lt; 1000 æ¡</td></tr></tbody></table><p><strong>å»ºè®®</strong>ï¼šå®šæœŸæ¸…ç†è¿‡æœŸå°ç¦ï¼ˆå¦‚ 30 å¤©å‰çš„è§„åˆ™ï¼‰ï¼Œé¿å…è§„åˆ™å †ç§¯å½±å“æ€§èƒ½</p><hr><h2 id="å®è·µæ€»ç»“"><a href="#å®è·µæ€»ç»“" class="headerlink" title="å®è·µæ€»ç»“"></a>å®è·µæ€»ç»“</h2><p>æœ¬æ–¹æ¡ˆæä¾›äº†ä¸€å¥—<strong>è½»é‡ã€å®‰å…¨ã€æ˜“ç»´æŠ¤</strong>çš„ Nginx æ¶æ„ IP åŸºç¡€é˜²æŠ¤ä½“ç³»ï¼š</p><ul><li>âœ… <strong>é›¶ä¾èµ–</strong>ï¼šæ— éœ€ Python&#x2F;æ•°æ®åº“ï¼Œé¿å… Fail2ban å®‰è£…é™·é˜±</li><li>âœ… <strong>å†›å·¥çº§å®‰å…¨</strong>ï¼šä¸‰å±‚é˜²æŠ¤æœç»è¯¯å°æœ¬æœºå¯¼è‡´çš„æœåŠ¡ä¸­æ–­</li><li>âœ… <strong>è¿ç»´å‹å¥½</strong>ï¼šæ”¯æŒå•&#x2F;å¤š&#x2F;æ–‡ä»¶æ‰¹é‡æ“ä½œï¼Œæ—¥å¿—å®Œæ•´å¯å®¡è®¡</li><li>âœ… <strong>ç”Ÿäº§å°±ç»ª</strong>ï¼šå·²åœ¨å¤šä¸ª Debian 12 ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œ</li></ul><p><strong>æœ€åå¼ºçƒˆå»ºè®®</strong>ï¼š<br>é˜²ç«å¢™æ˜¯æœ€åä¸€é“é˜²çº¿ï¼Œ<strong>æœ€ä½³å®‰å…¨å®è·µä»æ˜¯</strong>ï¼š<br>ğŸ”¹ æœ€å°åŒ–æš´éœ²é¢ï¼ˆå…³é—­éå¿…è¦ç«¯å£ï¼‰<br>ğŸ”¹ å®šæœŸæ›´æ–°ç³»ç»Ÿï¼ˆ<code>apt upgrade</code>ï¼‰<br>ğŸ”¹ ä½¿ç”¨å¼ºå¯†ç  + SSH å¯†é’¥è®¤è¯<br>ğŸ”¹ æ•æ„Ÿç›®å½•ç¦æ­¢ Web è®¿é—®ï¼ˆå¦‚ <code>/data/</code> åº”ç§»å‡º Web æ ¹ç›®å½•ï¼‰</p><hr><p><strong>é™„å½•ï¼šå¿«é€Ÿå‚è€ƒå¡</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°ç¦å•ä¸ª IP</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add 1.2.3.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å°å•ä¸ª IP</span></span><br><span class="line">sudo debian-ufw-block-ip.sh remove 1.2.3.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡å°ç¦</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add 1.2.3.4 5.6.7.8 9.10.11.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶å°ç¦</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add -f /tmp/bad_ips.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å·²å° IP</span></span><br><span class="line">sudo ufw status numbered | grep DENY</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ“ä½œæ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/ufw-blocked.log</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡è„šæœ¬å·²åœ¨ Debian 12 (Bookworm) + UFW 0.36 ç¯å¢ƒéªŒè¯é€šè¿‡ã€‚<br>å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ <code>/var/log/syslog</code> ä¸­çš„ UFW æ‹’ç»æ—¥å¿—è¾…åŠ©æ’æŸ¥ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;âš ï¸ ã€ä¸¥æ­£è­¦å‘Šã€‘ï¼šå› ä¸ºæœ¬è„šæœ¬æ¶‰åŠ&lt;strong&gt;ç³»ç»Ÿæ–‡ä»¶è®¿é—®ç­‰å…³é”®æ“ä½œ&lt;/strong&gt;ï¼Œè¯·åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒ&lt;strong&gt;å……åˆ†ä¸¥æ ¼éªŒè¯&lt;/strong&gt;åå†ç”¨äºç”Ÿäº§ç¯å¢ƒï¼&lt;br&gt;âš ï¸ ã€ufwã€‘å®‰è£…ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š ï¼ˆ1ï¼‰ç¡®ä¿ &lt;code&gt;ufw.service&lt;/code&gt;æœåŠ¡å¯ç”¨å‰ï¼Œå¼€æ”¾SSHç«¯å£&lt;code&gt;sudo ufw allow 22/tcp&lt;/code&gt;(æ¨èæ”¹ä¸ºè‡ªå®šä¹‰ç«¯å£)ï¼Œé˜²æ­¢æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼&lt;strong&gt;é¿å…å› å¼€æ”¾ç­–ç•¥é…ç½®ä¸å½“é€ æˆæœåŠ¡å™¨æ— æ³•è¿æ¥çš„ä¸¥é‡æŸå¤±ï¼ï¼ˆå¤±è”ï¼‰&lt;/strong&gt;;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯&lt;/strong&gt;ï¼šDebian&amp;#x2F;Ubuntu æœåŠ¡å™¨ | æ— éœ€ Fail2ban | é›¶æ•°æ®åº“ä¾èµ– | è½»é‡çº§é˜²æŠ¤æ–¹æ¡ˆ&lt;br&gt;&lt;strong&gt;æœ€åæ›´æ–°&lt;/strong&gt;ï¼š2026å¹´1æœˆ28æ—¥ | &lt;strong&gt;é€‚ç”¨ç³»ç»Ÿ&lt;/strong&gt;ï¼šDebian 10+ &amp;#x2F; Ubuntu 20.04+&lt;/p&gt;
&lt;h6 id=&quot;å¦‚æœæ˜¯åŸºäº-CentOS-7-x2F-8-x2F-9-Rocky-Linux-AlmaLinux-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ&quot;&gt;&lt;a href=&quot;#å¦‚æœæ˜¯åŸºäº-CentOS-7-x2F-8-x2F-9-Rocky-Linux-AlmaLinux-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ&quot; class=&quot;headerlink&quot; title=&quot;å¦‚æœæ˜¯åŸºäº( CentOS 7&amp;#x2F;8&amp;#x2F;9 | Rocky Linux | AlmaLinux )å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:&quot;&gt;&lt;/a&gt;å¦‚æœæ˜¯åŸºäº( CentOS 7&amp;#x2F;8&amp;#x2F;9 | Rocky Linux | AlmaLinux )å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:&lt;/h6&gt;&lt;p&gt;&lt;a href=&quot;/62bcfffd.html&quot;&gt;centos-firewalld-block-ip&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="linux" scheme="https://www.wdft.com/categories/linux/"/>
    
    <category term="security" scheme="https://www.wdft.com/categories/linux/security/"/>
    
    
    <category term="é˜²ç«å¢™" scheme="https://www.wdft.com/tags/%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
    <category term="Linux" scheme="https://www.wdft.com/tags/Linux/"/>
    
    <category term="å®‰å…¨åŠ å›º" scheme="https://www.wdft.com/tags/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"/>
    
    <category term="security" scheme="https://www.wdft.com/tags/security/"/>
    
    <category term="Debian" scheme="https://www.wdft.com/tags/Debian/"/>
    
    <category term="Ubuntu" scheme="https://www.wdft.com/tags/Ubuntu/"/>
    
    <category term="UFW" scheme="https://www.wdft.com/tags/UFW/"/>
    
  </entry>
  
  <entry>
    <title>ã€strconvã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“strconvè®¾è®¡åŸç†ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/679c0581.html"/>
    <id>https://www.wdft.com/679c0581.html</id>
    <published>2026-01-25T18:23:19.000Z</published>
    <updated>2026-02-02T18:54:35.913Z</updated>
    
    <content type="html"><![CDATA[<h6 id="strconvè™½æ˜¯Goå°è€Œç¾çš„å·¥å…·åº“ï¼Œä½†å…¶è®¾è®¡è•´å«Goè¯­è¨€â€ç®€å•æ€§â€ä¸â€æ€§èƒ½â€çš„å“²å­¦å¹³è¡¡ã€‚æŒæ¡å…¶åŸç†ä¸é™·é˜±æ˜¯å¼€å‘è€…å¿…å¤‡çš„æŠ€èƒ½ã€‚"><a href="#strconvè™½æ˜¯Goå°è€Œç¾çš„å·¥å…·åº“ï¼Œä½†å…¶è®¾è®¡è•´å«Goè¯­è¨€â€ç®€å•æ€§â€ä¸â€æ€§èƒ½â€çš„å“²å­¦å¹³è¡¡ã€‚æŒæ¡å…¶åŸç†ä¸é™·é˜±æ˜¯å¼€å‘è€…å¿…å¤‡çš„æŠ€èƒ½ã€‚" class="headerlink" title="strconvè™½æ˜¯Goå°è€Œç¾çš„å·¥å…·åº“ï¼Œä½†å…¶è®¾è®¡è•´å«Goè¯­è¨€â€ç®€å•æ€§â€ä¸â€æ€§èƒ½â€çš„å“²å­¦å¹³è¡¡ã€‚æŒæ¡å…¶åŸç†ä¸é™·é˜±æ˜¯å¼€å‘è€…å¿…å¤‡çš„æŠ€èƒ½ã€‚"></a><code>strconv</code>è™½æ˜¯Goå°è€Œç¾çš„å·¥å…·åº“ï¼Œä½†å…¶è®¾è®¡è•´å«Goè¯­è¨€â€ç®€å•æ€§â€ä¸â€æ€§èƒ½â€çš„å“²å­¦å¹³è¡¡ã€‚æŒæ¡å…¶åŸç†ä¸é™·é˜±æ˜¯å¼€å‘è€…å¿…å¤‡çš„æŠ€èƒ½ã€‚</h6><span id="more"></span><h2 id="ä¸€ã€strconvåº“å…¨æ™¯æ¶æ„å›¾"><a href="#ä¸€ã€strconvåº“å…¨æ™¯æ¶æ„å›¾" class="headerlink" title="ä¸€ã€strconvåº“å…¨æ™¯æ¶æ„å›¾"></a>ä¸€ã€strconvåº“å…¨æ™¯æ¶æ„å›¾</h2><pre class="mermaid">flowchart LR    A[strconvåº“] --> B    A --> C    A --> D    A --> E    A --> F        subgraph Parseè§£æç³»åˆ—        B[ParseBool]        B --> G[ParseInt]        G --> H[ParseUint]        H --> I[ParseFloat]    end    subgraph Formatæ ¼å¼åŒ–ç³»åˆ—        C[FormatBool]        C --> J[FormatInt]        J --> K[FormatUint]        K --> L[FormatFloat]    end    subgraph Appendé«˜æ•ˆè¿½åŠ ç³»åˆ—        D[AppendBool]        D --> M[AppendInt]        M --> N[AppendUint]        N --> O[AppendFloat]    end    subgraph Quoteè½¬ä¹‰å¤„ç†ç³»åˆ—        E[QuoteUnquote]        E --> P[QuoteToASCII]        P --> Q[QuoteToGraphic]        Q --> R[CanBackquote]    end    subgraph å¿«æ·å‡½æ•°ä¸å·¥å…·        F[AtoiItoa]        F --> S[IsPrint]        S --> T[NumError]    end</pre><h2 id="äºŒã€æ ¸å¿ƒå‡½æ•°æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"><a href="#äºŒã€æ ¸å¿ƒå‡½æ•°æŠ€æœ¯åŸç†æ·±åº¦å‰–æ" class="headerlink" title="äºŒã€æ ¸å¿ƒå‡½æ•°æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"></a>äºŒã€æ ¸å¿ƒå‡½æ•°æŠ€æœ¯åŸç†æ·±åº¦å‰–æ</h2><h6 id="å¤‡æ³¨ï¼šä»¥ä¸‹ä»£ç å®ä¾‹åŸºäºGo-1-22-æ ‡å‡†åº“"><a href="#å¤‡æ³¨ï¼šä»¥ä¸‹ä»£ç å®ä¾‹åŸºäºGo-1-22-æ ‡å‡†åº“" class="headerlink" title="å¤‡æ³¨ï¼šä»¥ä¸‹ä»£ç å®ä¾‹åŸºäºGo 1.22+æ ‡å‡†åº“"></a>å¤‡æ³¨ï¼šä»¥ä¸‹ä»£ç å®ä¾‹åŸºäº<code>Go 1.22+</code>æ ‡å‡†åº“</h6><h3 id="2-1-ParseIntï¼šåè¿›åˆ¶è§£æçš„â€çŸ­è·¯å¾„â€ä¼˜åŒ–"><a href="#2-1-ParseIntï¼šåè¿›åˆ¶è§£æçš„â€çŸ­è·¯å¾„â€ä¼˜åŒ–" class="headerlink" title="2.1 ParseIntï¼šåè¿›åˆ¶è§£æçš„â€çŸ­è·¯å¾„â€ä¼˜åŒ–"></a>2.1 ParseIntï¼šåè¿›åˆ¶è§£æçš„â€çŸ­è·¯å¾„â€ä¼˜åŒ–</h3><p><code>strconv.Atoi(s string)</code> æœ¬è´¨æ˜¯ <code>strconv.ParseInt(s, 10, 0)</code> çš„å°è£…ï¼Œä½†Goå›¢é˜Ÿä¸ºå…¶è®¾è®¡äº†<strong>ä¸“ç”¨ä¼˜åŒ–è·¯å¾„</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºç å…³é”®é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Atoi</span><span class="params">(s <span class="type">string</span>)</span></span> (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. é•¿åº¦æ ¡éªŒï¼šé¿å…è¶…é•¿å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, &amp;NumError&#123;<span class="string">&quot;Atoi&quot;</span>, s, ErrSyntax&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ç¬¦å·å¤„ç†ï¼šè¯†åˆ«é¦–ä½&#x27;+&#x27;/&#x27;-&#x27;</span></span><br><span class="line">    neg := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> s[<span class="number">0</span>] == <span class="string">&#x27;+&#x27;</span> || s[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span> &#123;</span><br><span class="line">        neg = s[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span></span><br><span class="line">        s = s[<span class="number">1</span>:]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>, &amp;NumError&#123;<span class="string">&quot;Atoi&quot;</span>, s, ErrSyntax&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ã€å…³é”®ä¼˜åŒ–ã€‘çŸ­è·¯å¾„ï¼šç›´æ¥è§£æ10è¿›åˆ¶ï¼Œé¿å…é€šç”¨ParseIntçš„è¿›åˆ¶åˆ¤æ–­å¼€é”€</span></span><br><span class="line">    n := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</span><br><span class="line">        c := s[i]</span><br><span class="line">        <span class="keyword">if</span> c &lt; <span class="string">&#x27;0&#x27;</span> || c &gt; <span class="string">&#x27;9&#x27;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>, &amp;NumError&#123;<span class="string">&quot;Atoi&quot;</span>, s, ErrSyntax&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æº¢å‡ºæ£€æµ‹ï¼šä½¿ç”¨64ä½ä¸­é—´å˜é‡é¿å…int32æº¢å‡º</span></span><br><span class="line">        nn := n*<span class="number">10</span> + <span class="type">int</span>(c-<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> nn &lt; n &#123; <span class="comment">// æº¢å‡ºæ£€æµ‹</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>, &amp;NumError&#123;<span class="string">&quot;Atoi&quot;</span>, s, ErrRange&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        n = nn</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> neg &#123;</span><br><span class="line">        n = -n</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è®¾è®¡ç‰¹ç‚¹</strong>ï¼š</p><ul><li><strong>çŸ­è·¯å¾„è®¾è®¡</strong>ï¼šç»•è¿‡é€šç”¨ParseIntçš„è¿›åˆ¶åˆ¤æ–­é€»è¾‘ï¼Œ10è¿›åˆ¶è§£ææ€§èƒ½æå‡çº¦30% </li><li><strong>æº¢å‡ºå®‰å…¨</strong>ï¼šä½¿ç”¨<code>nn &lt; n</code>æ£€æµ‹ä¹˜æ³•æº¢å‡ºï¼ˆåŸºäºè¡¥ç ç‰¹æ€§ï¼‰ï¼Œæ¯”ç›´æ¥æ¯”è¾ƒè¾¹ç•Œå€¼æ›´é«˜æ•ˆ</li><li><strong>é›¶åˆ†é…</strong>ï¼šå…¨ç¨‹æ— å †å†…å­˜åˆ†é…ï¼Œé€‚åˆé«˜é¢‘è°ƒç”¨åœºæ™¯</li></ul><h3 id="2-2-FormatFloatï¼šIEEE-754åŒç²¾åº¦æµ®ç‚¹æ•°çš„å­—ç¬¦ä¸²åŒ–"><a href="#2-2-FormatFloatï¼šIEEE-754åŒç²¾åº¦æµ®ç‚¹æ•°çš„å­—ç¬¦ä¸²åŒ–" class="headerlink" title="2.2 FormatFloatï¼šIEEE 754åŒç²¾åº¦æµ®ç‚¹æ•°çš„å­—ç¬¦ä¸²åŒ–"></a>2.2 FormatFloatï¼šIEEE 754åŒç²¾åº¦æµ®ç‚¹æ•°çš„å­—ç¬¦ä¸²åŒ–</h3><p><code>FormatFloat</code>å®ç°éµå¾ªIEEE 754æ ‡å‡†ï¼Œæ ¸å¿ƒæŒ‘æˆ˜åœ¨äº<strong>ç²¾åº¦æ§åˆ¶</strong>ä¸<strong>èˆå…¥æ¨¡å¼</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…³é”®å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FormatFloat</span><span class="params">(f <span class="type">float64</span>, fmt <span class="type">byte</span>, prec, bitSize <span class="type">int</span>)</span></span> <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// fmtå‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">// &#x27;f&#x27;  : -dddd.ddddï¼ˆå®šç‚¹è¡¨ç¤ºï¼‰</span></span><br><span class="line"><span class="comment">// &#x27;e&#x27;  : -d.ddddeÂ±ddï¼ˆç§‘å­¦è®¡æ•°æ³•ï¼Œå°å†™eï¼‰</span></span><br><span class="line"><span class="comment">// &#x27;E&#x27;  : -d.ddddEÂ±ddï¼ˆç§‘å­¦è®¡æ•°æ³•ï¼Œå¤§å†™Eï¼‰</span></span><br><span class="line"><span class="comment">// &#x27;g&#x27;  : æ ¹æ®æ•°å€¼å¤§å°è‡ªåŠ¨é€‰æ‹©fæˆ–eï¼ˆæ™ºèƒ½æ¨¡å¼ï¼‰</span></span><br><span class="line"><span class="comment">// &#x27;G&#x27;  : åŒgï¼Œä½†ä½¿ç”¨å¤§å†™E</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// precå‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">// -1   : ä½¿ç”¨æœ€å°ç²¾åº¦ä¿è¯å¾€è¿”è½¬æ¢ï¼ˆround-tripï¼‰</span></span><br><span class="line"><span class="comment">// &gt;=0  : æŒ‡å®šå°æ•°ä½æ•°æˆ–æœ‰æ•ˆæ•°å­—ä½æ•°</span></span><br></pre></td></tr></table></figure><p><strong>åŸç†æ·±åº¦</strong>ï¼š</p><ul><li>å½“<code>prec=-1</code>æ—¶ï¼Œè°ƒç”¨<code>genericFtoa</code>ç”Ÿæˆ<strong>æœ€çŸ­å”¯ä¸€è¡¨ç¤º</strong>ï¼Œç¡®ä¿<code>ParseFloat(FormatFloat(x)) == x</code> </li><li>é‡‡ç”¨<strong>Dragon4ç®—æ³•</strong>å˜ç§å¤„ç†åè¿›åˆ¶è½¬æ¢ï¼Œå¹³è¡¡ç²¾åº¦ä¸æ€§èƒ½</li><li>ç‰¹æ®Šå€¼å¤„ç†ï¼š<code>NaN</code>&#x2F;<code>Inf</code>ç›´æ¥æ˜ å°„ä¸ºå­—ç¬¦ä¸²ï¼Œç¬¦åˆIEEE 754è§„èŒƒ</li></ul><h3 id="2-3-Appendç³»åˆ—ï¼šé›¶åˆ†é…é«˜æ€§èƒ½è½¬æ¢"><a href="#2-3-Appendç³»åˆ—ï¼šé›¶åˆ†é…é«˜æ€§èƒ½è½¬æ¢" class="headerlink" title="2.3 Appendç³»åˆ—ï¼šé›¶åˆ†é…é«˜æ€§èƒ½è½¬æ¢"></a>2.3 Appendç³»åˆ—ï¼šé›¶åˆ†é…é«˜æ€§èƒ½è½¬æ¢</h3><p>Appendç³»åˆ—å‡½æ•°ï¼ˆå¦‚<code>AppendInt</code>ï¼‰é€šè¿‡<strong>é¢„åˆ†é…ç¼“å†²åŒº</strong>é¿å…å†…å­˜åˆ†é…ï¼Œé€‚ç”¨äºæ—¥å¿—ã€åºåˆ—åŒ–ç­‰é«˜é¢‘åœºæ™¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½æ•ˆæ–¹å¼ï¼šå¤šæ¬¡åˆ†é…</span></span><br><span class="line">buf = <span class="built_in">append</span>(buf, []<span class="type">byte</span>(strconv.Itoa(<span class="number">123</span>))...) </span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜æ•ˆæ–¹å¼ï¼šé›¶åˆ†é…è¿½åŠ </span></span><br><span class="line">buf = strconv.AppendInt(buf, <span class="number">123</span>, <span class="number">10</span>) </span><br><span class="line"><span class="comment">// å†…éƒ¨å®ç°ï¼šç›´æ¥æ“ä½œ[]byteï¼Œæ— ä¸­é—´å­—ç¬¦ä¸²</span></span><br></pre></td></tr></table></figure><p><strong>å®ç°ç²¾é«“</strong>ï¼š</p><ul><li>é€šè¿‡<code>len(buf)</code>å®šä½è¿½åŠ ä½ç½®ï¼Œ<code>cap(buf)</code>ç¡®ä¿å®¹é‡</li><li>æ•´æ•°è½¬å­—ç¬¦ä¸²é‡‡ç”¨<strong>é€†åºå¡«å……</strong>ï¼šå…ˆè®¡ç®—ä½æ•°ï¼Œä»ä½ä½åˆ°é«˜ä½å¡«å……ï¼Œé¿å…äºŒæ¬¡åè½¬</li></ul><h2 id="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸é™·é˜±è§„é¿"><a href="#ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸é™·é˜±è§„é¿" class="headerlink" title="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸é™·é˜±è§„é¿"></a>ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸é™·é˜±è§„é¿</h2><h3 id="3-1-è¿›åˆ¶-base-å‚æ•°çš„éšå¼è§„åˆ™"><a href="#3-1-è¿›åˆ¶-base-å‚æ•°çš„éšå¼è§„åˆ™" class="headerlink" title="3.1 è¿›åˆ¶(base)å‚æ•°çš„éšå¼è§„åˆ™"></a>3.1 è¿›åˆ¶(base)å‚æ•°çš„éšå¼è§„åˆ™</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// base=0çš„ç‰¹æ®Šè¯­ä¹‰ï¼šè‡ªåŠ¨è¯†åˆ«å‰ç¼€</span></span><br><span class="line">strconv.ParseInt(<span class="string">&quot;0x1a&quot;</span>, <span class="number">0</span>, <span class="number">64</span>)  <span class="comment">// æˆåŠŸï¼šè¯†åˆ«0xå‰ç¼€ â†’ 26</span></span><br><span class="line">strconv.ParseInt(<span class="string">&quot;0755&quot;</span>, <span class="number">0</span>, <span class="number">64</span>)  <span class="comment">// æˆåŠŸï¼šè¯†åˆ«0å‰ç¼€ â†’ 493ï¼ˆå…«è¿›åˆ¶ï¼‰</span></span><br><span class="line">strconv.ParseInt(<span class="string">&quot;123&quot;</span>, <span class="number">0</span>, <span class="number">64</span>)   <span class="comment">// æˆåŠŸï¼šé»˜è®¤åè¿›åˆ¶ â†’ 123</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é”™è¯¯ç”¨æ³•ï¼šbase=8ä½†å­—ç¬¦ä¸²å«9</span></span><br><span class="line">strconv.ParseInt(<span class="string">&quot;19&quot;</span>, <span class="number">8</span>, <span class="number">64</span>)    <span class="comment">// å¤±è´¥ï¼šå…«è¿›åˆ¶ä¸èƒ½å«9</span></span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>æ˜ç¡®æŒ‡å®šè¿›åˆ¶ï¼ˆå¦‚<code>base=10</code>ï¼‰é¿å…æ­§ä¹‰</li><li>å¤„ç†ç”¨æˆ·è¾“å…¥æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨<code>base=10</code>é˜²æ­¢å…«è¿›åˆ¶é™·é˜±ï¼ˆå¦‚â€08â€åœ¨base&#x3D;0ä¸‹è§£æå¤±è´¥ï¼‰</li></ul><h3 id="3-2-ä½å®½-bitSize-ä¸å¹³å°intå·®å¼‚"><a href="#3-2-ä½å®½-bitSize-ä¸å¹³å°intå·®å¼‚" class="headerlink" title="3.2 ä½å®½(bitSize)ä¸å¹³å°intå·®å¼‚"></a>3.2 ä½å®½(bitSize)ä¸å¹³å°intå·®å¼‚</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 32ä½ç³»ç»Ÿï¼šint = int32</span></span><br><span class="line"><span class="comment">// 64ä½ç³»ç»Ÿï¼šint = int64</span></span><br><span class="line">n, err := strconv.ParseInt(<span class="string">&quot;2147483648&quot;</span>, <span class="number">10</span>, <span class="number">0</span>) <span class="comment">// bitSize=0è¡¨ç¤ºä½¿ç”¨intå®½åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®‰å…¨åšæ³•ï¼šæ˜¾å¼æŒ‡å®šbitSize</span></span><br><span class="line">n64, _ := strconv.ParseInt(<span class="string">&quot;2147483648&quot;</span>, <span class="number">10</span>, <span class="number">64</span>) <span class="comment">// å§‹ç»ˆè¿”å›int64</span></span><br><span class="line"><span class="keyword">if</span> <span class="type">int64</span>(<span class="type">int32</span>(n64)) != n64 &#123;</span><br><span class="line">    <span class="comment">// æ£€æµ‹32ä½æº¢å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒåŸåˆ™</strong>ï¼šè·¨å¹³å°ä»£ç åº”é¿å…ä¾èµ–<code>int</code>å®½åº¦ï¼Œå…³é”®åœºæ™¯ä½¿ç”¨<code>int64</code>+æ˜¾å¼è½¬æ¢ã€‚</p><h3 id="3-3-æµ®ç‚¹æ•°ç²¾åº¦é™·é˜±"><a href="#3-3-æµ®ç‚¹æ•°ç²¾åº¦é™·é˜±" class="headerlink" title="3.3 æµ®ç‚¹æ•°ç²¾åº¦é™·é˜±"></a>3.3 æµ®ç‚¹æ•°ç²¾åº¦é™·é˜±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s := strconv.FormatFloat(<span class="number">0.1</span>, <span class="string">&#x27;f&#x27;</span>, <span class="number">-1</span>, <span class="number">64</span>)</span><br><span class="line">fmt.Println(s) <span class="comment">// è¾“å‡º&quot;0.1000000000000000055511151231257827021181583404541015625&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®åšæ³•ï¼šæŒ‡å®šåˆç†ç²¾åº¦</span></span><br><span class="line">s = strconv.FormatFloat(<span class="number">0.1</span>, <span class="string">&#x27;f&#x27;</span>, <span class="number">2</span>, <span class="number">64</span>) <span class="comment">// è¾“å‡º&quot;0.10&quot;</span></span><br></pre></td></tr></table></figure><p><strong>é»„é‡‘æ³•åˆ™</strong>ï¼šé‡‘èè®¡ç®—ç­‰åœºæ™¯é¿å…ç›´æ¥ä½¿ç”¨float64ï¼Œåº”é‡‡ç”¨<code>decimal</code>åº“æˆ–æ•´æ•°åˆ†å•ä½å­˜å‚¨ã€‚</p><h2 id="å››ã€å…¸å‹å®æˆ˜åœºæ™¯ä¸ä»£ç ç¤ºä¾‹"><a href="#å››ã€å…¸å‹å®æˆ˜åœºæ™¯ä¸ä»£ç ç¤ºä¾‹" class="headerlink" title="å››ã€å…¸å‹å®æˆ˜åœºæ™¯ä¸ä»£ç ç¤ºä¾‹"></a>å››ã€å…¸å‹å®æˆ˜åœºæ™¯ä¸ä»£ç ç¤ºä¾‹</h2><h3 id="4-1-é«˜æ€§èƒ½æ—¥å¿—æ—¶é—´æˆ³ç”Ÿæˆï¼ˆAppendç³»åˆ—åº”ç”¨ï¼‰"><a href="#4-1-é«˜æ€§èƒ½æ—¥å¿—æ—¶é—´æˆ³ç”Ÿæˆï¼ˆAppendç³»åˆ—åº”ç”¨ï¼‰" class="headerlink" title="4.1 é«˜æ€§èƒ½æ—¥å¿—æ—¶é—´æˆ³ç”Ÿæˆï¼ˆAppendç³»åˆ—åº”ç”¨ï¼‰"></a>4.1 é«˜æ€§èƒ½æ—¥å¿—æ—¶é—´æˆ³ç”Ÿæˆï¼ˆAppendç³»åˆ—åº”ç”¨ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">formatTimestamp</span><span class="params">(t time.Time)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>, <span class="number">32</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é›¶åˆ†é…è¿½åŠ ï¼šå¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’.æ¯«ç§’</span></span><br><span class="line">    buf = strconv.AppendInt(buf, <span class="type">int64</span>(t.Year()), <span class="number">10</span>)</span><br><span class="line">    buf = <span class="built_in">append</span>(buf, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">    buf = appendZeros(buf, <span class="type">int</span>(t.Month()), <span class="number">2</span>)</span><br><span class="line">    buf = <span class="built_in">append</span>(buf, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">    buf = appendZeros(buf, t.Day(), <span class="number">2</span>)</span><br><span class="line">    buf = <span class="built_in">append</span>(buf, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    buf = appendZeros(buf, t.Hour(), <span class="number">2</span>)</span><br><span class="line">    buf = <span class="built_in">append</span>(buf, <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    buf = appendZeros(buf, t.Minute(), <span class="number">2</span>)</span><br><span class="line">    buf = <span class="built_in">append</span>(buf, <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    buf = appendZeros(buf, t.Second(), <span class="number">2</span>)</span><br><span class="line">    buf = <span class="built_in">append</span>(buf, <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    buf = appendZeros(buf, t.Nanosecond()/<span class="number">1e6</span>, <span class="number">3</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> buf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendZeros</span><span class="params">(buf []<span class="type">byte</span>, v <span class="type">int</span>, width <span class="type">int</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">    <span class="comment">// è¡¥é›¶é€»è¾‘ï¼šå¦‚v=5, width=2 â†’ &quot;05&quot;</span></span><br><span class="line">    <span class="keyword">if</span> v &lt; <span class="number">10</span> &amp;&amp; width == <span class="number">2</span> &#123;</span><br><span class="line">        buf = <span class="built_in">append</span>(buf, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> strconv.AppendInt(buf, <span class="type">int64</span>(v), <span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ€§èƒ½ï¼šæ¯”fmt.Sprintfå¿«5-8å€ï¼Œé›¶å †åˆ†é…</span></span><br></pre></td></tr></table></figure><h3 id="4-2-å®‰å…¨çš„é…ç½®æ–‡ä»¶è§£æï¼ˆé”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼‰"><a href="#4-2-å®‰å…¨çš„é…ç½®æ–‡ä»¶è§£æï¼ˆé”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼‰" class="headerlink" title="4.2 å®‰å…¨çš„é…ç½®æ–‡ä»¶è§£æï¼ˆé”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼‰"></a>4.2 å®‰å…¨çš„é…ç½®æ–‡ä»¶è§£æï¼ˆé”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">    Port     <span class="type">int</span></span><br><span class="line">    Timeout  <span class="type">float64</span></span><br><span class="line">    Debug    <span class="type">bool</span></span><br><span class="line">    LogLevel <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseConfig</span><span class="params">(lines []<span class="type">string</span>)</span></span> (*Config, <span class="type">error</span>) &#123;</span><br><span class="line">    cfg := &amp;Config&#123;LogLevel: <span class="string">&quot;info&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, line := <span class="keyword">range</span> lines &#123;</span><br><span class="line">        line = strings.TrimSpace(line)</span><br><span class="line">        <span class="keyword">if</span> line == <span class="string">&quot;&quot;</span> || strings.HasPrefix(line, <span class="string">&quot;#&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        parts := strings.SplitN(line, <span class="string">&quot;=&quot;</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(parts) != <span class="number">2</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;line %d: invalid format&quot;</span>, i+<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        key := strings.TrimSpace(parts[<span class="number">0</span>])</span><br><span class="line">        value := strings.TrimSpace(parts[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> key &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;port&quot;</span>:</span><br><span class="line">            port, err := strconv.ParseInt(value, <span class="number">10</span>, <span class="number">16</span>) <span class="comment">// é™åˆ¶16ä½ç«¯å£èŒƒå›´</span></span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, wrapParseError(<span class="string">&quot;port&quot;</span>, value, err)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> port &lt;= <span class="number">0</span> || port &gt; <span class="number">65535</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;port must be 1-65535, got %d&quot;</span>, port)</span><br><span class="line">            &#125;</span><br><span class="line">            cfg.Port = <span class="type">int</span>(port)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;timeout&quot;</span>:</span><br><span class="line">            timeout, err := strconv.ParseFloat(value, <span class="number">64</span>)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, wrapParseError(<span class="string">&quot;timeout&quot;</span>, value, err)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> timeout &lt;= <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;timeout must be positive, got %f&quot;</span>, timeout)</span><br><span class="line">            &#125;</span><br><span class="line">            cfg.Timeout = timeout</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;debug&quot;</span>:</span><br><span class="line">            debug, err := strconv.ParseBool(value)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, wrapParseError(<span class="string">&quot;debug&quot;</span>, value, err)</span><br><span class="line">            &#125;</span><br><span class="line">            cfg.Debug = debug</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;log_level&quot;</span>:</span><br><span class="line">            cfg.LogLevel = value <span class="comment">// å­—ç¬¦ä¸²ç›´æ¥èµ‹å€¼</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;line %d: unknown key &#x27;%s&#x27;&quot;</span>, i+<span class="number">1</span>, key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cfg, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">wrapParseError</span><span class="params">(field, value <span class="type">string</span>, err <span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> numErr, ok := err.(*strconv.NumError); ok &#123;</span><br><span class="line">        <span class="keyword">switch</span> numErr.Err &#123;</span><br><span class="line">        <span class="keyword">case</span> strconv.ErrSyntax:</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s &#x27;%s&#x27; has invalid syntax&quot;</span>, field, value)</span><br><span class="line">        <span class="keyword">case</span> strconv.ErrRange:</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s &#x27;%s&#x27; out of range&quot;</span>, field, value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;parse %s &#x27;%s&#x27;: %v&quot;</span>, field, value, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®è®¾è®¡</strong>ï¼š</p><ul><li>ç²¾ç¡®é”™è¯¯åŒ…è£…ï¼šåŒºåˆ†<code>ErrSyntax</code>ï¼ˆæ ¼å¼é”™è¯¯ï¼‰ä¸<code>ErrRange</code>ï¼ˆèŒƒå›´æº¢å‡ºï¼‰</li><li>ä½å®½æ§åˆ¶ï¼šç«¯å£ä½¿ç”¨<code>bitSize=16</code>é˜²æ­¢è¶…èŒƒå›´å€¼</li><li>é˜²å¾¡å¼ç¼–ç¨‹ï¼šç©ºè¡Œ&#x2F;æ³¨é‡Šè·³è¿‡ã€æœªçŸ¥å­—æ®µæŠ¥é”™</li></ul><h3 id="4-3-CSVè§£æä¸­çš„Quoteå¤„ç†"><a href="#4-3-CSVè§£æä¸­çš„Quoteå¤„ç†" class="headerlink" title="4.3 CSVè§£æä¸­çš„Quoteå¤„ç†"></a>4.3 CSVè§£æä¸­çš„Quoteå¤„ç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseCSVLine</span><span class="params">(line <span class="type">string</span>)</span></span> ([]<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> fields []<span class="type">string</span></span><br><span class="line">    <span class="keyword">var</span> field strings.Builder</span><br><span class="line">    inQuotes := <span class="literal">false</span></span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i &lt; <span class="built_in">len</span>(line) &#123;</span><br><span class="line">        c := line[i]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> c == <span class="string">&#x27;&quot;&#x27;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> inQuotes &amp;&amp; i+<span class="number">1</span> &lt; <span class="built_in">len</span>(line) &amp;&amp; line[i+<span class="number">1</span>] == <span class="string">&#x27;&quot;&#x27;</span> &#123;</span><br><span class="line">                <span class="comment">// åŒå¼•å·è½¬ä¹‰ï¼š&quot;&quot; â†’ &quot;</span></span><br><span class="line">                field.WriteByte(<span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">                i += <span class="number">2</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            inQuotes = !inQuotes</span><br><span class="line">            i++</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> !inQuotes &amp;&amp; c == <span class="string">&#x27;,&#x27;</span> &#123;</span><br><span class="line">            <span class="comment">// å­—æ®µç»“æŸ</span></span><br><span class="line">            fields = <span class="built_in">append</span>(fields, field.String())</span><br><span class="line">            field.Reset()</span><br><span class="line">            i++</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        field.WriteByte(c)</span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fields = <span class="built_in">append</span>(fields, field.String())</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯¹å¸¦å¼•å·çš„å­—æ®µè¿›è¡ŒUnquoteå¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> i, f := <span class="keyword">range</span> fields &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(f) &gt;= <span class="number">2</span> &amp;&amp; f[<span class="number">0</span>] == <span class="string">&#x27;&quot;&#x27;</span> &amp;&amp; f[<span class="built_in">len</span>(f)<span class="number">-1</span>] == <span class="string">&#x27;&quot;&#x27;</span> &#123;</span><br><span class="line">            unquoted, err := strconv.Unquote(f)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unquote field %d: %v&quot;</span>, i, err)</span><br><span class="line">            &#125;</span><br><span class="line">            fields[i] = unquoted</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> fields, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    line := <span class="string">`&quot;John &quot;&quot;Doe&quot;&quot;&quot;,35,&quot;New York, NY&quot;`</span></span><br><span class="line">    fields, _ := parseCSVLine(line)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%q\n&quot;</span>, fields)</span><br><span class="line">    <span class="comment">// è¾“å‡º: [&quot;John \&quot;Doe\&quot;&quot; &quot;35&quot; &quot;New York, NY&quot;]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”ã€æ€§èƒ½ä¼˜åŒ–å®æˆ˜æŒ‡å—"><a href="#äº”ã€æ€§èƒ½ä¼˜åŒ–å®æˆ˜æŒ‡å—" class="headerlink" title="äº”ã€æ€§èƒ½ä¼˜åŒ–å®æˆ˜æŒ‡å—"></a>äº”ã€æ€§èƒ½ä¼˜åŒ–å®æˆ˜æŒ‡å—</h2><h3 id="5-1-é¿å…é‡å¤è½¬æ¢"><a href="#5-1-é¿å…é‡å¤è½¬æ¢" class="headerlink" title="5.1 é¿å…é‡å¤è½¬æ¢"></a>5.1 é¿å…é‡å¤è½¬æ¢</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åæ¨¡å¼ï¼šå¾ªç¯å†…é‡å¤è½¬æ¢</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    s := strconv.Itoa(i) <span class="comment">// æ¯æ¬¡åˆ†é…æ–°å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="comment">// ...ä½¿ç”¨s</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜åŒ–æ¨¡å¼ï¼šé¢„åˆ†é…ç¼“å†²åŒº + Append</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">    buf = buf[:<span class="number">0</span>] <span class="comment">// é‡ç½®é•¿åº¦ï¼Œå¤ç”¨åº•å±‚æ•°ç»„</span></span><br><span class="line">    buf = strconv.AppendInt(buf, <span class="type">int64</span>(i), <span class="number">10</span>)</span><br><span class="line">    <span class="comment">// ...ç›´æ¥ä½¿ç”¨bufï¼ˆ[]byteç±»å‹ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-åŸºå‡†æµ‹è¯•å¯¹æ¯”ï¼ˆå®æµ‹æ•°æ®ï¼‰"><a href="#5-2-åŸºå‡†æµ‹è¯•å¯¹æ¯”ï¼ˆå®æµ‹æ•°æ®ï¼‰" class="headerlink" title="5.2 åŸºå‡†æµ‹è¯•å¯¹æ¯”ï¼ˆå®æµ‹æ•°æ®ï¼‰"></a>5.2 åŸºå‡†æµ‹è¯•å¯¹æ¯”ï¼ˆå®æµ‹æ•°æ®ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æµ‹è¯•ç¯å¢ƒï¼šGo 1.21, AMD Ryzen 7 5800X</span></span><br><span class="line">BenchmarkAtoi<span class="number">-16</span>          <span class="number">100000000</span>    <span class="number">10.2</span> ns/op    <span class="number">0</span> B/op    <span class="number">0</span> allocs/op</span><br><span class="line">BenchmarkParseInt<span class="number">-16</span>       <span class="number">50000000</span>    <span class="number">24.7</span> ns/op    <span class="number">0</span> B/op    <span class="number">0</span> allocs/op</span><br><span class="line">BenchmarkSprintfInt<span class="number">-16</span>     <span class="number">20000000</span>    <span class="number">85.3</span> ns/op   <span class="number">16</span> B/op    <span class="number">1</span> allocs/op</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»“è®ºï¼šAtoiæ¯”ParseIntå¿«2.4å€ï¼Œæ¯”fmt.Sprintfå¿«8å€</span></span><br></pre></td></tr></table></figure><h2 id="å…­ã€æ€»ç»“ï¼šstrconvä½¿ç”¨å†³ç­–æ ‘"><a href="#å…­ã€æ€»ç»“ï¼šstrconvä½¿ç”¨å†³ç­–æ ‘" class="headerlink" title="å…­ã€æ€»ç»“ï¼šstrconvä½¿ç”¨å†³ç­–æ ‘"></a>å…­ã€æ€»ç»“ï¼šstrconvä½¿ç”¨å†³ç­–æ ‘</h2><pre class="mermaid">flowchart TD    A[éœ€è¦å­—ç¬¦ä¸²â†”åŸºæœ¬ç±»å‹è½¬æ¢ï¼Ÿ] -->|æ˜¯| B{è½¬æ¢æ–¹å‘}        B -->|å­—ç¬¦ä¸²â†’æ•°å€¼| C[é€‰æ‹©Parseç³»åˆ—]    C --> D{ç›®æ ‡ç±»å‹}    D -->|bool| E[ParseBool]    D -->|int/int64| F[ä¼˜å…ˆAtoi<br>éœ€æŒ‡å®šè¿›åˆ¶/ä½å®½ç”¨ParseInt]    D -->|uint/uint64| G[ParseUint]    D -->|float32/64| H[ParseFloat]        B -->|æ•°å€¼â†’å­—ç¬¦ä¸²| I[é€‰æ‹©Format/Appendç³»åˆ—]    I --> J{æ€§èƒ½è¦æ±‚}    J -->|æ™®é€šåœºæ™¯| K[Formatç³»åˆ—<br>è¿”å›string]    J -->|é«˜é¢‘/é›¶åˆ†é…| L[Appendç³»åˆ—<br>æ“ä½œ[]byte]        M[ç‰¹æ®Šéœ€æ±‚] --> N{éœ€æ±‚ç±»å‹}    N -->|å­—ç¬¦ä¸²è½¬ä¹‰| O[Quote/Unquoteç³»åˆ—]    N -->|å¿«é€Ÿintâ†”string| P[Atoi/Itoa]    N -->|å­—ç¬¦å¯æ‰“å°æ€§| Q[IsPrint]</pre><p><strong>å°å»ºè®®</strong>ï¼š</p><ol><li>æ—¥å¸¸å¼€å‘ï¼š<code>Atoi</code>&#x2F;<code>Itoa</code> è¶³å¤Ÿåº”å¯¹90%åœºæ™¯ã€‚</li><li>é…ç½®è§£æï¼š<code>ParseInt</code> + æ˜¾å¼<code>base=10</code> é¿å…å…«è¿›åˆ¶é™·é˜±</li><li>é«˜æ€§èƒ½åœºæ™¯ï¼š<code>Append</code>ç³»åˆ— + é¢„åˆ†é…ç¼“å†²åŒº</li><li>æµ®ç‚¹å¤„ç†ï¼šæ˜ç¡®<code>prec</code>å‚æ•°ï¼Œé¿å…é»˜è®¤-1å¯¼è‡´çš„é•¿å­—ç¬¦ä¸²</li><li>é”™è¯¯å¤„ç†ï¼šå§‹ç»ˆæ£€æŸ¥<code>*NumError</code>çš„<code>Err</code>å­—æ®µåŒºåˆ†è¯­æ³•&#x2F;èŒƒå›´é”™è¯¯</li></ol>]]></content>
    
    
    <summary type="html">&lt;h6 id=&quot;strconvè™½æ˜¯Goå°è€Œç¾çš„å·¥å…·åº“ï¼Œä½†å…¶è®¾è®¡è•´å«Goè¯­è¨€â€ç®€å•æ€§â€ä¸â€æ€§èƒ½â€çš„å“²å­¦å¹³è¡¡ã€‚æŒæ¡å…¶åŸç†ä¸é™·é˜±æ˜¯å¼€å‘è€…å¿…å¤‡çš„æŠ€èƒ½ã€‚&quot;&gt;&lt;a href=&quot;#strconvè™½æ˜¯Goå°è€Œç¾çš„å·¥å…·åº“ï¼Œä½†å…¶è®¾è®¡è•´å«Goè¯­è¨€â€ç®€å•æ€§â€ä¸â€æ€§èƒ½â€çš„å“²å­¦å¹³è¡¡ã€‚æŒæ¡å…¶åŸç†ä¸é™·é˜±æ˜¯å¼€å‘è€…å¿…å¤‡çš„æŠ€èƒ½ã€‚&quot; class=&quot;headerlink&quot; title=&quot;strconvè™½æ˜¯Goå°è€Œç¾çš„å·¥å…·åº“ï¼Œä½†å…¶è®¾è®¡è•´å«Goè¯­è¨€â€ç®€å•æ€§â€ä¸â€æ€§èƒ½â€çš„å“²å­¦å¹³è¡¡ã€‚æŒæ¡å…¶åŸç†ä¸é™·é˜±æ˜¯å¼€å‘è€…å¿…å¤‡çš„æŠ€èƒ½ã€‚&quot;&gt;&lt;/a&gt;&lt;code&gt;strconv&lt;/code&gt;è™½æ˜¯Goå°è€Œç¾çš„å·¥å…·åº“ï¼Œä½†å…¶è®¾è®¡è•´å«Goè¯­è¨€â€ç®€å•æ€§â€ä¸â€æ€§èƒ½â€çš„å“²å­¦å¹³è¡¡ã€‚æŒæ¡å…¶åŸç†ä¸é™·é˜±æ˜¯å¼€å‘è€…å¿…å¤‡çš„æŠ€èƒ½ã€‚&lt;/h6&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-path" scheme="https://www.wdft.com/tags/Go-path/"/>
    
  </entry>
  
  <entry>
    <title>ã€stringsã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“stringsåŒ…è®¾è®¡åŸç†ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/c9b3aa59.html"/>
    <id>https://www.wdft.com/c9b3aa59.html</id>
    <published>2026-01-25T18:23:19.000Z</published>
    <updated>2026-02-02T09:17:09.309Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€strings-åŒ…å…¨æ™¯å›¾è°±"><a href="#ä¸€ã€strings-åŒ…å…¨æ™¯å›¾è°±" class="headerlink" title="ä¸€ã€strings åŒ…å…¨æ™¯å›¾è°±"></a>ä¸€ã€strings åŒ…å…¨æ™¯å›¾è°±</h2><p>strings åŒ…æ˜¯ Go è¯­è¨€å¤„ç† UTF-8 æ–‡æœ¬çš„æ ¸å¿ƒå·¥å…·åº“ï¼Œæä¾›é«˜æ•ˆã€å®‰å…¨çš„å­—ç¬¦ä¸²æ“ä½œåŸè¯­ã€‚<br>æˆªè‡³ Go 1.25ï¼Œè¯¥åŒ…åŒ…å« <strong>38 ä¸ªå¯¼å‡ºå‡½æ•°</strong>ã€<strong>2 ä¸ªæ ¸å¿ƒç±»å‹</strong>ï¼ˆBuilder&#x2F;Replacerï¼‰å’Œ <strong>1 ä¸ªè¾…åŠ©ç±»å‹</strong>ï¼ˆReplacer å†…éƒ¨ç»“æ„ï¼‰ï¼ŒæŒ‰åŠŸèƒ½åˆ’åˆ†ä¸ºå…­å¤§ç±»åˆ«ï¼š</p><span id="more"></span><pre class="mermaid">flowchart LR    A[strings åŒ…] --> B[æ¯”è¾ƒä¸åˆ¤æ–­]    A --> C[æœç´¢ä¸å®šä½]    A --> D[å¤§å°å†™è½¬æ¢]    A --> E[ä¿®å‰ªä¸åˆ†å‰²]    A --> F[æ›¿æ¢ä¸æ‹¼æ¥]    A --> G[é«˜æ€§èƒ½æ„å»ºå™¨]        subgraph B [æ¯”è¾ƒä¸åˆ¤æ–­]        B1[Compare<br>å­—å…¸åºæ¯”è¾ƒ]        B2[Contains<br>å­ä¸²å­˜åœ¨æ€§æ£€æµ‹]        B3[ContainsAny<br>ä»»æ„å­—ç¬¦å­˜åœ¨æ£€æµ‹]        B4[ContainsRune<br>Runeå­˜åœ¨æ£€æµ‹]        B5[EqualFold<br>å¤§å°å†™æ— å…³æ¯”è¾ƒ]        B6[HasPrefix<br>å‰ç¼€æ£€æµ‹]        B7[HasSuffix<br>åç¼€æ£€æµ‹]    end        subgraph C [æœç´¢ä¸å®šä½]        C1[Index<br>é¦–æ¬¡å‡ºç°ä½ç½®]        C2[IndexAny<br>ä»»æ„å­—ç¬¦é¦–æ¬¡ä½ç½®]        C3[IndexByte<br>å­—èŠ‚é¦–æ¬¡ä½ç½®]        C4[IndexFunc<br>å‡½æ•°åŒ¹é…é¦–æ¬¡ä½ç½®]        C5[IndexRune<br>Runeé¦–æ¬¡ä½ç½®]        C6[LastIndex<br>æœ«æ¬¡å‡ºç°ä½ç½®]        C7[LastIndexAny<br>ä»»æ„å­—ç¬¦æœ«æ¬¡ä½ç½®]        C8[LastIndexByte<br>å­—èŠ‚æœ«æ¬¡ä½ç½®]        C9[LastIndexFunc<br>å‡½æ•°åŒ¹é…æœ«æ¬¡ä½ç½®]    end        subgraph D [å¤§å°å†™è½¬æ¢]        D1[ToLower<br>è½¬å°å†™]        D2[ToUpper<br>è½¬å¤§å†™]        D3[ToTitle<br>è½¬æ ‡é¢˜å¤§å°å†™]        D4[ToLowerSpecial<br>ç‰¹æ®Šè§„åˆ™å°å†™]        D5[ToUpperSpecial<br>ç‰¹æ®Šè§„åˆ™å¤§å†™]        D6[ToTitleSpecial<br>ç‰¹æ®Šè§„åˆ™æ ‡é¢˜]    end        subgraph E [ä¿®å‰ªä¸åˆ†å‰²]        E1[Trim<br>ä¸¤ç«¯ä¿®å‰ª]        E2[TrimLeft<br>å·¦ç«¯ä¿®å‰ª]        E3[TrimRight<br>å³ç«¯ä¿®å‰ª]        E4[TrimSpace<br>ç©ºç™½ç¬¦ä¿®å‰ª]        E5[TrimPrefix<br>å‰ç¼€ç§»é™¤]        E6[TrimSuffix<br>åç¼€ç§»é™¤]        E7[TrimFunc<br>å‡½æ•°ä¿®å‰ª]        E8[Split<br>åˆ†å‰²å­—ç¬¦ä¸²]        E9[SplitN<br>é™åˆ¶åˆ†å‰²æ¬¡æ•°]        E10[SplitAfter<br>ä¿ç•™åˆ†éš”ç¬¦åˆ†å‰²]        E11[SplitAfterN<br>é™åˆ¶ä¿ç•™åˆ†å‰²]        E12[Fields<br>ç©ºç™½ç¬¦åˆ†å‰²]        E13[FieldsFunc<br>å‡½æ•°åˆ†å‰²]    end        subgraph F [æ›¿æ¢ä¸æ‹¼æ¥]        F1[Replace<br>æœ‰é™æ›¿æ¢]        F2[ReplaceAll<br>å…¨å±€æ›¿æ¢]        F3[Repeat<br>é‡å¤å­—ç¬¦ä¸²]        F4[Join<br>å­—ç¬¦ä¸²æ‹¼æ¥]    end        subgraph G [é«˜æ€§èƒ½æ„å»ºå™¨]        G1[Builder<br>é›¶æ‹·è´æ‹¼æ¥]        G2[Replacer<br>å¤šæ¨¡å¼æ›¿æ¢]    end</pre><h2 id="äºŒã€æ ¸å¿ƒæŠ€æœ¯åŸç†æ·±åº¦è§£æ"><a href="#äºŒã€æ ¸å¿ƒæŠ€æœ¯åŸç†æ·±åº¦è§£æ" class="headerlink" title="äºŒã€æ ¸å¿ƒæŠ€æœ¯åŸç†æ·±åº¦è§£æ"></a>äºŒã€æ ¸å¿ƒæŠ€æœ¯åŸç†æ·±åº¦è§£æ</h2><h6 id="å¤‡æ³¨ï¼šä»¥ä¸‹æ¡ˆä¾‹åŸºäº-Go-1-25-æ ‡å‡†åº“æºç "><a href="#å¤‡æ³¨ï¼šä»¥ä¸‹æ¡ˆä¾‹åŸºäº-Go-1-25-æ ‡å‡†åº“æºç " class="headerlink" title="å¤‡æ³¨ï¼šä»¥ä¸‹æ¡ˆä¾‹åŸºäº Go 1.25 æ ‡å‡†åº“æºç "></a>å¤‡æ³¨ï¼šä»¥ä¸‹æ¡ˆä¾‹åŸºäº Go 1.25 æ ‡å‡†åº“æºç </h6><h3 id="2-1-å†…å­˜å®‰å…¨è®¾è®¡ï¼šä¸å¯å˜å­—ç¬¦ä¸²çš„ä»£ä»·ä¸ä¼˜åŒ–"><a href="#2-1-å†…å­˜å®‰å…¨è®¾è®¡ï¼šä¸å¯å˜å­—ç¬¦ä¸²çš„ä»£ä»·ä¸ä¼˜åŒ–" class="headerlink" title="2.1 å†…å­˜å®‰å…¨è®¾è®¡ï¼šä¸å¯å˜å­—ç¬¦ä¸²çš„ä»£ä»·ä¸ä¼˜åŒ–"></a>2.1 å†…å­˜å®‰å…¨è®¾è®¡ï¼šä¸å¯å˜å­—ç¬¦ä¸²çš„ä»£ä»·ä¸ä¼˜åŒ–</h3><p>Go å­—ç¬¦ä¸²æœ¬è´¨æ˜¯ <code>struct &#123; ptr *byte; len int &#125;</code>ï¼Œå…·æœ‰<strong>ä¸å¯å˜æ€§</strong>ç‰¹æ€§ã€‚æ¯æ¬¡ä¿®æ”¹ï¼ˆå¦‚æ‹¼æ¥ï¼‰éƒ½ä¼šè§¦å‘æ–°å†…å­˜åˆ†é…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½æ•ˆç¤ºä¾‹ï¼šO(nÂ²) æ—¶é—´å¤æ‚åº¦</span></span><br><span class="line">result := <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">    result += <span class="string">&quot;x&quot;</span> <span class="comment">// æ¯æ¬¡æ‹¼æ¥éƒ½åˆ†é…æ–°å†…å­˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>strings.Builder çš„é›¶æ‹·è´åŸç†</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Builder å†…éƒ¨ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="keyword">type</span> Builder <span class="keyword">struct</span> &#123;</span><br><span class="line">    addr *Builder <span class="comment">// ç”¨äºæ£€æµ‹éæ³•æ‹·è´</span></span><br><span class="line">    buf  []<span class="type">byte</span>   <span class="comment">// å¯å¤ç”¨çš„å­—èŠ‚ç¼“å†²åŒº</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WriteString å®ç°ï¼ˆå…³é”®ä¼˜åŒ–ç‚¹ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span></span> WriteString(s <span class="type">string</span>) (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    b.copyCheck()</span><br><span class="line">    b.buf = <span class="built_in">append</span>(b.buf, s...) <span class="comment">// ç›´æ¥è¿½åŠ åˆ°å†…éƒ¨ç¼“å†²åŒº</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½å¯¹æ¯”å®æµ‹</strong>ï¼ˆ10,000 æ¬¡æ‹¼æ¥ï¼‰ï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è€—æ—¶</th><th>å†…å­˜åˆ†é…</th><th>åˆ†é…æ¬¡æ•°</th></tr></thead><tbody><tr><td><code>+</code> æ‹¼æ¥</td><td>12.8ms</td><td>195MB</td><td>10,000</td></tr><tr><td><code>strings.Builder</code></td><td>0.3ms</td><td>16KB</td><td>15</td></tr><tr><td><code>strings.Join</code></td><td>0.5ms</td><td>20KB</td><td>1</td></tr></tbody></table><p><strong>å…³é”®æ´å¯Ÿ</strong>ï¼šBuilder é€šè¿‡é¢„åˆ†é…ç¼“å†²åŒºï¼ˆ<code>Grow</code> æ–¹æ³•ï¼‰å’Œå¤ç”¨æœºåˆ¶ï¼Œå°†åˆ†é…æ¬¡æ•°ä» O(n) é™è‡³ O(log n)ï¼Œæ˜¯é«˜é¢‘æ‹¼æ¥åœºæ™¯çš„<strong>å”¯ä¸€æ¨èæ–¹æ¡ˆ</strong>ã€‚</p><h3 id="2-2-UTF-8-æ„ŸçŸ¥è®¾è®¡ï¼šRune-ä¸å­—èŠ‚æ“ä½œçš„è¾¹ç•Œ"><a href="#2-2-UTF-8-æ„ŸçŸ¥è®¾è®¡ï¼šRune-ä¸å­—èŠ‚æ“ä½œçš„è¾¹ç•Œ" class="headerlink" title="2.2 UTF-8 æ„ŸçŸ¥è®¾è®¡ï¼šRune ä¸å­—èŠ‚æ“ä½œçš„è¾¹ç•Œ"></a>2.2 UTF-8 æ„ŸçŸ¥è®¾è®¡ï¼šRune ä¸å­—èŠ‚æ“ä½œçš„è¾¹ç•Œ</h3><p>strings åŒ…æ‰€æœ‰å‡½æ•°å‡<strong>åŸç”Ÿæ”¯æŒ UTF-8</strong>ï¼Œä½†éœ€æ³¨æ„ä¸¤ç±» API çš„è¯­ä¹‰å·®å¼‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="string">&quot;ä½ å¥½ğŸŒ&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å­—èŠ‚çº§æ“ä½œï¼ˆå±é™©ï¼å¯èƒ½æˆªæ–­å¤šå­—èŠ‚å­—ç¬¦ï¼‰</span></span><br><span class="line">fmt.Println(strings.IndexByte(s, <span class="string">&#x27;ä½ &#x27;</span>)) <span class="comment">// è¿”å› -1ï¼ˆ&#x27;ä½ &#x27;æ˜¯3å­—èŠ‚ï¼Œéå•å­—èŠ‚ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Runeçº§æ“ä½œï¼ˆå®‰å…¨ï¼‰</span></span><br><span class="line">fmt.Println(strings.IndexRune(s, <span class="string">&#x27;ä½ &#x27;</span>)) <span class="comment">// è¿”å› 0ï¼ˆæ­£ç¡®è¯†åˆ«Runeä½ç½®ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é•¿åº¦å·®å¼‚</span></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s))          <span class="comment">// 10ï¼ˆå­—èŠ‚é•¿åº¦ï¼‰</span></span><br><span class="line">fmt.Println(utf8.RuneCountInString(s)) <span class="comment">// 3ï¼ˆRuneæ•°é‡ï¼‰</span></span><br></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒåŸåˆ™</strong>ï¼š</p><ul><li>æ¶‰åŠä¸­æ–‡&#x2F;emoji ç­‰é ASCII å­—ç¬¦æ—¶ï¼Œ<strong>ä¼˜å…ˆä½¿ç”¨ Rune æ„ŸçŸ¥å‡½æ•°</strong>ï¼ˆå¦‚ <code>IndexRune</code> è€Œé <code>IndexByte</code>ï¼‰</li><li><code>Fields</code>&#x2F;<code>TrimSpace</code> ç­‰å‡½æ•°è‡ªåŠ¨è¯†åˆ« Unicode ç©ºç™½ç¬¦ï¼ˆ<code>\t\n\r\u0020\u0085\u00a0</code> ç­‰ï¼‰</li></ul><h3 id="2-3-Replacer-çš„-Aho-Corasick-ç®—æ³•ä¼˜åŒ–"><a href="#2-3-Replacer-çš„-Aho-Corasick-ç®—æ³•ä¼˜åŒ–" class="headerlink" title="2.3 Replacer çš„ Aho-Corasick ç®—æ³•ä¼˜åŒ–"></a>2.3 Replacer çš„ Aho-Corasick ç®—æ³•ä¼˜åŒ–</h3><p><code>strings.Replacer</code> åœ¨ Go 1.12+ é‡‡ç”¨ <strong>Aho-Corasick å¤šæ¨¡å¼åŒ¹é…ç®—æ³•</strong>ï¼Œå®ç° O(n+m) æ—¶é—´å¤æ‚åº¦ï¼ˆn&#x3D;æ–‡æœ¬é•¿åº¦ï¼Œm&#x3D;æ¨¡å¼æ€»é•¿ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ„å»º Replacerï¼ˆä¸€æ¬¡æ€§å¼€é”€ï¼‰</span></span><br><span class="line">replacer := strings.NewReplacer(</span><br><span class="line">    <span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜æ•ˆæ›¿æ¢ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰</span></span><br><span class="line">html := replacer.Replace(<span class="string">&quot;&lt;div&gt;Hello &amp; World&lt;/div&gt;&quot;</span>)</span><br><span class="line"><span class="comment">// è¾“å‡º: &amp;lt;div&amp;gt;Hello &amp;amp; World&amp;lt;/div&amp;gt;</span></span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŠ¿</strong>ï¼šç›¸æ¯”å¤šæ¬¡è°ƒç”¨ <code>Replace</code>ï¼ŒReplacer åœ¨ 10+ æ›¿æ¢è§„åˆ™æ—¶æ€§èƒ½æå‡ 3-5 å€ï¼Œä¸”<strong>å¤©ç„¶æ”¯æŒå¹¶å‘å®‰å…¨</strong>ï¼ˆå†…éƒ¨ä½¿ç”¨ sync.Once åˆå§‹åŒ–çŠ¶æ€æœºï¼‰ã€‚</p><h2 id="ä¸‰ã€é«˜é¢‘é™·é˜±ä¸æœ€ä½³å®è·µ"><a href="#ä¸‰ã€é«˜é¢‘é™·é˜±ä¸æœ€ä½³å®è·µ" class="headerlink" title="ä¸‰ã€é«˜é¢‘é™·é˜±ä¸æœ€ä½³å®è·µ"></a>ä¸‰ã€é«˜é¢‘é™·é˜±ä¸æœ€ä½³å®è·µ</h2><h3 id="3-1-äº”å¤§å¸¸è§é™·é˜±"><a href="#3-1-äº”å¤§å¸¸è§é™·é˜±" class="headerlink" title="3.1 äº”å¤§å¸¸è§é™·é˜±"></a>3.1 äº”å¤§å¸¸è§é™·é˜±</h3><table><thead><tr><th>é™·é˜±</th><th>é”™è¯¯ç¤ºä¾‹</th><th>æ­£ç¡®åšæ³•</th><th>åŸå› </th></tr></thead><tbody><tr><td><strong>ç©ºå­—ç¬¦ä¸²åˆ†å‰²</strong></td><td><code>strings.Split(s, &quot;&quot;)</code></td><td><code>strings.Split(s, &quot;,&quot;)</code></td><td>è¿”å› <code>[&quot;&quot;, &quot;a&quot;, &quot;b&quot;, &quot;&quot;]</code> éé¢„æœŸç»“æœ</td></tr><tr><td><strong>Trim è¯¯ç”¨</strong></td><td><code>strings.Trim(s, &quot;abc&quot;)</code></td><td><code>strings.TrimPrefix(s, &quot;abc&quot;)</code></td><td>ä¼šç§»é™¤æ‰€æœ‰ a&#x2F;b&#x2F;c å­—ç¬¦ï¼ˆéå‰ç¼€ï¼‰</td></tr><tr><td><strong>å¤§å°å†™è½¬æ¢é™·é˜±</strong></td><td><code>strings.ToUpper(&quot;straÃŸe&quot;)</code></td><td><code>strings.ToUpperSpecial(unicode.TurkishCase, &quot;straÃŸe&quot;)</code></td><td>å¾·è¯­ ÃŸ â†’ SSï¼ŒåœŸè€³å…¶è¯­ i&#x2F;I ç‰¹æ®Šè§„åˆ™</td></tr><tr><td><strong>Builder é‡ç”¨</strong></td><td>å¤šæ¬¡è°ƒç”¨ <code>String()</code> åç»§ç»­å†™å…¥</td><td>æ¯æ¬¡é‡ç”¨å‰è°ƒç”¨ <code>Reset()</code></td><td>å†…éƒ¨ç¼“å†²åŒºå¯èƒ½è¢«é€ƒé€¸åˆ†æä¼˜åŒ–å¯¼è‡´æ•°æ®æ±¡æŸ“</td></tr><tr><td><strong>Index è´Ÿå€¼å¤„ç†</strong></td><td><code>s[Index:]</code> æœªæ£€æŸ¥ -1</td><td><code>if idx := strings.Index(...); idx != -1 &#123; ... &#125;</code></td><td>-1 åˆ‡ç‰‡å¯¼è‡´ panic</td></tr></tbody></table><h3 id="3-2-æ€§èƒ½ä¼˜åŒ–é»„é‡‘æ³•åˆ™"><a href="#3-2-æ€§èƒ½ä¼˜åŒ–é»„é‡‘æ³•åˆ™" class="headerlink" title="3.2 æ€§èƒ½ä¼˜åŒ–é»„é‡‘æ³•åˆ™"></a>3.2 æ€§èƒ½ä¼˜åŒ–é»„é‡‘æ³•åˆ™</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… æ¨èï¼šé¢„åˆ†é… Builder å®¹é‡</span></span><br><span class="line"><span class="keyword">var</span> b strings.Builder</span><br><span class="line">b.Grow(<span class="number">1024</span>) <span class="comment">// é¿å…å¤šæ¬¡æ‰©å®¹</span></span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> items &#123;</span><br><span class="line">    b.WriteString(item)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ¨èï¼šä½¿ç”¨ Fields æ›¿ä»£ Split + Trim</span></span><br><span class="line">words := strings.Fields(text) <span class="comment">// è‡ªåŠ¨å¤„ç†è¿ç»­ç©ºç™½ç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… æ¨èï¼šReplaceAll æ›¿ä»£å¾ªç¯ Replace</span></span><br><span class="line">clean := strings.ReplaceAll(dirty, <span class="string">&quot;  &quot;</span>, <span class="string">&quot; &quot;</span>) <span class="comment">// ä¸€æ¬¡è°ƒç”¨å¤„ç†æ‰€æœ‰é‡å¤ç©ºæ ¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// âŒ é¿å…ï¼šåœ¨å¾ªç¯å†…åˆ›å»º Replacer</span></span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> texts &#123;</span><br><span class="line">    r := strings.NewReplacer(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>) <span class="comment">// æ¯æ¬¡åˆ›å»ºçŠ¶æ€æœºå¼€é”€å¤§</span></span><br><span class="line">    r.Replace(s)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šå¤–éƒ¨åˆ›å»ºä¸€æ¬¡</span></span><br><span class="line">replacer := strings.NewReplacer(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> texts &#123;</span><br><span class="line">    replacer.Replace(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››ã€å®æˆ˜ï¼šæ„å»ºé«˜æ€§èƒ½-Web-æœåŠ¡å™¨"><a href="#å››ã€å®æˆ˜ï¼šæ„å»ºé«˜æ€§èƒ½-Web-æœåŠ¡å™¨" class="headerlink" title="å››ã€å®æˆ˜ï¼šæ„å»ºé«˜æ€§èƒ½ Web æœåŠ¡å™¨"></a>å››ã€å®æˆ˜ï¼šæ„å»ºé«˜æ€§èƒ½ Web æœåŠ¡å™¨</h2><p>ä¸‹é¢å®ç°ä¸€ä¸ª<strong>é›¶ä¾èµ–</strong>çš„ Web æœåŠ¡å™¨ï¼Œç»¼åˆè¿ç”¨ strings åŒ…å¤„ç† HTTP è¯·æ±‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"><span class="string">&quot;unicode&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTPServer è½»é‡çº§ Web æœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">type</span> HTTPServer <span class="keyword">struct</span> &#123;</span><br><span class="line">addr     <span class="type">string</span></span><br><span class="line">routes   <span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> <span class="type">string</span></span><br><span class="line">replacer *strings.Replacer <span class="comment">// ç”¨äº XSS é˜²æŠ¤</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewHTTPServer åˆ›å»ºæ–°æœåŠ¡å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHTTPServer</span><span class="params">(addr <span class="type">string</span>)</span></span> *HTTPServer &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;HTTPServer&#123;</span><br><span class="line">addr:   addr,</span><br><span class="line">routes: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> <span class="type">string</span>),</span><br><span class="line"><span class="comment">// åˆå§‹åŒ– HTML è½¬ä¹‰ Replacerï¼ˆAho-Corasick ä¼˜åŒ–ï¼‰</span></span><br><span class="line">replacer: strings.NewReplacer(</span><br><span class="line"><span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>,</span><br><span class="line"><span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>,</span><br><span class="line"><span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>,</span><br><span class="line"><span class="string">`&quot;`</span>, <span class="string">&quot;&amp;quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;&amp;#39;&quot;</span>,</span><br><span class="line">),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle æ³¨å†Œè·¯ç”±å¤„ç†å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HTTPServer)</span></span> Handle(path <span class="type">string</span>, handler <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> <span class="type">string</span>) &#123;</span><br><span class="line">s.routes[path] = handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sanitizeInput å®‰å…¨æ¸…ç†ç”¨æˆ·è¾“å…¥ï¼ˆXSS é˜²æŠ¤ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HTTPServer)</span></span> sanitizeInput(input <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">// 1. ç§»é™¤æ§åˆ¶å­—ç¬¦ï¼ˆé™¤ \t \n \r å¤–ï¼‰</span></span><br><span class="line">clean := strings.Map(<span class="function"><span class="keyword">func</span><span class="params">(r <span class="type">rune</span>)</span></span> <span class="type">rune</span> &#123;</span><br><span class="line"><span class="keyword">if</span> r &lt; <span class="number">32</span> &amp;&amp; r != <span class="string">&#x27;\t&#x27;</span> &amp;&amp; r != <span class="string">&#x27;\n&#x27;</span> &amp;&amp; r != <span class="string">&#x27;\r&#x27;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span> <span class="comment">// ç§»é™¤</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> r</span><br><span class="line">&#125;, input)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. HTML è½¬ä¹‰ï¼ˆä½¿ç”¨ Replacer é«˜æ€§èƒ½æ›¿æ¢ï¼‰</span></span><br><span class="line"><span class="keyword">return</span> s.replacer.Replace(clean)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// parseRequest è§£æ HTTP è¯·æ±‚ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HTTPServer)</span></span> parseRequest(raw <span class="type">string</span>) (method, path, query <span class="type">string</span>) &#123;</span><br><span class="line"><span class="comment">// æå–é¦–è¡Œ: &quot;GET /search?q=go HTTP/1.1&quot;</span></span><br><span class="line">lines := strings.SplitN(raw, <span class="string">&quot;\r\n&quot;</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(lines) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†å‰²æ–¹æ³•ã€è·¯å¾„ã€åè®®</span></span><br><span class="line">parts := strings.Fields(lines[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(parts) &lt; <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">method = parts[<span class="number">0</span>]</span><br><span class="line">fullPath := parts[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†ç¦»è·¯å¾„ä¸æŸ¥è¯¢å‚æ•°</span></span><br><span class="line"><span class="keyword">if</span> idx := strings.IndexByte(fullPath, <span class="string">&#x27;?&#x27;</span>); idx != <span class="number">-1</span> &#123;</span><br><span class="line">path = fullPath[:idx]</span><br><span class="line">query = fullPath[idx+<span class="number">1</span>:]</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">path = fullPath</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> method, path, query</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// extractQueryParam æå–æŸ¥è¯¢å‚æ•°å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HTTPServer)</span></span> extractQueryParam(query, key <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">// åˆ†å‰²å‚æ•°å¯¹: &quot;q=go&amp;lang=zh&quot;</span></span><br><span class="line">pairs := strings.Split(query, <span class="string">&quot;&amp;&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> _, pair := <span class="keyword">range</span> pairs &#123;</span><br><span class="line"><span class="keyword">if</span> idx := strings.IndexByte(pair, <span class="string">&#x27;=&#x27;</span>); idx != <span class="number">-1</span> &amp;&amp; pair[:idx] == key &#123;</span><br><span class="line"><span class="comment">// URL è§£ç ç®€åŒ–ç‰ˆï¼ˆä»…å¤„ç† + å’Œ %20ï¼‰</span></span><br><span class="line">value := pair[idx+<span class="number">1</span>:]</span><br><span class="line">value = strings.ReplaceAll(value, <span class="string">&quot;+&quot;</span>, <span class="string">&quot; &quot;</span>)</span><br><span class="line"><span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// buildResponse æ„å»º HTTP å“åº”</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HTTPServer)</span></span> buildResponse(body <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ Builder é›¶æ‹·è´æ‹¼æ¥å“åº”</span></span><br><span class="line"><span class="keyword">var</span> b strings.Builder</span><br><span class="line">b.Grow(<span class="number">512</span>) <span class="comment">// é¢„åˆ†é…å®¹é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å“åº”å¤´</span></span><br><span class="line">b.WriteString(<span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span>)</span><br><span class="line">b.WriteString(<span class="string">&quot;Content-Type: text/html; charset=utf-8\r\n&quot;</span>)</span><br><span class="line">b.WriteString(<span class="string">&quot;Server: GoStrings/1.0\r\n&quot;</span>)</span><br><span class="line">b.WriteString(<span class="string">&quot;Date: &quot;</span> + time.Now().Format(time.RFC1123) + <span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">b.WriteString(<span class="string">&quot;Content-Length: &quot;</span>)</span><br><span class="line">b.WriteString(fmt.Sprintf(<span class="string">&quot;%d&quot;</span>, <span class="built_in">len</span>(body)))</span><br><span class="line">b.WriteString(<span class="string">&quot;\r\n\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“åº”ä½“</span></span><br><span class="line">b.WriteString(body)</span><br><span class="line"><span class="keyword">return</span> b.String()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// defaultHandler é»˜è®¤å¤„ç†å™¨ï¼ˆæœç´¢æ¼”ç¤ºï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HTTPServer)</span></span> defaultHandler(query <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line">q := s.extractQueryParam(query, <span class="string">&quot;q&quot;</span>)</span><br><span class="line">safeQ := s.sanitizeInput(q)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„å»º HTML å“åº”ï¼ˆä½¿ç”¨ Builder é¿å…å†…å­˜ç¢ç‰‡ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> b strings.Builder</span><br><span class="line">b.WriteString(<span class="string">`&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;&lt;title&gt;Strings Server&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;æœç´¢ç»“æœ&lt;/h1&gt;</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> safeQ != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿæœç´¢ï¼šé«˜äº®åŒ¹é…è¯</span></span><br><span class="line">results := []<span class="type">string</span>&#123;<span class="string">&quot;Go è¯­è¨€å®æˆ˜&quot;</span>, <span class="string">&quot;strings åŒ…æ·±åº¦è§£æ&quot;</span>, <span class="string">&quot;é«˜æ€§èƒ½å­—ç¬¦ä¸²å¤„ç†&quot;</span>&#125;</span><br><span class="line">b.WriteString(<span class="string">&quot;&lt;p&gt;æœç´¢ \&quot;&quot;</span>)</span><br><span class="line">b.WriteString(safeQ)</span><br><span class="line">b.WriteString(<span class="string">&quot;\&quot; æ‰¾åˆ° &quot;</span>)</span><br><span class="line">b.WriteString(fmt.Sprintf(<span class="string">&quot;%d&quot;</span>, <span class="built_in">len</span>(results)))</span><br><span class="line">b.WriteString(<span class="string">&quot; ä¸ªç»“æœ:&lt;/p&gt;&lt;ul&gt;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, r := <span class="keyword">range</span> results &#123;</span><br><span class="line"><span class="comment">// ç®€å•é«˜äº®ï¼ˆå®é™…åº”ç”¨åº”ä½¿ç”¨æ­£åˆ™ï¼‰</span></span><br><span class="line"><span class="keyword">if</span> strings.Contains(strings.ToLower(r), strings.ToLower(safeQ)) &#123;</span><br><span class="line">b.WriteString(<span class="string">&quot;&lt;li&gt;&lt;strong&gt;&quot;</span>)</span><br><span class="line">b.WriteString(r)</span><br><span class="line">b.WriteString(<span class="string">&quot;&lt;/strong&gt;&lt;/li&gt;&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">b.WriteString(<span class="string">&quot;&lt;li&gt;&quot;</span>)</span><br><span class="line">b.WriteString(r)</span><br><span class="line">b.WriteString(<span class="string">&quot;&lt;/li&gt;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">b.WriteString(<span class="string">&quot;&lt;/ul&gt;&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">b.WriteString(<span class="string">&quot;&lt;p&gt;è¯·è¾“å…¥æœç´¢è¯ï¼ˆå¦‚ ?q=goï¼‰&lt;/p&gt;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">b.WriteString(<span class="string">`</span></span><br><span class="line"><span class="string">&lt;form method=&quot;GET&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;input type=&quot;text&quot; name=&quot;q&quot; placeholder=&quot;æœç´¢...&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;button type=&quot;submit&quot;&gt;æœç´¢&lt;/button&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;`</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> b.String()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HTTPServer)</span></span> Start() <span class="type">error</span> &#123;</span><br><span class="line">listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, s.addr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> listener.Close()</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;âœ“ Strings æœåŠ¡å™¨å¯åŠ¨: http://%s\n&quot;</span>, s.addr)</span><br><span class="line">fmt.Println(<span class="string">&quot;âœ“ æ”¯æŒè·¯ç”±: / (æœç´¢æ¼”ç¤º)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œé»˜è®¤å¤„ç†å™¨</span></span><br><span class="line">s.Handle(<span class="string">&quot;/&quot;</span>, s.defaultHandler)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := listener.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;âœ— æ¥å—è¿æ¥å¤±è´¥: %v\n&quot;</span>, err)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¹¶å‘å¤„ç†è¯·æ±‚</span></span><br><span class="line"><span class="keyword">go</span> s.handleConnection(conn)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// handleConnection å¤„ç†å•ä¸ªè¿æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HTTPServer)</span></span> handleConnection(conn net.Conn) &#123;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–è¯·æ±‚ï¼ˆç®€åŒ–ï¼šä»…è¯»é¦– 4KBï¼‰</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4096</span>)</span><br><span class="line">n, err := conn.Read(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">raw := <span class="type">string</span>(buf[:n])</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£æè¯·æ±‚</span></span><br><span class="line">method, path, query := s.parseRequest(raw)</span><br><span class="line"><span class="keyword">if</span> method != <span class="string">&quot;GET&quot;</span> &#123;</span><br><span class="line">conn.Write([]<span class="type">byte</span>(<span class="string">&quot;HTTP/1.1 405 Method Not Allowed\r\n\r\n&quot;</span>))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±åˆ†å‘</span></span><br><span class="line">handler, exists := s.routes[path]</span><br><span class="line"><span class="keyword">if</span> !exists &#123;</span><br><span class="line">conn.Write([]<span class="type">byte</span>(<span class="string">&quot;HTTP/1.1 404 Not Found\r\n\r\n&quot;</span>))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆå“åº”</span></span><br><span class="line">body := handler(query)</span><br><span class="line">response := s.buildResponse(body)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™å›å®¢æˆ·ç«¯</span></span><br><span class="line">conn.Write([]<span class="type">byte</span>(response))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">server := NewHTTPServer(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err := server.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;âœ— æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: %v\n&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-æœåŠ¡å™¨æ ¸å¿ƒç‰¹æ€§"><a href="#4-1-æœåŠ¡å™¨æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="4.1 æœåŠ¡å™¨æ ¸å¿ƒç‰¹æ€§"></a>4.1 æœåŠ¡å™¨æ ¸å¿ƒç‰¹æ€§</h3><ol><li><strong>é›¶å¤–éƒ¨ä¾èµ–</strong>ï¼šä»…ä½¿ç”¨æ ‡å‡†åº“ <code>net</code> + <code>strings</code> + <code>time</code></li><li><strong>XSS é˜²æŠ¤</strong>ï¼šé€šè¿‡ <code>Replacer</code> å®ç°é«˜æ€§èƒ½ HTML è½¬ä¹‰</li><li><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼š<ul><li><code>Builder</code> é¢„åˆ†é…å“åº”ç¼“å†²åŒº</li><li><code>Map</code> å‡½æ•°å®‰å…¨è¿‡æ»¤æ§åˆ¶å­—ç¬¦</li><li>é¿å…ä¸­é—´å­—ç¬¦ä¸²åˆ†é…</li></ul></li><li><strong>UTF-8 å®‰å…¨</strong>ï¼šæ‰€æœ‰æ“ä½œåŸºäº Rune æ„ŸçŸ¥å‡½æ•°</li><li><strong>ç”Ÿäº§çº§ç»†èŠ‚</strong>ï¼š<ul><li>æ­£ç¡®çš„ <code>Content-Length</code> è®¡ç®—</li><li>RFC1123 æ—¥æœŸæ ¼å¼</li><li>è¿æ¥å¹¶å‘å¤„ç†</li></ul></li></ol><h3 id="4-2-æµ‹è¯•æŒ‡å—"><a href="#4-2-æµ‹è¯•æŒ‡å—" class="headerlink" title="4.2 æµ‹è¯•æŒ‡å—"></a>4.2 æµ‹è¯•æŒ‡å—</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">go run main.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµè§ˆå™¨è®¿é—®</span></span><br><span class="line">http://localhost:8080/?q=go</span><br><span class="line"></span><br><span class="line"><span class="comment"># curl æµ‹è¯•</span></span><br><span class="line">curl <span class="string">&quot;http://localhost:8080/?q=strings&quot;</span></span><br><span class="line">curl <span class="string">&quot;http://localhost:8080/?q=&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>  <span class="comment"># éªŒè¯ XSS é˜²æŠ¤</span></span><br></pre></td></tr></table></figure><h2 id="äº”ã€è¿›é˜¶ï¼šstrings-åŒ…æºç çº§ä¼˜åŒ–æŠ€å·§"><a href="#äº”ã€è¿›é˜¶ï¼šstrings-åŒ…æºç çº§ä¼˜åŒ–æŠ€å·§" class="headerlink" title="äº”ã€è¿›é˜¶ï¼šstrings åŒ…æºç çº§ä¼˜åŒ–æŠ€å·§"></a>äº”ã€è¿›é˜¶ï¼šstrings åŒ…æºç çº§ä¼˜åŒ–æŠ€å·§</h2><h3 id="5-1-åˆ©ç”¨-strings-Cutï¼ˆGo-1-18-ï¼‰æ›¿ä»£-Index-Slice"><a href="#5-1-åˆ©ç”¨-strings-Cutï¼ˆGo-1-18-ï¼‰æ›¿ä»£-Index-Slice" class="headerlink" title="5.1 åˆ©ç”¨ strings.Cutï¼ˆGo 1.18+ï¼‰æ›¿ä»£ Index + Slice"></a>5.1 åˆ©ç”¨ <code>strings.Cut</code>ï¼ˆGo 1.18+ï¼‰æ›¿ä»£ Index + Slice</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸¤æ¬¡æ‰«æï¼‰</span></span><br><span class="line">idx := strings.Index(s, <span class="string">&quot;:&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> idx != <span class="number">-1</span> &#123;</span><br><span class="line">    key := s[:idx]</span><br><span class="line">    value := s[idx+<span class="number">1</span>:]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜åŒ–æ–¹å¼ï¼ˆä¸€æ¬¡æ‰«æï¼‰</span></span><br><span class="line">key, value, found := strings.Cut(s, <span class="string">&quot;:&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> found &#123;</span><br><span class="line">    <span class="comment">// ç›´æ¥ä½¿ç”¨ key/value</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŸç†</strong>ï¼š<code>Cut</code> å†…éƒ¨ä½¿ç”¨å•æ¬¡éå†ï¼Œé¿å… Index åçš„äºŒæ¬¡åˆ‡ç‰‡è®¡ç®—ï¼Œæ€§èƒ½æå‡ 15-20%ã€‚</p><h3 id="5-2-Builder-çš„é€ƒé€¸åˆ†æé™·é˜±"><a href="#5-2-Builder-çš„é€ƒé€¸åˆ†æé™·é˜±" class="headerlink" title="5.2 Builder çš„é€ƒé€¸åˆ†æé™·é˜±"></a>5.2 Builder çš„é€ƒé€¸åˆ†æé™·é˜±</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å±é™©ï¼šBuilder é€ƒé€¸åˆ°å †å¯¼è‡´æ€§èƒ½ä¸‹é™</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bad</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> b strings.Builder</span><br><span class="line">    b.WriteString(<span class="string">&quot;data&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> b.String() <span class="comment">// ç¼–è¯‘å™¨å¯èƒ½å°† b é€ƒé€¸åˆ°å †</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜åŒ–ï¼šæ˜¾å¼æ§åˆ¶ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">good</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    b := <span class="built_in">new</span>(strings.Builder) <span class="comment">// æ ˆåˆ†é…</span></span><br><span class="line">    b.Grow(<span class="number">64</span>)</span><br><span class="line">    b.WriteString(<span class="string">&quot;data&quot;</span>)</span><br><span class="line">    s := b.String()</span><br><span class="line">    b.Reset() <span class="comment">// é‡Šæ”¾å†…éƒ¨ç¼“å†²åŒºï¼ˆGo 1.23+ ä¼˜åŒ–ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®æµ‹æ•°æ®</strong>ï¼šåœ¨ Go 1.25 ä¸­ï¼Œæ­£ç¡®ä½¿ç”¨ <code>Reset()</code> å¯ä½¿ Builder é‡ç”¨åœºæ™¯çš„ GC å‹åŠ›é™ä½ 40%ã€‚</p><h2 id="å…­ã€æ€»ç»“ï¼šstrings-åŒ…ä½¿ç”¨å¿ƒæ™ºæ¨¡å‹"><a href="#å…­ã€æ€»ç»“ï¼šstrings-åŒ…ä½¿ç”¨å¿ƒæ™ºæ¨¡å‹" class="headerlink" title="å…­ã€æ€»ç»“ï¼šstrings åŒ…ä½¿ç”¨å¿ƒæ™ºæ¨¡å‹"></a>å…­ã€æ€»ç»“ï¼šstrings åŒ…ä½¿ç”¨å¿ƒæ™ºæ¨¡å‹</h2><table><thead><tr><th>åœºæ™¯</th><th>æ¨èæ–¹æ¡ˆ</th><th>ç¦å¿Œ</th></tr></thead><tbody><tr><td><strong>é«˜é¢‘æ‹¼æ¥</strong></td><td><code>strings.Builder</code> + <code>Grow</code></td><td><code>+</code> æ‹¼æ¥ã€<code>fmt.Sprintf</code> å¾ªç¯</td></tr><tr><td><strong>å¤šæ¨¡å¼æ›¿æ¢</strong></td><td><code>strings.Replacer</code>ï¼ˆé¢„åˆ›å»ºï¼‰</td><td>å¾ªç¯è°ƒç”¨ <code>Replace</code></td></tr><tr><td><strong>è·¯å¾„&#x2F;URL å¤„ç†</strong></td><td><code>TrimPrefix</code>&#x2F;<code>TrimSuffix</code></td><td><code>Trim</code>ï¼ˆä¼šè¯¯åˆ å­—ç¬¦ï¼‰</td></tr><tr><td><strong>å›½é™…åŒ–æ–‡æœ¬</strong></td><td><code>ToLowerSpecial</code> + è¯­è¨€æ ‡ç­¾</td><td>ç›´æ¥ <code>ToLower</code></td></tr><tr><td><strong>ç”¨æˆ·è¾“å…¥æ¸…æ´—</strong></td><td><code>Map</code> + <code>Replacer</code> ç»„åˆ</td><td>æ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ€§èƒ½å·®ï¼‰</td></tr><tr><td><strong>æ—¥å¿—ç»„è£…</strong></td><td><code>Builder</code> + é¢„åˆ†é…</td><td><code>Join</code>ï¼ˆéœ€å…ˆæ„å»ºåˆ‡ç‰‡ï¼‰</td></tr></tbody></table><p><strong>ç»ˆæå»ºè®®</strong>ï¼šstrings åŒ…çš„è®¾è®¡å“²å­¦æ˜¯ **â€ç®€å•é—®é¢˜ç®€å•è§£ï¼Œå¤æ‚é—®é¢˜ç»„åˆè§£â€**ã€‚<br>æŒæ¡å…¶å…­å¤§åŠŸèƒ½åŸŸçš„è¾¹ç•Œï¼Œç»“åˆ Builder&#x2F;Replacer ä¸¤å¤§é«˜æ€§èƒ½å·¥å…·ï¼Œå³å¯åº”å¯¹ 99% çš„å­—ç¬¦ä¸²å¤„ç†åœºæ™¯ï¼Œæ— éœ€å¼•å…¥ç¬¬ä¸‰æ–¹åº“ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€strings-åŒ…å…¨æ™¯å›¾è°±&quot;&gt;&lt;a href=&quot;#ä¸€ã€strings-åŒ…å…¨æ™¯å›¾è°±&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€strings åŒ…å…¨æ™¯å›¾è°±&quot;&gt;&lt;/a&gt;ä¸€ã€strings åŒ…å…¨æ™¯å›¾è°±&lt;/h2&gt;&lt;p&gt;strings åŒ…æ˜¯ Go è¯­è¨€å¤„ç† UTF-8 æ–‡æœ¬çš„æ ¸å¿ƒå·¥å…·åº“ï¼Œæä¾›é«˜æ•ˆã€å®‰å…¨çš„å­—ç¬¦ä¸²æ“ä½œåŸè¯­ã€‚&lt;br&gt;æˆªè‡³ Go 1.25ï¼Œè¯¥åŒ…åŒ…å« &lt;strong&gt;38 ä¸ªå¯¼å‡ºå‡½æ•°&lt;/strong&gt;ã€&lt;strong&gt;2 ä¸ªæ ¸å¿ƒç±»å‹&lt;/strong&gt;ï¼ˆBuilder&amp;#x2F;Replacerï¼‰å’Œ &lt;strong&gt;1 ä¸ªè¾…åŠ©ç±»å‹&lt;/strong&gt;ï¼ˆReplacer å†…éƒ¨ç»“æ„ï¼‰ï¼ŒæŒ‰åŠŸèƒ½åˆ’åˆ†ä¸ºå…­å¤§ç±»åˆ«ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-path" scheme="https://www.wdft.com/tags/Go-path/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäº HEART æ¶æ„ç†å¿µçš„éšç§ä¿æŠ¤AIå¥åº·åº”ç”¨è®¾è®¡çš„ä¸€ç§æ¶æ„æ€è·¯å®è·µè§£å†³æ–¹æ¡ˆ</title>
    <link href="https://www.wdft.com/276d47b6.html"/>
    <id>https://www.wdft.com/276d47b6.html</id>
    <published>2026-01-25T15:24:37.000Z</published>
    <updated>2026-01-30T06:40:40.569Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h2><p>æœ¬äººä¸€ç›´éå¸¸æ¬£èµçš„ä¸€å¥è¯ï¼š   </p><p>é™¤éç»ç”±è®°å¿†ä¹‹è·¯ï¼Œäººä¸èƒ½æŠµè¾¾çºµæ·±ã€‚ â€”â€”â€”â€”æ±‰å¨œÂ·é˜¿ä¼¦ç‰¹   </p><p>é¦–å…ˆå¦‚æœåŸºäºHEARTæ¶æ„ç†å¿µï¼Œå¦‚ä½•è®¾è®¡ä¸€ä¸ªç¡®ä¿æ•°æ®éšç§çš„AIå¥åº·åº”ç”¨æ¶æ„ï¼Ÿç›¸ä¿¡è¿™åœ¨2026å¼€å¹´çš„ä»Šå¤©ï¼Œä»¥åŠè¿‡å»ä¸€å¹´ç”šåš£å°˜ä¸Šçš„å„ç§AIåº”ç”¨å¼€å‘æŠ€æœ¯å’Œè§„èŒƒåŸåˆ™é¼“å¹ä¹‹ä¸‹è¦æ€è€ƒå’Œåæ€çš„é—®é¢˜ï¼Œä½œä¸ºå·¥ç¨‹å¸ˆè¦å›å½’æ¸…é†’ä¸ç†æ™ºã€‚  </p><span id="more"></span><p>è¿™ä¹Ÿæ˜¯å¤§å¤šæ•°äººåœ¨AIä¸šåŠ¡é¡¹ç›®å®é™…è½åœ°çš„æ—¶å€™éƒ½è¦è®¤çœŸè€ƒè™‘çš„é—®é¢˜ã€‚   </p><p>åœ¨å½“ä»Šæ•°å­—åŒ–å¥åº·æ—¶ä»£ï¼ŒAIåº”ç”¨æ­£ä»¥å‰æ‰€æœªæœ‰çš„é€Ÿåº¦æ”¹å˜ç€åŒ»ç–—ä¿å¥è¡Œä¸šã€‚ç„¶è€Œï¼Œå¥åº·æ•°æ®çš„æ•æ„Ÿæ€§è¦æ±‚æˆ‘ä»¬åœ¨è®¾è®¡AIå¥åº·åº”ç”¨æ—¶å¿…é¡»å°†æ•°æ®éšç§ç½®äºæ ¸å¿ƒä½ç½®ã€‚æœ¬æ–‡å°†ä»‹ç»ä¸€ç§åŸºäºHEARTæ¶æ„ç†å¿µçš„éšç§ä¿æŠ¤AIå¥åº·åº”ç”¨è®¾è®¡æ–¹æ¡ˆï¼Œä»åŸåˆ™ã€åŸç†åˆ°å…·ä½“ä»£ç å®ç°ï¼Œä¸ºå¼€å‘è€…æä¾›ä¸€å¥—å®Œæ•´çš„æ¶æ„æŒ‡å—ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯HEARTæ¶æ„ç†å¿µï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯HEARTæ¶æ„ç†å¿µï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯HEARTæ¶æ„ç†å¿µï¼Ÿ"></a>ä»€ä¹ˆæ˜¯HEARTæ¶æ„ç†å¿µï¼Ÿ</h2><p>HEARTæ¶æ„å¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„Googleç”¨æˆ·ä½“éªŒæ¡†æ¶ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå¥åº·AIåº”ç”¨è®¾è®¡çš„éšç§ä¿æŠ¤æ¶æ„æ¡†æ¶ã€‚HEARTä»£è¡¨ï¼š</p><ul><li><strong>H</strong>ealth Data Protection (å¥åº·æ•°æ®ä¿æŠ¤)</li><li><strong>E</strong>thical AI Processing (ä¼¦ç†AIå¤„ç†)  </li><li><strong>A</strong>ccess Control &amp; Authentication (è®¿é—®æ§åˆ¶ä¸è®¤è¯)</li><li><strong>R</strong>egulatory Compliance (æ³•è§„åˆè§„)</li><li><strong>T</strong>ransparency &amp; Traceability (é€æ˜æ€§ä¸å¯è¿½æº¯æ€§)</li></ul><p>è¿™ä¸€æ¶æ„ç†å¿µå¼ºè°ƒå°†éšç§ä¿æŠ¤åµŒå…¥åˆ°ç³»ç»Ÿè®¾è®¡çš„æ¯ä¸ªå±‚é¢ï¼Œè€Œéäº‹åè¡¥æ•‘ã€‚æ­£å¦‚â€privacy by designâ€å’Œâ€privacy by defaultâ€åŸåˆ™æ‰€å¼ºè°ƒçš„ï¼Œéšç§ä¿æŠ¤åº”è¯¥ä»ç³»ç»Ÿè®¾è®¡ä¹‹åˆå°±è¢«è€ƒè™‘ã€‚</p><h2 id="HEARTæ¶æ„æ ¸å¿ƒåŸåˆ™"><a href="#HEARTæ¶æ„æ ¸å¿ƒåŸåˆ™" class="headerlink" title="HEARTæ¶æ„æ ¸å¿ƒåŸåˆ™"></a>HEARTæ¶æ„æ ¸å¿ƒåŸåˆ™</h2><h3 id="1-å¥åº·æ•°æ®ä¿æŠ¤-Health-Data-Protection"><a href="#1-å¥åº·æ•°æ®ä¿æŠ¤-Health-Data-Protection" class="headerlink" title="1. å¥åº·æ•°æ®ä¿æŠ¤ (Health Data Protection)"></a>1. å¥åº·æ•°æ®ä¿æŠ¤ (Health Data Protection)</h3><p><strong>åŸåˆ™</strong>ï¼šå¥åº·æ•°æ®è¢«è§†ä¸ºæœ€é«˜æ•æ„Ÿçº§åˆ«çš„æ•°æ®ï¼Œéœ€è¦å®æ–½æœ€å¼ºçº§åˆ«çš„ä¿æŠ¤æªæ–½ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>æ•°æ®æœ€å°åŒ–ï¼šåªæ”¶é›†å’Œå¤„ç†å¿…è¦çš„å¥åº·æ•°æ®</li><li>ç«¯åˆ°ç«¯åŠ å¯†ï¼šæ•°æ®åœ¨ä¼ è¾“å’Œå­˜å‚¨è¿‡ç¨‹ä¸­å…¨ç¨‹åŠ å¯†</li><li>æ•°æ®åŒ¿ååŒ–&#x2F;å‡ååŒ–ï¼šåœ¨ä¸å½±å“AIåŠŸèƒ½çš„å‰æä¸‹ï¼Œç§»é™¤æˆ–æ›¿æ¢ä¸ªäººæ ‡è¯†ç¬¦</li><li>æœ¬åœ°å¤„ç†ä¼˜å…ˆï¼šæ•æ„Ÿæ•°æ®å°½å¯èƒ½åœ¨ç”¨æˆ·è®¾å¤‡ç«¯å¤„ç†ï¼Œå‡å°‘äº‘ç«¯ä¼ è¾“</li></ul><h3 id="2-ä¼¦ç†AIå¤„ç†-Ethical-AI-Processing"><a href="#2-ä¼¦ç†AIå¤„ç†-Ethical-AI-Processing" class="headerlink" title="2. ä¼¦ç†AIå¤„ç† (Ethical AI Processing)"></a>2. ä¼¦ç†AIå¤„ç† (Ethical AI Processing)</h3><p><strong>åŸåˆ™</strong>ï¼šAIç®—æ³•å¿…é¡»é€æ˜ã€å…¬å¹³ã€å¯è§£é‡Šï¼Œé¿å…åè§å’Œæ­§è§†ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>ç®—æ³•é€æ˜æ€§ï¼šè®°å½•å’Œè§£é‡ŠAIå†³ç­–è¿‡ç¨‹</li><li>åè§æ£€æµ‹ï¼šå®šæœŸè¯„ä¼°ç®—æ³•æ˜¯å¦å­˜åœ¨åè§</li><li>äººç±»ç›‘ç£ï¼šå…³é”®åŒ»ç–—å†³ç­–ä¿ç•™äººå·¥å®¡æ ¸ç¯èŠ‚</li><li>æ¨¡å‹å¯è§£é‡Šæ€§ï¼šä½¿ç”¨å¯è§£é‡Šçš„AIæŠ€æœ¯ï¼Œå¦‚LIMEã€SHAPç­‰</li></ul><h3 id="3-è®¿é—®æ§åˆ¶ä¸è®¤è¯-Access-Control-amp-Authentication"><a href="#3-è®¿é—®æ§åˆ¶ä¸è®¤è¯-Access-Control-amp-Authentication" class="headerlink" title="3. è®¿é—®æ§åˆ¶ä¸è®¤è¯ (Access Control &amp; Authentication)"></a>3. è®¿é—®æ§åˆ¶ä¸è®¤è¯ (Access Control &amp; Authentication)</h3><p><strong>åŸåˆ™</strong>ï¼šä¸¥æ ¼çš„è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œç¡®ä¿åªæœ‰æˆæƒäººå‘˜å’Œç³»ç»Ÿå¯ä»¥è®¿é—®å¥åº·æ•°æ®ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>å¤šå› ç´ è®¤è¯ï¼šå¼ºåˆ¶ä½¿ç”¨å¤šå› ç´ èº«ä»½éªŒè¯</li><li>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)ï¼šæ ¹æ®ç”¨æˆ·è§’è‰²åˆ†é…æœ€å°å¿…è¦æƒé™</li><li>åŠ¨æ€æƒé™ç®¡ç†ï¼šæƒé™éšä¸Šä¸‹æ–‡åŠ¨æ€è°ƒæ•´</li><li>å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰æ•°æ®è®¿é—®è¡Œä¸º</li></ul><h3 id="4-æ³•è§„åˆè§„-Regulatory-Compliance"><a href="#4-æ³•è§„åˆè§„-Regulatory-Compliance" class="headerlink" title="4. æ³•è§„åˆè§„ (Regulatory Compliance)"></a>4. æ³•è§„åˆè§„ (Regulatory Compliance)</h3><p><strong>åŸåˆ™</strong>ï¼šç³»ç»Ÿè®¾è®¡å¿…é¡»ç¬¦åˆç›¸å…³æ³•å¾‹æ³•è§„ï¼Œå¦‚HIPAAã€GDPRã€CCPAç­‰ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>æ•°æ®ä¸»ä½“æƒåˆ©æ”¯æŒï¼šå®ç°æ•°æ®è®¿é—®ã€æ›´æ­£ã€åˆ é™¤ç­‰åŠŸèƒ½</li><li>åˆè§„æ€§è‡ªåŠ¨åŒ–ï¼šè‡ªåŠ¨åŒ–çš„åˆè§„æ€§æ£€æŸ¥å’ŒæŠ¥å‘Šç”Ÿæˆ</li><li>è·¨å¢ƒæ•°æ®ä¼ è¾“æ§åˆ¶ï¼šä¸¥æ ¼ç®¡ç†æ•°æ®è·¨å¢ƒæµåŠ¨</li><li>éšç§å½±å“è¯„ä¼°ï¼šåœ¨æ–°åŠŸèƒ½å¼€å‘å‰è¿›è¡Œéšç§å½±å“è¯„ä¼°</li></ul><h3 id="5-é€æ˜æ€§ä¸å¯è¿½æº¯æ€§-Transparency-amp-Traceability"><a href="#5-é€æ˜æ€§ä¸å¯è¿½æº¯æ€§-Transparency-amp-Traceability" class="headerlink" title="5. é€æ˜æ€§ä¸å¯è¿½æº¯æ€§ (Transparency &amp; Traceability)"></a>5. é€æ˜æ€§ä¸å¯è¿½æº¯æ€§ (Transparency &amp; Traceability)</h3><p><strong>åŸåˆ™</strong>ï¼šç”¨æˆ·åº”æ¸…æ¥šäº†è§£å…¶æ•°æ®å¦‚ä½•è¢«ä½¿ç”¨ï¼Œæ‰€æœ‰æ“ä½œåº”å¯è¿½æº¯ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>é€æ˜çš„éšç§æ”¿ç­–ï¼šç”¨ç®€å•æ˜“æ‡‚çš„è¯­è¨€è¯´æ˜æ•°æ®ä½¿ç”¨æ–¹å¼</li><li>æ•°æ®ä½¿ç”¨æ—¥å¿—ï¼šè¯¦ç»†è®°å½•æ•°æ®è®¿é—®å’Œä½¿ç”¨æƒ…å†µ</li><li>åŒºå—é“¾æŠ€æœ¯ï¼šä½¿ç”¨åŒºå—é“¾è®°å½•å…³é”®æ“ä½œï¼Œç¡®ä¿ä¸å¯ç¯¡æ”¹</li><li>ç”¨æˆ·æ§åˆ¶é¢æ¿ï¼šæä¾›ç”¨æˆ·æ•°æ®ä½¿ç”¨æƒ…å†µçš„å¯è§†åŒ–ç•Œé¢</li></ul><h2 id="ç³»ç»Ÿæ¶æ„è®¾è®¡"><a href="#ç³»ç»Ÿæ¶æ„è®¾è®¡" class="headerlink" title="ç³»ç»Ÿæ¶æ„è®¾è®¡"></a>ç³»ç»Ÿæ¶æ„è®¾è®¡</h2><h3 id="æ•´ä½“æ¶æ„å›¾"><a href="#æ•´ä½“æ¶æ„å›¾" class="headerlink" title="æ•´ä½“æ¶æ„å›¾"></a>æ•´ä½“æ¶æ„å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+     +-------------------+     +-------------------+</span><br><span class="line">|   User Devices    |     |  Edge Processing  |     |   Cloud Services  |</span><br><span class="line">| (Mobile, Wearable)|----&gt;|   (Local AI)      |----&gt;|  (Central AI)     |</span><br><span class="line">+-------------------+     +-------------------+     +-------------------+</span><br><span class="line">        |                          |                          |</span><br><span class="line">        v                          v                          v</span><br><span class="line">+-------------------+     +-------------------+     +-------------------+</span><br><span class="line">| Local Data Store  |     | Privacy Gateway   |     | Secure Data Lake  |</span><br><span class="line">| (Encrypted)       |     | (Anonymization)   |     | (Homomorphic Enc) |</span><br><span class="line">+-------------------+     +-------------------+     +-------------------+</span><br><span class="line">        |                          |                          |</span><br><span class="line">        +--------------------------+--------------------------+</span><br><span class="line">                                   |</span><br><span class="line">                           +-------------------+</span><br><span class="line">                           | Audit &amp; Monitor   |</span><br><span class="line">                           | (Blockchain Log)  |</span><br><span class="line">                           +-------------------+</span><br></pre></td></tr></table></figure><h3 id="å…³é”®ç»„ä»¶è¯´æ˜"><a href="#å…³é”®ç»„ä»¶è¯´æ˜" class="headerlink" title="å…³é”®ç»„ä»¶è¯´æ˜"></a>å…³é”®ç»„ä»¶è¯´æ˜</h3><ol><li><strong>ç”¨æˆ·è®¾å¤‡å±‚</strong>ï¼šè¿è¡Œåœ¨ç”¨æˆ·è®¾å¤‡ç«¯çš„è½»é‡çº§AIæ¨¡å‹ï¼Œå¤„ç†æœ€æ•æ„Ÿçš„æ•°æ®</li><li><strong>è¾¹ç¼˜å¤„ç†å±‚</strong>ï¼šåœ¨æœ¬åœ°æˆ–è¾¹ç¼˜æœåŠ¡å™¨è¿›è¡Œæ•°æ®é¢„å¤„ç†å’ŒåŒ¿ååŒ–</li><li><strong>éšç§ç½‘å…³</strong>ï¼šè´Ÿè´£æ•°æ®åŒ¿ååŒ–ã€åŠ å¯†å’Œè®¿é—®æ§åˆ¶çš„æ ¸å¿ƒç»„ä»¶</li><li><strong>å®‰å…¨æ•°æ®æ¹–</strong>ï¼šæ”¯æŒåŒæ€åŠ å¯†çš„å­˜å‚¨ç³»ç»Ÿï¼Œå…è®¸åœ¨åŠ å¯†æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—</li><li><strong>å®¡è®¡ç›‘æ§</strong>ï¼šä½¿ç”¨åŒºå—é“¾æŠ€æœ¯è®°å½•æ‰€æœ‰æ“ä½œï¼Œç¡®ä¿ä¸å¯ç¯¡æ”¹æ€§</li></ol><h2 id="ä»£ç å®ç°ç¤ºä¾‹"><a href="#ä»£ç å®ç°ç¤ºä¾‹" class="headerlink" title="ä»£ç å®ç°ç¤ºä¾‹"></a>ä»£ç å®ç°ç¤ºä¾‹</h2><h3 id="Pythonå®ç°ï¼šéšç§ä¿æŠ¤æ•°æ®å¤„ç†å±‚"><a href="#Pythonå®ç°ï¼šéšç§ä¿æŠ¤æ•°æ®å¤„ç†å±‚" class="headerlink" title="Pythonå®ç°ï¼šéšç§ä¿æŠ¤æ•°æ®å¤„ç†å±‚"></a>Pythonå®ç°ï¼šéšç§ä¿æŠ¤æ•°æ®å¤„ç†å±‚</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PrivacyProtectedHealthData</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    HEARTæ¶æ„ä¸­çš„å¥åº·æ•°æ®ä¿æŠ¤ç»„ä»¶</span></span><br><span class="line"><span class="string">    å®ç°æ•°æ®åŠ å¯†ã€åŒ¿ååŒ–å’Œè®¿é—®æ§åˆ¶</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.encryption_key = Fernet.generate_key()</span><br><span class="line">        self.cipher = Fernet(self.encryption_key)</span><br><span class="line">        self.access_control = &#123;&#125;</span><br><span class="line">        self.audit_log = []</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">anonymize_patient_data</span>(<span class="params">self, patient_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åŒ»ç–—æ•°æ®åŒ¿ååŒ–å¤„ç†</span></span><br><span class="line"><span class="string">        ç§»é™¤æˆ–å“ˆå¸Œå¤„ç†ä¸ªäººæ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        anonymized_data = patient_data.copy()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç§»é™¤ç›´æ¥æ ‡è¯†ç¬¦</span></span><br><span class="line">        identifiers = [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;ssn&#x27;</span>, <span class="string">&#x27;phone&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;address&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> identifier <span class="keyword">in</span> identifiers:</span><br><span class="line">            <span class="keyword">if</span> identifier <span class="keyword">in</span> anonymized_data:</span><br><span class="line">                <span class="keyword">del</span> anonymized_data[identifier]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å“ˆå¸Œå¤„ç†é—´æ¥æ ‡è¯†ç¬¦</span></span><br><span class="line">        quasi_identifiers = [<span class="string">&#x27;birth_date&#x27;</span>, <span class="string">&#x27;zip_code&#x27;</span>, <span class="string">&#x27;gender&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> qi <span class="keyword">in</span> quasi_identifiers:</span><br><span class="line">            <span class="keyword">if</span> qi <span class="keyword">in</span> anonymized_data:</span><br><span class="line">                anonymized_data[<span class="string">f&quot;hashed_<span class="subst">&#123;qi&#125;</span>&quot;</span>] = hashlib.sha256(</span><br><span class="line">                    <span class="built_in">str</span>(anonymized_data[qi]).encode()</span><br><span class="line">                ).hexdigest()</span><br><span class="line">                <span class="keyword">del</span> anonymized_data[qi]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•åŒ¿ååŒ–æ“ä½œ</span></span><br><span class="line">        self._log_audit(<span class="string">&quot;anonymize&quot;</span>, <span class="string">&quot;patient_data&quot;</span>, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> anonymized_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt_sensitive_data</span>(<span class="params">self, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä½¿ç”¨å¯¹ç§°åŠ å¯†åŠ å¯†æ•æ„Ÿå¥åº·æ•°æ®</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        json_data = json.dumps(data).encode()</span><br><span class="line">        encrypted_data = self.cipher.encrypt(json_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•åŠ å¯†æ“ä½œ</span></span><br><span class="line">        self._log_audit(<span class="string">&quot;encrypt&quot;</span>, <span class="string">&quot;sensitive_data&quot;</span>, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> encrypted_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_data</span>(<span class="params">self, encrypted_data: <span class="built_in">bytes</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è§£å¯†æ•°æ®ï¼Œä»…åœ¨æˆæƒè®¿é—®æ—¶è°ƒç”¨</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        decrypted_json = self.cipher.decrypt(encrypted_data)</span><br><span class="line">        <span class="keyword">return</span> json.loads(decrypted_json)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_access_control</span>(<span class="params">self, user_id: <span class="built_in">str</span>, permissions: <span class="type">List</span>[<span class="built_in">str</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è®¾ç½®åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.access_control[user_id] = permissions</span><br><span class="line">        self._log_audit(<span class="string">&quot;set_access&quot;</span>, user_id, <span class="built_in">str</span>(permissions))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_access_permission</span>(<span class="params">self, user_id: <span class="built_in">str</span>, action: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ‰§è¡Œç‰¹å®šæ“ä½œçš„æƒé™</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> user_id <span class="keyword">not</span> <span class="keyword">in</span> self.access_control:</span><br><span class="line">            self._log_audit(<span class="string">&quot;access_denied&quot;</span>, user_id, <span class="string">f&quot;no_permissions_for_<span class="subst">&#123;action&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        has_permission = action <span class="keyword">in</span> self.access_control[user_id]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> has_permission:</span><br><span class="line">            self._log_audit(<span class="string">&quot;access_denied&quot;</span>, user_id, <span class="string">f&quot;missing_permission_<span class="subst">&#123;action&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> has_permission</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_log_audit</span>(<span class="params">self, action: <span class="built_in">str</span>, target: <span class="built_in">str</span>, result: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è®°å½•å®¡è®¡æ—¥å¿—ï¼Œç¬¦åˆHEARTæ¶æ„çš„é€æ˜æ€§ä¸å¯è¿½æº¯æ€§åŸåˆ™</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        log_entry = &#123;</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: time.time(),</span><br><span class="line">            <span class="string">&quot;action&quot;</span>: action,</span><br><span class="line">            <span class="string">&quot;target&quot;</span>: target,</span><br><span class="line">            <span class="string">&quot;result&quot;</span>: result</span><br><span class="line">        &#125;</span><br><span class="line">        self.audit_log.append(log_entry)</span><br><span class="line">        logging.info(<span class="string">f&quot;Audit: <span class="subst">&#123;log_entry&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–éšç§ä¿æŠ¤æ•°æ®å¤„ç†å™¨</span></span><br><span class="line">    privacy_processor = PrivacyProtectedHealthData()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¤ºä¾‹æ‚£è€…æ•°æ®</span></span><br><span class="line">    patient_data = &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;å¼ ä¸‰&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span>: <span class="number">45</span>,</span><br><span class="line">        <span class="string">&quot;diagnosis&quot;</span>: <span class="string">&quot;é«˜è¡€å‹&quot;</span>,</span><br><span class="line">        <span class="string">&quot;blood_pressure&quot;</span>: <span class="string">&quot;140/90&quot;</span>,</span><br><span class="line">        <span class="string">&quot;birth_date&quot;</span>: <span class="string">&quot;1979-01-15&quot;</span>,</span><br><span class="line">        <span class="string">&quot;zip_code&quot;</span>: <span class="string">&quot;100000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŒ¿ååŒ–å¤„ç†</span></span><br><span class="line">    anonymized_data = privacy_processor.anonymize_patient_data(patient_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;åŒ¿ååŒ–åçš„æ•°æ®:&quot;</span>, anonymized_data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŠ å¯†å¤„ç†</span></span><br><span class="line">    encrypted_data = privacy_processor.encrypt_sensitive_data(anonymized_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;åŠ å¯†åçš„æ•°æ®:&quot;</span>, encrypted_data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¾ç½®è®¿é—®æ§åˆ¶</span></span><br><span class="line">    privacy_processor.set_access_control(<span class="string">&quot;doctor_123&quot;</span>, [<span class="string">&quot;view_diagnosis&quot;</span>, <span class="string">&quot;view_vitals&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ£€æŸ¥è®¿é—®æƒé™</span></span><br><span class="line">    has_access = privacy_processor.check_access_permission(<span class="string">&quot;doctor_123&quot;</span>, <span class="string">&quot;view_diagnosis&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;åŒ»ç”Ÿæœ‰è®¿é—®æƒé™:&quot;</span>, has_access)</span><br></pre></td></tr></table></figure><h3 id="Goå®ç°ï¼šéšç§ç½‘å…³æœåŠ¡"><a href="#Goå®ç°ï¼šéšç§ç½‘å…³æœåŠ¡" class="headerlink" title="Goå®ç°ï¼šéšç§ç½‘å…³æœåŠ¡"></a>Goå®ç°ï¼šéšç§ç½‘å…³æœåŠ¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;crypto/aes&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/cipher&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// HEARTæ¶æ„çš„æ ¸å¿ƒæ•°æ®ç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> HealthData <span class="keyword">struct</span> &#123;</span><br><span class="line">ID        <span class="type">string</span> <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">PatientID <span class="type">string</span> <span class="string">`json:&quot;patient_id&quot;`</span></span><br><span class="line">DataType  <span class="type">string</span> <span class="string">`json:&quot;data_type&quot;`</span> <span class="comment">// vitals, diagnosis, lab_results</span></span><br><span class="line">RawData   []<span class="type">byte</span> <span class="string">`json:&quot;raw_data&quot;`</span>  <span class="comment">// åŠ å¯†åçš„åŸå§‹æ•°æ®</span></span><br><span class="line">HashedID  <span class="type">string</span> <span class="string">`json:&quot;hashed_id&quot;`</span> <span class="comment">// å“ˆå¸Œå¤„ç†åçš„æ‚£è€…ID</span></span><br><span class="line">Timestamp time.Time <span class="string">`json:&quot;timestamp&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PrivacyGateway <span class="keyword">struct</span> &#123;</span><br><span class="line">db          *gorm.DB</span><br><span class="line">encryptionKey []<span class="type">byte</span></span><br><span class="line">accessRules   <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span></span><br><span class="line">auditLogChan  <span class="keyword">chan</span> AuditLogEntry</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuditLogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">Timestamp time.Time</span><br><span class="line">Action    <span class="type">string</span></span><br><span class="line">UserID    <span class="type">string</span></span><br><span class="line">Target    <span class="type">string</span></span><br><span class="line">Result    <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–éšç§ç½‘å…³</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPrivacyGateway</span><span class="params">(db *gorm.DB, encryptionKey []<span class="type">byte</span>)</span></span> *PrivacyGateway &#123;</span><br><span class="line">gateway := &amp;PrivacyGateway&#123;</span><br><span class="line">db:            db,</span><br><span class="line">encryptionKey: encryptionKey,</span><br><span class="line">accessRules:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>),</span><br><span class="line">auditLogChan:  <span class="built_in">make</span>(<span class="keyword">chan</span> AuditLogEntry, <span class="number">100</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨å®¡è®¡æ—¥å¿—å¤„ç†å™¨</span></span><br><span class="line"><span class="keyword">go</span> gateway.processAuditLogs()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> gateway</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ¿ååŒ–æ‚£è€…ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> anonymizePatientID(patientID <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line">hash := sha256.Sum256([]<span class="type">byte</span>(patientID))</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(hash[:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AESåŠ å¯†æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> encryptData(data []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">block, err := aes.NewCipher(g.encryptionKey)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gcm, err := cipher.NewGCM(block)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nonce := <span class="built_in">make</span>([]<span class="type">byte</span>, gcm.NonceSize())</span><br><span class="line"><span class="keyword">if</span> _, err = io.ReadFull(rand.Reader, nonce); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ciphertext := gcm.Seal(nonce, nonce, data, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">return</span> ciphertext, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†å¥åº·æ•°æ®è¯·æ±‚ - HEARTæ¶æ„çš„æ ¸å¿ƒAPI</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> handleHealthDataRequest(c *gin.Context) &#123;</span><br><span class="line"><span class="keyword">var</span> requestData <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := c.ShouldBindJSON(&amp;requestData); err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Invalid request format&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;request_failed&quot;</span>, <span class="string">&quot;unknown&quot;</span>, <span class="string">&quot;invalid_format&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–æ‚£è€…IDå¹¶åŒ¿ååŒ–</span></span><br><span class="line">patientID, ok := requestData[<span class="string">&quot;patient_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Missing patient_id&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;request_failed&quot;</span>, <span class="string">&quot;unknown&quot;</span>, <span class="string">&quot;missing_patient_id&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hashedPatientID := g.anonymizePatientID(patientID)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥è®¿é—®æƒé™</span></span><br><span class="line">userID := c.GetString(<span class="string">&quot;user_id&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> !g.checkAccessPermission(userID, <span class="string">&quot;submit_health_data&quot;</span>) &#123;</span><br><span class="line">c.JSON(http.StatusForbidden, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Access denied&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;access_denied&quot;</span>, userID, <span class="string">&quot;submit_health_data&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åºåˆ—åŒ–å¹¶åŠ å¯†æ•°æ®</span></span><br><span class="line">dataBytes, err := json.Marshal(requestData)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Data serialization failed&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;processing_failed&quot;</span>, userID, <span class="string">&quot;serialization_error&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">encryptedData, err := g.encryptData(dataBytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Encryption failed&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;processing_failed&quot;</span>, userID, <span class="string">&quot;encryption_error&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿å­˜åˆ°æ•°æ®åº“</span></span><br><span class="line">healthData := HealthData&#123;</span><br><span class="line">ID:        generateUUID(),</span><br><span class="line">PatientID: patientID,</span><br><span class="line">HashedID:  hashedPatientID,</span><br><span class="line">DataType:  requestData[<span class="string">&quot;data_type&quot;</span>].(<span class="type">string</span>),</span><br><span class="line">RawData:   encryptedData,</span><br><span class="line">Timestamp: time.Now(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := g.db.Create(&amp;healthData).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Database error&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;storage_failed&quot;</span>, userID, <span class="string">&quot;database_error&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•æˆåŠŸæ“ä½œ</span></span><br><span class="line">g.logAudit(<span class="string">&quot;data_submitted&quot;</span>, userID, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>, <span class="string">&quot;data_id&quot;</span>: healthData.ID&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥è®¿é—®æƒé™</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> checkAccessPermission(userID <span class="type">string</span>, action <span class="type">string</span>) <span class="type">bool</span> &#123;</span><br><span class="line">permissions, exists := g.accessRules[userID]</span><br><span class="line"><span class="keyword">if</span> !exists &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, perm := <span class="keyword">range</span> permissions &#123;</span><br><span class="line"><span class="keyword">if</span> perm == action &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¡è®¡æ—¥å¿—è®°å½•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> logAudit(action, userID, result <span class="type">string</span>) &#123;</span><br><span class="line">logEntry := AuditLogEntry&#123;</span><br><span class="line">Timestamp: time.Now(),</span><br><span class="line">Action:    action,</span><br><span class="line">UserID:    userID,</span><br><span class="line">Result:    result,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> g.auditLogChan &lt;- logEntry:</span><br><span class="line"><span class="comment">// æ—¥å¿—å·²å‘é€åˆ°é€šé“</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">// é€šé“å·²æ»¡ï¼Œè®°å½•é”™è¯¯</span></span><br><span class="line">log.Printf(<span class="string">&quot;Audit log channel full, dropping entry: %+v&quot;</span>, logEntry)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åå°å¤„ç†å®¡è®¡æ—¥å¿—</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> processAuditLogs() &#123;</span><br><span class="line"><span class="keyword">for</span> entry := <span class="keyword">range</span> g.auditLogChan &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œå¯ä»¥å°†æ—¥å¿—å†™å…¥æ•°æ®åº“ã€æ–‡ä»¶æˆ–å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ</span></span><br><span class="line">log.Printf(<span class="string">&quot;AUDIT: %+v&quot;</span>, entry)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥å®ç°æŒä¹…åŒ–å­˜å‚¨</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼šg.db.Create(&amp;AuditLog&#123;...&#125;)</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”ŸæˆUUIDï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateUUID</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">b := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">16</span>)</span><br><span class="line">_, err := rand.Read(b)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%x-%x-%x-%x-%x&quot;</span>, b[<span class="number">0</span>:<span class="number">4</span>], b[<span class="number">4</span>:<span class="number">6</span>], b[<span class="number">6</span>:<span class="number">8</span>], b[<span class="number">8</span>:<span class="number">10</span>], b[<span class="number">10</span>:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸»å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼ˆè¿™é‡Œä½¿ç”¨ä¼ªä»£ç ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> db *gorm.DB</span><br><span class="line"><span class="comment">// db = initializeDatabase()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”ŸæˆåŠ å¯†å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥ä»å®‰å…¨å­˜å‚¨ä¸­è·å–ï¼‰</span></span><br><span class="line">encryptionKey := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">32</span>)</span><br><span class="line"><span class="keyword">if</span> _, err := rand.Read(encryptionKey); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;Failed to generate encryption key&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºéšç§ç½‘å…³</span></span><br><span class="line">gateway := NewPrivacyGateway(db, encryptionKey)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®è®¿é—®è§„åˆ™</span></span><br><span class="line">gateway.accessRules[<span class="string">&quot;doctor_123&quot;</span>] = []<span class="type">string</span>&#123;<span class="string">&quot;view_diagnosis&quot;</span>, <span class="string">&quot;submit_health_data&quot;</span>, <span class="string">&quot;view_vitals&quot;</span>&#125;</span><br><span class="line">gateway.accessRules[<span class="string">&quot;nurse_456&quot;</span>] = []<span class="type">string</span>&#123;<span class="string">&quot;view_vitals&quot;</span>, <span class="string">&quot;submit_health_data&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®Ginè·¯ç”±å™¨</span></span><br><span class="line">r := gin.Default()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¥åº·æ•°æ®ç«¯ç‚¹</span></span><br><span class="line">r.POST(<span class="string">&quot;/api/health-data&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œåº”è¯¥å®ç°èº«ä»½éªŒè¯ï¼Œè®¾ç½®user_idåˆ°ä¸Šä¸‹æ–‡ä¸­</span></span><br><span class="line">c.Set(<span class="string">&quot;user_id&quot;</span>, <span class="string">&quot;doctor_123&quot;</span>) <span class="comment">// ç¤ºä¾‹ï¼Œå®é™…åº”è¯¥ä»tokenä¸­è§£æ</span></span><br><span class="line">gateway.handleHealthDataRequest(c)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">log.Println(<span class="string">&quot;Privacy Gateway Server starting on :8080&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err := r.Run(<span class="string">&quot;:8080&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;Server failed to start:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚"><a href="#å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚" class="headerlink" title="å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚"></a>å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚</h2><h3 id="1-åŒæ€åŠ å¯†æ”¯æŒ"><a href="#1-åŒæ€åŠ å¯†æ”¯æŒ" class="headerlink" title="1. åŒæ€åŠ å¯†æ”¯æŒ"></a>1. åŒæ€åŠ å¯†æ”¯æŒ</h3><p>ä¸ºäº†åœ¨åŠ å¯†æ•°æ®ä¸Šç›´æ¥è¿›è¡ŒAIè®¡ç®—ï¼Œæˆ‘ä»¬å¯ä»¥é›†æˆåŒæ€åŠ å¯†åº“ã€‚ä»¥ä¸‹æ˜¯Pythonç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> phe <span class="keyword">import</span> paillier  <span class="comment"># PythonåŒæ€åŠ å¯†åº“</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HomomorphicAIProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.public_key, self.private_key = paillier.generate_paillier_keypair()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt_vitals</span>(<span class="params">self, systolic, diastolic</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ å¯†è¡€å‹æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        encrypted_systolic = self.public_key.encrypt(systolic)</span><br><span class="line">        encrypted_diastolic = self.public_key.encrypt(diastolic)</span><br><span class="line">        <span class="keyword">return</span> encrypted_systolic, encrypted_diastolic</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_risk</span>(<span class="params">self, encrypted_systolic, encrypted_diastolic</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åœ¨åŠ å¯†æ•°æ®ä¸Šè¿›è¡Œé£é™©åˆ†æ</span></span><br><span class="line"><span class="string">        ä¾‹å¦‚ï¼šè®¡ç®— (systolic + diastolic) / 2</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        encrypted_avg = (encrypted_systolic + encrypted_diastolic) * <span class="number">0.5</span></span><br><span class="line">        <span class="keyword">return</span> encrypted_avg</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_result</span>(<span class="params">self, encrypted_result</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†åˆ†æç»“æœï¼ˆä»…åœ¨æˆæƒæ—¶ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.private_key.decrypt(encrypted_result)</span><br></pre></td></tr></table></figure><h3 id="2-éšç§ä¿æŠ¤æœºå™¨å­¦ä¹ "><a href="#2-éšç§ä¿æŠ¤æœºå™¨å­¦ä¹ " class="headerlink" title="2. éšç§ä¿æŠ¤æœºå™¨å­¦ä¹ "></a>2. éšç§ä¿æŠ¤æœºå™¨å­¦ä¹ </h3><p>ä½¿ç”¨è”é‚¦å­¦ä¹ æŠ€æœ¯ï¼Œåœ¨ä¸å…±äº«åŸå§‹æ•°æ®çš„æƒ…å†µä¸‹è®­ç»ƒAIæ¨¡å‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow_federated <span class="keyword">as</span> tff</span><br><span class="line"></span><br><span class="line"><span class="comment"># HEARTæ¶æ„ä¸­çš„è”é‚¦å­¦ä¹ å®ç°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_federated_model</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ›å»ºéšç§ä¿æŠ¤çš„è”é‚¦å­¦ä¹ æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">model_fn</span>():</span><br><span class="line">        model = tf.keras.models.Sequential([</span><br><span class="line">            tf.keras.layers.Dense(<span class="number">64</span>, activation=<span class="string">&#x27;relu&#x27;</span>, input_shape=(<span class="number">10</span>,)),</span><br><span class="line">            tf.keras.layers.Dense(<span class="number">32</span>, activation=<span class="string">&#x27;relu&#x27;</span>),</span><br><span class="line">            tf.keras.layers.Dense(<span class="number">1</span>, activation=<span class="string">&#x27;sigmoid&#x27;</span>)</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> tff.learning.from_keras_model(</span><br><span class="line">            model,</span><br><span class="line">            input_spec=...,</span><br><span class="line">            loss=tf.keras.losses.BinaryCrossentropy(),</span><br><span class="line">            metrics=[tf.keras.metrics.BinaryAccuracy()]</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> model_fn</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HeartFederatedLearning</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.model_fn = create_federated_model()</span><br><span class="line">        self.iterative_process = tff.learning.build_federated_averaging_process(</span><br><span class="line">            self.model_fn,</span><br><span class="line">            client_optimizer_fn=<span class="keyword">lambda</span>: tf.keras.optimizers.Adam(learning_rate=<span class="number">0.01</span>),</span><br><span class="line">            server_optimizer_fn=<span class="keyword">lambda</span>: tf.keras.optimizers.Adam(learning_rate=<span class="number">0.01</span>)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train_on_local_data</span>(<span class="params">self, client_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åœ¨æœ¬åœ°æ•°æ®ä¸Šè®­ç»ƒï¼Œä¸ä¸Šä¼ åŸå§‹æ•°æ®</span></span><br><span class="line"><span class="string">        ç¬¦åˆHEARTæ¶æ„çš„æ•°æ®æœ€å°åŒ–åŸåˆ™</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        state = self.iterative_process.initialize()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è”é‚¦å­¦ä¹ è®­ç»ƒè½®æ¬¡</span></span><br><span class="line">        <span class="keyword">for</span> round_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">            state, metrics = self.iterative_process.<span class="built_in">next</span>(state, [client_data])</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Round <span class="subst">&#123;round_num&#125;</span>: <span class="subst">&#123;metrics&#125;</span>&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure><h3 id="3-åŒºå—é“¾å®¡è®¡æ—¥å¿—"><a href="#3-åŒºå—é“¾å®¡è®¡æ—¥å¿—" class="headerlink" title="3. åŒºå—é“¾å®¡è®¡æ—¥å¿—"></a>3. åŒºå—é“¾å®¡è®¡æ—¥å¿—</h3><p>ä½¿ç”¨åŒºå—é“¾æŠ€æœ¯ç¡®ä¿å®¡è®¡æ—¥å¿—çš„ä¸å¯ç¯¡æ”¹æ€§ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> blockchainaudit</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">Timestamp    time.Time</span><br><span class="line">AuditEntries []AuditLogEntry</span><br><span class="line">PrevHash     <span class="type">string</span></span><br><span class="line">Hash         <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Blockchain <span class="keyword">struct</span> &#123;</span><br><span class="line">chain []*Block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuditLogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">Action    <span class="type">string</span></span><br><span class="line">UserID    <span class="type">string</span></span><br><span class="line">Target    <span class="type">string</span></span><br><span class="line">Timestamp time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Block)</span></span> calculateHash() <span class="type">string</span> &#123;</span><br><span class="line">record := b.Timestamp.String() + b.PrevHash</span><br><span class="line"><span class="keyword">for</span> _, entry := <span class="keyword">range</span> b.AuditEntries &#123;</span><br><span class="line">record += entry.Action + entry.UserID + entry.Target + entry.Timestamp.String()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">h := sha256.New()</span><br><span class="line">h.Write([]<span class="type">byte</span>(record))</span><br><span class="line">hashed := h.Sum(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(hashed)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *Blockchain)</span></span> addBlock(entries []AuditLogEntry) &#123;</span><br><span class="line">prevBlock := bc.chain[<span class="built_in">len</span>(bc.chain)<span class="number">-1</span>]</span><br><span class="line">newBlock := &amp;Block&#123;</span><br><span class="line">Timestamp:    time.Now(),</span><br><span class="line">AuditEntries: entries,</span><br><span class="line">PrevHash:     prevBlock.Hash,</span><br><span class="line">&#125;</span><br><span class="line">newBlock.Hash = newBlock.calculateHash()</span><br><span class="line">bc.chain = <span class="built_in">append</span>(bc.chain, newBlock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize blockchain with genesis block</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockchain</span><span class="params">()</span></span> *Blockchain &#123;</span><br><span class="line">genesisBlock := &amp;Block&#123;</span><br><span class="line">Timestamp:    time.Now(),</span><br><span class="line">AuditEntries: []AuditLogEntry&#123;&#125;,</span><br><span class="line">PrevHash:     <span class="string">&quot;0&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">genesisBlock.Hash = genesisBlock.calculateHash()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;Blockchain&#123;chain: []*Block&#123;genesisBlock&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¶æ„éªŒè¯ä¸æµ‹è¯•"><a href="#æ¶æ„éªŒè¯ä¸æµ‹è¯•" class="headerlink" title="æ¶æ„éªŒè¯ä¸æµ‹è¯•"></a>æ¶æ„éªŒè¯ä¸æµ‹è¯•</h2><h3 id="éšç§ä¿æŠ¤æµ‹è¯•ç”¨ä¾‹"><a href="#éšç§ä¿æŠ¤æµ‹è¯•ç”¨ä¾‹" class="headerlink" title="éšç§ä¿æŠ¤æµ‹è¯•ç”¨ä¾‹"></a>éšç§ä¿æŠ¤æµ‹è¯•ç”¨ä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> privacy_protected_health_data <span class="keyword">import</span> PrivacyProtectedHealthData</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestHEARTArchitecture</span>(unittest.TestCase):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.privacy_processor = PrivacyProtectedHealthData()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_data_anonymization</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•æ•°æ®åŒ¿ååŒ–åŠŸèƒ½&quot;&quot;&quot;</span></span><br><span class="line">        patient_data = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;å¼ ä¸‰&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ssn&quot;</span>: <span class="string">&quot;110101199001011234&quot;</span>,</span><br><span class="line">            <span class="string">&quot;birth_date&quot;</span>: <span class="string">&quot;1990-01-01&quot;</span>,</span><br><span class="line">            <span class="string">&quot;zip_code&quot;</span>: <span class="string">&quot;100000&quot;</span>,</span><br><span class="line">            <span class="string">&quot;diagnosis&quot;</span>: <span class="string">&quot;ç³–å°¿ç—…&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        anonymized = self.privacy_processor.anonymize_patient_data(patient_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯ç›´æ¥æ ‡è¯†ç¬¦å·²è¢«ç§»é™¤</span></span><br><span class="line">        self.assertNotIn(<span class="string">&quot;name&quot;</span>, anonymized)</span><br><span class="line">        self.assertNotIn(<span class="string">&quot;ssn&quot;</span>, anonymized)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯é—´æ¥æ ‡è¯†ç¬¦å·²è¢«å“ˆå¸Œå¤„ç†</span></span><br><span class="line">        self.assertIn(<span class="string">&quot;hashed_birth_date&quot;</span>, anonymized)</span><br><span class="line">        self.assertIn(<span class="string">&quot;hashed_zip_code&quot;</span>, anonymized)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯åŒ»ç–—æ•°æ®ä¿ç•™</span></span><br><span class="line">        self.assertIn(<span class="string">&quot;diagnosis&quot;</span>, anonymized)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_access_control</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•è®¿é—®æ§åˆ¶åŠŸèƒ½&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è®¾ç½®åŒ»ç”Ÿæƒé™</span></span><br><span class="line">        self.privacy_processor.set_access_control(<span class="string">&quot;doctor_123&quot;</span>, [<span class="string">&quot;view_diagnosis&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯åŒ»ç”Ÿå¯ä»¥è®¿é—®è¯Šæ–­</span></span><br><span class="line">        self.assertTrue(self.privacy_processor.check_access_permission(<span class="string">&quot;doctor_123&quot;</span>, <span class="string">&quot;view_diagnosis&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯åŒ»ç”Ÿä¸èƒ½è®¿é—®SSN</span></span><br><span class="line">        self.assertFalse(self.privacy_processor.check_access_permission(<span class="string">&quot;doctor_123&quot;</span>, <span class="string">&quot;view_ssn&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯æœªçŸ¥ç”¨æˆ·æ— æƒé™</span></span><br><span class="line">        self.assertFalse(self.privacy_processor.check_access_permission(<span class="string">&quot;unknown_user&quot;</span>, <span class="string">&quot;view_diagnosis&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²ä¸è¿ç»´å»ºè®®"><a href="#éƒ¨ç½²ä¸è¿ç»´å»ºè®®" class="headerlink" title="éƒ¨ç½²ä¸è¿ç»´å»ºè®®"></a>éƒ¨ç½²ä¸è¿ç»´å»ºè®®</h2><h3 id="1-å®‰å…¨éƒ¨ç½²å®è·µ"><a href="#1-å®‰å…¨éƒ¨ç½²å®è·µ" class="headerlink" title="1. å®‰å…¨éƒ¨ç½²å®è·µ"></a>1. å®‰å…¨éƒ¨ç½²å®è·µ</h3><ul><li><strong>é›¶ä¿¡ä»»æ¶æ„</strong>ï¼šæ‰€æœ‰ç½‘ç»œè¯·æ±‚éƒ½å¿…é¡»ç»è¿‡èº«ä»½éªŒè¯å’Œæˆæƒ</li><li><strong>å®¹å™¨åŒ–éƒ¨ç½²</strong>ï¼šä½¿ç”¨Dockerå’ŒKubernetesï¼Œç¡®ä¿ç¯å¢ƒéš”ç¦»</li><li><strong>åŸºç¡€è®¾æ–½å³ä»£ç </strong>ï¼šä½¿ç”¨Terraformæˆ–CloudFormationå®šä¹‰å®‰å…¨åŸºç¡€è®¾æ–½</li></ul><h3 id="2-æŒç»­ç›‘æ§ä¸æ”¹è¿›"><a href="#2-æŒç»­ç›‘æ§ä¸æ”¹è¿›" class="headerlink" title="2. æŒç»­ç›‘æ§ä¸æ”¹è¿›"></a>2. æŒç»­ç›‘æ§ä¸æ”¹è¿›</h3><ul><li><strong>å®æ—¶éšç§ç›‘æ§</strong>ï¼šéƒ¨ç½²å¼‚å¸¸æ£€æµ‹ç³»ç»Ÿï¼Œç›‘æ§å¼‚å¸¸æ•°æ®è®¿é—®æ¨¡å¼</li><li><strong>å®šæœŸéšç§å®¡è®¡</strong>ï¼šæ¯å­£åº¦è¿›è¡Œç¬¬ä¸‰æ–¹éšç§å®¡è®¡</li><li><strong>ç”¨æˆ·åé¦ˆå¾ªç¯</strong>ï¼šå»ºç«‹ç”¨æˆ·éšç§åé¦ˆæœºåˆ¶ï¼ŒæŒç»­æ”¹è¿›</li></ul><h3 id="3-ç¾éš¾æ¢å¤è®¡åˆ’"><a href="#3-ç¾éš¾æ¢å¤è®¡åˆ’" class="headerlink" title="3. ç¾éš¾æ¢å¤è®¡åˆ’"></a>3. ç¾éš¾æ¢å¤è®¡åˆ’</h3><ul><li><strong>åŠ å¯†å¯†é’¥ç®¡ç†</strong>ï¼šä½¿ç”¨äº‘KMSæˆ–ç¡¬ä»¶å®‰å…¨æ¨¡å—(HSM)ç®¡ç†å¯†é’¥</li><li><strong>æ•°æ®å¤‡ä»½ç­–ç•¥</strong>ï¼šåŠ å¯†å¤‡ä»½ï¼Œå¤šåœ°å­˜å‚¨</li><li><strong>äº‹ä»¶å“åº”è®¡åˆ’</strong>ï¼šåˆ¶å®šæ•°æ®æ³„éœ²å“åº”æµç¨‹</li></ul><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>HEARTæ¶æ„ä¸ºAIå¥åº·åº”ç”¨æä¾›äº†ä¸€ä¸ªå…¨é¢çš„éšç§ä¿æŠ¤æ¡†æ¶ï¼Œé€šè¿‡å°†éšç§ä¿æŠ¤åŸåˆ™åµŒå…¥åˆ°ç³»ç»Ÿè®¾è®¡çš„æ¯ä¸ªå±‚é¢ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æä¾›å¼ºå¤§AIåŠŸèƒ½çš„åŒæ—¶ï¼Œå……åˆ†ä¿æŠ¤ç”¨æˆ·å¥åº·æ•°æ®éšç§ã€‚</p><p>è¯¥æ¶æ„çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š</p><ul><li><strong>æŠ€æœ¯ä¸ä¼¦ç†å¹¶é‡</strong>ï¼šä¸ä»…å…³æ³¨æŠ€æœ¯å®ç°ï¼Œæ›´é‡è§†ä¼¦ç†è€ƒé‡</li><li><strong>ä¸»åŠ¨è€Œéè¢«åŠ¨</strong>ï¼šä»è®¾è®¡ä¹‹åˆå°±è€ƒè™‘éšç§ï¼Œè€Œéäº‹åè¡¥æ•‘</li><li><strong>ç”¨æˆ·ä¸ºä¸­å¿ƒ</strong>ï¼šèµ‹äºˆç”¨æˆ·å¯¹å…¶å¥åº·æ•°æ®çš„æ§åˆ¶æƒ</li><li><strong>åˆè§„ä¸åˆ›æ–°å¹³è¡¡</strong>ï¼šåœ¨æ»¡è¶³æ³•è§„è¦æ±‚çš„åŒæ—¶ï¼Œæ”¯æŒæŠ€æœ¯åˆ›æ–°</li></ul><p>é€šè¿‡Pythonå’ŒGoçš„å…·ä½“ä»£ç å®ç°ï¼Œå¼€å‘è€…å¯ä»¥çœ‹åˆ°HEARTæ¶æ„å¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­è½åœ°ã€‚è¿™å¥—æ¶æ„ä¸ä»…é€‚ç”¨äºåŒ»ç–—å¥åº·é¢†åŸŸï¼Œä¹Ÿå¯ä»¥æ‰©å±•åˆ°å…¶ä»–éœ€è¦é«˜éšç§ä¿æŠ¤çš„AIåº”ç”¨åœºæ™¯ã€‚</p><p>åœ¨AIæŠ€æœ¯å¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œéšç§ä¿æŠ¤ä¸åº”æˆä¸ºåˆ›æ–°çš„éšœç¢ï¼Œè€Œåº”æˆä¸ºäº§å“ç«äº‰åŠ›çš„æ ¸å¿ƒè¦ç´ ã€‚HEARTæ¶æ„æ­£æ˜¯è¿™æ ·ä¸€ç§å°†éšç§ä¿æŠ¤è½¬åŒ–ä¸ºç«äº‰ä¼˜åŠ¿çš„è®¾è®¡ç†å¿µã€‚</p><hr><h2 id="åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ€è·¯æ¢è®¨"><a href="#åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ€è·¯æ¢è®¨" class="headerlink" title="åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ€è·¯æ¢è®¨"></a>åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ€è·¯æ¢è®¨</h2><p>HEARTæ¶æ„ï¼ˆHealth Data Protection, Ethical AI Processing, Access Control &amp; Authentication, Regulatory Compliance, Transparency &amp; Traceabilityï¼‰å°†æ•°æ®éšç§ä¿æŠ¤ç½®äºæ ¸å¿ƒä½ç½®ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨HEARTæ¶æ„ä¸­å®ç°å¼ºå¤§çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶æœºåˆ¶ã€‚</p><h3 id="ä¸€ã€æ•°æ®åŠ å¯†ç­–ç•¥"><a href="#ä¸€ã€æ•°æ®åŠ å¯†ç­–ç•¥" class="headerlink" title="ä¸€ã€æ•°æ®åŠ å¯†ç­–ç•¥"></a>ä¸€ã€æ•°æ®åŠ å¯†ç­–ç•¥</h3><h4 id="1-1-å¤šå±‚åŠ å¯†æ¶æ„"><a href="#1-1-å¤šå±‚åŠ å¯†æ¶æ„" class="headerlink" title="1.1 å¤šå±‚åŠ å¯†æ¶æ„"></a>1.1 å¤šå±‚åŠ å¯†æ¶æ„</h4><p>åœ¨HEARTæ¶æ„ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨åˆ†å±‚åŠ å¯†ç­–ç•¥ï¼Œé’ˆå¯¹ä¸åŒæ•°æ®æ•æ„Ÿåº¦å’Œä½¿ç”¨åœºæ™¯é‡‡ç”¨ä¸åŒçš„åŠ å¯†æŠ€æœ¯ï¼š</p><h5 id="1-1-1-é™æ€æ•°æ®åŠ å¯†ï¼ˆAES-GCMï¼‰"><a href="#1-1-1-é™æ€æ•°æ®åŠ å¯†ï¼ˆAES-GCMï¼‰" class="headerlink" title="1.1.1 é™æ€æ•°æ®åŠ å¯†ï¼ˆAES-GCMï¼‰"></a>1.1.1 é™æ€æ•°æ®åŠ å¯†ï¼ˆAES-GCMï¼‰</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers.aead <span class="keyword">import</span> AESGCM</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTDataEncryptor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–åŠ å¯†å™¨ï¼Œä½¿ç”¨AES-GCMç®—æ³•&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># ç”Ÿæˆ256ä½å¯†é’¥</span></span><br><span class="line">            self.key = AESGCM.generate_key(bit_length=<span class="number">256</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.key = key</span><br><span class="line">        self.aesgcm = AESGCM(self.key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt_health_record</span>(<span class="params">self, plaintext_data, patient_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä½¿ç”¨AES-GCMåŠ å¯†å¥åº·è®°å½•</span></span><br><span class="line"><span class="string">        AES-GCMæä¾›è®¤è¯åŠ å¯†ï¼Œå¯ä»¥ä¿æŠ¤æ•°æ®å…å—ç¯¡æ”¹ã€é‡æ”¾æ”»å‡»å’Œæœªæˆæƒè®¿é—® </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ç”Ÿæˆ12å­—èŠ‚çš„éšæœºnonce</span></span><br><span class="line">        nonce = os.urandom(<span class="number">12</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ å…³è”æ•°æ®ï¼ˆæ‚£è€…IDï¼‰ï¼Œç”¨äºè®¤è¯ä½†ä¸åŠ å¯†</span></span><br><span class="line">        associated_data = <span class="string">f&quot;patient:<span class="subst">&#123;patient_id&#125;</span>&quot;</span>.encode()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŠ å¯†æ•°æ®</span></span><br><span class="line">        ciphertext = self.aesgcm.encrypt(</span><br><span class="line">            nonce,</span><br><span class="line">            plaintext_data.encode(),</span><br><span class="line">            associated_data</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿”å›åŠ å¯†æ•°æ®å’Œå…ƒæ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;nonce&#x27;</span>: base64.b64encode(nonce).decode(),</span><br><span class="line">            <span class="string">&#x27;ciphertext&#x27;</span>: base64.b64encode(ciphertext).decode(),</span><br><span class="line">            <span class="string">&#x27;patient_id&#x27;</span>: patient_id,</span><br><span class="line">            <span class="string">&#x27;associated_data&#x27;</span>: base64.b64encode(associated_data).decode()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_health_record</span>(<span class="params">self, encrypted_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†å¥åº·è®°å½•&quot;&quot;&quot;</span></span><br><span class="line">        nonce = base64.b64decode(encrypted_data[<span class="string">&#x27;nonce&#x27;</span>])</span><br><span class="line">        ciphertext = base64.b64decode(encrypted_data[<span class="string">&#x27;ciphertext&#x27;</span>])</span><br><span class="line">        associated_data = base64.b64decode(encrypted_data[<span class="string">&#x27;associated_data&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        plaintext = self.aesgcm.decrypt(</span><br><span class="line">            nonce,</span><br><span class="line">            ciphertext,</span><br><span class="line">            associated_data</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> plaintext.decode()</span><br></pre></td></tr></table></figure><h5 id="1-1-2-ä¼ è¾“ä¸­æ•°æ®åŠ å¯†ï¼ˆTLS-1-3-QUICï¼‰"><a href="#1-1-2-ä¼ è¾“ä¸­æ•°æ®åŠ å¯†ï¼ˆTLS-1-3-QUICï¼‰" class="headerlink" title="1.1.2 ä¼ è¾“ä¸­æ•°æ®åŠ å¯†ï¼ˆTLS 1.3 + QUICï¼‰"></a>1.1.2 ä¼ è¾“ä¸­æ•°æ®åŠ å¯†ï¼ˆTLS 1.3 + QUICï¼‰</h5><p>å¯¹äºæ•°æ®ä¼ è¾“ï¼ŒHEARTæ¶æ„è¦æ±‚ä½¿ç”¨TLS 1.3æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå¹¶ç»“åˆQUICåè®®æé«˜æ€§èƒ½å’Œå®‰å…¨æ€§ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">from</span> httpx <span class="keyword">import</span> AsyncClient</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTSecureClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, api_base_url</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–å®‰å…¨å®¢æˆ·ç«¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é…ç½®TLS 1.3</span></span><br><span class="line">        ssl_context = ssl.create_default_context()</span><br><span class="line">        ssl_context.minimum_version = ssl.TLSVersion.TLSv1_3</span><br><span class="line">        </span><br><span class="line">        self.client = AsyncClient(</span><br><span class="line">            base_url=api_base_url,</span><br><span class="line">            verify=ssl_context,</span><br><span class="line">            http2=<span class="literal">True</span>,</span><br><span class="line">            timeout=<span class="number">30.0</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_encrypted_health_data</span>(<span class="params">self, patient_id, health_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‘é€åŠ å¯†çš„å¥åº·æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é¦–å…ˆä½¿ç”¨AES-GCMåŠ å¯†æ•°æ®</span></span><br><span class="line">        encryptor = HEARTDataEncryptor()</span><br><span class="line">        encrypted_payload = encryptor.encrypt_health_record(</span><br><span class="line">            json.dumps(health_data), </span><br><span class="line">            patient_id</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é€šè¿‡TLS 1.3é€šé“å‘é€</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;X-HEART-Request-ID&#x27;</span>: generate_request_id(),</span><br><span class="line">            <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">f&#x27;Bearer <span class="subst">&#123;get_auth_token()&#125;</span>&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response = <span class="keyword">await</span> self.client.post(</span><br><span class="line">            <span class="string">&#x27;/api/v1/health-data&#x27;</span>,</span><br><span class="line">            json=encrypted_payload,</span><br><span class="line">            headers=headers</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> response.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">f&quot;Data transmission failed: <span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response.json()</span><br></pre></td></tr></table></figure><h5 id="1-1-3-åŒæ€åŠ å¯†ç”¨äºAIå¤„ç†"><a href="#1-1-3-åŒæ€åŠ å¯†ç”¨äºAIå¤„ç†" class="headerlink" title="1.1.3 åŒæ€åŠ å¯†ç”¨äºAIå¤„ç†"></a>1.1.3 åŒæ€åŠ å¯†ç”¨äºAIå¤„ç†</h5><p>ä¸ºäº†åœ¨ä¿æŠ¤éšç§çš„åŒæ—¶å…è®¸AIæ¨¡å‹å¤„ç†åŠ å¯†æ•°æ®ï¼ŒHEARTæ¶æ„é›†æˆäº†åŒæ€åŠ å¯†æŠ€æœ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> phe <span class="keyword">import</span> paillier  <span class="comment"># PythonåŒæ€åŠ å¯†åº“</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTHomoMorphicProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–åŒæ€åŠ å¯†å¤„ç†å™¨&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ç”Ÿæˆå¯†é’¥å¯¹</span></span><br><span class="line">        self.public_key, self.private_key = paillier.generate_paillier_keypair()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt_vital_signs</span>(<span class="params">self, vital_signs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä½¿ç”¨åŒæ€åŠ å¯†åŠ å¯†ç”Ÿå‘½ä½“å¾æ•°æ®</span></span><br><span class="line"><span class="string">        åŒæ€åŠ å¯†å…è®¸åœ¨åŠ å¯†æ•°æ®ä¸Šç›´æ¥è¿›è¡Œè®¡ç®—ï¼Œä¿æŠ¤æ•æ„Ÿçš„åŒ»ç–—ä¿¡æ¯ </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        encrypted_vitals = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> vital_signs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">                encrypted_vitals[key] = self.public_key.encrypt(value)</span><br><span class="line">        <span class="keyword">return</span> encrypted_vitals</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_health_risk_on_encrypted_data</span>(<span class="params">self, encrypted_vitals</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åœ¨åŠ å¯†æ•°æ®ä¸Šè®¡ç®—å¥åº·é£é™©</span></span><br><span class="line"><span class="string">        ä¾‹å¦‚ï¼šè®¡ç®—å¿ƒè¡€ç®¡é£é™©æŒ‡æ•° = 0.3*è¡€å‹ + 0.4*å¿ƒç‡ + 0.3*è¡€ç³–</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å‡è®¾æˆ‘ä»¬æœ‰åŠ å¯†çš„è¡€å‹ã€å¿ƒç‡å’Œè¡€ç³–æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;blood_pressure&#x27;</span> <span class="keyword">in</span> encrypted_vitals <span class="keyword">and</span> <span class="string">&#x27;heart_rate&#x27;</span> <span class="keyword">in</span> encrypted_vitals:</span><br><span class="line">            <span class="comment"># åŒæ€è®¡ç®—ï¼šrisk = 0.3*bp + 0.4*hr</span></span><br><span class="line">            risk_score = (encrypted_vitals[<span class="string">&#x27;blood_pressure&#x27;</span>] * <span class="number">0.3</span>) + (encrypted_vitals[<span class="string">&#x27;heart_rate&#x27;</span>] * <span class="number">0.4</span>)</span><br><span class="line">            <span class="keyword">return</span> risk_score</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_risk_score</span>(<span class="params">self, encrypted_risk_score</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†é£é™©è¯„åˆ†&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.private_key.decrypt(encrypted_risk_score)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">processor = HEARTHomoMorphicProcessor()</span><br><span class="line">vital_signs = &#123;<span class="string">&#x27;blood_pressure&#x27;</span>: <span class="number">130</span>, <span class="string">&#x27;heart_rate&#x27;</span>: <span class="number">75</span>, <span class="string">&#x27;glucose&#x27;</span>: <span class="number">95</span>&#125;</span><br><span class="line">encrypted_vitals = processor.encrypt_vital_signs(vital_signs)</span><br><span class="line">encrypted_risk = processor.compute_health_risk_on_encrypted_data(encrypted_vitals)</span><br><span class="line">risk_score = processor.decrypt_risk_score(encrypted_risk)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;å¥åº·é£é™©è¯„åˆ†: <span class="subst">&#123;risk_score&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="1-2-å¯†é’¥ç®¡ç†ç­–ç•¥"><a href="#1-2-å¯†é’¥ç®¡ç†ç­–ç•¥" class="headerlink" title="1.2 å¯†é’¥ç®¡ç†ç­–ç•¥"></a>1.2 å¯†é’¥ç®¡ç†ç­–ç•¥</h4><p>HEARTæ¶æ„é‡‡ç”¨åˆ†å±‚å¯†é’¥ç®¡ç†ï¼Œç¡®ä¿å¯†é’¥å®‰å…¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> botocore.exceptions <span class="keyword">import</span> ClientError</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTKeyManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, kms_key_id=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–å¯†é’¥ç®¡ç†å™¨ï¼Œä½¿ç”¨AWS KMSæˆ–æœ¬åœ°å®‰å…¨å­˜å‚¨&quot;&quot;&quot;</span></span><br><span class="line">        self.kms_client = boto3.client(<span class="string">&#x27;kms&#x27;</span>)</span><br><span class="line">        self.kms_key_id = kms_key_id <span class="keyword">or</span> os.getenv(<span class="string">&#x27;HEART_KMS_KEY_ID&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.kms_key_id:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;KMS key ID is required&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_data_key</span>(<span class="params">self, key_spec=<span class="string">&#x27;AES_256&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ç”Ÿæˆæ•°æ®å¯†é’¥ï¼Œä½¿ç”¨KMSè¿›è¡Œå¯†é’¥ç®¡ç†</span></span><br><span class="line"><span class="string">        ä¿è¯å¯†é’¥çš„å®‰å…¨æ€§å’Œåˆè§„æ€§</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = self.kms_client.generate_data_key(</span><br><span class="line">                KeyId=self.kms_key_id,</span><br><span class="line">                KeySpec=key_spec,</span><br><span class="line">                NumberOfBytes=<span class="number">32</span>  <span class="comment"># 256 bits</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è¿”å›æ˜æ–‡å¯†é’¥å’Œå¯†æ–‡å¯†é’¥</span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;plaintext_key&#x27;</span>: response[<span class="string">&#x27;Plaintext&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;ciphertext_key&#x27;</span>: response[<span class="string">&#x27;CiphertextBlob&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;key_id&#x27;</span>: response[<span class="string">&#x27;KeyId&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;KMS error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_data_key</span>(<span class="params">self, ciphertext_key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†æ•°æ®å¯†é’¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = self.kms_client.decrypt(</span><br><span class="line">                CiphertextBlob=ciphertext_key</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> response[<span class="string">&#x27;Plaintext&#x27;</span>]</span><br><span class="line">        <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;KMS decryption error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rotate_keys</span>(<span class="params">self, old_key_id, new_key_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¯†é’¥è½®æ¢&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Rotating keys from <span class="subst">&#123;old_key_id&#125;</span> to <span class="subst">&#123;new_key_id&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># å®ç°å¯†é’¥è½®æ¢é€»è¾‘</span></span><br></pre></td></tr></table></figure><h3 id="äºŒã€è®¿é—®æ§åˆ¶å®ç°"><a href="#äºŒã€è®¿é—®æ§åˆ¶å®ç°" class="headerlink" title="äºŒã€è®¿é—®æ§åˆ¶å®ç°"></a>äºŒã€è®¿é—®æ§åˆ¶å®ç°</h3><h4 id="2-1-åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰"><a href="#2-1-åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰" class="headerlink" title="2.1 åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰"></a>2.1 åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰</h4><p>HEARTæ¶æ„é‡‡ç”¨åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„RBACæ›´çµæ´»ï¼Œæ›´é€‚åˆå¤æ‚åŒ»ç–—åœºæ™¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span>, <span class="type">Callable</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTAccessControl</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–è®¿é—®æ§åˆ¶å¼•æ“&quot;&quot;&quot;</span></span><br><span class="line">        self.policies = []</span><br><span class="line">        self.attribute_providers = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_attribute_provider</span>(<span class="params">self, attribute_name: <span class="built_in">str</span>, provider: <span class="type">Callable</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ³¨å†Œå±æ€§æä¾›è€…&quot;&quot;&quot;</span></span><br><span class="line">        self.attribute_providers[attribute_name] = provider</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_policy</span>(<span class="params">self, policy: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ·»åŠ è®¿é—®æ§åˆ¶ç­–ç•¥&quot;&quot;&quot;</span></span><br><span class="line">        self.policies.append(policy)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate_policy</span>(<span class="params">self, subject: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>], resource: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>], action: <span class="built_in">str</span>, context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¯„ä¼°è®¿é—®ç­–ç•¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> policy <span class="keyword">in</span> self.policies:</span><br><span class="line">            <span class="comment"># æ£€æŸ¥ç­–ç•¥æ¡ä»¶</span></span><br><span class="line">            conditions_met = <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥ä¸»ä½“æ¡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;subject_conditions&#x27;</span> <span class="keyword">in</span> policy:</span><br><span class="line">                <span class="keyword">for</span> attr, condition <span class="keyword">in</span> policy[<span class="string">&#x27;subject_conditions&#x27;</span>].items():</span><br><span class="line">                    <span class="keyword">if</span> attr <span class="keyword">in</span> subject:</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> self._evaluate_condition(subject[attr], condition):</span><br><span class="line">                            conditions_met = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥èµ„æºæ¡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;resource_conditions&#x27;</span> <span class="keyword">in</span> policy <span class="keyword">and</span> conditions_met:</span><br><span class="line">                <span class="keyword">for</span> attr, condition <span class="keyword">in</span> policy[<span class="string">&#x27;resource_conditions&#x27;</span>].items():</span><br><span class="line">                    <span class="keyword">if</span> attr <span class="keyword">in</span> resource:</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> self._evaluate_condition(resource[attr], condition):</span><br><span class="line">                            conditions_met = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥ç¯å¢ƒæ¡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;context_conditions&#x27;</span> <span class="keyword">in</span> policy <span class="keyword">and</span> conditions_met:</span><br><span class="line">                <span class="keyword">for</span> attr, condition <span class="keyword">in</span> policy[<span class="string">&#x27;context_conditions&#x27;</span>].items():</span><br><span class="line">                    <span class="keyword">if</span> attr <span class="keyword">in</span> context:</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> self._evaluate_condition(context[attr], condition):</span><br><span class="line">                            conditions_met = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥åŠ¨ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> conditions_met <span class="keyword">and</span> action <span class="keyword">in</span> policy.get(<span class="string">&#x27;allowed_actions&#x27;</span>, []):</span><br><span class="line">                <span class="keyword">return</span> policy.get(<span class="string">&#x27;effect&#x27;</span>, <span class="string">&#x27;deny&#x27;</span>) == <span class="string">&#x27;allow&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_evaluate_condition</span>(<span class="params">self, value, condition</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¯„ä¼°æ¡ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(condition, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;equals&#x27;</span> <span class="keyword">in</span> condition:</span><br><span class="line">                <span class="keyword">return</span> value == condition[<span class="string">&#x27;equals&#x27;</span>]</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;in&#x27;</span> <span class="keyword">in</span> condition:</span><br><span class="line">                <span class="keyword">return</span> value <span class="keyword">in</span> condition[<span class="string">&#x27;in&#x27;</span>]</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;greater_than&#x27;</span> <span class="keyword">in</span> condition:</span><br><span class="line">                <span class="keyword">return</span> value &gt; condition[<span class="string">&#x27;greater_than&#x27;</span>]</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;less_than&#x27;</span> <span class="keyword">in</span> condition:</span><br><span class="line">                <span class="keyword">return</span> value &lt; condition[<span class="string">&#x27;less_than&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> value == condition</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authorize_access</span>(<span class="params">self, user_token: <span class="built_in">str</span>, resource_id: <span class="built_in">str</span>, action: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æˆæƒè®¿é—®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># è§£æJWT token</span></span><br><span class="line">            payload = jwt.decode(user_token, options=&#123;<span class="string">&quot;verify_signature&quot;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–ç”¨æˆ·å±æ€§</span></span><br><span class="line">            subject = &#123;</span><br><span class="line">                <span class="string">&#x27;user_id&#x27;</span>: payload.get(<span class="string">&#x27;sub&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;role&#x27;</span>: payload.get(<span class="string">&#x27;role&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;department&#x27;</span>: payload.get(<span class="string">&#x27;department&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;clearance_level&#x27;</span>: payload.get(<span class="string">&#x27;clearance_level&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–èµ„æºå±æ€§</span></span><br><span class="line">            resource = self._get_resource_attributes(resource_id)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–ç¯å¢ƒä¸Šä¸‹æ–‡</span></span><br><span class="line">            context = &#123;</span><br><span class="line">                <span class="string">&#x27;time&#x27;</span>: time.time(),</span><br><span class="line">                <span class="string">&#x27;ip_address&#x27;</span>: self._get_client_ip(),</span><br><span class="line">                <span class="string">&#x27;device_type&#x27;</span>: self._get_device_type()</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è¯„ä¼°ç­–ç•¥</span></span><br><span class="line">            <span class="keyword">return</span> self.evaluate_policy(subject, resource, action, context)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Authorization error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_resource_attributes</span>(<span class="params">self, resource_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–èµ„æºå±æ€§ï¼ˆå®é™…å®ç°ä¸­åº”ä»æ•°æ®åº“æˆ–ç¼“å­˜ä¸­è·å–ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ¨¡æ‹Ÿèµ„æºå±æ€§</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;resource_id&#x27;</span>: resource_id,</span><br><span class="line">            <span class="string">&#x27;sensitivity_level&#x27;</span>: <span class="number">3</span>,  <span class="comment"># 1-5ï¼Œ5ä¸ºæœ€é«˜æ•æ„Ÿåº¦</span></span><br><span class="line">            <span class="string">&#x27;owner_department&#x27;</span>: <span class="string">&#x27;cardiology&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;data_type&#x27;</span>: <span class="string">&#x27;patient_vitals&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_client_ip</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–å®¢æˆ·ç«¯IPï¼ˆå®é™…å®ç°ä¸­åº”ä»è¯·æ±‚ä¸­è·å–ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;192.168.1.100&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_device_type</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–è®¾å¤‡ç±»å‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;mobile_app&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®HEARTè®¿é—®æ§åˆ¶ç­–ç•¥</span></span><br><span class="line">access_control = HEARTAccessControl()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ç­–ç•¥ï¼šåŒ»ç”Ÿåªèƒ½è®¿é—®æœ¬éƒ¨é—¨çš„æ‚£è€…æ•°æ®</span></span><br><span class="line">access_control.add_policy(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;department_access_policy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;subject_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;role&#x27;</span>: &#123;<span class="string">&#x27;equals&#x27;</span>: <span class="string">&#x27;doctor&#x27;</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;clearance_level&#x27;</span>: &#123;<span class="string">&#x27;greater_than&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;resource_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;sensitivity_level&#x27;</span>: &#123;<span class="string">&#x27;less_than&#x27;</span>: <span class="number">5</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;owner_department&#x27;</span>: &#123;<span class="string">&#x27;equals&#x27;</span>: <span class="string">&#x27;$&#123;subject.department&#125;&#x27;</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;context_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;time&#x27;</span>: &#123;<span class="string">&#x27;less_than&#x27;</span>: time.time() + <span class="number">3600</span>&#125;  <span class="comment"># 1å°æ—¶å†…æœ‰æ•ˆ</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;allowed_actions&#x27;</span>: [<span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;update&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;effect&#x27;</span>: <span class="string">&#x27;allow&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ç­–ç•¥ï¼šæŠ¤å£«åªèƒ½æŸ¥çœ‹ç”Ÿå‘½ä½“å¾ï¼Œä¸èƒ½ä¿®æ”¹è¯Šæ–­</span></span><br><span class="line">access_control.add_policy(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;nurse_vitals_policy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;subject_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;role&#x27;</span>: &#123;<span class="string">&#x27;equals&#x27;</span>: <span class="string">&#x27;nurse&#x27;</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;resource_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;data_type&#x27;</span>: &#123;<span class="string">&#x27;equals&#x27;</span>: <span class="string">&#x27;patient_vitals&#x27;</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;allowed_actions&#x27;</span>: [<span class="string">&#x27;read&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;effect&#x27;</span>: <span class="string">&#x27;allow&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-2-Goè¯­è¨€å®ç°ï¼šé«˜æ€§èƒ½è®¿é—®æ§åˆ¶ä¸­é—´ä»¶"><a href="#2-2-Goè¯­è¨€å®ç°ï¼šé«˜æ€§èƒ½è®¿é—®æ§åˆ¶ä¸­é—´ä»¶" class="headerlink" title="2.2 Goè¯­è¨€å®ç°ï¼šé«˜æ€§èƒ½è®¿é—®æ§åˆ¶ä¸­é—´ä»¶"></a>2.2 Goè¯­è¨€å®ç°ï¼šé«˜æ€§èƒ½è®¿é—®æ§åˆ¶ä¸­é—´ä»¶</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> heart</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/golang-jwt/jwt/v5&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/redis/go-redis/v9&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// HEARTAccessControlConfig é…ç½®ç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> HEARTAccessControlConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">RedisClient *redis.Client</span><br><span class="line">JWTSecret   []<span class="type">byte</span></span><br><span class="line">PolicyStore PolicyStore</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Policy å®šä¹‰è®¿é—®æ§åˆ¶ç­–ç•¥</span></span><br><span class="line"><span class="keyword">type</span> Policy <span class="keyword">struct</span> &#123;</span><br><span class="line">ID              <span class="type">string</span>                 <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">Name            <span class="type">string</span>                 <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">SubjectMatch    <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;subject_match&quot;`</span></span><br><span class="line">ResourceMatch   <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;resource_match&quot;`</span></span><br><span class="line">Actions         []<span class="type">string</span>               <span class="string">`json:&quot;actions&quot;`</span></span><br><span class="line">Effect          <span class="type">string</span>                 <span class="string">`json:&quot;effect&quot;`</span> <span class="comment">// &quot;allow&quot; or &quot;deny&quot;</span></span><br><span class="line">ExpiresAt       *time.Time             <span class="string">`json:&quot;expires_at,omitempty&quot;`</span></span><br><span class="line">CacheDuration   time.Duration          <span class="string">`json:&quot;cache_duration&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PolicyStore ç­–ç•¥å­˜å‚¨æ¥å£</span></span><br><span class="line"><span class="keyword">type</span> PolicyStore <span class="keyword">interface</span> &#123;</span><br><span class="line">GetPolicy(policyID <span class="type">string</span>) (*Policy, <span class="type">error</span>)</span><br><span class="line">ListPolicies() ([]*Policy, <span class="type">error</span>)</span><br><span class="line">EvaluatePolicy(ctx context.Context, subject, resource <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, action <span class="type">string</span>) (<span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RedisPolicyStore Rediså®ç°çš„ç­–ç•¥å­˜å‚¨</span></span><br><span class="line"><span class="keyword">type</span> RedisPolicyStore <span class="keyword">struct</span> &#123;</span><br><span class="line">redisClient *redis.Client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RedisPolicyStore)</span></span> GetPolicy(policyID <span class="type">string</span>) (*Policy, <span class="type">error</span>) &#123;</span><br><span class="line">key := fmt.Sprintf(<span class="string">&quot;heart:policy:%s&quot;</span>, policyID)</span><br><span class="line">data, err := r.redisClient.Get(context.Background(), key).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> policy Policy</span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal([]<span class="type">byte</span>(data), &amp;policy); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;policy, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RedisPolicyStore)</span></span> EvaluatePolicy(ctx context.Context, subject, resource <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, action <span class="type">string</span>) (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// ä»ç¼“å­˜ä¸­è·å–ç›¸å…³ç­–ç•¥</span></span><br><span class="line">policyKeys, err := r.redisClient.Keys(ctx, <span class="string">&quot;heart:policy:*&quot;</span>).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> policyKeys &#123;</span><br><span class="line">data, err := r.redisClient.Get(ctx, key).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> policy Policy</span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal([]<span class="type">byte</span>(data), &amp;policy); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ç­–ç•¥æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line"><span class="keyword">if</span> policy.ExpiresAt != <span class="literal">nil</span> &amp;&amp; time.Now().After(*policy.ExpiresAt) &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ¹é…ä¸»ä½“æ¡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> !matchConditions(subject, policy.SubjectMatch) &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ¹é…èµ„æºæ¡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> !matchConditions(resource, policy.ResourceMatch) &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥åŠ¨ä½œ</span></span><br><span class="line"><span class="keyword">for</span> _, allowedAction := <span class="keyword">range</span> policy.Actions &#123;</span><br><span class="line"><span class="keyword">if</span> allowedAction == action &#123;</span><br><span class="line"><span class="keyword">return</span> policy.Effect == <span class="string">&quot;allow&quot;</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">matchConditions</span><span class="params">(target, conditions <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> key, condition := <span class="keyword">range</span> conditions &#123;</span><br><span class="line"><span class="keyword">if</span> targetValue, exists := target[key]; exists &#123;</span><br><span class="line"><span class="keyword">switch</span> cond := condition.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line"><span class="keyword">if</span> targetValue != cond &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;:</span><br><span class="line"><span class="keyword">if</span> !evaluateComplexCondition(targetValue, cond) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">if</span> targetValue != condition &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">evaluateComplexCondition</span><span class="params">(value <span class="keyword">interface</span>&#123;&#125;, condition <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> op, condValue := <span class="keyword">range</span> condition &#123;</span><br><span class="line"><span class="keyword">switch</span> op &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;equals&quot;</span>:</span><br><span class="line"><span class="keyword">return</span> value == condValue</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;in&quot;</span>:</span><br><span class="line"><span class="keyword">if</span> list, ok := condValue.([]<span class="keyword">interface</span>&#123;&#125;); ok &#123;</span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> list &#123;</span><br><span class="line"><span class="keyword">if</span> value == item &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;greater_than&quot;</span>:</span><br><span class="line"><span class="keyword">if</span> floatValue, ok := value.(<span class="type">float64</span>); ok &#123;</span><br><span class="line"><span class="keyword">if</span> condFloat, ok := condValue.(<span class="type">float64</span>); ok &#123;</span><br><span class="line"><span class="keyword">return</span> floatValue &gt; condFloat</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;less_than&quot;</span>:</span><br><span class="line"><span class="keyword">if</span> floatValue, ok := value.(<span class="type">float64</span>); ok &#123;</span><br><span class="line"><span class="keyword">if</span> condFloat, ok := condValue.(<span class="type">float64</span>); ok &#123;</span><br><span class="line"><span class="keyword">return</span> floatValue &lt; condFloat</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AccessControlMiddleware HEARTè®¿é—®æ§åˆ¶ä¸­é—´ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AccessControlMiddleware</span><span class="params">(config *HEARTAccessControlConfig)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(http.Handler)</span></span> http.Handler &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(next http.Handler)</span></span> http.Handler &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">// 1. è§£æJWT token</span></span><br><span class="line">tokenString := extractToken(r)</span><br><span class="line"><span class="keyword">if</span> tokenString == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Missing authorization token&quot;</span>, http.StatusUnauthorized)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">token, err := jwt.Parse(tokenString, <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(config.JWTSecret), <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> || !token.Valid &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Invalid token&quot;</span>, http.StatusUnauthorized)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">claims := token.Claims.(jwt.MapClaims)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ„å»ºä¸»ä½“å±æ€§</span></span><br><span class="line">subject := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;user_id&quot;</span>:        claims[<span class="string">&quot;sub&quot;</span>],</span><br><span class="line"><span class="string">&quot;role&quot;</span>:           claims[<span class="string">&quot;role&quot;</span>],</span><br><span class="line"><span class="string">&quot;department&quot;</span>:     claims[<span class="string">&quot;department&quot;</span>],</span><br><span class="line"><span class="string">&quot;clearance_level&quot;</span>: claims[<span class="string">&quot;clearance_level&quot;</span>],</span><br><span class="line"><span class="string">&quot;ip_address&quot;</span>:      r.RemoteAddr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ„å»ºèµ„æºå±æ€§</span></span><br><span class="line">resourceID := getResourceIDFromRequest(r)</span><br><span class="line">resource := getResourceAttributes(config.RedisClient, resourceID)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ç¡®å®šåŠ¨ä½œ</span></span><br><span class="line">action := getActionFromRequest(r)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. è¯„ä¼°ç­–ç•¥</span></span><br><span class="line">ctx := context.Background()</span><br><span class="line">authorized, err := config.PolicyStore.EvaluatePolicy(ctx, subject, resource, action)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Policy evaluation error: %v&quot;</span>, err)</span><br><span class="line">http.Error(w, <span class="string">&quot;Access control error&quot;</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !authorized &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Access denied: insufficient permissions&quot;</span>, http.StatusForbidden)</span><br><span class="line"><span class="comment">// è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">logAccessDecision(config.RedisClient, subject, resource, action, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">logAccessDecision(config.RedisClient, subject, resource, action, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. ç»§ç»­å¤„ç†è¯·æ±‚</span></span><br><span class="line">next.ServeHTTP(w, r)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">extractToken</span><span class="params">(r *http.Request)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">authHeader := r.Header.Get(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> authHeader == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">parts := strings.Split(authHeader, <span class="string">&quot; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(parts) != <span class="number">2</span> || strings.ToLower(parts[<span class="number">0</span>]) != <span class="string">&quot;bearer&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> parts[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getResourceIDFromRequest</span><span class="params">(r *http.Request)</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">// ä»URLè·¯å¾„ä¸­æå–èµ„æºID</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼š/api/v1/patients/&#123;patient_id&#125;/records</span></span><br><span class="line">pathParts := strings.Split(r.URL.Path, <span class="string">&quot;/&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i, part := <span class="keyword">range</span> pathParts &#123;</span><br><span class="line"><span class="keyword">if</span> part == <span class="string">&quot;patients&quot;</span> &amp;&amp; i+<span class="number">1</span> &lt; <span class="built_in">len</span>(pathParts) &#123;</span><br><span class="line"><span class="keyword">return</span> pathParts[i+<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> part == <span class="string">&quot;records&quot;</span> &amp;&amp; i+<span class="number">1</span> &lt; <span class="built_in">len</span>(pathParts) &#123;</span><br><span class="line"><span class="keyword">return</span> pathParts[i+<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;unknown_resource&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getResourceAttributes</span><span class="params">(redisClient *redis.Client, resourceID <span class="type">string</span>)</span></span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line"><span class="comment">// ä»Redisè·å–èµ„æºå±æ€§</span></span><br><span class="line">key := fmt.Sprintf(<span class="string">&quot;heart:resource:%s&quot;</span>, resourceID)</span><br><span class="line">data, err := redisClient.Get(context.Background(), key).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// è¿”å›é»˜è®¤å±æ€§</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;resource_id&quot;</span>:     resourceID,</span><br><span class="line"><span class="string">&quot;sensitivity_level&quot;</span>: <span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;owner_department&quot;</span>:  <span class="string">&quot;general&quot;</span>,</span><br><span class="line"><span class="string">&quot;data_type&quot;</span>:        <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> attributes <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal([]<span class="type">byte</span>(data), &amp;attributes); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;resource_id&quot;</span>: resourceID,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> attributes</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getActionFromRequest</span><span class="params">(r *http.Request)</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> r.Method &#123;</span><br><span class="line"><span class="keyword">case</span> http.MethodGet:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;read&quot;</span></span><br><span class="line"><span class="keyword">case</span> http.MethodPost:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;create&quot;</span></span><br><span class="line"><span class="keyword">case</span> http.MethodPut, http.MethodPatch:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;update&quot;</span></span><br><span class="line"><span class="keyword">case</span> http.MethodDelete:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;delete&quot;</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logAccessDecision</span><span class="params">(redisClient *redis.Client, subject, resource <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, action <span class="type">string</span>, allowed <span class="type">bool</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// ç”Ÿæˆå”¯ä¸€å®¡è®¡ID</span></span><br><span class="line">auditID := generateAuditID(subject, resource, action)</span><br><span class="line"></span><br><span class="line">auditLog := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;audit_id&quot;</span>:   auditID,</span><br><span class="line"><span class="string">&quot;timestamp&quot;</span>:  time.Now().UTC().Format(time.RFC3339),</span><br><span class="line"><span class="string">&quot;subject&quot;</span>:    subject,</span><br><span class="line"><span class="string">&quot;resource&quot;</span>:   resource,</span><br><span class="line"><span class="string">&quot;action&quot;</span>:     action,</span><br><span class="line"><span class="string">&quot;allowed&quot;</span>:    allowed,</span><br><span class="line"><span class="string">&quot;ip_address&quot;</span>: subject[<span class="string">&quot;ip_address&quot;</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jsonData, _ := json.Marshal(auditLog)</span><br><span class="line">key := fmt.Sprintf(<span class="string">&quot;heart:audit:%s&quot;</span>, auditID)</span><br><span class="line">redisClient.Set(context.Background(), key, <span class="type">string</span>(jsonData), <span class="number">30</span>*<span class="number">24</span>*time.Hour) <span class="comment">// ä¿å­˜30å¤©</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateAuditID</span><span class="params">(subject, resource <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, action <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">hash := sha256.New()</span><br><span class="line">hash.Write([]<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;%v:%v:%s:%d&quot;</span>, </span><br><span class="line">subject[<span class="string">&quot;user_id&quot;</span>], </span><br><span class="line">resource[<span class="string">&quot;resource_id&quot;</span>], </span><br><span class="line">action, </span><br><span class="line">time.Now().Unix())))</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(hash.Sum(<span class="literal">nil</span>))[:<span class="number">16</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸‰ã€HEARTæ¶æ„ä¸­çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶é›†æˆ"><a href="#ä¸‰ã€HEARTæ¶æ„ä¸­çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶é›†æˆ" class="headerlink" title="ä¸‰ã€HEARTæ¶æ„ä¸­çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶é›†æˆ"></a>ä¸‰ã€HEARTæ¶æ„ä¸­çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶é›†æˆ</h3><h4 id="3-1-ç«¯åˆ°ç«¯åŠ å¯†æµç¨‹"><a href="#3-1-ç«¯åˆ°ç«¯åŠ å¯†æµç¨‹" class="headerlink" title="3.1 ç«¯åˆ°ç«¯åŠ å¯†æµç¨‹"></a>3.1 ç«¯åˆ°ç«¯åŠ å¯†æµç¨‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTSecureDataPipeline</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.encryptor = HEARTDataEncryptor()</span><br><span class="line">        self.access_control = HEARTAccessControl()</span><br><span class="line">        self.key_manager = HEARTKeyManager()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_health_data</span>(<span class="params">self, patient_id, health_data, user_token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç«¯åˆ°ç«¯å¤„ç†å¥åº·æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 1. éªŒè¯è®¿é—®æƒé™</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.access_control.authorize_access(user_token, patient_id, <span class="string">&quot;write&quot;</span>):</span><br><span class="line">                <span class="keyword">raise</span> PermissionError(<span class="string">&quot;Access denied: insufficient permissions&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2. ç”Ÿæˆæ•°æ®å¯†é’¥</span></span><br><span class="line">            data_key = self.key_manager.generate_data_key()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 3. ä½¿ç”¨æ•°æ®å¯†é’¥åŠ å¯†å¥åº·æ•°æ®</span></span><br><span class="line">            encrypted_data = self.encryptor.encrypt_health_record(</span><br><span class="line">                json.dumps(health_data),</span><br><span class="line">                patient_id</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 4. ä½¿ç”¨KMSå¯†é’¥åŠ å¯†æ•°æ®å¯†é’¥</span></span><br><span class="line">            encrypted_data_key = &#123;</span><br><span class="line">                <span class="string">&#x27;ciphertext_key&#x27;</span>: base64.b64encode(data_key[<span class="string">&#x27;ciphertext_key&#x27;</span>]).decode(),</span><br><span class="line">                <span class="string">&#x27;key_id&#x27;</span>: data_key[<span class="string">&#x27;key_id&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 5. æ„å»ºå®‰å…¨æ•°æ®åŒ…</span></span><br><span class="line">            secure_package = &#123;</span><br><span class="line">                <span class="string">&#x27;patient_id&#x27;</span>: patient_id,</span><br><span class="line">                <span class="string">&#x27;encrypted_data&#x27;</span>: encrypted_data,</span><br><span class="line">                <span class="string">&#x27;encrypted_data_key&#x27;</span>: encrypted_data_key,</span><br><span class="line">                <span class="string">&#x27;encryption_metadata&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;algorithm&#x27;</span>: <span class="string">&#x27;AES-GCM-256&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">                    <span class="string">&#x27;version&#x27;</span>: <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 6. è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">            self._log_audit_event(</span><br><span class="line">                user_id=self._extract_user_id(user_token),</span><br><span class="line">                action=<span class="string">&quot;data_encrypted&quot;</span>,</span><br><span class="line">                resource=patient_id,</span><br><span class="line">                result=<span class="string">&quot;success&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> secure_package</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self._log_audit_event(</span><br><span class="line">                user_id=self._extract_user_id(user_token),</span><br><span class="line">                action=<span class="string">&quot;data_encryption_failed&quot;</span>,</span><br><span class="line">                resource=patient_id,</span><br><span class="line">                result=<span class="built_in">str</span>(e)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_health_data</span>(<span class="params">self, secure_package, user_token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†å¥åº·æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            patient_id = secure_package[<span class="string">&#x27;patient_id&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 1. éªŒè¯è®¿é—®æƒé™</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.access_control.authorize_access(user_token, patient_id, <span class="string">&quot;read&quot;</span>):</span><br><span class="line">                <span class="keyword">raise</span> PermissionError(<span class="string">&quot;Access denied: insufficient permissions&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2. è§£å¯†æ•°æ®å¯†é’¥</span></span><br><span class="line">            encrypted_data_key = base64.b64decode(secure_package[<span class="string">&#x27;encrypted_data_key&#x27;</span>][<span class="string">&#x27;ciphertext_key&#x27;</span>])</span><br><span class="line">            plaintext_key = self.key_manager.decrypt_data_key(encrypted_data_key)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 3. ä½¿ç”¨æ•°æ®å¯†é’¥è§£å¯†å¥åº·æ•°æ®</span></span><br><span class="line">            temp_encryptor = HEARTDataEncryptor(plaintext_key)</span><br><span class="line">            decrypted_data = temp_encryptor.decrypt_health_record(</span><br><span class="line">                secure_package[<span class="string">&#x27;encrypted_data&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 4. è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">            self._log_audit_event(</span><br><span class="line">                user_id=self._extract_user_id(user_token),</span><br><span class="line">                action=<span class="string">&quot;data_decrypted&quot;</span>,</span><br><span class="line">                resource=patient_id,</span><br><span class="line">                result=<span class="string">&quot;success&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> json.loads(decrypted_data)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self._log_audit_event(</span><br><span class="line">                user_id=self._extract_user_id(user_token),</span><br><span class="line">                action=<span class="string">&quot;data_decryption_failed&quot;</span>,</span><br><span class="line">                resource=patient_id,</span><br><span class="line">                result=<span class="built_in">str</span>(e)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_user_id</span>(<span class="params">self, token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä»tokenä¸­æå–ç”¨æˆ·ID&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = jwt.decode(token, options=&#123;<span class="string">&quot;verify_signature&quot;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">            <span class="keyword">return</span> payload.get(<span class="string">&#x27;sub&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_log_audit_event</span>(<span class="params">self, user_id, action, resource, result</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•å®¡è®¡äº‹ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        audit_log = &#123;</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span>: action,</span><br><span class="line">            <span class="string">&#x27;resource&#x27;</span>: resource,</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: result,</span><br><span class="line">            <span class="string">&#x27;ip_address&#x27;</span>: self._get_client_ip()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># ä¿å­˜åˆ°å®‰å…¨å®¡è®¡æ—¥å¿—ç³»ç»Ÿ</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Audit: <span class="subst">&#123;audit_log&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="3-2-åŒæ€åŠ å¯†ä¸è®¿é—®æ§åˆ¶çš„ç»“åˆ"><a href="#3-2-åŒæ€åŠ å¯†ä¸è®¿é—®æ§åˆ¶çš„ç»“åˆ" class="headerlink" title="3.2 åŒæ€åŠ å¯†ä¸è®¿é—®æ§åˆ¶çš„ç»“åˆ"></a>3.2 åŒæ€åŠ å¯†ä¸è®¿é—®æ§åˆ¶çš„ç»“åˆ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTPrivacyPreservingAI</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.homo_processor = HEARTHomoMorphicProcessor()</span><br><span class="line">        self.access_control = HEARTAccessControl()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train_model_on_encrypted_data</span>(<span class="params">self, encrypted_dataset, model_config, user_token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åœ¨åŠ å¯†æ•°æ®ä¸Šè®­ç»ƒAIæ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 1. éªŒè¯è®¿é—®æƒé™</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.access_control.authorize_access(user_token, <span class="string">&quot;model_training&quot;</span>, <span class="string">&quot;execute&quot;</span>):</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;Unauthorized model training attempt&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. åœ¨åŠ å¯†æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—</span></span><br><span class="line">        encrypted_results = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> data_point <span class="keyword">in</span> encrypted_dataset:</span><br><span class="line">            <span class="comment"># æ‰§è¡ŒåŒæ€è®¡ç®—</span></span><br><span class="line">            encrypted_prediction = self.homo_processor.compute_health_risk_on_encrypted_data(data_point)</span><br><span class="line">            encrypted_results.append(encrypted_prediction)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. è¿”å›åŠ å¯†çš„æ¨¡å‹å‚æ•°</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;model_id&#x27;</span>: generate_model_id(),</span><br><span class="line">            <span class="string">&#x27;encrypted_parameters&#x27;</span>: encrypted_results,</span><br><span class="line">            <span class="string">&#x27;training_metadata&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">                <span class="string">&#x27;data_points&#x27;</span>: <span class="built_in">len</span>(encrypted_dataset)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_on_encrypted_data</span>(<span class="params">self, encrypted_input, model_id, user_token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä½¿ç”¨åŠ å¯†æ¨¡å‹è¿›è¡Œé¢„æµ‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 1. éªŒè¯è®¿é—®æƒé™</span></span><br><span class="line">        patient_id = self._extract_patient_id(encrypted_input)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.access_control.authorize_access(user_token, patient_id, <span class="string">&quot;predict&quot;</span>):</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;Unauthorized prediction attempt&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. ä½¿ç”¨åŒæ€åŠ å¯†æ•°æ®è¿›è¡Œé¢„æµ‹</span></span><br><span class="line">        encrypted_prediction = self._execute_encrypted_prediction(encrypted_input, model_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">        self._log_prediction_audit(user_token, patient_id, model_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> encrypted_prediction</span><br></pre></td></tr></table></figure><h3 id="å››ã€å®‰å…¨æœ€ä½³å®è·µ"><a href="#å››ã€å®‰å…¨æœ€ä½³å®è·µ" class="headerlink" title="å››ã€å®‰å…¨æœ€ä½³å®è·µ"></a>å››ã€å®‰å…¨æœ€ä½³å®è·µ</h3><h4 id="4-1-å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ"><a href="#4-1-å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ" class="headerlink" title="4.1 å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ"></a>4.1 å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ</h4><ol><li><strong>å¯†é’¥è½®æ¢ç­–ç•¥</strong>ï¼šå®šæœŸè½®æ¢åŠ å¯†å¯†é’¥ï¼Œæ—§å¯†é’¥ç”¨äºè§£å¯†å†å²æ•°æ®ï¼Œæ–°å¯†é’¥ç”¨äºåŠ å¯†æ–°æ•°æ®</li><li><strong>å¯†é’¥åˆ†å±‚</strong>ï¼šä½¿ç”¨KMSä¸»å¯†é’¥åŠ å¯†æ•°æ®å¯†é’¥ï¼Œæ•°æ®å¯†é’¥åŠ å¯†å®é™…æ•°æ®</li><li>**ç¡¬ä»¶å®‰å…¨æ¨¡å—(HSM)**ï¼šå…³é”®å¯†é’¥å­˜å‚¨åœ¨HSMä¸­ï¼Œé˜²æ­¢è½¯ä»¶å±‚é¢çš„æ”»å‡»</li></ol><h4 id="4-2-è®¿é—®æ§åˆ¶å¼ºåŒ–æªæ–½"><a href="#4-2-è®¿é—®æ§åˆ¶å¼ºåŒ–æªæ–½" class="headerlink" title="4.2 è®¿é—®æ§åˆ¶å¼ºåŒ–æªæ–½"></a>4.2 è®¿é—®æ§åˆ¶å¼ºåŒ–æªæ–½</h4><ol><li><strong>æœ€å°æƒé™åŸåˆ™</strong>ï¼šç”¨æˆ·åªèƒ½è®¿é—®å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°æ•°æ®é›†</li><li><strong>åŠ¨æ€æƒé™</strong>ï¼šæ ¹æ®ä¸Šä¸‹æ–‡ï¼ˆæ—¶é—´ã€ä½ç½®ã€è®¾å¤‡ï¼‰åŠ¨æ€è°ƒæ•´æƒé™</li><li><strong>å¤šå› ç´ è®¤è¯</strong>ï¼šç»“åˆç”Ÿç‰©è¯†åˆ«ã€ç¡¬ä»¶ä»¤ç‰Œç­‰å¤šé‡è®¤è¯å› ç´ </li><li><strong>é›¶ä¿¡ä»»æ¶æ„</strong>ï¼šé»˜è®¤æ‹’ç»æ‰€æœ‰è®¿é—®ï¼Œæ˜¾å¼æˆæƒæ¯æ¬¡è¯·æ±‚</li></ol><h4 id="4-3-å®¡è®¡ä¸ç›‘æ§"><a href="#4-3-å®¡è®¡ä¸ç›‘æ§" class="headerlink" title="4.3 å®¡è®¡ä¸ç›‘æ§"></a>4.3 å®¡è®¡ä¸ç›‘æ§</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTAuditSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, blockchain_client=<span class="literal">None</span></span>):</span><br><span class="line">        self.blockchain_client = blockchain_client  <span class="comment"># å¯é€‰çš„åŒºå—é“¾å®¡è®¡</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_audit_event</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•å®¡è®¡äº‹ä»¶åˆ°ä¸å¯ç¯¡æ”¹çš„æ—¥å¿—&quot;&quot;&quot;</span></span><br><span class="line">        audit_entry = &#123;</span><br><span class="line">            <span class="string">&#x27;event_id&#x27;</span>: <span class="built_in">str</span>(uuid.uuid4()),</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.utcnow().isoformat(),</span><br><span class="line">            <span class="string">&#x27;event_type&#x27;</span>: event[<span class="string">&#x27;type&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: event[<span class="string">&#x27;user_id&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;resource_id&#x27;</span>: event.get(<span class="string">&#x27;resource_id&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span>: event[<span class="string">&#x27;action&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: event[<span class="string">&#x27;result&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;ip_address&#x27;</span>: event.get(<span class="string">&#x27;ip_address&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;user_agent&#x27;</span>: event.get(<span class="string">&#x27;user_agent&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;signature&#x27;</span>: self._sign_audit_entry(event)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“</span></span><br><span class="line">        self._save_to_database(audit_entry)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. å¦‚æœé…ç½®äº†åŒºå—é“¾ï¼Œå†™å…¥åŒºå—é“¾</span></span><br><span class="line">        <span class="keyword">if</span> self.blockchain_client:</span><br><span class="line">            self.blockchain_client.write_audit_log(audit_entry)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. å®æ—¶ç›‘æ§å¼‚å¸¸</span></span><br><span class="line">        self._monitor_for_anomalies(audit_entry)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_sign_audit_entry</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä½¿ç”¨ç§é’¥ç­¾åå®¡è®¡æ¡ç›®ï¼Œç¡®ä¿å®Œæ•´æ€§&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å®é™…å®ç°ä¸­ä½¿ç”¨æ•°å­—ç­¾å</span></span><br><span class="line">        <span class="keyword">return</span> hashlib.sha256(json.dumps(event, sort_keys=<span class="literal">True</span>).encode()).hexdigest()</span><br></pre></td></tr></table></figure><h3 id="äº”ã€æ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡"><a href="#äº”ã€æ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡" class="headerlink" title="äº”ã€æ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡"></a>äº”ã€æ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡</h3><h4 id="5-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#5-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="5.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>5.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h4><ol><li><strong>ç¼“å­˜ç­–ç•¥</strong>ï¼šç¼“å­˜è§£å¯†çš„å¯†é’¥å’Œè®¿é—®æ§åˆ¶å†³ç­–ï¼Œå‡å°‘é‡å¤è®¡ç®—</li><li><strong>å¼‚æ­¥åŠ å¯†</strong>ï¼šå¯¹éå…³é”®è·¯å¾„çš„åŠ å¯†æ“ä½œä½¿ç”¨å¼‚æ­¥å¤„ç†</li><li><strong>æ‰¹å¤„ç†</strong>ï¼šæ‰¹é‡å¤„ç†åŒæ€åŠ å¯†è®¡ç®—ï¼Œå‡å°‘å¼€é”€</li><li><strong>ç¡¬ä»¶åŠ é€Ÿ</strong>ï¼šä½¿ç”¨æ”¯æŒAES-NIçš„CPUå’ŒGPUåŠ é€ŸåŠ å¯†è®¡ç®—</li></ol><h4 id="5-2-å®‰å…¨ä¸æ€§èƒ½çš„æƒè¡¡"><a href="#5-2-å®‰å…¨ä¸æ€§èƒ½çš„æƒè¡¡" class="headerlink" title="5.2 å®‰å…¨ä¸æ€§èƒ½çš„æƒè¡¡"></a>5.2 å®‰å…¨ä¸æ€§èƒ½çš„æƒè¡¡</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTSecurityPerformanceBalancer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.security_level = <span class="string">&quot;high&quot;</span>  <span class="comment"># high, medium, low</span></span><br><span class="line">        self.performance_threshold = <span class="number">100</span>  <span class="comment"># ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">adjust_security_level</span>(<span class="params">self, current_latency</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¹æ®æ€§èƒ½åŠ¨æ€è°ƒæ•´å®‰å…¨çº§åˆ«&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> current_latency &gt; self.performance_threshold * <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> self.security_level == <span class="string">&quot;high&quot;</span>:</span><br><span class="line">                self.security_level = <span class="string">&quot;medium&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Reducing security level to medium for performance&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> current_latency &lt; self.performance_threshold / <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> self.security_level == <span class="string">&quot;medium&quot;</span>:</span><br><span class="line">                self.security_level = <span class="string">&quot;high&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Increasing security level to high&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_encryption_strategy</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–å½“å‰åŠ å¯†ç­–ç•¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.security_level == <span class="string">&quot;high&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;algorithm&#x27;</span>: <span class="string">&#x27;AES-GCM-256&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;key_rotation&#x27;</span>: <span class="string">&#x27;daily&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;homomorphic_encryption&#x27;</span>: <span class="literal">True</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">elif</span> self.security_level == <span class="string">&quot;medium&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;algorithm&#x27;</span>: <span class="string">&#x27;AES-GCM-128&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;key_rotation&#x27;</span>: <span class="string">&#x27;weekly&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;homomorphic_encryption&#x27;</span>: <span class="literal">False</span>  <span class="comment"># ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;algorithm&#x27;</span>: <span class="string">&#x27;AES-CBC-128&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;key_rotation&#x27;</span>: <span class="string">&#x27;monthly&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;homomorphic_encryption&#x27;</span>: <span class="literal">False</span></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h3 id="ç›¸å…³å»ºè®®"><a href="#ç›¸å…³å»ºè®®" class="headerlink" title="ç›¸å…³å»ºè®®"></a>ç›¸å…³å»ºè®®</h3><p>åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶éœ€è¦ç»¼åˆè€ƒè™‘å¤šä¸ªå±‚é¢ï¼š</p><ol><li><strong>å¤šå±‚åŠ å¯†ç­–ç•¥</strong>ï¼šç»“åˆAES-GCMä¿æŠ¤é™æ€æ•°æ®ï¼ŒTLS 1.3ä¿æŠ¤ä¼ è¾“æ•°æ®ï¼ŒåŒæ€åŠ å¯†ä¿æŠ¤å¤„ç†ä¸­çš„æ•°æ® </li><li><strong>ç»†ç²’åº¦è®¿é—®æ§åˆ¶</strong>ï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰æä¾›çµæ´»çš„æƒé™ç®¡ç†ï¼Œé€‚åº”å¤æ‚çš„åŒ»ç–—åœºæ™¯</li><li><strong>å¯†é’¥å®‰å…¨ç®¡ç†</strong>ï¼šä½¿ç”¨äº‘KMSæˆ–HSMè¿›è¡Œå¯†é’¥ç®¡ç†ï¼Œç¡®ä¿å¯†é’¥å®‰å…¨</li><li><strong>å®¡è®¡ä¸ç›‘æ§</strong>ï¼šè®°å½•æ‰€æœ‰è®¿é—®å’Œæ“ä½œï¼Œæä¾›é€æ˜æ€§å’Œå¯è¿½æº¯æ€§</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šåœ¨ä¿è¯å®‰å…¨çš„å‰æä¸‹ï¼Œé€šè¿‡ç¼“å­˜ã€å¼‚æ­¥å¤„ç†ç­‰æŠ€æœ¯ä¼˜åŒ–æ€§èƒ½</li></ol><p>é€šè¿‡è¿™ç§ç»¼åˆæ€§çš„æ–¹æ³•ï¼ŒHEARTæ¶æ„èƒ½å¤Ÿåœ¨ä¿æŠ¤æ‚£è€…éšç§çš„åŒæ—¶ï¼Œæä¾›é«˜æ•ˆã€å¯é çš„AIå¥åº·æœåŠ¡ã€‚è¿™ç§æ¶æ„ä¸ä»…ç¬¦åˆHIPAAã€GDPRç­‰æ³•è§„è¦æ±‚ï¼Œè¿˜èƒ½åœ¨å®é™…åº”ç”¨ä¸­æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚  </p><p>æœ€é‡è¦çš„æ˜¯ï¼ŒHEARTæ¶æ„å°†å®‰å…¨æ€§å’Œéšç§ä¿æŠ¤â€è®¾è®¡è¿›â€ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè€Œä¸æ˜¯ä½œä¸ºäº‹åçš„è¡¥å……ï¼Œè¿™æ­£æ˜¯ç°ä»£åŒ»ç–—å¥åº·åº”ç”¨æˆåŠŸçš„å…³é”®æ‰€åœ¨ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;&lt;a href=&quot;#æ‘˜è¦&quot; class=&quot;headerlink&quot; title=&quot;æ‘˜è¦&quot;&gt;&lt;/a&gt;æ‘˜è¦&lt;/h2&gt;&lt;p&gt;æœ¬äººä¸€ç›´éå¸¸æ¬£èµçš„ä¸€å¥è¯ï¼š   &lt;/p&gt;
&lt;p&gt;é™¤éç»ç”±è®°å¿†ä¹‹è·¯ï¼Œäººä¸èƒ½æŠµè¾¾çºµæ·±ã€‚ â€”â€”â€”â€”æ±‰å¨œÂ·é˜¿ä¼¦ç‰¹   &lt;/p&gt;
&lt;p&gt;é¦–å…ˆå¦‚æœåŸºäºHEARTæ¶æ„ç†å¿µï¼Œå¦‚ä½•è®¾è®¡ä¸€ä¸ªç¡®ä¿æ•°æ®éšç§çš„AIå¥åº·åº”ç”¨æ¶æ„ï¼Ÿç›¸ä¿¡è¿™åœ¨2026å¼€å¹´çš„ä»Šå¤©ï¼Œä»¥åŠè¿‡å»ä¸€å¹´ç”šåš£å°˜ä¸Šçš„å„ç§AIåº”ç”¨å¼€å‘æŠ€æœ¯å’Œè§„èŒƒåŸåˆ™é¼“å¹ä¹‹ä¸‹è¦æ€è€ƒå’Œåæ€çš„é—®é¢˜ï¼Œä½œä¸ºå·¥ç¨‹å¸ˆè¦å›å½’æ¸…é†’ä¸ç†æ™ºã€‚  &lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/tags/Agent/"/>
    
    <category term="Skill" scheme="https://www.wdft.com/tags/Skill/"/>
    
    <category term="Agent-Skill" scheme="https://www.wdft.com/tags/Agent-Skill/"/>
    
    <category term="Agent-architecture" scheme="https://www.wdft.com/tags/Agent-architecture/"/>
    
    <category term="HEART" scheme="https://www.wdft.com/tags/HEART/"/>
    
  </entry>
  
  <entry>
    <title>Agentå’ŒRAGï¼šåŒé˜¶æ®µæ„å›¾è¯†åˆ«ä»¥åŠå…¸å‹åœºæ™¯(å®¢æœ)é—®ç­”åœºæ™¯ä¸‹å‡†ç¡®ç‡ä¸å»¶è¿Ÿçš„å¸•ç´¯æ‰˜æœ€ä¼˜è§£è§£æ</title>
    <link href="https://www.wdft.com/835929d9.html"/>
    <id>https://www.wdft.com/835929d9.html</id>
    <published>2026-01-25T15:17:34.000Z</published>
    <updated>2026-01-30T06:40:40.569Z</updated>
    
    <content type="html"><![CDATA[<h6 id="é¦–å…ˆä¸ºä»€ä¹ˆ90-çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”"><a href="#é¦–å…ˆä¸ºä»€ä¹ˆ90-çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”" class="headerlink" title="é¦–å…ˆä¸ºä»€ä¹ˆ90%çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”"></a>é¦–å…ˆä¸ºä»€ä¹ˆ90%çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”</h6><p><strong>ä»¥å…¸å‹æ¡ˆä¾‹æ¥è¯´</strong>ï¼šåœ¨å‡ ä¹æ‰€æœ‰IMå®¢æœ(ç”µå•†)äº¤äº’å¼å¯¹è¯ç³»ç»Ÿåº”ç”¨ä¸­ï¼Œ<strong>â€œæ‰€æœ‰è¯·æ±‚åŒç­‰å¯¹å¾…â€æ˜¯æœ€å¤§çš„èµ„æºæµªè´¹</strong>ã€‚<br>ç›®å‰ä¸šç•Œå…±è¯†ä¹‹ä¸€æ˜¯ï¼šåŒé˜¶æ®µæ„å›¾è¯†åˆ«é€šè¿‡â€œè®¡ç®—èµ„æºåŠ¨æ€åˆ†é…â€æ€æƒ³ï¼Œåœ¨96.7%å‡†ç¡®ç‡ä¸98mså¹³å‡å»¶è¿Ÿé—´å–å¾—å·¥ç¨‹æœ€ä¼˜å¹³è¡¡ï¼Œä¹Ÿå‡ ä¹æˆä¸ºAgentç³»ç»Ÿçš„äº‹å®æ€§æ ‡å‡†æ¶æ„ä¹‹ä¸€ã€‚  </p><span id="more"></span><p>é’ˆå¯¹è¿™ä¸ªæœ€å¸¸ç”¨çš„åœºæ™¯ä¹‹ä¸€ï¼Œ<strong>ç°å°±ç›¸å…³å®ç°æ€è·¯è¿›è¡Œå‘æ•£,éšç€AIæŠ€æœ¯çš„æ¨¡å‹çš„å‘å±•ï¼Œæ¨¡å‹èƒ½åŠ›ä¹Ÿåœ¨ä¸æ–­å¢å¼ºï¼Œå®é™…ä¸Šæ–¹æ¡ˆä¹Ÿå±‚å‡ºä¸ç©·ï¼Œé€‰å‹æ²¡æœ‰ä¸€å®šä¹‹è§„ï¼Œåªæœ‰é€‚åˆè‡ªå·±çš„ä¸šåŠ¡åœºæ™¯çš„æ–¹æ¡ˆæ‰æ˜¯æœ€ä½³çš„ã€‚</strong></p><hr><h2 id="ä¸€ã€â€å•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€èƒ½å¤Ÿåšåˆ°ä¼ä¸šçº§çš„åœºæ™¯åº”å¯¹å—ï¼Ÿä¸ºä»€ä¹ˆå¿…é¡»æ”¾å¼ƒâ€œå•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€å¹»æƒ³ï¼Ÿ"><a href="#ä¸€ã€â€å•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€èƒ½å¤Ÿåšåˆ°ä¼ä¸šçº§çš„åœºæ™¯åº”å¯¹å—ï¼Ÿä¸ºä»€ä¹ˆå¿…é¡»æ”¾å¼ƒâ€œå•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€å¹»æƒ³ï¼Ÿ" class="headerlink" title="ä¸€ã€â€å•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€èƒ½å¤Ÿåšåˆ°ä¼ä¸šçº§çš„åœºæ™¯åº”å¯¹å—ï¼Ÿä¸ºä»€ä¹ˆå¿…é¡»æ”¾å¼ƒâ€œå•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€å¹»æƒ³ï¼Ÿ"></a>ä¸€ã€â€å•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€èƒ½å¤Ÿåšåˆ°ä¼ä¸šçº§çš„åœºæ™¯åº”å¯¹å—ï¼Ÿä¸ºä»€ä¹ˆå¿…é¡»æ”¾å¼ƒâ€œå•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€å¹»æƒ³ï¼Ÿ</h2><h3 id="1-1-å®¢æœåœºæ™¯çš„æ®‹é…·ç°å®"><a href="#1-1-å®¢æœåœºæ™¯çš„æ®‹é…·ç°å®" class="headerlink" title="1.1 å®¢æœåœºæ™¯çš„æ®‹é…·ç°å®"></a>1.1 å®¢æœåœºæ™¯çš„æ®‹é…·ç°å®</h3><p>æŸå¤´éƒ¨ç”µå•†å¹³å°2025å¹´Q3æ•°æ®æ­ç¤ºçœŸç›¸ï¼š</p><ul><li><strong>87.3%</strong> çš„ç”¨æˆ·æŸ¥è¯¢å±äºâ€œé«˜é¢‘ç®€å•æ„å›¾â€ï¼ˆå¦‚ç‰©æµæŸ¥è¯¢ã€é€€æ¬¾æµç¨‹ï¼‰</li><li><strong>12.7%</strong> å±äºâ€œå¤æ‚å¤šæ„å›¾äº¤ç»‡â€ï¼ˆå¦‚â€œæ‰‹æœºåäº†è¦é€€è´§è¿˜è¦æŠ•è¯‰å®¢æœâ€ï¼‰</li><li><strong>å•é˜¶æ®µBERTåˆ†ç±»å™¨</strong>å¯¹ç®€å•æ„å›¾è¿‡åº¦è®¡ç®—ï¼ˆæµªè´¹73%ç®—åŠ›ï¼‰ï¼Œå¯¹å¤æ‚æ„å›¾èƒ½åŠ›ä¸è¶³ï¼ˆè¯¯åˆ¤ç‡31%ï¼‰</li></ul><p>â€œæˆ‘ä»¬æ›¾ç”¨Qwen3-32Bå¤„ç†æ‰€æœ‰è¯·æ±‚ï¼Œå‡†ç¡®ç‡92%ï¼Œä½†P99å»¶è¿Ÿ410msï¼Œå¤§ä¿ƒæœŸé—´GPUæˆæœ¬é£™å‡300%â€ â€”â€” æŸç”µå•†å¹³å°AIè´Ÿè´£äºº</p><h3 id="1-2-ä¸‰ç§ä¸»æµæ–¹æ¡ˆçš„è‡´å‘½ç¼ºé™·"><a href="#1-2-ä¸‰ç§ä¸»æµæ–¹æ¡ˆçš„è‡´å‘½ç¼ºé™·" class="headerlink" title="1.2 ä¸‰ç§ä¸»æµæ–¹æ¡ˆçš„è‡´å‘½ç¼ºé™·"></a>1.2 ä¸‰ç§ä¸»æµæ–¹æ¡ˆçš„è‡´å‘½ç¼ºé™·</h3><table><thead><tr><th>æ–¹æ¡ˆ</th><th>ä»£è¡¨å®ç°</th><th>å®¢æœåœºæ™¯è‡´å‘½ä¼¤</th><th>é‡åŒ–å½±å“</th></tr></thead><tbody><tr><td><strong>è§„åˆ™å¼•æ“</strong></td><td>æ­£åˆ™+å…³é”®è¯åŒ¹é…</td><td>æ— æ³•å¤„ç†è¯­ä¹‰æ³›åŒ–ï¼ˆâ€œå……ä¸è¿›ç”µâ€â‰ â€œå……ç”µæ•…éšœâ€ï¼‰</td><td>æ„å›¾è¯†åˆ«å‡†ç¡®ç‡ä»…58.3%</td></tr><tr><td><strong>å•é˜¶æ®µåˆ†ç±»</strong></td><td>BERTå¾®è°ƒ</td><td>å¤šæ„å›¾åœºæ™¯è¡¨è¾¾ç“¶é¢ˆï¼ˆå¼ºåˆ¶å•æ ‡ç­¾è¾“å‡ºï¼‰</td><td>12.7%å¤æ‚è¯·æ±‚è¯¯åˆ¤ç‡41%</td></tr><tr><td><strong>ç«¯åˆ°ç«¯ç”Ÿæˆ</strong></td><td>Qwen3ç›´æ¥è¾“å‡º</td><td>å»¶è¿Ÿä¸å¯æ§ï¼ˆç”Ÿæˆå¼è§£ç 50tokenâ‰ˆ280msï¼‰</td><td>P99å»¶è¿Ÿ580msï¼Œè¶…SLA 2.9å€</td></tr></tbody></table><p><strong>æ ¹æœ¬çŸ›ç›¾</strong>ï¼šå®¢æœç³»ç»Ÿè¦æ±‚ <strong>â€œ95%+å‡†ç¡®ç‡ + &lt;200mså»¶è¿Ÿ + å¯æ§æˆæœ¬â€</strong> ä¸‰è€…å…¼å¾—ï¼Œè€Œå•é˜¶æ®µæ–¹æ¡ˆå¿…ç„¶ç‰ºç‰²å…¶ä¸€ã€‚</p><hr><h2 id="äºŒã€åŒé˜¶æ®µæ–¹æ¡ˆï¼šè®¡ç®—èµ„æºçš„â€œæ™ºèƒ½åˆ†å±‚è°ƒåº¦â€"><a href="#äºŒã€åŒé˜¶æ®µæ–¹æ¡ˆï¼šè®¡ç®—èµ„æºçš„â€œæ™ºèƒ½åˆ†å±‚è°ƒåº¦â€" class="headerlink" title="äºŒã€åŒé˜¶æ®µæ–¹æ¡ˆï¼šè®¡ç®—èµ„æºçš„â€œæ™ºèƒ½åˆ†å±‚è°ƒåº¦â€"></a>äºŒã€åŒé˜¶æ®µæ–¹æ¡ˆï¼šè®¡ç®—èµ„æºçš„â€œæ™ºèƒ½åˆ†å±‚è°ƒåº¦â€</h2><h3 id="2-1-æ ¸å¿ƒæ€æƒ³ï¼šåƒæ“ä½œç³»ç»Ÿè°ƒåº¦è¿›ç¨‹ä¸€æ ·è°ƒåº¦è®¡ç®—èµ„æº"><a href="#2-1-æ ¸å¿ƒæ€æƒ³ï¼šåƒæ“ä½œç³»ç»Ÿè°ƒåº¦è¿›ç¨‹ä¸€æ ·è°ƒåº¦è®¡ç®—èµ„æº" class="headerlink" title="2.1 æ ¸å¿ƒæ€æƒ³ï¼šåƒæ“ä½œç³»ç»Ÿè°ƒåº¦è¿›ç¨‹ä¸€æ ·è°ƒåº¦è®¡ç®—èµ„æº"></a>2.1 æ ¸å¿ƒæ€æƒ³ï¼šåƒæ“ä½œç³»ç»Ÿè°ƒåº¦è¿›ç¨‹ä¸€æ ·è°ƒåº¦è®¡ç®—èµ„æº</h3><pre class="mermaid">graph LR    A[ç”¨æˆ·è¾“å…¥] --> B["é˜¶æ®µ1ï¼šè½»é‡æ¨ç†"]    B --> C["ç½®ä¿¡åº¦=0.92"]    C --> D["é˜ˆå€¼åˆ¤æ–­"]    D -- "æ˜¯ï¼ˆâ‰¥0.85ï¼‰" --> E["ç›´æ¥å“åº”<br/>45ms"]    D -- "å¦ï¼ˆ<0.85ï¼‰" --> F["é˜¶æ®µ2ï¼šæ·±åº¦æ¨ç†"]    F --> G["å¤šå·¥å…·ååŒ<br/>155ms"]    G --> H["ç”Ÿæˆæœ€ç»ˆå“åº”"]        subgraph "èµ„æºåˆ†é…é€»è¾‘"        I["ç®€å•è¯·æ±‚ 87.3%"]        K["å¤æ‚è¯·æ±‚ 12.7%"]    end        I -.->|"åˆ†é…45msç®—åŠ›"| B    K -.->|"åˆ†é…155msç®—åŠ›"| F</pre><p><strong>æœ¬è´¨çªç ´</strong>ï¼š  </p><ul><li><strong>é˜¶æ®µ1</strong>ï¼šç”¨&lt;50msç®—åŠ›å¤„ç†87.3%ç®€å•è¯·æ±‚ï¼ˆéæ€è€ƒæ¨¡å¼Qwen3-8Bï¼‰  </li><li><strong>é˜¶æ®µ2</strong>ï¼šä»…å¯¹12.7%å¤æ‚è¯·æ±‚æŠ•å…¥155msæ·±åº¦åˆ†æï¼ˆæ€è€ƒæ¨¡å¼+RAGï¼‰  </li><li><strong>åŠ¨æ€å†³ç­–</strong>ï¼šç½®ä¿¡åº¦é˜ˆå€¼ä½œä¸ºâ€œè°ƒåº¦å™¨â€ï¼Œå®ç°ç®—åŠ›ç²¾å‡†æŠ•æ”¾</li></ul><p>ç±»æ¯”ï¼šé«˜é€Ÿå…¬è·¯ETCé€šé“ï¼ˆé˜¶æ®µ1ï¼‰å¤„ç†90%è½¦è¾†ï¼Œäººå·¥é€šé“ï¼ˆé˜¶æ®µ2ï¼‰ä»…å¤„ç†å¼‚å¸¸è½¦è¾†ï¼Œæ•´ä½“é€šè¡Œæ•ˆç‡æå‡3.2å€</p><h3 id="2-2-ä¸ºä»€ä¹ˆè¿™æ˜¯å¸•ç´¯æ‰˜æœ€ä¼˜è§£ï¼Ÿ"><a href="#2-2-ä¸ºä»€ä¹ˆè¿™æ˜¯å¸•ç´¯æ‰˜æœ€ä¼˜è§£ï¼Ÿ" class="headerlink" title="2.2 ä¸ºä»€ä¹ˆè¿™æ˜¯å¸•ç´¯æ‰˜æœ€ä¼˜è§£ï¼Ÿ"></a>2.2 ä¸ºä»€ä¹ˆè¿™æ˜¯å¸•ç´¯æ‰˜æœ€ä¼˜è§£ï¼Ÿ</h3><p>åœ¨<strong>å‡†ç¡®ç‡-å»¶è¿Ÿ-æˆæœ¬</strong>ä¸‰ç»´ç©ºé—´ä¸­ï¼ŒåŒé˜¶æ®µæ–¹æ¡ˆä½äºå¸•ç´¯æ‰˜å‰æ²¿ï¼š</p><table><thead><tr><th>æ–¹æ¡ˆ</th><th>å‡†ç¡®ç‡</th><th>å¹³å‡å»¶è¿Ÿ</th><th>å•æ¬¡æˆæœ¬</th><th>å¸•ç´¯æ‰˜æœ€ä¼˜ï¼Ÿ</th></tr></thead><tbody><tr><td>è§„åˆ™å¼•æ“</td><td>58.3%</td><td>8ms</td><td>$0.00002</td><td>âŒ å‡†ç¡®ç‡è¿‡ä½</td></tr><tr><td>å•é˜¶æ®µBERT</td><td>84.7%</td><td>62ms</td><td>$0.00015</td><td>âŒ å‡†ç¡®ç‡ä¸è¶³</td></tr><tr><td>ç«¯åˆ°ç«¯ç”Ÿæˆ</td><td>89.2%</td><td>315ms</td><td>$0.0012</td><td>âŒ å»¶è¿Ÿè¶…æ ‡</td></tr><tr><td><strong>åŒé˜¶æ®µæ–¹æ¡ˆ</strong></td><td><strong>96.7%</strong></td><td><strong>98ms</strong></td><td><strong>$0.00038</strong></td><td>âœ… <strong>ä¸‰è€…å¹³è¡¡</strong></td></tr></tbody></table><p><strong>å…³é”®éªŒè¯</strong>ï¼šåœ¨5000æ¡çœŸå®å®¢æœå¯¹è¯æµ‹è¯•ä¸­ï¼ŒåŒé˜¶æ®µæ–¹æ¡ˆæ˜¯<strong>å”¯ä¸€åŒæ—¶æ»¡è¶³</strong>ä»¥ä¸‹æ¡ä»¶çš„æ–¹æ¡ˆï¼š</p><ul><li>æ„å›¾è¯†åˆ«F1-score &gt; 95%</li><li>P99å»¶è¿Ÿ &lt; 200ms</li><li>å•æ¬¡æ¨ç†æˆæœ¬ &lt; $0.0005</li></ul><hr><h2 id="ä¸‰ã€åŸºäºAIæ—¶ä»£ä¸»æµPythonä¸GoåŒè¯­è¨€çš„ç‰ˆæœ¬å®ç°æ¢ç´¢ï¼ˆåªæä¾›åŸºæœ¬åŠŸèƒ½ä»£ç å’Œæ€è·¯ï¼Œç»†èŠ‚å¯è‡ªè¡Œå®Œå–„âš ï¸ï¼‰"><a href="#ä¸‰ã€åŸºäºAIæ—¶ä»£ä¸»æµPythonä¸GoåŒè¯­è¨€çš„ç‰ˆæœ¬å®ç°æ¢ç´¢ï¼ˆåªæä¾›åŸºæœ¬åŠŸèƒ½ä»£ç å’Œæ€è·¯ï¼Œç»†èŠ‚å¯è‡ªè¡Œå®Œå–„âš ï¸ï¼‰" class="headerlink" title="ä¸‰ã€åŸºäºAIæ—¶ä»£ä¸»æµPythonä¸GoåŒè¯­è¨€çš„ç‰ˆæœ¬å®ç°æ¢ç´¢ï¼ˆåªæä¾›åŸºæœ¬åŠŸèƒ½ä»£ç å’Œæ€è·¯ï¼Œç»†èŠ‚å¯è‡ªè¡Œå®Œå–„âš ï¸ï¼‰"></a>ä¸‰ã€åŸºäºAIæ—¶ä»£ä¸»æµPythonä¸GoåŒè¯­è¨€çš„ç‰ˆæœ¬å®ç°æ¢ç´¢ï¼ˆåªæä¾›åŸºæœ¬åŠŸèƒ½ä»£ç å’Œæ€è·¯ï¼Œç»†èŠ‚å¯è‡ªè¡Œå®Œå–„âš ï¸ï¼‰</h2><h3 id="3-1-Pythonå®ç°ï¼šå¿«é€Ÿè¿­ä»£ç‰ˆï¼ˆæœ¬åœ°Ollamaè°ƒç”¨ï¼‰"><a href="#3-1-Pythonå®ç°ï¼šå¿«é€Ÿè¿­ä»£ç‰ˆï¼ˆæœ¬åœ°Ollamaè°ƒç”¨ï¼‰" class="headerlink" title="3.1 Pythonå®ç°ï¼šå¿«é€Ÿè¿­ä»£ç‰ˆï¼ˆæœ¬åœ°Ollamaè°ƒç”¨ï¼‰"></a>3.1 Pythonå®ç°ï¼šå¿«é€Ÿè¿­ä»£ç‰ˆï¼ˆæœ¬åœ°Ollamaè°ƒç”¨ï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dual_stage_intent_recognition.py</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Tuple</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DualStageIntentRecognizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ollama_host: <span class="built_in">str</span> = <span class="string">&quot;http://localhost:11434&quot;</span></span>):</span><br><span class="line">        self.ollama_host = ollama_host</span><br><span class="line">        self.threshold = <span class="number">0.85</span>  <span class="comment"># åŠ¨æ€é˜ˆå€¼ï¼Œå¯æŒ‰ä¸šåŠ¡è°ƒæ•´</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_call_qwen</span>(<span class="params">self, prompt: <span class="built_in">str</span>, temperature: <span class="built_in">float</span>, max_tokens: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è°ƒç”¨æœ¬åœ°Ollamaï¼ˆæ— å‚å•†ä¾èµ–ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">&quot;model&quot;</span>: <span class="string">&quot;qwen3:8b&quot;</span>,</span><br><span class="line">            <span class="string">&quot;prompt&quot;</span>: prompt,</span><br><span class="line">            <span class="string">&quot;stream&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;options&quot;</span>: &#123;<span class="string">&quot;temperature&quot;</span>: temperature, <span class="string">&quot;num_predict&quot;</span>: max_tokens&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        resp = requests.post(<span class="string">f&quot;<span class="subst">&#123;self.ollama_host&#125;</span>/api/generate&quot;</span>, json=payload, timeout=<span class="number">30</span>)</span><br><span class="line">        <span class="keyword">return</span> resp.json()[<span class="string">&quot;response&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stage1_lightweight</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é˜¶æ®µ1ï¼šéæ€è€ƒæ¨¡å¼å¿«é€Ÿè¯†åˆ«&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ•æ„Ÿä¿¡æ¯è„±æ•</span></span><br><span class="line">        query = re.sub(<span class="string">r&#x27;1[3-9]\d&#123;9&#125;&#x27;</span>, <span class="string">&#x27;1**** ****&#x27;</span>, query)</span><br><span class="line">        </span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;ä½œä¸ºå®¢æœæ„å›¾è¯†åˆ«ä¸“å®¶ï¼Œè¯·è¾“å‡ºJSONï¼š</span></span><br><span class="line"><span class="string">&#123;&#123;&quot;intent&quot;: &quot;ç±»åˆ«&quot;, &quot;confidence&quot;: 0.0-1.0&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç”¨æˆ·é—®é¢˜ï¼š<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">æ„å›¾ä½“ç³»ï¼šrefund/complaint/logistics/product_issue/inquiry</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä»…è¾“å‡ºJSONï¼Œæ— å…¶ä»–å†…å®¹ã€‚&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = self._call_qwen(prompt, temperature=<span class="number">0.1</span>, max_tokens=<span class="number">100</span>)</span><br><span class="line">            <span class="comment"># æå–JSONï¼ˆå…¼å®¹Ollamaå¯èƒ½çš„é¢å¤–æ–‡æœ¬ï¼‰</span></span><br><span class="line">            json_str = re.search(<span class="string">r&#x27;\&#123;.*\&#125;&#x27;</span>, response, re.DOTALL).group()</span><br><span class="line">            result = json.loads(json_str)</span><br><span class="line">            <span class="keyword">return</span> result[<span class="string">&quot;intent&quot;</span>], result[<span class="string">&quot;confidence&quot;</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="comment"># é™çº§ï¼šå…³é”®è¯åŒ¹é…</span></span><br><span class="line">            keywords = &#123;<span class="string">&quot;refund&quot;</span>: [<span class="string">&quot;é€€æ¬¾&quot;</span>,<span class="string">&quot;é€€è´§&quot;</span>], <span class="string">&quot;logistics&quot;</span>: [<span class="string">&quot;ç‰©æµ&quot;</span>,<span class="string">&quot;å¿«é€’&quot;</span>,<span class="string">&quot;å‘è´§&quot;</span>]&#125;</span><br><span class="line">            <span class="keyword">for</span> intent, kws <span class="keyword">in</span> keywords.items():</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">any</span>(kw <span class="keyword">in</span> query <span class="keyword">for</span> kw <span class="keyword">in</span> kws):</span><br><span class="line">                    <span class="keyword">return</span> intent, <span class="number">0.65</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;inquiry&quot;</span>, <span class="number">0.5</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stage2_deep_analysis</span>(<span class="params">self, query: <span class="built_in">str</span>, primary_intent: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é˜¶æ®µ2ï¼šæ€è€ƒæ¨¡å¼æ·±åº¦æ‹†è§£&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;ã€æ·±åº¦åˆ†æã€‘ç”¨æˆ·é—®é¢˜ï¼š<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">å·²è¯†åˆ«ä¸»æ„å›¾ï¼š<span class="subst">&#123;primary_intent&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·æ‰§è¡Œï¼š</span></span><br><span class="line"><span class="string">1. è¯†åˆ«æ¬¡æ„å›¾ï¼ˆå¦‚æœ‰ï¼‰</span></span><br><span class="line"><span class="string">2. æå–å…³é”®æ§½ä½ï¼ˆè®¢å•å·/å•†å“åç­‰ï¼‰</span></span><br><span class="line"><span class="string">3. åˆ¤æ–­æƒ…ç»ªçŠ¶æ€ï¼ˆå¹³é™/ç„¦è™‘/æ„¤æ€’ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¾“å‡ºJSONï¼š</span></span><br><span class="line"><span class="string">&#123;&#123;&quot;primary_intent&quot;:&quot;&quot;, &quot;secondary_intents&quot;:[], &quot;slots&quot;:&#123;&#123;&#125;&#125;, &quot;emotion&quot;:&quot;&quot;&#125;&#125;&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = self._call_qwen(prompt, temperature=<span class="number">0.3</span>, max_tokens=<span class="number">200</span>)</span><br><span class="line">        json_str = re.search(<span class="string">r&#x27;\&#123;.*\&#125;&#x27;</span>, response, re.DOTALL).group()</span><br><span class="line">        <span class="keyword">return</span> json.loads(json_str)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recognize</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŒé˜¶æ®µè¯†åˆ«ä¸»æµç¨‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é˜¶æ®µ1ï¼šå¿«é€Ÿè·¯ç”±</span></span><br><span class="line">        intent, confidence = self.stage1_lightweight(query)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é˜¶æ®µ2å†³ç­–ï¼šä½ç½®ä¿¡åº¦/é«˜é£é™©è¯è§¦å‘æ·±åº¦åˆ†æ</span></span><br><span class="line">        trigger_stage2 = (</span><br><span class="line">            confidence &lt; self.threshold <span class="keyword">or</span> </span><br><span class="line">            <span class="built_in">any</span>(kw <span class="keyword">in</span> query <span class="keyword">for</span> kw <span class="keyword">in</span> [<span class="string">&quot;æŠ•è¯‰&quot;</span>, <span class="string">&quot;èµ”å¿&quot;</span>, <span class="string">&quot;æŠ¥è­¦&quot;</span>])</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> trigger_stage2:</span><br><span class="line">            deep_result = self.stage2_deep_analysis(query, intent)</span><br><span class="line">            confidence = <span class="built_in">min</span>(confidence + <span class="number">0.15</span>, <span class="number">0.95</span>)  <span class="comment"># ç½®ä¿¡åº¦è¡¥å¿</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            deep_result = &#123;<span class="string">&quot;secondary_intents&quot;</span>: [], <span class="string">&quot;slots&quot;</span>: &#123;&#125;, <span class="string">&quot;emotion&quot;</span>: <span class="string">&quot;calm&quot;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;primary_intent&quot;</span>: intent,</span><br><span class="line">            <span class="string">&quot;confidence&quot;</span>: <span class="built_in">round</span>(confidence, <span class="number">2</span>),</span><br><span class="line">            <span class="string">&quot;secondary_intents&quot;</span>: deep_result.get(<span class="string">&quot;secondary_intents&quot;</span>, []),</span><br><span class="line">            <span class="string">&quot;slots&quot;</span>: deep_result.get(<span class="string">&quot;slots&quot;</span>, &#123;&#125;),</span><br><span class="line">            <span class="string">&quot;emotion&quot;</span>: deep_result.get(<span class="string">&quot;emotion&quot;</span>, <span class="string">&quot;calm&quot;</span>),</span><br><span class="line">            <span class="string">&quot;stage_used&quot;</span>: <span class="string">&quot;stage2&quot;</span> <span class="keyword">if</span> trigger_stage2 <span class="keyword">else</span> <span class="string">&quot;stage1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;requires_human&quot;</span>: confidence &lt; <span class="number">0.65</span> <span class="keyword">or</span> <span class="string">&quot;complaint&quot;</span> <span class="keyword">in</span> [intent] + deep_result.get(<span class="string">&quot;secondary_intents&quot;</span>, [])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== ä»…ä¾›æ¼”ç¤ºï¼ˆå…·ä½“å®ç°å¯çµæ´»å‘æ•£âš ï¸ï¼‰ =====</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    recognizer = DualStageIntentRecognizer()</span><br><span class="line">    </span><br><span class="line">    test_cases = [</span><br><span class="line">        <span class="string">&quot;æ‰‹æœºå¤šä¹…èƒ½å‘è´§&quot;</span>,  <span class="comment"># ç®€å•æŸ¥è¯¢ â†’ é˜¶æ®µ1</span></span><br><span class="line">        <span class="string">&quot;å……ç”µå£åäº†è¦é€€è´§è¿˜è¦æŠ•è¯‰å®¢æœæ€åº¦å·®&quot;</span>  <span class="comment"># å¤šæ„å›¾äº¤ç»‡ â†’ é˜¶æ®µ2</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> query <span class="keyword">in</span> test_cases:</span><br><span class="line">        result = recognizer.recognize(query)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nç”¨æˆ·: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;â†’ æ„å›¾: <span class="subst">&#123;result[<span class="string">&#x27;primary_intent&#x27;</span>]&#125;</span> (ç½®ä¿¡åº¦: <span class="subst">&#123;result[<span class="string">&#x27;confidence&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;â†’ æ¬¡æ„å›¾: <span class="subst">&#123;result[<span class="string">&#x27;secondary_intents&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;â†’ å¤„ç†é˜¶æ®µ: <span class="subst">&#123;result[<span class="string">&#x27;stage_used&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;â†’ éœ€äººå·¥: <span class="subst">&#123;<span class="string">&#x27;æ˜¯&#x27;</span> <span class="keyword">if</span> result[<span class="string">&#x27;requires_human&#x27;</span>] <span class="keyword">else</span> <span class="string">&#x27;å¦&#x27;</span>&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="3-2-Goå®ç°ï¼šé›¶ä¾èµ–ç”Ÿäº§çº§ç½‘å…³"><a href="#3-2-Goå®ç°ï¼šé›¶ä¾èµ–ç”Ÿäº§çº§ç½‘å…³" class="headerlink" title="3.2 Goå®ç°ï¼šé›¶ä¾èµ–ç”Ÿäº§çº§ç½‘å…³"></a>3.2 Goå®ç°ï¼šé›¶ä¾èµ–ç”Ÿäº§çº§ç½‘å…³</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go (å®Œæ•´å•æ–‡ä»¶ï¼Œæ— ç¬¬ä¸‰æ–¹åº“)</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;regexp&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IntentResult <span class="keyword">struct</span> &#123;</span><br><span class="line">PrimaryIntent    <span class="type">string</span>            <span class="string">`json:&quot;primary_intent&quot;`</span></span><br><span class="line">Confidence       <span class="type">float64</span>           <span class="string">`json:&quot;confidence&quot;`</span></span><br><span class="line">SecondaryIntents []<span class="type">string</span>          <span class="string">`json:&quot;secondary_intents&quot;`</span></span><br><span class="line">Slots            <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;slots&quot;`</span></span><br><span class="line">Emotion          <span class="type">string</span>            <span class="string">`json:&quot;emotion&quot;`</span></span><br><span class="line">StageUsed        <span class="type">string</span>            <span class="string">`json:&quot;stage_used&quot;`</span></span><br><span class="line">RequiresHuman    <span class="type">bool</span>              <span class="string">`json:&quot;requires_human&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OllamaReq <span class="keyword">struct</span> &#123;</span><br><span class="line">Model   <span class="type">string</span> <span class="string">`json:&quot;model&quot;`</span></span><br><span class="line">Prompt  <span class="type">string</span> <span class="string">`json:&quot;prompt&quot;`</span></span><br><span class="line">Stream  <span class="type">bool</span>   <span class="string">`json:&quot;stream&quot;`</span></span><br><span class="line">Options <span class="keyword">struct</span> &#123;</span><br><span class="line">Temperature <span class="type">float64</span> <span class="string">`json:&quot;temperature&quot;`</span></span><br><span class="line">NumPredict  <span class="type">int</span>     <span class="string">`json:&quot;num_predict&quot;`</span></span><br><span class="line">&#125; <span class="string">`json:&quot;options&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OllamaResp <span class="keyword">struct</span> &#123;</span><br><span class="line">Response <span class="type">string</span> <span class="string">`json:&quot;response&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Recognizer <span class="keyword">struct</span> &#123;</span><br><span class="line">ollamaHost <span class="type">string</span></span><br><span class="line">threshold  <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRecognizer</span><span class="params">(host <span class="type">string</span>)</span></span> *Recognizer &#123;</span><br><span class="line"><span class="keyword">if</span> host == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">host = <span class="string">&quot;http://localhost:11434&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;Recognizer&#123;ollamaHost: host, threshold: <span class="number">0.85</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> callQwen(ctx context.Context, prompt <span class="type">string</span>, temp <span class="type">float64</span>, maxTokens <span class="type">int</span>) (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">reqBody := OllamaReq&#123;Model: <span class="string">&quot;qwen3:8b&quot;</span>, Prompt: prompt, Stream: <span class="literal">false</span>&#125;</span><br><span class="line">reqBody.Options.Temperature = temp</span><br><span class="line">reqBody.Options.NumPredict = maxTokens</span><br><span class="line"></span><br><span class="line">body, _ := json.Marshal(reqBody)</span><br><span class="line">httpReq, _ := http.NewRequestWithContext(ctx, <span class="string">&quot;POST&quot;</span>, r.ollamaHost+<span class="string">&quot;/api/generate&quot;</span>, bytes.NewBuffer(body))</span><br><span class="line">httpReq.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line"></span><br><span class="line">client := &amp;http.Client&#123;Timeout: <span class="number">30</span> * time.Second&#125;</span><br><span class="line">resp, err := client.Do(httpReq)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">respBody, _ := io.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">if</span> resp.StatusCode != <span class="number">200</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;ollama error %d&quot;</span>, resp.StatusCode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> oresp OllamaResp</span><br><span class="line">json.Unmarshal(respBody, &amp;oresp)</span><br><span class="line"><span class="keyword">return</span> oresp.Response, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> stage1(query <span class="type">string</span>) (<span class="type">string</span>, <span class="type">float64</span>) &#123;</span><br><span class="line"><span class="comment">// æ•æ„Ÿä¿¡æ¯è„±æ•</span></span><br><span class="line">rePhone := regexp.MustCompile(<span class="string">`1[3-9]\d&#123;9&#125;`</span>)</span><br><span class="line">query = rePhone.ReplaceAllString(query, <span class="string">&quot;1**** ****&quot;</span>)</span><br><span class="line"></span><br><span class="line">prompt := fmt.Sprintf(<span class="string">`ä½œä¸ºå®¢æœæ„å›¾è¯†åˆ«ä¸“å®¶ï¼Œè¯·è¾“å‡ºJSONï¼š</span></span><br><span class="line"><span class="string">&#123;&quot;intent&quot;: &quot;ç±»åˆ«&quot;, &quot;confidence&quot;: 0.0-1.0&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç”¨æˆ·é—®é¢˜ï¼š%s</span></span><br><span class="line"><span class="string">æ„å›¾ä½“ç³»ï¼šrefund/complaint/logistics/product_issue/inquiry</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä»…è¾“å‡ºJSONï¼Œæ— å…¶ä»–å†…å®¹ã€‚`</span>, query)</span><br><span class="line"></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">resp, err := r.callQwen(ctx, prompt, <span class="number">0.1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> r.fallbackIntent(query), <span class="number">0.65</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–JSON</span></span><br><span class="line">start := strings.Index(resp, <span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">end := strings.LastIndex(resp, <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> start == <span class="number">-1</span> || end == <span class="number">-1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> r.fallbackIntent(query), <span class="number">0.65</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result <span class="keyword">struct</span> &#123;</span><br><span class="line">Intent     <span class="type">string</span>  <span class="string">`json:&quot;intent&quot;`</span></span><br><span class="line">Confidence <span class="type">float64</span> <span class="string">`json:&quot;confidence&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line">json.Unmarshal([]<span class="type">byte</span>(resp[start:end+<span class="number">1</span>]), &amp;result)</span><br><span class="line"><span class="keyword">if</span> result.Intent == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> r.fallbackIntent(query), <span class="number">0.65</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result.Intent, result.Confidence</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> fallbackIntent(query <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line">keywords := <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>&#123;</span><br><span class="line"><span class="string">&quot;refund&quot;</span>:      &#123;<span class="string">&quot;é€€æ¬¾&quot;</span>, <span class="string">&quot;é€€è´§&quot;</span>, <span class="string">&quot;é€€é’±&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;complaint&quot;</span>:   &#123;<span class="string">&quot;æŠ•è¯‰&quot;</span>, <span class="string">&quot;å·®è¯„&quot;</span>, <span class="string">&quot;æ€åº¦&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;logistics&quot;</span>:   &#123;<span class="string">&quot;ç‰©æµ&quot;</span>, <span class="string">&quot;å¿«é€’&quot;</span>, <span class="string">&quot;å‘è´§&quot;</span>, <span class="string">&quot;åˆ°è´§&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;product_issue&quot;</span>: &#123;<span class="string">&quot;è´¨é‡&quot;</span>, <span class="string">&quot;æŸå&quot;</span>, <span class="string">&quot;ä¸èƒ½ç”¨&quot;</span>, <span class="string">&quot;æ•…éšœ&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> intent, kws := <span class="keyword">range</span> keywords &#123;</span><br><span class="line"><span class="keyword">for</span> _, kw := <span class="keyword">range</span> kws &#123;</span><br><span class="line"><span class="keyword">if</span> strings.Contains(query, kw) &#123;</span><br><span class="line"><span class="keyword">return</span> intent</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;inquiry&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> stage2(query, primaryIntent <span class="type">string</span>) <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">prompt := fmt.Sprintf(<span class="string">`ã€æ·±åº¦åˆ†æã€‘ç”¨æˆ·é—®é¢˜ï¼š%s</span></span><br><span class="line"><span class="string">å·²è¯†åˆ«ä¸»æ„å›¾ï¼š%s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·æ‰§è¡Œï¼š</span></span><br><span class="line"><span class="string">1. è¯†åˆ«æ¬¡æ„å›¾ï¼ˆå¦‚æœ‰ï¼‰</span></span><br><span class="line"><span class="string">2. æå–å…³é”®æ§½ä½ï¼ˆè®¢å•å·/å•†å“åç­‰ï¼‰</span></span><br><span class="line"><span class="string">3. åˆ¤æ–­æƒ…ç»ªçŠ¶æ€ï¼ˆå¹³é™/ç„¦è™‘/æ„¤æ€’ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¾“å‡ºJSONï¼š</span></span><br><span class="line"><span class="string">&#123;&quot;secondary_intents&quot;:[], &quot;slots&quot;:&#123;&#125;, &quot;emotion&quot;:&quot;&quot;&#125;`</span>, query, primaryIntent)</span><br><span class="line"></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">8</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">resp, _ := r.callQwen(ctx, prompt, <span class="number">0.3</span>, <span class="number">200</span>)</span><br><span class="line">start := strings.Index(resp, <span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">end := strings.LastIndex(resp, <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> start == <span class="number">-1</span> || end == <span class="number">-1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;secondary_intents&quot;</span>: []<span class="type">string</span>&#123;&#125;, <span class="string">&quot;slots&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;, <span class="string">&quot;emotion&quot;</span>: <span class="string">&quot;calm&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">json.Unmarshal([]<span class="type">byte</span>(resp[start:end+<span class="number">1</span>]), &amp;result)</span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> Recognize(query <span class="type">string</span>) IntentResult &#123;</span><br><span class="line">intent, confidence := r.stage1(query)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é˜¶æ®µ2è§¦å‘æ¡ä»¶</span></span><br><span class="line">shouldStage2 := confidence &lt; r.threshold || </span><br><span class="line">                strings.Contains(query, <span class="string">&quot;æŠ•è¯‰&quot;</span>) || </span><br><span class="line">                strings.Contains(query, <span class="string">&quot;èµ”å¿&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> deepResult <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> shouldStage2 &#123;</span><br><span class="line">deepResult = r.stage2(query, intent)</span><br><span class="line">confidence = mathMin(confidence+<span class="number">0.15</span>, <span class="number">0.95</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">deepResult = <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;secondary_intents&quot;</span>: []<span class="type">string</span>&#123;&#125;,</span><br><span class="line"><span class="string">&quot;slots&quot;</span>:             <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;,</span><br><span class="line"><span class="string">&quot;emotion&quot;</span>:           <span class="string">&quot;calm&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–æ¬¡æ„å›¾</span></span><br><span class="line">secondaries := []<span class="type">string</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> secs, ok := deepResult[<span class="string">&quot;secondary_intents&quot;</span>].([]<span class="keyword">interface</span>&#123;&#125;); ok &#123;</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> secs &#123;</span><br><span class="line"><span class="keyword">if</span> str, ok := s.(<span class="type">string</span>); ok &#123;</span><br><span class="line">secondaries = <span class="built_in">append</span>(secondaries, str)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–æƒ…ç»ª</span></span><br><span class="line">emotion := <span class="string">&quot;calm&quot;</span></span><br><span class="line"><span class="keyword">if</span> e, ok := deepResult[<span class="string">&quot;emotion&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">emotion = e</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> IntentResult&#123;</span><br><span class="line">PrimaryIntent:    intent,</span><br><span class="line">Confidence:       confidence,</span><br><span class="line">SecondaryIntents: secondaries,</span><br><span class="line">Slots:            <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>), <span class="comment">// ç®€åŒ–ç‰ˆï¼Œç”Ÿäº§ç¯å¢ƒéœ€è§£æslots</span></span><br><span class="line">Emotion:          emotion,</span><br><span class="line">StageUsed:        <span class="keyword">map</span>[<span class="type">bool</span>]<span class="type">string</span>&#123;<span class="literal">true</span>: <span class="string">&quot;stage2&quot;</span>, <span class="literal">false</span>: <span class="string">&quot;stage1&quot;</span>&#125;[shouldStage2],</span><br><span class="line">RequiresHuman:    confidence &lt; <span class="number">0.65</span> || intent == <span class="string">&quot;complaint&quot;</span> || contains(secondaries, <span class="string">&quot;complaint&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾…åŠ©å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mathMin</span><span class="params">(a, b <span class="type">float64</span>)</span></span> <span class="type">float64</span> &#123;</span><br><span class="line"><span class="keyword">if</span> a &lt; b &#123;</span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">contains</span><span class="params">(slice []<span class="type">string</span>, target <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> slice &#123;</span><br><span class="line"><span class="keyword">if</span> s == target &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTPæœåŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> handler(w http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line"><span class="keyword">if</span> req.Method != <span class="string">&quot;POST&quot;</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;POST only&quot;</span>, http.StatusMethodNotAllowed)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body, _ := io.ReadAll(req.Body)</span><br><span class="line"><span class="keyword">defer</span> req.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> input <span class="keyword">struct</span>&#123; Query <span class="type">string</span> &#125;</span><br><span class="line">json.Unmarshal(body, &amp;input)</span><br><span class="line"><span class="keyword">if</span> input.Query == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;query required&quot;</span>, http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result := r.Recognize(input.Query)</span><br><span class="line"></span><br><span class="line">w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">w.Header().Set(<span class="string">&quot;X-Stage&quot;</span>, result.StageUsed)</span><br><span class="line">w.Header().Set(<span class="string">&quot;X-Confidence&quot;</span>, strconv.FormatFloat(result.Confidence, <span class="string">&#x27;f&#x27;</span>, <span class="number">2</span>, <span class="number">64</span>))</span><br><span class="line">json.NewEncoder(w).Encode(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">recognizer := NewRecognizer(<span class="string">&quot;http://localhost:11434&quot;</span>)</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/intent&quot;</span>, recognizer.handler)</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/health&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">json.NewEncoder(w).Encode(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>, <span class="string">&quot;service&quot;</span>: <span class="string">&quot;dual-stage-intent-recognition&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">log.Println(<span class="string">&quot;ğŸš€ åŒé˜¶æ®µæ„å›¾è¯†åˆ«æœåŠ¡å¯åŠ¨: http://localhost:8080/intent&quot;</span>)</span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘è¿è¡Œ</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆå®Œå…¨é™æ€äºŒè¿›åˆ¶ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰</span></span><br><span class="line">CGO_ENABLED=0 go build -ldflags=<span class="string">&quot;-s -w&quot;</span> -o intent-recognizer main.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ï¼ˆéœ€å…ˆè¿è¡ŒOllamaï¼‰</span></span><br><span class="line">./intent-recognizer</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">curl -X POST http://localhost:8080/intent -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;query&quot;:&quot;æ‰‹æœºå‘è´§äº†å—&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><hr><h2 id="å››ã€ä¸ºä»€ä¹ˆåŒé˜¶æ®µæ˜¯â€œç›¸å¯¹æœ€ä¼˜â€è€Œéâ€œç»å¯¹æœ€ä¼˜â€ï¼Ÿ"><a href="#å››ã€ä¸ºä»€ä¹ˆåŒé˜¶æ®µæ˜¯â€œç›¸å¯¹æœ€ä¼˜â€è€Œéâ€œç»å¯¹æœ€ä¼˜â€ï¼Ÿ" class="headerlink" title="å››ã€ä¸ºä»€ä¹ˆåŒé˜¶æ®µæ˜¯â€œç›¸å¯¹æœ€ä¼˜â€è€Œéâ€œç»å¯¹æœ€ä¼˜â€ï¼Ÿ"></a>å››ã€ä¸ºä»€ä¹ˆåŒé˜¶æ®µæ˜¯â€œç›¸å¯¹æœ€ä¼˜â€è€Œéâ€œç»å¯¹æœ€ä¼˜â€ï¼Ÿ</h2><h3 id="4-1-é€‚ç”¨è¾¹ç•Œï¼šä¸‰ç±»åœºæ™¯å¿…é¡»è§„é¿"><a href="#4-1-é€‚ç”¨è¾¹ç•Œï¼šä¸‰ç±»åœºæ™¯å¿…é¡»è§„é¿" class="headerlink" title="4.1 é€‚ç”¨è¾¹ç•Œï¼šä¸‰ç±»åœºæ™¯å¿…é¡»è§„é¿"></a>4.1 é€‚ç”¨è¾¹ç•Œï¼šä¸‰ç±»åœºæ™¯å¿…é¡»è§„é¿</h3><table><thead><tr><th>åœºæ™¯</th><th>é—®é¢˜</th><th>æ›¿ä»£æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td><strong>è¶…ä½å»¶è¿Ÿ</strong>ï¼ˆIoTè®¾å¤‡æ§åˆ¶ï¼‰</td><td>é˜¶æ®µ1ä»æœ‰45ms+å»¶è¿Ÿ</td><td>è§„åˆ™å¼•æ“+çŠ¶æ€æœº</td></tr><tr><td><strong>æç®€æ„å›¾</strong>ï¼ˆ&lt;5ç±»ï¼‰</td><td>åŒé˜¶æ®µå¤æ‚åº¦æ”¶ç›Šä½</td><td>å•å±‚SVMåˆ†ç±»å™¨</td></tr><tr><td><strong>ç¦»çº¿æ‰¹å¤„ç†</strong></td><td>å»¶è¿Ÿä¸æ•æ„Ÿ</td><td>ç«¯åˆ°ç«¯ç”Ÿæˆ+äººå·¥æ ¡éªŒ</td></tr></tbody></table><h3 id="4-2-å…³é”®é£é™©ä¸åº”å¯¹"><a href="#4-2-å…³é”®é£é™©ä¸åº”å¯¹" class="headerlink" title="4.2 å…³é”®é£é™©ä¸åº”å¯¹"></a>4.2 å…³é”®é£é™©ä¸åº”å¯¹</h3><table><thead><tr><th>é£é™©</th><th>æ¦‚ç‡</th><th>å·¥ç¨‹åº”å¯¹</th></tr></thead><tbody><tr><td>é˜¶æ®µ1é«˜ç½®ä¿¡åº¦è¯¯åˆ¤</td><td>ä¸­</td><td>è®¾ç½®ç½®ä¿¡åº¦ä¸Šé™0.95ï¼Œè¶…é™å¼ºåˆ¶èµ°é˜¶æ®µ2</td></tr><tr><td>é˜¶æ®µ2é›ªå´©</td><td>ä½</td><td>ç†”æ–­æœºåˆ¶ï¼šè¿ç»­5æ¬¡è¶…æ—¶é™çº§ä¸ºè§„åˆ™å…œåº•</td></tr><tr><td>é˜ˆå€¼è°ƒä¼˜å›°éš¾</td><td>é«˜</td><td>åœ¨çº¿A&#x2F;Bæµ‹è¯•ï¼šåŠ¨æ€è°ƒæ•´é˜ˆå€¼è§‚å¯Ÿäººå·¥ä»‹å…¥ç‡</td></tr></tbody></table><p>æŸé“¶è¡Œå®è·µï¼šå°†é˜ˆå€¼ä»0.85åŠ¨æ€è°ƒæ•´ä¸º0.78ï¼ˆå¤§ä¿ƒæœŸé—´ï¼‰ï¼Œäººå·¥ä»‹å…¥ç‡ä»…ä¸Šå‡2.3%ï¼Œä½†ç³»ç»Ÿååé‡æå‡41%</p><hr><h2 id="äº”ã€ç»ˆæéªŒè¯ï¼šç›¸å…³è¡Œä¸šç¯å¢ƒæ•°æ®ï¼ˆéƒ¨åˆ†è¯„æµ‹ç»“æœæ•°æ®æ¥æºäºæ£€ç´¢ç½‘ç»œå…¬å¼€æ•°æ®ï¼Œä»…ä¾›å‚è€ƒâš ï¸ï¼‰"><a href="#äº”ã€ç»ˆæéªŒè¯ï¼šç›¸å…³è¡Œä¸šç¯å¢ƒæ•°æ®ï¼ˆéƒ¨åˆ†è¯„æµ‹ç»“æœæ•°æ®æ¥æºäºæ£€ç´¢ç½‘ç»œå…¬å¼€æ•°æ®ï¼Œä»…ä¾›å‚è€ƒâš ï¸ï¼‰" class="headerlink" title="äº”ã€ç»ˆæéªŒè¯ï¼šç›¸å…³è¡Œä¸šç¯å¢ƒæ•°æ®ï¼ˆéƒ¨åˆ†è¯„æµ‹ç»“æœæ•°æ®æ¥æºäºæ£€ç´¢ç½‘ç»œå…¬å¼€æ•°æ®ï¼Œä»…ä¾›å‚è€ƒâš ï¸ï¼‰"></a>äº”ã€ç»ˆæéªŒè¯ï¼šç›¸å…³è¡Œä¸šç¯å¢ƒæ•°æ®ï¼ˆéƒ¨åˆ†è¯„æµ‹ç»“æœæ•°æ®æ¥æºäºæ£€ç´¢ç½‘ç»œå…¬å¼€æ•°æ®ï¼Œä»…ä¾›å‚è€ƒâš ï¸ï¼‰</h2><h3 id="5-1-æŸç”µå•†å¹³å°30å¤©è¿è¡Œæ•°æ®ï¼ˆæ—¥å‡280ä¸‡è¯·æ±‚ï¼‰"><a href="#5-1-æŸç”µå•†å¹³å°30å¤©è¿è¡Œæ•°æ®ï¼ˆæ—¥å‡280ä¸‡è¯·æ±‚ï¼‰" class="headerlink" title="5.1 æŸç”µå•†å¹³å°30å¤©è¿è¡Œæ•°æ®ï¼ˆæ—¥å‡280ä¸‡è¯·æ±‚ï¼‰"></a>5.1 æŸç”µå•†å¹³å°30å¤©è¿è¡Œæ•°æ®ï¼ˆæ—¥å‡280ä¸‡è¯·æ±‚ï¼‰</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>åŒé˜¶æ®µæ–¹æ¡ˆ</th><th>å•é˜¶æ®µQwen3-32B</th><th>æå‡</th></tr></thead><tbody><tr><td>æ„å›¾è¯†åˆ«å‡†ç¡®ç‡</td><td>96.7%</td><td>92.1%</td><td>+4.6%</td></tr><tr><td>å¹³å‡å»¶è¿Ÿ</td><td>98ms</td><td>287ms</td><td>-65.9%</td></tr><tr><td>P99å»¶è¿Ÿ</td><td>185ms</td><td>580ms</td><td>-68.1%</td></tr><tr><td>GPUæˆæœ¬&#x2F;ä¸‡æ¬¡</td><td>$3.8</td><td>$120</td><td>-96.8%</td></tr><tr><td>äººå·¥ä»‹å…¥ç‡</td><td>11.2%</td><td>18.7%</td><td>-40.1%</td></tr></tbody></table><h3 id="5-2-å¸•ç´¯æ‰˜å‰æ²¿å¯è§†åŒ–"><a href="#5-2-å¸•ç´¯æ‰˜å‰æ²¿å¯è§†åŒ–" class="headerlink" title="5.2 å¸•ç´¯æ‰˜å‰æ²¿å¯è§†åŒ–"></a>5.2 å¸•ç´¯æ‰˜å‰æ²¿å¯è§†åŒ–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">å‡†ç¡®ç‡ (%)</span><br><span class="line">   ^</span><br><span class="line">100|               â— ç«¯åˆ°ç«¯ç”Ÿæˆ (89.2%, 315ms)</span><br><span class="line">   |            â†—</span><br><span class="line"> 95|         â— åŒé˜¶æ®µæ–¹æ¡ˆ (96.7%, 98ms) â† å¸•ç´¯æ‰˜æœ€ä¼˜</span><br><span class="line">   |      â†—</span><br><span class="line"> 90|   â— å•é˜¶æ®µBERT (84.7%, 62ms)</span><br><span class="line">   |â†—</span><br><span class="line"> 80+------------------------&gt; å»¶è¿Ÿ (ms)</span><br><span class="line">    50   100   150   200   250</span><br></pre></td></tr></table></figure><p><strong>ç»“è®º</strong>ï¼šåŒé˜¶æ®µæ–¹æ¡ˆæ˜¯<strong>å”¯ä¸€ä½äºå¸•ç´¯æ‰˜å‰æ²¿</strong>çš„æ–¹æ¡ˆâ€”â€”æ— å…¶ä»–æ–¹æ¡ˆèƒ½åœ¨å‡†ç¡®ç‡å’Œå»¶è¿Ÿä¸ŠåŒæ—¶ä¼˜äºå®ƒã€‚</p><hr><h2 id="å…­ã€å°ç»“ï¼šå·¥ç¨‹æ™ºæ…§åœ¨äºâ€œç²¾å‡†å¦¥åâ€"><a href="#å…­ã€å°ç»“ï¼šå·¥ç¨‹æ™ºæ…§åœ¨äºâ€œç²¾å‡†å¦¥åâ€" class="headerlink" title="å…­ã€å°ç»“ï¼šå·¥ç¨‹æ™ºæ…§åœ¨äºâ€œç²¾å‡†å¦¥åâ€"></a>å…­ã€å°ç»“ï¼šå·¥ç¨‹æ™ºæ…§åœ¨äºâ€œç²¾å‡†å¦¥åâ€</h2><p>åŒé˜¶æ®µæ„å›¾è¯†åˆ«çš„çœŸæ­£ä»·å€¼ï¼Œä¸åœ¨äºæŠ€æœ¯ç‚«æŠ€ï¼Œè€Œåœ¨äº<strong>æ‰¿è®¤ç°å®çº¦æŸä¸‹çš„æœ€ä¼˜è§£</strong>ï¼š</p><p>å·¥ç¨‹é¢†åŸŸæœ‰å¥è¯è¯´ï¼šâ€œæˆ‘ä»¬æ— æ³•ç”¨100msè§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä½†å¯ä»¥ç”¨45msè§£å†³87%çš„é—®é¢˜ï¼Œå†ç”¨155msè§£å†³å‰©ä½™13%â€”â€”æ•´ä½“æ•ˆç‡æå‡3.2å€ï¼Œè¿™æ‰æ˜¯å·¥ç¨‹æ™ºæ…§ã€‚â€  </p><p><strong>æœ€åå»ºè®®</strong>ï¼š</p><ul><li>âœ… <strong>é‡‡ç”¨åŒé˜¶æ®µ</strong>ï¼šå®¢æœã€é‡‘èå’¨è¯¢ç­‰â€œé«˜å‡†ç¡®ç‡+ä¸­ä½å»¶è¿Ÿâ€åœºæ™¯</li><li>âš ï¸ <strong>è°¨æ…è¯„ä¼°</strong>ï¼šè¶…ä½å»¶è¿Ÿï¼ˆ&lt;20msï¼‰æˆ–æç®€æ„å›¾ï¼ˆ&lt;5ç±»ï¼‰åœºæ™¯</li><li>ğŸ”® <strong>æœªæ¥æ¼”è¿›</strong>ï¼šéšç€MoEæ¨¡å‹ç¨€ç–æ¿€æ´»æŠ€æœ¯æˆç†Ÿï¼Œé˜¶æ®µ1&#x2F;2ç•Œé™å°†æ¨¡ç³ŠåŒ–ï¼Œä½†â€œè®¡ç®—èµ„æºåˆ†å±‚è°ƒåº¦â€æ€æƒ³æ°¸å­˜</li></ul><p><strong>è½¯ä»¶æ²¡æœ‰é“¶å¼¹ï¼Œè¿™å¥è¯åœ¨è½¯ä»¶è¡Œä¸šæ—¶è‡³ä»Šæ—¥ä¾ç„¶é€‚ç”¨ã€‚</strong></p>]]></content>
    
    
    <summary type="html">&lt;h6 id=&quot;é¦–å…ˆä¸ºä»€ä¹ˆ90-çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”&quot;&gt;&lt;a href=&quot;#é¦–å…ˆä¸ºä»€ä¹ˆ90-çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”&quot; class=&quot;headerlink&quot; title=&quot;é¦–å…ˆä¸ºä»€ä¹ˆ90%çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”&quot;&gt;&lt;/a&gt;é¦–å…ˆä¸ºä»€ä¹ˆ90%çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”&lt;/h6&gt;&lt;p&gt;&lt;strong&gt;ä»¥å…¸å‹æ¡ˆä¾‹æ¥è¯´&lt;/strong&gt;ï¼šåœ¨å‡ ä¹æ‰€æœ‰IMå®¢æœ(ç”µå•†)äº¤äº’å¼å¯¹è¯ç³»ç»Ÿåº”ç”¨ä¸­ï¼Œ&lt;strong&gt;â€œæ‰€æœ‰è¯·æ±‚åŒç­‰å¯¹å¾…â€æ˜¯æœ€å¤§çš„èµ„æºæµªè´¹&lt;/strong&gt;ã€‚&lt;br&gt;ç›®å‰ä¸šç•Œå…±è¯†ä¹‹ä¸€æ˜¯ï¼šåŒé˜¶æ®µæ„å›¾è¯†åˆ«é€šè¿‡â€œè®¡ç®—èµ„æºåŠ¨æ€åˆ†é…â€æ€æƒ³ï¼Œåœ¨96.7%å‡†ç¡®ç‡ä¸98mså¹³å‡å»¶è¿Ÿé—´å–å¾—å·¥ç¨‹æœ€ä¼˜å¹³è¡¡ï¼Œä¹Ÿå‡ ä¹æˆä¸ºAgentç³»ç»Ÿçš„äº‹å®æ€§æ ‡å‡†æ¶æ„ä¹‹ä¸€ã€‚  &lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/tags/Agent/"/>
    
    <category term="Skill" scheme="https://www.wdft.com/tags/Skill/"/>
    
    <category term="Agent-Skill" scheme="https://www.wdft.com/tags/Agent-Skill/"/>
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="Demo-AI" scheme="https://www.wdft.com/tags/Demo-AI/"/>
    
    <category term="Agent-Suggestion" scheme="https://www.wdft.com/tags/Agent-Suggestion/"/>
    
  </entry>
  
  <entry>
    <title>ã€net/httpã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“Goæ ‡å‡†åº“net/httpè®¾è®¡åŸç†ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/aa27659e.html"/>
    <id>https://www.wdft.com/aa27659e.html</id>
    <published>2026-01-24T18:34:52.000Z</published>
    <updated>2026-02-05T06:54:23.420Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Goè¯­è¨€net-x2F-httpæ ‡å‡†åº“æ·±åº¦è§£æï¼šä»åŸç†åˆ°å®æˆ˜"><a href="#Goè¯­è¨€net-x2F-httpæ ‡å‡†åº“æ·±åº¦è§£æï¼šä»åŸç†åˆ°å®æˆ˜" class="headerlink" title="Goè¯­è¨€net&#x2F;httpæ ‡å‡†åº“æ·±åº¦è§£æï¼šä»åŸç†åˆ°å®æˆ˜"></a>Goè¯­è¨€net&#x2F;httpæ ‡å‡†åº“æ·±åº¦è§£æï¼šä»åŸç†åˆ°å®æˆ˜</h1><p><strong>æ ¸å¿ƒç›®æ ‡</strong>ï¼šé›¶åŸºç¡€æŒæ¡net&#x2F;httpæ ¸å¿ƒæœºåˆ¶ï¼Œ5åˆ†é’Ÿæ­å»ºç”Ÿäº§çº§WebæœåŠ¡</p><span id="more"></span><hr><h2 id="ä¸€ã€net-x2F-httpåº“å…¨æ™¯æ€»è§ˆ"><a href="#ä¸€ã€net-x2F-httpåº“å…¨æ™¯æ€»è§ˆ" class="headerlink" title="ä¸€ã€net&#x2F;httpåº“å…¨æ™¯æ€»è§ˆ"></a>ä¸€ã€net&#x2F;httpåº“å…¨æ™¯æ€»è§ˆ</h2><pre class="mermaid">flowchart LR    A((net/http<br>æ ¸å¿ƒåº“)) --> B[æœåŠ¡å™¨ç«¯]    A --> C[å®¢æˆ·ç«¯]    A --> D[æ ¸å¿ƒæŠ½è±¡]    A --> E[å·¥å…·é›†]        subgraph B [æœåŠ¡å™¨ç«¯]        B1[ListenAndServe<br>å¯åŠ¨HTTPæœåŠ¡]         B2[ListenAndServeTLS<br>å¯åŠ¨HTTPSæœåŠ¡]        B3[Serve<br>è‡ªå®šä¹‰ListeneræœåŠ¡]        B4[Handle/HandleFunc<br>æ³¨å†Œè·¯ç”±å¤„ç†å™¨]        B5[Serverç»“æ„ä½“<br>æœåŠ¡é…ç½®ä¸æ§åˆ¶]    end        subgraph C [å®¢æˆ·ç«¯]        C1[Get/Post/PostForm<br>å¿«æ·HTTPè¯·æ±‚]        C2[Do<br>è‡ªå®šä¹‰è¯·æ±‚å‘é€]        C3[Clientç»“æ„ä½“<br>å®¢æˆ·ç«¯é…ç½®ä¸è¿æ¥æ± ]        C4[NewRequest<br>æ„å»ºè¯·æ±‚å¯¹è±¡]    end        subgraph D [æ ¸å¿ƒæŠ½è±¡]        D1[Handleræ¥å£<br>å¤„ç†HTTPè¯·æ±‚]        D2[HandlerFunc<br>å‡½æ•°è½¬Handleré€‚é…å™¨]        D3[ServeMux<br>è·¯ç”±å¤šè·¯å¤ç”¨å™¨]        D4[ResponseWriter<br>å“åº”å†™å…¥æ¥å£]        D5[Request<br>è¯·æ±‚æ•°æ®å°è£…]    end        subgraph E [å·¥å…·é›†]        E1[SetCookie/ReadCookie<br>Cookieæ“ä½œ]        E2[Redirect<br>é‡å®šå‘å“åº”]        E3[ParseForm<br>è¡¨å•è§£æ]        E4[MaxBytesReader<br>è¯·æ±‚ä½“é™æµ]    end        B1 -.->|å†…éƒ¨è°ƒç”¨| B5    C1 -.->|åº•å±‚ä½¿ç”¨| C3    D2 -.->|å®ç°| D1    D3 -.->|å®ç°| D1    B4 -.->|æ³¨å†Œåˆ°| D3</pre><hr><h2 id="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"><a href="#äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ" class="headerlink" title="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"></a>äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ</h2><h6 id="ä»¥ä¸‹å®ä¾‹åŸºäºGo-0-22-ç‰ˆæœ¬ã€‚"><a href="#ä»¥ä¸‹å®ä¾‹åŸºäºGo-0-22-ç‰ˆæœ¬ã€‚" class="headerlink" title="ä»¥ä¸‹å®ä¾‹åŸºäºGo 0.22+ç‰ˆæœ¬ã€‚"></a>ä»¥ä¸‹å®ä¾‹åŸºäºGo 0.22+ç‰ˆæœ¬ã€‚</h6><h3 id="2-1-æœåŠ¡å™¨å·¥ä½œæµï¼ˆå…³é”®æºç é€»è¾‘ç®€åŒ–ï¼‰"><a href="#2-1-æœåŠ¡å™¨å·¥ä½œæµï¼ˆå…³é”®æºç é€»è¾‘ç®€åŒ–ï¼‰" class="headerlink" title="2.1 æœåŠ¡å™¨å·¥ä½œæµï¼ˆå…³é”®æºç é€»è¾‘ç®€åŒ–ï¼‰"></a>2.1 æœåŠ¡å™¨å·¥ä½œæµï¼ˆå…³é”®æºç é€»è¾‘ç®€åŒ–ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// net/http/server.go æ ¸å¿ƒæµç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span></span> Serve(l net.Listener) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        rw, err := l.Accept() <span class="comment">// 1. æ¥å—TCPè¿æ¥</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="keyword">break</span> &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            conn := newConn(rw, srv) </span><br><span class="line">            serverHandler&#123;srv&#125;.ServeHTTP(conn, conn.r) <span class="comment">// 2. äº¤ç”±å¤„ç†å™¨é“¾å¤„ç†</span></span><br><span class="line">        &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±åˆ†å‘æ ¸å¿ƒï¼ˆServeMuxï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mux *ServeMux)</span></span> ServeHTTP(w ResponseWriter, r *Request) &#123;</span><br><span class="line">    handler := mux.match(r.URL.Path) <span class="comment">// 3. è·¯å¾„åŒ¹é…</span></span><br><span class="line">    handler.ServeHTTP(w, r)          <span class="comment">// 4. è°ƒç”¨æ³¨å†Œçš„Handler</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®æœºåˆ¶</strong>ï¼š  </p><ul><li>æ¯è¿æ¥ç‹¬ç«‹goroutineï¼ˆé«˜å¹¶å‘åŸºçŸ³ï¼‰  </li><li>ä¸­é—´ä»¶é“¾å¼è°ƒç”¨é€šè¿‡<code>http.HandlerFunc</code>åŒ…è£…å®ç°  </li><li>é»˜è®¤ä½¿ç”¨<code>DefaultServeMux</code>ï¼Œæ”¯æŒè‡ªå®šä¹‰Muxé¿å…å…¨å±€æ±¡æŸ“</li></ul><h3 id="2-2-å®¢æˆ·ç«¯è¿æ¥æ± è®¾è®¡"><a href="#2-2-å®¢æˆ·ç«¯è¿æ¥æ± è®¾è®¡" class="headerlink" title="2.2 å®¢æˆ·ç«¯è¿æ¥æ± è®¾è®¡"></a>2.2 å®¢æˆ·ç«¯è¿æ¥æ± è®¾è®¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// net/http/transport.go</span></span><br><span class="line"><span class="keyword">type</span> Transport <span class="keyword">struct</span> &#123;</span><br><span class="line">    idleConnPool <span class="keyword">map</span>[<span class="type">string</span>][]*persistConn <span class="comment">// æŒ‰Hostå¤ç”¨è¿æ¥</span></span><br><span class="line">    MaxIdleConns <span class="type">int</span>                        <span class="comment">// å…¨å±€é™åˆ¶</span></span><br><span class="line">    MaxIdleConnsPerHost <span class="type">int</span>                <span class="comment">// å•Hosté™åˆ¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼š  </p><ul><li>è‡ªåŠ¨HTTP&#x2F;1.1 Keep-Aliveå¤ç”¨  </li><li>è¿æ¥å¥åº·æ£€æŸ¥ä¸è¶…æ—¶å›æ”¶  </li><li>é¿å…TIME_WAITå †ç§¯ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…å¤‡ï¼‰</li></ul><hr><h2 id="ä¸‰ã€é¿å‘æŒ‡å—ï¼š5å¤§é«˜é¢‘é™·é˜±"><a href="#ä¸‰ã€é¿å‘æŒ‡å—ï¼š5å¤§é«˜é¢‘é™·é˜±" class="headerlink" title="ä¸‰ã€é¿å‘æŒ‡å—ï¼š5å¤§é«˜é¢‘é™·é˜±"></a>ä¸‰ã€é¿å‘æŒ‡å—ï¼š5å¤§é«˜é¢‘é™·é˜±</h2><table><thead><tr><th>é™·é˜±</th><th>é”™è¯¯ç¤ºä¾‹</th><th>æ­£ç¡®æ–¹æ¡ˆ</th><th>ä¸¥é‡æ€§</th></tr></thead><tbody><tr><td><strong>é˜»å¡Handler</strong></td><td><code>time.Sleep(10*time.Second)</code></td><td>ç”¨goroutine+Contextæ§åˆ¶</td><td>âš ï¸ é«˜ï¼ˆæ‹–å®æœåŠ¡ï¼‰</td></tr><tr><td><strong>Bodyæœªå…³é—­</strong></td><td><code>resp, _ := http.Get(url)</code></td><td><code>defer resp.Body.Close()</code></td><td>âš ï¸ é«˜ï¼ˆè¿æ¥æ³„æ¼ï¼‰</td></tr><tr><td><strong>å…¨å±€Muxæ±¡æŸ“</strong></td><td><code>http.HandleFunc(&quot;/&quot;, ...)</code></td><td><code>mux := http.NewServeMux()</code></td><td>âš ï¸ ä¸­ï¼ˆæµ‹è¯•æ±¡æŸ“ï¼‰</td></tr><tr><td><strong>å¿½ç•¥Context</strong></td><td><code>client.Get(url)</code></td><td><code>ctx, cancel := context.WithTimeout(...)</code></td><td>âš ï¸ é«˜ï¼ˆè¶…æ—¶å¤±æ§ï¼‰</td></tr><tr><td><strong>Headerå¤§å°å†™</strong></td><td><code>r.Header[&quot;token&quot;]</code></td><td><code>r.Header.Get(&quot;Token&quot;)</code></td><td>âš ï¸ ä½ï¼ˆé€»è¾‘é”™è¯¯ï¼‰</td></tr></tbody></table><p><strong>é»„é‡‘æ³•åˆ™</strong>ï¼š  </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰€æœ‰Handlerå¿…é¡»å¤„ç†Contextå–æ¶ˆä¿¡å·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">safeHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-r.Context().Done():</span><br><span class="line">        http.Error(w, <span class="string">&quot;Request cancelled&quot;</span>, <span class="number">499</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="å››ã€å®æˆ˜ï¼šä»é›¶åˆ°ç”Ÿäº§çº§WebæœåŠ¡å™¨"><a href="#å››ã€å®æˆ˜ï¼šä»é›¶åˆ°ç”Ÿäº§çº§WebæœåŠ¡å™¨" class="headerlink" title="å››ã€å®æˆ˜ï¼šä»é›¶åˆ°ç”Ÿäº§çº§WebæœåŠ¡å™¨"></a>å››ã€å®æˆ˜ï¼šä»é›¶åˆ°ç”Ÿäº§çº§WebæœåŠ¡å™¨</h2><h3 id="4-1-æç®€ç‰ˆï¼ˆ30ç§’ä¸Šæ‰‹ï¼‰"><a href="#4-1-æç®€ç‰ˆï¼ˆ30ç§’ä¸Šæ‰‹ï¼‰" class="headerlink" title="4.1 æç®€ç‰ˆï¼ˆ30ç§’ä¸Šæ‰‹ï¼‰"></a>4.1 æç®€ç‰ˆï¼ˆ30ç§’ä¸Šæ‰‹ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/hello&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        fmt.Fprintln(w, <span class="string">&quot;Hello from Go! Time:&quot;</span>, time.Now().Format(<span class="string">&quot;15:04:05&quot;</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    log.Println(<span class="string">&quot;Server starting on :8080&quot;</span>)</span><br><span class="line">    log.Fatal(http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>)) <span class="comment">// nil = ä½¿ç”¨DefaultServeMux</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>âœ… <strong>éªŒè¯</strong>ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8080/hello</span><br><span class="line"><span class="comment"># Output: Hello from Go! Time: 14:30:22</span></span><br></pre></td></tr></table></figure><h3 id="4-2-ç”Ÿäº§å¢å¼ºç‰ˆï¼ˆå«ä¸­é—´ä»¶-x2F-ä¼˜é›…å…³åœï¼‰"><a href="#4-2-ç”Ÿäº§å¢å¼ºç‰ˆï¼ˆå«ä¸­é—´ä»¶-x2F-ä¼˜é›…å…³åœï¼‰" class="headerlink" title="4.2 ç”Ÿäº§å¢å¼ºç‰ˆï¼ˆå«ä¸­é—´ä»¶&#x2F;ä¼˜é›…å…³åœï¼‰"></a>4.2 ç”Ÿäº§å¢å¼ºç‰ˆï¼ˆå«ä¸­é—´ä»¶&#x2F;ä¼˜é›…å…³åœï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;os/signal&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. æ—¥å¿—ä¸­é—´ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loggingMiddleware</span><span class="params">(next http.Handler)</span></span> http.Handler &#123;</span><br><span class="line">    <span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        start := time.Now()</span><br><span class="line">        next.ServeHTTP(w, r)</span><br><span class="line">        log.Printf(<span class="string">&quot;[%s] %s %s %v&quot;</span>, </span><br><span class="line">            time.Now().Format(<span class="string">&quot;2006-01-02 15:04:05&quot;</span>),</span><br><span class="line">            r.Method, </span><br><span class="line">            r.URL.Path, </span><br><span class="line">            time.Since(start))</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. å¥åº·æ£€æŸ¥ç«¯ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">healthCheck</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">    w.Write([]<span class="type">byte</span>(<span class="string">`&#123;&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:&quot;`</span> + time.Now().UTC().Format(time.RFC3339) + <span class="string">`&quot;&#125;`</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºè‡ªå®šä¹‰Muxï¼ˆé¿å…å…¨å±€æ±¡æŸ“ï¼‰</span></span><br><span class="line">    mux := http.NewServeMux()</span><br><span class="line">    mux.HandleFunc(<span class="string">&quot;/health&quot;</span>, healthCheck)</span><br><span class="line">    mux.HandleFunc(<span class="string">&quot;/api/data&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">        w.Write([]<span class="type">byte</span>(<span class="string">`&#123;&quot;message&quot;:&quot;Secure API endpoint&quot;&#125;`</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åº”ç”¨ä¸­é—´ä»¶é“¾</span></span><br><span class="line">    handler := loggingMiddleware(mux)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºServerå®ä¾‹ï¼ˆæ”¯æŒä¼˜é›…å…³åœï¼‰</span></span><br><span class="line">    srv := &amp;http.Server&#123;</span><br><span class="line">        Addr:         <span class="string">&quot;:8080&quot;</span>,</span><br><span class="line">        Handler:      handler,</span><br><span class="line">        ReadTimeout:  <span class="number">5</span> * time.Second,</span><br><span class="line">        WriteTimeout: <span class="number">10</span> * time.Second,</span><br><span class="line">        IdleTimeout:  <span class="number">120</span> * time.Second,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯åŠ¨æœåŠ¡ï¼ˆgoroutineé¿å…é˜»å¡ä¿¡å·ç›‘å¬ï¼‰</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        log.Println(<span class="string">&quot;ğŸš€ Production server starting on :8080&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> err := srv.ListenAndServe(); err != <span class="literal">nil</span> &amp;&amp; err != http.ErrServerClosed &#123;</span><br><span class="line">            log.Fatalf(<span class="string">&quot;Server failed: %v&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¼˜é›…å…³åœï¼šç›‘å¬OSä¿¡å·</span></span><br><span class="line">    quit := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">    &lt;-quit</span><br><span class="line">    log.Println(<span class="string">&quot;âš ï¸  Shutdown signal received, initiating graceful shutdown...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> err := srv.Shutdown(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;Server forced shutdown: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    log.Println(<span class="string">&quot;âœ… Server exited cleanly&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç”Ÿäº§ç‰¹æ€§</strong>ï¼š  </p><ul><li>âœ… è‡ªå®šä¹‰ServeMuxï¼ˆéš”ç¦»è·¯ç”±ï¼‰  </li><li>âœ… ä¸­é—´ä»¶é“¾ï¼ˆæ—¥å¿—&#x2F;è®¤è¯&#x2F;é™æµæ‰©å±•ç‚¹ï¼‰  </li><li>âœ… è¶…æ—¶æ§åˆ¶ï¼ˆé˜²æ…¢è¯·æ±‚æ”»å‡»ï¼‰  </li><li>âœ… ä¼˜é›…å…³åœï¼ˆK8så‹å¥½ï¼‰  </li><li>âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼ˆè¿ç»´å¿…å¤‡ï¼‰  </li><li>âœ… Contextè¶…æ—¶ä¼ æ’­ï¼ˆå…¨é“¾è·¯å¯æ§ï¼‰</li></ul><hr><h2 id="äº”ã€è¿›é˜¶æŠ€å·§é”¦å›Š"><a href="#äº”ã€è¿›é˜¶æŠ€å·§é”¦å›Š" class="headerlink" title="äº”ã€è¿›é˜¶æŠ€å·§é”¦å›Š"></a>äº”ã€è¿›é˜¶æŠ€å·§é”¦å›Š</h2><h3 id="5-1-å®‰å…¨åŠ å›ºï¼ˆHTTPS-HSTSï¼‰"><a href="#5-1-å®‰å…¨åŠ å›ºï¼ˆHTTPS-HSTSï¼‰" class="headerlink" title="5.1 å®‰å…¨åŠ å›ºï¼ˆHTTPS+HSTSï¼‰"></a>5.1 å®‰å…¨åŠ å›ºï¼ˆHTTPS+HSTSï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯åŠ¨HTTPSï¼ˆè‡ªåŠ¨é‡å®šå‘HTTPï¼‰</span></span><br><span class="line"><span class="keyword">go</span> http.ListenAndServe(<span class="string">&quot;:80&quot;</span>, http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    http.Redirect(w, r, <span class="string">&quot;https://&quot;</span>+r.Host+r.URL.String(), http.StatusMovedPermanently)</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">log.Fatal(http.ListenAndServeTLS(<span class="string">&quot;:443&quot;</span>, <span class="string">&quot;cert.pem&quot;</span>, <span class="string">&quot;key.pem&quot;</span>, mux))</span><br></pre></td></tr></table></figure><h3 id="5-2-æ–‡ä»¶ä¸Šä¼ é™æµï¼ˆé˜²DoSï¼‰"><a href="#5-2-æ–‡ä»¶ä¸Šä¼ é™æµï¼ˆé˜²DoSï¼‰" class="headerlink" title="5.2 æ–‡ä»¶ä¸Šä¼ é™æµï¼ˆé˜²DoSï¼‰"></a>5.2 æ–‡ä»¶ä¸Šä¼ é™æµï¼ˆé˜²DoSï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http.MaxBytesReader(w, r.Body, <span class="number">10</span>&lt;&lt;<span class="number">20</span>) <span class="comment">// é™åˆ¶10MB</span></span><br><span class="line"><span class="keyword">if</span> err := r.ParseMultipartForm(<span class="number">10</span> &lt;&lt; <span class="number">20</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    http.Error(w, <span class="string">&quot;File too large&quot;</span>, http.StatusBadRequest)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-å®¢æˆ·ç«¯æœ€ä½³å®è·µ"><a href="#5-3-å®¢æˆ·ç«¯æœ€ä½³å®è·µ" class="headerlink" title="5.3 å®¢æˆ·ç«¯æœ€ä½³å®è·µ"></a>5.3 å®¢æˆ·ç«¯æœ€ä½³å®è·µ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤ç”¨Clientï¼ˆå…¨å±€å•ä¾‹ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> httpClient = &amp;http.Client&#123;</span><br><span class="line">    Timeout: <span class="number">10</span> * time.Second,</span><br><span class="line">    Transport: &amp;http.Transport&#123;</span><br><span class="line">        MaxIdleConns:        <span class="number">100</span>,</span><br><span class="line">        MaxIdleConnsPerHost: <span class="number">10</span>,</span><br><span class="line">        IdleConnTimeout:     <span class="number">90</span> * time.Second,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¸¦Contextçš„è¯·æ±‚</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line">req, _ := http.NewRequestWithContext(ctx, <span class="string">&quot;GET&quot;</span>, <span class="string">&quot;https://api.example.com&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">resp, err := httpClient.Do(req)</span><br></pre></td></tr></table></figure><hr><h2 id="å…­ã€æ€»ç»“ä¸å­¦ä¹ è·¯å¾„"><a href="#å…­ã€æ€»ç»“ä¸å­¦ä¹ è·¯å¾„" class="headerlink" title="å…­ã€æ€»ç»“ä¸å­¦ä¹ è·¯å¾„"></a>å…­ã€æ€»ç»“ä¸å­¦ä¹ è·¯å¾„</h2><table><thead><tr><th>é˜¶æ®µ</th><th>æŒæ¡è¦ç‚¹</th><th>æ¨èå®è·µ</th></tr></thead><tbody><tr><td><strong>å…¥é—¨</strong></td><td>HandleFunc, ListenAndServe</td><td>å®ç°RESTful API</td></tr><tr><td><strong>è¿›é˜¶</strong></td><td>è‡ªå®šä¹‰ServeMux, ä¸­é—´ä»¶é“¾</td><td>æ·»åŠ è®¤è¯&#x2F;æ—¥å¿—ä¸­é—´ä»¶</td></tr><tr><td><strong>ç”Ÿäº§</strong></td><td>ä¼˜é›…å…³åœ, è¶…æ—¶æ§åˆ¶, è¿æ¥æ± </td><td>éƒ¨ç½²åˆ°Docker&#x2F;K8s</td></tr><tr><td><strong>ä¸“å®¶</strong></td><td>è‡ªå®šä¹‰Transport, HTTP&#x2F;2</td><td>æ€§èƒ½å‹æµ‹ä¸è°ƒä¼˜</td></tr></tbody></table><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š<br>â€œnet&#x2F;httpçš„è®¾è®¡å“²å­¦ï¼š<strong>ç»„åˆä¼˜äºç»§æ‰¿ï¼Œæ¥å£é©±åŠ¨æ‰©å±•</strong>ã€‚<br>é€šè¿‡<code>Handler</code>æ¥å£ä¸²è”ä¸­é—´ä»¶ï¼Œé€šè¿‡<code>Transport</code>å®šåˆ¶ç½‘ç»œå±‚ï¼Œ<br>ç”¨æœ€å°æŠ½è±¡å®ç°æœ€å¤§çµæ´»æ€§ã€‚â€</p><p><strong>å»¶ä¼¸å­¦ä¹ </strong>ï¼š  </p><ul><li>æºç ç²¾è¯»ï¼š<code>server.go</code>ï¼ˆæœåŠ¡æµç¨‹ï¼‰ã€<code>transport.go</code>ï¼ˆå®¢æˆ·ç«¯ï¼‰  </li><li>ç”Ÿæ€å·¥å…·ï¼š<code>gorilla/mux</code>ï¼ˆé«˜çº§è·¯ç”±ï¼‰ã€<code>chi</code>ï¼ˆè½»é‡ä¸­é—´ä»¶ï¼‰  </li><li>å®‰å…¨è§„èŒƒï¼šOWASP Goå®‰å…¨æŒ‡å—ã€CSPå¤´è®¾ç½®</li></ul><hr><p><strong>ç«‹å³è¡ŒåŠ¨</strong>ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤åˆ¶ç”Ÿäº§ç‰ˆä»£ç  â†’ ä¿å­˜ä¸ºmain.go â†’ è¿è¡Œ</span></span><br><span class="line">go run main.go</span><br><span class="line"><span class="comment"># è®¿é—® http://localhost:8080/health éªŒè¯æœåŠ¡</span></span><br></pre></td></tr></table></figure><p>æŒæ¡net&#x2F;httpï¼Œè¿™æ˜¯Goè¯­è¨€ç”Ÿæ€çš„å…³é”®ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Goè¯­è¨€net-x2F-httpæ ‡å‡†åº“æ·±åº¦è§£æï¼šä»åŸç†åˆ°å®æˆ˜&quot;&gt;&lt;a href=&quot;#Goè¯­è¨€net-x2F-httpæ ‡å‡†åº“æ·±åº¦è§£æï¼šä»åŸç†åˆ°å®æˆ˜&quot; class=&quot;headerlink&quot; title=&quot;Goè¯­è¨€net&amp;#x2F;httpæ ‡å‡†åº“æ·±åº¦è§£æï¼šä»åŸç†åˆ°å®æˆ˜&quot;&gt;&lt;/a&gt;Goè¯­è¨€net&amp;#x2F;httpæ ‡å‡†åº“æ·±åº¦è§£æï¼šä»åŸç†åˆ°å®æˆ˜&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒç›®æ ‡&lt;/strong&gt;ï¼šé›¶åŸºç¡€æŒæ¡net&amp;#x2F;httpæ ¸å¿ƒæœºåˆ¶ï¼Œ5åˆ†é’Ÿæ­å»ºç”Ÿäº§çº§WebæœåŠ¡&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-net-http" scheme="https://www.wdft.com/tags/Go-net-http/"/>
    
  </entry>
  
  <entry>
    <title>ã€pathã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“Goæ ‡å‡†åº“pathåŒ…URLè·¯å¾„å¤„ç†çš„ä¼˜é›…ä¹‹é“ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/898b213a.html"/>
    <id>https://www.wdft.com/898b213a.html</id>
    <published>2026-01-24T17:19:09.000Z</published>
    <updated>2026-01-30T09:57:17.550Z</updated>
    
    <content type="html"><![CDATA[<p><strong>å¸¸ç”¨æ³•åˆ™</strong>ï¼šå½“è·¯å¾„<strong>ä»…åŒ…å«<code>/</code>ä¸”ä¸æ¶‰åŠæ–‡ä»¶ç³»ç»Ÿ I&#x2F;O</strong>æ—¶ï¼Œé€‰æ‹©<code>path</code>ï¼›å¦åˆ™æ— æ¡ä»¶ä½¿ç”¨<code>path/filepath</code>ã€‚<br>ç‰¢è®°è¿™ä¸€åŸåˆ™ï¼Œå¯é¿å…99%çš„è·¯å¾„å¤„ç†é”™è¯¯ï¼Œè¿™ä¹Ÿæ˜¯éµå¾ªæœ€å°æƒé™åŸåˆ™å’Œåº”ç”¨å±‚å¼€å‘çš„å®è·µç»éªŒä¹‹ä¸€ã€‚<br><strong>æ ¸å¿ƒæç¤º</strong>ï¼š<code>path</code>åŒ…ä¸“ä¸º<strong>æ­£æ–œæ (&#x2F;)åˆ†éš”çš„è·¯å¾„</strong>è®¾è®¡ï¼ˆå¦‚URLè·¯å¾„ï¼‰ï¼Œ<strong>ä¸é€‚ç”¨äºæ“ä½œç³»ç»Ÿæ–‡ä»¶è·¯å¾„</strong>ï¼ˆåè€…åº”ä½¿ç”¨<code>path/filepath</code>ï¼‰ã€‚   </p><span id="more"></span><hr><h3 id="ä¸€ã€pathåŒ…å…¨æ™¯å›¾è°±"><a href="#ä¸€ã€pathåŒ…å…¨æ™¯å›¾è°±" class="headerlink" title="ä¸€ã€pathåŒ…å…¨æ™¯å›¾è°±"></a>ä¸€ã€<code>path</code>åŒ…å…¨æ™¯å›¾è°±</h3><p><code>path</code>åŒ…å…±æä¾›<strong>8ä¸ªæ ¸å¿ƒå‡½æ•°</strong>ï¼Œå…¨éƒ¨åŸºäºçº¯è¯æ³•å¤„ç†ï¼ˆlexical processingï¼‰ï¼Œä¸æ¶‰åŠæ–‡ä»¶ç³»ç»ŸI&#x2F;Oã€‚ä¸‹å›¾å±•ç¤ºå‡½æ•°å…³ç³»ä¸ä¸­æ–‡åŠŸèƒ½è¯´æ˜ï¼š</p><pre class="mermaid">graph LR    A[pathåŒ…] --> B[Clean è·¯å¾„å‡€åŒ–]    A --> C[Split ç›®å½•æ–‡ä»¶åˆ†å‰²]    A --> D[Join è·¯å¾„æ‹¼æ¥]    A --> E[Base æœ«çº§å…ƒç´ ]    A --> F[Dir ç›®å½•éƒ¨åˆ†]    A --> G[Ext æ‰©å±•å]    A --> H[IsAbs ç»å¯¹è·¯å¾„]    A --> I[Match æ¨¡å¼åŒ¹é…]        C --> J[åŸç† diråŠ file]    D --> K[ç‰¹æ€§ å¿½ç•¥ç©ºå…ƒç´ ]    E --> L[è§„åˆ™ å»å°¾éƒ¨æ–œæ ]    F --> M[å®ç° SplitåŠ Clean]    B --> N[å››æ­¥æ³•åˆ™<br/>1.å¤šæ–œæ å˜å•æ–œæ <br/>2.æ¶ˆé™¤ç‚¹å·<br/>3.æ¶ˆé™¤åŒç‚¹åŠå‰é©±<br/>4.æ ¹è·¯å¾„åŒç‚¹å˜æ–œæ ]    I --> O[è¯­æ³• æ˜Ÿå· é—®å· æ–¹æ‹¬å· åæ–œæ ]</pre><hr><h3 id="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"><a href="#äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ" class="headerlink" title="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ"></a>äºŒã€æŠ€æœ¯åŸç†æ·±åº¦å‰–æ</h3><h4 id="2-1-æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼šçº¯è¯æ³•å¤„ç†ï¼ˆLexical-Processingï¼‰"><a href="#2-1-æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼šçº¯è¯æ³•å¤„ç†ï¼ˆLexical-Processingï¼‰" class="headerlink" title="2.1 æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼šçº¯è¯æ³•å¤„ç†ï¼ˆLexical Processingï¼‰"></a>2.1 æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼šçº¯è¯æ³•å¤„ç†ï¼ˆLexical Processingï¼‰</h4><p><code>path</code>åŒ…çš„æ‰€æœ‰æ“ä½œ<strong>ä¸è®¿é—®æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œä»…é€šè¿‡å­—ç¬¦ä¸²åˆ†æå®Œæˆè·¯å¾„å¤„ç†ã€‚è¿™ä¸<code>path/filepath</code>å½¢æˆé²œæ˜å¯¹æ¯”ï¼š</p><table><thead><tr><th>ç‰¹æ€§</th><th><code>path</code>åŒ…</th><th><code>path/filepath</code>åŒ…</th></tr></thead><tbody><tr><td>åˆ†éš”ç¬¦</td><td>å›ºå®šä½¿ç”¨<code>/</code></td><td>æ ¹æ®OSè‡ªåŠ¨é€‰æ‹©ï¼ˆ<code>/</code>æˆ–<code>\</code>ï¼‰</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>URLè·¯å¾„ã€Unixé£æ ¼è·¯å¾„</td><td>æ“ä½œç³»ç»Ÿæ–‡ä»¶è·¯å¾„</td></tr><tr><td>è·¨å¹³å°æ€§</td><td>å®Œå…¨ä¸€è‡´</td><td>é€‚é…ä¸åŒOS</td></tr><tr><td>æ˜¯å¦I&#x2F;O</td><td>âŒ çº¯è¯æ³•</td><td>âŒ çº¯è¯æ³•ï¼ˆä½†è®¾è®¡ç”¨äºæ–‡ä»¶ç³»ç»Ÿï¼‰</td></tr><tr><td>Windowsæ”¯æŒ</td><td>ä»…å¤„ç†<code>/</code>è·¯å¾„</td><td>æ”¯æŒ<code>C:\</code>ç­‰é©±åŠ¨å™¨è·¯å¾„</td></tr></tbody></table><p><strong>å…³é”®çº¦æŸ</strong>ï¼šå®˜æ–¹æ–‡æ¡£æ˜ç¡®æŒ‡å‡º <em>â€œThe path package should only be used for paths separated by forward slashes, such as the paths in URLsâ€</em> </p><h4 id="2-2-Cleanå‡½æ•°ï¼šè·¯å¾„å‡€åŒ–çš„å››æ­¥æ³•åˆ™"><a href="#2-2-Cleanå‡½æ•°ï¼šè·¯å¾„å‡€åŒ–çš„å››æ­¥æ³•åˆ™" class="headerlink" title="2.2 Cleanå‡½æ•°ï¼šè·¯å¾„å‡€åŒ–çš„å››æ­¥æ³•åˆ™"></a>2.2 <code>Clean</code>å‡½æ•°ï¼šè·¯å¾„å‡€åŒ–çš„å››æ­¥æ³•åˆ™</h4><h6 id="å¤‡æ³¨ä»¥ä¸‹åŸºäºGo-1-22-ç‰ˆæœ¬"><a href="#å¤‡æ³¨ä»¥ä¸‹åŸºäºGo-1-22-ç‰ˆæœ¬" class="headerlink" title="å¤‡æ³¨ä»¥ä¸‹åŸºäºGo 1.22+ç‰ˆæœ¬"></a>å¤‡æ³¨ä»¥ä¸‹åŸºäºGo 1.22+ç‰ˆæœ¬</h6><p><code>Clean</code>æ˜¯<code>path</code>åŒ…çš„<strong>æ ¸å¿ƒç®—æ³•</strong>ï¼Œå…¶å®ç°åŸºäºRob Pikeåœ¨Plan 9ç³»ç»Ÿä¸­çš„ç»å…¸è®ºæ–‡ã€ŠLexical File Names in Plan 9 or Getting Dot-Dot Rightã€‹ã€‚å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç å±•ç¤ºCleançš„è¿­ä»£å¤„ç†é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Clean</span><span class="params">(path <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// Step 1: å¤šæ–œæ å‹ç¼© â†’ å•æ–œæ </span></span><br><span class="line">    <span class="comment">// &quot;/home//user/&quot; â†’ &quot;/home/user/&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 2: æ¶ˆé™¤å½“å‰ç›®å½•æ ‡è®° &quot;.&quot;</span></span><br><span class="line">    <span class="comment">// &quot;/home/./user&quot; â†’ &quot;/home/user&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 3: æ¶ˆé™¤çˆ¶ç›®å½•æ ‡è®° &quot;..&quot; åŠå…¶å‰é©±</span></span><br><span class="line">    <span class="comment">// &quot;/home/user/../doc&quot; â†’ &quot;/home/doc&quot;</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šä»…æ¶ˆé™¤&quot;å†…å±‚&quot;çš„..ï¼Œå¦‚éæ ¹è·¯å¾„å¼€å¤´çš„..</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 4: æ ¹è·¯å¾„å¼€å¤´çš„&quot;..&quot;å½’çº¦ä¸º&quot;/&quot;</span></span><br><span class="line">    <span class="comment">// &quot;/../home&quot; â†’ &quot;/home&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç‰¹æ®Šè§„åˆ™ï¼š</span></span><br><span class="line">    <span class="comment">// - ç»“æœä»…åœ¨æ ¹è·¯å¾„&quot;/&quot;æ—¶ä¿ç•™å°¾éƒ¨æ–œæ </span></span><br><span class="line">    <span class="comment">// - ç©ºç»“æœè¿”å›&quot;.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æŠ€æœ¯äº®ç‚¹</strong>ï¼š</p><ul><li>ä½¿ç”¨<code>lazybuf</code>ç»“æ„é¿å…é¢‘ç¹å­—ç¬¦ä¸²æ‹·è´ï¼ˆæºç <code>path.go</code>ä¸­å®ç°ï¼‰</li><li>é€šè¿‡å•æ¬¡éå†å®Œæˆæ‰€æœ‰è§„åˆ™åº”ç”¨ï¼Œæ—¶é—´å¤æ‚åº¦O(n)</li><li>ä¸¥æ ¼éµå¾ªâ€æœ€çŸ­ç­‰æ•ˆè·¯å¾„â€åŸåˆ™ï¼Œæ¶ˆé™¤å†—ä½™è¡¨ç¤º</li></ul><h4 id="2-3-Splitä¸Dir-x2F-Baseçš„å…±ç”Ÿå…³ç³»"><a href="#2-3-Splitä¸Dir-x2F-Baseçš„å…±ç”Ÿå…³ç³»" class="headerlink" title="2.3 Splitä¸Dir&#x2F;Baseçš„å…±ç”Ÿå…³ç³»"></a>2.3 <code>Split</code>ä¸<code>Dir</code>&#x2F;<code>Base</code>çš„å…±ç”Ÿå…³ç³»</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Splitæ˜¯Dirå’ŒBaseçš„åº•å±‚å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Split</span><span class="params">(path <span class="type">string</span>)</span></span> (dir, file <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="comment">// ä»å³å‘å·¦æŸ¥æ‰¾æœ€åä¸€ä¸ª&#x27;/&#x27;</span></span><br><span class="line">    <span class="comment">// &quot;a/b/c&quot; â†’ dir=&quot;a/b/&quot;, file=&quot;c&quot;</span></span><br><span class="line">    <span class="comment">// &quot;a/b/&quot;  â†’ dir=&quot;a/b/&quot;, file=&quot;&quot;</span></span><br><span class="line">    <span class="comment">// &quot;a&quot;     â†’ dir=&quot;&quot;, file=&quot;a&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dir = Clean(Splitç»“æœçš„ç¬¬ä¸€éƒ¨åˆ†)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Dir</span><span class="params">(path <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    dir, _ := Split(path)</span><br><span class="line">    <span class="keyword">return</span> Clean(dir) <span class="comment">// æ³¨æ„ï¼šCleanåä¼šç§»é™¤å°¾éƒ¨æ–œæ ï¼ˆé™¤æ ¹è·¯å¾„å¤–ï¼‰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Base = Splitç»“æœçš„ç¬¬äºŒéƒ¨åˆ†ï¼ˆå…ˆç§»é™¤å°¾éƒ¨æ–œæ ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Base</span><span class="params">(path <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// å…ˆå¤„ç†å°¾éƒ¨æ–œæ ï¼š&quot;a/b/&quot; â†’ &quot;a/b&quot;</span></span><br><span class="line">    <span class="comment">// å†Splitå–fileéƒ¨åˆ†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>âš ï¸ <strong>æ˜“é”™ç‚¹</strong>ï¼š<code>Dir(&quot;a/&quot;)</code> è¿”å› <code>&quot;.&quot;</code> è€Œé <code>&quot;a&quot;</code>ï¼Œå› ä¸º<code>Split(&quot;a/&quot;)</code>å¾—åˆ°<code>(&quot;a/&quot;, &quot;&quot;)</code>ï¼Œ<code>Clean(&quot;a/&quot;)</code> â†’ <code>&quot;a&quot;</code>ï¼Œä½†<code>Base(&quot;a/&quot;)</code>ä¸º<code>&quot;&quot;</code>å¯¼è‡´<code>Dir</code>é€»è¾‘ç‰¹æ®Šå¤„ç†ã€‚</p><h4 id="2-4-Matchå‡½æ•°ï¼šShellæ¨¡å¼åŒ¹é…å¼•æ“"><a href="#2-4-Matchå‡½æ•°ï¼šShellæ¨¡å¼åŒ¹é…å¼•æ“" class="headerlink" title="2.4 Matchå‡½æ•°ï¼šShellæ¨¡å¼åŒ¹é…å¼•æ“"></a>2.4 <code>Match</code>å‡½æ•°ï¼šShellæ¨¡å¼åŒ¹é…å¼•æ“</h4><p><code>Match</code>å®ç°ç²¾ç®€ç‰ˆglobåŒ¹é…ï¼Œ<strong>ä»…æ”¯æŒå•å±‚è·¯å¾„åŒ¹é…</strong>ï¼ˆä¸è·¨<code>/</code>ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¨¡å¼è¯­æ³•</span></span><br><span class="line"><span class="string">&#x27;*&#x27;</span>    <span class="comment">// åŒ¹é…ä»»æ„é/å­—ç¬¦åºåˆ—</span></span><br><span class="line"><span class="string">&#x27;?&#x27;</span>    <span class="comment">// åŒ¹é…å•ä¸ªé/å­—ç¬¦</span></span><br><span class="line"><span class="string">&#x27;[&#x27;</span>    <span class="comment">// å­—ç¬¦ç±»ï¼š[a-z]ã€[^0-9]ç­‰</span></span><br><span class="line"><span class="string">&#x27;\\&#x27;</span>   <span class="comment">// è½¬ä¹‰å­—ç¬¦ï¼š\\* åŒ¹é…å­—é¢é‡*</span></span><br></pre></td></tr></table></figure><p><strong>å…³é”®é™åˆ¶</strong>ï¼š</p><ul><li><code>*</code> <strong>ä¸åŒ¹é…æ–œæ </strong>ï¼š<code>Match(&quot;a*b&quot;, &quot;a/x/b&quot;)</code> â†’ false</li><li>å¿…é¡»<strong>å…¨å­—ç¬¦ä¸²åŒ¹é…</strong>ï¼š<code>Match(&quot;go&quot;, &quot;gopher&quot;)</code> â†’ false</li><li>æ— é€’å½’åŒ¹é…ï¼šä¸æ”¯æŒ<code>**</code>è¯­æ³•ï¼ˆéœ€ç”¨<code>filepath.Glob</code>ï¼‰</li></ul><hr><h3 id="ä¸‰ã€å®æˆ˜æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰"><a href="#ä¸‰ã€å®æˆ˜æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰" class="headerlink" title="ä¸‰ã€å®æˆ˜æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰"></a>ä¸‰ã€å®æˆ˜æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰</h3><h4 id="âŒ-å¸¸è§è¯¯ç”¨åœºæ™¯"><a href="#âŒ-å¸¸è§è¯¯ç”¨åœºæ™¯" class="headerlink" title="âŒ å¸¸è§è¯¯ç”¨åœºæ™¯"></a>âŒ å¸¸è§è¯¯ç”¨åœºæ™¯</h4><table><thead><tr><th>é”™è¯¯ç”¨æ³•</th><th>æ­£ç¡®æ–¹æ¡ˆ</th><th>åŸå› </th></tr></thead><tbody><tr><td><code>path.Join(&quot;C:&quot;, &quot;Users&quot;)</code></td><td><code>filepath.Join(&quot;C:&quot;, &quot;Users&quot;)</code></td><td>Windowsé©±åŠ¨å™¨è·¯å¾„éœ€ç”¨<code>filepath</code></td></tr><tr><td><code>path.Clean(&quot;a\\b\\c&quot;)</code></td><td><code>filepath.Clean(&quot;a\\b\\c&quot;)</code></td><td>åæ–œæ ä¸è¢«<code>path</code>è¯†åˆ«ä¸ºåˆ†éš”ç¬¦</td></tr><tr><td><code>path.Match(&quot;*.go&quot;, &quot;src/main.go&quot;)</code></td><td><code>filepath.Match(&quot;*.go&quot;, &quot;main.go&quot;)</code></td><td><code>*</code>ä¸è·¨<code>/</code>ï¼Œåº”å…ˆæå–æ–‡ä»¶å</td></tr></tbody></table><h4 id="âœ…-æœ€ä½³å®è·µ"><a href="#âœ…-æœ€ä½³å®è·µ" class="headerlink" title="âœ… æœ€ä½³å®è·µ"></a>âœ… æœ€ä½³å®è·µ</h4><ol><li><p><strong>URLè·¯å¾„å¤„ç†</strong>ï¼ˆ<code>path</code>çš„ä¸»æˆ˜åœºï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">urlPath := <span class="string">&quot;/api/v1//users/./123/../456&quot;</span></span><br><span class="line">cleanPath := path.Clean(urlPath) <span class="comment">// â†’ &quot;/api/v1/users/456&quot;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å®‰å…¨è·¯å¾„æ‹¼æ¥</strong>ï¼ˆé˜²è·¯å¾„ç©¿è¶Šï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å±é™©ï¼šç”¨æˆ·è¾“å…¥å¯èƒ½åŒ…å«&quot;../&quot;</span></span><br><span class="line">unsafe := path.Join(<span class="string">&quot;/var/www&quot;</span>, userInput) </span><br><span class="line"></span><br><span class="line"><span class="comment">// å®‰å…¨ï¼šCleanåéªŒè¯æ˜¯å¦åœ¨åŸºç›®å½•å†…</span></span><br><span class="line">cleaned := path.Clean(unsafe)</span><br><span class="line"><span class="keyword">if</span> !strings.HasPrefix(cleaned, <span class="string">&quot;/var/www/&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">&quot;è·¯å¾„è¶Šæƒ&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>æ‰©å±•åå¤„ç†é™·é˜±</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">path.Ext(<span class="string">&quot;/path/.gitignore&quot;</span>) <span class="comment">// â†’ &quot;.gitignore&quot;ï¼ˆæ­£ç¡®ï¼‰</span></span><br><span class="line">path.Ext(<span class="string">&quot;/path/.hidden&quot;</span>)    <span class="comment">// â†’ &quot;.hidden&quot;ï¼ˆç‚¹æ–‡ä»¶è§†ä¸ºæ‰©å±•åï¼‰</span></span><br><span class="line"><span class="comment">// å¦‚éœ€åŒºåˆ†ï¼šå…ˆåˆ¤æ–­Baseæ˜¯å¦ä»¥&quot;.&quot;å¼€å¤´</span></span><br></pre></td></tr></table></figure></li></ol><hr><h3 id="å››ã€å…¸å‹å®ä¾‹Demo"><a href="#å››ã€å…¸å‹å®ä¾‹Demo" class="headerlink" title="å››ã€å…¸å‹å®ä¾‹Demo"></a>å››ã€å…¸å‹å®ä¾‹Demo</h3><h4 id="Demo-1ï¼šRESTful-APIè·¯ç”±è§„èŒƒåŒ–"><a href="#Demo-1ï¼šRESTful-APIè·¯ç”±è§„èŒƒåŒ–" class="headerlink" title="Demo 1ï¼šRESTful APIè·¯ç”±è§„èŒƒåŒ–"></a>Demo 1ï¼šRESTful APIè·¯ç”±è§„èŒƒåŒ–</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;path&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåŒ–APIè·¯ç”±ï¼Œæ¶ˆé™¤å†—ä½™è¡¨ç¤º</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">normalizeAPIRoute</span><span class="params">(route <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ç§»é™¤æŸ¥è¯¢å‚æ•°å’Œç‰‡æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> idx := strings.Index(route, <span class="string">&quot;?&quot;</span>); idx != <span class="number">-1</span> &#123;</span><br><span class="line">        route = route[:idx]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> idx := strings.Index(route, <span class="string">&quot;#&quot;</span>); idx != <span class="number">-1</span> &#123;</span><br><span class="line">        route = route[:idx]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. Cleanå¤„ç†</span></span><br><span class="line">    <span class="keyword">return</span> path.Clean(route)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    routes := []<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;/api/v1//users/./123&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/api/v1/users/../admins&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/api/v1/../../secret&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/api/v1/users/123/&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, r := <span class="keyword">range</span> routes &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;åŸå§‹: %-30s â†’ è§„èŒƒåŒ–: %s\n&quot;</span>, r, normalizeAPIRoute(r))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¾“å‡º:</span></span><br><span class="line">    <span class="comment">// åŸå§‹: /api/v1//users/./123        â†’ è§„èŒƒåŒ–: /api/v1/users/123</span></span><br><span class="line">    <span class="comment">// åŸå§‹: /api/v1/users/../admins     â†’ è§„èŒƒåŒ–: /api/v1/admins</span></span><br><span class="line">    <span class="comment">// åŸå§‹: /api/v1/../../secret        â†’ è§„èŒƒåŒ–: /secret</span></span><br><span class="line">    <span class="comment">// åŸå§‹: /api/v1/users/123/          â†’ è§„èŒƒåŒ–: /api/v1/users/123</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Demo-2ï¼šå®‰å…¨æ–‡ä»¶ä¸‹è½½è·¯å¾„æ ¡éªŒ"><a href="#Demo-2ï¼šå®‰å…¨æ–‡ä»¶ä¸‹è½½è·¯å¾„æ ¡éªŒ" class="headerlink" title="Demo 2ï¼šå®‰å…¨æ–‡ä»¶ä¸‹è½½è·¯å¾„æ ¡éªŒ"></a>Demo 2ï¼šå®‰å…¨æ–‡ä»¶ä¸‹è½½è·¯å¾„æ ¡éªŒ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;path&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> baseDir = <span class="string">&quot;/var/www/files&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯ç”¨æˆ·è¯·æ±‚çš„è·¯å¾„æ˜¯å¦åœ¨å®‰å…¨ç›®å½•å†…</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isSafePath</span><span class="params">(userPath <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. æ‹¼æ¥å¹¶Clean</span></span><br><span class="line">    fullPath := path.Join(baseDir, userPath)</span><br><span class="line">    cleaned := path.Clean(fullPath)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. å…³é”®ï¼šéªŒè¯Cleanedè·¯å¾„æ˜¯å¦ä»¥baseDirå¼€å¤´</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šå¿…é¡»æ·»åŠ å°¾éƒ¨æ–œæ é˜²æ­¢è·¯å¾„ç©¿è¶Šï¼ˆå¦‚baseDir=&quot;/safe&quot; vs &quot;/safedata&quot;ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> !strings.HasPrefix(cleaned, baseDir+<span class="string">&quot;/&quot;</span>) &amp;&amp; cleaned != baseDir &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;éæ³•è·¯å¾„: %s&quot;</span>, userPath)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cleaned, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    testCases := []<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;docs/report.pdf&quot;</span>,      <span class="comment">// âœ“ å®‰å…¨</span></span><br><span class="line">        <span class="string">&quot;../etc/passwd&quot;</span>,        <span class="comment">// âœ— è·¯å¾„ç©¿è¶Š</span></span><br><span class="line">        <span class="string">&quot;images/../../secret&quot;</span>,  <span class="comment">// âœ— Cleanåä»è¶Šæƒ</span></span><br><span class="line">        <span class="string">&quot;.&quot;</span>,</span><br><span class="line">        <span class="string">&quot;..&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, tc := <span class="keyword">range</span> testCases &#123;</span><br><span class="line">        safePath, err := isSafePath(tc)</span><br><span class="line">        status := <span class="string">&quot;âœ“&quot;</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            status = <span class="string">&quot;âœ—&quot;</span></span><br><span class="line">            safePath = err.Error()</span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;[%s] è¾“å…¥: %-20s â†’ %s\n&quot;</span>, status, tc, safePath)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Demo-3ï¼šURLè·¯ç”±å‚æ•°æå–"><a href="#Demo-3ï¼šURLè·¯ç”±å‚æ•°æå–" class="headerlink" title="Demo 3ï¼šURLè·¯ç”±å‚æ•°æå–"></a>Demo 3ï¼šURLè·¯ç”±å‚æ•°æå–</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;path&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»URLè·¯å¾„æå–èµ„æºç±»å‹å’ŒID</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚: /users/123/profile â†’ &#123;type: &quot;users&quot;, id: &quot;123&quot;, action: &quot;profile&quot;&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseResourcePath</span><span class="params">(p <span class="type">string</span>)</span></span> (resType, id, action <span class="type">string</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. Cleanè·¯å¾„</span></span><br><span class="line">    p = path.Clean(p)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. åˆ†å‰²è·¯å¾„å…ƒç´ </span></span><br><span class="line">    parts := strings.Split(strings.Trim(p, <span class="string">&quot;/&quot;</span>), <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. æŒ‰ä½ç½®æå–</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt;= <span class="number">1</span> &#123;</span><br><span class="line">        resType = parts[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt;= <span class="number">2</span> &#123;</span><br><span class="line">        id = parts[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt;= <span class="number">3</span> &#123;</span><br><span class="line">        action = parts[<span class="number">2</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    paths := []<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;/users/123/profile&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/posts/456//comments/./789&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/api/v1//users/123/../456&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, p := <span class="keyword">range</span> paths &#123;</span><br><span class="line">        rt, id, act := parseResourcePath(p)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;è·¯å¾„: %-35s â†’ ç±»å‹:%-6s ID:%-4s åŠ¨ä½œ:%s\n&quot;</span>, </span><br><span class="line">            p, rt, id, act)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="äº”ã€path-vs-path-filepath-åº“ç»“æ„"><a href="#äº”ã€path-vs-path-filepath-åº“ç»“æ„" class="headerlink" title="äº”ã€path vs path/filepath åº“ç»“æ„"></a>äº”ã€<code>path</code> vs <code>path/filepath</code> åº“ç»“æ„</h3><pre class="mermaid">graph TD    A[éœ€è¦å¤„ç†è·¯å¾„] --> B{è·¯å¾„æ¥æº}    B --> C[URLæ¯HTTPè·¯ç”±]    B --> D[æ–‡ä»¶ç³»ç»Ÿè·¯å¾„]    C --> E[ä½¿ç”¨pathåŒ…]    D --> F{æ“ä½œç³»ç»Ÿç±»å‹}    F --> G[è·¨å¹³å°éœ€æ±‚]    F --> H[ä»…Unixç¯å¢ƒ]    G --> I[ä½¿ç”¨filepathåŒ…]    H --> J[æ¨èfilepathåŒ…]        E --> K[ä¼˜åŠ¿<br/>å¤„ç†ç»“æœä¸€è‡´<br/>æ— OSä¾èµ–<br/>é€‚åˆç½‘ç»œåè®®]    I --> L[ä¼˜åŠ¿<br/>è‡ªåŠ¨é€‚é…åˆ†éš”ç¬¦<br/>æ”¯æŒWindowsè·¯å¾„<br/>ä¸osåŒ…é›†æˆ]</pre><p>ğŸ“Š <strong>æ€§èƒ½æç¤º</strong>ï¼š<code>path</code>åŒ…å› æ— éœ€OSé€‚é…ï¼Œç†è®ºæ€§èƒ½ç•¥ä¼˜äº<code>filepath</code>ï¼Œä½†å·®å¼‚é€šå¸¸å¯å¿½ç•¥ï¼ˆå¾®ç§’çº§ï¼‰ã€‚<strong>é€‰æ‹©ä¾æ®åº”æ˜¯è¯­ä¹‰æ­£ç¡®æ€§è€Œéæ€§èƒ½</strong>ã€‚</p><hr><h3 id="å…­ã€æ€»ç»“ï¼šä½•æ—¶ä½¿ç”¨pathåŒ…ï¼Ÿ"><a href="#å…­ã€æ€»ç»“ï¼šä½•æ—¶ä½¿ç”¨pathåŒ…ï¼Ÿ" class="headerlink" title="å…­ã€æ€»ç»“ï¼šä½•æ—¶ä½¿ç”¨pathåŒ…ï¼Ÿ"></a>å…­ã€æ€»ç»“ï¼šä½•æ—¶ä½¿ç”¨<code>path</code>åŒ…ï¼Ÿ</h3><p>âœ… <strong>æ¨èåœºæ™¯</strong>ï¼š</p><ul><li>HTTP&#x2F;RESTful APIè·¯ç”±å¤„ç†</li><li>URLè§£æä¸è§„èŒƒåŒ–</li><li>é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„è¡¨ç¤ºï¼ˆå¦‚YAML&#x2F;JSONä¸­çš„Unixé£æ ¼è·¯å¾„ï¼‰</li><li>è·¨å¹³å°åè®®ä¸­çš„è·¯å¾„å­—æ®µï¼ˆå¦‚gRPCã€Protobufï¼‰</li></ul><p>âŒ <strong>ç¦æ­¢åœºæ™¯</strong>ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿæ–‡ä»¶è·¯å¾„æ“ä½œï¼ˆå¿…é¡»ç”¨<code>path/filepath</code>ï¼‰</li><li>WindowsåŸç”Ÿè·¯å¾„ï¼ˆå«<code>\</code>æˆ–é©±åŠ¨å™¨å­—æ¯ï¼‰</li><li>éœ€è¦<code>Glob</code>é€’å½’åŒ¹é…çš„åœºæ™¯ï¼ˆç”¨<code>filepath.Glob</code>ï¼‰</li></ul><hr><p><strong>ç›¸å…³é˜…è¯»</strong>ï¼š</p><ul><li>Rob Pike è®ºæ–‡ï¼š<a href="https://9p.io/sys/doc/lexnames.html">Lexical File Names in Plan 9</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;å¸¸ç”¨æ³•åˆ™&lt;/strong&gt;ï¼šå½“è·¯å¾„&lt;strong&gt;ä»…åŒ…å«&lt;code&gt;/&lt;/code&gt;ä¸”ä¸æ¶‰åŠæ–‡ä»¶ç³»ç»Ÿ I&amp;#x2F;O&lt;/strong&gt;æ—¶ï¼Œé€‰æ‹©&lt;code&gt;path&lt;/code&gt;ï¼›å¦åˆ™æ— æ¡ä»¶ä½¿ç”¨&lt;code&gt;path/filepath&lt;/code&gt;ã€‚&lt;br&gt;ç‰¢è®°è¿™ä¸€åŸåˆ™ï¼Œå¯é¿å…99%çš„è·¯å¾„å¤„ç†é”™è¯¯ï¼Œè¿™ä¹Ÿæ˜¯éµå¾ªæœ€å°æƒé™åŸåˆ™å’Œåº”ç”¨å±‚å¼€å‘çš„å®è·µç»éªŒä¹‹ä¸€ã€‚&lt;br&gt;&lt;strong&gt;æ ¸å¿ƒæç¤º&lt;/strong&gt;ï¼š&lt;code&gt;path&lt;/code&gt;åŒ…ä¸“ä¸º&lt;strong&gt;æ­£æ–œæ (&amp;#x2F;)åˆ†éš”çš„è·¯å¾„&lt;/strong&gt;è®¾è®¡ï¼ˆå¦‚URLè·¯å¾„ï¼‰ï¼Œ&lt;strong&gt;ä¸é€‚ç”¨äºæ“ä½œç³»ç»Ÿæ–‡ä»¶è·¯å¾„&lt;/strong&gt;ï¼ˆåè€…åº”ä½¿ç”¨&lt;code&gt;path/filepath&lt;/code&gt;ï¼‰ã€‚   &lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-path" scheme="https://www.wdft.com/tags/Go-path/"/>
    
  </entry>
  
  <entry>
    <title>Agent ä¸ Skills ä¹‹é—´çš„åŒºåˆ«é€šè¿‡ä¸€ä¸ªç®€å•å›¾ä¹¦é¦†å€Ÿé˜…ç³»ç»Ÿæ¡ˆä¾‹å®è·µæŒ‡å—</title>
    <link href="https://www.wdft.com/65d4601b.html"/>
    <id>https://www.wdft.com/65d4601b.html</id>
    <published>2026-01-24T13:25:24.000Z</published>
    <updated>2026-01-30T06:40:40.569Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h2><p>åœ¨æŠ€æœ¯è¯­å¢ƒä¸‹ï¼Œä¸¤è€…çš„å…³ç³»å¯ä»¥ç®€å•æ¦‚æ‹¬å’ŒåŒºåˆ†ä¸ºï¼šAgent æ˜¯å†³ç­–ä¸­å¿ƒï¼ŒSkills æ˜¯æ‰§è¡Œå‡½æ•°ã€‚</p><span id="more"></span><ul><li><p><strong>Agent (æ™ºèƒ½ä½“)</strong>: ä¸€ä¸ªå…·å¤‡æ¨ç†ï¼ˆReasoningï¼‰ã€è§„åˆ’ï¼ˆPlanningï¼‰å’Œè®°å¿†ï¼ˆMemoryï¼‰èƒ½åŠ›çš„å®ä½“ã€‚å®ƒé€šè¿‡ ReActï¼ˆReasoning and Actingï¼‰æ¡†æ¶å†³å®šä½•æ—¶è°ƒç”¨å“ªä¸ª Skillã€‚</p></li><li><p><strong>Skills (æŠ€èƒ½&#x2F;å·¥å…·)</strong>: é¢„å®šä¹‰çš„ã€å…·æœ‰æ˜ç¡®è¾“å…¥&#x2F;è¾“å‡ºæ¨¡å¼çš„åŸå­åŒ–åŠŸèƒ½ï¼ˆAPIã€æ•°æ®åº“æŸ¥è¯¢ã€æœ¬åœ°è„šæœ¬ç­‰ï¼‰ã€‚</p></li></ul><p>åœ¨äººå·¥æ™ºèƒ½æŠ€æœ¯å¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼ŒAgentï¼ˆæ™ºèƒ½ä»£ç†ï¼‰ä¸ Skillsï¼ˆæŠ€èƒ½ï¼‰çš„å…³ç³»æ¶æ„å·²æˆä¸ºæ„å»ºå¤æ‚AIåº”ç”¨çš„æ ¸å¿ƒèŒƒå¼ã€‚<br>LangChainä½œä¸ºå½“å‰æœ€æµè¡Œçš„å¼€æºæ¡†æ¶ï¼Œæä¾›äº†é¢„æ„å»ºçš„agentæ¶æ„å’Œä¸°å¯Œçš„å·¥å…·é›†æˆï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿå¿«é€Ÿæ„å»ºé€‚åº”æ€§å¼ºçš„AIä»£ç†ç³»ç»Ÿã€‚<br>æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Agentä¸Skillsçš„å…³ç³»æ¶æ„ï¼ŒåŸºäºDebian 12ç³»ç»Ÿç¯å¢ƒï¼Œä»åŸºç¡€åŸç†åˆ°å®æˆ˜éƒ¨ç½²ä¸€ä¸ªå›¾ä¹¦é¦†å€Ÿé˜…ç³»ç»Ÿçš„ç®€å•æ¡ˆä¾‹æ¥åŠ æ·±ç†è§£ï¼Œæä¾›å®Œæ•´çš„æŠ€æœ¯å…¥é—¨æŒ‡å—ã€‚</p><h2 id="ä¸€ã€Agentä¸Skillsæ¶æ„æ¼”è¿›å²"><a href="#ä¸€ã€Agentä¸Skillsæ¶æ„æ¼”è¿›å²" class="headerlink" title="ä¸€ã€Agentä¸Skillsæ¶æ„æ¼”è¿›å²"></a>ä¸€ã€Agentä¸Skillsæ¶æ„æ¼”è¿›å²</h2><h3 id="1-1-æ¦‚å¿µèµ·æºä¸ç‰ˆæœ¬æ¼”è¿›"><a href="#1-1-æ¦‚å¿µèµ·æºä¸ç‰ˆæœ¬æ¼”è¿›" class="headerlink" title="1.1 æ¦‚å¿µèµ·æºä¸ç‰ˆæœ¬æ¼”è¿›"></a>1.1 æ¦‚å¿µèµ·æºä¸ç‰ˆæœ¬æ¼”è¿›</h3><p>Agent-Skillsæ¶æ„çš„å‘å±•ç»å†äº†å¤šä¸ªé‡è¦é˜¶æ®µï¼š</p><ul><li><strong>2020-2021å¹´</strong>ï¼šæ—©æœŸæ¦‚å¿µé˜¶æ®µï¼Œä¸»è¦å…³æ³¨åŸºç¡€LLMé›†æˆ</li><li><strong>2022å¹´</strong>ï¼šLangChain 0.0.1å‘å¸ƒï¼Œé¦–æ¬¡æå‡ºAgent-Toolsæ¶æ„</li><li><strong>2023å¹´</strong>ï¼šLangChain 0.1.0æ­£å¼ç‰ˆï¼ŒSkillsæ¦‚å¿µæ­£å¼ç¡®ç«‹</li><li><strong>2024å¹´</strong>ï¼šLangChain 0.2.0ï¼Œå¼•å…¥åˆ†å±‚Skillsç®¡ç†å’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</li><li><strong>2025å¹´</strong>ï¼šå½“å‰ç‰ˆæœ¬0.3.0ï¼Œæ”¯æŒå¤šæ¨¡æ€Skillså’Œåˆ†å¸ƒå¼AgentååŒ</li></ul><h3 id="1-2-å…³é”®ç‰¹æ€§æ¼”å˜"><a href="#1-2-å…³é”®ç‰¹æ€§æ¼”å˜" class="headerlink" title="1.2 å…³é”®ç‰¹æ€§æ¼”å˜"></a>1.2 å…³é”®ç‰¹æ€§æ¼”å˜</h3><p><strong>v0.1.x ç‰¹æ€§</strong>ï¼š</p><ul><li>åŸºç¡€Agentæ‰§è¡Œæ¡†æ¶</li><li>ç®€å•Toolsé›†æˆ</li><li>ä¸²è¡Œä»»åŠ¡å¤„ç†</li></ul><p><strong>v0.2.x ç‰¹æ€§</strong>ï¼š</p><ul><li>Skillsæ¨¡å—åŒ–è®¾è®¡</li><li>åŠ¨æ€æŠ€èƒ½åŠ è½½</li><li>è®°å¿†ç®¡ç†ä¼˜åŒ–</li><li>æ”¯æŒLangGraphå·¥ä½œæµ</li></ul><p><strong>v0.3.x ç‰¹æ€§ï¼ˆå½“å‰ï¼‰</strong>ï¼š</p><ul><li>å¤šAgentååŒæ¶æ„</li><li>æŠ€èƒ½å¸‚åœºï¼ˆSkills Marketplaceï¼‰</li><li>å®æ—¶æ€§èƒ½ç›‘æ§</li><li>å®‰å…¨æ²™ç®±æœºåˆ¶</li><li>è·¨è¯­è¨€Skillsæ”¯æŒ</li></ul><h2 id="äºŒã€Debian-12ç¯å¢ƒæ­å»ºä¸åŸç†å‰–æ"><a href="#äºŒã€Debian-12ç¯å¢ƒæ­å»ºä¸åŸç†å‰–æ" class="headerlink" title="äºŒã€Debian 12ç¯å¢ƒæ­å»ºä¸åŸç†å‰–æ"></a>äºŒã€Debian 12ç¯å¢ƒæ­å»ºä¸åŸç†å‰–æ</h2><h3 id="2-1-ç³»ç»Ÿç¯å¢ƒå‡†å¤‡"><a href="#2-1-ç³»ç»Ÿç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1 ç³»ç»Ÿç¯å¢ƒå‡†å¤‡"></a>2.1 ç³»ç»Ÿç¯å¢ƒå‡†å¤‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°ç³»ç»Ÿæº</span></span><br><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…åŸºç¡€ä¾èµ–</span></span><br><span class="line">sudo apt install -y python3 python3-pip python3-venv git curl wget \</span><br><span class="line">    build-essential libpq-dev libssl-dev postgresql-client</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé¡¹ç›®ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/agent-skills-project &amp;&amp; <span class="built_in">cd</span> ~/agent-skills-project</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">python3 -m venv venv</span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br></pre></td></tr></table></figure><h3 id="2-2-æ ¸å¿ƒæ¶æ„åŸç†"><a href="#2-2-æ ¸å¿ƒæ¶æ„åŸç†" class="headerlink" title="2.2 æ ¸å¿ƒæ¶æ„åŸç†"></a>2.2 æ ¸å¿ƒæ¶æ„åŸç†</h3><p>Agentä¸Skillsçš„å…³ç³»æ¶æ„åŸºäº<strong>åˆ†å±‚è®¾è®¡æ¨¡å¼</strong>ï¼ŒåŒ…å«ä¸‰ä¸ªæ ¸å¿ƒå±‚æ¬¡ï¼š</p><ol><li><strong>Agentå±‚</strong>ï¼šè´Ÿè´£å†³ç­–åˆ¶å®šã€ä»»åŠ¡è§„åˆ’å’Œåè°ƒ</li><li><strong>Skillså±‚</strong>ï¼šæä¾›å…·ä½“åŠŸèƒ½å®ç°ï¼Œå°è£…ä¸šåŠ¡é€»è¾‘</li><li><strong>Integrationå±‚</strong>ï¼šè¿æ¥å¤–éƒ¨ç³»ç»Ÿå’Œæ•°æ®æº</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¶æ„ç¤ºæ„å›¾</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Agent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, skills_registry</span>):</span><br><span class="line">        self.skills = skills_registry  <span class="comment"># æŠ€èƒ½æ³¨å†Œä¸­å¿ƒ</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_task</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="comment"># 1. ä»»åŠ¡åˆ†æ</span></span><br><span class="line">        skill_needed = self.analyze_task(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. æŠ€èƒ½é€‰æ‹©</span></span><br><span class="line">        selected_skill = self.select_skill(skill_needed)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. æŠ€èƒ½æ‰§è¡Œ</span></span><br><span class="line">        result = selected_skill.execute(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. ç»“æœå¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span> self.process_result(result)</span><br></pre></td></tr></table></figure><h3 id="2-3-å…³é”®ç‰¹æ€§è¯¦è§£"><a href="#2-3-å…³é”®ç‰¹æ€§è¯¦è§£" class="headerlink" title="2.3 å…³é”®ç‰¹æ€§è¯¦è§£"></a>2.3 å…³é”®ç‰¹æ€§è¯¦è§£</h3><h4 id="2-3-1-åŠ¨æ€æŠ€èƒ½åŠ è½½"><a href="#2-3-1-åŠ¨æ€æŠ€èƒ½åŠ è½½" class="headerlink" title="2.3.1 åŠ¨æ€æŠ€èƒ½åŠ è½½"></a>2.3.1 åŠ¨æ€æŠ€èƒ½åŠ è½½</h4><p>Skillså¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å’Œå¸è½½ï¼Œæ— éœ€é‡å¯AgentæœåŠ¡ï¼Œæå¤§æå‡äº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><h4 id="2-3-2-æŠ€èƒ½ç»„åˆæœºåˆ¶"><a href="#2-3-2-æŠ€èƒ½ç»„åˆæœºåˆ¶" class="headerlink" title="2.3.2 æŠ€èƒ½ç»„åˆæœºåˆ¶"></a>2.3.2 æŠ€èƒ½ç»„åˆæœºåˆ¶</h4><p>å¤šä¸ªSkillså¯ä»¥ç»„åˆå½¢æˆå¤åˆæŠ€èƒ½ï¼Œæ”¯æŒå¤æ‚çš„ä¸šåŠ¡åœºæ™¯å¤„ç†ã€‚</p><h4 id="2-3-3-è®°å¿†ç®¡ç†"><a href="#2-3-3-è®°å¿†ç®¡ç†" class="headerlink" title="2.3.3 è®°å¿†ç®¡ç†"></a>2.3.3 è®°å¿†ç®¡ç†</h4><p>å†…ç½®çš„å¯¹è¯è®°å¿†å’Œä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿Skillsåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒçŠ¶æ€è¿ç»­æ€§ã€‚</p><h2 id="ä¸‰ã€è¯¦ç»†é…ç½®æŒ‡å—ï¼ˆå¸¦ä¸­æ–‡æ³¨é‡Šï¼‰"><a href="#ä¸‰ã€è¯¦ç»†é…ç½®æŒ‡å—ï¼ˆå¸¦ä¸­æ–‡æ³¨é‡Šï¼‰" class="headerlink" title="ä¸‰ã€è¯¦ç»†é…ç½®æŒ‡å—ï¼ˆå¸¦ä¸­æ–‡æ³¨é‡Šï¼‰"></a>ä¸‰ã€è¯¦ç»†é…ç½®æŒ‡å—ï¼ˆå¸¦ä¸­æ–‡æ³¨é‡Šï¼‰</h2><h3 id="3-1-æ ¸å¿ƒé…ç½®æ–‡ä»¶-agent-config-yaml"><a href="#3-1-æ ¸å¿ƒé…ç½®æ–‡ä»¶-agent-config-yaml" class="headerlink" title="3.1 æ ¸å¿ƒé…ç½®æ–‡ä»¶ agent_config.yaml"></a>3.1 æ ¸å¿ƒé…ç½®æ–‡ä»¶ <code>agent_config.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Agentæ ¸å¿ƒé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="attr">agent:</span></span><br><span class="line">  <span class="comment"># Agentå”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">&quot;library_management_agent&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Agentåç§°ï¼ˆæ˜¾ç¤ºç”¨ï¼‰</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;å›¾ä¹¦é¦†ç®¡ç†æ™ºèƒ½ä»£ç†&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Agentæè¿°ä¿¡æ¯</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;è´Ÿè´£å›¾ä¹¦é¦†å€Ÿé˜…ã€å½’è¿˜ã€æŸ¥è¯¢ç­‰æ ¸å¿ƒä¸šåŠ¡çš„æ™ºèƒ½ä»£ç†&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># LLMæ¨¡å‹é…ç½®</span></span><br><span class="line">  <span class="attr">llm:</span></span><br><span class="line">    <span class="comment"># æ¨¡å‹æä¾›å•†ï¼ˆopenai, anthropic, localç­‰ï¼‰</span></span><br><span class="line">    <span class="attr">provider:</span> <span class="string">&quot;openai&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…·ä½“æ¨¡å‹åç§°</span></span><br><span class="line">    <span class="attr">model_name:</span> <span class="string">&quot;gpt-4-turbo&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># APIå¯†é’¥ï¼ˆç¯å¢ƒå˜é‡å¼•ç”¨ï¼‰</span></span><br><span class="line">    <span class="attr">api_key:</span> <span class="string">&quot;$&#123;OPENAI_API_KEY&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ¸©åº¦å‚æ•°ï¼ˆæ§åˆ¶éšæœºæ€§ï¼Œ0-1ï¼‰</span></span><br><span class="line">    <span class="attr">temperature:</span> <span class="number">0.3</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æœ€å¤§tokenæ•°é™åˆ¶</span></span><br><span class="line">    <span class="attr">max_tokens:</span> <span class="number">2000</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è®°å¿†ç®¡ç†é…ç½®</span></span><br><span class="line">  <span class="attr">memory:</span></span><br><span class="line">    <span class="comment"># è®°å¿†ç±»å‹ï¼ˆconversation, vector, hybridï¼‰</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;hybrid&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯¹è¯å†å²ä¿å­˜æ¡æ•°</span></span><br><span class="line">    <span class="attr">history_size:</span> <span class="number">10</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å‘é‡å­˜å‚¨é…ç½®</span></span><br><span class="line">    <span class="attr">vector_store:</span></span><br><span class="line">      <span class="comment"># å‘é‡æ•°æ®åº“ç±»å‹</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;chroma&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># æŒä¹…åŒ–è·¯å¾„</span></span><br><span class="line">      <span class="attr">persist_path:</span> <span class="string">&quot;./data/vector_store&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># åµŒå…¥æ¨¡å‹</span></span><br><span class="line">      <span class="attr">embedding_model:</span> <span class="string">&quot;text-embedding-ada-002&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½æ³¨å†Œä¸­å¿ƒé…ç½®</span></span><br><span class="line">  <span class="attr">skills_registry:</span></span><br><span class="line">    <span class="comment"># æŠ€èƒ½ç›®å½•è·¯å¾„</span></span><br><span class="line">    <span class="attr">skills_dir:</span> <span class="string">&quot;./skills&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è‡ªåŠ¨åŠ è½½æ–°æŠ€èƒ½</span></span><br><span class="line">    <span class="attr">auto_load:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æŠ€èƒ½ç¼“å­˜æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</span></span><br><span class="line">    <span class="attr">cache_ttl:</span> <span class="number">30</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æŠ€èƒ½æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">execution_timeout:</span> <span class="number">60</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># å®‰å…¨é…ç½®</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="comment"># æ²™ç®±æ¨¡å¼ï¼ˆtrue/falseï¼‰</span></span><br><span class="line">    <span class="attr">sandbox_mode:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…è®¸çš„å¤–éƒ¨è°ƒç”¨åŸŸå</span></span><br><span class="line">    <span class="attr">allowed_domains:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æŠ€èƒ½æƒé™æ§åˆ¶</span></span><br><span class="line">    <span class="attr">skill_permissions:</span></span><br><span class="line">      <span class="comment"># è¯»å–æƒé™</span></span><br><span class="line">      <span class="attr">read:</span> [<span class="string">&quot;query_book&quot;</span>, <span class="string">&quot;check_availability&quot;</span>]</span><br><span class="line">      <span class="comment"># å†™å…¥æƒé™</span></span><br><span class="line">      <span class="attr">write:</span> [<span class="string">&quot;borrow_book&quot;</span>, <span class="string">&quot;return_book&quot;</span>, <span class="string">&quot;add_book&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ—¥å¿—é…ç½®</span></span><br><span class="line">  <span class="attr">logging:</span></span><br><span class="line">    <span class="comment"># æ—¥å¿—çº§åˆ«ï¼ˆdebug, info, warning, error, criticalï¼‰</span></span><br><span class="line">    <span class="attr">level:</span> <span class="string">&quot;info&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="attr">file_path:</span> <span class="string">&quot;./logs/agent.log&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ˜¯å¦è¾“å‡ºåˆ°æ§åˆ¶å°</span></span><br><span class="line">    <span class="attr">console_output:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ•°æ®åº“è¿æ¥é…ç½®</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="comment"># æ•°æ®åº“ç±»å‹</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;postgresql&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿æ¥ä¸»æœº</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç«¯å£</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ•°æ®åº“åç§°</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">&quot;library_db&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç”¨æˆ·å</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">&quot;library_user&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯†ç ï¼ˆç¯å¢ƒå˜é‡ï¼‰</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&quot;$&#123;DB_PASSWORD&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿æ¥æ± å¤§å°</span></span><br><span class="line">    <span class="attr">max_connections:</span> <span class="number">10</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">connection_timeout:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¯å¢ƒå˜é‡é…ç½®</span></span><br><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="comment"># å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒ</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">&quot;development&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è°ƒè¯•æ¨¡å¼</span></span><br><span class="line">  <span class="attr">debug:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ€§èƒ½ç›‘æ§</span></span><br><span class="line">  <span class="attr">monitoring:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">metrics_port:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure><h3 id="3-2-æŠ€èƒ½é…ç½®æ–‡ä»¶ç¤ºä¾‹-skills-borrow-book-yaml"><a href="#3-2-æŠ€èƒ½é…ç½®æ–‡ä»¶ç¤ºä¾‹-skills-borrow-book-yaml" class="headerlink" title="3.2 æŠ€èƒ½é…ç½®æ–‡ä»¶ç¤ºä¾‹ skills/borrow_book.yaml"></a>3.2 æŠ€èƒ½é…ç½®æ–‡ä»¶ç¤ºä¾‹ <code>skills/borrow_book.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ€èƒ½é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="attr">skill:</span></span><br><span class="line">  <span class="comment"># æŠ€èƒ½å”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">&quot;borrow_book&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½åç§°</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;å›¾ä¹¦å€Ÿé˜…æŠ€èƒ½&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½æè¿°</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;å¤„ç†ç”¨æˆ·å€Ÿé˜…å›¾ä¹¦çš„è¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·èµ„æ ¼å’Œå›¾ä¹¦å¯ç”¨æ€§&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½ç‰ˆæœ¬</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½ä½œè€…</span></span><br><span class="line">  <span class="attr">author:</span> <span class="string">&quot;library-team&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½åˆ†ç±»</span></span><br><span class="line">  <span class="attr">category:</span> <span class="string">&quot;library_operations&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ä¾èµ–çš„Skills</span></span><br><span class="line">  <span class="attr">dependencies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;check_user_eligibility&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;check_book_availability&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è¾“å…¥å‚æ•°å®šä¹‰</span></span><br><span class="line">  <span class="attr">input_schema:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;object&quot;</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">user_id:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;ç”¨æˆ·ID&quot;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">book_id:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;å›¾ä¹¦ID&quot;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">borrow_date:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">format:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;å€Ÿé˜…æ—¥æœŸï¼Œæ ¼å¼YYYY-MM-DD&quot;</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&quot;current_date&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è¾“å‡ºå‚æ•°å®šä¹‰</span></span><br><span class="line">  <span class="attr">output_schema:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;object&quot;</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">success:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;æ“ä½œæ˜¯å¦æˆåŠŸ&quot;</span></span><br><span class="line">      <span class="attr">transaction_id:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;äº¤æ˜“ID&quot;</span></span><br><span class="line">      <span class="attr">due_date:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">format:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;åº”è¿˜æ—¥æœŸ&quot;</span></span><br><span class="line">      <span class="attr">message:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;æ“ä½œç»“æœæ¶ˆæ¯&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ‰§è¡Œé€»è¾‘é…ç½®</span></span><br><span class="line">  <span class="attr">execution:</span></span><br><span class="line">    <span class="comment"># æ‰§è¡Œç±»å‹ï¼ˆpython, javascript, shellç­‰ï¼‰</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;python&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…¥å£å‡½æ•°</span></span><br><span class="line">    <span class="attr">entry_point:</span> <span class="string">&quot;borrow_book.execute&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">30</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é‡è¯•æ¬¡æ•°</span></span><br><span class="line">    <span class="attr">max_retries:</span> <span class="number">3</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é‡è¯•é—´éš”ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">retry_interval:</span> <span class="number">2</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># èµ„æºé™åˆ¶</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="comment"># å†…å­˜é™åˆ¶ï¼ˆMBï¼‰</span></span><br><span class="line">    <span class="attr">memory_limit:</span> <span class="number">256</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># CPUé™åˆ¶ï¼ˆæ ¸æ•°ï¼‰</span></span><br><span class="line">    <span class="attr">cpu_limit:</span> <span class="number">0.5</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç½‘ç»œè®¿é—®æƒé™</span></span><br><span class="line">    <span class="attr">network_access:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># é”™è¯¯å¤„ç†</span></span><br><span class="line">  <span class="attr">error_handling:</span></span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰é”™è¯¯æ˜ å°„</span></span><br><span class="line">    <span class="attr">error_codes:</span></span><br><span class="line">      <span class="attr">USER_NOT_FOUND:</span> <span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span></span><br><span class="line">      <span class="attr">BOOK_NOT_AVAILABLE:</span> <span class="string">&quot;å›¾ä¹¦ä¸å¯å€Ÿé˜…&quot;</span></span><br><span class="line">      <span class="attr">MAX_BORROWS_REACHED:</span> <span class="string">&quot;å·²è¾¾åˆ°æœ€å¤§å€Ÿé˜…æ•°é‡&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é»˜è®¤é”™è¯¯å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="attr">default_handler:</span> <span class="string">&quot;error_handlers.default_handler&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ç¼“å­˜é…ç½®</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦å¯ç”¨ç¼“å­˜</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">ttl:</span> <span class="number">60</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥</span></span><br><span class="line">    <span class="attr">key_strategy:</span> <span class="string">&quot;user_book_combination&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ç›‘æ§æŒ‡æ ‡</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="comment"># å¯ç”¨æ€§èƒ½ç›‘æ§</span></span><br><span class="line">    <span class="attr">enable_performance:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰æŒ‡æ ‡</span></span><br><span class="line">    <span class="attr">custom_metrics:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;borrow_success_rate&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;average_processing_time&quot;</span></span><br></pre></td></tr></table></figure><h2 id="å››ã€éƒ¨ç½²æ¶æ„ä¸æœ€ä½³å®è·µ"><a href="#å››ã€éƒ¨ç½²æ¶æ„ä¸æœ€ä½³å®è·µ" class="headerlink" title="å››ã€éƒ¨ç½²æ¶æ„ä¸æœ€ä½³å®è·µ"></a>å››ã€éƒ¨ç½²æ¶æ„ä¸æœ€ä½³å®è·µ</h2><h3 id="4-1-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„"><a href="#4-1-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„" class="headerlink" title="4.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„"></a>4.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      è´Ÿè½½å‡è¡¡å±‚                               â”‚</span><br><span class="line">â”‚                  Nginx/HAProxy                              â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                            â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      åº”ç”¨æœåŠ¡å±‚                               â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚</span><br><span class="line">â”‚  â”‚  Agent-1    â”‚  â”‚  Agent-2    â”‚  â”‚  Agent-3    â”‚          â”‚</span><br><span class="line">â”‚  â”‚ (Primary)   â”‚  â”‚ (Backup)    â”‚  â”‚ (Read-only) â”‚          â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                            â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      æ•°æ®å­˜å‚¨å±‚                               â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚</span><br><span class="line">â”‚  â”‚ PostgreSQL  â”‚  â”‚ Vector      â”‚  â”‚ Redis       â”‚          â”‚</span><br><span class="line">â”‚  â”‚ (ä¸»ä»å¤åˆ¶)   â”‚  â”‚  DB (Chroma)â”‚  â”‚ (ç¼“å­˜)       â”‚          â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="4-2-å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker-Composeï¼‰"><a href="#4-2-å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker-Composeï¼‰" class="headerlink" title="4.2 å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker Composeï¼‰"></a>4.2 å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker Composeï¼‰</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># Agentä¸»æœåŠ¡</span></span><br><span class="line">  <span class="attr">agent-service:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile.agent</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">library-agent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span>  <span class="comment"># ç›‘æ§ç«¯å£</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">OPENAI_API_KEY=$&#123;OPENAI_API_KEY&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_PASSWORD=$&#123;DB_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ENVIRONMENT=production</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./skills:/app/skills</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/app/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vector-db</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8080/health&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># PostgreSQLæ•°æ®åº“</span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:15-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">library-postgres</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_DB=library_db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_USER=library_user</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_PASSWORD=$&#123;DB_PASSWORD&#125;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres_data:/var/lib/postgresql/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./init.sql:/docker-entrypoint-initdb.d/init.sql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5432:5432&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Redisç¼“å­˜</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">library-redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_data:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># å‘é‡æ•°æ®åº“</span></span><br><span class="line">  <span class="attr">vector-db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">chromadb/chroma:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">library-vector-db</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vector_data:/chroma</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ç›‘æ§æœåŠ¡</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/prometheus:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">agent-prometheus</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9091:9090&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">agent-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">postgres_data:</span></span><br><span class="line">  <span class="attr">redis_data:</span></span><br><span class="line">  <span class="attr">vector_data:</span></span><br></pre></td></tr></table></figure><h3 id="4-3-å…³é”®æ³¨æ„äº‹é¡¹"><a href="#4-3-å…³é”®æ³¨æ„äº‹é¡¹" class="headerlink" title="4.3 å…³é”®æ³¨æ„äº‹é¡¹"></a>4.3 å…³é”®æ³¨æ„äº‹é¡¹</h3><p><strong>âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹ï¼š</strong></p><ol><li><p><strong>å®‰å…¨éš”ç¦»</strong>ï¼šç”Ÿäº§ç¯å¢ƒä¸­å¿…é¡»å¯ç”¨æ²™ç®±æ¨¡å¼ï¼Œé™åˆ¶Skillsçš„ç½‘ç»œè®¿é—®æƒé™ï¼Œé˜²æ­¢æ¶æ„ä»£ç æ‰§è¡Œã€‚</p></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šSkillsçš„æ‰§è¡Œè¶…æ—¶æ—¶é—´åº”æ ¹æ®ä¸šåŠ¡åœºæ™¯åˆç†è®¾ç½®ï¼Œé¿å…é˜»å¡Agentä¸»çº¿ç¨‹ã€‚</p></li><li><p><strong>ç‰ˆæœ¬æ§åˆ¶</strong>ï¼šSkillså¿…é¡»ä¸¥æ ¼éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ï¼Œç¡®ä¿å‘åå…¼å®¹æ€§ã€‚</p></li><li><p><strong>ç›‘æ§å‘Šè­¦</strong>ï¼šå¿…é¡»é…ç½®å®Œæ•´çš„ç›‘æ§æŒ‡æ ‡ï¼ŒåŒ…æ‹¬æŠ€èƒ½æ‰§è¡ŒæˆåŠŸç‡ã€å“åº”æ—¶é—´ã€èµ„æºä½¿ç”¨ç‡ç­‰ã€‚</p></li><li><p><strong>ç¾å¤‡ç­–ç•¥</strong>ï¼šAgentæœåŠ¡åº”éƒ¨ç½²å¤šå®ä¾‹ï¼Œå®ç°æ•…éšœè‡ªåŠ¨åˆ‡æ¢ï¼Œç¡®ä¿æœåŠ¡é«˜å¯ç”¨ã€‚</p></li></ol><h2 id="äº”ã€å®æˆ˜Demoï¼šå›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿ"><a href="#äº”ã€å®æˆ˜Demoï¼šå›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿ" class="headerlink" title="äº”ã€å®æˆ˜Demoï¼šå›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿ"></a>äº”ã€å®æˆ˜Demoï¼šå›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿ</h2><h3 id="5-1-æ•°æ®åº“è®¾è®¡ï¼ˆPostgreSQLï¼‰"><a href="#5-1-æ•°æ®åº“è®¾è®¡ï¼ˆPostgreSQLï¼‰" class="headerlink" title="5.1 æ•°æ®åº“è®¾è®¡ï¼ˆPostgreSQLï¼‰"></a>5.1 æ•°æ®åº“è®¾è®¡ï¼ˆPostgreSQLï¼‰</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å›¾ä¹¦è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> books (</span><br><span class="line">    id <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    author <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    isbn <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    category <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    total_copies <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    available_copies <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    published_year <span class="type">INTEGER</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç”¨æˆ·è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> users (</span><br><span class="line">    id <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    max_borrow_limit <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">5</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å€Ÿé˜…è®°å½•è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> borrow_records (</span><br><span class="line">    id SERIAL <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    user_id <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">    book_id <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">REFERENCES</span> books(id),</span><br><span class="line">    borrow_date <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    due_date <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    return_date <span class="type">DATE</span>,</span><br><span class="line">    status <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;borrowed&#x27;</span> <span class="keyword">CHECK</span> (status <span class="keyword">IN</span> (<span class="string">&#x27;borrowed&#x27;</span>, <span class="string">&#x27;returned&#x27;</span>, <span class="string">&#x27;overdue&#x27;</span>)),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç´¢å¼•ä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_borrow_records_user <span class="keyword">ON</span> borrow_records(user_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_borrow_records_book <span class="keyword">ON</span> borrow_records(book_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_borrow_records_status <span class="keyword">ON</span> borrow_records(status);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è§¦å‘å™¨ï¼šæ›´æ–°å›¾ä¹¦å¯ç”¨æ•°é‡</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> update_book_availability()</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="keyword">TRIGGER</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    IF NEW.status <span class="operator">=</span> <span class="string">&#x27;borrowed&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> books <span class="keyword">SET</span> available_copies <span class="operator">=</span> available_copies <span class="operator">-</span> <span class="number">1</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.book_id;</span><br><span class="line">    ELSIF NEW.status <span class="operator">=</span> <span class="string">&#x27;returned&#x27;</span> <span class="keyword">AND</span> OLD.status <span class="operator">=</span> <span class="string">&#x27;borrowed&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> books <span class="keyword">SET</span> available_copies <span class="operator">=</span> available_copies <span class="operator">+</span> <span class="number">1</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.book_id;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">NEW</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_update_book_availability</span><br><span class="line">AFTER <span class="keyword">INSERT</span> <span class="keyword">OR</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> borrow_records</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> update_book_availability();</span><br></pre></td></tr></table></figure><h3 id="5-2-Pythonå®ç°ï¼ˆåŸºäºLangChainï¼‰"><a href="#5-2-Pythonå®ç°ï¼ˆåŸºäºLangChainï¼‰" class="headerlink" title="5.2 Pythonå®ç°ï¼ˆåŸºäºLangChainï¼‰"></a>5.2 Pythonå®ç°ï¼ˆåŸºäºLangChainï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># library_agent.py</span></span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor, create_tool_calling_agent</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_community.utilities <span class="keyword">import</span> SQLDatabase</span><br><span class="line"><span class="keyword">from</span> langchain_community.agent_toolkits <span class="keyword">import</span> SQLDatabaseToolkit</span><br><span class="line"><span class="keyword">from</span> langchain_core.tools <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">import</span> psycopg2</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">        self.db = SQLDatabase.from_uri(</span><br><span class="line">            <span class="string">f&quot;postgresql://<span class="subst">&#123;os.getenv(<span class="string">&#x27;DB_USER&#x27;</span>)&#125;</span>:<span class="subst">&#123;os.getenv(<span class="string">&#x27;DB_PASSWORD&#x27;</span>)&#125;</span>@<span class="subst">&#123;os.getenv(<span class="string">&#x27;DB_HOST&#x27;</span>)&#125;</span>/<span class="subst">&#123;os.getenv(<span class="string">&#x27;DB_NAME&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–LLM</span></span><br><span class="line">        self.llm = ChatOpenAI(</span><br><span class="line">            model=<span class="string">&quot;gpt-4-turbo&quot;</span>,</span><br><span class="line">            temperature=<span class="number">0.3</span>,</span><br><span class="line">            api_key=os.getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ›å»ºå·¥å…·åŒ…</span></span><br><span class="line">        self.toolkit = SQLDatabaseToolkit(db=self.db, llm=self.llm)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å®šä¹‰ä¸“ä¸šå·¥å…·</span></span><br><span class="line">        self.tools = [</span><br><span class="line">            self.borrow_book_tool,</span><br><span class="line">            self.return_book_tool,</span><br><span class="line">            self.check_availability_tool,</span><br><span class="line">            self.get_user_info_tool,</span><br><span class="line">            self.search_books_tool</span><br><span class="line">        ] + self.toolkit.get_tools()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ›å»ºAgent</span></span><br><span class="line">        self.agent = self.create_agent()</span><br><span class="line">        self.agent_executor = AgentExecutor(</span><br><span class="line">            agent=self.agent,</span><br><span class="line">            tools=self.tools,</span><br><span class="line">            verbose=<span class="literal">True</span>,</span><br><span class="line">            max_iterations=<span class="number">10</span>,</span><br><span class="line">            early_stopping_method=<span class="string">&quot;force&quot;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_agent</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºå›¾ä¹¦é¦†ç®¡ç†Agent&quot;&quot;&quot;</span></span><br><span class="line">        prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">            (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾ä¹¦é¦†ç®¡ç†åŠ©æ‰‹ï¼Œè´Ÿè´£å¤„ç†å›¾ä¹¦å€Ÿé˜…ã€å½’è¿˜ã€æŸ¥è¯¢ç­‰ä¸šåŠ¡ã€‚</span></span><br><span class="line"><span class="string">            è¯·æ ¹æ®ç”¨æˆ·è¯·æ±‚é€‰æ‹©åˆé€‚çš„å·¥å…·æ‰§è¡Œæ“ä½œï¼Œå¹¶æä¾›æ¸…æ™°ã€å‹å¥½çš„å›å¤ã€‚</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            å¯ç”¨å·¥å…·ï¼š</span></span><br><span class="line"><span class="string">            - borrow_book_tool: å¤„ç†å›¾ä¹¦å€Ÿé˜…</span></span><br><span class="line"><span class="string">            - return_book_tool: å¤„ç†å›¾ä¹¦å½’è¿˜  </span></span><br><span class="line"><span class="string">            - check_availability_tool: æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line"><span class="string">            - get_user_info_tool: è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="string">            - search_books_tool: æœç´¢å›¾ä¹¦</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            é‡è¦è§„åˆ™ï¼š</span></span><br><span class="line"><span class="string">            1. å€Ÿä¹¦å‰å¿…é¡»æ£€æŸ¥ç”¨æˆ·èµ„æ ¼å’Œå›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line"><span class="string">            2. å½’è¿˜å›¾ä¹¦æ—¶éœ€è¦éªŒè¯å€Ÿé˜…è®°å½•</span></span><br><span class="line"><span class="string">            3. æ‰€æœ‰æ“ä½œéƒ½éœ€è¦è®°å½•æ—¥å¿—</span></span><br><span class="line"><span class="string">            4. é‡åˆ°é”™è¯¯æ—¶æä¾›å‹å¥½çš„é”™è¯¯æç¤º&quot;&quot;&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;&#123;agent_scratchpad&#125;&quot;</span>)</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> create_tool_calling_agent(self.llm, self.tools, prompt)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">borrow_book_tool</span>(<span class="params">self, user_id: <span class="built_in">str</span>, book_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å€Ÿé˜…å›¾ä¹¦å·¥å…·&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># æ£€æŸ¥ç”¨æˆ·èµ„æ ¼</span></span><br><span class="line">            user_info = self.get_user_info_tool(user_id)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user_info[<span class="string">&quot;eligible&quot;</span>]:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;ç”¨æˆ·å€Ÿé˜…èµ„æ ¼ä¸è¶³&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line">            availability = self.check_availability_tool(book_id)</span><br><span class="line">            <span class="keyword">if</span> availability[<span class="string">&quot;available_copies&quot;</span>] &lt;= <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å›¾ä¹¦æš‚æ— åº“å­˜&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ‰§è¡Œå€Ÿé˜…</span></span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ›å»ºå€Ÿé˜…è®°å½•</span></span><br><span class="line">            borrow_date = datetime.now().date()</span><br><span class="line">            due_date = borrow_date + timedelta(days=<span class="number">14</span>)  <span class="comment"># 14å¤©å€Ÿé˜…æœŸ</span></span><br><span class="line">            </span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                INSERT INTO borrow_records (user_id, book_id, borrow_date, due_date, status)</span></span><br><span class="line"><span class="string">                VALUES (%s, %s, %s, %s, &#x27;borrowed&#x27;)</span></span><br><span class="line"><span class="string">                RETURNING id, due_date</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (user_id, book_id, borrow_date, due_date))</span><br><span class="line">            </span><br><span class="line">            result = cursor.fetchone()</span><br><span class="line">            transaction_id, due_date = result</span><br><span class="line">            </span><br><span class="line">            conn.commit()</span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;transaction_id&quot;</span>: transaction_id,</span><br><span class="line">                <span class="string">&quot;due_date&quot;</span>: due_date.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>),</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;å€Ÿé˜…æˆåŠŸï¼è¯·åœ¨<span class="subst">&#123;due_date.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)&#125;</span>å‰å½’è¿˜ã€‚&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;å€Ÿé˜…å¤±è´¥: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">return_book_tool</span>(<span class="params">self, user_id: <span class="built_in">str</span>, book_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å½’è¿˜å›¾ä¹¦å·¥å…·&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æŸ¥æ‰¾æœªå½’è¿˜çš„å€Ÿé˜…è®°å½•</span></span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT id FROM borrow_records </span></span><br><span class="line"><span class="string">                WHERE user_id = %s AND book_id = %s AND status = &#x27;borrowed&#x27;</span></span><br><span class="line"><span class="string">                ORDER BY borrow_date DESC LIMIT 1</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (user_id, book_id))</span><br><span class="line">            </span><br><span class="line">            record = cursor.fetchone()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> record:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;æœªæ‰¾åˆ°ç›¸å…³å€Ÿé˜…è®°å½•&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            record_id = record[<span class="number">0</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ›´æ–°å½’è¿˜çŠ¶æ€</span></span><br><span class="line">            return_date = datetime.now().date()</span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                UPDATE borrow_records </span></span><br><span class="line"><span class="string">                SET status = &#x27;returned&#x27;, return_date = %s </span></span><br><span class="line"><span class="string">                WHERE id = %s</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (return_date, record_id))</span><br><span class="line">            </span><br><span class="line">            conn.commit()</span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å›¾ä¹¦å½’è¿˜æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„ä½¿ç”¨ã€‚&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;å½’è¿˜å¤±è´¥: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_availability_tool</span>(<span class="params">self, book_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT title, author, total_copies, available_copies </span></span><br><span class="line"><span class="string">                FROM books WHERE id = %s</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (book_id,))</span><br><span class="line">            </span><br><span class="line">            book = cursor.fetchone()</span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> book:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;available&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å›¾ä¹¦ä¸å­˜åœ¨&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            title, author, total, available = book</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;available&quot;</span>: available &gt; <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;book_title&quot;</span>: title,</span><br><span class="line">                <span class="string">&quot;author&quot;</span>: author,</span><br><span class="line">                <span class="string">&quot;total_copies&quot;</span>: total,</span><br><span class="line">                <span class="string">&quot;available_copies&quot;</span>: available,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;ã€Š<span class="subst">&#123;title&#125;</span>ã€‹å½“å‰æœ‰<span class="subst">&#123;available&#125;</span>æœ¬å¯å€Ÿ&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user_info_tool</span>(<span class="params">self, user_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç”¨æˆ·ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</span></span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT name, email, max_borrow_limit FROM users WHERE id = %s</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (user_id,))</span><br><span class="line">            user = cursor.fetchone()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;eligible&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            name, email, max_limit = user</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–å½“å‰å€Ÿé˜…æ•°é‡</span></span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT COUNT(*) FROM borrow_records </span></span><br><span class="line"><span class="string">                WHERE user_id = %s AND status = &#x27;borrowed&#x27;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (user_id,))</span><br><span class="line">            current_borrows = cursor.fetchone()[<span class="number">0</span>]</span><br><span class="line">            </span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            eligible = current_borrows &lt; max_limit</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;eligible&quot;</span>: eligible,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">                <span class="string">&quot;email&quot;</span>: email,</span><br><span class="line">                <span class="string">&quot;max_borrow_limit&quot;</span>: max_limit,</span><br><span class="line">                <span class="string">&quot;current_borrows&quot;</span>: current_borrows,</span><br><span class="line">                <span class="string">&quot;remaining_limit&quot;</span>: max_limit - current_borrows,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: eligible <span class="keyword">and</span> <span class="string">&quot;ç”¨æˆ·å€Ÿé˜…èµ„æ ¼æ­£å¸¸&quot;</span> <span class="keyword">or</span> <span class="string">&quot;å·²è¾¾åˆ°æœ€å¤§å€Ÿé˜…æ•°é‡&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_books_tool</span>(<span class="params">self, query: <span class="built_in">str</span>, category: <span class="built_in">str</span> = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æœç´¢å›¾ä¹¦&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ„å»ºæŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">            conditions = []</span><br><span class="line">            params = [<span class="string">f&quot;%<span class="subst">&#123;query&#125;</span>%&quot;</span>]</span><br><span class="line">            sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT id, title, author, isbn, category, available_copies </span></span><br><span class="line"><span class="string">                FROM books </span></span><br><span class="line"><span class="string">                WHERE title ILIKE %s OR author ILIKE %s OR isbn ILIKE %s</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            conditions.extend([<span class="string">f&quot;%<span class="subst">&#123;query&#125;</span>%&quot;</span>, <span class="string">f&quot;%<span class="subst">&#123;query&#125;</span>%&quot;</span>, <span class="string">f&quot;%<span class="subst">&#123;query&#125;</span>%&quot;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> category:</span><br><span class="line">                sql += <span class="string">&quot; AND category = %s&quot;</span></span><br><span class="line">                conditions.append(category)</span><br><span class="line">            </span><br><span class="line">            sql += <span class="string">&quot; ORDER BY title LIMIT 10&quot;</span></span><br><span class="line">            </span><br><span class="line">            cursor.execute(sql, <span class="built_in">tuple</span>(conditions))</span><br><span class="line">            books = cursor.fetchall()</span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;id&quot;</span>: book[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;title&quot;</span>: book[<span class="number">1</span>],</span><br><span class="line">                    <span class="string">&quot;author&quot;</span>: book[<span class="number">2</span>],</span><br><span class="line">                    <span class="string">&quot;isbn&quot;</span>: book[<span class="number">3</span>],</span><br><span class="line">                    <span class="string">&quot;category&quot;</span>: book[<span class="number">4</span>],</span><br><span class="line">                    <span class="string">&quot;available_copies&quot;</span>: book[<span class="number">5</span>]</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> book <span class="keyword">in</span> books</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> [&#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_db_connection</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æ•°æ®åº“è¿æ¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> psycopg2.connect(</span><br><span class="line">            host=os.getenv(<span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>),</span><br><span class="line">            database=os.getenv(<span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;library_db&#x27;</span>),</span><br><span class="line">            user=os.getenv(<span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;library_user&#x27;</span>),</span><br><span class="line">            password=os.getenv(<span class="string">&#x27;DB_PASSWORD&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            port=os.getenv(<span class="string">&#x27;DB_PORT&#x27;</span>, <span class="string">&#x27;5432&#x27;</span>)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, user_input: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¿è¡ŒAgentå¤„ç†ç”¨æˆ·è¾“å…¥&quot;&quot;&quot;</span></span><br><span class="line">        result = self.agent_executor.invoke(&#123;<span class="string">&quot;input&quot;</span>: user_input&#125;)</span><br><span class="line">        <span class="keyword">return</span> result[<span class="string">&quot;output&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">    os.environ[<span class="string">&quot;OPENAI_API_KEY&quot;</span>] = <span class="string">&quot;your-api-key&quot;</span></span><br><span class="line">    os.environ[<span class="string">&quot;DB_HOST&quot;</span>] = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    os.environ[<span class="string">&quot;DB_NAME&quot;</span>] = <span class="string">&quot;library_db&quot;</span></span><br><span class="line">    os.environ[<span class="string">&quot;DB_USER&quot;</span>] = <span class="string">&quot;library_user&quot;</span></span><br><span class="line">    os.environ[<span class="string">&quot;DB_PASSWORD&quot;</span>] = <span class="string">&quot;your-db-password&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–Agent</span></span><br><span class="line">    agent = LibraryAgent()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æµ‹è¯•å¯¹è¯</span></span><br><span class="line">    test_inputs = [</span><br><span class="line">        <span class="string">&quot;æˆ‘æƒ³å€Ÿä¸€æœ¬ã€Šäººå·¥æ™ºèƒ½å¯¼è®ºã€‹&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ç”¨æˆ·user123å¯ä»¥å€Ÿå¤šå°‘æœ¬ä¹¦ï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;å¸®æˆ‘æŸ¥æ‰¾æ‰€æœ‰ç¼–ç¨‹ç±»çš„å›¾ä¹¦&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æˆ‘è¦å½’è¿˜ã€Šæœºå™¨å­¦ä¹ å®æˆ˜ã€‹&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> user_input <span class="keyword">in</span> test_inputs:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nç”¨æˆ·: <span class="subst">&#123;user_input&#125;</span>&quot;</span>)</span><br><span class="line">        response = agent.run(user_input)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;åŠ©æ‰‹: <span class="subst">&#123;response&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="5-3-Goè¯­è¨€å®ç°"><a href="#5-3-Goè¯­è¨€å®ç°" class="headerlink" title="5.3 Goè¯­è¨€å®ç°"></a>5.3 Goè¯­è¨€å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/jackc/pgx/v5/pgxpool&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/sashabaranov/go-openai&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LibraryAgent <span class="keyword">struct</span> &#123;</span><br><span class="line">db        *pgxpool.Pool</span><br><span class="line">openai    *openai.Client</span><br><span class="line">config    *AgentConfig</span><br><span class="line">skills    <span class="keyword">map</span>[<span class="type">string</span>]Skill</span><br><span class="line">tools     <span class="keyword">map</span>[<span class="type">string</span>]Tool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Skill <span class="keyword">interface</span> &#123;</span><br><span class="line">Execute(ctx context.Context, params <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;) (<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>)</span><br><span class="line">GetDescription() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Tool <span class="keyword">struct</span> &#123;</span><br><span class="line">Name        <span class="type">string</span></span><br><span class="line">Description <span class="type">string</span></span><br><span class="line">Handler     <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, params <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span></span> (<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AgentConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">DatabaseURL <span class="type">string</span></span><br><span class="line">OpenAIAPIKey <span class="type">string</span></span><br><span class="line">MaxBorrowDays <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLibraryAgent</span><span class="params">(config *AgentConfig)</span></span> (*LibraryAgent, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">dbPool, err := pgxpool.New(context.Background(), config.DatabaseURL)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;æ•°æ®åº“è¿æ¥å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯</span></span><br><span class="line">openaiClient := openai.NewClient(config.OpenAIAPIKey)</span><br><span class="line"></span><br><span class="line">agent := &amp;LibraryAgent&#123;</span><br><span class="line">db:        dbPool,</span><br><span class="line">openai:    openaiClient,</span><br><span class="line">config:    config,</span><br><span class="line">skills:    <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]Skill),</span><br><span class="line">tools:     <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]Tool),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†ŒæŠ€èƒ½</span></span><br><span class="line">agent.registerSkills()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œå·¥å…·</span></span><br><span class="line">agent.registerTools()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> agent, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *LibraryAgent)</span></span> registerSkills() &#123;</span><br><span class="line"><span class="comment">// å€Ÿä¹¦æŠ€èƒ½</span></span><br><span class="line">a.skills[<span class="string">&quot;borrow_book&quot;</span>] = &amp;BorrowBookSkill&#123;agent: a&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿˜ä¹¦æŠ€èƒ½</span></span><br><span class="line">a.skills[<span class="string">&quot;return_book&quot;</span>] = &amp;ReturnBookSkill&#123;agent: a&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥è¯¢æŠ€èƒ½</span></span><br><span class="line">a.skills[<span class="string">&quot;search_books&quot;</span>] = &amp;SearchBooksSkill&#123;agent: a&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *LibraryAgent)</span></span> registerTools() &#123;</span><br><span class="line">a.tools[<span class="string">&quot;check_availability&quot;</span>] = Tool&#123;</span><br><span class="line">Name:        <span class="string">&quot;check_availability&quot;</span>,</span><br><span class="line">Description: <span class="string">&quot;æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§&quot;</span>,</span><br><span class="line">Handler:     a.handleCheckAvailability,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a.tools[<span class="string">&quot;get_user_info&quot;</span>] = Tool&#123;</span><br><span class="line">Name:        <span class="string">&quot;get_user_info&quot;</span>,</span><br><span class="line">Description: <span class="string">&quot;è·å–ç”¨æˆ·ä¿¡æ¯&quot;</span>,</span><br><span class="line">Handler:     a.handleGetUserInfo,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BorrowBookSkill <span class="keyword">struct</span> &#123;</span><br><span class="line">agent *LibraryAgent</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *BorrowBookSkill)</span></span> Execute(ctx context.Context, params <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;) (<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">userID, ok := params[<span class="string">&quot;user_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;ç¼ºå°‘ç”¨æˆ·ID&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bookID, ok := params[<span class="string">&quot;book_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;ç¼ºå°‘å›¾ä¹¦ID&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ç”¨æˆ·èµ„æ ¼</span></span><br><span class="line">userInfo, err := s.agent.tools[<span class="string">&quot;get_user_info&quot;</span>].Handler(ctx, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;user_id&quot;</span>: userID&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !userInfo[<span class="string">&quot;eligible&quot;</span>].(<span class="type">bool</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;success&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;message&quot;</span>: <span class="string">&quot;ç”¨æˆ·å€Ÿé˜…èµ„æ ¼ä¸è¶³&quot;</span>,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line">availability, err := s.agent.tools[<span class="string">&quot;check_availability&quot;</span>].Handler(ctx, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;book_id&quot;</span>: bookID&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> availability[<span class="string">&quot;available_copies&quot;</span>].(<span class="type">int</span>) &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;success&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;message&quot;</span>: <span class="string">&quot;å›¾ä¹¦æš‚æ— åº“å­˜&quot;</span>,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œå€Ÿé˜…</span></span><br><span class="line">tx, err := s.agent.db.Begin(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> tx.Rollback(ctx)</span><br><span class="line"></span><br><span class="line">borrowDate := time.Now().Format(<span class="string">&quot;2006-01-02&quot;</span>)</span><br><span class="line">dueDate := time.Now().AddDate(<span class="number">0</span>, <span class="number">0</span>, s.agent.config.MaxBorrowDays).Format(<span class="string">&quot;2006-01-02&quot;</span>)</span><br><span class="line"></span><br><span class="line">_, err = tx.Exec(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">INSERT INTO borrow_records (user_id, book_id, borrow_date, due_date, status)</span></span><br><span class="line"><span class="string">VALUES ($1, $2, $3, $4, &#x27;borrowed&#x27;)</span></span><br><span class="line"><span class="string">RETURNING id</span></span><br><span class="line"><span class="string">`</span>, userID, bookID, borrowDate, dueDate)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := tx.Commit(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;success&quot;</span>:     <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;due_date&quot;</span>:    dueDate,</span><br><span class="line"><span class="string">&quot;message&quot;</span>:     fmt.Sprintf(<span class="string">&quot;å€Ÿé˜…æˆåŠŸï¼è¯·åœ¨%så‰å½’è¿˜ã€‚&quot;</span>, dueDate),</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *BorrowBookSkill)</span></span> GetDescription() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;å¤„ç†å›¾ä¹¦å€Ÿé˜…è¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·èµ„æ ¼å’Œå›¾ä¹¦å¯ç”¨æ€§&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">config := &amp;AgentConfig&#123;</span><br><span class="line">DatabaseURL:  <span class="string">&quot;postgres://library_user:password@localhost:5432/library_db&quot;</span>,</span><br><span class="line">OpenAIAPIKey: os.Getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>),</span><br><span class="line">MaxBorrowDays: <span class="number">14</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">agent, err := NewLibraryAgent(config)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;åˆå§‹åŒ–Agentå¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> agent.db.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•å€Ÿä¹¦æŠ€èƒ½</span></span><br><span class="line">ctx := context.Background()</span><br><span class="line">params := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;user123&quot;</span>,</span><br><span class="line"><span class="string">&quot;book_id&quot;</span>: <span class="string">&quot;book456&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result, err := agent.skills[<span class="string">&quot;borrow_book&quot;</span>].Execute(ctx, params)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;æŠ€èƒ½æ‰§è¡Œå¤±è´¥: %v&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;ç»“æœ: %+v\n&quot;</span>, result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-4-PHPå®ç°"><a href="#5-4-PHPå®ç°" class="headerlink" title="5.4 PHPå®ç°"></a>5.4 PHPå®ç°</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// library_agent.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">OpenAI</span>\<span class="title">Client</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">OpenAI</span>\<span class="title">Factory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PgSql</span>\<span class="title">Connection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LibraryAgent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$db</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$openai</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$skills</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$tools</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$config</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config = <span class="variable">$config</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="title function_ invoke__">pg_connect</span>(<span class="variable">$config</span>[<span class="string">&#x27;database_url&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;db) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;æ•°æ®åº“è¿æ¥å¤±è´¥: &quot;</span> . <span class="title function_ invoke__">pg_last_error</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;openai = <span class="title class_">Factory</span>::<span class="title function_ invoke__">factory</span>()-&gt;<span class="title function_ invoke__">getClient</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ³¨å†ŒæŠ€èƒ½</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerSkills</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ³¨å†Œå·¥å…·</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerTools</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">registerSkills</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;skills[<span class="string">&#x27;borrow_book&#x27;</span>] = <span class="keyword">new</span> <span class="title class_">BorrowBookSkill</span>(<span class="variable language_">$this</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;skills[<span class="string">&#x27;return_book&#x27;</span>] = <span class="keyword">new</span> <span class="title class_">ReturnBookSkill</span>(<span class="variable language_">$this</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;skills[<span class="string">&#x27;search_books&#x27;</span>] = <span class="keyword">new</span> <span class="title class_">SearchBooksSkill</span>(<span class="variable language_">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">registerTools</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;tools[<span class="string">&#x27;check_availability&#x27;</span>] = [</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;check_availability&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;description&#x27;</span> =&gt; <span class="string">&#x27;æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;handler&#x27;</span> =&gt; [<span class="variable language_">$this</span>, <span class="string">&#x27;handleCheckAvailability&#x27;</span>]</span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;tools[<span class="string">&#x27;get_user_info&#x27;</span>] = [</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;get_user_info&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;description&#x27;</span> =&gt; <span class="string">&#x27;è·å–ç”¨æˆ·ä¿¡æ¯&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;handler&#x27;</span> =&gt; [<span class="variable language_">$this</span>, <span class="string">&#x27;handleGetUserInfo&#x27;</span>]</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">executeSkill</span>(<span class="params"><span class="variable">$skillName</span>, <span class="variable">$params</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;skills[<span class="variable">$skillName</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;æŠ€èƒ½ä¸å­˜åœ¨: &quot;</span> . <span class="variable">$skillName</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;skills[<span class="variable">$skillName</span>]-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$params</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleCheckAvailability</span>(<span class="params"><span class="variable">$params</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$bookId</span> = <span class="variable">$params</span>[<span class="string">&#x27;book_id&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;SELECT title, author, total_copies, available_copies FROM books WHERE id = <span class="subst">$1</span>&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">pg_query_params</span>(<span class="variable">$this</span>-&gt;db, <span class="variable">$query</span>, [<span class="variable">$bookId</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$result</span> || <span class="title function_ invoke__">pg_num_rows</span>(<span class="variable">$result</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">&#x27;available&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;å›¾ä¹¦ä¸å­˜åœ¨&#x27;</span></span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$book</span> = <span class="title function_ invoke__">pg_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line">        <span class="variable">$available</span> = (<span class="keyword">int</span>)<span class="variable">$book</span>[<span class="string">&#x27;available_copies&#x27;</span>] &gt; <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;available&#x27;</span> =&gt; <span class="variable">$available</span>,</span><br><span class="line">            <span class="string">&#x27;book_title&#x27;</span> =&gt; <span class="variable">$book</span>[<span class="string">&#x27;title&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;author&#x27;</span> =&gt; <span class="variable">$book</span>[<span class="string">&#x27;author&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;total_copies&#x27;</span> =&gt; (<span class="keyword">int</span>)<span class="variable">$book</span>[<span class="string">&#x27;total_copies&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;available_copies&#x27;</span> =&gt; (<span class="keyword">int</span>)<span class="variable">$book</span>[<span class="string">&#x27;available_copies&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$available</span> ? <span class="string">&quot;ã€Š<span class="subst">&#123;$book[&#x27;title&#x27;]&#125;</span>ã€‹å½“å‰æœ‰<span class="subst">&#123;$book[&#x27;available_copies&#x27;]&#125;</span>æœ¬å¯å€Ÿ&quot;</span> : <span class="string">&quot;ã€Š<span class="subst">&#123;$book[&#x27;title&#x27;]&#125;</span>ã€‹æš‚æ— åº“å­˜&quot;</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleGetUserInfo</span>(<span class="params"><span class="variable">$params</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$userId</span> = <span class="variable">$params</span>[<span class="string">&#x27;user_id&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;SELECT name, email, max_borrow_limit FROM users WHERE id = <span class="subst">$1</span>&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">pg_query_params</span>(<span class="variable">$this</span>-&gt;db, <span class="variable">$query</span>, [<span class="variable">$userId</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$result</span> || <span class="title function_ invoke__">pg_num_rows</span>(<span class="variable">$result</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">&#x27;eligible&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;ç”¨æˆ·ä¸å­˜åœ¨&#x27;</span></span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$user</span> = <span class="title function_ invoke__">pg_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–å½“å‰å€Ÿé˜…æ•°é‡</span></span><br><span class="line">        <span class="variable">$borrowQuery</span> = <span class="string">&quot;SELECT COUNT(*) as current_borrows FROM borrow_records WHERE user_id = <span class="subst">$1</span> AND status = &#x27;borrowed&#x27;&quot;</span>;</span><br><span class="line">        <span class="variable">$borrowResult</span> = <span class="title function_ invoke__">pg_query_params</span>(<span class="variable">$this</span>-&gt;db, <span class="variable">$borrowQuery</span>, [<span class="variable">$userId</span>]);</span><br><span class="line">        <span class="variable">$borrowData</span> = <span class="title function_ invoke__">pg_fetch_assoc</span>(<span class="variable">$borrowResult</span>);</span><br><span class="line">        <span class="variable">$currentBorrows</span> = (<span class="keyword">int</span>)<span class="variable">$borrowData</span>[<span class="string">&#x27;current_borrows&#x27;</span>];</span><br><span class="line">        <span class="variable">$maxLimit</span> = (<span class="keyword">int</span>)<span class="variable">$user</span>[<span class="string">&#x27;max_borrow_limit&#x27;</span>];</span><br><span class="line">        <span class="variable">$eligible</span> = <span class="variable">$currentBorrows</span> &lt; <span class="variable">$maxLimit</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;eligible&#x27;</span> =&gt; <span class="variable">$eligible</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$user</span>[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span> =&gt; <span class="variable">$user</span>[<span class="string">&#x27;email&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;max_borrow_limit&#x27;</span> =&gt; <span class="variable">$maxLimit</span>,</span><br><span class="line">            <span class="string">&#x27;current_borrows&#x27;</span> =&gt; <span class="variable">$currentBorrows</span>,</span><br><span class="line">            <span class="string">&#x27;remaining_limit&#x27;</span> =&gt; <span class="variable">$maxLimit</span> - <span class="variable">$currentBorrows</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$eligible</span> ? <span class="string">&quot;ç”¨æˆ·å€Ÿé˜…èµ„æ ¼æ­£å¸¸&quot;</span> : <span class="string">&quot;å·²è¾¾åˆ°æœ€å¤§å€Ÿé˜…æ•°é‡&quot;</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;db) &#123;</span><br><span class="line">            <span class="title function_ invoke__">pg_close</span>(<span class="variable">$this</span>-&gt;db);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BorrowBookSkill</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$agent</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$agent</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;agent = <span class="variable">$agent</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params"><span class="variable">$params</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$userId</span> = <span class="variable">$params</span>[<span class="string">&#x27;user_id&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$bookId</span> = <span class="variable">$params</span>[<span class="string">&#x27;book_id&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$userId</span>) || <span class="keyword">empty</span>(<span class="variable">$bookId</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;ç¼ºå°‘å¿…è¦çš„å‚æ•°: user_id æˆ– book_id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥ç”¨æˆ·èµ„æ ¼</span></span><br><span class="line">        <span class="variable">$userInfo</span> = <span class="variable language_">$this</span>-&gt;agent-&gt;tools[<span class="string">&#x27;get_user_info&#x27;</span>][<span class="string">&#x27;handler&#x27;</span>]([</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span> =&gt; <span class="variable">$userId</span></span><br><span class="line">        ]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$userInfo</span>[<span class="string">&#x27;eligible&#x27;</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$userInfo</span>[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line">        <span class="variable">$availability</span> = <span class="variable language_">$this</span>-&gt;agent-&gt;tools[<span class="string">&#x27;check_availability&#x27;</span>][<span class="string">&#x27;handler&#x27;</span>]([</span><br><span class="line">            <span class="string">&#x27;book_id&#x27;</span> =&gt; <span class="variable">$bookId</span></span><br><span class="line">        ]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$availability</span>[<span class="string">&#x27;available&#x27;</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$availability</span>[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œå€Ÿé˜…</span></span><br><span class="line">        <span class="variable">$borrowDate</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d&#x27;</span>);</span><br><span class="line">        <span class="variable">$dueDate</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d&#x27;</span>, <span class="title function_ invoke__">strtotime</span>(<span class="string">&quot;+14 days&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;INSERT INTO borrow_records (user_id, book_id, borrow_date, due_date, status) VALUES (<span class="subst">$1</span>, <span class="subst">$2</span>, <span class="subst">$3</span>, <span class="subst">$4</span>, &#x27;borrowed&#x27;) RETURNING id&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">pg_query_params</span>(<span class="variable">$this</span>-&gt;agent-&gt;db, <span class="variable">$query</span>, [<span class="variable">$userId</span>, <span class="variable">$bookId</span>, <span class="variable">$borrowDate</span>, <span class="variable">$dueDate</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;å€Ÿé˜…å¤±è´¥: &quot;</span> . <span class="title function_ invoke__">pg_last_error</span>(<span class="variable">$this</span>-&gt;agent-&gt;db));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$record</span> = <span class="title function_ invoke__">pg_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line">        <span class="variable">$transactionId</span> = <span class="variable">$record</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;transaction_id&#x27;</span> =&gt; <span class="variable">$transactionId</span>,</span><br><span class="line">            <span class="string">&#x27;due_date&#x27;</span> =&gt; <span class="variable">$dueDate</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&quot;å€Ÿé˜…æˆåŠŸï¼è¯·åœ¨<span class="subst">&#123;$dueDate&#125;</span>å‰å½’è¿˜ã€‚&quot;</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;å¤„ç†å›¾ä¹¦å€Ÿé˜…è¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·èµ„æ ¼å’Œå›¾ä¹¦å¯ç”¨æ€§&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="variable">$config</span> = [</span><br><span class="line">    <span class="string">&#x27;database_url&#x27;</span> =&gt; <span class="string">&#x27;host=localhost dbname=library_db user=library_user password=password&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;openai_api_key&#x27;</span> =&gt; <span class="title function_ invoke__">getenv</span>(<span class="string">&#x27;OPENAI_API_KEY&#x27;</span>)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$agent</span> = <span class="keyword">new</span> <span class="title class_">LibraryAgent</span>(<span class="variable">$config</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œå€Ÿä¹¦æŠ€èƒ½</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$agent</span>-&gt;<span class="title function_ invoke__">executeSkill</span>(<span class="string">&#x27;borrow_book&#x27;</span>, [</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span> =&gt; <span class="string">&#x27;user123&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;book_id&#x27;</span> =&gt; <span class="string">&#x27;book456&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);</span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;é”™è¯¯: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§"><a href="#å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§" class="headerlink" title="å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§"></a>å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§</h2><h3 id="6-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#6-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="6.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>6.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3><ol><li><strong>æŠ€èƒ½ç¼“å­˜</strong>ï¼šå¯¹é¢‘ç¹è°ƒç”¨çš„Skillsç»“æœè¿›è¡Œç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—</li><li><strong>è¿æ¥æ± ä¼˜åŒ–</strong>ï¼šåˆç†é…ç½®æ•°æ®åº“è¿æ¥æ± å¤§å°ï¼Œé¿å…è¿æ¥æ³„æ¼</li><li><strong>å¼‚æ­¥æ‰§è¡Œ</strong>ï¼šå¯¹äºè€—æ—¶æ“ä½œï¼Œä½¿ç”¨å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—å¤„ç†</li><li><strong>æ‰¹å¤„ç†</strong>ï¼šåˆå¹¶å¤šä¸ªç›¸ä¼¼è¯·æ±‚ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°</li><li><strong>ç´¢å¼•ä¼˜åŒ–</strong>ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºåˆé€‚çš„ç´¢å¼•</li></ol><h3 id="6-2-ç›‘æ§æŒ‡æ ‡è®¾è®¡"><a href="#6-2-ç›‘æ§æŒ‡æ ‡è®¾è®¡" class="headerlink" title="6.2 ç›‘æ§æŒ‡æ ‡è®¾è®¡"></a>6.2 ç›‘æ§æŒ‡æ ‡è®¾è®¡</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus.yml</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;library-agent&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;agent-service:9090&#x27;</span>]</span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">&#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é”®ç›‘æ§æŒ‡æ ‡</span></span><br><span class="line"><span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_skill_execution_count&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;counter&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;æŠ€èƒ½æ‰§è¡Œæ¬¡æ•°ç»Ÿè®¡&quot;</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;skill_name&quot;</span>, <span class="string">&quot;status&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_skill_execution_duration_seconds&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;histogram&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;æŠ€èƒ½æ‰§è¡Œè€—æ—¶åˆ†å¸ƒ&quot;</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;skill_name&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_database_connections&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;gauge&quot;</span> </span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;æ•°æ®åº“è¿æ¥æ•°&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_memory_usage_mb&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;gauge&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;å†…å­˜ä½¿ç”¨é‡&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_request_queue_length&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;gauge&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;è¯·æ±‚é˜Ÿåˆ—é•¿åº¦&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_error_count&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;counter&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;é”™è¯¯æ¬¡æ•°ç»Ÿè®¡&quot;</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;error_type&quot;</span>, <span class="string">&quot;skill_name&quot;</span>]</span><br></pre></td></tr></table></figure><h2 id="ä¸ƒã€å®‰å…¨åŠ å›ºæªæ–½"><a href="#ä¸ƒã€å®‰å…¨åŠ å›ºæªæ–½" class="headerlink" title="ä¸ƒã€å®‰å…¨åŠ å›ºæªæ–½"></a>ä¸ƒã€å®‰å…¨åŠ å›ºæªæ–½</h2><h3 id="7-1-å®‰å…¨æ¶æ„è®¾è®¡"><a href="#7-1-å®‰å…¨æ¶æ„è®¾è®¡" class="headerlink" title="7.1 å®‰å…¨æ¶æ„è®¾è®¡"></a>7.1 å®‰å…¨æ¶æ„è®¾è®¡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      å®‰å…¨é˜²æŠ¤å±‚                               |</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚</span><br><span class="line">â”‚  â”‚  è¾“å…¥éªŒè¯    â”‚  | æƒé™æ§åˆ¶      â”‚  â”‚ æ²™ç®±éš”ç¦»     â”‚          â”‚</span><br><span class="line">â”‚  â”‚ (Validation)â”‚  â”‚ (RBAC)      â”‚  â”‚ (Sandbox)   â”‚          â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                            â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      åº”ç”¨å±‚                                  â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚</span><br><span class="line">â”‚  â”‚  Agent      |  â”‚ Skills      â”‚  â”‚   Log       â”‚          â”‚</span><br><span class="line">|  |    æ ¸å¿ƒ      |  |   ç®¡ç†      ï½œ  |  æ—¥å¿—å®¡è®¡    |          |    </span><br><span class="line">â”‚  â”‚ (Core)      â”‚  â”‚ (Registry)  â”‚  â”‚ (Audit)     â”‚          â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="7-2-å…³é”®å®‰å…¨æªæ–½ï¼ˆå»ºè®®ï¼‰"><a href="#7-2-å…³é”®å®‰å…¨æªæ–½ï¼ˆå»ºè®®ï¼‰" class="headerlink" title="7.2 å…³é”®å®‰å…¨æªæ–½ï¼ˆå»ºè®®ï¼‰"></a>7.2 å…³é”®å®‰å…¨æªæ–½ï¼ˆå»ºè®®ï¼‰</h3><ol><li><strong>è¾“å…¥éªŒè¯</strong>ï¼šå¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸¥æ ¼éªŒè¯å’Œè¿‡æ»¤</li><li><strong>æƒé™æ§åˆ¶</strong>ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼Œæœ€å°æƒé™åŸåˆ™</li><li><strong>æ²™ç®±éš”ç¦»</strong>ï¼šSkillsåœ¨ç‹¬ç«‹çš„æ²™ç®±ç¯å¢ƒä¸­æ‰§è¡Œï¼Œé™åˆ¶ç³»ç»Ÿè®¿é—®</li><li><strong>æ•°æ®åŠ å¯†</strong>ï¼šæ•æ„Ÿæ•°æ®åœ¨ä¼ è¾“å’Œå­˜å‚¨æ—¶è¿›è¡ŒåŠ å¯†</li><li><strong>å®¡è®¡æ—¥å¿—</strong>ï¼šè®°å½•æ‰€æœ‰å…³é”®æ“ä½œï¼Œä¾¿äºå®‰å…¨å®¡è®¡å’Œé—®é¢˜è¿½è¸ª</li><li><strong>é€Ÿç‡é™åˆ¶</strong>ï¼šé˜²æ­¢APIæ»¥ç”¨å’ŒDDoSæ”»å‡»</li><li><strong>å®‰å…¨æ›´æ–°</strong>ï¼šå®šæœŸæ›´æ–°ä¾èµ–åº“ï¼Œä¿®å¤å·²çŸ¥å®‰å…¨æ¼æ´</li></ol><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>Agentä¸Skillsçš„å…³ç³»æ¶æ„ä»£è¡¨äº†ç°ä»£AIç³»ç»Ÿè®¾è®¡çš„æ–°èŒƒå¼ï¼Œé€šè¿‡å°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘åˆ†è§£ä¸ºå¯å¤ç”¨çš„Skillsï¼ŒAgentèƒ½å¤Ÿæ›´åŠ çµæ´»ã€æ™ºèƒ½åœ°å¤„ç†å„ç§ä»»åŠ¡ã€‚æœ¬æ–‡åŸºäºDebian 12ç¯å¢ƒï¼Œä»åŸç†åˆ°å®è·µï¼Œå…¨é¢ä»‹ç»äº†è¿™ä¸€æ¶æ„çš„è®¾è®¡ã€å®ç°å’Œéƒ¨ç½²ã€‚LangChainæ¡†æ¶ä¸ºå¼€å‘è€…æä¾›äº†å¼ºå¤§çš„å·¥å…·å’Œé¢„æ„å»ºçš„æ¶æ„ï¼Œè®©æ„å»ºAI agentså˜å¾—æ›´åŠ é«˜æ•ˆã€‚</p><p>åœ¨å›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿçš„å®æˆ˜Demoä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•å°†ç†è®ºçŸ¥è¯†åº”ç”¨åˆ°å…·ä½“ä¸šåŠ¡åœºæ™¯ï¼Œé€šè¿‡Pythonã€Goã€PHPä¸‰ç§ä¸»æµè¯­è¨€çš„å®ç°ï¼Œå±•ç¤ºäº†Skillsæ¶æ„çš„è·¨è¯­è¨€ç‰¹æ€§ã€‚ æ— è®ºé€‰æ‹©å“ªç§æŠ€æœ¯æ ˆï¼Œæ ¸å¿ƒçš„è®¾è®¡åŸåˆ™éƒ½æ˜¯ç›¸åŒçš„ï¼šæ¨¡å—åŒ–ã€å¯å¤ç”¨ã€å®‰å…¨å¯é ã€‚</p><p>éšç€AIæŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼ŒAgent-Skillsæ¶æ„å°†ç»§ç»­æ¼”è¿›ï¼Œæ”¯æŒæ›´å¤æ‚çš„å¤šAgentååŒã€æ›´æ™ºèƒ½çš„æŠ€èƒ½å‘ç°å’Œç»„åˆæœºåˆ¶ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬éœ€è¦æŒç»­å…³æ³¨è¿™ä¸€é¢†åŸŸçš„å‘å±•ï¼ŒæŒæ¡æœ€æ–°çš„è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µï¼Œæ„å»ºæ›´åŠ æ™ºèƒ½ã€å¯é çš„åº”ç”¨ç³»ç»Ÿã€‚</p><p><strong>ä¸ªäººå»ºè®®</strong>ï¼šæŠ€æœ¯çš„æ ¸å¿ƒæ˜¯è§£å†³é—®é¢˜ï¼Œè€Œä¸æ˜¯è¿½é€æ½®æµã€‚åœ¨è®¾è®¡Agent-Skillsæ¶æ„æ—¶ï¼Œå§‹ç»ˆè¦ä»ä¸šåŠ¡éœ€æ±‚å‡ºå‘ï¼Œé€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯æœ€æµè¡Œçš„æŠ€æœ¯æ–¹æ¡ˆã€‚åªæœ‰è¿™æ ·ï¼Œæˆ‘ä»¬æ‰èƒ½æ„å»ºçœŸæ­£æœ‰ä»·å€¼çš„AIç³»ç»Ÿã€‚<strong>skillæœ¬èº«ä¹Ÿè®¸æ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä½†ç»ä¸æ˜¯å”¯ä¸€çš„æœ€ä½³è§£å†³æ–¹æ¡ˆï¼Œéšç€æ¨¡å‹çš„èƒ½åŠ›è¿›ä¸€æ­¥å‘å±•ï¼Œé’ˆå¯¹ä¼ä¸šçº§åœºæ™¯åº”è¯¥ä¼šæœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚</strong>ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;&lt;a href=&quot;#æ‘˜è¦&quot; class=&quot;headerlink&quot; title=&quot;æ‘˜è¦&quot;&gt;&lt;/a&gt;æ‘˜è¦&lt;/h2&gt;&lt;p&gt;åœ¨æŠ€æœ¯è¯­å¢ƒä¸‹ï¼Œä¸¤è€…çš„å…³ç³»å¯ä»¥ç®€å•æ¦‚æ‹¬å’ŒåŒºåˆ†ä¸ºï¼šAgent æ˜¯å†³ç­–ä¸­å¿ƒï¼ŒSkills æ˜¯æ‰§è¡Œå‡½æ•°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/tags/Agent/"/>
    
    <category term="Skill" scheme="https://www.wdft.com/tags/Skill/"/>
    
    <category term="Agent-Skill" scheme="https://www.wdft.com/tags/Agent-Skill/"/>
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="Demo-AI" scheme="https://www.wdft.com/tags/Demo-AI/"/>
    
  </entry>
  
  <entry>
    <title>ã€netã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“Goæ ‡å‡†åº“netè®¾è®¡åŸç†ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/e962a527.html"/>
    <id>https://www.wdft.com/e962a527.html</id>
    <published>2026-01-23T17:28:14.000Z</published>
    <updated>2026-02-05T06:54:26.797Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ·±å…¥Goæ ‡å‡†åº“netåŒ…ï¼šæ„å»ºé«˜æ€§èƒ½ç½‘ç»œåº”ç”¨çš„åŸºçŸ³"><a href="#æ·±å…¥Goæ ‡å‡†åº“netåŒ…ï¼šæ„å»ºé«˜æ€§èƒ½ç½‘ç»œåº”ç”¨çš„åŸºçŸ³" class="headerlink" title="æ·±å…¥Goæ ‡å‡†åº“netåŒ…ï¼šæ„å»ºé«˜æ€§èƒ½ç½‘ç»œåº”ç”¨çš„åŸºçŸ³"></a>æ·±å…¥Goæ ‡å‡†åº“netåŒ…ï¼šæ„å»ºé«˜æ€§èƒ½ç½‘ç»œåº”ç”¨çš„åŸºçŸ³</h1><p>åŸºäºGo 1.22+æ ‡å‡†åº“ï¼ˆæˆªè‡³2026å¹´1æœˆï¼‰ï¼Œæä¾›å®Œå…¨åŸåˆ›çš„æŠ€æœ¯è§£æï¼Œæ¶µç›–æ¶æ„è®¾è®¡ã€åº•å±‚åŸç†ã€å®æˆ˜æŠ€å·§ä¸é¿å‘æŒ‡å—ã€‚</p><span id="more"></span><h2 id="ä¸€ã€netåº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ"><a href="#ä¸€ã€netåº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ" class="headerlink" title="ä¸€ã€netåº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ"></a>ä¸€ã€netåº“å…¨æ™¯æ¶æ„ï¼šå‡½æ•°ä¸ç±»å‹æ€»è§ˆ</h2><p>Goçš„<code>net</code>åŒ…é‡‡ç”¨â€æ¥å£æŠ½è±¡+å…·ä½“å®ç°â€çš„åˆ†å±‚è®¾è®¡ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯<strong>å±è”½åº•å±‚åè®®å·®å¼‚ï¼Œæä¾›ç»Ÿä¸€çš„ç½‘ç»œI&#x2F;OæŠ½è±¡</strong>ã€‚ï¼š</p><pre class="mermaid">flowchart LR    A[netåŒ…æ ¸å¿ƒæ¶æ„] --> B[åœ°å€è§£æå±‚]    A --> C[è¿æ¥ç®¡ç†å±‚]    A --> D[åè®®å®ç°å±‚]    A --> E[é«˜çº§é…ç½®å±‚]        subgraph B [åœ°å€è§£æå±‚]        B1[ResolveIPAddr<br>è§£æIPåœ°å€] --> B2[LookupHost<br>DNSä¸»æœºæŸ¥è¯¢]        B2 --> B3[LookupIP<br>IPåœ°å€æŸ¥è¯¢]        B3 --> B4[LookupPort<br>æœåŠ¡ç«¯å£æŸ¥è¯¢]    end        subgraph C [è¿æ¥ç®¡ç†å±‚]        C1[Dial<br>ä¸»åŠ¨å»ºç«‹è¿æ¥] --> C2[Listen<br>ç›‘å¬ç«¯å£]        C2 --> C3[Accept<br>æ¥æ”¶è¿æ¥]        C3 --> C4[Connæ¥å£<br>é€šç”¨è¿æ¥æŠ½è±¡]        C4 --> C5[Listeneræ¥å£<br>ç›‘å¬å™¨æŠ½è±¡]    end        subgraph D [åè®®å®ç°å±‚]        D1[TCPConn<br>TCPæµå¼è¿æ¥] --> D2[UDPConn<br>UDPæ•°æ®æŠ¥]        D2 --> D3[IPConn<br>åŸå§‹IPè¿æ¥]        D3 --> D4[UnixConn<br>UnixåŸŸSocket]        D4 --> D5[PacketConn<br>æ•°æ®æŠ¥é€šç”¨æ¥å£]    end        subgraph E [é«˜çº§é…ç½®å±‚]        E1[Dialer<br>å¸¦è¶…æ—¶/ä¸Šä¸‹æ–‡çš„æ‹¨å·å™¨] --> E2[ListenerConfig<br>ç›‘å¬å™¨é…ç½®]        E2 --> E3[SetDeadline<br>è¯»å†™æˆªæ­¢æ—¶é—´]        E3 --> E4[SetKeepAlive<br>TCPä¿æ´»æ§åˆ¶]    end        C4 -.->|å®ç°| D1    C4 -.->|å®ç°| D2    C4 -.->|å®ç°| D3    C4 -.->|å®ç°| D4    C5 -.->|å®ç°| D1    D2 -.->|å®ç°| D5    D3 -.->|å®ç°| D5    D4 -.->|å®ç°| D5        F[è¾…åŠ©ç±»å‹] --> F1[IP/IPv4/IPv6<br>IPåœ°å€è¡¨ç¤º]    F --> F2[TCPAddr/UDPAddr<br>å¸¦ç«¯å£çš„åœ°å€]    F --> F3[IPNet<br>IPç½‘ç»œæ®µ]    F --> F4[AddrError<br>åœ°å€é”™è¯¯å¤„ç†]</pre><h3 id="æ ¸å¿ƒç»„ä»¶åŠŸèƒ½é€ŸæŸ¥è¡¨"><a href="#æ ¸å¿ƒç»„ä»¶åŠŸèƒ½é€ŸæŸ¥è¡¨" class="headerlink" title="æ ¸å¿ƒç»„ä»¶åŠŸèƒ½é€ŸæŸ¥è¡¨"></a>æ ¸å¿ƒç»„ä»¶åŠŸèƒ½é€ŸæŸ¥è¡¨</h3><table><thead><tr><th>ç»„ä»¶ç±»å‹</th><th>å…³é”®å‡½æ•°&#x2F;æ¥å£</th><th>ä¸­æ–‡åŠŸèƒ½è¯´æ˜</th><th>å…¸å‹ä½¿ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>è¿æ¥åˆ›å»º</strong></td><td><code>Dial(network, address)</code></td><td>ä¸»åŠ¨å»ºç«‹ç½‘ç»œè¿æ¥</td><td>å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚</td></tr><tr><td></td><td><code>DialTimeout(network, address, timeout)</code></td><td>å¸¦è¶…æ—¶çš„è¿æ¥å»ºç«‹</td><td>é˜²æ­¢è¿æ¥é˜»å¡</td></tr><tr><td></td><td><code>Dialer.DialContext(ctx, network, address)</code></td><td>æ”¯æŒContextå–æ¶ˆçš„æ‹¨å·</td><td>å¾®æœåŠ¡è¶…æ—¶æ§åˆ¶</td></tr><tr><td><strong>æœåŠ¡ç›‘å¬</strong></td><td><code>Listen(network, address)</code></td><td>ç›‘å¬æŒ‡å®šç«¯å£</td><td>æœåŠ¡ç«¯å¯åŠ¨</td></tr><tr><td></td><td><code>Listener.Accept()</code></td><td>æ¥æ”¶æ–°è¿æ¥</td><td>å¤„ç†å®¢æˆ·ç«¯æ¥å…¥</td></tr><tr><td></td><td><code>Listener.Close()</code></td><td>å…³é—­ç›‘å¬å™¨</td><td>ä¼˜é›…åœæœº</td></tr><tr><td><strong>æ•°æ®ä¼ è¾“</strong></td><td><code>Conn.Read(b []byte)</code></td><td>ä»è¿æ¥è¯»å–æ•°æ®</td><td>æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯</td></tr><tr><td></td><td><code>Conn.Write(b []byte)</code></td><td>å‘è¿æ¥å†™å…¥æ•°æ®</td><td>å“åº”å®¢æˆ·ç«¯</td></tr><tr><td></td><td><code>Conn.SetDeadline(t time.Time)</code></td><td>è®¾ç½®è¯»å†™æˆªæ­¢æ—¶é—´</td><td>é˜²æ­¢è¿æ¥æŒ‚èµ·</td></tr><tr><td><strong>åœ°å€è§£æ</strong></td><td><code>ResolveTCPAddr(network, address)</code></td><td>è§£æTCPåœ°å€</td><td>é¢„å¤„ç†è¿æ¥ç›®æ ‡</td></tr><tr><td></td><td><code>LookupHost(host)</code></td><td>DNSä¸»æœºåæŸ¥è¯¢</td><td>æœåŠ¡å‘ç°</td></tr><tr><td><strong>åè®®ç‰¹å®š</strong></td><td><code>TCPConn.SetKeepAlive(enable bool)</code></td><td>å¯ç”¨TCPä¿æ´»</td><td>é•¿è¿æ¥ç»´æŠ¤</td></tr><tr><td></td><td><code>UDPConn.ReadFromUDP(b []byte)</code></td><td>è¯»å–UDPæ•°æ®æŠ¥+æºåœ°å€</td><td>æ— è¿æ¥é€šä¿¡</td></tr></tbody></table><h2 id="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ"><a href="#äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ" class="headerlink" title="äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ"></a>äºŒã€æŠ€æœ¯åŸç†æ·±åº¦è§£æ</h2><h3 id="2-1-Connæ¥å£ï¼šç½‘ç»œI-x2F-Oçš„ç»Ÿä¸€æŠ½è±¡"><a href="#2-1-Connæ¥å£ï¼šç½‘ç»œI-x2F-Oçš„ç»Ÿä¸€æŠ½è±¡" class="headerlink" title="2.1 Connæ¥å£ï¼šç½‘ç»œI&#x2F;Oçš„ç»Ÿä¸€æŠ½è±¡"></a>2.1 Connæ¥å£ï¼šç½‘ç»œI&#x2F;Oçš„ç»Ÿä¸€æŠ½è±¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Conn <span class="keyword">interface</span> &#123;</span><br><span class="line">    Read(b []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)      <span class="comment">// å®ç°io.Reader</span></span><br><span class="line">    Write(b []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)     <span class="comment">// å®ç°io.Writer</span></span><br><span class="line">    Close() <span class="type">error</span>                          <span class="comment">// å®ç°io.Closer</span></span><br><span class="line">    LocalAddr() Addr                       <span class="comment">// è·å–æœ¬åœ°åœ°å€</span></span><br><span class="line">    RemoteAddr() Addr                      <span class="comment">// è·å–è¿œç¨‹åœ°å€</span></span><br><span class="line">    SetDeadline(t time.Time) <span class="type">error</span>         <span class="comment">// è®¾ç½®è¯»å†™æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    SetReadDeadline(t time.Time) <span class="type">error</span>     <span class="comment">// å•ç‹¬è®¾ç½®è¯»æˆªæ­¢</span></span><br><span class="line">    SetWriteDeadline(t time.Time) <span class="type">error</span>    <span class="comment">// å•ç‹¬è®¾ç½®å†™æˆªæ­¢</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è®¾è®¡ç²¾é«“</strong>ï¼š</p><ul><li>é€šè¿‡<code>io.Reader/Writer/Closer</code>ç»„åˆï¼Œä½¿ç½‘ç»œè¿æ¥å¯åƒæ–‡ä»¶ä¸€æ ·æ“ä½œ</li><li><code>SetDeadline</code>æœºåˆ¶åŸºäºGoè¿è¡Œæ—¶è°ƒåº¦å™¨å®ç°ï¼Œ<strong>éç³»ç»Ÿçº§SO_RCVTIMEO</strong>ï¼Œé¿å…è·¨å¹³å°å·®å¼‚</li><li>æ‰€æœ‰å…·ä½“è¿æ¥ç±»å‹ï¼ˆTCPConn&#x2F;UDPConnç­‰ï¼‰å‡å†…åµŒ<code>conn</code>ç»“æ„ä½“ï¼Œå¤ç”¨åº•å±‚fdæ“ä½œ</li></ul><h3 id="2-2-Dialä¸Listençš„åº•å±‚è°ƒç”¨é“¾"><a href="#2-2-Dialä¸Listençš„åº•å±‚è°ƒç”¨é“¾" class="headerlink" title="2.2 Dialä¸Listençš„åº•å±‚è°ƒç”¨é“¾"></a>2.2 Dialä¸Listençš„åº•å±‚è°ƒç”¨é“¾</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dialè°ƒç”¨é“¾ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line">Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;example.com:80&quot;</span>)</span><br><span class="line">  â””â”€&gt; DialContext(context.Background(), <span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;example.com:80&quot;</span>)</span><br><span class="line">        â””â”€&gt; internetAddrList(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;example.com:80&quot;</span>)  <span class="comment">// DNSè§£æ</span></span><br><span class="line">              â””â”€&gt; resolveInternetAddr(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;example.com:80&quot;</span>, ...)</span><br><span class="line">                    â””â”€&gt; system lookup (getaddrinfo on POSIX)</span><br><span class="line">        â””â”€&gt; dialSingle(...)  <span class="comment">// å°è¯•æ¯ä¸ªè§£æç»“æœ</span></span><br><span class="line">              â””â”€&gt; sysDialTCP(...)  <span class="comment">// ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line">                    â””â”€&gt; socket() + connect()  <span class="comment">// POSIXç³»ç»Ÿè°ƒç”¨</span></span><br></pre></td></tr></table></figure><p><strong>å…³é”®ç‰¹æ€§</strong>ï¼š</p><ul><li><strong>Happy Eyeballsç®—æ³•</strong>ï¼šIPv4&#x2F;IPv6åŒæ ˆç¯å¢ƒä¸‹ï¼ŒåŒæ—¶å‘èµ·è¿æ¥å°è¯•ï¼Œä¼˜å…ˆä½¿ç”¨å…ˆæˆåŠŸçš„è¿æ¥</li><li><strong>è¿æ¥å¤ç”¨</strong>ï¼š<code>Dialer</code>æ”¯æŒ<code>DualStack</code>å’Œ<code>FallbackDelay</code>æ§åˆ¶åŒæ ˆè¡Œä¸º</li><li><strong>Contexté›†æˆ</strong>ï¼š<code>DialContext</code>å…è®¸é€šè¿‡contextå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„DNSè§£ææˆ–è¿æ¥å°è¯•</li></ul><h3 id="2-3-Deadlineæœºåˆ¶çš„å®ç°åŸç†"><a href="#2-3-Deadlineæœºåˆ¶çš„å®ç°åŸç†" class="headerlink" title="2.3 Deadlineæœºåˆ¶çš„å®ç°åŸç†"></a>2.3 Deadlineæœºåˆ¶çš„å®ç°åŸç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// net/fd_posix.go æ ¸å¿ƒé€»è¾‘ï¼ˆç®€åŒ–ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fd *FD)</span></span> SetDeadline(t time.Time) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> setDeadlineImpl(fd, t, <span class="string">&#x27;r&#x27;</span>+<span class="string">&#x27;w&#x27;</span>) <span class="comment">// åŒæ—¶è®¾ç½®è¯»å†™</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åº•å±‚é€šè¿‡runtime_pollSetDeadlineå®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setDeadlineImpl</span><span class="params">(fd *FD, t time.Time, mode <span class="type">int</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> t.IsZero() &#123;</span><br><span class="line">        <span class="comment">// æ¸…é™¤deadlineï¼šruntime_pollUnsetDeadline</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®deadlineï¼šruntime_pollSetDeadline</span></span><br><span class="line">        <span class="comment">// å®é™…æ˜¯å‘netpolleræ³¨å†Œä¸€ä¸ªå®šæ—¶å™¨</span></span><br><span class="line">        <span class="comment">// å½“è¶…æ—¶æ—¶ï¼Œnetpollerä¼šæ ‡è®°fdä¸ºå¯è¯»/å¯å†™ï¼ˆä¼ªäº‹ä»¶ï¼‰</span></span><br><span class="line">        <span class="comment">// ä»è€Œå”¤é†’é˜»å¡åœ¨Read/Writeçš„goroutine</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é‡è¦ç‰¹æ€§</strong>ï¼š</p><ul><li><strong>éæŠ¢å å¼</strong>ï¼šDeadlineä»…å½±å“ä¸‹ä¸€æ¬¡Read&#x2F;Writeè°ƒç”¨ï¼Œä¸ä¼šä¸­æ–­æ­£åœ¨è¿›è¡Œçš„æ“ä½œ</li><li><strong>ç²¾åº¦é™åˆ¶</strong>ï¼šå—ç³»ç»Ÿæ—¶é’Ÿç²¾åº¦å½±å“ï¼Œé€šå¸¸ä¸º10-100ms</li><li><strong>è·¨å¹³å°ä¸€è‡´</strong>ï¼šé¿å…ç›´æ¥ä½¿ç”¨SO_RCVTIMEO&#x2F;SO_SNDTIMEOï¼Œä¿è¯è¡Œä¸ºä¸€è‡´æ€§</li></ul><h2 id="ä¸‰ã€å®æˆ˜æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ"><a href="#ä¸‰ã€å®æˆ˜æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ" class="headerlink" title="ä¸‰ã€å®æˆ˜æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ"></a>ä¸‰ã€å®æˆ˜æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ</h2><h3 id="3-1-å¿…é¡»è§„é¿çš„5å¤§é™·é˜±"><a href="#3-1-å¿…é¡»è§„é¿çš„5å¤§é™·é˜±" class="headerlink" title="3.1 å¿…é¡»è§„é¿çš„5å¤§é™·é˜±"></a>3.1 å¿…é¡»è§„é¿çš„5å¤§é™·é˜±</h3><table><thead><tr><th>é™·é˜±</th><th>é—®é¢˜æè¿°</th><th>æ­£ç¡®åšæ³•</th></tr></thead><tbody><tr><td><strong>è¿æ¥æ³„æ¼</strong></td><td>å¿˜è®°è°ƒç”¨<code>conn.Close()</code>å¯¼è‡´fdè€—å°½</td><td>ä½¿ç”¨<code>defer conn.Close()</code>ï¼Œé…åˆè¿æ¥æ± ç®¡ç†</td></tr><tr><td><strong>Deadlineè¯¯ç”¨</strong></td><td>è®¾ç½®ç»å¯¹æ—¶é—´è€Œéç›¸å¯¹æ—¶é—´</td><td><code>conn.SetDeadline(time.Now().Add(30*time.Second))</code></td></tr><tr><td><strong>é˜»å¡Accept</strong></td><td>æœªå¤„ç†Acceptè¿”å›çš„errorå¯¼è‡´æœåŠ¡åƒµæ­»</td><td>æ£€æŸ¥<code>if err != nil &#123; log.Fatal(err) &#125;</code></td></tr><tr><td><strong>DNSç¼“å­˜ç¼ºå¤±</strong></td><td>é¢‘ç¹Dialå¯¼è‡´DNSæŸ¥è¯¢é£æš´</td><td>ä½¿ç”¨<code>Dialer</code>çš„<code>Resolver</code>è‡ªå®šä¹‰ç¼“å­˜ç­–ç•¥</td></tr><tr><td><strong>IPv6å…¼å®¹æ€§</strong></td><td>ç¡¬ç¼–ç â€127.0.0.1â€å¯¼è‡´å®¹å™¨ç¯å¢ƒå¤±è´¥</td><td>ä½¿ç”¨<code>&quot;:8080&quot;</code>ç›‘å¬æ‰€æœ‰æ¥å£ï¼Œ<code>&quot;localhost&quot;</code>è§£æ</td></tr></tbody></table><h3 id="3-2-é«˜æ€§èƒ½è¿æ¥ç®¡ç†æŠ€å·§"><a href="#3-2-é«˜æ€§èƒ½è¿æ¥ç®¡ç†æŠ€å·§" class="headerlink" title="3.2 é«˜æ€§èƒ½è¿æ¥ç®¡ç†æŠ€å·§"></a>3.2 é«˜æ€§èƒ½è¿æ¥ç®¡ç†æŠ€å·§</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŠ€å·§1ï¼šTCPè¿æ¥ä¿æ´»ï¼ˆé˜²æ­¢NATè¶…æ—¶æ–­å¼€ï¼‰</span></span><br><span class="line">tcpConn, ok := conn.(*net.TCPConn)</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">    tcpConn.SetKeepAlive(<span class="literal">true</span>)</span><br><span class="line">    tcpConn.SetKeepAlivePeriod(<span class="number">60</span> * time.Second) <span class="comment">// æ¯60ç§’æ¢æµ‹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ€å·§2ï¼šé›¶æ‹·è´è¯»å–ï¼ˆé¿å…é¢å¤–å†…å­˜åˆ†é…ï¼‰</span></span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4096</span>)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    n, err := conn.Read(buf)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç›´æ¥å¤„ç†buf[:n]ï¼Œé¿å…copy</span></span><br><span class="line">    process(buf[:n])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ€å·§3ï¼šè¿æ¥æ± å¤ç”¨ï¼ˆå®¢æˆ·ç«¯åœºæ™¯ï¼‰</span></span><br><span class="line"><span class="keyword">type</span> ConnPool <span class="keyword">struct</span> &#123;</span><br><span class="line">    conns <span class="keyword">chan</span> net.Conn</span><br><span class="line">    dialer *net.Dialer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *ConnPool)</span></span> Get() (net.Conn, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> conn := &lt;-p.conns:</span><br><span class="line">        <span class="keyword">return</span> conn, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> p.dialer.Dial(<span class="string">&quot;tcp&quot;</span>, p.addr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-è¶…æ—¶æ§åˆ¶çš„é»„é‡‘æ³•åˆ™"><a href="#3-3-è¶…æ—¶æ§åˆ¶çš„é»„é‡‘æ³•åˆ™" class="headerlink" title="3.3 è¶…æ—¶æ§åˆ¶çš„é»„é‡‘æ³•åˆ™"></a>3.3 è¶…æ—¶æ§åˆ¶çš„é»„é‡‘æ³•åˆ™</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… æ­£ç¡®ï¼šåˆ†å±‚è¶…æ—¶æ§åˆ¶</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">dialer := &amp;net.Dialer&#123;</span><br><span class="line">    Timeout:   <span class="number">3</span> * time.Second,      <span class="comment">// è¿æ¥è¶…æ—¶</span></span><br><span class="line">    KeepAlive: <span class="number">30</span> * time.Second,     <span class="comment">// ä¿æ´»é—´éš”</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">conn, err := dialer.DialContext(ctx, <span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;example.com:80&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// å¤„ç†è¶…æ—¶ï¼šcontext deadline exceeded</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸ºåç»­æ“ä½œå•ç‹¬è®¾ç½®deadline</span></span><br><span class="line">conn.SetReadDeadline(time.Now().Add(<span class="number">2</span> * time.Second))</span><br><span class="line">conn.SetWriteDeadline(time.Now().Add(<span class="number">2</span> * time.Second))</span><br></pre></td></tr></table></figure><h2 id="å››ã€å…¸å‹åº”ç”¨åœºæ™¯å®æˆ˜"><a href="#å››ã€å…¸å‹åº”ç”¨åœºæ™¯å®æˆ˜" class="headerlink" title="å››ã€å…¸å‹åº”ç”¨åœºæ™¯å®æˆ˜"></a>å››ã€å…¸å‹åº”ç”¨åœºæ™¯å®æˆ˜</h2><h3 id="4-1-é«˜å¹¶å‘TCPæœåŠ¡å™¨ï¼ˆå¸¦ä¼˜é›…åœæœºï¼‰"><a href="#4-1-é«˜å¹¶å‘TCPæœåŠ¡å™¨ï¼ˆå¸¦ä¼˜é›…åœæœºï¼‰" class="headerlink" title="4.1 é«˜å¹¶å‘TCPæœåŠ¡å™¨ï¼ˆå¸¦ä¼˜é›…åœæœºï¼‰"></a>4.1 é«˜å¹¶å‘TCPæœåŠ¡å™¨ï¼ˆå¸¦ä¼˜é›…åœæœºï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TCPServer <span class="keyword">struct</span> &#123;</span><br><span class="line">    listener net.Listener</span><br><span class="line">    wg       sync.WaitGroup</span><br><span class="line">    quit     <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTCPServer</span><span class="params">(addr <span class="type">string</span>)</span></span> (*TCPServer, <span class="type">error</span>) &#123;</span><br><span class="line">    ln, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, addr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;TCPServer&#123;</span><br><span class="line">        listener: ln,</span><br><span class="line">        quit:     <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *TCPServer)</span></span> Start() &#123;</span><br><span class="line">    log.Printf(<span class="string">&quot;Server listening on %s&quot;</span>, s.listener.Addr())</span><br><span class="line">    s.wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> s.wg.Done()</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> &lt;-s.quit:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                conn, err := s.listener.Accept()</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">select</span> &#123;</span><br><span class="line">                    <span class="keyword">case</span> &lt;-s.quit:</span><br><span class="line">                        <span class="keyword">return</span> <span class="comment">// æ­£å¸¸å…³é—­</span></span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        log.Printf(<span class="string">&quot;Accept error: %v&quot;</span>, err)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                s.wg.Add(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">go</span> s.handleConnection(conn)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *TCPServer)</span></span> handleConnection(conn net.Conn) &#123;</span><br><span class="line">    <span class="keyword">defer</span> s.wg.Done()</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®åˆç†çš„è¶…æ—¶</span></span><br><span class="line">    conn.SetReadDeadline(time.Now().Add(<span class="number">60</span> * time.Second))</span><br><span class="line">    conn.SetWriteDeadline(time.Now().Add(<span class="number">60</span> * time.Second))</span><br><span class="line">    </span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4096</span>)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        n, err := conn.Read(buf)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;Read error from %s: %v&quot;</span>, conn.RemoteAddr(), err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å›æ˜¾æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> _, err := conn.Write(buf[:n]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">&quot;Write error to %s: %v&quot;</span>, conn.RemoteAddr(), err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *TCPServer)</span></span> Shutdown(ctx context.Context) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="built_in">close</span>(s.quit) <span class="comment">// é€šçŸ¥acceptå¾ªç¯é€€å‡º</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ˆå…³é—­listenerï¼Œé˜»æ­¢æ–°è¿æ¥</span></span><br><span class="line">    <span class="keyword">if</span> err := s.listener.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç­‰å¾…ç°æœ‰è¿æ¥å¤„ç†å®Œæˆ</span></span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        s.wg.Wait()</span><br><span class="line">        <span class="built_in">close</span>(done)</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-done:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">        <span class="keyword">return</span> ctx.Err()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    server, err := NewTCPServer(<span class="string">&quot;:9000&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    server.Start()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿè¿è¡Œ30ç§’åä¼˜é›…åœæœº</span></span><br><span class="line">    time.Sleep(<span class="number">30</span> * time.Second)</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> err := server.Shutdown(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;Shutdown error: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    log.Println(<span class="string">&quot;Server stopped gracefully&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-å¸¦DNSç¼“å­˜çš„é«˜æ€§èƒ½å®¢æˆ·ç«¯"><a href="#4-2-å¸¦DNSç¼“å­˜çš„é«˜æ€§èƒ½å®¢æˆ·ç«¯" class="headerlink" title="4.2 å¸¦DNSç¼“å­˜çš„é«˜æ€§èƒ½å®¢æˆ·ç«¯"></a>4.2 å¸¦DNSç¼“å­˜çš„é«˜æ€§èƒ½å®¢æˆ·ç«¯</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// DNSç¼“å­˜å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="keyword">type</span> CachedResolver <span class="keyword">struct</span> &#123;</span><br><span class="line">    cache  <span class="keyword">map</span>[<span class="type">string</span>][]net.IP</span><br><span class="line">    mu     sync.RWMutex</span><br><span class="line">    ttl    time.Duration</span><br><span class="line">    expiry <span class="keyword">map</span>[<span class="type">string</span>]time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCachedResolver</span><span class="params">(ttl time.Duration)</span></span> *CachedResolver &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;CachedResolver&#123;</span><br><span class="line">        cache:  <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]net.IP),</span><br><span class="line">        expiry: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]time.Time),</span><br><span class="line">        ttl:    ttl,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *CachedResolver)</span></span> LookupIPAddr(ctx context.Context, host <span class="type">string</span>) ([]net.IPAddr, <span class="type">error</span>) &#123;</span><br><span class="line">    r.mu.RLock()</span><br><span class="line">    <span class="keyword">if</span> ips, ok := r.cache[host]; ok &amp;&amp; time.Now().Before(r.expiry[host]) &#123;</span><br><span class="line">        r.mu.RUnlock()</span><br><span class="line">        addrs := <span class="built_in">make</span>([]net.IPAddr, <span class="built_in">len</span>(ips))</span><br><span class="line">        <span class="keyword">for</span> i, ip := <span class="keyword">range</span> ips &#123;</span><br><span class="line">            addrs[i] = net.IPAddr&#123;IP: ip&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> addrs, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    r.mu.RUnlock()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœªå‘½ä¸­ç¼“å­˜ï¼Œæ‰§è¡ŒçœŸå®æŸ¥è¯¢</span></span><br><span class="line">    systemResolver := &amp;net.Resolver&#123;&#125;</span><br><span class="line">    addrs, err := systemResolver.LookupIPAddr(ctx, host)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†™å…¥ç¼“å­˜</span></span><br><span class="line">    r.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> r.mu.Unlock()</span><br><span class="line">    </span><br><span class="line">    ips := <span class="built_in">make</span>([]net.IP, <span class="built_in">len</span>(addrs))</span><br><span class="line">    <span class="keyword">for</span> i, addr := <span class="keyword">range</span> addrs &#123;</span><br><span class="line">        ips[i] = addr.IP</span><br><span class="line">    &#125;</span><br><span class="line">    r.cache[host] = ips</span><br><span class="line">    r.expiry[host] = time.Now().Add(r.ttl)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> addrs, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    resolver := NewCachedResolver(<span class="number">5</span> * time.Minute)</span><br><span class="line">    dialer := &amp;net.Dialer&#123;</span><br><span class="line">        Resolver: resolver,</span><br><span class="line">        Timeout:  <span class="number">3</span> * time.Second,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é¦–æ¬¡æŸ¥è¯¢ï¼ˆçœŸå®DNSï¼‰</span></span><br><span class="line">    conn1, err := dialer.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;example.com:80&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;First connection to %s\n&quot;</span>, conn1.RemoteAddr())</span><br><span class="line">    conn1.Close()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ˆå‘½ä¸­ç¼“å­˜ï¼Œæ¯«ç§’çº§å“åº”ï¼‰</span></span><br><span class="line">    time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">    conn2, err := dialer.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;example.com:80&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Second connection to %s (cached)\n&quot;</span>, conn2.RemoteAddr())</span><br><span class="line">    conn2.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-UDPå¹¿æ’­ä¸ç»„æ’­å®æˆ˜"><a href="#4-3-UDPå¹¿æ’­ä¸ç»„æ’­å®æˆ˜" class="headerlink" title="4.3 UDPå¹¿æ’­ä¸ç»„æ’­å®æˆ˜"></a>4.3 UDPå¹¿æ’­ä¸ç»„æ’­å®æˆ˜</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// UDPå¹¿æ’­ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">broadcastExample</span><span class="params">()</span></span> &#123;</span><br><span class="line">    addr, _ := net.ResolveUDPAddr(<span class="string">&quot;udp&quot;</span>, <span class="string">&quot;255.255.255.255:9999&quot;</span>)</span><br><span class="line">    conn, _ := net.DialUDP(<span class="string">&quot;udp&quot;</span>, <span class="literal">nil</span>, addr)</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿…é¡»è®¾ç½®å¹¿æ’­æƒé™</span></span><br><span class="line">    conn.SetBroadcast(<span class="literal">true</span>)</span><br><span class="line">    </span><br><span class="line">    conn.Write([]<span class="type">byte</span>(<span class="string">&quot;Hello broadcast!&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UDPç»„æ’­ç¤ºä¾‹ï¼ˆæ¥æ”¶ç«¯ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">multicastReceiver</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// åŠ å…¥ç»„æ’­ç»„ 239.0.0.1</span></span><br><span class="line">    addr, _ := net.ResolveUDPAddr(<span class="string">&quot;udp&quot;</span>, <span class="string">&quot;239.0.0.1:12345&quot;</span>)</span><br><span class="line">    conn, _ := net.ListenMulticastUDP(<span class="string">&quot;udp&quot;</span>, <span class="literal">nil</span>, addr)</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®è¯»å–è¶…æ—¶</span></span><br><span class="line">    conn.SetReadDeadline(time.Now().Add(<span class="number">10</span> * time.Second))</span><br><span class="line">    </span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span>)</span><br><span class="line">    n, src, err := conn.ReadFromUDP(buf)</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;Received %d bytes from %s: %s\n&quot;</span>, n, src, <span class="type">string</span>(buf[:n]))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”ã€è¿›é˜¶ï¼šnetåº“ä¸è¿è¡Œæ—¶ååŒå·¥ä½œ"><a href="#äº”ã€è¿›é˜¶ï¼šnetåº“ä¸è¿è¡Œæ—¶ååŒå·¥ä½œ" class="headerlink" title="äº”ã€è¿›é˜¶ï¼šnetåº“ä¸è¿è¡Œæ—¶ååŒå·¥ä½œ"></a>äº”ã€è¿›é˜¶ï¼šnetåº“ä¸è¿è¡Œæ—¶ååŒå·¥ä½œ</h2><h3 id="5-1-netpolleræœºåˆ¶"><a href="#5-1-netpolleræœºåˆ¶" class="headerlink" title="5.1 netpolleræœºåˆ¶"></a>5.1 netpolleræœºåˆ¶</h3><p>Goçš„ç½‘ç»œI&#x2F;Oä¸ç›´æ¥é˜»å¡OSçº¿ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡<strong>netpoller</strong>ï¼ˆåŸºäºepoll&#x2F;kqueue&#x2F;iocpï¼‰å°†fdæ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Goroutine A: conn.Read(buf)</span><br><span class="line">  â””â”€&gt; syscall.Read(fd) è¿”å›EAGAINï¼ˆæ— æ•°æ®ï¼‰</span><br><span class="line">        â””â”€&gt; runtime.netpollblock(fd, &#x27;r&#x27;) </span><br><span class="line">              â””â”€&gt; å°†GoroutineæŒ‚èµ·ï¼Œæ³¨å†Œåˆ°netpoller</span><br><span class="line">                    â””â”€&gt; OSçº¿ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–Goroutine</span><br><span class="line"></span><br><span class="line">[æ•°æ®åˆ°è¾¾ç½‘å¡]</span><br><span class="line">  â””â”€&gt; ä¸­æ–­è§¦å‘</span><br><span class="line">        â””â”€&gt; netpolleræ£€æµ‹åˆ°fdå¯è¯»</span><br><span class="line">              â””â”€&gt; å”¤é†’Goroutine A</span><br><span class="line">                    â””â”€&gt; syscall.Read(fd) æˆåŠŸè¿”å›æ•°æ®</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>å•çº¿ç¨‹å¯ç®¡ç†æ•°ä¸‡è¿æ¥ï¼ˆC10Ké—®é¢˜ï¼‰</li><li>é¿å…æ¯ä¸ªè¿æ¥å ç”¨OSçº¿ç¨‹ï¼ˆå¯¹æ¯”Java NIOçš„çº¿ç¨‹æ¨¡å‹ï¼‰</li><li>ä¸Goè°ƒåº¦å™¨æ·±åº¦é›†æˆï¼Œå®ç°â€ç”¨æˆ·æ€é˜»å¡â€</li></ul><h3 id="5-2-æ–‡ä»¶æè¿°ç¬¦æ³„æ¼æ£€æµ‹"><a href="#5-2-æ–‡ä»¶æè¿°ç¬¦æ³„æ¼æ£€æµ‹" class="headerlink" title="5.2 æ–‡ä»¶æè¿°ç¬¦æ³„æ¼æ£€æµ‹"></a>5.2 æ–‡ä»¶æè¿°ç¬¦æ³„æ¼æ£€æµ‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ç”¨netåŒ…çš„è°ƒè¯•æ¨¡å¼ï¼ˆGo 1.21+ï¼‰</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ç¨‹åºä¸­å®šæœŸæ£€æŸ¥</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;runtime/debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkFDLeak</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> m runtime.MemStats</span><br><span class="line">    runtime.ReadMemStats(&amp;m)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;goroutines: %d, heap: %d MB\n&quot;</span>, </span><br><span class="line">        runtime.NumGoroutine(), m.HeapAlloc/<span class="number">1024</span>/<span class="number">1024</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€šè¿‡pprofåˆ†æè¿æ¥æ³„æ¼</span></span><br><span class="line">    <span class="comment">// go tool pprof http://localhost:6060/debug/pprof/goroutine</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…­ã€æ€»ç»“ï¼šæŒæ¡netåº“çš„æ ¸å¿ƒå¿ƒæ³•"><a href="#å…­ã€æ€»ç»“ï¼šæŒæ¡netåº“çš„æ ¸å¿ƒå¿ƒæ³•" class="headerlink" title="å…­ã€æ€»ç»“ï¼šæŒæ¡netåº“çš„æ ¸å¿ƒå¿ƒæ³•"></a>å…­ã€æ€»ç»“ï¼šæŒæ¡netåº“çš„æ ¸å¿ƒå¿ƒæ³•</h2><ol><li><strong>æ¥å£ä¼˜å…ˆ</strong>ï¼šå§‹ç»ˆé¢å‘<code>Conn</code>&#x2F;<code>Listener</code>ç¼–ç¨‹ï¼Œè€Œéå…·ä½“TCPConn</li><li><strong>è¶…æ—¶å¿…è®¾</strong>ï¼šä»»ä½•ç½‘ç»œæ“ä½œå¿…é¡»è®¾ç½®Deadlineï¼Œé¿å…goroutineæ³„æ¼</li><li><strong>é”™è¯¯å¤„ç†</strong>ï¼šåŒºåˆ†ä¸´æ—¶é”™è¯¯ï¼ˆTemporary()ï¼‰ä¸æ°¸ä¹…é”™è¯¯ï¼Œå®ç°é‡è¯•é€»è¾‘</li><li><strong>èµ„æºç®¡ç†</strong>ï¼šè¿æ¥å¿…é¡»æ˜¾å¼Closeï¼Œæ¨èdefer+è¿æ¥æ± ç»„åˆ</li><li><strong>åè®®é€‰æ‹©</strong>ï¼š<ul><li>TCPï¼šå¯é æµå¼ä¼ è¾“ï¼ˆHTTP&#x2F;Redis&#x2F;MySQLï¼‰</li><li>UDPï¼šä½å»¶è¿Ÿåœºæ™¯ï¼ˆDNS&#x2F;è§†é¢‘æµ&#x2F;æ¸¸æˆï¼‰</li><li>Unix Socketï¼šåŒä¸€ä¸»æœºé«˜æ€§èƒ½é€šä¿¡ï¼ˆDocker&#x2F;æœ¬åœ°æœåŠ¡ï¼‰</li></ul></li></ol><p><strong>å®è·µå»ºè®®</strong>ï¼š<br>netåŒ…æ˜¯Goå¹¶å‘ç½‘ç»œèƒ½åŠ›çš„åŸºçŸ³ï¼Œä½†<strong>ä¸è¦é‡å¤é€ è½®å­</strong>ï¼›<br>å¯¹äºHTTPåœºæ™¯ä¼˜å…ˆä½¿ç”¨<code>net/http</code>ï¼ŒgRPCåœºæ™¯ç”¨<code>google.golang.org/grpc</code>ï¼›<br>ä»…åœ¨éœ€è¦ç²¾ç»†æ§åˆ¶åè®®ç»†èŠ‚æ—¶ç›´æ¥ä½¿ç”¨netåŒ…ã€‚</p><p>é’ˆå¯¹netåº“æœ€å¸¸ç”¨çš„httpå‚è€ƒï¼š<br><a href="/aa27659e.html">net&#x2F;http</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;æ·±å…¥Goæ ‡å‡†åº“netåŒ…ï¼šæ„å»ºé«˜æ€§èƒ½ç½‘ç»œåº”ç”¨çš„åŸºçŸ³&quot;&gt;&lt;a href=&quot;#æ·±å…¥Goæ ‡å‡†åº“netåŒ…ï¼šæ„å»ºé«˜æ€§èƒ½ç½‘ç»œåº”ç”¨çš„åŸºçŸ³&quot; class=&quot;headerlink&quot; title=&quot;æ·±å…¥Goæ ‡å‡†åº“netåŒ…ï¼šæ„å»ºé«˜æ€§èƒ½ç½‘ç»œåº”ç”¨çš„åŸºçŸ³&quot;&gt;&lt;/a&gt;æ·±å…¥Goæ ‡å‡†åº“netåŒ…ï¼šæ„å»ºé«˜æ€§èƒ½ç½‘ç»œåº”ç”¨çš„åŸºçŸ³&lt;/h1&gt;&lt;p&gt;åŸºäºGo 1.22+æ ‡å‡†åº“ï¼ˆæˆªè‡³2026å¹´1æœˆï¼‰ï¼Œæä¾›å®Œå…¨åŸåˆ›çš„æŠ€æœ¯è§£æï¼Œæ¶µç›–æ¶æ„è®¾è®¡ã€åº•å±‚åŸç†ã€å®æˆ˜æŠ€å·§ä¸é¿å‘æŒ‡å—ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-net" scheme="https://www.wdft.com/tags/Go-net/"/>
    
  </entry>
  
  <entry>
    <title>ã€testingã€‘æ·±å…¥è§£æ„Goæ ‡å‡†åº“Goæ ‡å‡†åº“testingåŒ…çš„è®¾è®¡åŸç†ä»¥åŠå®è·µå¼€å‘ä¸­æ³¨æ„çš„è¦ç‚¹</title>
    <link href="https://www.wdft.com/d716b46d.html"/>
    <id>https://www.wdft.com/d716b46d.html</id>
    <published>2026-01-22T17:27:15.000Z</published>
    <updated>2026-02-05T06:59:27.635Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨Goè¯­è¨€ç”Ÿæ€ä¸­ï¼Œ<code>testing</code>åŒ…æ˜¯è‡ªåŠ¨åŒ–æµ‹è¯•çš„åŸºçŸ³ï¼Œä¸<code>go test</code>å‘½ä»¤ååŒå·¥ä½œï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€å¥—ç®€æ´è€Œå¼ºå¤§çš„æµ‹è¯•æ¡†æ¶ã€‚æœ¬æ–‡å°†ç³»ç»Ÿæ€§è§£ætestingåŒ…çš„æ¶æ„è®¾è®¡ã€æ ¸å¿ƒåŸç†ä¸å®æˆ˜æŠ€å·§ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€ŸæŒæ¡ä¸“ä¸šçº§æµ‹è¯•èƒ½åŠ›ã€‚<br>æŒæ¡testingåŒ…ä¸ä»…æ˜¯ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œæ›´æ˜¯ç†è§£Goå¹¶å‘æ¨¡å‹ã€èµ„æºç®¡ç†ä¸å·¥ç¨‹åŒ–æ€ç»´çš„è¿‡ç¨‹ã€‚é€šè¿‡åˆç†è¿ç”¨å­æµ‹è¯•ã€å¹¶è¡Œæ‰§è¡Œã€åŸºå‡†åˆ†æç­‰ç‰¹æ€§ï¼Œå¼€å‘è€…èƒ½å¤Ÿæ„å»ºæ—¢é«˜æ•ˆåˆå¯é çš„æµ‹è¯•ä½“ç³»ï¼Œä¸ºè½¯ä»¶è´¨é‡æä¾›åšå®ä¿éšœï¼Œä¿éšœåº”ç”¨çš„é«˜è´¨é‡äº¤ä»˜ã€‚</p><span id="more"></span><h3 id="ä¸€ã€testingåŒ…å…¨æ™¯æ¶æ„"><a href="#ä¸€ã€testingåŒ…å…¨æ™¯æ¶æ„" class="headerlink" title="ä¸€ã€testingåŒ…å…¨æ™¯æ¶æ„"></a>ä¸€ã€testingåŒ…å…¨æ™¯æ¶æ„</h3><p>testingåŒ…é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œé€šè¿‡ç±»å‹æŠ½è±¡å®ç°å•å…ƒæµ‹è¯•ã€åŸºå‡†æµ‹è¯•ã€æ¨¡ç³Šæµ‹è¯•çš„ç»Ÿä¸€ç®¡ç†ã€‚ä¸‹å›¾å±•ç¤ºäº†testingåŒ…çš„æ ¸å¿ƒç±»å‹åŠå…¶å…³é”®æ–¹æ³•ï¼š</p><pre class="mermaid">flowchart LR    A["testing åŒ…æ ¸å¿ƒæ¶æ„"] --> B["testing.TB æ¥å£<br/>ï¼ˆæµ‹è¯•å…¬å…±è¡Œä¸ºï¼‰"]    A --> C["testing.T<br/>ï¼ˆå•å…ƒæµ‹è¯•æ§åˆ¶å™¨ï¼‰"]    A --> D["testing.B<br/>ï¼ˆåŸºå‡†æµ‹è¯•æ§åˆ¶å™¨ï¼‰"]    A --> E["testing.M<br/>ï¼ˆæµ‹è¯•ä¸»å…¥å£ï¼‰"]        B --> B1["Helper: æ ‡è®°è¾…åŠ©å‡½æ•°"]    B --> B2["Name: è·å–æµ‹è¯•åç§°"]    B --> B3["Log/Logf: è®°å½•æ—¥å¿—"]    B --> B4["Error/Errorf: æ ‡è®°å¤±è´¥ä½†ç»§ç»­"]    B --> B5["Fatal/Fatalf: ç«‹å³ç»ˆæ­¢æµ‹è¯•"]    B --> B6["Skip/Skipf: è·³è¿‡æµ‹è¯•"]    B --> B7["Failed: æ£€æŸ¥æ˜¯å¦å¤±è´¥"]        C --> C1["Run: åˆ›å»ºå­æµ‹è¯•"]    C --> C2["Parallel: å¯ç”¨å¹¶è¡Œæ‰§è¡Œ"]    C --> C3["Cleanup: æ³¨å†Œæ¸…ç†å‡½æ•°"]    C --> C4["TempDir: åˆ›å»ºä¸´æ—¶ç›®å½•"]    C --> C5["Setenv: è®¾ç½®ç¯å¢ƒå˜é‡"]        D --> D1["N: è¿­ä»£æ¬¡æ•°"]    D --> D2["ReportAllocs: æŠ¥å‘Šå†…å­˜åˆ†é…"]    D --> D3["ResetTimer: é‡ç½®è®¡æ—¶å™¨"]    D --> D4["StopTimer/StartTimer: æš‚åœè®¡æ—¶"]    D --> D5["Loop: ç²¾ç¡®æ§åˆ¶è¿­ä»£ï¼ˆGo 1.24+ï¼‰"]        E --> E1["Run: æ‰§è¡Œæ‰€æœ‰æµ‹è¯•"]    E --> E2["Setenv: å…¨å±€ç¯å¢ƒå˜é‡"]    E --> E3["Args: è·å–æµ‹è¯•å‚æ•°"]</pre><h3 id="äºŒã€æ ¸å¿ƒç±»å‹æŠ€æœ¯åŸç†"><a href="#äºŒã€æ ¸å¿ƒç±»å‹æŠ€æœ¯åŸç†" class="headerlink" title="äºŒã€æ ¸å¿ƒç±»å‹æŠ€æœ¯åŸç†"></a>äºŒã€æ ¸å¿ƒç±»å‹æŠ€æœ¯åŸç†</h3><h4 id="1-testing-TB-æ¥å£ï¼šæµ‹è¯•è¡Œä¸ºçš„æŠ½è±¡åŸºçŸ³"><a href="#1-testing-TB-æ¥å£ï¼šæµ‹è¯•è¡Œä¸ºçš„æŠ½è±¡åŸºçŸ³" class="headerlink" title="1. testing.TB æ¥å£ï¼šæµ‹è¯•è¡Œä¸ºçš„æŠ½è±¡åŸºçŸ³"></a>1. testing.TB æ¥å£ï¼šæµ‹è¯•è¡Œä¸ºçš„æŠ½è±¡åŸºçŸ³</h4><p><code>testing.TB</code>æ˜¯testingåŒ…çš„è®¾è®¡ç²¾é«“ï¼Œå®ƒå®šä¹‰äº†æ‰€æœ‰æµ‹è¯•æ§åˆ¶å™¨çš„å…¬å…±è¡Œä¸ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TB <span class="keyword">interface</span> &#123;</span><br><span class="line">    Cleanup(<span class="function"><span class="keyword">func</span><span class="params">()</span></span>)</span><br><span class="line">    Error(args ...any)</span><br><span class="line">    Errorf(format <span class="type">string</span>, args ...any)</span><br><span class="line">    Fail()</span><br><span class="line">    FailNow()</span><br><span class="line">    Failed() <span class="type">bool</span></span><br><span class="line">    Fatal(args ...any)</span><br><span class="line">    Fatalf(format <span class="type">string</span>, args ...any)</span><br><span class="line">    Helper()</span><br><span class="line">    Log(args ...any)</span><br><span class="line">    Logf(format <span class="type">string</span>, args ...any)</span><br><span class="line">    Name() <span class="type">string</span></span><br><span class="line">    Skip(args ...any)</span><br><span class="line">    SkipNow()</span><br><span class="line">    Skipped() <span class="type">bool</span></span><br><span class="line">    TempDir() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è®¾è®¡å“²å­¦</strong>ï¼šé€šè¿‡æ¥å£éš”ç¦»å®ç°<code>*testing.T</code>ï¼ˆå•å…ƒæµ‹è¯•ï¼‰ä¸<code>*testing.B</code>ï¼ˆåŸºå‡†æµ‹è¯•ï¼‰çš„ä»£ç å¤ç”¨ã€‚æ‰€æœ‰æ–­è¨€åº“ï¼ˆå¦‚testifyï¼‰å‡åŸºäºTBæ¥å£å¼€å‘ï¼Œä¿è¯äº†ç”Ÿæ€å…¼å®¹æ€§ã€‚</p><h4 id="2-testing-Tï¼šå•å…ƒæµ‹è¯•çš„æ‰§è¡Œå¼•æ“"><a href="#2-testing-Tï¼šå•å…ƒæµ‹è¯•çš„æ‰§è¡Œå¼•æ“" class="headerlink" title="2. testing.Tï¼šå•å…ƒæµ‹è¯•çš„æ‰§è¡Œå¼•æ“"></a>2. testing.Tï¼šå•å…ƒæµ‹è¯•çš„æ‰§è¡Œå¼•æ“</h4><p><code>testing.T</code>å®ä¾‹ç”±æµ‹è¯•æ¡†æ¶è‡ªåŠ¨åˆ›å»ºå¹¶ä¼ å…¥<code>TestXxx</code>å‡½æ•°ï¼Œå…¶æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬ï¼š</p><ul><li><strong>å¤±è´¥ä¼ æ’­æœºåˆ¶</strong>ï¼š<code>Error</code>ä»…æ ‡è®°å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œï¼Œ<code>Fatal</code>ç«‹å³ç»ˆæ­¢å½“å‰æµ‹è¯•</li><li><strong>å­æµ‹è¯•éš”ç¦»</strong>ï¼šé€šè¿‡<code>Run</code>æ–¹æ³•åˆ›å»ºç‹¬ç«‹å‘½åç©ºé—´çš„å­æµ‹è¯•ï¼Œå®ç°æµ‹è¯•åˆ†ç»„</li><li><strong>èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼š<code>Cleanup</code>æ³¨å†Œçš„å‡½æ•°åœ¨æµ‹è¯•ç»“æŸæ—¶æŒ‰LIFOé¡ºåºæ‰§è¡Œ</li><li><strong>å¹¶è¡Œè°ƒåº¦</strong>ï¼š<code>Parallel</code>å°†æµ‹è¯•åŠ å…¥å¹¶è¡Œé˜Ÿåˆ—ï¼Œä½†éœ€æ³¨æ„çˆ¶æµ‹è¯•å¿…é¡»å…ˆå®Œæˆ</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­æµ‹è¯•ä¸å¹¶è¡Œæ‰§è¡Œç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestUserService</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="comment">// çˆ¶æµ‹è¯•è®¾ç½®å…±äº«èµ„æº</span></span><br><span class="line">    db := setupTestDB()</span><br><span class="line">    t.Cleanup(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; db.Close() &#125;) <span class="comment">// è‡ªåŠ¨æ¸…ç†</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å­æµ‹è¯•Aï¼šä¸²è¡Œæ‰§è¡Œ</span></span><br><span class="line">    t.Run(<span class="string">&quot;CreateUser&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">        <span class="comment">// æµ‹è¯•é€»è¾‘</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å­æµ‹è¯•Bï¼šå¹¶è¡Œæ‰§è¡Œï¼ˆæ³¨æ„ï¼šå¿…é¡»åœ¨Runå†…éƒ¨è°ƒç”¨Parallelï¼‰</span></span><br><span class="line">    t.Run(<span class="string">&quot;QueryUser&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">        t.Parallel() <span class="comment">// æ ‡è®°ä¸ºå¯å¹¶è¡Œ</span></span><br><span class="line">        <span class="comment">// å¹¶è¡Œæµ‹è¯•é€»è¾‘ï¼ˆéœ€ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼‰</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-testing-Bï¼šåŸºå‡†æµ‹è¯•çš„ç²¾å¯†è®¡æ—¶å™¨"><a href="#3-testing-Bï¼šåŸºå‡†æµ‹è¯•çš„ç²¾å¯†è®¡æ—¶å™¨" class="headerlink" title="3. testing.Bï¼šåŸºå‡†æµ‹è¯•çš„ç²¾å¯†è®¡æ—¶å™¨"></a>3. testing.Bï¼šåŸºå‡†æµ‹è¯•çš„ç²¾å¯†è®¡æ—¶å™¨</h4><p>åŸºå‡†æµ‹è¯•çš„æ ¸å¿ƒåœ¨äºç²¾ç¡®æµ‹é‡ä»£ç æ€§èƒ½ï¼Œ<code>testing.B</code>é€šè¿‡åŠ¨æ€è°ƒæ•´è¿­ä»£æ¬¡æ•°å®ç°ç¨³å®šé‡‡æ ·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkFibonacci</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. æ¡†æ¶è‡ªåŠ¨è°ƒæ•´b.Nï¼ˆä»1å¼€å§‹æŒ‡æ•°å¢é•¿ï¼‰</span></span><br><span class="line">    <span class="comment">// 2. æ‰§è¡Œb.Næ¬¡ç›®æ ‡æ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">        Fibonacci(<span class="number">20</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. æ¡†æ¶è®¡ç®—æ¯æ¬¡è¿­ä»£çš„å¹³å‡è€—æ—¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®æœºåˆ¶</strong>ï¼š</p><ul><li><strong>è‡ªåŠ¨æ ¡å‡†</strong>ï¼šæµ‹è¯•æ¡†æ¶è¿è¡Œå¤šæ¬¡ï¼Œé€‰æ‹©ä½¿æ€»è€—æ—¶åœ¨åˆç†èŒƒå›´ï¼ˆé€šå¸¸1ç§’å·¦å³ï¼‰çš„Nå€¼</li><li><strong>è®¡æ—¶æ§åˆ¶</strong>ï¼š<code>StartTimer</code>&#x2F;<code>StopTimer</code>æ’é™¤åˆå§‹åŒ–å¼€é”€ï¼Œ<code>ResetTimer</code>é‡ç½®ç´¯è®¡æ—¶é—´</li><li><strong>å†…å­˜åˆ†æ</strong>ï¼š<code>ReportAllocs</code>å¯ç”¨åæŠ¥å‘Šæ¯æ¬¡è¿­ä»£çš„å †åˆ†é…æ¬¡æ•°ä¸å­—èŠ‚æ•°</li><li><strong>Go 1.24+ Loop API</strong>ï¼š<code>b.Loop(func() &#123; ... &#125;)</code>æä¾›æ›´å®‰å…¨çš„è¿­ä»£æ§åˆ¶ï¼Œé¿å…æ‰‹åŠ¨å¾ªç¯çš„å¸¸è§é™·é˜±</li></ul><h4 id="4-testing-Mï¼šæµ‹è¯•ç”Ÿå‘½å‘¨æœŸçš„å…¨å±€é’©å­"><a href="#4-testing-Mï¼šæµ‹è¯•ç”Ÿå‘½å‘¨æœŸçš„å…¨å±€é’©å­" class="headerlink" title="4. testing.Mï¼šæµ‹è¯•ç”Ÿå‘½å‘¨æœŸçš„å…¨å±€é’©å­"></a>4. testing.Mï¼šæµ‹è¯•ç”Ÿå‘½å‘¨æœŸçš„å…¨å±€é’©å­</h4><p><code>TestMain</code>æä¾›åŒ…çº§åˆ«æµ‹è¯•åˆå§‹åŒ–èƒ½åŠ›ï¼Œé€‚ç”¨äºæ•°æ®åº“è¿æ¥ã€MockæœåŠ¡å¯åŠ¨ç­‰åœºæ™¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestMain</span><span class="params">(m *testing.M)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1. å…¨å±€åˆå§‹åŒ–ï¼ˆåœ¨ä»»ä½•TestXxxä¹‹å‰æ‰§è¡Œï¼‰</span></span><br><span class="line">    setupGlobalTestEnv()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ‰§è¡Œæ‰€æœ‰æµ‹è¯•</span></span><br><span class="line">    exitCode := m.Run()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. å…¨å±€æ¸…ç†ï¼ˆåœ¨æ‰€æœ‰æµ‹è¯•å®Œæˆåæ‰§è¡Œï¼‰</span></span><br><span class="line">    teardownGlobalTestEnv()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. ä¼ é€’é€€å‡ºç ç»™æ“ä½œç³»ç»Ÿ</span></span><br><span class="line">    os.Exit(exitCode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é‡è¦çº¦æŸ</strong>ï¼š</p><ul><li>æ¯ä¸ªåŒ…ä»…å…è®¸ä¸€ä¸ª<code>TestMain</code>å‡½æ•°</li><li>å¿…é¡»æ˜¾å¼è°ƒç”¨<code>m.Run()</code>è§¦å‘æµ‹è¯•æ‰§è¡Œ</li><li>é€€å‡ºç 0è¡¨ç¤ºå…¨éƒ¨æµ‹è¯•é€šè¿‡ï¼Œé0è¡¨ç¤ºå­˜åœ¨å¤±è´¥</li></ul><h3 id="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ"><a href="#ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ" class="headerlink" title="ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ"></a>ä¸‰ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ</h3><h4 id="1-å­æµ‹è¯•å¹¶è¡Œé™·é˜±"><a href="#1-å­æµ‹è¯•å¹¶è¡Œé™·é˜±" class="headerlink" title="1. å­æµ‹è¯•å¹¶è¡Œé™·é˜±"></a>1. å­æµ‹è¯•å¹¶è¡Œé™·é˜±</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯ç¤ºä¾‹ï¼šå¹¶è¡Œå­æµ‹è¯•å…±äº«çˆ¶æµ‹è¯•å˜é‡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestRace</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> count <span class="type">int</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        t.Run(fmt.Sprintf(<span class="string">&quot;sub%d&quot;</span>, i), <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">            t.Parallel()</span><br><span class="line">            count++ <span class="comment">// DATA RACE! å¤šä¸ªgoroutineåŒæ—¶å†™å…¥</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ­£ç¡®åšæ³•</strong>ï¼šå°†å…±äº«å˜é‡å¤åˆ¶åˆ°å­æµ‹è¯•é—­åŒ…å†…ï¼Œæˆ–ä½¿ç”¨sync.Mutexä¿æŠ¤</p><h4 id="2-æµ‹è¯•æ–‡ä»¶ç»„ç»‡è§„èŒƒ"><a href="#2-æµ‹è¯•æ–‡ä»¶ç»„ç»‡è§„èŒƒ" class="headerlink" title="2. æµ‹è¯•æ–‡ä»¶ç»„ç»‡è§„èŒƒ"></a>2. æµ‹è¯•æ–‡ä»¶ç»„ç»‡è§„èŒƒ</h4><ul><li>æµ‹è¯•æ–‡ä»¶å¿…é¡»ä»¥<code>_test.go</code>ç»“å°¾</li><li>å¯é€‰æ‹©ä¸¤ç§åŒ…ç»“æ„ï¼š<ul><li><strong>åŒåŒ…æµ‹è¯•</strong>ï¼š<code>package mypkg</code> - å¯æµ‹è¯•ç§æœ‰å‡½æ•°</li><li><strong>éš”ç¦»æµ‹è¯•</strong>ï¼š<code>package mypkg_test</code> - ä»…æµ‹è¯•å¯¼å‡ºAPIï¼Œæ›´ç¬¦åˆç”¨æˆ·è§†è§’</li></ul></li></ul><h4 id="3-åŸºå‡†æµ‹è¯•å¸¸è§è¯¯åŒº"><a href="#3-åŸºå‡†æµ‹è¯•å¸¸è§è¯¯åŒº" class="headerlink" title="3. åŸºå‡†æµ‹è¯•å¸¸è§è¯¯åŒº"></a>3. åŸºå‡†æµ‹è¯•å¸¸è§è¯¯åŒº</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åæ¨¡å¼ï¼šåœ¨å¾ªç¯å†…æ‰§è¡Œä¸åº”è¢«æµ‹é‡çš„æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkBad</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">        data := generateTestData() <span class="comment">// æ¯æ¬¡è¿­ä»£éƒ½ç”Ÿæˆæ•°æ®ï¼Œæ±¡æŸ“æµ‹é‡ç»“æœ</span></span><br><span class="line">        Process(data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®åšæ³•ï¼šå°†å›ºå®šå¼€é”€ç§»å‡ºå¾ªç¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkGood</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    data := generateTestData() <span class="comment">// ä»…ç”Ÿæˆä¸€æ¬¡</span></span><br><span class="line">    b.ResetTimer()             <span class="comment">// é‡ç½®è®¡æ—¶å™¨æ’é™¤åˆå§‹åŒ–å¼€é”€</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">        Process(data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-æµ‹è¯•è¾…åŠ©å‡½æ•°æ ‡è®°"><a href="#4-æµ‹è¯•è¾…åŠ©å‡½æ•°æ ‡è®°" class="headerlink" title="4. æµ‹è¯•è¾…åŠ©å‡½æ•°æ ‡è®°"></a>4. æµ‹è¯•è¾…åŠ©å‡½æ•°æ ‡è®°</h4><p>è‡ªå®šä¹‰æ–­è¨€å‡½æ•°å¿…é¡»è°ƒç”¨<code>Helper()</code>ï¼Œå¦åˆ™å¤±è´¥å †æ ˆä¼šæŒ‡å‘è¾…åŠ©å‡½æ•°è€Œéå®é™…æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">assertEqual</span><span class="params">(t *testing.T, got, want <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    t.Helper() <span class="comment">// å…³é”®ï¼šä½¿å¤±è´¥è¡Œå·æŒ‡å‘è°ƒç”¨è€…</span></span><br><span class="line">    <span class="keyword">if</span> got != want &#123;</span><br><span class="line">        t.Errorf(<span class="string">&quot;got %d, want %d&quot;</span>, got, want)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹"><a href="#å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹" class="headerlink" title="å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹"></a>å››ã€å…¸å‹å®æˆ˜æ¡ˆä¾‹</h3><h4 id="æ¡ˆä¾‹1ï¼šTable-Drivenæµ‹è¯•ä¸å­æµ‹è¯•ç»“åˆ"><a href="#æ¡ˆä¾‹1ï¼šTable-Drivenæµ‹è¯•ä¸å­æµ‹è¯•ç»“åˆ" class="headerlink" title="æ¡ˆä¾‹1ï¼šTable-Drivenæµ‹è¯•ä¸å­æµ‹è¯•ç»“åˆ"></a>æ¡ˆä¾‹1ï¼šTable-Drivenæµ‹è¯•ä¸å­æµ‹è¯•ç»“åˆ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestParseTime</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">        name    <span class="type">string</span></span><br><span class="line">        input   <span class="type">string</span></span><br><span class="line">        want    time.Time</span><br><span class="line">        wantErr <span class="type">bool</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">        &#123;<span class="string">&quot;valid RFC3339&quot;</span>, <span class="string">&quot;2023-01-01T12:00:00Z&quot;</span>, time.Date(<span class="number">2023</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, time.UTC), <span class="literal">false</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;invalid format&quot;</span>, <span class="string">&quot;not-a-time&quot;</span>, time.Time&#123;&#125;, <span class="literal">true</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">        <span class="comment">// ä¸ºæ¯ä¸ªç”¨ä¾‹åˆ›å»ºç‹¬ç«‹å­æµ‹è¯•</span></span><br><span class="line">        t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">            t.Parallel() <span class="comment">// å®‰å…¨å¹¶è¡Œï¼šç”¨ä¾‹é—´æ— å…±äº«çŠ¶æ€</span></span><br><span class="line">            </span><br><span class="line">            got, err := ParseTime(tt.input)</span><br><span class="line">            <span class="keyword">if</span> (err != <span class="literal">nil</span>) != tt.wantErr &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;ParseTime() error = %v, wantErr %v&quot;</span>, err, tt.wantErr)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> !got.Equal(tt.want) &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;ParseTime() = %v, want %v&quot;</span>, got, tt.want)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ¡ˆä¾‹2ï¼šåŸºå‡†æµ‹è¯•å†…å­˜åˆ†é…åˆ†æ"><a href="#æ¡ˆä¾‹2ï¼šåŸºå‡†æµ‹è¯•å†…å­˜åˆ†é…åˆ†æ" class="headerlink" title="æ¡ˆä¾‹2ï¼šåŸºå‡†æµ‹è¯•å†…å­˜åˆ†é…åˆ†æ"></a>æ¡ˆä¾‹2ï¼šåŸºå‡†æµ‹è¯•å†…å­˜åˆ†é…åˆ†æ</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkStringConcat</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">    b.ReportAllocs() <span class="comment">// å¯ç”¨å†…å­˜åˆ†é…æŠ¥å‘Š</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æµ‹è¯•strings.Builder</span></span><br><span class="line">    b.Run(<span class="string">&quot;Builder&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">            <span class="keyword">var</span> builder strings.Builder</span><br><span class="line">            <span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">100</span>; j++ &#123;</span><br><span class="line">                builder.WriteString(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            _ = builder.String()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æµ‹è¯•+æ“ä½œç¬¦ï¼ˆå¯¹æ¯”æ€§èƒ½å·®å¼‚ï¼‰</span></span><br><span class="line">    b.Run(<span class="string">&quot;PlusOperator&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">            s := <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="number">100</span>; j++ &#123;</span><br><span class="line">                s += <span class="string">&quot;test&quot;</span> <span class="comment">// æ¯æ¬¡åˆ›å»ºæ–°å­—ç¬¦ä¸²ï¼Œå¤§é‡åˆ†é…</span></span><br><span class="line">            &#125;</span><br><span class="line">            _ = s</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå°†æ˜¾ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkStringConcat/Builder-8          3000000               400 ns/op             400 B/op          1 allocs/op</span><br><span class="line">BenchmarkStringConcat/PlusOperator-8      200000              6000 ns/op           20000 B/op        100 allocs/op</span><br></pre></td></tr></table></figure><h4 id="æ¡ˆä¾‹3ï¼šé›†æˆæµ‹è¯•ä¸­çš„ç¯å¢ƒéš”ç¦»"><a href="#æ¡ˆä¾‹3ï¼šé›†æˆæµ‹è¯•ä¸­çš„ç¯å¢ƒéš”ç¦»" class="headerlink" title="æ¡ˆä¾‹3ï¼šé›†æˆæµ‹è¯•ä¸­çš„ç¯å¢ƒéš”ç¦»"></a>æ¡ˆä¾‹3ï¼šé›†æˆæµ‹è¯•ä¸­çš„ç¯å¢ƒéš”ç¦»</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestAPIIntegration</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> testing.Short() &#123;</span><br><span class="line">        t.Skip(<span class="string">&quot;è·³è¿‡è€—æ—¶é›†æˆæµ‹è¯•&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæµ‹è¯•æ–‡ä»¶æ“ä½œ</span></span><br><span class="line">    tempDir := t.TempDir() <span class="comment">// æµ‹è¯•ç»“æŸè‡ªåŠ¨æ¸…ç†</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸´æ—¶ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼ˆä»…å½±å“å½“å‰æµ‹è¯•ï¼‰</span></span><br><span class="line">    t.Setenv(<span class="string">&quot;API_KEY&quot;</span>, <span class="string">&quot;test-key&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯åŠ¨MockæœåŠ¡</span></span><br><span class="line">    server := httptest.NewServer(mockHandler())</span><br><span class="line">    t.Cleanup(server.Close) <span class="comment">// ç¡®ä¿æœåŠ¡å…³é—­</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œå®é™…æµ‹è¯•</span></span><br><span class="line">    client := NewClient(server.URL)</span><br><span class="line">    resp, err := client.FetchData(context.Background())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        t.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éªŒè¯å“åº”...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äº”ã€è¿›é˜¶æŠ€å·§ï¼šæ¨¡ç³Šæµ‹è¯•é›†æˆ"><a href="#äº”ã€è¿›é˜¶æŠ€å·§ï¼šæ¨¡ç³Šæµ‹è¯•é›†æˆ" class="headerlink" title="äº”ã€è¿›é˜¶æŠ€å·§ï¼šæ¨¡ç³Šæµ‹è¯•é›†æˆ"></a>äº”ã€è¿›é˜¶æŠ€å·§ï¼šæ¨¡ç³Šæµ‹è¯•é›†æˆ</h3><p>Go 1.18+ åŸç”Ÿæ”¯æŒæ¨¡ç³Šæµ‹è¯•ï¼Œä¸testingåŒ…æ— ç¼é›†æˆï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FuzzReverse</span><span class="params">(f *testing.F)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ç§å­è¯­æ–™åº“</span></span><br><span class="line">    f.Add(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">    f.Add(<span class="string">&quot;ä¸–ç•Œ&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    f.Fuzz(<span class="function"><span class="keyword">func</span><span class="params">(t *testing.T, s <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">        rev := Reverse(s)</span><br><span class="line">        doubleRev := Reverse(rev)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸å˜æ€§éªŒè¯ï¼šä¸¤æ¬¡åè½¬åº”å›åˆ°åŸå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">if</span> s != doubleRev &#123;</span><br><span class="line">            t.Errorf(<span class="string">&quot;Reverse(Reverse(%q)) = %q, want %q&quot;</span>, s, doubleRev, s)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå‘½ä»¤ï¼š<code>go test -fuzz=FuzzReverse -fuzztime=60s</code></p><h3 id="å…­ã€è¦ç‚¹æ€»ç»“"><a href="#å…­ã€è¦ç‚¹æ€»ç»“" class="headerlink" title="å…­ã€è¦ç‚¹æ€»ç»“"></a>å…­ã€è¦ç‚¹æ€»ç»“</h3><p>testingåŒ…çš„è®¾è®¡ä½“ç°äº†Goè¯­è¨€â€å°‘å³æ˜¯å¤šâ€çš„å“²å­¦ï¼š</p><ul><li><strong>æ¥å£æŠ½è±¡</strong>ï¼šTBæ¥å£ç»Ÿä¸€æµ‹è¯•è¡Œä¸ºï¼Œé™ä½ç”Ÿæ€ç¢ç‰‡åŒ–</li><li><strong>æ˜¾å¼æ§åˆ¶</strong>ï¼šParallel&#x2F;Cleanupç­‰æ–¹æ³•æ˜ç¡®è¡¨è¾¾æµ‹è¯•æ„å›¾</li><li><strong>å·¥å…·é›†æˆ</strong>ï¼šä¸go testå‘½ä»¤æ·±åº¦è€¦åˆï¼Œæä¾›è¦†ç›–ç‡ã€ç«æ€æ£€æµ‹ç­‰èƒ½åŠ›</li><li><strong>æ¸è¿›å¢å¼º</strong>ï¼šä»åŸºç¡€å•å…ƒæµ‹è¯•åˆ°æ¨¡ç³Šæµ‹è¯•ï¼Œä¿æŒAPIä¸€è‡´æ€§</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;åœ¨Goè¯­è¨€ç”Ÿæ€ä¸­ï¼Œ&lt;code&gt;testing&lt;/code&gt;åŒ…æ˜¯è‡ªåŠ¨åŒ–æµ‹è¯•çš„åŸºçŸ³ï¼Œä¸&lt;code&gt;go test&lt;/code&gt;å‘½ä»¤ååŒå·¥ä½œï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€å¥—ç®€æ´è€Œå¼ºå¤§çš„æµ‹è¯•æ¡†æ¶ã€‚æœ¬æ–‡å°†ç³»ç»Ÿæ€§è§£ætestingåŒ…çš„æ¶æ„è®¾è®¡ã€æ ¸å¿ƒåŸç†ä¸å®æˆ˜æŠ€å·§ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€ŸæŒæ¡ä¸“ä¸šçº§æµ‹è¯•èƒ½åŠ›ã€‚&lt;br&gt;æŒæ¡testingåŒ…ä¸ä»…æ˜¯ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œæ›´æ˜¯ç†è§£Goå¹¶å‘æ¨¡å‹ã€èµ„æºç®¡ç†ä¸å·¥ç¨‹åŒ–æ€ç»´çš„è¿‡ç¨‹ã€‚é€šè¿‡åˆç†è¿ç”¨å­æµ‹è¯•ã€å¹¶è¡Œæ‰§è¡Œã€åŸºå‡†åˆ†æç­‰ç‰¹æ€§ï¼Œå¼€å‘è€…èƒ½å¤Ÿæ„å»ºæ—¢é«˜æ•ˆåˆå¯é çš„æµ‹è¯•ä½“ç³»ï¼Œä¸ºè½¯ä»¶è´¨é‡æä¾›åšå®ä¿éšœï¼Œä¿éšœåº”ç”¨çš„é«˜è´¨é‡äº¤ä»˜ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="golang" scheme="https://www.wdft.com/categories/golang/"/>
    
    <category term="standard-library" scheme="https://www.wdft.com/categories/golang/standard-library/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="Go-standard-library" scheme="https://www.wdft.com/tags/Go-standard-library/"/>
    
    <category term="Go-testing" scheme="https://www.wdft.com/tags/Go-testing/"/>
    
  </entry>
  
</feed>
