<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jaco Liu Personal Site (ljq@GitHub).å®‰å…¨è´¯ç©¿äºè½¯ä»¶å¼€å‘å„ä¸ªç¯èŠ‚.</title>
  
  <subtitle>Jaco Liu Personal Site (ljq@GitHub)</subtitle>
  <link href="https://www.wdft.com/atom.xml" rel="self"/>
  
  <link href="https://www.wdft.com/"/>
  <updated>2026-01-28T10:03:44.022Z</updated>
  <id>https://www.wdft.com/</id>
  
  <author>
    <name>Jaco Liu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä½¿ç”¨ CentOS + firewalld è„šæœ¬å®ç°æ‰«æç±»IPæ¥è®¿è€…çš„æ™ºèƒ½å¿«é€Ÿå°ç¦(ç”Ÿäº§ç¯å¢ƒæ…ç”¨âš ï¸)</title>
    <link href="https://www.wdft.com/62bcfffd.html"/>
    <id>https://www.wdft.com/62bcfffd.html</id>
    <published>2026-01-27T15:12:03.000Z</published>
    <updated>2026-01-28T10:03:44.022Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><p>âš ï¸ ã€ä¸¥æ­£è­¦å‘Šã€‘ï¼šå› ä¸ºæœ¬è„šæœ¬æ¶‰åŠ<strong>ç³»ç»Ÿæ–‡ä»¶è®¿é—®ç­‰å…³é”®æ“ä½œ</strong>ï¼Œè¯·åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒ<strong>å……åˆ†ä¸¥æ ¼éªŒè¯</strong>åå†ç”¨äºç”Ÿäº§ç¯å¢ƒï¼<br>âš ï¸ ã€firewalldã€‘å®‰è£…ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š ï¼ˆ1ï¼‰ç¡®ä¿ <code>firewalld.service</code>æœåŠ¡å¯ç”¨å‰ï¼Œå¼€æ”¾SSHç«¯å£<code>sudo ufw allow 22/tcp</code>(æ¨èæ”¹ä¸ºè‡ªå®šä¹‰ç«¯å£)ï¼Œé˜²æ­¢æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼<strong>é¿å…å› å¼€æ”¾ç­–ç•¥é…ç½®ä¸å½“é€ æˆæœåŠ¡å™¨æ— æ³•è¿æ¥çš„æŸå¤±ï¼ˆå¤±è”ï¼‰ï¼</strong>;</p><blockquote><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šCentOS 7&#x2F;8&#x2F;9 | Rocky Linux | AlmaLinux<br><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼šé›¶ä¾èµ– | æ— éœ€ Fail2ban | å®Œæ•´å®‰å…¨é˜²æŠ¤ | ç”Ÿäº§ç¯å¢ƒå°±ç»ª<br><strong>æœ€åæ›´æ–°</strong>ï¼š2026å¹´1æœˆ28æ—¥</p></blockquote><h6 id="å¦‚æœæ˜¯åŸºäº-Debain-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ"><a href="#å¦‚æœæ˜¯åŸºäº-Debain-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ" class="headerlink" title="å¦‚æœæ˜¯åŸºäº Debain å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:"></a>å¦‚æœæ˜¯åŸºäº Debain å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:</h6><p><a href="/65fc9071.html">debian-ufw-block-ip</a></p><span id="more"></span><hr><h2 id="ğŸ“Œ-ä¸ºä»€ä¹ˆéœ€è¦-Firewalld-Shell-è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#ğŸ“Œ-ä¸ºä»€ä¹ˆéœ€è¦-Firewalld-Shell-è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="ğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ Firewalld + Shell è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ"></a>ğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ Firewalld + Shell è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ</h2><p>å½“ä½ çš„ Web æœåŠ¡å™¨é­é‡ä»¥ä¸‹æ”»å‡»æ—¶ï¼š</p><ul><li>ç®€å•å¿«é€Ÿå“åº”ç´§æ€¥é˜²æŠ¤</li><li>é¢‘ç¹æ‰«æ <code>/data/</code>ã€<code>/images/</code> ç­‰æ•æ„Ÿç›®å½•</li><li>å¤§é‡ 403&#x2F;404 è¯·æ±‚ï¼ˆæš´åŠ›ç ´è§£ã€ç›®å½•éå†ï¼‰</li><li>CC æ”»å‡»æˆ–çˆ¬è™«æ»¥ç”¨</li></ul><p>ä¼ ç»Ÿæ–¹æ¡ˆå¦‚ Fail2ban è™½å¼ºå¤§ï¼Œä½†å­˜åœ¨ï¼š</p><ul><li>ä¾èµ– Python ç¯å¢ƒï¼Œå ç”¨èµ„æºï¼Œéœ€è¦å¼•å…¥å¤–éƒ¨èµ„æºåŒ…</li><li>é…ç½®å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜</li><li>å¯èƒ½å› æ•°æ®åº“é—®é¢˜å¯¼è‡´å®‰è£…å¤±è´¥ï¼ˆå¦‚ä½ é‡åˆ°çš„ MariaDB é—®é¢˜ï¼‰</li></ul><p><strong>æœ¬æ–¹æ¡ˆä¼˜åŠ¿</strong>ï¼š<br>âœ… çº¯ Shell è„šæœ¬ï¼Œé›¶å¤–éƒ¨ä¾èµ–<br>âœ… åŸºäº Firewalldï¼ˆCentOS é»˜è®¤é˜²ç«å¢™ï¼‰ï¼Œæ“ä½œç›´è§‚<br>âœ… æ™ºèƒ½é˜²æŠ¤ï¼šè‡ªåŠ¨è·³è¿‡æœ¬æœº&#x2F;å†…ç½‘&#x2F;å›ç¯åœ°å€ï¼Œæœç»è¯¯å°<br>âœ… æ”¯æŒå• IPã€å¤š IPã€æ–‡ä»¶æ‰¹é‡æ“ä½œ<br>âœ… å®Œæ•´æ“ä½œæ—¥å¿—ï¼Œä¾¿äºå®¡è®¡  </p><hr><h2 id="ğŸ”‘-æ ¸å¿ƒåŠŸèƒ½æ¸…å•"><a href="#ğŸ”‘-æ ¸å¿ƒåŠŸèƒ½æ¸…å•" class="headerlink" title="ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½æ¸…å•"></a>ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½æ¸…å•</h2><table><thead><tr><th>åŠŸèƒ½</th><th>è¯´æ˜</th><th>å®‰å…¨é˜²æŠ¤</th></tr></thead><tbody><tr><td><strong>å•&#x2F;å¤š IP å°ç¦&#x2F;è§£å°</strong></td><td><code>add/remove &lt;IP&gt; [&lt;IP2&gt; ...]</code></td><td>âœ… æ‹¦æˆªæœ¬æœº&#x2F;å†…ç½‘&#x2F;å›ç¯</td></tr><tr><td><strong>æ–‡ä»¶æ‰¹é‡æ“ä½œ</strong></td><td><code>-f &lt;æ–‡ä»¶&gt;</code> æ”¯æŒæ³¨é‡Š&#x2F;ç©ºè¡Œ</td><td>âœ… è‡ªåŠ¨è·³è¿‡å±é™©åœ°å€</td></tr><tr><td><strong>IPv4&#x2F;IPv6 åŒæ ˆ</strong></td><td>è‡ªåŠ¨è¯†åˆ«åœ°å€æ—å¹¶æ­£ç¡®å°ç¦</td><td>âœ… ä¸¥æ ¼æ ¼å¼éªŒè¯</td></tr><tr><td><strong>è§„åˆ™æŒä¹…åŒ–</strong></td><td>è‡ªåŠ¨ <code>--permanent</code> + <code>--reload</code></td><td>âœ… é‡å¯ä¸å¤±æ•ˆ</td></tr><tr><td><strong>é˜²é‡å¤æ“ä½œ</strong></td><td>æ™ºèƒ½æ£€æµ‹å·²å­˜åœ¨è§„åˆ™</td><td>âœ… é¿å…è§„åˆ™å †ç§¯</td></tr><tr><td><strong>å®Œæ•´æ“ä½œæ—¥å¿—</strong></td><td><code>/var/log/firewalld-blocked.log</code></td><td>âœ… å®¡è®¡è¿½è¸ª</td></tr><tr><td><strong>å±é™©åœ°å€é˜²æŠ¤</strong></td><td>æ‹¦æˆª 10.0.0.0&#x2F;8, 192.168.0.0&#x2F;16 ç­‰</td><td>âœ… ä»… <code>add</code> æ“ä½œè§¦å‘</td></tr></tbody></table><hr><h2 id="ğŸ’»-å®Œæ•´è„šæœ¬ä»£ç ï¼ˆblock-ip-shï¼‰"><a href="#ğŸ’»-å®Œæ•´è„šæœ¬ä»£ç ï¼ˆblock-ip-shï¼‰" class="headerlink" title="ğŸ’» å®Œæ•´è„šæœ¬ä»£ç ï¼ˆblock-ip.shï¼‰"></a>ğŸ’» å®Œæ•´è„šæœ¬ä»£ç ï¼ˆblock-ip.shï¼‰</h2><blockquote><p><strong>æ–‡ä»¶è·¯å¾„</strong>ï¼š<code>/usr/local/bin/block-ip.sh</code><br><strong>æƒé™è¦æ±‚</strong>ï¼š<code>chmod +x</code> + <code>sudo</code> æ‰§è¡Œ<br><strong>ä¾èµ–</strong>ï¼š<code>firewalld</code> æœåŠ¡å¿…é¡»è¿è¡Œ</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =============================================================</span></span><br><span class="line"><span class="comment"># CentOS firewalld IP ç®¡ç†è„šæœ¬</span></span><br><span class="line"><span class="comment"># ä½œè€…ï¼šä¼ä¸šçº§å®‰å…¨åŠ å›ºæ–¹æ¡ˆ</span></span><br><span class="line"><span class="comment"># ç‰ˆæœ¬ï¼š2.0 (firewalld ä¸“ç”¨)</span></span><br><span class="line"><span class="comment"># åŠŸèƒ½ï¼šæ™ºèƒ½å°ç¦/è§£å°æ¶æ„è®¿é—® IPï¼Œé€‚é… CentOS/RHEL ç”Ÿæ€</span></span><br><span class="line"><span class="comment"># ä¸¥æ­£è­¦å‘Šï¼š ä½¿ç”¨æ­¤è„šæœ¬å‰å……åˆ†éªŒè¯ï¼Œä¸”åœ¨ç¡®ä¿firewalldæœåŠ¡æ˜¯åœ¨å¼€æ”¾SSHç«¯å£çš„æƒ…å†µä¸‹è¿›è¡Œï¼</span></span><br><span class="line"><span class="comment"># =============================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== ç³»ç»Ÿæ£€æµ‹ ==========</span></span><br><span class="line">SYSTEM_INFO=$(detect_system)</span><br><span class="line">OS_TYPE=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$SYSTEM_INFO</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;|&#x27;</span> -f1)</span><br><span class="line">OS_VERSION=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$SYSTEM_INFO</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;|&#x27;</span> -f2)</span><br><span class="line">FIREWALL_BACKEND=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$SYSTEM_INFO</span>&quot;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;|&#x27;</span> -f3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== firewalld å®‰å…¨äº¤äº’ç¡®è®¤ ==========</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$FIREWALL_BACKEND</span>&quot;</span> == <span class="string">&quot;firewalld&quot;</span> ]] &amp;&amp; [[ -z <span class="string">&quot;<span class="variable">$&#123;SKIP_SAFETY_CHECK:-&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    SSH_PORT=<span class="string">&quot;<span class="variable">$&#123;SSH_PORT:-22&#125;</span>&quot;</span></span><br><span class="line">    TIMEOUT=60</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä»…å½“ firewalld è¿è¡Œæ—¶å¼ºåˆ¶ç¡®è®¤</span></span><br><span class="line">    <span class="keyword">if</span> firewall-cmd --state &amp;&gt;/dev/null &amp;&amp; systemctl is-active firewalld &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ğŸ” SSH ç«¯å£å®‰å…¨ç¡®è®¤ï¼ˆfirewalld è¿è¡Œä¸­ï¼‰&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;â€¢ SSH ç«¯å£: <span class="variable">$SSH_PORT</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;â€¢ è¿è¡Œæ—¶è§„åˆ™: <span class="subst">$(firewall-cmd --list-services 2&gt;/dev/null | grep -qw ssh &amp;&amp; echo &#x27;âœ… ssh æœåŠ¡&#x27; || echo &#x27;âš ï¸  æœªæ£€æµ‹åˆ° ssh æœåŠ¡&#x27;)</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;âš ï¸  æœªæ”¾è¡Œ SSH å¯èƒ½å¯¼è‡´æ°¸ä¹…å¤±è”ï¼äº‘æœåŠ¡å™¨éœ€åŒæ—¶æ£€æŸ¥å®‰å…¨ç»„ã€‚&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;â“ æ˜¯å¦å·²ç¡®ä¿ SSH è¿æ¥å®‰å…¨ï¼Ÿ(yes/no) [<span class="variable">$&#123;TIMEOUT&#125;</span>s è¶…æ—¶]&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">&quot;&gt;&gt;&gt; &quot;</span></span><br><span class="line">        </span><br><span class="line">        read_input=<span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">command</span> -v <span class="built_in">timeout</span> &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">            read_input=$(<span class="built_in">timeout</span> <span class="string">&quot;<span class="variable">$TIMEOUT</span>&quot;</span> bash -c <span class="string">&#x27;read -r input &amp;&amp; echo &quot;$input&quot;&#x27;</span> 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">read</span> -t <span class="string">&quot;<span class="variable">$TIMEOUT</span>&quot;</span> -r input 2&gt;/dev/null || input=<span class="string">&quot;&quot;</span></span><br><span class="line">            read_input=<span class="string">&quot;<span class="variable">$input</span>&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> [[ ! <span class="string">&quot;<span class="variable">$&#123;read_input,,&#125;</span>&quot;</span> =~ ^(<span class="built_in">yes</span>|y|ye)$ ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ å®‰å…¨ç¡®è®¤å¤±è´¥ï¼Œç»ˆæ­¢æ‰§è¡Œ&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;ğŸ’¡ è¯·å…ˆæ‰§è¡Œ: sudo firewall-cmd --add-service=ssh --permanent &amp;&amp; sudo firewall-cmd --reload&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;âœ… å®‰å…¨ç¡®è®¤é€šè¿‡&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># ========== å®‰å…¨ç¡®è®¤ç»“æŸ ==========</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 1. ç¯å¢ƒæ£€æŸ¥ ------------------------</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">command</span> -v firewall-cmd &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;âŒ é”™è¯¯ï¼šfirewalld æœªå®‰è£…æˆ–ä¸å¯ç”¨&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;è¯·å…ˆå®‰è£…å¹¶å¯ç”¨ firewalldï¼š&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  sudo yum install -y firewalld&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;  sudo systemctl enable --now firewalld&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ! sudo firewall-cmd --state &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;âŒ é”™è¯¯ï¼šfirewalld æœåŠ¡æœªè¿è¡Œ&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;è¯·å…ˆå¯åŠ¨æœåŠ¡ï¼šsudo systemctl start firewalld&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 2. å‚æ•°è§£æ ------------------------</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -lt 2 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">âŒ ç”¨æ³•é”™è¯¯ï¼</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä¸“ä¸šç”¨æ³•ï¼ˆCentOS firewalld ä¸“ç”¨ï¼‰ï¼š</span></span><br><span class="line"><span class="string">  # å• IP æ“ä½œ</span></span><br><span class="line"><span class="string">  sudo $0 add    &lt;IP&gt;</span></span><br><span class="line"><span class="string">  sudo $0 remove &lt;IP&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # å¤š IP æ‰¹é‡æ“ä½œï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</span></span><br><span class="line"><span class="string">  sudo $0 add    &lt;IP1&gt; &lt;IP2&gt; &lt;IP3&gt;</span></span><br><span class="line"><span class="string">  sudo $0 remove &lt;IP1&gt; &lt;IP2&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # ä»æ–‡ä»¶æ‰¹é‡æ“ä½œï¼ˆæ¯è¡Œä¸€ä¸ª IPï¼Œæ”¯æŒ # æ³¨é‡Šï¼‰</span></span><br><span class="line"><span class="string">  sudo $0 add    -f /path/to/bad_ips.txt</span></span><br><span class="line"><span class="string">  sudo $0 remove -f /path/to/good_ips.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">âš ï¸  å®‰å…¨è­¦å‘Šï¼š</span></span><br><span class="line"><span class="string">  â€¢ ç¦æ­¢å°ç¦æœ¬æœºå…¬ç½‘ IPã€å†…ç½‘ IPï¼ˆ10.x/172.16-31.x/192.168.xï¼‰ã€127.0.0.1ã€::1</span></span><br><span class="line"><span class="string">  â€¢ å°ç¦æ“ä½œå°†æ‹’ç»è¯¥ IP æ‰€æœ‰å…¥ç«™è¿æ¥ï¼ˆåŒ…æ‹¬ SSHï¼ï¼‰</span></span><br><span class="line"><span class="string">  â€¢ firewalld è§„åˆ™éœ€ --permanent + --reload æ‰èƒ½æŒä¹…ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">ACTION=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line"></span><br><span class="line">IP_LIST=()</span><br><span class="line">FROM_FILE=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -gt 0 ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;-f&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -lt 2 ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ -f åå¿…é¡»æŒ‡å®šæ–‡ä»¶è·¯å¾„&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">        FROM_FILE=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">        <span class="built_in">shift</span> 2</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        IP_LIST+=(<span class="string">&quot;<span class="variable">$1</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">shift</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[[ <span class="string">&quot;<span class="variable">$&#123;#IP_LIST[@]&#125;</span>&quot;</span> -eq 0 &amp;&amp; -z <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ æœªæä¾›ä»»ä½• IP æˆ–æ–‡ä»¶&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶è¯»å– IPï¼ˆè·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šï¼‰</span></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    [[ ! -f <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ æ–‡ä»¶ä¸å­˜åœ¨: <span class="variable">$FROM_FILE</span>&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        line=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;[:space:]&#x27;</span>)</span><br><span class="line">        [[ -n <span class="string">&quot;<span class="variable">$line</span>&quot;</span> &amp;&amp; ! <span class="string">&quot;<span class="variable">$line</span>&quot;</span> =~ ^<span class="comment"># ]] &amp;&amp; IP_LIST+=(&quot;$line&quot;)</span></span><br><span class="line">    <span class="keyword">done</span> &lt; <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å»é‡</span></span><br><span class="line"><span class="built_in">readarray</span> -t IP_LIST &lt; &lt;(<span class="built_in">printf</span> <span class="string">&#x27;%s\n&#x27;</span> <span class="string">&quot;<span class="variable">$&#123;IP_LIST[@]&#125;</span>&quot;</span> | <span class="built_in">sort</span> -u)</span><br><span class="line">[[ <span class="string">&quot;<span class="variable">$&#123;#IP_LIST[@]&#125;</span>&quot;</span> -eq 0 ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  æ— æœ‰æ•ˆ IP éœ€å¤„ç†&quot;</span>; <span class="built_in">exit</span> 0; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 3. å®‰å…¨å‡½æ•° ------------------------</span></span><br><span class="line"><span class="built_in">declare</span> -A LOCAL_IPS</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_local_ips</span></span>() &#123;</span><br><span class="line">    LOCAL_IPS[<span class="string">&quot;127.0.0.1&quot;</span>]=1</span><br><span class="line">    LOCAL_IPS[<span class="string">&quot;::1&quot;</span>]=1</span><br><span class="line">    <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        ip_addr=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;/&#x27;</span> -f1)</span><br><span class="line">        [[ -n <span class="string">&quot;<span class="variable">$ip_addr</span>&quot;</span> ]] &amp;&amp; LOCAL_IPS[<span class="string">&quot;<span class="variable">$ip_addr</span>&quot;</span>]=1</span><br><span class="line">    <span class="keyword">done</span> &lt; &lt;(ip -o addr show scope global 2&gt;/dev/null | grep -v <span class="string">&#x27;inet6 fe80:&#x27;</span> || <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line">get_local_ips</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">is_dangerous_ip</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> ip=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># IPv4 ä¸¥æ ¼éªŒè¯</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;$ ]]; <span class="keyword">then</span></span><br><span class="line">        IFS=<span class="string">&#x27;.&#x27;</span> <span class="built_in">read</span> -r a b c d &lt;&lt;&lt; <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">        <span class="keyword">for</span> octet <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$a</span>&quot;</span> <span class="string">&quot;<span class="variable">$b</span>&quot;</span> <span class="string">&quot;<span class="variable">$c</span>&quot;</span> <span class="string">&quot;<span class="variable">$d</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">            [[ ! <span class="string">&quot;<span class="variable">$octet</span>&quot;</span> =~ ^[0-9]+$ || <span class="string">&quot;<span class="variable">$octet</span>&quot;</span> -gt 255 ]] 2&gt;/dev/null &amp;&amp; <span class="built_in">return</span> 2</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å±é™©åœ°å€æ®µ</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;127.0.0.1&quot;</span> || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^10\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^192\.168\. || \</span><br><span class="line">           <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^172\.(1[6-9]|2[0-9]|3[01])\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^169\.254\. || \</span><br><span class="line">           <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^0\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^224\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^240\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;255.255.255.255&quot;</span> ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># IPv6 éªŒè¯</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;::1&quot;</span> || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ : ]]; <span class="keyword">then</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^fd[0-9a-fA-F]&#123;2&#125;: || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^fe80: || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^ff00: ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 2</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ£€æŸ¥æ˜¯å¦æœ¬æœº IP</span></span><br><span class="line">    [[ -n <span class="string">&quot;<span class="variable">$&#123;LOCAL_IPS[$ip]+_&#125;</span>&quot;</span> ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># firewalld è§„åˆ™ç”Ÿæˆå™¨</span></span><br><span class="line"><span class="function"><span class="title">get_rich_rule</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> ip=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> action=<span class="string">&quot;<span class="variable">$2</span>&quot;</span>  <span class="comment"># reject/drop</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ : ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;rule family=\&quot;ipv6\&quot; source address=\&quot;<span class="variable">$ip</span>\&quot; <span class="variable">$action</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;rule family=\&quot;ipv4\&quot; source address=\&quot;<span class="variable">$ip</span>\&quot; <span class="variable">$action</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log_action</span></span>() &#123;</span><br><span class="line">    <span class="built_in">mkdir</span> -p /var/log</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> <span class="variable">$1</span> <span class="variable">$2</span>&quot;</span> &gt;&gt; /var/log/firewalld-blocked.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 4. æ‰¹é‡æ‰§è¡Œ ------------------------</span></span><br><span class="line">TOTAL=<span class="variable">$&#123;#IP_LIST[@]&#125;</span></span><br><span class="line">SUCCESS=0</span><br><span class="line">SKIPPED=0</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸš€ firewalld <span class="variable">$ACTION</span> æ“ä½œï¼ˆå…± <span class="variable">$TOTAL</span> ä¸ª IPï¼‰...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;IP_LIST[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;â€¢ <span class="variable">$ip</span> ... &quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å®‰å…¨æ£€æŸ¥ï¼ˆä»… add æ“ä½œä¸¥æ ¼æ‹¦æˆªå±é™© IPï¼‰</span></span><br><span class="line">    <span class="keyword">case</span> $(is_dangerous_ip <span class="string">&quot;<span class="variable">$ip</span>&quot;</span>; <span class="built_in">echo</span> $?) <span class="keyword">in</span></span><br><span class="line">        0)</span><br><span class="line">            <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;add&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;âš ï¸  è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰&quot;</span></span><br><span class="line">                ((SKIPPED++))</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            ;;</span><br><span class="line">        2)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ æ— æ•ˆæ ¼å¼&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;add&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è§„åˆ™</span></span><br><span class="line">        RULE=$(get_rich_rule <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> sudo firewall-cmd --permanent --list-rich-rules 2&gt;/dev/null | grep -qF <span class="string">&quot;<span class="variable">$RULE</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  å·²å°ç¦&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ æ°¸ä¹…è§„åˆ™</span></span><br><span class="line">        <span class="keyword">if</span> sudo firewall-cmd --permanent --add-rich-rule=<span class="string">&quot;<span class="variable">$RULE</span>&quot;</span> &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># é‡è½½ä½¿è§„åˆ™ç”Ÿæ•ˆ</span></span><br><span class="line">            sudo firewall-cmd --reload &amp;&gt;/dev/null</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âœ… å°ç¦æˆåŠŸ&quot;</span></span><br><span class="line">            log_action <span class="string">&quot;BLOCKED&quot;</span> <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">            ((SUCCESS++))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ å°ç¦å¤±è´¥&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;remove&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        RULE=$(get_rich_rule <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> <span class="string">&quot;reject&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> ! sudo firewall-cmd --permanent --list-rich-rules 2&gt;/dev/null | grep -qF <span class="string">&quot;<span class="variable">$RULE</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  æœªå°ç¦&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sudo firewall-cmd --permanent --remove-rich-rule=<span class="string">&quot;<span class="variable">$RULE</span>&quot;</span> &amp;&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">            sudo firewall-cmd --reload &amp;&gt;/dev/null</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âœ… è§£å°æˆåŠŸ&quot;</span></span><br><span class="line">            log_action <span class="string">&quot;UNBLOCKED&quot;</span> <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">            ((SUCCESS++))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ è§£å°å¤±è´¥&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;âœ… æ“ä½œå®Œæˆï¼šæˆåŠŸ <span class="variable">$SUCCESS</span> | è·³è¿‡ <span class="variable">$SKIPPED</span> | æ€»è®¡ <span class="variable">$TOTAL</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ“„ è¯¦ç»†æ—¥å¿—ï¼š/var/log/firewalld-blocked.log&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ” å½“å‰å°ç¦åˆ—è¡¨ï¼šsudo firewall-cmd --permanent --list-rich-rules | grep reject&quot;</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”§-CentOS-éƒ¨ç½²æ­¥éª¤"><a href="#ğŸ”§-CentOS-éƒ¨ç½²æ­¥éª¤" class="headerlink" title="ğŸ”§ CentOS éƒ¨ç½²æ­¥éª¤"></a>ğŸ”§ CentOS éƒ¨ç½²æ­¥éª¤</h2><h3 id="1-ç¡®ä¿-firewalld-å·²å®‰è£…å¹¶è¿è¡Œ"><a href="#1-ç¡®ä¿-firewalld-å·²å®‰è£…å¹¶è¿è¡Œ" class="headerlink" title="1. ç¡®ä¿ firewalld å·²å®‰è£…å¹¶è¿è¡Œ"></a>1. ç¡®ä¿ firewalld å·²å®‰è£…å¹¶è¿è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… firewalldï¼ˆå¦‚æœªå®‰è£…ï¼‰</span></span><br><span class="line">sudo yum install -y firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯çŠ¶æ€</span></span><br><span class="line">sudo firewall-cmd --state</span><br><span class="line"><span class="comment"># åº”è¾“å‡ºï¼šrunning</span></span><br></pre></td></tr></table></figure><h3 id="2-ä¿å­˜è„šæœ¬"><a href="#2-ä¿å­˜è„šæœ¬" class="headerlink" title="2. ä¿å­˜è„šæœ¬"></a>2. ä¿å­˜è„šæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /usr/local/bin/block-ip.sh</span><br><span class="line"><span class="comment"># ç²˜è´´ä¸Šæ–¹å®Œæ•´ä»£ç </span></span><br></pre></td></tr></table></figure><h3 id="3-è®¾ç½®æƒé™"><a href="#3-è®¾ç½®æƒé™" class="headerlink" title="3. è®¾ç½®æƒé™"></a>3. è®¾ç½®æƒé™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> +x /usr/local/bin/block-ip.sh</span><br></pre></td></tr></table></figure><h3 id="4-ï¼ˆé‡è¦ï¼‰æ”¾è¡Œ-SSH-é¿å…è¢«é”"><a href="#4-ï¼ˆé‡è¦ï¼‰æ”¾è¡Œ-SSH-é¿å…è¢«é”" class="headerlink" title="4. ï¼ˆé‡è¦ï¼‰æ”¾è¡Œ SSH é¿å…è¢«é”"></a>4. ï¼ˆé‡è¦ï¼‰æ”¾è¡Œ SSH é¿å…è¢«é”</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¡®è®¤å½“å‰ SSH ç«¯å£ï¼ˆé»˜è®¤ 22ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --add-service=ssh</span><br><span class="line">sudo firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–æŒ‡å®šç«¯å£ï¼ˆå¦‚ 2222ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --add-port=2222/tcp</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><blockquote><p>âš ï¸ <strong>è‡´å‘½è­¦å‘Š</strong>ï¼š<br>åœ¨å¯ç”¨ä»»ä½•å°ç¦è§„åˆ™å‰ï¼Œ<strong>åŠ¡å¿…ç¡®è®¤ SSH å·²æ”¾è¡Œ</strong>ï¼<br>å»ºè®®åœ¨ screen&#x2F;tmux ä¼šè¯ä¸­æ“ä½œï¼Œé¿å…ç½‘ç»œä¸­æ–­å¯¼è‡´å¤±è”ã€‚</p></blockquote><hr><h2 id="ğŸ§ª-CentOS-ä½¿ç”¨ç¤ºä¾‹"><a href="#ğŸ§ª-CentOS-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ğŸ§ª CentOS ä½¿ç”¨ç¤ºä¾‹"></a>ğŸ§ª CentOS ä½¿ç”¨ç¤ºä¾‹</h2><h3 id="åœºæ™¯-1ï¼šå°ç¦å•ä¸ªæ¶æ„-IP"><a href="#åœºæ™¯-1ï¼šå°ç¦å•ä¸ªæ¶æ„-IP" class="headerlink" title="åœºæ™¯ 1ï¼šå°ç¦å•ä¸ªæ¶æ„ IP"></a>åœºæ™¯ 1ï¼šå°ç¦å•ä¸ªæ¶æ„ IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo block-ip.sh add x.x.x.1</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment"># â€¢ x.x.x.1 ... âœ… å°ç¦æˆåŠŸ</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-2ï¼šä»-Nginx-æ—¥å¿—æå–å¹¶å°ç¦æ‰«æå™¨"><a href="#åœºæ™¯-2ï¼šä»-Nginx-æ—¥å¿—æå–å¹¶å°ç¦æ‰«æå™¨" class="headerlink" title="åœºæ™¯ 2ï¼šä» Nginx æ—¥å¿—æå–å¹¶å°ç¦æ‰«æå™¨"></a>åœºæ™¯ 2ï¼šä» Nginx æ—¥å¿—æå–å¹¶å°ç¦æ‰«æå™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æå–è®¿é—® /data/ ç›®å½•çš„ IPï¼ˆæœ€è¿‘ 1000 è¡Œï¼‰</span></span><br><span class="line"><span class="built_in">tail</span> -n 1000 /var/log/nginx/access.log | \</span><br><span class="line">  awk <span class="string">&#x27;$7 ~ /\/data\// &#123;print $1&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | \</span><br><span class="line">  awk <span class="string">&#x27;$1 &gt; 10 &#123;print $2&#125;&#x27;</span> &gt; /tmp/scanners.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡å°ç¦</span></span><br><span class="line">sudo block-ip.sh add -f /tmp/scanners.txt</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-3ï¼šæŸ¥çœ‹å½“å‰å°ç¦è§„åˆ™"><a href="#åœºæ™¯-3ï¼šæŸ¥çœ‹å½“å‰å°ç¦è§„åˆ™" class="headerlink" title="åœºæ™¯ 3ï¼šæŸ¥çœ‹å½“å‰å°ç¦è§„åˆ™"></a>åœºæ™¯ 3ï¼šæŸ¥çœ‹å½“å‰å°ç¦è§„åˆ™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰ rich rules</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»…æŸ¥çœ‹æ‹’ç»è§„åˆ™ï¼ˆå°ç¦åˆ—è¡¨ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules | grep <span class="string">&quot;reject&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment"># rule family=&quot;ipv4&quot; source address=&quot;x.x.x.1&quot; reject</span></span><br><span class="line"><span class="comment"># rule family=&quot;ipv6&quot; source address=&quot;xxxx:xxxx::ipv6&quot; reject</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-4ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰"><a href="#åœºæ™¯-4ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰" class="headerlink" title="åœºæ™¯ 4ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰"></a>åœºæ™¯ 4ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°è¯•å°ç¦æœ¬æœº â†’ è‡ªåŠ¨æ‹’ç»</span></span><br><span class="line">sudo block-ip.sh add 127.0.0.1</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šâ€¢ 127.0.0.1 ... âš ï¸ è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°è¯•å°ç¦å†…ç½‘ â†’ è‡ªåŠ¨æ‹’ç»</span></span><br><span class="line">sudo block-ip.sh add 192.168.1.100</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šâ€¢ 192.168.1.100 ... âš ï¸ è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”’-firewalld-ä¸“å±å®‰å…¨æœºåˆ¶"><a href="#ğŸ”’-firewalld-ä¸“å±å®‰å…¨æœºåˆ¶" class="headerlink" title="ğŸ”’ firewalld ä¸“å±å®‰å…¨æœºåˆ¶"></a>ğŸ”’ firewalld ä¸“å±å®‰å…¨æœºåˆ¶</h2><h3 id="1-è§„åˆ™æŒä¹…åŒ–ä¿éšœ"><a href="#1-è§„åˆ™æŒä¹…åŒ–ä¿éšœ" class="headerlink" title="1. è§„åˆ™æŒä¹…åŒ–ä¿éšœ"></a>1. è§„åˆ™æŒä¹…åŒ–ä¿éšœ</h3><table><thead><tr><th>æ“ä½œ</th><th>firewalld å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>æ·»åŠ è§„åˆ™</strong></td><td><code>--permanent --add-rich-rule</code></td><td>ä»…å†™å…¥é…ç½®æ–‡ä»¶</td></tr><tr><td><strong>ç”Ÿæ•ˆè§„åˆ™</strong></td><td><code>--reload</code></td><td>é‡è½½é…ç½®ä½¿è§„åˆ™ç”Ÿæ•ˆ</td></tr><tr><td><strong>è¿è¡Œæ—¶è§„åˆ™</strong></td><td>æ—  <code>--permanent</code></td><td>é‡å¯åä¸¢å¤±ï¼ˆæœ¬è„šæœ¬ä¸ä½¿ç”¨ï¼‰</td></tr></tbody></table><blockquote><p>âœ… æœ¬è„šæœ¬<strong>è‡ªåŠ¨å¤„ç†æŒä¹…åŒ–+é‡è½½</strong>ï¼Œé¿å…è§„åˆ™ä¸¢å¤±</p></blockquote><h3 id="2-IPv4-x2F-IPv6-åŒæ ˆç²¾ç¡®å¤„ç†"><a href="#2-IPv4-x2F-IPv6-åŒæ ˆç²¾ç¡®å¤„ç†" class="headerlink" title="2. IPv4&#x2F;IPv6 åŒæ ˆç²¾ç¡®å¤„ç†"></a>2. IPv4&#x2F;IPv6 åŒæ ˆç²¾ç¡®å¤„ç†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># IPv4 è§„åˆ™</span></span><br><span class="line">rule family=<span class="string">&quot;ipv4&quot;</span> <span class="built_in">source</span> address=<span class="string">&quot;x.x.x.1&quot;</span> reject</span><br><span class="line"></span><br><span class="line"><span class="comment"># IPv6 è§„åˆ™</span></span><br><span class="line">rule family=<span class="string">&quot;ipv6&quot;</span> <span class="built_in">source</span> address=<span class="string">&quot;xxxx:xxxx::ipv6&quot;</span> reject</span><br></pre></td></tr></table></figure><h3 id="3-è§„åˆ™å†²çªé˜²æŠ¤"><a href="#3-è§„åˆ™å†²çªé˜²æŠ¤" class="headerlink" title="3. è§„åˆ™å†²çªé˜²æŠ¤"></a>3. è§„åˆ™å†²çªé˜²æŠ¤</h3><ul><li>åŒä¸€ IP ä¸ä¼šé‡å¤æ·»åŠ è§„åˆ™ï¼ˆé€šè¿‡ç²¾ç¡®åŒ¹é… rich ruleï¼‰</li><li>è§£å°æ—¶ç²¾ç¡®åŒ¹é…å®Œæ•´è§„åˆ™å­—ç¬¦ä¸²ï¼Œé¿å…è¯¯åˆ å…¶ä»–è§„åˆ™</li></ul><hr><h2 id="âš ï¸-CentOS-ä¸“å±æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-CentOS-ä¸“å±æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ CentOS ä¸“å±æ³¨æ„äº‹é¡¹"></a>âš ï¸ CentOS ä¸“å±æ³¨æ„äº‹é¡¹</h2><h3 id="1-å…³é”®é£é™©ç‚¹"><a href="#1-å…³é”®é£é™©ç‚¹" class="headerlink" title="1. å…³é”®é£é™©ç‚¹"></a>1. å…³é”®é£é™©ç‚¹</h3><table><thead><tr><th>é£é™©</th><th>åº”å¯¹æªæ–½</th></tr></thead><tbody><tr><td><strong>firewalld æœªè¿è¡Œ</strong></td><td>è„šæœ¬å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶æŠ¥é”™</td></tr><tr><td><strong>è§„åˆ™æœªæŒä¹…åŒ–</strong></td><td>æ‰€æœ‰æ“ä½œå¼ºåˆ¶ä½¿ç”¨ <code>--permanent</code> + <code>--reload</code></td></tr><tr><td><strong>SELinux å¹²æ‰°</strong></td><td>é€šå¸¸ä¸å½±å“ firewalldï¼Œä½†éœ€ç¡®ä¿ <code>setenforce 0</code> ä»…ç”¨äºè°ƒè¯•</td></tr><tr><td><strong>äº‘æœåŠ¡å™¨å®‰å…¨ç»„</strong></td><td>firewalld æ˜¯<strong>ç¬¬äºŒå±‚é˜²æŠ¤</strong>ï¼Œä»éœ€é…ç½®äº‘å¹³å°å®‰å…¨ç»„</td></tr></tbody></table><h3 id="2-æœ€ä½³å®è·µ"><a href="#2-æœ€ä½³å®è·µ" class="headerlink" title="2. æœ€ä½³å®è·µ"></a>2. æœ€ä½³å®è·µ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å°ç¦å‰ç¡®è®¤å½“å‰å…¬ç½‘ IPï¼ˆé¿å…è‡ªå°ï¼‰</span></span><br><span class="line">MY_IP=$(curl -s ifconfig.me)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æˆ‘çš„å…¬ç½‘ IP: <span class="variable">$MY_IP</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å¤‡ä»½å½“å‰ firewalld é…ç½®</span></span><br><span class="line">sudo <span class="built_in">cp</span> -r /etc/firewalld /etc/firewalld.backup-$(<span class="built_in">date</span> +%Y%m%d)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è®¾ç½®æ—¥å¿—è½®è½¬</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/var/log/firewalld-blocked.log &#123;</span></span><br><span class="line"><span class="string">    daily</span></span><br><span class="line"><span class="string">    rotate 30</span></span><br><span class="line"><span class="string">    compress</span></span><br><span class="line"><span class="string">    missingok</span></span><br><span class="line"><span class="string">    notifempty</span></span><br><span class="line"><span class="string">&#125;&quot;</span> | sudo <span class="built_in">tee</span> /etc/logrotate.d/firewalld-blocked</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. å®šæœŸæ¸…ç†è¿‡æœŸè§„åˆ™ï¼ˆç¤ºä¾‹ï¼š30 å¤©å‰çš„å°ç¦ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules | \</span><br><span class="line">  grep <span class="string">&quot;reject&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> rule; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># æ­¤å¤„éœ€ç»“åˆæ—¥å¿—å®ç°æ™ºèƒ½æ¸…ç†ï¼ˆç•¥ï¼‰</span></span><br><span class="line">    :</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="3-ä¸-Nginx-æ—¥å¿—é›†æˆï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰"><a href="#3-ä¸-Nginx-æ—¥å¿—é›†æˆï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰" class="headerlink" title="3. ä¸ Nginx æ—¥å¿—é›†æˆï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰"></a>3. ä¸ Nginx æ—¥å¿—é›†æˆï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/cron.d/nginx-firewalld-block</span></span><br><span class="line">*/10 * * * * root /usr/local/bin/block-nginx-scanners-centos.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># block-nginx-scanners-centos.sh å†…å®¹ï¼š</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">LOG=<span class="string">&quot;/var/log/nginx/access.log&quot;</span></span><br><span class="line">THRESHOLD=15</span><br><span class="line"></span><br><span class="line"><span class="built_in">tail</span> -n 2000 <span class="string">&quot;<span class="variable">$LOG</span>&quot;</span> | \</span><br><span class="line">  awk <span class="string">&#x27;$9 ~ /^(403|404)$/ &amp;&amp; ($7 ~ /\/data\// || $7 ~ /\/images\//) &#123;print $1&#125;&#x27;</span> | \</span><br><span class="line">  <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | awk -v t=<span class="variable">$THRESHOLD</span> <span class="string">&#x27;$1 &gt; t &#123;print $2&#125;&#x27;</span> | \</span><br><span class="line">  xargs -r /usr/local/bin/block-ip.sh add 2&gt;/dev/null</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ“Š-firewalld-vs-UFW-æ€§èƒ½å¯¹æ¯”"><a href="#ğŸ“Š-firewalld-vs-UFW-æ€§èƒ½å¯¹æ¯”" class="headerlink" title="ğŸ“Š firewalld vs UFW æ€§èƒ½å¯¹æ¯”"></a>ğŸ“Š firewalld vs UFW æ€§èƒ½å¯¹æ¯”</h2><table><thead><tr><th>æŒ‡æ ‡</th><th>firewalld (CentOS)</th><th>UFW (Debian)</th></tr></thead><tbody><tr><td><strong>è§„åˆ™æ·»åŠ é€Ÿåº¦</strong></td><td>~0.15 ç§’&#x2F;æ¡ï¼ˆå« â€“reloadï¼‰</td><td>~0.05 ç§’&#x2F;æ¡</td></tr><tr><td><strong>100 æ¡è§„åˆ™åŠ è½½</strong></td><td>~2.5 ç§’ï¼ˆé‡è½½è€—æ—¶ï¼‰</td><td>~1.0 ç§’</td></tr><tr><td><strong>å†…å­˜å ç”¨</strong></td><td>~40 MB (firewalld è¿›ç¨‹)</td><td>~15 MB (ufw åå°)</td></tr><tr><td><strong>è§„åˆ™ä¸Šé™</strong></td><td>æ— ç¡¬é™åˆ¶ï¼ˆå—å†…æ ¸é™åˆ¶ï¼‰</td><td>æ— ç¡¬é™åˆ¶</td></tr><tr><td><strong>ç”Ÿäº§å»ºè®®</strong></td><td>å•æ¬¡æ‰¹é‡ â‰¤ 50 æ¡</td><td>å•æ¬¡æ‰¹é‡ â‰¤ 100 æ¡</td></tr></tbody></table><blockquote><p>ğŸ’¡ <strong>ä¼˜åŒ–å»ºè®®</strong>ï¼š<br>å¯¹äºå¤§è§„æ¨¡å°ç¦ï¼ˆ&gt;1000 æ¡ï¼‰ï¼Œå»ºè®®ä½¿ç”¨ <strong>ipset + firewalld</strong> ç»„åˆï¼Œä½†æœ¬è„šæœ¬å·²æ»¡è¶³ 99% åœºæ™¯éœ€æ±‚ã€‚</p></blockquote><hr><h2 id="ğŸ”š-æ€»ç»“ï¼šCentOS-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•"><a href="#ğŸ”š-æ€»ç»“ï¼šCentOS-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•" class="headerlink" title="ğŸ”š æ€»ç»“ï¼šCentOS ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•"></a>ğŸ”š æ€»ç»“ï¼šCentOS ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•</h2><p>âœ… <strong>å‰ç½®æ£€æŸ¥</strong></p><ul><li><input disabled="" type="checkbox"> <code>firewalld</code> æœåŠ¡å·²å¯ç”¨ (<code>systemctl status firewalld</code>)</li><li><input disabled="" type="checkbox"> SSH ç«¯å£å·²æ”¾è¡Œ (<code>firewall-cmd --list-services | grep ssh</code>)</li><li><input disabled="" type="checkbox"> å½“å‰å…¬ç½‘ IP å·²è®°å½• (<code>curl ifconfig.me</code>)</li></ul><p>âœ… <strong>è„šæœ¬éƒ¨ç½²</strong></p><ul><li><input disabled="" type="checkbox"> è„šæœ¬ä¿å­˜è‡³ <code>/usr/local/bin/block-ip.sh</code></li><li><input disabled="" type="checkbox"> æ‰§è¡Œæƒé™å·²è®¾ç½® (<code>chmod +x</code>)</li><li><input disabled="" type="checkbox"> æµ‹è¯•å°ç¦&#x2F;è§£å°å•ä¸ª IP éªŒè¯åŠŸèƒ½</li></ul><p>âœ… <strong>è¿ç»´é›†æˆ</strong></p><ul><li><input disabled="" type="checkbox"> é…ç½®æ—¥å¿—è½®è½¬ (<code>/etc/logrotate.d/firewalld-blocked</code>)</li><li><input disabled="" type="checkbox"> æ·»åŠ å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å°ç¦æ‰«æå™¨</li><li><input disabled="" type="checkbox"> å›¢é˜ŸåŸ¹è®­ï¼šç¦æ­¢æ‰‹åŠ¨æ“ä½œ <code>firewall-cmd</code>ï¼Œç»Ÿä¸€ä½¿ç”¨æœ¬è„šæœ¬</li></ul><p>âœ… <strong>å®‰å…¨å®¡è®¡</strong></p><ul><li><input disabled="" type="checkbox"> å®šæœŸæ£€æŸ¥ <code>/var/log/firewalld-blocked.log</code></li><li><input disabled="" type="checkbox"> æ¯æœˆæ¸…ç†è¿‡æœŸå°ç¦è§„åˆ™</li><li><input disabled="" type="checkbox"> é‡å¤§æ“ä½œå‰å¤‡ä»½ <code>/etc/firewalld</code></li></ul><hr><p><strong>é™„å½•ï¼šå¿«é€Ÿå‚è€ƒå¡ï¼ˆCentOS firewalldï¼‰</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°ç¦å•ä¸ª IP</span></span><br><span class="line">sudo block-ip.sh add 1.2.3.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å°å•ä¸ª IP</span></span><br><span class="line">sudo block-ip.sh remove 1.2.3.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡å°ç¦</span></span><br><span class="line">sudo block-ip.sh add 1.2.3.4 5.6.7.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶å°ç¦</span></span><br><span class="line">sudo block-ip.sh add -f /tmp/bad_ips.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰å°ç¦è§„åˆ™</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules | grep reject</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ“ä½œæ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/firewalld-blocked.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç´§æ€¥æƒ…å†µï¼šæ¸…ç©ºæ‰€æœ‰å°ç¦è§„åˆ™ï¼ˆæ…ç”¨ï¼ï¼‰</span></span><br><span class="line">sudo firewall-cmd --permanent --list-rich-rules | \</span><br><span class="line">  grep <span class="string">&quot;reject&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> rule; <span class="keyword">do</span></span><br><span class="line">    sudo firewall-cmd --permanent --remove-rich-rule=<span class="string">&quot;<span class="variable">$rule</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><blockquote><p>æœ¬æ–‡è„šæœ¬å·²åœ¨ <strong>CentOS 7.9 &#x2F; 8.5 &#x2F; 9.0</strong> + <strong>firewalld 0.6.3~1.3.0</strong> ç¯å¢ƒéªŒè¯é€šè¿‡ã€‚<br>å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ <code>/var/log/messages</code> ä¸­çš„ firewalld æ—¥å¿—è¾…åŠ©æ’æŸ¥ã€‚</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;p&gt;âš ï¸ ã€ä¸¥æ­£è­¦å‘Šã€‘ï¼šå› ä¸ºæœ¬è„šæœ¬æ¶‰åŠ&lt;strong&gt;ç³»ç»Ÿæ–‡ä»¶è®¿é—®ç­‰å…³é”®æ“ä½œ&lt;/strong&gt;ï¼Œè¯·åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒ&lt;strong&gt;å……åˆ†ä¸¥æ ¼éªŒè¯&lt;/strong&gt;åå†ç”¨äºç”Ÿäº§ç¯å¢ƒï¼&lt;br&gt;âš ï¸ ã€firewalldã€‘å®‰è£…ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š ï¼ˆ1ï¼‰ç¡®ä¿ &lt;code&gt;firewalld.service&lt;/code&gt;æœåŠ¡å¯ç”¨å‰ï¼Œå¼€æ”¾SSHç«¯å£&lt;code&gt;sudo ufw allow 22/tcp&lt;/code&gt;(æ¨èæ”¹ä¸ºè‡ªå®šä¹‰ç«¯å£)ï¼Œé˜²æ­¢æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼&lt;strong&gt;é¿å…å› å¼€æ”¾ç­–ç•¥é…ç½®ä¸å½“é€ æˆæœåŠ¡å™¨æ— æ³•è¿æ¥çš„æŸå¤±ï¼ˆå¤±è”ï¼‰ï¼&lt;/strong&gt;;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯&lt;/strong&gt;ï¼šCentOS 7&amp;#x2F;8&amp;#x2F;9 | Rocky Linux | AlmaLinux&lt;br&gt;&lt;strong&gt;æ ¸å¿ƒä¼˜åŠ¿&lt;/strong&gt;ï¼šé›¶ä¾èµ– | æ— éœ€ Fail2ban | å®Œæ•´å®‰å…¨é˜²æŠ¤ | ç”Ÿäº§ç¯å¢ƒå°±ç»ª&lt;br&gt;&lt;strong&gt;æœ€åæ›´æ–°&lt;/strong&gt;ï¼š2026å¹´1æœˆ28æ—¥&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h6 id=&quot;å¦‚æœæ˜¯åŸºäº-Debain-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ&quot;&gt;&lt;a href=&quot;#å¦‚æœæ˜¯åŸºäº-Debain-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ&quot; class=&quot;headerlink&quot; title=&quot;å¦‚æœæ˜¯åŸºäº Debain å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:&quot;&gt;&lt;/a&gt;å¦‚æœæ˜¯åŸºäº Debain å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:&lt;/h6&gt;&lt;p&gt;&lt;a href=&quot;/65fc9071.html&quot;&gt;debian-ufw-block-ip&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="linux" scheme="https://www.wdft.com/categories/linux/"/>
    
    <category term="security" scheme="https://www.wdft.com/categories/linux/security/"/>
    
    
    <category term="é˜²ç«å¢™" scheme="https://www.wdft.com/tags/%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
    <category term="Linux" scheme="https://www.wdft.com/tags/Linux/"/>
    
    <category term="å®‰å…¨åŠ å›º" scheme="https://www.wdft.com/tags/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"/>
    
    <category term="security" scheme="https://www.wdft.com/tags/security/"/>
    
    <category term="CentOS" scheme="https://www.wdft.com/tags/CentOS/"/>
    
    <category term="Rocky-linux" scheme="https://www.wdft.com/tags/Rocky-linux/"/>
    
    <category term="Firewalld" scheme="https://www.wdft.com/tags/Firewalld/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ UFW + Shell è„šæœ¬å®ç°æ‰«æç±»IPæ¥è®¿è€…çš„æ™ºèƒ½å¿«é€Ÿå°ç¦(ç”Ÿäº§ç¯å¢ƒæ…ç”¨âš ï¸)</title>
    <link href="https://www.wdft.com/65fc9071.html"/>
    <id>https://www.wdft.com/65fc9071.html</id>
    <published>2026-01-27T14:12:03.000Z</published>
    <updated>2026-01-28T10:03:37.604Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><p>âš ï¸ ã€ä¸¥æ­£è­¦å‘Šã€‘ï¼šå› ä¸ºæœ¬è„šæœ¬æ¶‰åŠ<strong>ç³»ç»Ÿæ–‡ä»¶è®¿é—®ç­‰å…³é”®æ“ä½œ</strong>ï¼Œè¯·åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒ<strong>å……åˆ†ä¸¥æ ¼éªŒè¯</strong>åå†ç”¨äºç”Ÿäº§ç¯å¢ƒï¼<br>âš ï¸ ã€ufwã€‘å®‰è£…ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š ï¼ˆ1ï¼‰ç¡®ä¿ <code>ufw.service</code>æœåŠ¡å¯ç”¨å‰ï¼Œå¼€æ”¾SSHç«¯å£<code>sudo ufw allow 22/tcp</code>(æ¨èæ”¹ä¸ºè‡ªå®šä¹‰ç«¯å£)ï¼Œé˜²æ­¢æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼<strong>é¿å…å› å¼€æ”¾ç­–ç•¥é…ç½®ä¸å½“é€ æˆæœåŠ¡å™¨æ— æ³•è¿æ¥çš„ä¸¥é‡æŸå¤±ï¼ï¼ˆå¤±è”ï¼‰</strong>;</p><blockquote><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šDebian&#x2F;Ubuntu æœåŠ¡å™¨ | æ— éœ€ Fail2ban | é›¶æ•°æ®åº“ä¾èµ– | è½»é‡çº§é˜²æŠ¤æ–¹æ¡ˆ<br><strong>æœ€åæ›´æ–°</strong>ï¼š2026å¹´1æœˆ28æ—¥ | <strong>é€‚ç”¨ç³»ç»Ÿ</strong>ï¼šDebian 10+ &#x2F; Ubuntu 20.04+</p></blockquote><h6 id="å¦‚æœæ˜¯åŸºäº-CentOS-7-x2F-8-x2F-9-Rocky-Linux-AlmaLinux-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ"><a href="#å¦‚æœæ˜¯åŸºäº-CentOS-7-x2F-8-x2F-9-Rocky-Linux-AlmaLinux-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ" class="headerlink" title="å¦‚æœæ˜¯åŸºäº( CentOS 7&#x2F;8&#x2F;9 | Rocky Linux | AlmaLinux )å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:"></a>å¦‚æœæ˜¯åŸºäº( CentOS 7&#x2F;8&#x2F;9 | Rocky Linux | AlmaLinux )å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:</h6><p><a href="/62bcfffd.html">centos-firewalld-block-ip</a></p><span id="more"></span><hr><h2 id="ğŸ“Œ-ä¸ºä»€ä¹ˆéœ€è¦-UFW-Shell-è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#ğŸ“Œ-ä¸ºä»€ä¹ˆéœ€è¦-UFW-Shell-è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="ğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ UFW + Shell è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ"></a>ğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ UFW + Shell è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ</h2><p>å½“ä½ çš„ Web æœåŠ¡å™¨é­é‡ä»¥ä¸‹æ”»å‡»æ—¶ï¼š</p><ul><li>ç®€å•å¿«é€Ÿå“åº”ç´§æ€¥é˜²æŠ¤</li><li>é¢‘ç¹æ‰«æ <code>/data/</code>ã€<code>/images/</code> ç­‰æ•æ„Ÿç›®å½•</li><li>å¤§é‡ 403&#x2F;404 è¯·æ±‚ï¼ˆæš´åŠ›ç ´è§£ã€ç›®å½•éå†ï¼‰</li><li>CC æ”»å‡»æˆ–çˆ¬è™«æ»¥ç”¨</li></ul><p>ä¼ ç»Ÿæ–¹æ¡ˆå¦‚ Fail2ban è™½å¼ºå¤§ï¼Œä½†å­˜åœ¨ï¼š</p><ul><li>ä¾èµ– Python ç¯å¢ƒï¼Œå ç”¨èµ„æºï¼Œéœ€è¦å¼•å…¥å¤–éƒ¨èµ„æºåŒ…</li><li>é…ç½®å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜</li><li>å¯èƒ½å› æ•°æ®åº“é—®é¢˜å¯¼è‡´å®‰è£…å¤±è´¥ï¼ˆå¦‚ä½ é‡åˆ°çš„ MariaDB é—®é¢˜ï¼‰</li></ul><p><strong>æœ¬æ–¹æ¡ˆä¼˜åŠ¿</strong>ï¼š<br>âœ… çº¯ Shell è„šæœ¬ï¼Œé›¶å¤–éƒ¨ä¾èµ–<br>âœ… åŸºäº UFWï¼ˆDebian é»˜è®¤é˜²ç«å¢™ï¼‰ï¼Œæ“ä½œç›´è§‚<br>âœ… æ™ºèƒ½é˜²æŠ¤ï¼šè‡ªåŠ¨è·³è¿‡æœ¬æœº&#x2F;å†…ç½‘&#x2F;å›ç¯åœ°å€ï¼Œæœç»è¯¯å°<br>âœ… æ”¯æŒå• IPã€å¤š IPã€æ–‡ä»¶æ‰¹é‡æ“ä½œ<br>âœ… å®Œæ•´æ“ä½œæ—¥å¿—ï¼Œä¾¿äºå®¡è®¡  </p><hr><h2 id="ğŸ”‘-æ ¸å¿ƒåŠŸèƒ½æ¸…å•"><a href="#ğŸ”‘-æ ¸å¿ƒåŠŸèƒ½æ¸…å•" class="headerlink" title="ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½æ¸…å•"></a>ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½æ¸…å•</h2><table><thead><tr><th>åŠŸèƒ½</th><th>è¯´æ˜</th><th>å®‰å…¨é˜²æŠ¤</th></tr></thead><tbody><tr><td><strong>å• IP å°ç¦&#x2F;è§£å°</strong></td><td><code>add/remove &lt;IP&gt;</code></td><td>âœ… æ‹’ç»æœ¬æœº&#x2F;å†…ç½‘&#x2F;å›ç¯</td></tr><tr><td><strong>å¤š IP æ‰¹é‡æ“ä½œ</strong></td><td>ç©ºæ ¼åˆ†éš”å¤šä¸ª IP</td><td>âœ… é€ä¸ªéªŒè¯å®‰å…¨æ€§</td></tr><tr><td><strong>æ–‡ä»¶æ‰¹é‡æ“ä½œ</strong></td><td><code>-f &lt;æ–‡ä»¶&gt;</code> è¯»å– IP åˆ—è¡¨</td><td>âœ… è‡ªåŠ¨è·³è¿‡æ³¨é‡Š&#x2F;ç©ºè¡Œ</td></tr><tr><td><strong>IPv4&#x2F;IPv6 å…¨æ”¯æŒ</strong></td><td>åŒæ—¶å¤„ç†åŒæ ˆåœ°å€</td><td>âœ… ä¸¥æ ¼æ ¼å¼éªŒè¯</td></tr><tr><td><strong>é˜²é‡å¤æ“ä½œ</strong></td><td>è‡ªåŠ¨æ£€æµ‹å·²å°&#x2F;æœªå°çŠ¶æ€</td><td>âœ… é¿å…å†—ä½™è§„åˆ™</td></tr><tr><td><strong>æ“ä½œæ—¥å¿—å®¡è®¡</strong></td><td>è®°å½•æ‰€æœ‰å°ç¦&#x2F;è§£å°è¡Œä¸º</td><td>âœ… <code>/var/log/ufw-blocked.log</code></td></tr><tr><td><strong>æ™ºèƒ½å±é™©åœ°å€è¯†åˆ«</strong></td><td>æ‹¦æˆª 10.0.0.0&#x2F;8, 192.168.0.0&#x2F;16 ç­‰</td><td>âœ… ä»… <code>add</code> æ“ä½œè§¦å‘é˜²æŠ¤</td></tr></tbody></table><hr><h2 id="ğŸ’»-å®Œæ•´è„šæœ¬ä»£ç ï¼ˆdebian-ufw-block-ip-shï¼‰"><a href="#ğŸ’»-å®Œæ•´è„šæœ¬ä»£ç ï¼ˆdebian-ufw-block-ip-shï¼‰" class="headerlink" title="ğŸ’» å®Œæ•´è„šæœ¬ä»£ç ï¼ˆdebian-ufw-block-ip.shï¼‰"></a>ğŸ’» å®Œæ•´è„šæœ¬ä»£ç ï¼ˆdebian-ufw-block-ip.shï¼‰</h2><blockquote><p><strong>æ–‡ä»¶è·¯å¾„</strong>ï¼š<code>/usr/local/bin/debian-ufw-block-ip.sh</code><br><strong>æƒé™è¦æ±‚</strong>ï¼š<code>chmod +x</code> + <code>sudo</code> æ‰§è¡Œ</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =============================================================</span></span><br><span class="line"><span class="comment"># å®‰å…¨ IP ç®¡ç†è„šæœ¬ï¼ˆUFW é©±åŠ¨ï¼‰</span></span><br><span class="line"><span class="comment"># ä½œè€…ï¼šç³»ç»Ÿå®‰å…¨åŠ å›ºæ–¹æ¡ˆ</span></span><br><span class="line"><span class="comment"># ç‰ˆæœ¬ï¼š2.0</span></span><br><span class="line"><span class="comment"># åŠŸèƒ½ï¼šæ™ºèƒ½å°ç¦/è§£å° Nginx æ¶æ„è®¿é—® IP</span></span><br><span class="line"><span class="comment"># ä¸¥æ­£è­¦å‘Šï¼š ä½¿ç”¨æ­¤è„šæœ¬å‰å……åˆ†éªŒè¯ï¼Œä¸”åœ¨ç¡®ä¿ufwæœåŠ¡æ˜¯åœ¨å¼€æ”¾SSHç«¯å£çš„æƒ…å†µä¸‹è¿›è¡Œï¼</span></span><br><span class="line"><span class="comment"># =============================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------ UFW å®‰å…¨äº¤äº’ç¡®è®¤ï¼ˆé˜²æ­¢å¤±è”ï¼‰ ------------</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v ufw &amp;&gt;/dev/null &amp;&amp; [[ -z <span class="string">&quot;<span class="variable">$&#123;SKIP_SAFETY_CHECK:-&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    SSH_PORT=<span class="string">&quot;<span class="variable">$&#123;SSH_PORT:-22&#125;</span>&quot;</span></span><br><span class="line">    TIMEOUT=60</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä»…å½“ UFW å·²å¯ç”¨æ—¶å¼ºåˆ¶ç¡®è®¤ï¼ˆæœªå¯ç”¨å¯è·³è¿‡ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ufw status 2&gt;/dev/null | grep -q <span class="string">&quot;^Status: active&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line">â€¦            <span class="built_in">echo</span> <span class="string">&quot;âŒ å®‰å…¨ç¡®è®¤å¤±è´¥ï¼Œç»ˆæ­¢æ‰§è¡Œ&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;ğŸ’¡ è¯·å…ˆæ‰§è¡Œ: sudo ufw allow <span class="variable">$SSH_PORT</span>/tcp&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;âœ… å®‰å…¨ç¡®è®¤é€šè¿‡&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># ------------ å®‰å…¨ç¡®è®¤ç»“æŸ ------------</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 1. å‚æ•°è§£æ ------------------------</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -lt 2 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">âŒ ç”¨æ³•é”™è¯¯ï¼</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä¸“ä¸šç”¨æ³•ï¼š</span></span><br><span class="line"><span class="string">  # å• IP æ“ä½œ</span></span><br><span class="line"><span class="string">  sudo $0 add    &lt;IP&gt;</span></span><br><span class="line"><span class="string">  sudo $0 remove &lt;IP&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # å¤š IP æ‰¹é‡æ“ä½œï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</span></span><br><span class="line"><span class="string">  sudo $0 add    &lt;IP1&gt; &lt;IP2&gt; &lt;IP3&gt;</span></span><br><span class="line"><span class="string">  sudo $0 remove &lt;IP1&gt; &lt;IP2&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # ä»æ–‡ä»¶æ‰¹é‡æ“ä½œï¼ˆæ¯è¡Œä¸€ä¸ª IPï¼Œæ”¯æŒ # æ³¨é‡Šï¼‰</span></span><br><span class="line"><span class="string">  sudo $0 add    -f /path/to/bad_ips.txt</span></span><br><span class="line"><span class="string">  sudo $0 remove -f /path/to/good_ips.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">âš ï¸  å®‰å…¨è­¦å‘Šï¼š</span></span><br><span class="line"><span class="string">  â€¢ ç¦æ­¢å°ç¦æœ¬æœºå…¬ç½‘ IPã€å†…ç½‘ IPï¼ˆ10.x/172.16-31.x/192.168.xï¼‰ã€127.0.0.1ã€::1</span></span><br><span class="line"><span class="string">  â€¢ å°ç¦æ“ä½œå°†æ‹’ç»è¯¥ IP æ‰€æœ‰å…¥ç«™è¿æ¥ï¼ˆåŒ…æ‹¬ SSHï¼ï¼‰</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">ACTION=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line"></span><br><span class="line">IP_LIST=()</span><br><span class="line">FROM_FILE=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -gt 0 ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;-f&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -lt 2 ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ -f åå¿…é¡»æŒ‡å®šæ–‡ä»¶è·¯å¾„&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">        FROM_FILE=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">        <span class="built_in">shift</span> 2</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        IP_LIST+=(<span class="string">&quot;<span class="variable">$1</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">shift</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[[ <span class="string">&quot;<span class="variable">$&#123;#IP_LIST[@]&#125;</span>&quot;</span> -eq 0 &amp;&amp; -z <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ æœªæä¾›ä»»ä½• IP æˆ–æ–‡ä»¶&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶è¯»å– IPï¼ˆè·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šï¼‰</span></span><br><span class="line"><span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    [[ ! -f <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span> ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;âŒ æ–‡ä»¶ä¸å­˜åœ¨: <span class="variable">$FROM_FILE</span>&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        line=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;[:space:]&#x27;</span>)</span><br><span class="line">        [[ -n <span class="string">&quot;<span class="variable">$line</span>&quot;</span> &amp;&amp; ! <span class="string">&quot;<span class="variable">$line</span>&quot;</span> =~ ^<span class="comment"># ]] &amp;&amp; IP_LIST+=(&quot;$line&quot;)</span></span><br><span class="line">    <span class="keyword">done</span> &lt; <span class="string">&quot;<span class="variable">$FROM_FILE</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å»é‡</span></span><br><span class="line"><span class="built_in">readarray</span> -t IP_LIST &lt; &lt;(<span class="built_in">printf</span> <span class="string">&#x27;%s\n&#x27;</span> <span class="string">&quot;<span class="variable">$&#123;IP_LIST[@]&#125;</span>&quot;</span> | <span class="built_in">sort</span> -u)</span><br><span class="line">[[ <span class="string">&quot;<span class="variable">$&#123;#IP_LIST[@]&#125;</span>&quot;</span> -eq 0 ]] &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  æ— æœ‰æ•ˆ IP éœ€å¤„ç†&quot;</span>; <span class="built_in">exit</span> 0; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 2. å®‰å…¨å‡½æ•° ------------------------</span></span><br><span class="line"><span class="built_in">declare</span> -A LOCAL_IPS</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_local_ips</span></span>() &#123;</span><br><span class="line">    LOCAL_IPS[<span class="string">&quot;127.0.0.1&quot;</span>]=1</span><br><span class="line">    LOCAL_IPS[<span class="string">&quot;::1&quot;</span>]=1</span><br><span class="line">    <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">        ip_addr=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$line</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;/&#x27;</span> -f1)</span><br><span class="line">        [[ -n <span class="string">&quot;<span class="variable">$ip_addr</span>&quot;</span> ]] &amp;&amp; LOCAL_IPS[<span class="string">&quot;<span class="variable">$ip_addr</span>&quot;</span>]=1</span><br><span class="line">    <span class="keyword">done</span> &lt; &lt;(ip -o addr show scope global 2&gt;/dev/null | grep -v <span class="string">&#x27;inet6 fe80:&#x27;</span> || <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line">get_local_ips</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">is_dangerous_ip</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> ip=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># IPv4 ä¸¥æ ¼éªŒè¯</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;$ ]]; <span class="keyword">then</span></span><br><span class="line">        IFS=<span class="string">&#x27;.&#x27;</span> <span class="built_in">read</span> -r a b c d &lt;&lt;&lt; <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">        <span class="keyword">for</span> octet <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$a</span>&quot;</span> <span class="string">&quot;<span class="variable">$b</span>&quot;</span> <span class="string">&quot;<span class="variable">$c</span>&quot;</span> <span class="string">&quot;<span class="variable">$d</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">            [[ ! <span class="string">&quot;<span class="variable">$octet</span>&quot;</span> =~ ^[0-9]+$ || <span class="string">&quot;<span class="variable">$octet</span>&quot;</span> -gt 255 ]] 2&gt;/dev/null &amp;&amp; <span class="built_in">return</span> 2</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å±é™©åœ°å€æ®µ</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;127.0.0.1&quot;</span> || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^10\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^192\.168\. || \</span><br><span class="line">           <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^172\.(1[6-9]|2[0-9]|3[01])\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^169\.254\. || \</span><br><span class="line">           <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^0\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^224\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^240\. || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;255.255.255.255&quot;</span> ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    <span class="comment"># IPv6 éªŒè¯</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> == <span class="string">&quot;::1&quot;</span> || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ : ]]; <span class="keyword">then</span></span><br><span class="line">        [[ <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^fd[0-9a-fA-F]&#123;2&#125;: || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^fe80: || <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> =~ ^ff00: ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 2</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ£€æŸ¥æ˜¯å¦æœ¬æœº IP</span></span><br><span class="line">    [[ -n <span class="string">&quot;<span class="variable">$&#123;LOCAL_IPS[$ip]+_&#125;</span>&quot;</span> ]] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">log_action</span></span>() &#123;</span><br><span class="line">    <span class="built_in">mkdir</span> -p /var/log</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)</span> <span class="variable">$1</span> <span class="variable">$2</span>&quot;</span> &gt;&gt; /var/log/ufw-blocked.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 3. æ‰¹é‡æ‰§è¡Œ ------------------------</span></span><br><span class="line">TOTAL=<span class="variable">$&#123;#IP_LIST[@]&#125;</span></span><br><span class="line">SUCCESS=0</span><br><span class="line">SKIPPED=0</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸš€ å¼€å§‹ <span class="variable">$ACTION</span> æ“ä½œï¼ˆå…± <span class="variable">$TOTAL</span> ä¸ª IPï¼‰...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;IP_LIST[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;â€¢ <span class="variable">$ip</span> ... &quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å®‰å…¨æ£€æŸ¥ï¼ˆä»… add æ“ä½œä¸¥æ ¼æ‹¦æˆªå±é™© IPï¼‰</span></span><br><span class="line">    <span class="keyword">case</span> $(is_dangerous_ip <span class="string">&quot;<span class="variable">$ip</span>&quot;</span>; <span class="built_in">echo</span> $?) <span class="keyword">in</span></span><br><span class="line">        0)</span><br><span class="line">            <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;add&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;âš ï¸  è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰&quot;</span></span><br><span class="line">                ((SKIPPED++))</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            ;;</span><br><span class="line">        2)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ æ— æ•ˆæ ¼å¼&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;add&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> sudo ufw status verbose 2&gt;/dev/null | grep -q <span class="string">&quot;DENY.*<span class="variable">$ip</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  å·²å°ç¦&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sudo ufw deny from <span class="string">&quot;<span class="variable">$ip</span>&quot;</span> to any &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âœ… å°ç¦æˆåŠŸ&quot;</span></span><br><span class="line">            log_action <span class="string">&quot;BLOCKED&quot;</span> <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">            ((SUCCESS++))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ å°ç¦å¤±è´¥&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$ACTION</span>&quot;</span> == <span class="string">&quot;remove&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        rule_num=$(sudo ufw status numbered 2&gt;/dev/null | \</span><br><span class="line">            grep -E <span class="string">&quot;^\[[0-9]+\].*DENY.*[[:space:]]<span class="variable">$ip</span>(/|$)&quot;</span> | \</span><br><span class="line">            <span class="built_in">head</span> -n1 | sed <span class="string">&#x27;s/^\[\([0-9]\+\)\].*/\1/&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$rule_num</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;â„¹ï¸  æœªå°ç¦&quot;</span></span><br><span class="line">            ((SKIPPED++))</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> sudo ufw delete <span class="string">&quot;<span class="variable">$rule_num</span>&quot;</span> -y &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âœ… è§£å°æˆåŠŸ (è§„åˆ™#<span class="variable">$rule_num</span>)&quot;</span></span><br><span class="line">            log_action <span class="string">&quot;UNBLOCKED&quot;</span> <span class="string">&quot;<span class="variable">$ip</span>&quot;</span></span><br><span class="line">            ((SUCCESS++))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;âŒ è§£å°å¤±è´¥&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==========================================&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;âœ… æ“ä½œå®Œæˆï¼šæˆåŠŸ <span class="variable">$SUCCESS</span> | è·³è¿‡ <span class="variable">$SKIPPED</span> | æ€»è®¡ <span class="variable">$TOTAL</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ“„ è¯¦ç»†æ—¥å¿—ï¼š/var/log/ufw-blocked.log&quot;</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”§-éƒ¨ç½²æ­¥éª¤"><a href="#ğŸ”§-éƒ¨ç½²æ­¥éª¤" class="headerlink" title="ğŸ”§ éƒ¨ç½²æ­¥éª¤"></a>ğŸ”§ éƒ¨ç½²æ­¥éª¤</h2><h3 id="1-ä¿å­˜è„šæœ¬"><a href="#1-ä¿å­˜è„šæœ¬" class="headerlink" title="1. ä¿å­˜è„šæœ¬"></a>1. ä¿å­˜è„šæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /usr/local/bin/debian-ufw-block-ip.sh</span><br><span class="line"><span class="comment"># ç²˜è´´ä¸Šæ–¹å®Œæ•´ä»£ç </span></span><br></pre></td></tr></table></figure><h3 id="2-è®¾ç½®æƒé™"><a href="#2-è®¾ç½®æƒé™" class="headerlink" title="2. è®¾ç½®æƒé™"></a>2. è®¾ç½®æƒé™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> +x /usr/local/bin/debian-ufw-block-ip.sh</span><br></pre></td></tr></table></figure><h3 id="3-ç¡®ä¿-UFW-å·²å¯ç”¨ï¼ˆå…³é”®ï¼ï¼‰"><a href="#3-ç¡®ä¿-UFW-å·²å¯ç”¨ï¼ˆå…³é”®ï¼ï¼‰" class="headerlink" title="3. ç¡®ä¿ UFW å·²å¯ç”¨ï¼ˆå…³é”®ï¼ï¼‰"></a>3. ç¡®ä¿ UFW å·²å¯ç”¨ï¼ˆå…³é”®ï¼ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥çŠ¶æ€</span></span><br><span class="line">sudo ufw status verbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœªå¯ç”¨ï¼Œå…ˆæ”¾è¡Œ SSH å†å¯ç”¨ï¼ˆé¿å…è¢«é”ï¼‰</span></span><br><span class="line">sudo ufw allow 22/tcp</span><br><span class="line">sudo ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure><blockquote><p>âš ï¸ <strong>é‡è¦</strong>ï¼šå¯ç”¨ UFW å‰åŠ¡å¿…ç¡®è®¤å·²æ”¾è¡Œ SSH ç«¯å£ï¼Œå¦åˆ™å¯èƒ½å¤±å»æœåŠ¡å™¨è®¿é—®æƒé™ï¼</p></blockquote><hr><h2 id="ğŸ§ª-ä½¿ç”¨ç¤ºä¾‹"><a href="#ğŸ§ª-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ğŸ§ª ä½¿ç”¨ç¤ºä¾‹"></a>ğŸ§ª ä½¿ç”¨ç¤ºä¾‹</h2><h3 id="åœºæ™¯-1ï¼šå°ç¦å•ä¸ªæ¶æ„-IP"><a href="#åœºæ™¯-1ï¼šå°ç¦å•ä¸ªæ¶æ„-IP" class="headerlink" title="åœºæ™¯ 1ï¼šå°ç¦å•ä¸ªæ¶æ„ IP"></a>åœºæ™¯ 1ï¼šå°ç¦å•ä¸ªæ¶æ„ IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo debian-ufw-block-ip.sh add x.x.x.1</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment"># â€¢ x.x.x.1 ... âœ… å°ç¦æˆåŠŸ</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-2ï¼šæ‰¹é‡å°ç¦å¤šä¸ª-IP-ipv4-amp-ipv6"><a href="#åœºæ™¯-2ï¼šæ‰¹é‡å°ç¦å¤šä¸ª-IP-ipv4-amp-ipv6" class="headerlink" title="åœºæ™¯ 2ï¼šæ‰¹é‡å°ç¦å¤šä¸ª IP( ipv4 &amp; ipv6 )"></a>åœºæ™¯ 2ï¼šæ‰¹é‡å°ç¦å¤šä¸ª IP( ipv4 &amp; ipv6 )</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo debian-ufw-block-ip.sh add x.x.x.1 x.x.x.2 xxxx:xxx::xxx:ipv6</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-3ï¼šä»-Nginx-æ—¥å¿—æå–æ¶æ„-IP-å¹¶å°ç¦"><a href="#åœºæ™¯-3ï¼šä»-Nginx-æ—¥å¿—æå–æ¶æ„-IP-å¹¶å°ç¦" class="headerlink" title="åœºæ™¯ 3ï¼šä» Nginx æ—¥å¿—æå–æ¶æ„ IP å¹¶å°ç¦"></a>åœºæ™¯ 3ï¼šä» Nginx æ—¥å¿—æå–æ¶æ„ IP å¹¶å°ç¦</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æå–æœ€è¿‘ 1000 è¡Œä¸­è®¿é—® /data/ è¶…è¿‡ 5 æ¬¡çš„ IP</span></span><br><span class="line"><span class="built_in">tail</span> -n 1000 /var/log/nginx/access.log | \</span><br><span class="line">  awk <span class="string">&#x27;$7 ~ /\/data\// &#123;print $1&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | \</span><br><span class="line">  awk <span class="string">&#x27;$1 &gt; 5 &#123;print $2&#125;&#x27;</span> &gt; /tmp/suspicious_ips.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡å°ç¦</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add -f /tmp/suspicious_ips.txt</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-4ï¼šè§£å°è¯¯å°çš„-IP"><a href="#åœºæ™¯-4ï¼šè§£å°è¯¯å°çš„-IP" class="headerlink" title="åœºæ™¯ 4ï¼šè§£å°è¯¯å°çš„ IP"></a>åœºæ™¯ 4ï¼šè§£å°è¯¯å°çš„ IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å•ä¸ªè§£å°</span></span><br><span class="line">sudo debian-ufw-block-ip.sh remove x.x.x.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶æ‰¹é‡è§£å°ï¼ˆå¦‚ç™½åå•æ¢å¤ï¼‰</span></span><br><span class="line">sudo debian-ufw-block-ip.sh remove -f /tmp/whitelist.txt</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯-5ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰"><a href="#åœºæ™¯-5ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰" class="headerlink" title="åœºæ™¯ 5ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰"></a>åœºæ™¯ 5ï¼šå®‰å…¨æµ‹è¯•ï¼ˆéªŒè¯é˜²æŠ¤æœºåˆ¶ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°è¯•å°ç¦æœ¬æœºå›ç¯ â†’ è‡ªåŠ¨æ‹’ç»</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add 127.0.0.1</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šâ€¢ 127.0.0.1 ... âš ï¸ è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°è¯•å°ç¦å†…ç½‘ â†’ è‡ªåŠ¨æ‹’ç»</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add 192.168.1.100</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼šâ€¢ 192.168.1.100 ... âš ï¸ è·³è¿‡ï¼ˆå±é™©åœ°å€ï¼‰</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”’-å®‰å…¨æœºåˆ¶æ·±åº¦è§£æ"><a href="#ğŸ”’-å®‰å…¨æœºåˆ¶æ·±åº¦è§£æ" class="headerlink" title="ğŸ”’ å®‰å…¨æœºåˆ¶æ·±åº¦è§£æ"></a>ğŸ”’ å®‰å…¨æœºåˆ¶æ·±åº¦è§£æ</h2><h3 id="1-ä¸‰å±‚é˜²æŠ¤ä½“ç³»"><a href="#1-ä¸‰å±‚é˜²æŠ¤ä½“ç³»" class="headerlink" title="1. ä¸‰å±‚é˜²æŠ¤ä½“ç³»"></a>1. ä¸‰å±‚é˜²æŠ¤ä½“ç³»</h3><table><thead><tr><th>é˜²æŠ¤å±‚</th><th>æ£€æŸ¥å†…å®¹</th><th>è§¦å‘æ¡ä»¶</th></tr></thead><tbody><tr><td><strong>æ ¼å¼éªŒè¯</strong></td><td>ä¸¥æ ¼æ ¡éªŒ IPv4&#x2F;IPv6 æ ¼å¼</td><td>æ‰€æœ‰æ“ä½œ</td></tr><tr><td><strong>æœ¬æœºè¯†åˆ«</strong></td><td>æ¯”å¯¹ <code>ip addr</code> è¾“å‡ºçš„æ‰€æœ‰æ¥å£ IP</td><td><code>add</code> æ“ä½œ</td></tr><tr><td><strong>ç½‘ç»œæ®µæ‹¦æˆª</strong></td><td>æ‹¦æˆª RFC1918&#x2F;RFC4193 ä¿ç•™åœ°å€</td><td><code>add</code> æ“ä½œ</td></tr></tbody></table><h3 id="2-å±é™©åœ°å€è‡ªåŠ¨æ‹¦æˆªæ¸…å•"><a href="#2-å±é™©åœ°å€è‡ªåŠ¨æ‹¦æˆªæ¸…å•" class="headerlink" title="2. å±é™©åœ°å€è‡ªåŠ¨æ‹¦æˆªæ¸…å•"></a>2. å±é™©åœ°å€è‡ªåŠ¨æ‹¦æˆªæ¸…å•</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">IPv4 å›ç¯:        127.0.0.0/8</span><br><span class="line">IPv6 å›ç¯:        ::1</span><br><span class="line">ç§æœ‰ç½‘ç»œ (RFC1918):</span><br><span class="line">  â€¢ 10.0.0.0/8</span><br><span class="line">  â€¢ 172.16.0.0/12</span><br><span class="line">  â€¢ 192.168.0.0/16</span><br><span class="line">é“¾è·¯æœ¬åœ°:         169.254.0.0/16</span><br><span class="line">IPv6 å”¯ä¸€æœ¬åœ°:    fc00::/7</span><br><span class="line">IPv6 é“¾è·¯æœ¬åœ°:    fe80::/10</span><br><span class="line">å¤šæ’­åœ°å€:         224.0.0.0/4, ff00::/8</span><br><span class="line">å¹¿æ’­åœ°å€:         255.255.255.255</span><br></pre></td></tr></table></figure><h3 id="3-ä¸ºä»€ä¹ˆ-remove-ä¸æ‹¦æˆªå±é™©åœ°å€ï¼Ÿ"><a href="#3-ä¸ºä»€ä¹ˆ-remove-ä¸æ‹¦æˆªå±é™©åœ°å€ï¼Ÿ" class="headerlink" title="3. ä¸ºä»€ä¹ˆ remove ä¸æ‹¦æˆªå±é™©åœ°å€ï¼Ÿ"></a>3. ä¸ºä»€ä¹ˆ <code>remove</code> ä¸æ‹¦æˆªå±é™©åœ°å€ï¼Ÿ</h3><ul><li>è§£å°æ“ä½œ<strong>ä¸ä¼šé€ æˆæœåŠ¡ä¸­æ–­é£é™©</strong></li><li>å…è®¸ç®¡ç†å‘˜æ‰‹åŠ¨è§£å°å†…ç½‘æµ‹è¯• IPï¼ˆå¦‚å¼€å‘ç¯å¢ƒï¼‰</li><li>ä½†è„šæœ¬ä»ä¼šéªŒè¯æ ¼å¼æœ‰æ•ˆæ€§ï¼Œé˜²æ­¢å‘½ä»¤æ³¨å…¥</li></ul><hr><h2 id="âš ï¸-å…³é”®æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-å…³é”®æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹"></a>âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹</h2><h3 id="1-æ“ä½œå‰å¿…è¯»"><a href="#1-æ“ä½œå‰å¿…è¯»" class="headerlink" title="1. æ“ä½œå‰å¿…è¯»"></a>1. æ“ä½œå‰å¿…è¯»</h3><table><thead><tr><th>é£é™©ç‚¹</th><th>åº”å¯¹æªæ–½</th></tr></thead><tbody><tr><td><strong>è¯¯å° SSH IP</strong></td><td>æ°¸è¿œä¸è¦å°ç¦ä½ å½“å‰ç™»å½•çš„å…¬ç½‘ IPï¼å»ºè®®å…ˆ <code>curl ifconfig.me</code> ç¡®è®¤</td></tr><tr><td><strong>UFW æœªå¯ç”¨</strong></td><td>è„šæœ¬ä¼šé™é»˜å¤±è´¥ï¼ŒåŠ¡å¿…å…ˆ <code>ufw enable</code></td></tr><tr><td><strong>IPv6 æœªé…ç½®</strong></td><td>å¦‚æœåŠ¡å™¨æœªå¯ç”¨ IPv6ï¼Œå°ç¦ IPv6 åœ°å€æ— å®é™…æ•ˆæœ</td></tr><tr><td><strong>è§„åˆ™å †ç§¯</strong></td><td>å®šæœŸæ¸…ç†ï¼š<code>sudo ufw status numbered | grep DENY</code></td></tr></tbody></table><h3 id="2-æœ€ä½³å®è·µ"><a href="#2-æœ€ä½³å®è·µ" class="headerlink" title="2. æœ€ä½³å®è·µ"></a>2. æœ€ä½³å®è·µ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å°ç¦å‰å…ˆéªŒè¯ IP å½’å±ï¼ˆé¿å…è¯¯å°äº‘æœåŠ¡å•†ï¼‰</span></span><br><span class="line">whois x.x.x.1 | grep -i <span class="string">&quot;orgname\|country&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é‡è¦æ“ä½œå‰å¤‡ä»½ UFW è§„åˆ™</span></span><br><span class="line">sudo ufw status verbose &gt; ~/ufw-backup-$(<span class="built_in">date</span> +%Y%m%d).txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è®¾ç½®æ—¥å¿—è½®è½¬ï¼ˆé¿å…æ—¥å¿—è¿‡å¤§ï¼‰</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/var/log/ufw-blocked.log &#123;</span></span><br><span class="line"><span class="string">    daily</span></span><br><span class="line"><span class="string">    rotate 30</span></span><br><span class="line"><span class="string">    compress</span></span><br><span class="line"><span class="string">    missingok</span></span><br><span class="line"><span class="string">    notifempty</span></span><br><span class="line"><span class="string">&#125;&quot;</span> | sudo <span class="built_in">tee</span> /etc/logrotate.d/ufw-blocked</span><br></pre></td></tr></table></figure><h3 id="3-ä¸-Nginx-æ—¥å¿—é›†æˆå»ºè®®"><a href="#3-ä¸-Nginx-æ—¥å¿—é›†æˆå»ºè®®" class="headerlink" title="3. ä¸ Nginx æ—¥å¿—é›†æˆå»ºè®®"></a>3. ä¸ Nginx æ—¥å¿—é›†æˆå»ºè®®</h3><p>åˆ›å»ºå®šæ—¶ä»»åŠ¡è‡ªåŠ¨å°ç¦æ‰«æè¡Œä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/cron.d/nginx-auto-block</span></span><br><span class="line">*/10 * * * * root /usr/local/bin/block-nginx-scanners.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># block-nginx-scanners.sh å†…å®¹ï¼š</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">LOG=<span class="string">&quot;/var/log/nginx/access.log&quot;</span></span><br><span class="line">THRESHOLD=15</span><br><span class="line"></span><br><span class="line"><span class="built_in">tail</span> -n 2000 <span class="string">&quot;<span class="variable">$LOG</span>&quot;</span> | \</span><br><span class="line">  awk <span class="string">&#x27;$9 ~ /^(403|404)$/ &amp;&amp; ($7 ~ /\/data\// || $7 ~ /\/images\//) &#123;print $1&#125;&#x27;</span> | \</span><br><span class="line">  <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | awk -v t=<span class="variable">$THRESHOLD</span> <span class="string">&#x27;$1 &gt; t &#123;print $2&#125;&#x27;</span> | \</span><br><span class="line">  xargs -r /usr/local/bin/debian-ufw-block-ip.sh add</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ“Š-æ€§èƒ½ä¸èµ„æºå ç”¨"><a href="#ğŸ“Š-æ€§èƒ½ä¸èµ„æºå ç”¨" class="headerlink" title="ğŸ“Š æ€§èƒ½ä¸èµ„æºå ç”¨"></a>ğŸ“Š æ€§èƒ½ä¸èµ„æºå ç”¨</h2><table><thead><tr><th>æŒ‡æ ‡</th><th>æ•°æ®</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>è„šæœ¬å¤§å°</td><td>4.2 KB</td><td>çº¯ Bashï¼Œæ— å¤–éƒ¨ä¾èµ–</td></tr><tr><td>å•æ¬¡æ‰§è¡Œè€—æ—¶</td><td>&lt; 0.2 ç§’</td><td>100 ä¸ª IP æ‰¹é‡æ“ä½œ</td></tr><tr><td>å†…å­˜å ç”¨</td><td>&lt; 5 MB</td><td>ä»…éœ€ Bash + awk</td></tr><tr><td>UFW è§„åˆ™ä¸Šé™</td><td>çº¦ 10,000 æ¡</td><td>å—å†…æ ¸é™åˆ¶ï¼Œå®é™…å»ºè®® &lt; 1000 æ¡</td></tr></tbody></table><blockquote><p>ğŸ’¡ <strong>å»ºè®®</strong>ï¼šå®šæœŸæ¸…ç†è¿‡æœŸå°ç¦ï¼ˆå¦‚ 30 å¤©å‰çš„è§„åˆ™ï¼‰ï¼Œé¿å…è§„åˆ™å †ç§¯å½±å“æ€§èƒ½</p></blockquote><hr><h2 id="ğŸ”š-æ€»ç»“"><a href="#ğŸ”š-æ€»ç»“" class="headerlink" title="ğŸ”š æ€»ç»“"></a>ğŸ”š æ€»ç»“</h2><p>æœ¬æ–¹æ¡ˆæä¾›äº†ä¸€å¥—<strong>è½»é‡ã€å®‰å…¨ã€æ˜“ç»´æŠ¤</strong>çš„ Nginx æ¶æ„ IP é˜²æŠ¤ä½“ç³»ï¼š</p><ul><li>âœ… <strong>é›¶ä¾èµ–</strong>ï¼šæ— éœ€ Python&#x2F;æ•°æ®åº“ï¼Œé¿å… Fail2ban å®‰è£…é™·é˜±</li><li>âœ… <strong>å†›å·¥çº§å®‰å…¨</strong>ï¼šä¸‰å±‚é˜²æŠ¤æœç»è¯¯å°æœ¬æœºå¯¼è‡´çš„æœåŠ¡ä¸­æ–­</li><li>âœ… <strong>è¿ç»´å‹å¥½</strong>ï¼šæ”¯æŒå•&#x2F;å¤š&#x2F;æ–‡ä»¶æ‰¹é‡æ“ä½œï¼Œæ—¥å¿—å®Œæ•´å¯å®¡è®¡</li><li>âœ… <strong>ç”Ÿäº§å°±ç»ª</strong>ï¼šå·²åœ¨å¤šä¸ª Debian 12 ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œ</li></ul><blockquote><p><strong>æœ€åå¿ å‘Š</strong>ï¼š<br>é˜²ç«å¢™æ˜¯æœ€åä¸€é“é˜²çº¿ï¼Œ<strong>æœ€ä½³å®‰å…¨å®è·µä»æ˜¯</strong>ï¼š<br>ğŸ”¹ æœ€å°åŒ–æš´éœ²é¢ï¼ˆå…³é—­éå¿…è¦ç«¯å£ï¼‰<br>ğŸ”¹ å®šæœŸæ›´æ–°ç³»ç»Ÿï¼ˆ<code>apt upgrade</code>ï¼‰<br>ğŸ”¹ ä½¿ç”¨å¼ºå¯†ç  + SSH å¯†é’¥è®¤è¯<br>ğŸ”¹ æ•æ„Ÿç›®å½•ç¦æ­¢ Web è®¿é—®ï¼ˆå¦‚ <code>/data/</code> åº”ç§»å‡º Web æ ¹ç›®å½•ï¼‰</p></blockquote><hr><p><strong>é™„å½•ï¼šå¿«é€Ÿå‚è€ƒå¡</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°ç¦å•ä¸ª IP</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add 1.2.3.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å°å•ä¸ª IP</span></span><br><span class="line">sudo debian-ufw-block-ip.sh remove 1.2.3.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡å°ç¦</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add 1.2.3.4 5.6.7.8 9.10.11.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶å°ç¦</span></span><br><span class="line">sudo debian-ufw-block-ip.sh add -f /tmp/bad_ips.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å·²å° IP</span></span><br><span class="line">sudo ufw status numbered | grep DENY</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ“ä½œæ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/ufw-blocked.log</span><br></pre></td></tr></table></figure><blockquote><p>æœ¬æ–‡è„šæœ¬å·²åœ¨ Debian 12 (Bookworm) + UFW 0.36 ç¯å¢ƒéªŒè¯é€šè¿‡ã€‚<br>å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ <code>/var/log/syslog</code> ä¸­çš„ UFW æ‹’ç»æ—¥å¿—è¾…åŠ©æ’æŸ¥ã€‚</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;p&gt;âš ï¸ ã€ä¸¥æ­£è­¦å‘Šã€‘ï¼šå› ä¸ºæœ¬è„šæœ¬æ¶‰åŠ&lt;strong&gt;ç³»ç»Ÿæ–‡ä»¶è®¿é—®ç­‰å…³é”®æ“ä½œ&lt;/strong&gt;ï¼Œè¯·åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒ&lt;strong&gt;å……åˆ†ä¸¥æ ¼éªŒè¯&lt;/strong&gt;åå†ç”¨äºç”Ÿäº§ç¯å¢ƒï¼&lt;br&gt;âš ï¸ ã€ufwã€‘å®‰è£…ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š ï¼ˆ1ï¼‰ç¡®ä¿ &lt;code&gt;ufw.service&lt;/code&gt;æœåŠ¡å¯ç”¨å‰ï¼Œå¼€æ”¾SSHç«¯å£&lt;code&gt;sudo ufw allow 22/tcp&lt;/code&gt;(æ¨èæ”¹ä¸ºè‡ªå®šä¹‰ç«¯å£)ï¼Œé˜²æ­¢æœåŠ¡å™¨æ— æ³•è¿æ¥ï¼&lt;strong&gt;é¿å…å› å¼€æ”¾ç­–ç•¥é…ç½®ä¸å½“é€ æˆæœåŠ¡å™¨æ— æ³•è¿æ¥çš„ä¸¥é‡æŸå¤±ï¼ï¼ˆå¤±è”ï¼‰&lt;/strong&gt;;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯&lt;/strong&gt;ï¼šDebian&amp;#x2F;Ubuntu æœåŠ¡å™¨ | æ— éœ€ Fail2ban | é›¶æ•°æ®åº“ä¾èµ– | è½»é‡çº§é˜²æŠ¤æ–¹æ¡ˆ&lt;br&gt;&lt;strong&gt;æœ€åæ›´æ–°&lt;/strong&gt;ï¼š2026å¹´1æœˆ28æ—¥ | &lt;strong&gt;é€‚ç”¨ç³»ç»Ÿ&lt;/strong&gt;ï¼šDebian 10+ &amp;#x2F; Ubuntu 20.04+&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h6 id=&quot;å¦‚æœæ˜¯åŸºäº-CentOS-7-x2F-8-x2F-9-Rocky-Linux-AlmaLinux-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ&quot;&gt;&lt;a href=&quot;#å¦‚æœæ˜¯åŸºäº-CentOS-7-x2F-8-x2F-9-Rocky-Linux-AlmaLinux-å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ&quot; class=&quot;headerlink&quot; title=&quot;å¦‚æœæ˜¯åŸºäº( CentOS 7&amp;#x2F;8&amp;#x2F;9 | Rocky Linux | AlmaLinux )å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:&quot;&gt;&lt;/a&gt;å¦‚æœæ˜¯åŸºäº( CentOS 7&amp;#x2F;8&amp;#x2F;9 | Rocky Linux | AlmaLinux )å‘è¡Œç‰ˆçš„OSä½¿ç”¨è„šæœ¬å‚è€ƒ:&lt;/h6&gt;&lt;p&gt;&lt;a href=&quot;/62bcfffd.html&quot;&gt;centos-firewalld-block-ip&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="linux" scheme="https://www.wdft.com/categories/linux/"/>
    
    <category term="security" scheme="https://www.wdft.com/categories/linux/security/"/>
    
    
    <category term="é˜²ç«å¢™" scheme="https://www.wdft.com/tags/%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
    <category term="Linux" scheme="https://www.wdft.com/tags/Linux/"/>
    
    <category term="Debian" scheme="https://www.wdft.com/tags/Debian/"/>
    
    <category term="Ubuntu" scheme="https://www.wdft.com/tags/Ubuntu/"/>
    
    <category term="UFW" scheme="https://www.wdft.com/tags/UFW/"/>
    
    <category term="å®‰å…¨åŠ å›º" scheme="https://www.wdft.com/tags/%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA/"/>
    
    <category term="security" scheme="https://www.wdft.com/tags/security/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäº HEART æ¶æ„ç†å¿µçš„éšç§ä¿æŠ¤AIå¥åº·åº”ç”¨è®¾è®¡çš„ä¸€ç§æ¶æ„æ€è·¯å®è·µè§£å†³æ–¹æ¡ˆ</title>
    <link href="https://www.wdft.com/276d47b6.html"/>
    <id>https://www.wdft.com/276d47b6.html</id>
    <published>2026-01-25T15:24:37.000Z</published>
    <updated>2026-01-26T09:20:02.433Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h2 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h2><p>æœ¬äººä¸€ç›´éå¸¸æ¬£èµçš„ä¸€å¥è¯ï¼š   </p><p>é™¤éç»ç”±è®°å¿†ä¹‹è·¯ï¼Œäººä¸èƒ½æŠµè¾¾çºµæ·±ã€‚ â€”â€”â€”â€”æ±‰å¨œÂ·é˜¿ä¼¦ç‰¹   </p><p>é¦–å…ˆå¦‚æœåŸºäºHEARTæ¶æ„ç†å¿µï¼Œå¦‚ä½•è®¾è®¡ä¸€ä¸ªç¡®ä¿æ•°æ®éšç§çš„AIå¥åº·åº”ç”¨æ¶æ„ï¼Ÿç›¸ä¿¡è¿™åœ¨2026å¼€å¹´çš„ä»Šå¤©ï¼Œä»¥åŠè¿‡å»ä¸€å¹´ç”šåš£å°˜ä¸Šçš„å„ç§AIåº”ç”¨å¼€å‘æŠ€æœ¯å’Œè§„èŒƒåŸåˆ™é¼“å¹ä¹‹ä¸‹è¦æ€è€ƒå’Œåæ€çš„é—®é¢˜ï¼Œä½œä¸ºå·¥ç¨‹å¸ˆè¦å›å½’æ¸…é†’ä¸ç†æ™ºã€‚  </p><span id="more"></span><p>è¿™ä¹Ÿæ˜¯å¤§å¤šæ•°äººåœ¨AIä¸šåŠ¡é¡¹ç›®å®é™…è½åœ°çš„æ—¶å€™éƒ½è¦è®¤çœŸè€ƒè™‘çš„é—®é¢˜ã€‚   </p><p>åœ¨å½“ä»Šæ•°å­—åŒ–å¥åº·æ—¶ä»£ï¼ŒAIåº”ç”¨æ­£ä»¥å‰æ‰€æœªæœ‰çš„é€Ÿåº¦æ”¹å˜ç€åŒ»ç–—ä¿å¥è¡Œä¸šã€‚ç„¶è€Œï¼Œå¥åº·æ•°æ®çš„æ•æ„Ÿæ€§è¦æ±‚æˆ‘ä»¬åœ¨è®¾è®¡AIå¥åº·åº”ç”¨æ—¶å¿…é¡»å°†æ•°æ®éšç§ç½®äºæ ¸å¿ƒä½ç½®ã€‚æœ¬æ–‡å°†ä»‹ç»ä¸€ç§åŸºäºHEARTæ¶æ„ç†å¿µçš„éšç§ä¿æŠ¤AIå¥åº·åº”ç”¨è®¾è®¡æ–¹æ¡ˆï¼Œä»åŸåˆ™ã€åŸç†åˆ°å…·ä½“ä»£ç å®ç°ï¼Œä¸ºå¼€å‘è€…æä¾›ä¸€å¥—å®Œæ•´çš„æ¶æ„æŒ‡å—ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯HEARTæ¶æ„ç†å¿µï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯HEARTæ¶æ„ç†å¿µï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯HEARTæ¶æ„ç†å¿µï¼Ÿ"></a>ä»€ä¹ˆæ˜¯HEARTæ¶æ„ç†å¿µï¼Ÿ</h2><p>HEARTæ¶æ„å¹¶éä¼ ç»Ÿæ„ä¹‰ä¸Šçš„Googleç”¨æˆ·ä½“éªŒæ¡†æ¶ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå¥åº·AIåº”ç”¨è®¾è®¡çš„éšç§ä¿æŠ¤æ¶æ„æ¡†æ¶ã€‚HEARTä»£è¡¨ï¼š</p><ul><li><strong>H</strong>ealth Data Protection (å¥åº·æ•°æ®ä¿æŠ¤)</li><li><strong>E</strong>thical AI Processing (ä¼¦ç†AIå¤„ç†)  </li><li><strong>A</strong>ccess Control &amp; Authentication (è®¿é—®æ§åˆ¶ä¸è®¤è¯)</li><li><strong>R</strong>egulatory Compliance (æ³•è§„åˆè§„)</li><li><strong>T</strong>ransparency &amp; Traceability (é€æ˜æ€§ä¸å¯è¿½æº¯æ€§)</li></ul><p>è¿™ä¸€æ¶æ„ç†å¿µå¼ºè°ƒå°†éšç§ä¿æŠ¤åµŒå…¥åˆ°ç³»ç»Ÿè®¾è®¡çš„æ¯ä¸ªå±‚é¢ï¼Œè€Œéäº‹åè¡¥æ•‘ã€‚æ­£å¦‚â€privacy by designâ€å’Œâ€privacy by defaultâ€åŸåˆ™æ‰€å¼ºè°ƒçš„ï¼Œéšç§ä¿æŠ¤åº”è¯¥ä»ç³»ç»Ÿè®¾è®¡ä¹‹åˆå°±è¢«è€ƒè™‘ã€‚</p><h2 id="HEARTæ¶æ„æ ¸å¿ƒåŸåˆ™"><a href="#HEARTæ¶æ„æ ¸å¿ƒåŸåˆ™" class="headerlink" title="HEARTæ¶æ„æ ¸å¿ƒåŸåˆ™"></a>HEARTæ¶æ„æ ¸å¿ƒåŸåˆ™</h2><h3 id="1-å¥åº·æ•°æ®ä¿æŠ¤-Health-Data-Protection"><a href="#1-å¥åº·æ•°æ®ä¿æŠ¤-Health-Data-Protection" class="headerlink" title="1. å¥åº·æ•°æ®ä¿æŠ¤ (Health Data Protection)"></a>1. å¥åº·æ•°æ®ä¿æŠ¤ (Health Data Protection)</h3><p><strong>åŸåˆ™</strong>ï¼šå¥åº·æ•°æ®è¢«è§†ä¸ºæœ€é«˜æ•æ„Ÿçº§åˆ«çš„æ•°æ®ï¼Œéœ€è¦å®æ–½æœ€å¼ºçº§åˆ«çš„ä¿æŠ¤æªæ–½ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>æ•°æ®æœ€å°åŒ–ï¼šåªæ”¶é›†å’Œå¤„ç†å¿…è¦çš„å¥åº·æ•°æ®</li><li>ç«¯åˆ°ç«¯åŠ å¯†ï¼šæ•°æ®åœ¨ä¼ è¾“å’Œå­˜å‚¨è¿‡ç¨‹ä¸­å…¨ç¨‹åŠ å¯†</li><li>æ•°æ®åŒ¿ååŒ–&#x2F;å‡ååŒ–ï¼šåœ¨ä¸å½±å“AIåŠŸèƒ½çš„å‰æä¸‹ï¼Œç§»é™¤æˆ–æ›¿æ¢ä¸ªäººæ ‡è¯†ç¬¦</li><li>æœ¬åœ°å¤„ç†ä¼˜å…ˆï¼šæ•æ„Ÿæ•°æ®å°½å¯èƒ½åœ¨ç”¨æˆ·è®¾å¤‡ç«¯å¤„ç†ï¼Œå‡å°‘äº‘ç«¯ä¼ è¾“</li></ul><h3 id="2-ä¼¦ç†AIå¤„ç†-Ethical-AI-Processing"><a href="#2-ä¼¦ç†AIå¤„ç†-Ethical-AI-Processing" class="headerlink" title="2. ä¼¦ç†AIå¤„ç† (Ethical AI Processing)"></a>2. ä¼¦ç†AIå¤„ç† (Ethical AI Processing)</h3><p><strong>åŸåˆ™</strong>ï¼šAIç®—æ³•å¿…é¡»é€æ˜ã€å…¬å¹³ã€å¯è§£é‡Šï¼Œé¿å…åè§å’Œæ­§è§†ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>ç®—æ³•é€æ˜æ€§ï¼šè®°å½•å’Œè§£é‡ŠAIå†³ç­–è¿‡ç¨‹</li><li>åè§æ£€æµ‹ï¼šå®šæœŸè¯„ä¼°ç®—æ³•æ˜¯å¦å­˜åœ¨åè§</li><li>äººç±»ç›‘ç£ï¼šå…³é”®åŒ»ç–—å†³ç­–ä¿ç•™äººå·¥å®¡æ ¸ç¯èŠ‚</li><li>æ¨¡å‹å¯è§£é‡Šæ€§ï¼šä½¿ç”¨å¯è§£é‡Šçš„AIæŠ€æœ¯ï¼Œå¦‚LIMEã€SHAPç­‰</li></ul><h3 id="3-è®¿é—®æ§åˆ¶ä¸è®¤è¯-Access-Control-amp-Authentication"><a href="#3-è®¿é—®æ§åˆ¶ä¸è®¤è¯-Access-Control-amp-Authentication" class="headerlink" title="3. è®¿é—®æ§åˆ¶ä¸è®¤è¯ (Access Control &amp; Authentication)"></a>3. è®¿é—®æ§åˆ¶ä¸è®¤è¯ (Access Control &amp; Authentication)</h3><p><strong>åŸåˆ™</strong>ï¼šä¸¥æ ¼çš„è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œç¡®ä¿åªæœ‰æˆæƒäººå‘˜å’Œç³»ç»Ÿå¯ä»¥è®¿é—®å¥åº·æ•°æ®ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>å¤šå› ç´ è®¤è¯ï¼šå¼ºåˆ¶ä½¿ç”¨å¤šå› ç´ èº«ä»½éªŒè¯</li><li>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)ï¼šæ ¹æ®ç”¨æˆ·è§’è‰²åˆ†é…æœ€å°å¿…è¦æƒé™</li><li>åŠ¨æ€æƒé™ç®¡ç†ï¼šæƒé™éšä¸Šä¸‹æ–‡åŠ¨æ€è°ƒæ•´</li><li>å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰æ•°æ®è®¿é—®è¡Œä¸º</li></ul><h3 id="4-æ³•è§„åˆè§„-Regulatory-Compliance"><a href="#4-æ³•è§„åˆè§„-Regulatory-Compliance" class="headerlink" title="4. æ³•è§„åˆè§„ (Regulatory Compliance)"></a>4. æ³•è§„åˆè§„ (Regulatory Compliance)</h3><p><strong>åŸåˆ™</strong>ï¼šç³»ç»Ÿè®¾è®¡å¿…é¡»ç¬¦åˆç›¸å…³æ³•å¾‹æ³•è§„ï¼Œå¦‚HIPAAã€GDPRã€CCPAç­‰ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>æ•°æ®ä¸»ä½“æƒåˆ©æ”¯æŒï¼šå®ç°æ•°æ®è®¿é—®ã€æ›´æ­£ã€åˆ é™¤ç­‰åŠŸèƒ½</li><li>åˆè§„æ€§è‡ªåŠ¨åŒ–ï¼šè‡ªåŠ¨åŒ–çš„åˆè§„æ€§æ£€æŸ¥å’ŒæŠ¥å‘Šç”Ÿæˆ</li><li>è·¨å¢ƒæ•°æ®ä¼ è¾“æ§åˆ¶ï¼šä¸¥æ ¼ç®¡ç†æ•°æ®è·¨å¢ƒæµåŠ¨</li><li>éšç§å½±å“è¯„ä¼°ï¼šåœ¨æ–°åŠŸèƒ½å¼€å‘å‰è¿›è¡Œéšç§å½±å“è¯„ä¼°</li></ul><h3 id="5-é€æ˜æ€§ä¸å¯è¿½æº¯æ€§-Transparency-amp-Traceability"><a href="#5-é€æ˜æ€§ä¸å¯è¿½æº¯æ€§-Transparency-amp-Traceability" class="headerlink" title="5. é€æ˜æ€§ä¸å¯è¿½æº¯æ€§ (Transparency &amp; Traceability)"></a>5. é€æ˜æ€§ä¸å¯è¿½æº¯æ€§ (Transparency &amp; Traceability)</h3><p><strong>åŸåˆ™</strong>ï¼šç”¨æˆ·åº”æ¸…æ¥šäº†è§£å…¶æ•°æ®å¦‚ä½•è¢«ä½¿ç”¨ï¼Œæ‰€æœ‰æ“ä½œåº”å¯è¿½æº¯ã€‚</p><p><strong>å®ç°è¦ç‚¹</strong>ï¼š</p><ul><li>é€æ˜çš„éšç§æ”¿ç­–ï¼šç”¨ç®€å•æ˜“æ‡‚çš„è¯­è¨€è¯´æ˜æ•°æ®ä½¿ç”¨æ–¹å¼</li><li>æ•°æ®ä½¿ç”¨æ—¥å¿—ï¼šè¯¦ç»†è®°å½•æ•°æ®è®¿é—®å’Œä½¿ç”¨æƒ…å†µ</li><li>åŒºå—é“¾æŠ€æœ¯ï¼šä½¿ç”¨åŒºå—é“¾è®°å½•å…³é”®æ“ä½œï¼Œç¡®ä¿ä¸å¯ç¯¡æ”¹</li><li>ç”¨æˆ·æ§åˆ¶é¢æ¿ï¼šæä¾›ç”¨æˆ·æ•°æ®ä½¿ç”¨æƒ…å†µçš„å¯è§†åŒ–ç•Œé¢</li></ul><h2 id="ç³»ç»Ÿæ¶æ„è®¾è®¡"><a href="#ç³»ç»Ÿæ¶æ„è®¾è®¡" class="headerlink" title="ç³»ç»Ÿæ¶æ„è®¾è®¡"></a>ç³»ç»Ÿæ¶æ„è®¾è®¡</h2><h3 id="æ•´ä½“æ¶æ„å›¾"><a href="#æ•´ä½“æ¶æ„å›¾" class="headerlink" title="æ•´ä½“æ¶æ„å›¾"></a>æ•´ä½“æ¶æ„å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+     +-------------------+     +-------------------+</span><br><span class="line">|   User Devices    |     |  Edge Processing  |     |   Cloud Services  |</span><br><span class="line">| (Mobile, Wearable)|----&gt;|   (Local AI)      |----&gt;|  (Central AI)     |</span><br><span class="line">+-------------------+     +-------------------+     +-------------------+</span><br><span class="line">        |                          |                          |</span><br><span class="line">        v                          v                          v</span><br><span class="line">+-------------------+     +-------------------+     +-------------------+</span><br><span class="line">| Local Data Store  |     | Privacy Gateway   |     | Secure Data Lake  |</span><br><span class="line">| (Encrypted)       |     | (Anonymization)   |     | (Homomorphic Enc) |</span><br><span class="line">+-------------------+     +-------------------+     +-------------------+</span><br><span class="line">        |                          |                          |</span><br><span class="line">        +--------------------------+--------------------------+</span><br><span class="line">                                   |</span><br><span class="line">                           +-------------------+</span><br><span class="line">                           | Audit &amp; Monitor   |</span><br><span class="line">                           | (Blockchain Log)  |</span><br><span class="line">                           +-------------------+</span><br></pre></td></tr></table></figure><h3 id="å…³é”®ç»„ä»¶è¯´æ˜"><a href="#å…³é”®ç»„ä»¶è¯´æ˜" class="headerlink" title="å…³é”®ç»„ä»¶è¯´æ˜"></a>å…³é”®ç»„ä»¶è¯´æ˜</h3><ol><li><strong>ç”¨æˆ·è®¾å¤‡å±‚</strong>ï¼šè¿è¡Œåœ¨ç”¨æˆ·è®¾å¤‡ç«¯çš„è½»é‡çº§AIæ¨¡å‹ï¼Œå¤„ç†æœ€æ•æ„Ÿçš„æ•°æ®</li><li><strong>è¾¹ç¼˜å¤„ç†å±‚</strong>ï¼šåœ¨æœ¬åœ°æˆ–è¾¹ç¼˜æœåŠ¡å™¨è¿›è¡Œæ•°æ®é¢„å¤„ç†å’ŒåŒ¿ååŒ–</li><li><strong>éšç§ç½‘å…³</strong>ï¼šè´Ÿè´£æ•°æ®åŒ¿ååŒ–ã€åŠ å¯†å’Œè®¿é—®æ§åˆ¶çš„æ ¸å¿ƒç»„ä»¶</li><li><strong>å®‰å…¨æ•°æ®æ¹–</strong>ï¼šæ”¯æŒåŒæ€åŠ å¯†çš„å­˜å‚¨ç³»ç»Ÿï¼Œå…è®¸åœ¨åŠ å¯†æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—</li><li><strong>å®¡è®¡ç›‘æ§</strong>ï¼šä½¿ç”¨åŒºå—é“¾æŠ€æœ¯è®°å½•æ‰€æœ‰æ“ä½œï¼Œç¡®ä¿ä¸å¯ç¯¡æ”¹æ€§</li></ol><h2 id="ä»£ç å®ç°ç¤ºä¾‹"><a href="#ä»£ç å®ç°ç¤ºä¾‹" class="headerlink" title="ä»£ç å®ç°ç¤ºä¾‹"></a>ä»£ç å®ç°ç¤ºä¾‹</h2><h3 id="Pythonå®ç°ï¼šéšç§ä¿æŠ¤æ•°æ®å¤„ç†å±‚"><a href="#Pythonå®ç°ï¼šéšç§ä¿æŠ¤æ•°æ®å¤„ç†å±‚" class="headerlink" title="Pythonå®ç°ï¼šéšç§ä¿æŠ¤æ•°æ®å¤„ç†å±‚"></a>Pythonå®ç°ï¼šéšç§ä¿æŠ¤æ•°æ®å¤„ç†å±‚</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PrivacyProtectedHealthData</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    HEARTæ¶æ„ä¸­çš„å¥åº·æ•°æ®ä¿æŠ¤ç»„ä»¶</span></span><br><span class="line"><span class="string">    å®ç°æ•°æ®åŠ å¯†ã€åŒ¿ååŒ–å’Œè®¿é—®æ§åˆ¶</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.encryption_key = Fernet.generate_key()</span><br><span class="line">        self.cipher = Fernet(self.encryption_key)</span><br><span class="line">        self.access_control = &#123;&#125;</span><br><span class="line">        self.audit_log = []</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">anonymize_patient_data</span>(<span class="params">self, patient_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åŒ»ç–—æ•°æ®åŒ¿ååŒ–å¤„ç†</span></span><br><span class="line"><span class="string">        ç§»é™¤æˆ–å“ˆå¸Œå¤„ç†ä¸ªäººæ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        anonymized_data = patient_data.copy()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç§»é™¤ç›´æ¥æ ‡è¯†ç¬¦</span></span><br><span class="line">        identifiers = [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;ssn&#x27;</span>, <span class="string">&#x27;phone&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;address&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> identifier <span class="keyword">in</span> identifiers:</span><br><span class="line">            <span class="keyword">if</span> identifier <span class="keyword">in</span> anonymized_data:</span><br><span class="line">                <span class="keyword">del</span> anonymized_data[identifier]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å“ˆå¸Œå¤„ç†é—´æ¥æ ‡è¯†ç¬¦</span></span><br><span class="line">        quasi_identifiers = [<span class="string">&#x27;birth_date&#x27;</span>, <span class="string">&#x27;zip_code&#x27;</span>, <span class="string">&#x27;gender&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> qi <span class="keyword">in</span> quasi_identifiers:</span><br><span class="line">            <span class="keyword">if</span> qi <span class="keyword">in</span> anonymized_data:</span><br><span class="line">                anonymized_data[<span class="string">f&quot;hashed_<span class="subst">&#123;qi&#125;</span>&quot;</span>] = hashlib.sha256(</span><br><span class="line">                    <span class="built_in">str</span>(anonymized_data[qi]).encode()</span><br><span class="line">                ).hexdigest()</span><br><span class="line">                <span class="keyword">del</span> anonymized_data[qi]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•åŒ¿ååŒ–æ“ä½œ</span></span><br><span class="line">        self._log_audit(<span class="string">&quot;anonymize&quot;</span>, <span class="string">&quot;patient_data&quot;</span>, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> anonymized_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt_sensitive_data</span>(<span class="params">self, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä½¿ç”¨å¯¹ç§°åŠ å¯†åŠ å¯†æ•æ„Ÿå¥åº·æ•°æ®</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        json_data = json.dumps(data).encode()</span><br><span class="line">        encrypted_data = self.cipher.encrypt(json_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•åŠ å¯†æ“ä½œ</span></span><br><span class="line">        self._log_audit(<span class="string">&quot;encrypt&quot;</span>, <span class="string">&quot;sensitive_data&quot;</span>, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> encrypted_data</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_data</span>(<span class="params">self, encrypted_data: <span class="built_in">bytes</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è§£å¯†æ•°æ®ï¼Œä»…åœ¨æˆæƒè®¿é—®æ—¶è°ƒç”¨</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        decrypted_json = self.cipher.decrypt(encrypted_data)</span><br><span class="line">        <span class="keyword">return</span> json.loads(decrypted_json)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_access_control</span>(<span class="params">self, user_id: <span class="built_in">str</span>, permissions: <span class="type">List</span>[<span class="built_in">str</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è®¾ç½®åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.access_control[user_id] = permissions</span><br><span class="line">        self._log_audit(<span class="string">&quot;set_access&quot;</span>, user_id, <span class="built_in">str</span>(permissions))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_access_permission</span>(<span class="params">self, user_id: <span class="built_in">str</span>, action: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ‰§è¡Œç‰¹å®šæ“ä½œçš„æƒé™</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> user_id <span class="keyword">not</span> <span class="keyword">in</span> self.access_control:</span><br><span class="line">            self._log_audit(<span class="string">&quot;access_denied&quot;</span>, user_id, <span class="string">f&quot;no_permissions_for_<span class="subst">&#123;action&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        has_permission = action <span class="keyword">in</span> self.access_control[user_id]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> has_permission:</span><br><span class="line">            self._log_audit(<span class="string">&quot;access_denied&quot;</span>, user_id, <span class="string">f&quot;missing_permission_<span class="subst">&#123;action&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> has_permission</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_log_audit</span>(<span class="params">self, action: <span class="built_in">str</span>, target: <span class="built_in">str</span>, result: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è®°å½•å®¡è®¡æ—¥å¿—ï¼Œç¬¦åˆHEARTæ¶æ„çš„é€æ˜æ€§ä¸å¯è¿½æº¯æ€§åŸåˆ™</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        log_entry = &#123;</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: time.time(),</span><br><span class="line">            <span class="string">&quot;action&quot;</span>: action,</span><br><span class="line">            <span class="string">&quot;target&quot;</span>: target,</span><br><span class="line">            <span class="string">&quot;result&quot;</span>: result</span><br><span class="line">        &#125;</span><br><span class="line">        self.audit_log.append(log_entry)</span><br><span class="line">        logging.info(<span class="string">f&quot;Audit: <span class="subst">&#123;log_entry&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–éšç§ä¿æŠ¤æ•°æ®å¤„ç†å™¨</span></span><br><span class="line">    privacy_processor = PrivacyProtectedHealthData()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¤ºä¾‹æ‚£è€…æ•°æ®</span></span><br><span class="line">    patient_data = &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;å¼ ä¸‰&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span>: <span class="number">45</span>,</span><br><span class="line">        <span class="string">&quot;diagnosis&quot;</span>: <span class="string">&quot;é«˜è¡€å‹&quot;</span>,</span><br><span class="line">        <span class="string">&quot;blood_pressure&quot;</span>: <span class="string">&quot;140/90&quot;</span>,</span><br><span class="line">        <span class="string">&quot;birth_date&quot;</span>: <span class="string">&quot;1979-01-15&quot;</span>,</span><br><span class="line">        <span class="string">&quot;zip_code&quot;</span>: <span class="string">&quot;100000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŒ¿ååŒ–å¤„ç†</span></span><br><span class="line">    anonymized_data = privacy_processor.anonymize_patient_data(patient_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;åŒ¿ååŒ–åçš„æ•°æ®:&quot;</span>, anonymized_data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŠ å¯†å¤„ç†</span></span><br><span class="line">    encrypted_data = privacy_processor.encrypt_sensitive_data(anonymized_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;åŠ å¯†åçš„æ•°æ®:&quot;</span>, encrypted_data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¾ç½®è®¿é—®æ§åˆ¶</span></span><br><span class="line">    privacy_processor.set_access_control(<span class="string">&quot;doctor_123&quot;</span>, [<span class="string">&quot;view_diagnosis&quot;</span>, <span class="string">&quot;view_vitals&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ£€æŸ¥è®¿é—®æƒé™</span></span><br><span class="line">    has_access = privacy_processor.check_access_permission(<span class="string">&quot;doctor_123&quot;</span>, <span class="string">&quot;view_diagnosis&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;åŒ»ç”Ÿæœ‰è®¿é—®æƒé™:&quot;</span>, has_access)</span><br></pre></td></tr></table></figure><h3 id="Goå®ç°ï¼šéšç§ç½‘å…³æœåŠ¡"><a href="#Goå®ç°ï¼šéšç§ç½‘å…³æœåŠ¡" class="headerlink" title="Goå®ç°ï¼šéšç§ç½‘å…³æœåŠ¡"></a>Goå®ç°ï¼šéšç§ç½‘å…³æœåŠ¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;crypto/aes&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/cipher&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// HEARTæ¶æ„çš„æ ¸å¿ƒæ•°æ®ç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> HealthData <span class="keyword">struct</span> &#123;</span><br><span class="line">ID        <span class="type">string</span> <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">PatientID <span class="type">string</span> <span class="string">`json:&quot;patient_id&quot;`</span></span><br><span class="line">DataType  <span class="type">string</span> <span class="string">`json:&quot;data_type&quot;`</span> <span class="comment">// vitals, diagnosis, lab_results</span></span><br><span class="line">RawData   []<span class="type">byte</span> <span class="string">`json:&quot;raw_data&quot;`</span>  <span class="comment">// åŠ å¯†åçš„åŸå§‹æ•°æ®</span></span><br><span class="line">HashedID  <span class="type">string</span> <span class="string">`json:&quot;hashed_id&quot;`</span> <span class="comment">// å“ˆå¸Œå¤„ç†åçš„æ‚£è€…ID</span></span><br><span class="line">Timestamp time.Time <span class="string">`json:&quot;timestamp&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PrivacyGateway <span class="keyword">struct</span> &#123;</span><br><span class="line">db          *gorm.DB</span><br><span class="line">encryptionKey []<span class="type">byte</span></span><br><span class="line">accessRules   <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span></span><br><span class="line">auditLogChan  <span class="keyword">chan</span> AuditLogEntry</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuditLogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">Timestamp time.Time</span><br><span class="line">Action    <span class="type">string</span></span><br><span class="line">UserID    <span class="type">string</span></span><br><span class="line">Target    <span class="type">string</span></span><br><span class="line">Result    <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–éšç§ç½‘å…³</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPrivacyGateway</span><span class="params">(db *gorm.DB, encryptionKey []<span class="type">byte</span>)</span></span> *PrivacyGateway &#123;</span><br><span class="line">gateway := &amp;PrivacyGateway&#123;</span><br><span class="line">db:            db,</span><br><span class="line">encryptionKey: encryptionKey,</span><br><span class="line">accessRules:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>),</span><br><span class="line">auditLogChan:  <span class="built_in">make</span>(<span class="keyword">chan</span> AuditLogEntry, <span class="number">100</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨å®¡è®¡æ—¥å¿—å¤„ç†å™¨</span></span><br><span class="line"><span class="keyword">go</span> gateway.processAuditLogs()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> gateway</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ¿ååŒ–æ‚£è€…ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> anonymizePatientID(patientID <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line">hash := sha256.Sum256([]<span class="type">byte</span>(patientID))</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(hash[:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AESåŠ å¯†æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> encryptData(data []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">block, err := aes.NewCipher(g.encryptionKey)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gcm, err := cipher.NewGCM(block)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nonce := <span class="built_in">make</span>([]<span class="type">byte</span>, gcm.NonceSize())</span><br><span class="line"><span class="keyword">if</span> _, err = io.ReadFull(rand.Reader, nonce); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ciphertext := gcm.Seal(nonce, nonce, data, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">return</span> ciphertext, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†å¥åº·æ•°æ®è¯·æ±‚ - HEARTæ¶æ„çš„æ ¸å¿ƒAPI</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> handleHealthDataRequest(c *gin.Context) &#123;</span><br><span class="line"><span class="keyword">var</span> requestData <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := c.ShouldBindJSON(&amp;requestData); err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Invalid request format&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;request_failed&quot;</span>, <span class="string">&quot;unknown&quot;</span>, <span class="string">&quot;invalid_format&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–æ‚£è€…IDå¹¶åŒ¿ååŒ–</span></span><br><span class="line">patientID, ok := requestData[<span class="string">&quot;patient_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Missing patient_id&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;request_failed&quot;</span>, <span class="string">&quot;unknown&quot;</span>, <span class="string">&quot;missing_patient_id&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hashedPatientID := g.anonymizePatientID(patientID)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥è®¿é—®æƒé™</span></span><br><span class="line">userID := c.GetString(<span class="string">&quot;user_id&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> !g.checkAccessPermission(userID, <span class="string">&quot;submit_health_data&quot;</span>) &#123;</span><br><span class="line">c.JSON(http.StatusForbidden, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Access denied&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;access_denied&quot;</span>, userID, <span class="string">&quot;submit_health_data&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åºåˆ—åŒ–å¹¶åŠ å¯†æ•°æ®</span></span><br><span class="line">dataBytes, err := json.Marshal(requestData)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Data serialization failed&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;processing_failed&quot;</span>, userID, <span class="string">&quot;serialization_error&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">encryptedData, err := g.encryptData(dataBytes)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Encryption failed&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;processing_failed&quot;</span>, userID, <span class="string">&quot;encryption_error&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿å­˜åˆ°æ•°æ®åº“</span></span><br><span class="line">healthData := HealthData&#123;</span><br><span class="line">ID:        generateUUID(),</span><br><span class="line">PatientID: patientID,</span><br><span class="line">HashedID:  hashedPatientID,</span><br><span class="line">DataType:  requestData[<span class="string">&quot;data_type&quot;</span>].(<span class="type">string</span>),</span><br><span class="line">RawData:   encryptedData,</span><br><span class="line">Timestamp: time.Now(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := g.db.Create(&amp;healthData).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Database error&quot;</span>&#125;)</span><br><span class="line">g.logAudit(<span class="string">&quot;storage_failed&quot;</span>, userID, <span class="string">&quot;database_error&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•æˆåŠŸæ“ä½œ</span></span><br><span class="line">g.logAudit(<span class="string">&quot;data_submitted&quot;</span>, userID, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>, <span class="string">&quot;data_id&quot;</span>: healthData.ID&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥è®¿é—®æƒé™</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> checkAccessPermission(userID <span class="type">string</span>, action <span class="type">string</span>) <span class="type">bool</span> &#123;</span><br><span class="line">permissions, exists := g.accessRules[userID]</span><br><span class="line"><span class="keyword">if</span> !exists &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, perm := <span class="keyword">range</span> permissions &#123;</span><br><span class="line"><span class="keyword">if</span> perm == action &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¡è®¡æ—¥å¿—è®°å½•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> logAudit(action, userID, result <span class="type">string</span>) &#123;</span><br><span class="line">logEntry := AuditLogEntry&#123;</span><br><span class="line">Timestamp: time.Now(),</span><br><span class="line">Action:    action,</span><br><span class="line">UserID:    userID,</span><br><span class="line">Result:    result,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> g.auditLogChan &lt;- logEntry:</span><br><span class="line"><span class="comment">// æ—¥å¿—å·²å‘é€åˆ°é€šé“</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">// é€šé“å·²æ»¡ï¼Œè®°å½•é”™è¯¯</span></span><br><span class="line">log.Printf(<span class="string">&quot;Audit log channel full, dropping entry: %+v&quot;</span>, logEntry)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åå°å¤„ç†å®¡è®¡æ—¥å¿—</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *PrivacyGateway)</span></span> processAuditLogs() &#123;</span><br><span class="line"><span class="keyword">for</span> entry := <span class="keyword">range</span> g.auditLogChan &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œå¯ä»¥å°†æ—¥å¿—å†™å…¥æ•°æ®åº“ã€æ–‡ä»¶æˆ–å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ</span></span><br><span class="line">log.Printf(<span class="string">&quot;AUDIT: %+v&quot;</span>, entry)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥å®ç°æŒä¹…åŒ–å­˜å‚¨</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼šg.db.Create(&amp;AuditLog&#123;...&#125;)</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”ŸæˆUUIDï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateUUID</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">b := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">16</span>)</span><br><span class="line">_, err := rand.Read(b)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%x-%x-%x-%x-%x&quot;</span>, b[<span class="number">0</span>:<span class="number">4</span>], b[<span class="number">4</span>:<span class="number">6</span>], b[<span class="number">6</span>:<span class="number">8</span>], b[<span class="number">8</span>:<span class="number">10</span>], b[<span class="number">10</span>:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸»å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼ˆè¿™é‡Œä½¿ç”¨ä¼ªä»£ç ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> db *gorm.DB</span><br><span class="line"><span class="comment">// db = initializeDatabase()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”ŸæˆåŠ å¯†å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥ä»å®‰å…¨å­˜å‚¨ä¸­è·å–ï¼‰</span></span><br><span class="line">encryptionKey := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">32</span>)</span><br><span class="line"><span class="keyword">if</span> _, err := rand.Read(encryptionKey); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;Failed to generate encryption key&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºéšç§ç½‘å…³</span></span><br><span class="line">gateway := NewPrivacyGateway(db, encryptionKey)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®è®¿é—®è§„åˆ™</span></span><br><span class="line">gateway.accessRules[<span class="string">&quot;doctor_123&quot;</span>] = []<span class="type">string</span>&#123;<span class="string">&quot;view_diagnosis&quot;</span>, <span class="string">&quot;submit_health_data&quot;</span>, <span class="string">&quot;view_vitals&quot;</span>&#125;</span><br><span class="line">gateway.accessRules[<span class="string">&quot;nurse_456&quot;</span>] = []<span class="type">string</span>&#123;<span class="string">&quot;view_vitals&quot;</span>, <span class="string">&quot;submit_health_data&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®Ginè·¯ç”±å™¨</span></span><br><span class="line">r := gin.Default()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¥åº·æ•°æ®ç«¯ç‚¹</span></span><br><span class="line">r.POST(<span class="string">&quot;/api/health-data&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œåº”è¯¥å®ç°èº«ä»½éªŒè¯ï¼Œè®¾ç½®user_idåˆ°ä¸Šä¸‹æ–‡ä¸­</span></span><br><span class="line">c.Set(<span class="string">&quot;user_id&quot;</span>, <span class="string">&quot;doctor_123&quot;</span>) <span class="comment">// ç¤ºä¾‹ï¼Œå®é™…åº”è¯¥ä»tokenä¸­è§£æ</span></span><br><span class="line">gateway.handleHealthDataRequest(c)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">log.Println(<span class="string">&quot;Privacy Gateway Server starting on :8080&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err := r.Run(<span class="string">&quot;:8080&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;Server failed to start:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚"><a href="#å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚" class="headerlink" title="å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚"></a>å…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚</h2><h3 id="1-åŒæ€åŠ å¯†æ”¯æŒ"><a href="#1-åŒæ€åŠ å¯†æ”¯æŒ" class="headerlink" title="1. åŒæ€åŠ å¯†æ”¯æŒ"></a>1. åŒæ€åŠ å¯†æ”¯æŒ</h3><p>ä¸ºäº†åœ¨åŠ å¯†æ•°æ®ä¸Šç›´æ¥è¿›è¡ŒAIè®¡ç®—ï¼Œæˆ‘ä»¬å¯ä»¥é›†æˆåŒæ€åŠ å¯†åº“ã€‚ä»¥ä¸‹æ˜¯Pythonç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> phe <span class="keyword">import</span> paillier  <span class="comment"># PythonåŒæ€åŠ å¯†åº“</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HomomorphicAIProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.public_key, self.private_key = paillier.generate_paillier_keypair()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt_vitals</span>(<span class="params">self, systolic, diastolic</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ å¯†è¡€å‹æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        encrypted_systolic = self.public_key.encrypt(systolic)</span><br><span class="line">        encrypted_diastolic = self.public_key.encrypt(diastolic)</span><br><span class="line">        <span class="keyword">return</span> encrypted_systolic, encrypted_diastolic</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_risk</span>(<span class="params">self, encrypted_systolic, encrypted_diastolic</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åœ¨åŠ å¯†æ•°æ®ä¸Šè¿›è¡Œé£é™©åˆ†æ</span></span><br><span class="line"><span class="string">        ä¾‹å¦‚ï¼šè®¡ç®— (systolic + diastolic) / 2</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        encrypted_avg = (encrypted_systolic + encrypted_diastolic) * <span class="number">0.5</span></span><br><span class="line">        <span class="keyword">return</span> encrypted_avg</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_result</span>(<span class="params">self, encrypted_result</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†åˆ†æç»“æœï¼ˆä»…åœ¨æˆæƒæ—¶ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.private_key.decrypt(encrypted_result)</span><br></pre></td></tr></table></figure><h3 id="2-éšç§ä¿æŠ¤æœºå™¨å­¦ä¹ "><a href="#2-éšç§ä¿æŠ¤æœºå™¨å­¦ä¹ " class="headerlink" title="2. éšç§ä¿æŠ¤æœºå™¨å­¦ä¹ "></a>2. éšç§ä¿æŠ¤æœºå™¨å­¦ä¹ </h3><p>ä½¿ç”¨è”é‚¦å­¦ä¹ æŠ€æœ¯ï¼Œåœ¨ä¸å…±äº«åŸå§‹æ•°æ®çš„æƒ…å†µä¸‹è®­ç»ƒAIæ¨¡å‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow_federated <span class="keyword">as</span> tff</span><br><span class="line"></span><br><span class="line"><span class="comment"># HEARTæ¶æ„ä¸­çš„è”é‚¦å­¦ä¹ å®ç°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_federated_model</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ›å»ºéšç§ä¿æŠ¤çš„è”é‚¦å­¦ä¹ æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">model_fn</span>():</span><br><span class="line">        model = tf.keras.models.Sequential([</span><br><span class="line">            tf.keras.layers.Dense(<span class="number">64</span>, activation=<span class="string">&#x27;relu&#x27;</span>, input_shape=(<span class="number">10</span>,)),</span><br><span class="line">            tf.keras.layers.Dense(<span class="number">32</span>, activation=<span class="string">&#x27;relu&#x27;</span>),</span><br><span class="line">            tf.keras.layers.Dense(<span class="number">1</span>, activation=<span class="string">&#x27;sigmoid&#x27;</span>)</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> tff.learning.from_keras_model(</span><br><span class="line">            model,</span><br><span class="line">            input_spec=...,</span><br><span class="line">            loss=tf.keras.losses.BinaryCrossentropy(),</span><br><span class="line">            metrics=[tf.keras.metrics.BinaryAccuracy()]</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> model_fn</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HeartFederatedLearning</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.model_fn = create_federated_model()</span><br><span class="line">        self.iterative_process = tff.learning.build_federated_averaging_process(</span><br><span class="line">            self.model_fn,</span><br><span class="line">            client_optimizer_fn=<span class="keyword">lambda</span>: tf.keras.optimizers.Adam(learning_rate=<span class="number">0.01</span>),</span><br><span class="line">            server_optimizer_fn=<span class="keyword">lambda</span>: tf.keras.optimizers.Adam(learning_rate=<span class="number">0.01</span>)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train_on_local_data</span>(<span class="params">self, client_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åœ¨æœ¬åœ°æ•°æ®ä¸Šè®­ç»ƒï¼Œä¸ä¸Šä¼ åŸå§‹æ•°æ®</span></span><br><span class="line"><span class="string">        ç¬¦åˆHEARTæ¶æ„çš„æ•°æ®æœ€å°åŒ–åŸåˆ™</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        state = self.iterative_process.initialize()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è”é‚¦å­¦ä¹ è®­ç»ƒè½®æ¬¡</span></span><br><span class="line">        <span class="keyword">for</span> round_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">            state, metrics = self.iterative_process.<span class="built_in">next</span>(state, [client_data])</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Round <span class="subst">&#123;round_num&#125;</span>: <span class="subst">&#123;metrics&#125;</span>&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure><h3 id="3-åŒºå—é“¾å®¡è®¡æ—¥å¿—"><a href="#3-åŒºå—é“¾å®¡è®¡æ—¥å¿—" class="headerlink" title="3. åŒºå—é“¾å®¡è®¡æ—¥å¿—"></a>3. åŒºå—é“¾å®¡è®¡æ—¥å¿—</h3><p>ä½¿ç”¨åŒºå—é“¾æŠ€æœ¯ç¡®ä¿å®¡è®¡æ—¥å¿—çš„ä¸å¯ç¯¡æ”¹æ€§ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> blockchainaudit</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">Timestamp    time.Time</span><br><span class="line">AuditEntries []AuditLogEntry</span><br><span class="line">PrevHash     <span class="type">string</span></span><br><span class="line">Hash         <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Blockchain <span class="keyword">struct</span> &#123;</span><br><span class="line">chain []*Block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuditLogEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">Action    <span class="type">string</span></span><br><span class="line">UserID    <span class="type">string</span></span><br><span class="line">Target    <span class="type">string</span></span><br><span class="line">Timestamp time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Block)</span></span> calculateHash() <span class="type">string</span> &#123;</span><br><span class="line">record := b.Timestamp.String() + b.PrevHash</span><br><span class="line"><span class="keyword">for</span> _, entry := <span class="keyword">range</span> b.AuditEntries &#123;</span><br><span class="line">record += entry.Action + entry.UserID + entry.Target + entry.Timestamp.String()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">h := sha256.New()</span><br><span class="line">h.Write([]<span class="type">byte</span>(record))</span><br><span class="line">hashed := h.Sum(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(hashed)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *Blockchain)</span></span> addBlock(entries []AuditLogEntry) &#123;</span><br><span class="line">prevBlock := bc.chain[<span class="built_in">len</span>(bc.chain)<span class="number">-1</span>]</span><br><span class="line">newBlock := &amp;Block&#123;</span><br><span class="line">Timestamp:    time.Now(),</span><br><span class="line">AuditEntries: entries,</span><br><span class="line">PrevHash:     prevBlock.Hash,</span><br><span class="line">&#125;</span><br><span class="line">newBlock.Hash = newBlock.calculateHash()</span><br><span class="line">bc.chain = <span class="built_in">append</span>(bc.chain, newBlock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize blockchain with genesis block</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockchain</span><span class="params">()</span></span> *Blockchain &#123;</span><br><span class="line">genesisBlock := &amp;Block&#123;</span><br><span class="line">Timestamp:    time.Now(),</span><br><span class="line">AuditEntries: []AuditLogEntry&#123;&#125;,</span><br><span class="line">PrevHash:     <span class="string">&quot;0&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">genesisBlock.Hash = genesisBlock.calculateHash()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;Blockchain&#123;chain: []*Block&#123;genesisBlock&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¶æ„éªŒè¯ä¸æµ‹è¯•"><a href="#æ¶æ„éªŒè¯ä¸æµ‹è¯•" class="headerlink" title="æ¶æ„éªŒè¯ä¸æµ‹è¯•"></a>æ¶æ„éªŒè¯ä¸æµ‹è¯•</h2><h3 id="éšç§ä¿æŠ¤æµ‹è¯•ç”¨ä¾‹"><a href="#éšç§ä¿æŠ¤æµ‹è¯•ç”¨ä¾‹" class="headerlink" title="éšç§ä¿æŠ¤æµ‹è¯•ç”¨ä¾‹"></a>éšç§ä¿æŠ¤æµ‹è¯•ç”¨ä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> privacy_protected_health_data <span class="keyword">import</span> PrivacyProtectedHealthData</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestHEARTArchitecture</span>(unittest.TestCase):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>):</span><br><span class="line">        self.privacy_processor = PrivacyProtectedHealthData()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_data_anonymization</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•æ•°æ®åŒ¿ååŒ–åŠŸèƒ½&quot;&quot;&quot;</span></span><br><span class="line">        patient_data = &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;å¼ ä¸‰&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ssn&quot;</span>: <span class="string">&quot;110101199001011234&quot;</span>,</span><br><span class="line">            <span class="string">&quot;birth_date&quot;</span>: <span class="string">&quot;1990-01-01&quot;</span>,</span><br><span class="line">            <span class="string">&quot;zip_code&quot;</span>: <span class="string">&quot;100000&quot;</span>,</span><br><span class="line">            <span class="string">&quot;diagnosis&quot;</span>: <span class="string">&quot;ç³–å°¿ç—…&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        anonymized = self.privacy_processor.anonymize_patient_data(patient_data)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯ç›´æ¥æ ‡è¯†ç¬¦å·²è¢«ç§»é™¤</span></span><br><span class="line">        self.assertNotIn(<span class="string">&quot;name&quot;</span>, anonymized)</span><br><span class="line">        self.assertNotIn(<span class="string">&quot;ssn&quot;</span>, anonymized)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯é—´æ¥æ ‡è¯†ç¬¦å·²è¢«å“ˆå¸Œå¤„ç†</span></span><br><span class="line">        self.assertIn(<span class="string">&quot;hashed_birth_date&quot;</span>, anonymized)</span><br><span class="line">        self.assertIn(<span class="string">&quot;hashed_zip_code&quot;</span>, anonymized)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯åŒ»ç–—æ•°æ®ä¿ç•™</span></span><br><span class="line">        self.assertIn(<span class="string">&quot;diagnosis&quot;</span>, anonymized)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_access_control</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æµ‹è¯•è®¿é—®æ§åˆ¶åŠŸèƒ½&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># è®¾ç½®åŒ»ç”Ÿæƒé™</span></span><br><span class="line">        self.privacy_processor.set_access_control(<span class="string">&quot;doctor_123&quot;</span>, [<span class="string">&quot;view_diagnosis&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯åŒ»ç”Ÿå¯ä»¥è®¿é—®è¯Šæ–­</span></span><br><span class="line">        self.assertTrue(self.privacy_processor.check_access_permission(<span class="string">&quot;doctor_123&quot;</span>, <span class="string">&quot;view_diagnosis&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯åŒ»ç”Ÿä¸èƒ½è®¿é—®SSN</span></span><br><span class="line">        self.assertFalse(self.privacy_processor.check_access_permission(<span class="string">&quot;doctor_123&quot;</span>, <span class="string">&quot;view_ssn&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># éªŒè¯æœªçŸ¥ç”¨æˆ·æ— æƒé™</span></span><br><span class="line">        self.assertFalse(self.privacy_processor.check_access_permission(<span class="string">&quot;unknown_user&quot;</span>, <span class="string">&quot;view_diagnosis&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²ä¸è¿ç»´å»ºè®®"><a href="#éƒ¨ç½²ä¸è¿ç»´å»ºè®®" class="headerlink" title="éƒ¨ç½²ä¸è¿ç»´å»ºè®®"></a>éƒ¨ç½²ä¸è¿ç»´å»ºè®®</h2><h3 id="1-å®‰å…¨éƒ¨ç½²å®è·µ"><a href="#1-å®‰å…¨éƒ¨ç½²å®è·µ" class="headerlink" title="1. å®‰å…¨éƒ¨ç½²å®è·µ"></a>1. å®‰å…¨éƒ¨ç½²å®è·µ</h3><ul><li><strong>é›¶ä¿¡ä»»æ¶æ„</strong>ï¼šæ‰€æœ‰ç½‘ç»œè¯·æ±‚éƒ½å¿…é¡»ç»è¿‡èº«ä»½éªŒè¯å’Œæˆæƒ</li><li><strong>å®¹å™¨åŒ–éƒ¨ç½²</strong>ï¼šä½¿ç”¨Dockerå’ŒKubernetesï¼Œç¡®ä¿ç¯å¢ƒéš”ç¦»</li><li><strong>åŸºç¡€è®¾æ–½å³ä»£ç </strong>ï¼šä½¿ç”¨Terraformæˆ–CloudFormationå®šä¹‰å®‰å…¨åŸºç¡€è®¾æ–½</li></ul><h3 id="2-æŒç»­ç›‘æ§ä¸æ”¹è¿›"><a href="#2-æŒç»­ç›‘æ§ä¸æ”¹è¿›" class="headerlink" title="2. æŒç»­ç›‘æ§ä¸æ”¹è¿›"></a>2. æŒç»­ç›‘æ§ä¸æ”¹è¿›</h3><ul><li><strong>å®æ—¶éšç§ç›‘æ§</strong>ï¼šéƒ¨ç½²å¼‚å¸¸æ£€æµ‹ç³»ç»Ÿï¼Œç›‘æ§å¼‚å¸¸æ•°æ®è®¿é—®æ¨¡å¼</li><li><strong>å®šæœŸéšç§å®¡è®¡</strong>ï¼šæ¯å­£åº¦è¿›è¡Œç¬¬ä¸‰æ–¹éšç§å®¡è®¡</li><li><strong>ç”¨æˆ·åé¦ˆå¾ªç¯</strong>ï¼šå»ºç«‹ç”¨æˆ·éšç§åé¦ˆæœºåˆ¶ï¼ŒæŒç»­æ”¹è¿›</li></ul><h3 id="3-ç¾éš¾æ¢å¤è®¡åˆ’"><a href="#3-ç¾éš¾æ¢å¤è®¡åˆ’" class="headerlink" title="3. ç¾éš¾æ¢å¤è®¡åˆ’"></a>3. ç¾éš¾æ¢å¤è®¡åˆ’</h3><ul><li><strong>åŠ å¯†å¯†é’¥ç®¡ç†</strong>ï¼šä½¿ç”¨äº‘KMSæˆ–ç¡¬ä»¶å®‰å…¨æ¨¡å—(HSM)ç®¡ç†å¯†é’¥</li><li><strong>æ•°æ®å¤‡ä»½ç­–ç•¥</strong>ï¼šåŠ å¯†å¤‡ä»½ï¼Œå¤šåœ°å­˜å‚¨</li><li><strong>äº‹ä»¶å“åº”è®¡åˆ’</strong>ï¼šåˆ¶å®šæ•°æ®æ³„éœ²å“åº”æµç¨‹</li></ul><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>HEARTæ¶æ„ä¸ºAIå¥åº·åº”ç”¨æä¾›äº†ä¸€ä¸ªå…¨é¢çš„éšç§ä¿æŠ¤æ¡†æ¶ï¼Œé€šè¿‡å°†éšç§ä¿æŠ¤åŸåˆ™åµŒå…¥åˆ°ç³»ç»Ÿè®¾è®¡çš„æ¯ä¸ªå±‚é¢ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æä¾›å¼ºå¤§AIåŠŸèƒ½çš„åŒæ—¶ï¼Œå……åˆ†ä¿æŠ¤ç”¨æˆ·å¥åº·æ•°æ®éšç§ã€‚</p><p>è¯¥æ¶æ„çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š</p><ul><li><strong>æŠ€æœ¯ä¸ä¼¦ç†å¹¶é‡</strong>ï¼šä¸ä»…å…³æ³¨æŠ€æœ¯å®ç°ï¼Œæ›´é‡è§†ä¼¦ç†è€ƒé‡</li><li><strong>ä¸»åŠ¨è€Œéè¢«åŠ¨</strong>ï¼šä»è®¾è®¡ä¹‹åˆå°±è€ƒè™‘éšç§ï¼Œè€Œéäº‹åè¡¥æ•‘</li><li><strong>ç”¨æˆ·ä¸ºä¸­å¿ƒ</strong>ï¼šèµ‹äºˆç”¨æˆ·å¯¹å…¶å¥åº·æ•°æ®çš„æ§åˆ¶æƒ</li><li><strong>åˆè§„ä¸åˆ›æ–°å¹³è¡¡</strong>ï¼šåœ¨æ»¡è¶³æ³•è§„è¦æ±‚çš„åŒæ—¶ï¼Œæ”¯æŒæŠ€æœ¯åˆ›æ–°</li></ul><p>é€šè¿‡Pythonå’ŒGoçš„å…·ä½“ä»£ç å®ç°ï¼Œå¼€å‘è€…å¯ä»¥çœ‹åˆ°HEARTæ¶æ„å¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­è½åœ°ã€‚è¿™å¥—æ¶æ„ä¸ä»…é€‚ç”¨äºåŒ»ç–—å¥åº·é¢†åŸŸï¼Œä¹Ÿå¯ä»¥æ‰©å±•åˆ°å…¶ä»–éœ€è¦é«˜éšç§ä¿æŠ¤çš„AIåº”ç”¨åœºæ™¯ã€‚</p><p>åœ¨AIæŠ€æœ¯å¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œéšç§ä¿æŠ¤ä¸åº”æˆä¸ºåˆ›æ–°çš„éšœç¢ï¼Œè€Œåº”æˆä¸ºäº§å“ç«äº‰åŠ›çš„æ ¸å¿ƒè¦ç´ ã€‚HEARTæ¶æ„æ­£æ˜¯è¿™æ ·ä¸€ç§å°†éšç§ä¿æŠ¤è½¬åŒ–ä¸ºç«äº‰ä¼˜åŠ¿çš„è®¾è®¡ç†å¿µã€‚</p><hr><h2 id="åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ€è·¯æ¢è®¨"><a href="#åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ€è·¯æ¢è®¨" class="headerlink" title="åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ€è·¯æ¢è®¨"></a>åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ€è·¯æ¢è®¨</h2><p>HEARTæ¶æ„ï¼ˆHealth Data Protection, Ethical AI Processing, Access Control &amp; Authentication, Regulatory Compliance, Transparency &amp; Traceabilityï¼‰å°†æ•°æ®éšç§ä¿æŠ¤ç½®äºæ ¸å¿ƒä½ç½®ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨HEARTæ¶æ„ä¸­å®ç°å¼ºå¤§çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶æœºåˆ¶ã€‚</p><h3 id="ä¸€ã€æ•°æ®åŠ å¯†ç­–ç•¥"><a href="#ä¸€ã€æ•°æ®åŠ å¯†ç­–ç•¥" class="headerlink" title="ä¸€ã€æ•°æ®åŠ å¯†ç­–ç•¥"></a>ä¸€ã€æ•°æ®åŠ å¯†ç­–ç•¥</h3><h4 id="1-1-å¤šå±‚åŠ å¯†æ¶æ„"><a href="#1-1-å¤šå±‚åŠ å¯†æ¶æ„" class="headerlink" title="1.1 å¤šå±‚åŠ å¯†æ¶æ„"></a>1.1 å¤šå±‚åŠ å¯†æ¶æ„</h4><p>åœ¨HEARTæ¶æ„ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨åˆ†å±‚åŠ å¯†ç­–ç•¥ï¼Œé’ˆå¯¹ä¸åŒæ•°æ®æ•æ„Ÿåº¦å’Œä½¿ç”¨åœºæ™¯é‡‡ç”¨ä¸åŒçš„åŠ å¯†æŠ€æœ¯ï¼š</p><h5 id="1-1-1-é™æ€æ•°æ®åŠ å¯†ï¼ˆAES-GCMï¼‰"><a href="#1-1-1-é™æ€æ•°æ®åŠ å¯†ï¼ˆAES-GCMï¼‰" class="headerlink" title="1.1.1 é™æ€æ•°æ®åŠ å¯†ï¼ˆAES-GCMï¼‰"></a>1.1.1 é™æ€æ•°æ®åŠ å¯†ï¼ˆAES-GCMï¼‰</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers.aead <span class="keyword">import</span> AESGCM</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTDataEncryptor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–åŠ å¯†å™¨ï¼Œä½¿ç”¨AES-GCMç®—æ³•&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># ç”Ÿæˆ256ä½å¯†é’¥</span></span><br><span class="line">            self.key = AESGCM.generate_key(bit_length=<span class="number">256</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.key = key</span><br><span class="line">        self.aesgcm = AESGCM(self.key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt_health_record</span>(<span class="params">self, plaintext_data, patient_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä½¿ç”¨AES-GCMåŠ å¯†å¥åº·è®°å½•</span></span><br><span class="line"><span class="string">        AES-GCMæä¾›è®¤è¯åŠ å¯†ï¼Œå¯ä»¥ä¿æŠ¤æ•°æ®å…å—ç¯¡æ”¹ã€é‡æ”¾æ”»å‡»å’Œæœªæˆæƒè®¿é—® </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ç”Ÿæˆ12å­—èŠ‚çš„éšæœºnonce</span></span><br><span class="line">        nonce = os.urandom(<span class="number">12</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ·»åŠ å…³è”æ•°æ®ï¼ˆæ‚£è€…IDï¼‰ï¼Œç”¨äºè®¤è¯ä½†ä¸åŠ å¯†</span></span><br><span class="line">        associated_data = <span class="string">f&quot;patient:<span class="subst">&#123;patient_id&#125;</span>&quot;</span>.encode()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŠ å¯†æ•°æ®</span></span><br><span class="line">        ciphertext = self.aesgcm.encrypt(</span><br><span class="line">            nonce,</span><br><span class="line">            plaintext_data.encode(),</span><br><span class="line">            associated_data</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¿”å›åŠ å¯†æ•°æ®å’Œå…ƒæ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;nonce&#x27;</span>: base64.b64encode(nonce).decode(),</span><br><span class="line">            <span class="string">&#x27;ciphertext&#x27;</span>: base64.b64encode(ciphertext).decode(),</span><br><span class="line">            <span class="string">&#x27;patient_id&#x27;</span>: patient_id,</span><br><span class="line">            <span class="string">&#x27;associated_data&#x27;</span>: base64.b64encode(associated_data).decode()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_health_record</span>(<span class="params">self, encrypted_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†å¥åº·è®°å½•&quot;&quot;&quot;</span></span><br><span class="line">        nonce = base64.b64decode(encrypted_data[<span class="string">&#x27;nonce&#x27;</span>])</span><br><span class="line">        ciphertext = base64.b64decode(encrypted_data[<span class="string">&#x27;ciphertext&#x27;</span>])</span><br><span class="line">        associated_data = base64.b64decode(encrypted_data[<span class="string">&#x27;associated_data&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        plaintext = self.aesgcm.decrypt(</span><br><span class="line">            nonce,</span><br><span class="line">            ciphertext,</span><br><span class="line">            associated_data</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> plaintext.decode()</span><br></pre></td></tr></table></figure><h5 id="1-1-2-ä¼ è¾“ä¸­æ•°æ®åŠ å¯†ï¼ˆTLS-1-3-QUICï¼‰"><a href="#1-1-2-ä¼ è¾“ä¸­æ•°æ®åŠ å¯†ï¼ˆTLS-1-3-QUICï¼‰" class="headerlink" title="1.1.2 ä¼ è¾“ä¸­æ•°æ®åŠ å¯†ï¼ˆTLS 1.3 + QUICï¼‰"></a>1.1.2 ä¼ è¾“ä¸­æ•°æ®åŠ å¯†ï¼ˆTLS 1.3 + QUICï¼‰</h5><p>å¯¹äºæ•°æ®ä¼ è¾“ï¼ŒHEARTæ¶æ„è¦æ±‚ä½¿ç”¨TLS 1.3æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå¹¶ç»“åˆQUICåè®®æé«˜æ€§èƒ½å’Œå®‰å…¨æ€§ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">from</span> httpx <span class="keyword">import</span> AsyncClient</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTSecureClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, api_base_url</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–å®‰å…¨å®¢æˆ·ç«¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é…ç½®TLS 1.3</span></span><br><span class="line">        ssl_context = ssl.create_default_context()</span><br><span class="line">        ssl_context.minimum_version = ssl.TLSVersion.TLSv1_3</span><br><span class="line">        </span><br><span class="line">        self.client = AsyncClient(</span><br><span class="line">            base_url=api_base_url,</span><br><span class="line">            verify=ssl_context,</span><br><span class="line">            http2=<span class="literal">True</span>,</span><br><span class="line">            timeout=<span class="number">30.0</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_encrypted_health_data</span>(<span class="params">self, patient_id, health_data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å‘é€åŠ å¯†çš„å¥åº·æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é¦–å…ˆä½¿ç”¨AES-GCMåŠ å¯†æ•°æ®</span></span><br><span class="line">        encryptor = HEARTDataEncryptor()</span><br><span class="line">        encrypted_payload = encryptor.encrypt_health_record(</span><br><span class="line">            json.dumps(health_data), </span><br><span class="line">            patient_id</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é€šè¿‡TLS 1.3é€šé“å‘é€</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;X-HEART-Request-ID&#x27;</span>: generate_request_id(),</span><br><span class="line">            <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">f&#x27;Bearer <span class="subst">&#123;get_auth_token()&#125;</span>&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        response = <span class="keyword">await</span> self.client.post(</span><br><span class="line">            <span class="string">&#x27;/api/v1/health-data&#x27;</span>,</span><br><span class="line">            json=encrypted_payload,</span><br><span class="line">            headers=headers</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> response.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">f&quot;Data transmission failed: <span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response.json()</span><br></pre></td></tr></table></figure><h5 id="1-1-3-åŒæ€åŠ å¯†ç”¨äºAIå¤„ç†"><a href="#1-1-3-åŒæ€åŠ å¯†ç”¨äºAIå¤„ç†" class="headerlink" title="1.1.3 åŒæ€åŠ å¯†ç”¨äºAIå¤„ç†"></a>1.1.3 åŒæ€åŠ å¯†ç”¨äºAIå¤„ç†</h5><p>ä¸ºäº†åœ¨ä¿æŠ¤éšç§çš„åŒæ—¶å…è®¸AIæ¨¡å‹å¤„ç†åŠ å¯†æ•°æ®ï¼ŒHEARTæ¶æ„é›†æˆäº†åŒæ€åŠ å¯†æŠ€æœ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> phe <span class="keyword">import</span> paillier  <span class="comment"># PythonåŒæ€åŠ å¯†åº“</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTHomoMorphicProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–åŒæ€åŠ å¯†å¤„ç†å™¨&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ç”Ÿæˆå¯†é’¥å¯¹</span></span><br><span class="line">        self.public_key, self.private_key = paillier.generate_paillier_keypair()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt_vital_signs</span>(<span class="params">self, vital_signs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä½¿ç”¨åŒæ€åŠ å¯†åŠ å¯†ç”Ÿå‘½ä½“å¾æ•°æ®</span></span><br><span class="line"><span class="string">        åŒæ€åŠ å¯†å…è®¸åœ¨åŠ å¯†æ•°æ®ä¸Šç›´æ¥è¿›è¡Œè®¡ç®—ï¼Œä¿æŠ¤æ•æ„Ÿçš„åŒ»ç–—ä¿¡æ¯ </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        encrypted_vitals = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> vital_signs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, (<span class="built_in">int</span>, <span class="built_in">float</span>)):</span><br><span class="line">                encrypted_vitals[key] = self.public_key.encrypt(value)</span><br><span class="line">        <span class="keyword">return</span> encrypted_vitals</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_health_risk_on_encrypted_data</span>(<span class="params">self, encrypted_vitals</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åœ¨åŠ å¯†æ•°æ®ä¸Šè®¡ç®—å¥åº·é£é™©</span></span><br><span class="line"><span class="string">        ä¾‹å¦‚ï¼šè®¡ç®—å¿ƒè¡€ç®¡é£é™©æŒ‡æ•° = 0.3*è¡€å‹ + 0.4*å¿ƒç‡ + 0.3*è¡€ç³–</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å‡è®¾æˆ‘ä»¬æœ‰åŠ å¯†çš„è¡€å‹ã€å¿ƒç‡å’Œè¡€ç³–æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;blood_pressure&#x27;</span> <span class="keyword">in</span> encrypted_vitals <span class="keyword">and</span> <span class="string">&#x27;heart_rate&#x27;</span> <span class="keyword">in</span> encrypted_vitals:</span><br><span class="line">            <span class="comment"># åŒæ€è®¡ç®—ï¼šrisk = 0.3*bp + 0.4*hr</span></span><br><span class="line">            risk_score = (encrypted_vitals[<span class="string">&#x27;blood_pressure&#x27;</span>] * <span class="number">0.3</span>) + (encrypted_vitals[<span class="string">&#x27;heart_rate&#x27;</span>] * <span class="number">0.4</span>)</span><br><span class="line">            <span class="keyword">return</span> risk_score</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_risk_score</span>(<span class="params">self, encrypted_risk_score</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†é£é™©è¯„åˆ†&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.private_key.decrypt(encrypted_risk_score)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">processor = HEARTHomoMorphicProcessor()</span><br><span class="line">vital_signs = &#123;<span class="string">&#x27;blood_pressure&#x27;</span>: <span class="number">130</span>, <span class="string">&#x27;heart_rate&#x27;</span>: <span class="number">75</span>, <span class="string">&#x27;glucose&#x27;</span>: <span class="number">95</span>&#125;</span><br><span class="line">encrypted_vitals = processor.encrypt_vital_signs(vital_signs)</span><br><span class="line">encrypted_risk = processor.compute_health_risk_on_encrypted_data(encrypted_vitals)</span><br><span class="line">risk_score = processor.decrypt_risk_score(encrypted_risk)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;å¥åº·é£é™©è¯„åˆ†: <span class="subst">&#123;risk_score&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="1-2-å¯†é’¥ç®¡ç†ç­–ç•¥"><a href="#1-2-å¯†é’¥ç®¡ç†ç­–ç•¥" class="headerlink" title="1.2 å¯†é’¥ç®¡ç†ç­–ç•¥"></a>1.2 å¯†é’¥ç®¡ç†ç­–ç•¥</h4><p>HEARTæ¶æ„é‡‡ç”¨åˆ†å±‚å¯†é’¥ç®¡ç†ï¼Œç¡®ä¿å¯†é’¥å®‰å…¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> botocore.exceptions <span class="keyword">import</span> ClientError</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTKeyManager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, kms_key_id=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–å¯†é’¥ç®¡ç†å™¨ï¼Œä½¿ç”¨AWS KMSæˆ–æœ¬åœ°å®‰å…¨å­˜å‚¨&quot;&quot;&quot;</span></span><br><span class="line">        self.kms_client = boto3.client(<span class="string">&#x27;kms&#x27;</span>)</span><br><span class="line">        self.kms_key_id = kms_key_id <span class="keyword">or</span> os.getenv(<span class="string">&#x27;HEART_KMS_KEY_ID&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.kms_key_id:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;KMS key ID is required&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_data_key</span>(<span class="params">self, key_spec=<span class="string">&#x27;AES_256&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ç”Ÿæˆæ•°æ®å¯†é’¥ï¼Œä½¿ç”¨KMSè¿›è¡Œå¯†é’¥ç®¡ç†</span></span><br><span class="line"><span class="string">        ä¿è¯å¯†é’¥çš„å®‰å…¨æ€§å’Œåˆè§„æ€§</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = self.kms_client.generate_data_key(</span><br><span class="line">                KeyId=self.kms_key_id,</span><br><span class="line">                KeySpec=key_spec,</span><br><span class="line">                NumberOfBytes=<span class="number">32</span>  <span class="comment"># 256 bits</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è¿”å›æ˜æ–‡å¯†é’¥å’Œå¯†æ–‡å¯†é’¥</span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;plaintext_key&#x27;</span>: response[<span class="string">&#x27;Plaintext&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;ciphertext_key&#x27;</span>: response[<span class="string">&#x27;CiphertextBlob&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;key_id&#x27;</span>: response[<span class="string">&#x27;KeyId&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;KMS error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_data_key</span>(<span class="params">self, ciphertext_key</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†æ•°æ®å¯†é’¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = self.kms_client.decrypt(</span><br><span class="line">                CiphertextBlob=ciphertext_key</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> response[<span class="string">&#x27;Plaintext&#x27;</span>]</span><br><span class="line">        <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;KMS decryption error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rotate_keys</span>(<span class="params">self, old_key_id, new_key_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¯†é’¥è½®æ¢&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Rotating keys from <span class="subst">&#123;old_key_id&#125;</span> to <span class="subst">&#123;new_key_id&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># å®ç°å¯†é’¥è½®æ¢é€»è¾‘</span></span><br></pre></td></tr></table></figure><h3 id="äºŒã€è®¿é—®æ§åˆ¶å®ç°"><a href="#äºŒã€è®¿é—®æ§åˆ¶å®ç°" class="headerlink" title="äºŒã€è®¿é—®æ§åˆ¶å®ç°"></a>äºŒã€è®¿é—®æ§åˆ¶å®ç°</h3><h4 id="2-1-åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰"><a href="#2-1-åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰" class="headerlink" title="2.1 åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰"></a>2.1 åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰</h4><p>HEARTæ¶æ„é‡‡ç”¨åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„RBACæ›´çµæ´»ï¼Œæ›´é€‚åˆå¤æ‚åŒ»ç–—åœºæ™¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span>, <span class="type">Callable</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTAccessControl</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–è®¿é—®æ§åˆ¶å¼•æ“&quot;&quot;&quot;</span></span><br><span class="line">        self.policies = []</span><br><span class="line">        self.attribute_providers = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_attribute_provider</span>(<span class="params">self, attribute_name: <span class="built_in">str</span>, provider: <span class="type">Callable</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ³¨å†Œå±æ€§æä¾›è€…&quot;&quot;&quot;</span></span><br><span class="line">        self.attribute_providers[attribute_name] = provider</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_policy</span>(<span class="params">self, policy: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ·»åŠ è®¿é—®æ§åˆ¶ç­–ç•¥&quot;&quot;&quot;</span></span><br><span class="line">        self.policies.append(policy)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate_policy</span>(<span class="params">self, subject: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>], resource: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>], action: <span class="built_in">str</span>, context: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¯„ä¼°è®¿é—®ç­–ç•¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> policy <span class="keyword">in</span> self.policies:</span><br><span class="line">            <span class="comment"># æ£€æŸ¥ç­–ç•¥æ¡ä»¶</span></span><br><span class="line">            conditions_met = <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥ä¸»ä½“æ¡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;subject_conditions&#x27;</span> <span class="keyword">in</span> policy:</span><br><span class="line">                <span class="keyword">for</span> attr, condition <span class="keyword">in</span> policy[<span class="string">&#x27;subject_conditions&#x27;</span>].items():</span><br><span class="line">                    <span class="keyword">if</span> attr <span class="keyword">in</span> subject:</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> self._evaluate_condition(subject[attr], condition):</span><br><span class="line">                            conditions_met = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥èµ„æºæ¡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;resource_conditions&#x27;</span> <span class="keyword">in</span> policy <span class="keyword">and</span> conditions_met:</span><br><span class="line">                <span class="keyword">for</span> attr, condition <span class="keyword">in</span> policy[<span class="string">&#x27;resource_conditions&#x27;</span>].items():</span><br><span class="line">                    <span class="keyword">if</span> attr <span class="keyword">in</span> resource:</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> self._evaluate_condition(resource[attr], condition):</span><br><span class="line">                            conditions_met = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥ç¯å¢ƒæ¡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;context_conditions&#x27;</span> <span class="keyword">in</span> policy <span class="keyword">and</span> conditions_met:</span><br><span class="line">                <span class="keyword">for</span> attr, condition <span class="keyword">in</span> policy[<span class="string">&#x27;context_conditions&#x27;</span>].items():</span><br><span class="line">                    <span class="keyword">if</span> attr <span class="keyword">in</span> context:</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> self._evaluate_condition(context[attr], condition):</span><br><span class="line">                            conditions_met = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥åŠ¨ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> conditions_met <span class="keyword">and</span> action <span class="keyword">in</span> policy.get(<span class="string">&#x27;allowed_actions&#x27;</span>, []):</span><br><span class="line">                <span class="keyword">return</span> policy.get(<span class="string">&#x27;effect&#x27;</span>, <span class="string">&#x27;deny&#x27;</span>) == <span class="string">&#x27;allow&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_evaluate_condition</span>(<span class="params">self, value, condition</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¯„ä¼°æ¡ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(condition, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;equals&#x27;</span> <span class="keyword">in</span> condition:</span><br><span class="line">                <span class="keyword">return</span> value == condition[<span class="string">&#x27;equals&#x27;</span>]</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;in&#x27;</span> <span class="keyword">in</span> condition:</span><br><span class="line">                <span class="keyword">return</span> value <span class="keyword">in</span> condition[<span class="string">&#x27;in&#x27;</span>]</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;greater_than&#x27;</span> <span class="keyword">in</span> condition:</span><br><span class="line">                <span class="keyword">return</span> value &gt; condition[<span class="string">&#x27;greater_than&#x27;</span>]</span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;less_than&#x27;</span> <span class="keyword">in</span> condition:</span><br><span class="line">                <span class="keyword">return</span> value &lt; condition[<span class="string">&#x27;less_than&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> value == condition</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authorize_access</span>(<span class="params">self, user_token: <span class="built_in">str</span>, resource_id: <span class="built_in">str</span>, action: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æˆæƒè®¿é—®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># è§£æJWT token</span></span><br><span class="line">            payload = jwt.decode(user_token, options=&#123;<span class="string">&quot;verify_signature&quot;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–ç”¨æˆ·å±æ€§</span></span><br><span class="line">            subject = &#123;</span><br><span class="line">                <span class="string">&#x27;user_id&#x27;</span>: payload.get(<span class="string">&#x27;sub&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;role&#x27;</span>: payload.get(<span class="string">&#x27;role&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;department&#x27;</span>: payload.get(<span class="string">&#x27;department&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;clearance_level&#x27;</span>: payload.get(<span class="string">&#x27;clearance_level&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–èµ„æºå±æ€§</span></span><br><span class="line">            resource = self._get_resource_attributes(resource_id)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–ç¯å¢ƒä¸Šä¸‹æ–‡</span></span><br><span class="line">            context = &#123;</span><br><span class="line">                <span class="string">&#x27;time&#x27;</span>: time.time(),</span><br><span class="line">                <span class="string">&#x27;ip_address&#x27;</span>: self._get_client_ip(),</span><br><span class="line">                <span class="string">&#x27;device_type&#x27;</span>: self._get_device_type()</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è¯„ä¼°ç­–ç•¥</span></span><br><span class="line">            <span class="keyword">return</span> self.evaluate_policy(subject, resource, action, context)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Authorization error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_resource_attributes</span>(<span class="params">self, resource_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–èµ„æºå±æ€§ï¼ˆå®é™…å®ç°ä¸­åº”ä»æ•°æ®åº“æˆ–ç¼“å­˜ä¸­è·å–ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ¨¡æ‹Ÿèµ„æºå±æ€§</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;resource_id&#x27;</span>: resource_id,</span><br><span class="line">            <span class="string">&#x27;sensitivity_level&#x27;</span>: <span class="number">3</span>,  <span class="comment"># 1-5ï¼Œ5ä¸ºæœ€é«˜æ•æ„Ÿåº¦</span></span><br><span class="line">            <span class="string">&#x27;owner_department&#x27;</span>: <span class="string">&#x27;cardiology&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;data_type&#x27;</span>: <span class="string">&#x27;patient_vitals&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_client_ip</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–å®¢æˆ·ç«¯IPï¼ˆå®é™…å®ç°ä¸­åº”ä»è¯·æ±‚ä¸­è·å–ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;192.168.1.100&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_device_type</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–è®¾å¤‡ç±»å‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;mobile_app&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®HEARTè®¿é—®æ§åˆ¶ç­–ç•¥</span></span><br><span class="line">access_control = HEARTAccessControl()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ç­–ç•¥ï¼šåŒ»ç”Ÿåªèƒ½è®¿é—®æœ¬éƒ¨é—¨çš„æ‚£è€…æ•°æ®</span></span><br><span class="line">access_control.add_policy(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;department_access_policy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;subject_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;role&#x27;</span>: &#123;<span class="string">&#x27;equals&#x27;</span>: <span class="string">&#x27;doctor&#x27;</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;clearance_level&#x27;</span>: &#123;<span class="string">&#x27;greater_than&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;resource_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;sensitivity_level&#x27;</span>: &#123;<span class="string">&#x27;less_than&#x27;</span>: <span class="number">5</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;owner_department&#x27;</span>: &#123;<span class="string">&#x27;equals&#x27;</span>: <span class="string">&#x27;$&#123;subject.department&#125;&#x27;</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;context_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;time&#x27;</span>: &#123;<span class="string">&#x27;less_than&#x27;</span>: time.time() + <span class="number">3600</span>&#125;  <span class="comment"># 1å°æ—¶å†…æœ‰æ•ˆ</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;allowed_actions&#x27;</span>: [<span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;update&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;effect&#x27;</span>: <span class="string">&#x27;allow&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ç­–ç•¥ï¼šæŠ¤å£«åªèƒ½æŸ¥çœ‹ç”Ÿå‘½ä½“å¾ï¼Œä¸èƒ½ä¿®æ”¹è¯Šæ–­</span></span><br><span class="line">access_control.add_policy(&#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;nurse_vitals_policy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;subject_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;role&#x27;</span>: &#123;<span class="string">&#x27;equals&#x27;</span>: <span class="string">&#x27;nurse&#x27;</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;resource_conditions&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;data_type&#x27;</span>: &#123;<span class="string">&#x27;equals&#x27;</span>: <span class="string">&#x27;patient_vitals&#x27;</span>&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;allowed_actions&#x27;</span>: [<span class="string">&#x27;read&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;effect&#x27;</span>: <span class="string">&#x27;allow&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="2-2-Goè¯­è¨€å®ç°ï¼šé«˜æ€§èƒ½è®¿é—®æ§åˆ¶ä¸­é—´ä»¶"><a href="#2-2-Goè¯­è¨€å®ç°ï¼šé«˜æ€§èƒ½è®¿é—®æ§åˆ¶ä¸­é—´ä»¶" class="headerlink" title="2.2 Goè¯­è¨€å®ç°ï¼šé«˜æ€§èƒ½è®¿é—®æ§åˆ¶ä¸­é—´ä»¶"></a>2.2 Goè¯­è¨€å®ç°ï¼šé«˜æ€§èƒ½è®¿é—®æ§åˆ¶ä¸­é—´ä»¶</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> heart</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/golang-jwt/jwt/v5&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/redis/go-redis/v9&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// HEARTAccessControlConfig é…ç½®ç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> HEARTAccessControlConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">RedisClient *redis.Client</span><br><span class="line">JWTSecret   []<span class="type">byte</span></span><br><span class="line">PolicyStore PolicyStore</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Policy å®šä¹‰è®¿é—®æ§åˆ¶ç­–ç•¥</span></span><br><span class="line"><span class="keyword">type</span> Policy <span class="keyword">struct</span> &#123;</span><br><span class="line">ID              <span class="type">string</span>                 <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">Name            <span class="type">string</span>                 <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">SubjectMatch    <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;subject_match&quot;`</span></span><br><span class="line">ResourceMatch   <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;resource_match&quot;`</span></span><br><span class="line">Actions         []<span class="type">string</span>               <span class="string">`json:&quot;actions&quot;`</span></span><br><span class="line">Effect          <span class="type">string</span>                 <span class="string">`json:&quot;effect&quot;`</span> <span class="comment">// &quot;allow&quot; or &quot;deny&quot;</span></span><br><span class="line">ExpiresAt       *time.Time             <span class="string">`json:&quot;expires_at,omitempty&quot;`</span></span><br><span class="line">CacheDuration   time.Duration          <span class="string">`json:&quot;cache_duration&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PolicyStore ç­–ç•¥å­˜å‚¨æ¥å£</span></span><br><span class="line"><span class="keyword">type</span> PolicyStore <span class="keyword">interface</span> &#123;</span><br><span class="line">GetPolicy(policyID <span class="type">string</span>) (*Policy, <span class="type">error</span>)</span><br><span class="line">ListPolicies() ([]*Policy, <span class="type">error</span>)</span><br><span class="line">EvaluatePolicy(ctx context.Context, subject, resource <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, action <span class="type">string</span>) (<span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RedisPolicyStore Rediså®ç°çš„ç­–ç•¥å­˜å‚¨</span></span><br><span class="line"><span class="keyword">type</span> RedisPolicyStore <span class="keyword">struct</span> &#123;</span><br><span class="line">redisClient *redis.Client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RedisPolicyStore)</span></span> GetPolicy(policyID <span class="type">string</span>) (*Policy, <span class="type">error</span>) &#123;</span><br><span class="line">key := fmt.Sprintf(<span class="string">&quot;heart:policy:%s&quot;</span>, policyID)</span><br><span class="line">data, err := r.redisClient.Get(context.Background(), key).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> policy Policy</span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal([]<span class="type">byte</span>(data), &amp;policy); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;policy, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RedisPolicyStore)</span></span> EvaluatePolicy(ctx context.Context, subject, resource <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, action <span class="type">string</span>) (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// ä»ç¼“å­˜ä¸­è·å–ç›¸å…³ç­–ç•¥</span></span><br><span class="line">policyKeys, err := r.redisClient.Keys(ctx, <span class="string">&quot;heart:policy:*&quot;</span>).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> policyKeys &#123;</span><br><span class="line">data, err := r.redisClient.Get(ctx, key).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> policy Policy</span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal([]<span class="type">byte</span>(data), &amp;policy); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ç­–ç•¥æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line"><span class="keyword">if</span> policy.ExpiresAt != <span class="literal">nil</span> &amp;&amp; time.Now().After(*policy.ExpiresAt) &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ¹é…ä¸»ä½“æ¡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> !matchConditions(subject, policy.SubjectMatch) &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒ¹é…èµ„æºæ¡ä»¶</span></span><br><span class="line"><span class="keyword">if</span> !matchConditions(resource, policy.ResourceMatch) &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥åŠ¨ä½œ</span></span><br><span class="line"><span class="keyword">for</span> _, allowedAction := <span class="keyword">range</span> policy.Actions &#123;</span><br><span class="line"><span class="keyword">if</span> allowedAction == action &#123;</span><br><span class="line"><span class="keyword">return</span> policy.Effect == <span class="string">&quot;allow&quot;</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">matchConditions</span><span class="params">(target, conditions <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> key, condition := <span class="keyword">range</span> conditions &#123;</span><br><span class="line"><span class="keyword">if</span> targetValue, exists := target[key]; exists &#123;</span><br><span class="line"><span class="keyword">switch</span> cond := condition.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line"><span class="keyword">if</span> targetValue != cond &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;:</span><br><span class="line"><span class="keyword">if</span> !evaluateComplexCondition(targetValue, cond) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">if</span> targetValue != condition &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">evaluateComplexCondition</span><span class="params">(value <span class="keyword">interface</span>&#123;&#125;, condition <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> op, condValue := <span class="keyword">range</span> condition &#123;</span><br><span class="line"><span class="keyword">switch</span> op &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;equals&quot;</span>:</span><br><span class="line"><span class="keyword">return</span> value == condValue</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;in&quot;</span>:</span><br><span class="line"><span class="keyword">if</span> list, ok := condValue.([]<span class="keyword">interface</span>&#123;&#125;); ok &#123;</span><br><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> list &#123;</span><br><span class="line"><span class="keyword">if</span> value == item &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;greater_than&quot;</span>:</span><br><span class="line"><span class="keyword">if</span> floatValue, ok := value.(<span class="type">float64</span>); ok &#123;</span><br><span class="line"><span class="keyword">if</span> condFloat, ok := condValue.(<span class="type">float64</span>); ok &#123;</span><br><span class="line"><span class="keyword">return</span> floatValue &gt; condFloat</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;less_than&quot;</span>:</span><br><span class="line"><span class="keyword">if</span> floatValue, ok := value.(<span class="type">float64</span>); ok &#123;</span><br><span class="line"><span class="keyword">if</span> condFloat, ok := condValue.(<span class="type">float64</span>); ok &#123;</span><br><span class="line"><span class="keyword">return</span> floatValue &lt; condFloat</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AccessControlMiddleware HEARTè®¿é—®æ§åˆ¶ä¸­é—´ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AccessControlMiddleware</span><span class="params">(config *HEARTAccessControlConfig)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(http.Handler)</span></span> http.Handler &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(next http.Handler)</span></span> http.Handler &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">// 1. è§£æJWT token</span></span><br><span class="line">tokenString := extractToken(r)</span><br><span class="line"><span class="keyword">if</span> tokenString == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Missing authorization token&quot;</span>, http.StatusUnauthorized)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">token, err := jwt.Parse(tokenString, <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> []<span class="type">byte</span>(config.JWTSecret), <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> || !token.Valid &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Invalid token&quot;</span>, http.StatusUnauthorized)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">claims := token.Claims.(jwt.MapClaims)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ„å»ºä¸»ä½“å±æ€§</span></span><br><span class="line">subject := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;user_id&quot;</span>:        claims[<span class="string">&quot;sub&quot;</span>],</span><br><span class="line"><span class="string">&quot;role&quot;</span>:           claims[<span class="string">&quot;role&quot;</span>],</span><br><span class="line"><span class="string">&quot;department&quot;</span>:     claims[<span class="string">&quot;department&quot;</span>],</span><br><span class="line"><span class="string">&quot;clearance_level&quot;</span>: claims[<span class="string">&quot;clearance_level&quot;</span>],</span><br><span class="line"><span class="string">&quot;ip_address&quot;</span>:      r.RemoteAddr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ„å»ºèµ„æºå±æ€§</span></span><br><span class="line">resourceID := getResourceIDFromRequest(r)</span><br><span class="line">resource := getResourceAttributes(config.RedisClient, resourceID)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ç¡®å®šåŠ¨ä½œ</span></span><br><span class="line">action := getActionFromRequest(r)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. è¯„ä¼°ç­–ç•¥</span></span><br><span class="line">ctx := context.Background()</span><br><span class="line">authorized, err := config.PolicyStore.EvaluatePolicy(ctx, subject, resource, action)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Policy evaluation error: %v&quot;</span>, err)</span><br><span class="line">http.Error(w, <span class="string">&quot;Access control error&quot;</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !authorized &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Access denied: insufficient permissions&quot;</span>, http.StatusForbidden)</span><br><span class="line"><span class="comment">// è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">logAccessDecision(config.RedisClient, subject, resource, action, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">logAccessDecision(config.RedisClient, subject, resource, action, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. ç»§ç»­å¤„ç†è¯·æ±‚</span></span><br><span class="line">next.ServeHTTP(w, r)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">extractToken</span><span class="params">(r *http.Request)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">authHeader := r.Header.Get(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> authHeader == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">parts := strings.Split(authHeader, <span class="string">&quot; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(parts) != <span class="number">2</span> || strings.ToLower(parts[<span class="number">0</span>]) != <span class="string">&quot;bearer&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> parts[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getResourceIDFromRequest</span><span class="params">(r *http.Request)</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">// ä»URLè·¯å¾„ä¸­æå–èµ„æºID</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ï¼š/api/v1/patients/&#123;patient_id&#125;/records</span></span><br><span class="line">pathParts := strings.Split(r.URL.Path, <span class="string">&quot;/&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i, part := <span class="keyword">range</span> pathParts &#123;</span><br><span class="line"><span class="keyword">if</span> part == <span class="string">&quot;patients&quot;</span> &amp;&amp; i+<span class="number">1</span> &lt; <span class="built_in">len</span>(pathParts) &#123;</span><br><span class="line"><span class="keyword">return</span> pathParts[i+<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> part == <span class="string">&quot;records&quot;</span> &amp;&amp; i+<span class="number">1</span> &lt; <span class="built_in">len</span>(pathParts) &#123;</span><br><span class="line"><span class="keyword">return</span> pathParts[i+<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;unknown_resource&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getResourceAttributes</span><span class="params">(redisClient *redis.Client, resourceID <span class="type">string</span>)</span></span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line"><span class="comment">// ä»Redisè·å–èµ„æºå±æ€§</span></span><br><span class="line">key := fmt.Sprintf(<span class="string">&quot;heart:resource:%s&quot;</span>, resourceID)</span><br><span class="line">data, err := redisClient.Get(context.Background(), key).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// è¿”å›é»˜è®¤å±æ€§</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;resource_id&quot;</span>:     resourceID,</span><br><span class="line"><span class="string">&quot;sensitivity_level&quot;</span>: <span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;owner_department&quot;</span>:  <span class="string">&quot;general&quot;</span>,</span><br><span class="line"><span class="string">&quot;data_type&quot;</span>:        <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> attributes <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal([]<span class="type">byte</span>(data), &amp;attributes); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;resource_id&quot;</span>: resourceID,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> attributes</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getActionFromRequest</span><span class="params">(r *http.Request)</span></span> <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> r.Method &#123;</span><br><span class="line"><span class="keyword">case</span> http.MethodGet:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;read&quot;</span></span><br><span class="line"><span class="keyword">case</span> http.MethodPost:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;create&quot;</span></span><br><span class="line"><span class="keyword">case</span> http.MethodPut, http.MethodPatch:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;update&quot;</span></span><br><span class="line"><span class="keyword">case</span> http.MethodDelete:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;delete&quot;</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logAccessDecision</span><span class="params">(redisClient *redis.Client, subject, resource <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, action <span class="type">string</span>, allowed <span class="type">bool</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// ç”Ÿæˆå”¯ä¸€å®¡è®¡ID</span></span><br><span class="line">auditID := generateAuditID(subject, resource, action)</span><br><span class="line"></span><br><span class="line">auditLog := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;audit_id&quot;</span>:   auditID,</span><br><span class="line"><span class="string">&quot;timestamp&quot;</span>:  time.Now().UTC().Format(time.RFC3339),</span><br><span class="line"><span class="string">&quot;subject&quot;</span>:    subject,</span><br><span class="line"><span class="string">&quot;resource&quot;</span>:   resource,</span><br><span class="line"><span class="string">&quot;action&quot;</span>:     action,</span><br><span class="line"><span class="string">&quot;allowed&quot;</span>:    allowed,</span><br><span class="line"><span class="string">&quot;ip_address&quot;</span>: subject[<span class="string">&quot;ip_address&quot;</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jsonData, _ := json.Marshal(auditLog)</span><br><span class="line">key := fmt.Sprintf(<span class="string">&quot;heart:audit:%s&quot;</span>, auditID)</span><br><span class="line">redisClient.Set(context.Background(), key, <span class="type">string</span>(jsonData), <span class="number">30</span>*<span class="number">24</span>*time.Hour) <span class="comment">// ä¿å­˜30å¤©</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateAuditID</span><span class="params">(subject, resource <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, action <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">hash := sha256.New()</span><br><span class="line">hash.Write([]<span class="type">byte</span>(fmt.Sprintf(<span class="string">&quot;%v:%v:%s:%d&quot;</span>, </span><br><span class="line">subject[<span class="string">&quot;user_id&quot;</span>], </span><br><span class="line">resource[<span class="string">&quot;resource_id&quot;</span>], </span><br><span class="line">action, </span><br><span class="line">time.Now().Unix())))</span><br><span class="line"><span class="keyword">return</span> hex.EncodeToString(hash.Sum(<span class="literal">nil</span>))[:<span class="number">16</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸‰ã€HEARTæ¶æ„ä¸­çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶é›†æˆ"><a href="#ä¸‰ã€HEARTæ¶æ„ä¸­çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶é›†æˆ" class="headerlink" title="ä¸‰ã€HEARTæ¶æ„ä¸­çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶é›†æˆ"></a>ä¸‰ã€HEARTæ¶æ„ä¸­çš„æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶é›†æˆ</h3><h4 id="3-1-ç«¯åˆ°ç«¯åŠ å¯†æµç¨‹"><a href="#3-1-ç«¯åˆ°ç«¯åŠ å¯†æµç¨‹" class="headerlink" title="3.1 ç«¯åˆ°ç«¯åŠ å¯†æµç¨‹"></a>3.1 ç«¯åˆ°ç«¯åŠ å¯†æµç¨‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTSecureDataPipeline</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.encryptor = HEARTDataEncryptor()</span><br><span class="line">        self.access_control = HEARTAccessControl()</span><br><span class="line">        self.key_manager = HEARTKeyManager()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_health_data</span>(<span class="params">self, patient_id, health_data, user_token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç«¯åˆ°ç«¯å¤„ç†å¥åº·æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 1. éªŒè¯è®¿é—®æƒé™</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.access_control.authorize_access(user_token, patient_id, <span class="string">&quot;write&quot;</span>):</span><br><span class="line">                <span class="keyword">raise</span> PermissionError(<span class="string">&quot;Access denied: insufficient permissions&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2. ç”Ÿæˆæ•°æ®å¯†é’¥</span></span><br><span class="line">            data_key = self.key_manager.generate_data_key()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 3. ä½¿ç”¨æ•°æ®å¯†é’¥åŠ å¯†å¥åº·æ•°æ®</span></span><br><span class="line">            encrypted_data = self.encryptor.encrypt_health_record(</span><br><span class="line">                json.dumps(health_data),</span><br><span class="line">                patient_id</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 4. ä½¿ç”¨KMSå¯†é’¥åŠ å¯†æ•°æ®å¯†é’¥</span></span><br><span class="line">            encrypted_data_key = &#123;</span><br><span class="line">                <span class="string">&#x27;ciphertext_key&#x27;</span>: base64.b64encode(data_key[<span class="string">&#x27;ciphertext_key&#x27;</span>]).decode(),</span><br><span class="line">                <span class="string">&#x27;key_id&#x27;</span>: data_key[<span class="string">&#x27;key_id&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 5. æ„å»ºå®‰å…¨æ•°æ®åŒ…</span></span><br><span class="line">            secure_package = &#123;</span><br><span class="line">                <span class="string">&#x27;patient_id&#x27;</span>: patient_id,</span><br><span class="line">                <span class="string">&#x27;encrypted_data&#x27;</span>: encrypted_data,</span><br><span class="line">                <span class="string">&#x27;encrypted_data_key&#x27;</span>: encrypted_data_key,</span><br><span class="line">                <span class="string">&#x27;encryption_metadata&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;algorithm&#x27;</span>: <span class="string">&#x27;AES-GCM-256&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">                    <span class="string">&#x27;version&#x27;</span>: <span class="string">&#x27;1.0&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 6. è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">            self._log_audit_event(</span><br><span class="line">                user_id=self._extract_user_id(user_token),</span><br><span class="line">                action=<span class="string">&quot;data_encrypted&quot;</span>,</span><br><span class="line">                resource=patient_id,</span><br><span class="line">                result=<span class="string">&quot;success&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> secure_package</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self._log_audit_event(</span><br><span class="line">                user_id=self._extract_user_id(user_token),</span><br><span class="line">                action=<span class="string">&quot;data_encryption_failed&quot;</span>,</span><br><span class="line">                resource=patient_id,</span><br><span class="line">                result=<span class="built_in">str</span>(e)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrypt_health_data</span>(<span class="params">self, secure_package, user_token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£å¯†å¥åº·æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            patient_id = secure_package[<span class="string">&#x27;patient_id&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 1. éªŒè¯è®¿é—®æƒé™</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.access_control.authorize_access(user_token, patient_id, <span class="string">&quot;read&quot;</span>):</span><br><span class="line">                <span class="keyword">raise</span> PermissionError(<span class="string">&quot;Access denied: insufficient permissions&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2. è§£å¯†æ•°æ®å¯†é’¥</span></span><br><span class="line">            encrypted_data_key = base64.b64decode(secure_package[<span class="string">&#x27;encrypted_data_key&#x27;</span>][<span class="string">&#x27;ciphertext_key&#x27;</span>])</span><br><span class="line">            plaintext_key = self.key_manager.decrypt_data_key(encrypted_data_key)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 3. ä½¿ç”¨æ•°æ®å¯†é’¥è§£å¯†å¥åº·æ•°æ®</span></span><br><span class="line">            temp_encryptor = HEARTDataEncryptor(plaintext_key)</span><br><span class="line">            decrypted_data = temp_encryptor.decrypt_health_record(</span><br><span class="line">                secure_package[<span class="string">&#x27;encrypted_data&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 4. è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">            self._log_audit_event(</span><br><span class="line">                user_id=self._extract_user_id(user_token),</span><br><span class="line">                action=<span class="string">&quot;data_decrypted&quot;</span>,</span><br><span class="line">                resource=patient_id,</span><br><span class="line">                result=<span class="string">&quot;success&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> json.loads(decrypted_data)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self._log_audit_event(</span><br><span class="line">                user_id=self._extract_user_id(user_token),</span><br><span class="line">                action=<span class="string">&quot;data_decryption_failed&quot;</span>,</span><br><span class="line">                resource=patient_id,</span><br><span class="line">                result=<span class="built_in">str</span>(e)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_extract_user_id</span>(<span class="params">self, token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä»tokenä¸­æå–ç”¨æˆ·ID&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = jwt.decode(token, options=&#123;<span class="string">&quot;verify_signature&quot;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">            <span class="keyword">return</span> payload.get(<span class="string">&#x27;sub&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_log_audit_event</span>(<span class="params">self, user_id, action, resource, result</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•å®¡è®¡äº‹ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        audit_log = &#123;</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span>: action,</span><br><span class="line">            <span class="string">&#x27;resource&#x27;</span>: resource,</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: result,</span><br><span class="line">            <span class="string">&#x27;ip_address&#x27;</span>: self._get_client_ip()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># ä¿å­˜åˆ°å®‰å…¨å®¡è®¡æ—¥å¿—ç³»ç»Ÿ</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Audit: <span class="subst">&#123;audit_log&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="3-2-åŒæ€åŠ å¯†ä¸è®¿é—®æ§åˆ¶çš„ç»“åˆ"><a href="#3-2-åŒæ€åŠ å¯†ä¸è®¿é—®æ§åˆ¶çš„ç»“åˆ" class="headerlink" title="3.2 åŒæ€åŠ å¯†ä¸è®¿é—®æ§åˆ¶çš„ç»“åˆ"></a>3.2 åŒæ€åŠ å¯†ä¸è®¿é—®æ§åˆ¶çš„ç»“åˆ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTPrivacyPreservingAI</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.homo_processor = HEARTHomoMorphicProcessor()</span><br><span class="line">        self.access_control = HEARTAccessControl()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train_model_on_encrypted_data</span>(<span class="params">self, encrypted_dataset, model_config, user_token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åœ¨åŠ å¯†æ•°æ®ä¸Šè®­ç»ƒAIæ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 1. éªŒè¯è®¿é—®æƒé™</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.access_control.authorize_access(user_token, <span class="string">&quot;model_training&quot;</span>, <span class="string">&quot;execute&quot;</span>):</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;Unauthorized model training attempt&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. åœ¨åŠ å¯†æ•°æ®ä¸Šè¿›è¡Œè®¡ç®—</span></span><br><span class="line">        encrypted_results = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> data_point <span class="keyword">in</span> encrypted_dataset:</span><br><span class="line">            <span class="comment"># æ‰§è¡ŒåŒæ€è®¡ç®—</span></span><br><span class="line">            encrypted_prediction = self.homo_processor.compute_health_risk_on_encrypted_data(data_point)</span><br><span class="line">            encrypted_results.append(encrypted_prediction)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. è¿”å›åŠ å¯†çš„æ¨¡å‹å‚æ•°</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;model_id&#x27;</span>: generate_model_id(),</span><br><span class="line">            <span class="string">&#x27;encrypted_parameters&#x27;</span>: encrypted_results,</span><br><span class="line">            <span class="string">&#x27;training_metadata&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;timestamp&#x27;</span>: time.time(),</span><br><span class="line">                <span class="string">&#x27;data_points&#x27;</span>: <span class="built_in">len</span>(encrypted_dataset)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_on_encrypted_data</span>(<span class="params">self, encrypted_input, model_id, user_token</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä½¿ç”¨åŠ å¯†æ¨¡å‹è¿›è¡Œé¢„æµ‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 1. éªŒè¯è®¿é—®æƒé™</span></span><br><span class="line">        patient_id = self._extract_patient_id(encrypted_input)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.access_control.authorize_access(user_token, patient_id, <span class="string">&quot;predict&quot;</span>):</span><br><span class="line">            <span class="keyword">raise</span> PermissionError(<span class="string">&quot;Unauthorized prediction attempt&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. ä½¿ç”¨åŒæ€åŠ å¯†æ•°æ®è¿›è¡Œé¢„æµ‹</span></span><br><span class="line">        encrypted_prediction = self._execute_encrypted_prediction(encrypted_input, model_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. è®°å½•å®¡è®¡æ—¥å¿—</span></span><br><span class="line">        self._log_prediction_audit(user_token, patient_id, model_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> encrypted_prediction</span><br></pre></td></tr></table></figure><h3 id="å››ã€å®‰å…¨æœ€ä½³å®è·µ"><a href="#å››ã€å®‰å…¨æœ€ä½³å®è·µ" class="headerlink" title="å››ã€å®‰å…¨æœ€ä½³å®è·µ"></a>å››ã€å®‰å…¨æœ€ä½³å®è·µ</h3><h4 id="4-1-å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ"><a href="#4-1-å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ" class="headerlink" title="4.1 å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ"></a>4.1 å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ</h4><ol><li><strong>å¯†é’¥è½®æ¢ç­–ç•¥</strong>ï¼šå®šæœŸè½®æ¢åŠ å¯†å¯†é’¥ï¼Œæ—§å¯†é’¥ç”¨äºè§£å¯†å†å²æ•°æ®ï¼Œæ–°å¯†é’¥ç”¨äºåŠ å¯†æ–°æ•°æ®</li><li><strong>å¯†é’¥åˆ†å±‚</strong>ï¼šä½¿ç”¨KMSä¸»å¯†é’¥åŠ å¯†æ•°æ®å¯†é’¥ï¼Œæ•°æ®å¯†é’¥åŠ å¯†å®é™…æ•°æ®</li><li>**ç¡¬ä»¶å®‰å…¨æ¨¡å—(HSM)**ï¼šå…³é”®å¯†é’¥å­˜å‚¨åœ¨HSMä¸­ï¼Œé˜²æ­¢è½¯ä»¶å±‚é¢çš„æ”»å‡»</li></ol><h4 id="4-2-è®¿é—®æ§åˆ¶å¼ºåŒ–æªæ–½"><a href="#4-2-è®¿é—®æ§åˆ¶å¼ºåŒ–æªæ–½" class="headerlink" title="4.2 è®¿é—®æ§åˆ¶å¼ºåŒ–æªæ–½"></a>4.2 è®¿é—®æ§åˆ¶å¼ºåŒ–æªæ–½</h4><ol><li><strong>æœ€å°æƒé™åŸåˆ™</strong>ï¼šç”¨æˆ·åªèƒ½è®¿é—®å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°æ•°æ®é›†</li><li><strong>åŠ¨æ€æƒé™</strong>ï¼šæ ¹æ®ä¸Šä¸‹æ–‡ï¼ˆæ—¶é—´ã€ä½ç½®ã€è®¾å¤‡ï¼‰åŠ¨æ€è°ƒæ•´æƒé™</li><li><strong>å¤šå› ç´ è®¤è¯</strong>ï¼šç»“åˆç”Ÿç‰©è¯†åˆ«ã€ç¡¬ä»¶ä»¤ç‰Œç­‰å¤šé‡è®¤è¯å› ç´ </li><li><strong>é›¶ä¿¡ä»»æ¶æ„</strong>ï¼šé»˜è®¤æ‹’ç»æ‰€æœ‰è®¿é—®ï¼Œæ˜¾å¼æˆæƒæ¯æ¬¡è¯·æ±‚</li></ol><h4 id="4-3-å®¡è®¡ä¸ç›‘æ§"><a href="#4-3-å®¡è®¡ä¸ç›‘æ§" class="headerlink" title="4.3 å®¡è®¡ä¸ç›‘æ§"></a>4.3 å®¡è®¡ä¸ç›‘æ§</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTAuditSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, blockchain_client=<span class="literal">None</span></span>):</span><br><span class="line">        self.blockchain_client = blockchain_client  <span class="comment"># å¯é€‰çš„åŒºå—é“¾å®¡è®¡</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_audit_event</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è®°å½•å®¡è®¡äº‹ä»¶åˆ°ä¸å¯ç¯¡æ”¹çš„æ—¥å¿—&quot;&quot;&quot;</span></span><br><span class="line">        audit_entry = &#123;</span><br><span class="line">            <span class="string">&#x27;event_id&#x27;</span>: <span class="built_in">str</span>(uuid.uuid4()),</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: datetime.utcnow().isoformat(),</span><br><span class="line">            <span class="string">&#x27;event_type&#x27;</span>: event[<span class="string">&#x27;type&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span>: event[<span class="string">&#x27;user_id&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;resource_id&#x27;</span>: event.get(<span class="string">&#x27;resource_id&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span>: event[<span class="string">&#x27;action&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: event[<span class="string">&#x27;result&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;ip_address&#x27;</span>: event.get(<span class="string">&#x27;ip_address&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;user_agent&#x27;</span>: event.get(<span class="string">&#x27;user_agent&#x27;</span>),</span><br><span class="line">            <span class="string">&#x27;signature&#x27;</span>: self._sign_audit_entry(event)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“</span></span><br><span class="line">        self._save_to_database(audit_entry)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. å¦‚æœé…ç½®äº†åŒºå—é“¾ï¼Œå†™å…¥åŒºå—é“¾</span></span><br><span class="line">        <span class="keyword">if</span> self.blockchain_client:</span><br><span class="line">            self.blockchain_client.write_audit_log(audit_entry)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. å®æ—¶ç›‘æ§å¼‚å¸¸</span></span><br><span class="line">        self._monitor_for_anomalies(audit_entry)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_sign_audit_entry</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä½¿ç”¨ç§é’¥ç­¾åå®¡è®¡æ¡ç›®ï¼Œç¡®ä¿å®Œæ•´æ€§&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å®é™…å®ç°ä¸­ä½¿ç”¨æ•°å­—ç­¾å</span></span><br><span class="line">        <span class="keyword">return</span> hashlib.sha256(json.dumps(event, sort_keys=<span class="literal">True</span>).encode()).hexdigest()</span><br></pre></td></tr></table></figure><h3 id="äº”ã€æ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡"><a href="#äº”ã€æ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡" class="headerlink" title="äº”ã€æ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡"></a>äº”ã€æ€§èƒ½ä¼˜åŒ–ä¸æƒè¡¡</h3><h4 id="5-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#5-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="5.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>5.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h4><ol><li><strong>ç¼“å­˜ç­–ç•¥</strong>ï¼šç¼“å­˜è§£å¯†çš„å¯†é’¥å’Œè®¿é—®æ§åˆ¶å†³ç­–ï¼Œå‡å°‘é‡å¤è®¡ç®—</li><li><strong>å¼‚æ­¥åŠ å¯†</strong>ï¼šå¯¹éå…³é”®è·¯å¾„çš„åŠ å¯†æ“ä½œä½¿ç”¨å¼‚æ­¥å¤„ç†</li><li><strong>æ‰¹å¤„ç†</strong>ï¼šæ‰¹é‡å¤„ç†åŒæ€åŠ å¯†è®¡ç®—ï¼Œå‡å°‘å¼€é”€</li><li><strong>ç¡¬ä»¶åŠ é€Ÿ</strong>ï¼šä½¿ç”¨æ”¯æŒAES-NIçš„CPUå’ŒGPUåŠ é€ŸåŠ å¯†è®¡ç®—</li></ol><h4 id="5-2-å®‰å…¨ä¸æ€§èƒ½çš„æƒè¡¡"><a href="#5-2-å®‰å…¨ä¸æ€§èƒ½çš„æƒè¡¡" class="headerlink" title="5.2 å®‰å…¨ä¸æ€§èƒ½çš„æƒè¡¡"></a>5.2 å®‰å…¨ä¸æ€§èƒ½çš„æƒè¡¡</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HEARTSecurityPerformanceBalancer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.security_level = <span class="string">&quot;high&quot;</span>  <span class="comment"># high, medium, low</span></span><br><span class="line">        self.performance_threshold = <span class="number">100</span>  <span class="comment"># ms</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">adjust_security_level</span>(<span class="params">self, current_latency</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¹æ®æ€§èƒ½åŠ¨æ€è°ƒæ•´å®‰å…¨çº§åˆ«&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> current_latency &gt; self.performance_threshold * <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> self.security_level == <span class="string">&quot;high&quot;</span>:</span><br><span class="line">                self.security_level = <span class="string">&quot;medium&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Reducing security level to medium for performance&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> current_latency &lt; self.performance_threshold / <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> self.security_level == <span class="string">&quot;medium&quot;</span>:</span><br><span class="line">                self.security_level = <span class="string">&quot;high&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Increasing security level to high&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_encryption_strategy</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–å½“å‰åŠ å¯†ç­–ç•¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.security_level == <span class="string">&quot;high&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;algorithm&#x27;</span>: <span class="string">&#x27;AES-GCM-256&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;key_rotation&#x27;</span>: <span class="string">&#x27;daily&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;homomorphic_encryption&#x27;</span>: <span class="literal">True</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">elif</span> self.security_level == <span class="string">&quot;medium&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;algorithm&#x27;</span>: <span class="string">&#x27;AES-GCM-128&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;key_rotation&#x27;</span>: <span class="string">&#x27;weekly&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;homomorphic_encryption&#x27;</span>: <span class="literal">False</span>  <span class="comment"># ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&#x27;algorithm&#x27;</span>: <span class="string">&#x27;AES-CBC-128&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;key_rotation&#x27;</span>: <span class="string">&#x27;monthly&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;homomorphic_encryption&#x27;</span>: <span class="literal">False</span></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h3 id="ç›¸å…³å»ºè®®"><a href="#ç›¸å…³å»ºè®®" class="headerlink" title="ç›¸å…³å»ºè®®"></a>ç›¸å…³å»ºè®®</h3><p>åœ¨HEARTæ¶æ„ä¸­å®ç°æ•°æ®åŠ å¯†ä¸è®¿é—®æ§åˆ¶éœ€è¦ç»¼åˆè€ƒè™‘å¤šä¸ªå±‚é¢ï¼š</p><ol><li><strong>å¤šå±‚åŠ å¯†ç­–ç•¥</strong>ï¼šç»“åˆAES-GCMä¿æŠ¤é™æ€æ•°æ®ï¼ŒTLS 1.3ä¿æŠ¤ä¼ è¾“æ•°æ®ï¼ŒåŒæ€åŠ å¯†ä¿æŠ¤å¤„ç†ä¸­çš„æ•°æ® </li><li><strong>ç»†ç²’åº¦è®¿é—®æ§åˆ¶</strong>ï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰æä¾›çµæ´»çš„æƒé™ç®¡ç†ï¼Œé€‚åº”å¤æ‚çš„åŒ»ç–—åœºæ™¯</li><li><strong>å¯†é’¥å®‰å…¨ç®¡ç†</strong>ï¼šä½¿ç”¨äº‘KMSæˆ–HSMè¿›è¡Œå¯†é’¥ç®¡ç†ï¼Œç¡®ä¿å¯†é’¥å®‰å…¨</li><li><strong>å®¡è®¡ä¸ç›‘æ§</strong>ï¼šè®°å½•æ‰€æœ‰è®¿é—®å’Œæ“ä½œï¼Œæä¾›é€æ˜æ€§å’Œå¯è¿½æº¯æ€§</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šåœ¨ä¿è¯å®‰å…¨çš„å‰æä¸‹ï¼Œé€šè¿‡ç¼“å­˜ã€å¼‚æ­¥å¤„ç†ç­‰æŠ€æœ¯ä¼˜åŒ–æ€§èƒ½</li></ol><p>é€šè¿‡è¿™ç§ç»¼åˆæ€§çš„æ–¹æ³•ï¼ŒHEARTæ¶æ„èƒ½å¤Ÿåœ¨ä¿æŠ¤æ‚£è€…éšç§çš„åŒæ—¶ï¼Œæä¾›é«˜æ•ˆã€å¯é çš„AIå¥åº·æœåŠ¡ã€‚è¿™ç§æ¶æ„ä¸ä»…ç¬¦åˆHIPAAã€GDPRç­‰æ³•è§„è¦æ±‚ï¼Œè¿˜èƒ½åœ¨å®é™…åº”ç”¨ä¸­æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚  </p><p>æœ€é‡è¦çš„æ˜¯ï¼ŒHEARTæ¶æ„å°†å®‰å…¨æ€§å’Œéšç§ä¿æŠ¤â€è®¾è®¡è¿›â€ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè€Œä¸æ˜¯ä½œä¸ºäº‹åçš„è¡¥å……ï¼Œè¿™æ­£æ˜¯ç°ä»£åŒ»ç–—å¥åº·åº”ç”¨æˆåŠŸçš„å…³é”®æ‰€åœ¨ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;&lt;a href=&quot;#æ‘˜è¦&quot; class=&quot;headerlink&quot; title=&quot;æ‘˜è¦&quot;&gt;&lt;/a&gt;æ‘˜è¦&lt;/h2&gt;&lt;p&gt;æœ¬äººä¸€ç›´éå¸¸æ¬£èµçš„ä¸€å¥è¯ï¼š   &lt;/p&gt;
&lt;p&gt;é™¤éç»ç”±è®°å¿†ä¹‹è·¯ï¼Œäººä¸èƒ½æŠµè¾¾çºµæ·±ã€‚ â€”â€”â€”â€”æ±‰å¨œÂ·é˜¿ä¼¦ç‰¹   &lt;/p&gt;
&lt;p&gt;é¦–å…ˆå¦‚æœåŸºäºHEARTæ¶æ„ç†å¿µï¼Œå¦‚ä½•è®¾è®¡ä¸€ä¸ªç¡®ä¿æ•°æ®éšç§çš„AIå¥åº·åº”ç”¨æ¶æ„ï¼Ÿç›¸ä¿¡è¿™åœ¨2026å¼€å¹´çš„ä»Šå¤©ï¼Œä»¥åŠè¿‡å»ä¸€å¹´ç”šåš£å°˜ä¸Šçš„å„ç§AIåº”ç”¨å¼€å‘æŠ€æœ¯å’Œè§„èŒƒåŸåˆ™é¼“å¹ä¹‹ä¸‹è¦æ€è€ƒå’Œåæ€çš„é—®é¢˜ï¼Œä½œä¸ºå·¥ç¨‹å¸ˆè¦å›å½’æ¸…é†’ä¸ç†æ™ºã€‚  &lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Skill" scheme="https://www.wdft.com/tags/Skill/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/tags/Agent/"/>
    
    <category term="Agent-Skill" scheme="https://www.wdft.com/tags/Agent-Skill/"/>
    
    <category term="Agent-architecture" scheme="https://www.wdft.com/tags/Agent-architecture/"/>
    
    <category term="HEART" scheme="https://www.wdft.com/tags/HEART/"/>
    
  </entry>
  
  <entry>
    <title>Agentå’ŒRAGï¼šåŒé˜¶æ®µæ„å›¾è¯†åˆ«ä»¥åŠå…¸å‹åœºæ™¯(å®¢æœ)é—®ç­”åœºæ™¯ä¸‹å‡†ç¡®ç‡ä¸å»¶è¿Ÿçš„å¸•ç´¯æ‰˜æœ€ä¼˜è§£è§£æ</title>
    <link href="https://www.wdft.com/835929d9.html"/>
    <id>https://www.wdft.com/835929d9.html</id>
    <published>2026-01-25T15:17:34.000Z</published>
    <updated>2026-01-28T02:15:12.621Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h6 id="é¦–å…ˆä¸ºä»€ä¹ˆ90-çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”"><a href="#é¦–å…ˆä¸ºä»€ä¹ˆ90-çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”" class="headerlink" title="é¦–å…ˆä¸ºä»€ä¹ˆ90%çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”"></a>é¦–å…ˆä¸ºä»€ä¹ˆ90%çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”</h6><p><strong>ä»¥å…¸å‹æ¡ˆä¾‹æ¥è¯´</strong>ï¼šåœ¨å‡ ä¹æ‰€æœ‰IMå®¢æœ(ç”µå•†)äº¤äº’å¼å¯¹è¯ç³»ç»Ÿåº”ç”¨ä¸­ï¼Œ<strong>â€œæ‰€æœ‰è¯·æ±‚åŒç­‰å¯¹å¾…â€æ˜¯æœ€å¤§çš„èµ„æºæµªè´¹</strong>ã€‚<br>ç›®å‰ä¸šç•Œå…±è¯†ä¹‹ä¸€æ˜¯ï¼šåŒé˜¶æ®µæ„å›¾è¯†åˆ«é€šè¿‡â€œè®¡ç®—èµ„æºåŠ¨æ€åˆ†é…â€æ€æƒ³ï¼Œåœ¨96.7%å‡†ç¡®ç‡ä¸98mså¹³å‡å»¶è¿Ÿé—´å–å¾—å·¥ç¨‹æœ€ä¼˜å¹³è¡¡ï¼Œä¹Ÿå‡ ä¹æˆä¸ºAgentç³»ç»Ÿçš„äº‹å®æ€§æ ‡å‡†æ¶æ„ä¹‹ä¸€ã€‚  </p><span id="more"></span><p>é’ˆå¯¹è¿™ä¸ªæœ€å¸¸ç”¨çš„åœºæ™¯ä¹‹ä¸€ï¼Œ<strong>ç°å°±ç›¸å…³å®ç°æ€è·¯è¿›è¡Œå‘æ•£,éšç€AIæŠ€æœ¯çš„æ¨¡å‹çš„å‘å±•ï¼Œæ¨¡å‹èƒ½åŠ›ä¹Ÿåœ¨ä¸æ–­å¢å¼ºï¼Œå®é™…ä¸Šæ–¹æ¡ˆä¹Ÿå±‚å‡ºä¸ç©·ï¼Œé€‰å‹æ²¡æœ‰ä¸€å®šä¹‹è§„ï¼Œåªæœ‰é€‚åˆè‡ªå·±çš„ä¸šåŠ¡åœºæ™¯çš„æ–¹æ¡ˆæ‰æ˜¯æœ€ä½³çš„ã€‚</strong></p><hr><h2 id="ä¸€ã€â€å•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€èƒ½å¤Ÿåšåˆ°ä¼ä¸šçº§çš„åœºæ™¯åº”å¯¹å—ï¼Ÿä¸ºä»€ä¹ˆå¿…é¡»æ”¾å¼ƒâ€œå•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€å¹»æƒ³ï¼Ÿ"><a href="#ä¸€ã€â€å•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€èƒ½å¤Ÿåšåˆ°ä¼ä¸šçº§çš„åœºæ™¯åº”å¯¹å—ï¼Ÿä¸ºä»€ä¹ˆå¿…é¡»æ”¾å¼ƒâ€œå•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€å¹»æƒ³ï¼Ÿ" class="headerlink" title="ä¸€ã€â€å•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€èƒ½å¤Ÿåšåˆ°ä¼ä¸šçº§çš„åœºæ™¯åº”å¯¹å—ï¼Ÿä¸ºä»€ä¹ˆå¿…é¡»æ”¾å¼ƒâ€œå•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€å¹»æƒ³ï¼Ÿ"></a>ä¸€ã€â€å•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€èƒ½å¤Ÿåšåˆ°ä¼ä¸šçº§çš„åœºæ™¯åº”å¯¹å—ï¼Ÿä¸ºä»€ä¹ˆå¿…é¡»æ”¾å¼ƒâ€œå•é˜¶æ®µä¸‡èƒ½æ¨¡å‹â€å¹»æƒ³ï¼Ÿ</h2><h3 id="1-1-å®¢æœåœºæ™¯çš„æ®‹é…·ç°å®"><a href="#1-1-å®¢æœåœºæ™¯çš„æ®‹é…·ç°å®" class="headerlink" title="1.1 å®¢æœåœºæ™¯çš„æ®‹é…·ç°å®"></a>1.1 å®¢æœåœºæ™¯çš„æ®‹é…·ç°å®</h3><p>æŸå¤´éƒ¨ç”µå•†å¹³å°2025å¹´Q3æ•°æ®æ­ç¤ºçœŸç›¸ï¼š</p><ul><li><strong>87.3%</strong> çš„ç”¨æˆ·æŸ¥è¯¢å±äºâ€œé«˜é¢‘ç®€å•æ„å›¾â€ï¼ˆå¦‚ç‰©æµæŸ¥è¯¢ã€é€€æ¬¾æµç¨‹ï¼‰</li><li><strong>12.7%</strong> å±äºâ€œå¤æ‚å¤šæ„å›¾äº¤ç»‡â€ï¼ˆå¦‚â€œæ‰‹æœºåäº†è¦é€€è´§è¿˜è¦æŠ•è¯‰å®¢æœâ€ï¼‰</li><li><strong>å•é˜¶æ®µBERTåˆ†ç±»å™¨</strong>å¯¹ç®€å•æ„å›¾è¿‡åº¦è®¡ç®—ï¼ˆæµªè´¹73%ç®—åŠ›ï¼‰ï¼Œå¯¹å¤æ‚æ„å›¾èƒ½åŠ›ä¸è¶³ï¼ˆè¯¯åˆ¤ç‡31%ï¼‰</li></ul><blockquote><p>â€œæˆ‘ä»¬æ›¾ç”¨Qwen3-32Bå¤„ç†æ‰€æœ‰è¯·æ±‚ï¼Œå‡†ç¡®ç‡92%ï¼Œä½†P99å»¶è¿Ÿ410msï¼Œå¤§ä¿ƒæœŸé—´GPUæˆæœ¬é£™å‡300%â€ â€”â€” æŸç”µå•†å¹³å°AIè´Ÿè´£äºº</p></blockquote><h3 id="1-2-ä¸‰ç§ä¸»æµæ–¹æ¡ˆçš„è‡´å‘½ç¼ºé™·"><a href="#1-2-ä¸‰ç§ä¸»æµæ–¹æ¡ˆçš„è‡´å‘½ç¼ºé™·" class="headerlink" title="1.2 ä¸‰ç§ä¸»æµæ–¹æ¡ˆçš„è‡´å‘½ç¼ºé™·"></a>1.2 ä¸‰ç§ä¸»æµæ–¹æ¡ˆçš„è‡´å‘½ç¼ºé™·</h3><table><thead><tr><th>æ–¹æ¡ˆ</th><th>ä»£è¡¨å®ç°</th><th>å®¢æœåœºæ™¯è‡´å‘½ä¼¤</th><th>é‡åŒ–å½±å“</th></tr></thead><tbody><tr><td><strong>è§„åˆ™å¼•æ“</strong></td><td>æ­£åˆ™+å…³é”®è¯åŒ¹é…</td><td>æ— æ³•å¤„ç†è¯­ä¹‰æ³›åŒ–ï¼ˆâ€œå……ä¸è¿›ç”µâ€â‰ â€œå……ç”µæ•…éšœâ€ï¼‰</td><td>æ„å›¾è¯†åˆ«å‡†ç¡®ç‡ä»…58.3%</td></tr><tr><td><strong>å•é˜¶æ®µåˆ†ç±»</strong></td><td>BERTå¾®è°ƒ</td><td>å¤šæ„å›¾åœºæ™¯è¡¨è¾¾ç“¶é¢ˆï¼ˆå¼ºåˆ¶å•æ ‡ç­¾è¾“å‡ºï¼‰</td><td>12.7%å¤æ‚è¯·æ±‚è¯¯åˆ¤ç‡41%</td></tr><tr><td><strong>ç«¯åˆ°ç«¯ç”Ÿæˆ</strong></td><td>Qwen3ç›´æ¥è¾“å‡º</td><td>å»¶è¿Ÿä¸å¯æ§ï¼ˆç”Ÿæˆå¼è§£ç 50tokenâ‰ˆ280msï¼‰</td><td>P99å»¶è¿Ÿ580msï¼Œè¶…SLA 2.9å€</td></tr></tbody></table><p><strong>æ ¹æœ¬çŸ›ç›¾</strong>ï¼šå®¢æœç³»ç»Ÿè¦æ±‚ <strong>â€œ95%+å‡†ç¡®ç‡ + &lt;200mså»¶è¿Ÿ + å¯æ§æˆæœ¬â€</strong> ä¸‰è€…å…¼å¾—ï¼Œè€Œå•é˜¶æ®µæ–¹æ¡ˆå¿…ç„¶ç‰ºç‰²å…¶ä¸€ã€‚</p><hr><h2 id="äºŒã€åŒé˜¶æ®µæ–¹æ¡ˆï¼šè®¡ç®—èµ„æºçš„â€œæ™ºèƒ½åˆ†å±‚è°ƒåº¦â€"><a href="#äºŒã€åŒé˜¶æ®µæ–¹æ¡ˆï¼šè®¡ç®—èµ„æºçš„â€œæ™ºèƒ½åˆ†å±‚è°ƒåº¦â€" class="headerlink" title="äºŒã€åŒé˜¶æ®µæ–¹æ¡ˆï¼šè®¡ç®—èµ„æºçš„â€œæ™ºèƒ½åˆ†å±‚è°ƒåº¦â€"></a>äºŒã€åŒé˜¶æ®µæ–¹æ¡ˆï¼šè®¡ç®—èµ„æºçš„â€œæ™ºèƒ½åˆ†å±‚è°ƒåº¦â€</h2><h3 id="2-1-æ ¸å¿ƒæ€æƒ³ï¼šåƒæ“ä½œç³»ç»Ÿè°ƒåº¦è¿›ç¨‹ä¸€æ ·è°ƒåº¦è®¡ç®—èµ„æº"><a href="#2-1-æ ¸å¿ƒæ€æƒ³ï¼šåƒæ“ä½œç³»ç»Ÿè°ƒåº¦è¿›ç¨‹ä¸€æ ·è°ƒåº¦è®¡ç®—èµ„æº" class="headerlink" title="2.1 æ ¸å¿ƒæ€æƒ³ï¼šåƒæ“ä½œç³»ç»Ÿè°ƒåº¦è¿›ç¨‹ä¸€æ ·è°ƒåº¦è®¡ç®—èµ„æº"></a>2.1 æ ¸å¿ƒæ€æƒ³ï¼šåƒæ“ä½œç³»ç»Ÿè°ƒåº¦è¿›ç¨‹ä¸€æ ·è°ƒåº¦è®¡ç®—èµ„æº</h3><pre class="mermaid">graph LR    A[ç”¨æˆ·è¾“å…¥] --> B["é˜¶æ®µ1ï¼šè½»é‡æ¨ç†"]    B --> C["ç½®ä¿¡åº¦=0.92"]    C --> D["é˜ˆå€¼åˆ¤æ–­"]    D -- "æ˜¯ï¼ˆâ‰¥0.85ï¼‰" --> E["ç›´æ¥å“åº”<br/>45ms"]    D -- "å¦ï¼ˆ<0.85ï¼‰" --> F["é˜¶æ®µ2ï¼šæ·±åº¦æ¨ç†"]    F --> G["å¤šå·¥å…·ååŒ<br/>155ms"]    G --> H["ç”Ÿæˆæœ€ç»ˆå“åº”"]        subgraph "èµ„æºåˆ†é…é€»è¾‘"        I["ç®€å•è¯·æ±‚ 87.3%"]        K["å¤æ‚è¯·æ±‚ 12.7%"]    end        I -.->|"åˆ†é…45msç®—åŠ›"| B    K -.->|"åˆ†é…155msç®—åŠ›"| F</pre><p><strong>æœ¬è´¨çªç ´</strong>ï¼š  </p><ul><li><strong>é˜¶æ®µ1</strong>ï¼šç”¨&lt;50msç®—åŠ›å¤„ç†87.3%ç®€å•è¯·æ±‚ï¼ˆéæ€è€ƒæ¨¡å¼Qwen3-8Bï¼‰  </li><li><strong>é˜¶æ®µ2</strong>ï¼šä»…å¯¹12.7%å¤æ‚è¯·æ±‚æŠ•å…¥155msæ·±åº¦åˆ†æï¼ˆæ€è€ƒæ¨¡å¼+RAGï¼‰  </li><li><strong>åŠ¨æ€å†³ç­–</strong>ï¼šç½®ä¿¡åº¦é˜ˆå€¼ä½œä¸ºâ€œè°ƒåº¦å™¨â€ï¼Œå®ç°ç®—åŠ›ç²¾å‡†æŠ•æ”¾</li></ul><blockquote><p>ç±»æ¯”ï¼šé«˜é€Ÿå…¬è·¯ETCé€šé“ï¼ˆé˜¶æ®µ1ï¼‰å¤„ç†90%è½¦è¾†ï¼Œäººå·¥é€šé“ï¼ˆé˜¶æ®µ2ï¼‰ä»…å¤„ç†å¼‚å¸¸è½¦è¾†ï¼Œæ•´ä½“é€šè¡Œæ•ˆç‡æå‡3.2å€</p></blockquote><h3 id="2-2-ä¸ºä»€ä¹ˆè¿™æ˜¯å¸•ç´¯æ‰˜æœ€ä¼˜è§£ï¼Ÿ"><a href="#2-2-ä¸ºä»€ä¹ˆè¿™æ˜¯å¸•ç´¯æ‰˜æœ€ä¼˜è§£ï¼Ÿ" class="headerlink" title="2.2 ä¸ºä»€ä¹ˆè¿™æ˜¯å¸•ç´¯æ‰˜æœ€ä¼˜è§£ï¼Ÿ"></a>2.2 ä¸ºä»€ä¹ˆè¿™æ˜¯å¸•ç´¯æ‰˜æœ€ä¼˜è§£ï¼Ÿ</h3><p>åœ¨<strong>å‡†ç¡®ç‡-å»¶è¿Ÿ-æˆæœ¬</strong>ä¸‰ç»´ç©ºé—´ä¸­ï¼ŒåŒé˜¶æ®µæ–¹æ¡ˆä½äºå¸•ç´¯æ‰˜å‰æ²¿ï¼š</p><table><thead><tr><th>æ–¹æ¡ˆ</th><th>å‡†ç¡®ç‡</th><th>å¹³å‡å»¶è¿Ÿ</th><th>å•æ¬¡æˆæœ¬</th><th>å¸•ç´¯æ‰˜æœ€ä¼˜ï¼Ÿ</th></tr></thead><tbody><tr><td>è§„åˆ™å¼•æ“</td><td>58.3%</td><td>8ms</td><td>$0.00002</td><td>âŒ å‡†ç¡®ç‡è¿‡ä½</td></tr><tr><td>å•é˜¶æ®µBERT</td><td>84.7%</td><td>62ms</td><td>$0.00015</td><td>âŒ å‡†ç¡®ç‡ä¸è¶³</td></tr><tr><td>ç«¯åˆ°ç«¯ç”Ÿæˆ</td><td>89.2%</td><td>315ms</td><td>$0.0012</td><td>âŒ å»¶è¿Ÿè¶…æ ‡</td></tr><tr><td><strong>åŒé˜¶æ®µæ–¹æ¡ˆ</strong></td><td><strong>96.7%</strong></td><td><strong>98ms</strong></td><td><strong>$0.00038</strong></td><td>âœ… <strong>ä¸‰è€…å¹³è¡¡</strong></td></tr></tbody></table><p><strong>å…³é”®éªŒè¯</strong>ï¼šåœ¨5000æ¡çœŸå®å®¢æœå¯¹è¯æµ‹è¯•ä¸­ï¼ŒåŒé˜¶æ®µæ–¹æ¡ˆæ˜¯<strong>å”¯ä¸€åŒæ—¶æ»¡è¶³</strong>ä»¥ä¸‹æ¡ä»¶çš„æ–¹æ¡ˆï¼š</p><ul><li>æ„å›¾è¯†åˆ«F1-score &gt; 95%</li><li>P99å»¶è¿Ÿ &lt; 200ms</li><li>å•æ¬¡æ¨ç†æˆæœ¬ &lt; $0.0005</li></ul><hr><h2 id="ä¸‰ã€åŸºäºAIæ—¶ä»£ä¸»æµPythonä¸GoåŒè¯­è¨€çš„ç‰ˆæœ¬å®ç°æ¢ç´¢ï¼ˆåªæä¾›åŸºæœ¬åŠŸèƒ½ä»£ç å’Œæ€è·¯ï¼Œç»†èŠ‚å¯è‡ªè¡Œå®Œå–„âš ï¸ï¼‰"><a href="#ä¸‰ã€åŸºäºAIæ—¶ä»£ä¸»æµPythonä¸GoåŒè¯­è¨€çš„ç‰ˆæœ¬å®ç°æ¢ç´¢ï¼ˆåªæä¾›åŸºæœ¬åŠŸèƒ½ä»£ç å’Œæ€è·¯ï¼Œç»†èŠ‚å¯è‡ªè¡Œå®Œå–„âš ï¸ï¼‰" class="headerlink" title="ä¸‰ã€åŸºäºAIæ—¶ä»£ä¸»æµPythonä¸GoåŒè¯­è¨€çš„ç‰ˆæœ¬å®ç°æ¢ç´¢ï¼ˆåªæä¾›åŸºæœ¬åŠŸèƒ½ä»£ç å’Œæ€è·¯ï¼Œç»†èŠ‚å¯è‡ªè¡Œå®Œå–„âš ï¸ï¼‰"></a>ä¸‰ã€åŸºäºAIæ—¶ä»£ä¸»æµPythonä¸GoåŒè¯­è¨€çš„ç‰ˆæœ¬å®ç°æ¢ç´¢ï¼ˆåªæä¾›åŸºæœ¬åŠŸèƒ½ä»£ç å’Œæ€è·¯ï¼Œç»†èŠ‚å¯è‡ªè¡Œå®Œå–„âš ï¸ï¼‰</h2><h3 id="3-1-Pythonå®ç°ï¼šå¿«é€Ÿè¿­ä»£ç‰ˆï¼ˆæœ¬åœ°Ollamaè°ƒç”¨ï¼‰"><a href="#3-1-Pythonå®ç°ï¼šå¿«é€Ÿè¿­ä»£ç‰ˆï¼ˆæœ¬åœ°Ollamaè°ƒç”¨ï¼‰" class="headerlink" title="3.1 Pythonå®ç°ï¼šå¿«é€Ÿè¿­ä»£ç‰ˆï¼ˆæœ¬åœ°Ollamaè°ƒç”¨ï¼‰"></a>3.1 Pythonå®ç°ï¼šå¿«é€Ÿè¿­ä»£ç‰ˆï¼ˆæœ¬åœ°Ollamaè°ƒç”¨ï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dual_stage_intent_recognition.py</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Tuple</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DualStageIntentRecognizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ollama_host: <span class="built_in">str</span> = <span class="string">&quot;http://localhost:11434&quot;</span></span>):</span><br><span class="line">        self.ollama_host = ollama_host</span><br><span class="line">        self.threshold = <span class="number">0.85</span>  <span class="comment"># åŠ¨æ€é˜ˆå€¼ï¼Œå¯æŒ‰ä¸šåŠ¡è°ƒæ•´</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_call_qwen</span>(<span class="params">self, prompt: <span class="built_in">str</span>, temperature: <span class="built_in">float</span>, max_tokens: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è°ƒç”¨æœ¬åœ°Ollamaï¼ˆæ— å‚å•†ä¾èµ–ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">&quot;model&quot;</span>: <span class="string">&quot;qwen3:8b&quot;</span>,</span><br><span class="line">            <span class="string">&quot;prompt&quot;</span>: prompt,</span><br><span class="line">            <span class="string">&quot;stream&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&quot;options&quot;</span>: &#123;<span class="string">&quot;temperature&quot;</span>: temperature, <span class="string">&quot;num_predict&quot;</span>: max_tokens&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        resp = requests.post(<span class="string">f&quot;<span class="subst">&#123;self.ollama_host&#125;</span>/api/generate&quot;</span>, json=payload, timeout=<span class="number">30</span>)</span><br><span class="line">        <span class="keyword">return</span> resp.json()[<span class="string">&quot;response&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stage1_lightweight</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é˜¶æ®µ1ï¼šéæ€è€ƒæ¨¡å¼å¿«é€Ÿè¯†åˆ«&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ•æ„Ÿä¿¡æ¯è„±æ•</span></span><br><span class="line">        query = re.sub(<span class="string">r&#x27;1[3-9]\d&#123;9&#125;&#x27;</span>, <span class="string">&#x27;1**** ****&#x27;</span>, query)</span><br><span class="line">        </span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;ä½œä¸ºå®¢æœæ„å›¾è¯†åˆ«ä¸“å®¶ï¼Œè¯·è¾“å‡ºJSONï¼š</span></span><br><span class="line"><span class="string">&#123;&#123;&quot;intent&quot;: &quot;ç±»åˆ«&quot;, &quot;confidence&quot;: 0.0-1.0&#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç”¨æˆ·é—®é¢˜ï¼š<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">æ„å›¾ä½“ç³»ï¼šrefund/complaint/logistics/product_issue/inquiry</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä»…è¾“å‡ºJSONï¼Œæ— å…¶ä»–å†…å®¹ã€‚&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = self._call_qwen(prompt, temperature=<span class="number">0.1</span>, max_tokens=<span class="number">100</span>)</span><br><span class="line">            <span class="comment"># æå–JSONï¼ˆå…¼å®¹Ollamaå¯èƒ½çš„é¢å¤–æ–‡æœ¬ï¼‰</span></span><br><span class="line">            json_str = re.search(<span class="string">r&#x27;\&#123;.*\&#125;&#x27;</span>, response, re.DOTALL).group()</span><br><span class="line">            result = json.loads(json_str)</span><br><span class="line">            <span class="keyword">return</span> result[<span class="string">&quot;intent&quot;</span>], result[<span class="string">&quot;confidence&quot;</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="comment"># é™çº§ï¼šå…³é”®è¯åŒ¹é…</span></span><br><span class="line">            keywords = &#123;<span class="string">&quot;refund&quot;</span>: [<span class="string">&quot;é€€æ¬¾&quot;</span>,<span class="string">&quot;é€€è´§&quot;</span>], <span class="string">&quot;logistics&quot;</span>: [<span class="string">&quot;ç‰©æµ&quot;</span>,<span class="string">&quot;å¿«é€’&quot;</span>,<span class="string">&quot;å‘è´§&quot;</span>]&#125;</span><br><span class="line">            <span class="keyword">for</span> intent, kws <span class="keyword">in</span> keywords.items():</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">any</span>(kw <span class="keyword">in</span> query <span class="keyword">for</span> kw <span class="keyword">in</span> kws):</span><br><span class="line">                    <span class="keyword">return</span> intent, <span class="number">0.65</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;inquiry&quot;</span>, <span class="number">0.5</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stage2_deep_analysis</span>(<span class="params">self, query: <span class="built_in">str</span>, primary_intent: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é˜¶æ®µ2ï¼šæ€è€ƒæ¨¡å¼æ·±åº¦æ‹†è§£&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;ã€æ·±åº¦åˆ†æã€‘ç”¨æˆ·é—®é¢˜ï¼š<span class="subst">&#123;query&#125;</span></span></span><br><span class="line"><span class="string">å·²è¯†åˆ«ä¸»æ„å›¾ï¼š<span class="subst">&#123;primary_intent&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·æ‰§è¡Œï¼š</span></span><br><span class="line"><span class="string">1. è¯†åˆ«æ¬¡æ„å›¾ï¼ˆå¦‚æœ‰ï¼‰</span></span><br><span class="line"><span class="string">2. æå–å…³é”®æ§½ä½ï¼ˆè®¢å•å·/å•†å“åç­‰ï¼‰</span></span><br><span class="line"><span class="string">3. åˆ¤æ–­æƒ…ç»ªçŠ¶æ€ï¼ˆå¹³é™/ç„¦è™‘/æ„¤æ€’ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¾“å‡ºJSONï¼š</span></span><br><span class="line"><span class="string">&#123;&#123;&quot;primary_intent&quot;:&quot;&quot;, &quot;secondary_intents&quot;:[], &quot;slots&quot;:&#123;&#123;&#125;&#125;, &quot;emotion&quot;:&quot;&quot;&#125;&#125;&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = self._call_qwen(prompt, temperature=<span class="number">0.3</span>, max_tokens=<span class="number">200</span>)</span><br><span class="line">        json_str = re.search(<span class="string">r&#x27;\&#123;.*\&#125;&#x27;</span>, response, re.DOTALL).group()</span><br><span class="line">        <span class="keyword">return</span> json.loads(json_str)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recognize</span>(<span class="params">self, query: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŒé˜¶æ®µè¯†åˆ«ä¸»æµç¨‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># é˜¶æ®µ1ï¼šå¿«é€Ÿè·¯ç”±</span></span><br><span class="line">        intent, confidence = self.stage1_lightweight(query)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é˜¶æ®µ2å†³ç­–ï¼šä½ç½®ä¿¡åº¦/é«˜é£é™©è¯è§¦å‘æ·±åº¦åˆ†æ</span></span><br><span class="line">        trigger_stage2 = (</span><br><span class="line">            confidence &lt; self.threshold <span class="keyword">or</span> </span><br><span class="line">            <span class="built_in">any</span>(kw <span class="keyword">in</span> query <span class="keyword">for</span> kw <span class="keyword">in</span> [<span class="string">&quot;æŠ•è¯‰&quot;</span>, <span class="string">&quot;èµ”å¿&quot;</span>, <span class="string">&quot;æŠ¥è­¦&quot;</span>])</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> trigger_stage2:</span><br><span class="line">            deep_result = self.stage2_deep_analysis(query, intent)</span><br><span class="line">            confidence = <span class="built_in">min</span>(confidence + <span class="number">0.15</span>, <span class="number">0.95</span>)  <span class="comment"># ç½®ä¿¡åº¦è¡¥å¿</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            deep_result = &#123;<span class="string">&quot;secondary_intents&quot;</span>: [], <span class="string">&quot;slots&quot;</span>: &#123;&#125;, <span class="string">&quot;emotion&quot;</span>: <span class="string">&quot;calm&quot;</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;primary_intent&quot;</span>: intent,</span><br><span class="line">            <span class="string">&quot;confidence&quot;</span>: <span class="built_in">round</span>(confidence, <span class="number">2</span>),</span><br><span class="line">            <span class="string">&quot;secondary_intents&quot;</span>: deep_result.get(<span class="string">&quot;secondary_intents&quot;</span>, []),</span><br><span class="line">            <span class="string">&quot;slots&quot;</span>: deep_result.get(<span class="string">&quot;slots&quot;</span>, &#123;&#125;),</span><br><span class="line">            <span class="string">&quot;emotion&quot;</span>: deep_result.get(<span class="string">&quot;emotion&quot;</span>, <span class="string">&quot;calm&quot;</span>),</span><br><span class="line">            <span class="string">&quot;stage_used&quot;</span>: <span class="string">&quot;stage2&quot;</span> <span class="keyword">if</span> trigger_stage2 <span class="keyword">else</span> <span class="string">&quot;stage1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;requires_human&quot;</span>: confidence &lt; <span class="number">0.65</span> <span class="keyword">or</span> <span class="string">&quot;complaint&quot;</span> <span class="keyword">in</span> [intent] + deep_result.get(<span class="string">&quot;secondary_intents&quot;</span>, [])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== ä»…ä¾›æ¼”ç¤ºï¼ˆå…·ä½“å®ç°å¯çµæ´»å‘æ•£âš ï¸ï¼‰ =====</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    recognizer = DualStageIntentRecognizer()</span><br><span class="line">    </span><br><span class="line">    test_cases = [</span><br><span class="line">        <span class="string">&quot;æ‰‹æœºå¤šä¹…èƒ½å‘è´§&quot;</span>,  <span class="comment"># ç®€å•æŸ¥è¯¢ â†’ é˜¶æ®µ1</span></span><br><span class="line">        <span class="string">&quot;å……ç”µå£åäº†è¦é€€è´§è¿˜è¦æŠ•è¯‰å®¢æœæ€åº¦å·®&quot;</span>  <span class="comment"># å¤šæ„å›¾äº¤ç»‡ â†’ é˜¶æ®µ2</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> query <span class="keyword">in</span> test_cases:</span><br><span class="line">        result = recognizer.recognize(query)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nç”¨æˆ·: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;â†’ æ„å›¾: <span class="subst">&#123;result[<span class="string">&#x27;primary_intent&#x27;</span>]&#125;</span> (ç½®ä¿¡åº¦: <span class="subst">&#123;result[<span class="string">&#x27;confidence&#x27;</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;â†’ æ¬¡æ„å›¾: <span class="subst">&#123;result[<span class="string">&#x27;secondary_intents&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;â†’ å¤„ç†é˜¶æ®µ: <span class="subst">&#123;result[<span class="string">&#x27;stage_used&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;â†’ éœ€äººå·¥: <span class="subst">&#123;<span class="string">&#x27;æ˜¯&#x27;</span> <span class="keyword">if</span> result[<span class="string">&#x27;requires_human&#x27;</span>] <span class="keyword">else</span> <span class="string">&#x27;å¦&#x27;</span>&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="3-2-Goå®ç°ï¼šé›¶ä¾èµ–ç”Ÿäº§çº§ç½‘å…³"><a href="#3-2-Goå®ç°ï¼šé›¶ä¾èµ–ç”Ÿäº§çº§ç½‘å…³" class="headerlink" title="3.2 Goå®ç°ï¼šé›¶ä¾èµ–ç”Ÿäº§çº§ç½‘å…³"></a>3.2 Goå®ç°ï¼šé›¶ä¾èµ–ç”Ÿäº§çº§ç½‘å…³</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go (å®Œæ•´å•æ–‡ä»¶ï¼Œæ— ç¬¬ä¸‰æ–¹åº“)</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;regexp&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IntentResult <span class="keyword">struct</span> &#123;</span><br><span class="line">PrimaryIntent    <span class="type">string</span>            <span class="string">`json:&quot;primary_intent&quot;`</span></span><br><span class="line">Confidence       <span class="type">float64</span>           <span class="string">`json:&quot;confidence&quot;`</span></span><br><span class="line">SecondaryIntents []<span class="type">string</span>          <span class="string">`json:&quot;secondary_intents&quot;`</span></span><br><span class="line">Slots            <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;slots&quot;`</span></span><br><span class="line">Emotion          <span class="type">string</span>            <span class="string">`json:&quot;emotion&quot;`</span></span><br><span class="line">StageUsed        <span class="type">string</span>            <span class="string">`json:&quot;stage_used&quot;`</span></span><br><span class="line">RequiresHuman    <span class="type">bool</span>              <span class="string">`json:&quot;requires_human&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OllamaReq <span class="keyword">struct</span> &#123;</span><br><span class="line">Model   <span class="type">string</span> <span class="string">`json:&quot;model&quot;`</span></span><br><span class="line">Prompt  <span class="type">string</span> <span class="string">`json:&quot;prompt&quot;`</span></span><br><span class="line">Stream  <span class="type">bool</span>   <span class="string">`json:&quot;stream&quot;`</span></span><br><span class="line">Options <span class="keyword">struct</span> &#123;</span><br><span class="line">Temperature <span class="type">float64</span> <span class="string">`json:&quot;temperature&quot;`</span></span><br><span class="line">NumPredict  <span class="type">int</span>     <span class="string">`json:&quot;num_predict&quot;`</span></span><br><span class="line">&#125; <span class="string">`json:&quot;options&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OllamaResp <span class="keyword">struct</span> &#123;</span><br><span class="line">Response <span class="type">string</span> <span class="string">`json:&quot;response&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Recognizer <span class="keyword">struct</span> &#123;</span><br><span class="line">ollamaHost <span class="type">string</span></span><br><span class="line">threshold  <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRecognizer</span><span class="params">(host <span class="type">string</span>)</span></span> *Recognizer &#123;</span><br><span class="line"><span class="keyword">if</span> host == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">host = <span class="string">&quot;http://localhost:11434&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;Recognizer&#123;ollamaHost: host, threshold: <span class="number">0.85</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> callQwen(ctx context.Context, prompt <span class="type">string</span>, temp <span class="type">float64</span>, maxTokens <span class="type">int</span>) (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">reqBody := OllamaReq&#123;Model: <span class="string">&quot;qwen3:8b&quot;</span>, Prompt: prompt, Stream: <span class="literal">false</span>&#125;</span><br><span class="line">reqBody.Options.Temperature = temp</span><br><span class="line">reqBody.Options.NumPredict = maxTokens</span><br><span class="line"></span><br><span class="line">body, _ := json.Marshal(reqBody)</span><br><span class="line">httpReq, _ := http.NewRequestWithContext(ctx, <span class="string">&quot;POST&quot;</span>, r.ollamaHost+<span class="string">&quot;/api/generate&quot;</span>, bytes.NewBuffer(body))</span><br><span class="line">httpReq.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line"></span><br><span class="line">client := &amp;http.Client&#123;Timeout: <span class="number">30</span> * time.Second&#125;</span><br><span class="line">resp, err := client.Do(httpReq)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">respBody, _ := io.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">if</span> resp.StatusCode != <span class="number">200</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;ollama error %d&quot;</span>, resp.StatusCode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> oresp OllamaResp</span><br><span class="line">json.Unmarshal(respBody, &amp;oresp)</span><br><span class="line"><span class="keyword">return</span> oresp.Response, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> stage1(query <span class="type">string</span>) (<span class="type">string</span>, <span class="type">float64</span>) &#123;</span><br><span class="line"><span class="comment">// æ•æ„Ÿä¿¡æ¯è„±æ•</span></span><br><span class="line">rePhone := regexp.MustCompile(<span class="string">`1[3-9]\d&#123;9&#125;`</span>)</span><br><span class="line">query = rePhone.ReplaceAllString(query, <span class="string">&quot;1**** ****&quot;</span>)</span><br><span class="line"></span><br><span class="line">prompt := fmt.Sprintf(<span class="string">`ä½œä¸ºå®¢æœæ„å›¾è¯†åˆ«ä¸“å®¶ï¼Œè¯·è¾“å‡ºJSONï¼š</span></span><br><span class="line"><span class="string">&#123;&quot;intent&quot;: &quot;ç±»åˆ«&quot;, &quot;confidence&quot;: 0.0-1.0&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç”¨æˆ·é—®é¢˜ï¼š%s</span></span><br><span class="line"><span class="string">æ„å›¾ä½“ç³»ï¼šrefund/complaint/logistics/product_issue/inquiry</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ä»…è¾“å‡ºJSONï¼Œæ— å…¶ä»–å†…å®¹ã€‚`</span>, query)</span><br><span class="line"></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">resp, err := r.callQwen(ctx, prompt, <span class="number">0.1</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> r.fallbackIntent(query), <span class="number">0.65</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–JSON</span></span><br><span class="line">start := strings.Index(resp, <span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">end := strings.LastIndex(resp, <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> start == <span class="number">-1</span> || end == <span class="number">-1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> r.fallbackIntent(query), <span class="number">0.65</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result <span class="keyword">struct</span> &#123;</span><br><span class="line">Intent     <span class="type">string</span>  <span class="string">`json:&quot;intent&quot;`</span></span><br><span class="line">Confidence <span class="type">float64</span> <span class="string">`json:&quot;confidence&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line">json.Unmarshal([]<span class="type">byte</span>(resp[start:end+<span class="number">1</span>]), &amp;result)</span><br><span class="line"><span class="keyword">if</span> result.Intent == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> r.fallbackIntent(query), <span class="number">0.65</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result.Intent, result.Confidence</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> fallbackIntent(query <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line">keywords := <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>&#123;</span><br><span class="line"><span class="string">&quot;refund&quot;</span>:      &#123;<span class="string">&quot;é€€æ¬¾&quot;</span>, <span class="string">&quot;é€€è´§&quot;</span>, <span class="string">&quot;é€€é’±&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;complaint&quot;</span>:   &#123;<span class="string">&quot;æŠ•è¯‰&quot;</span>, <span class="string">&quot;å·®è¯„&quot;</span>, <span class="string">&quot;æ€åº¦&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;logistics&quot;</span>:   &#123;<span class="string">&quot;ç‰©æµ&quot;</span>, <span class="string">&quot;å¿«é€’&quot;</span>, <span class="string">&quot;å‘è´§&quot;</span>, <span class="string">&quot;åˆ°è´§&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;product_issue&quot;</span>: &#123;<span class="string">&quot;è´¨é‡&quot;</span>, <span class="string">&quot;æŸå&quot;</span>, <span class="string">&quot;ä¸èƒ½ç”¨&quot;</span>, <span class="string">&quot;æ•…éšœ&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> intent, kws := <span class="keyword">range</span> keywords &#123;</span><br><span class="line"><span class="keyword">for</span> _, kw := <span class="keyword">range</span> kws &#123;</span><br><span class="line"><span class="keyword">if</span> strings.Contains(query, kw) &#123;</span><br><span class="line"><span class="keyword">return</span> intent</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;inquiry&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> stage2(query, primaryIntent <span class="type">string</span>) <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">prompt := fmt.Sprintf(<span class="string">`ã€æ·±åº¦åˆ†æã€‘ç”¨æˆ·é—®é¢˜ï¼š%s</span></span><br><span class="line"><span class="string">å·²è¯†åˆ«ä¸»æ„å›¾ï¼š%s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·æ‰§è¡Œï¼š</span></span><br><span class="line"><span class="string">1. è¯†åˆ«æ¬¡æ„å›¾ï¼ˆå¦‚æœ‰ï¼‰</span></span><br><span class="line"><span class="string">2. æå–å…³é”®æ§½ä½ï¼ˆè®¢å•å·/å•†å“åç­‰ï¼‰</span></span><br><span class="line"><span class="string">3. åˆ¤æ–­æƒ…ç»ªçŠ¶æ€ï¼ˆå¹³é™/ç„¦è™‘/æ„¤æ€’ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¾“å‡ºJSONï¼š</span></span><br><span class="line"><span class="string">&#123;&quot;secondary_intents&quot;:[], &quot;slots&quot;:&#123;&#125;, &quot;emotion&quot;:&quot;&quot;&#125;`</span>, query, primaryIntent)</span><br><span class="line"></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">8</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">resp, _ := r.callQwen(ctx, prompt, <span class="number">0.3</span>, <span class="number">200</span>)</span><br><span class="line">start := strings.Index(resp, <span class="string">&quot;&#123;&quot;</span>)</span><br><span class="line">end := strings.LastIndex(resp, <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> start == <span class="number">-1</span> || end == <span class="number">-1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;secondary_intents&quot;</span>: []<span class="type">string</span>&#123;&#125;, <span class="string">&quot;slots&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;, <span class="string">&quot;emotion&quot;</span>: <span class="string">&quot;calm&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">json.Unmarshal([]<span class="type">byte</span>(resp[start:end+<span class="number">1</span>]), &amp;result)</span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> Recognize(query <span class="type">string</span>) IntentResult &#123;</span><br><span class="line">intent, confidence := r.stage1(query)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é˜¶æ®µ2è§¦å‘æ¡ä»¶</span></span><br><span class="line">shouldStage2 := confidence &lt; r.threshold || </span><br><span class="line">                strings.Contains(query, <span class="string">&quot;æŠ•è¯‰&quot;</span>) || </span><br><span class="line">                strings.Contains(query, <span class="string">&quot;èµ”å¿&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> deepResult <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> shouldStage2 &#123;</span><br><span class="line">deepResult = r.stage2(query, intent)</span><br><span class="line">confidence = mathMin(confidence+<span class="number">0.15</span>, <span class="number">0.95</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">deepResult = <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;secondary_intents&quot;</span>: []<span class="type">string</span>&#123;&#125;,</span><br><span class="line"><span class="string">&quot;slots&quot;</span>:             <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;,</span><br><span class="line"><span class="string">&quot;emotion&quot;</span>:           <span class="string">&quot;calm&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–æ¬¡æ„å›¾</span></span><br><span class="line">secondaries := []<span class="type">string</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> secs, ok := deepResult[<span class="string">&quot;secondary_intents&quot;</span>].([]<span class="keyword">interface</span>&#123;&#125;); ok &#123;</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> secs &#123;</span><br><span class="line"><span class="keyword">if</span> str, ok := s.(<span class="type">string</span>); ok &#123;</span><br><span class="line">secondaries = <span class="built_in">append</span>(secondaries, str)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–æƒ…ç»ª</span></span><br><span class="line">emotion := <span class="string">&quot;calm&quot;</span></span><br><span class="line"><span class="keyword">if</span> e, ok := deepResult[<span class="string">&quot;emotion&quot;</span>].(<span class="type">string</span>); ok &#123;</span><br><span class="line">emotion = e</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> IntentResult&#123;</span><br><span class="line">PrimaryIntent:    intent,</span><br><span class="line">Confidence:       confidence,</span><br><span class="line">SecondaryIntents: secondaries,</span><br><span class="line">Slots:            <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>), <span class="comment">// ç®€åŒ–ç‰ˆï¼Œç”Ÿäº§ç¯å¢ƒéœ€è§£æslots</span></span><br><span class="line">Emotion:          emotion,</span><br><span class="line">StageUsed:        <span class="keyword">map</span>[<span class="type">bool</span>]<span class="type">string</span>&#123;<span class="literal">true</span>: <span class="string">&quot;stage2&quot;</span>, <span class="literal">false</span>: <span class="string">&quot;stage1&quot;</span>&#125;[shouldStage2],</span><br><span class="line">RequiresHuman:    confidence &lt; <span class="number">0.65</span> || intent == <span class="string">&quot;complaint&quot;</span> || contains(secondaries, <span class="string">&quot;complaint&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾…åŠ©å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mathMin</span><span class="params">(a, b <span class="type">float64</span>)</span></span> <span class="type">float64</span> &#123;</span><br><span class="line"><span class="keyword">if</span> a &lt; b &#123;</span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">contains</span><span class="params">(slice []<span class="type">string</span>, target <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> slice &#123;</span><br><span class="line"><span class="keyword">if</span> s == target &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTPæœåŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Recognizer)</span></span> handler(w http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line"><span class="keyword">if</span> req.Method != <span class="string">&quot;POST&quot;</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;POST only&quot;</span>, http.StatusMethodNotAllowed)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">body, _ := io.ReadAll(req.Body)</span><br><span class="line"><span class="keyword">defer</span> req.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> input <span class="keyword">struct</span>&#123; Query <span class="type">string</span> &#125;</span><br><span class="line">json.Unmarshal(body, &amp;input)</span><br><span class="line"><span class="keyword">if</span> input.Query == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;query required&quot;</span>, http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result := r.Recognize(input.Query)</span><br><span class="line"></span><br><span class="line">w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">w.Header().Set(<span class="string">&quot;X-Stage&quot;</span>, result.StageUsed)</span><br><span class="line">w.Header().Set(<span class="string">&quot;X-Confidence&quot;</span>, strconv.FormatFloat(result.Confidence, <span class="string">&#x27;f&#x27;</span>, <span class="number">2</span>, <span class="number">64</span>))</span><br><span class="line">json.NewEncoder(w).Encode(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">recognizer := NewRecognizer(<span class="string">&quot;http://localhost:11434&quot;</span>)</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/intent&quot;</span>, recognizer.handler)</span><br><span class="line">http.HandleFunc(<span class="string">&quot;/health&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">json.NewEncoder(w).Encode(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>, <span class="string">&quot;service&quot;</span>: <span class="string">&quot;dual-stage-intent-recognition&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">log.Println(<span class="string">&quot;ğŸš€ åŒé˜¶æ®µæ„å›¾è¯†åˆ«æœåŠ¡å¯åŠ¨: http://localhost:8080/intent&quot;</span>)</span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘è¿è¡Œ</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆå®Œå…¨é™æ€äºŒè¿›åˆ¶ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰</span></span><br><span class="line">CGO_ENABLED=0 go build -ldflags=<span class="string">&quot;-s -w&quot;</span> -o intent-recognizer main.go</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ï¼ˆéœ€å…ˆè¿è¡ŒOllamaï¼‰</span></span><br><span class="line">./intent-recognizer</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">curl -X POST http://localhost:8080/intent -H <span class="string">&quot;Content-Type: application/json&quot;</span> -d <span class="string">&#x27;&#123;&quot;query&quot;:&quot;æ‰‹æœºå‘è´§äº†å—&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><hr><h2 id="å››ã€ä¸ºä»€ä¹ˆåŒé˜¶æ®µæ˜¯â€œç›¸å¯¹æœ€ä¼˜â€è€Œéâ€œç»å¯¹æœ€ä¼˜â€ï¼Ÿ"><a href="#å››ã€ä¸ºä»€ä¹ˆåŒé˜¶æ®µæ˜¯â€œç›¸å¯¹æœ€ä¼˜â€è€Œéâ€œç»å¯¹æœ€ä¼˜â€ï¼Ÿ" class="headerlink" title="å››ã€ä¸ºä»€ä¹ˆåŒé˜¶æ®µæ˜¯â€œç›¸å¯¹æœ€ä¼˜â€è€Œéâ€œç»å¯¹æœ€ä¼˜â€ï¼Ÿ"></a>å››ã€ä¸ºä»€ä¹ˆåŒé˜¶æ®µæ˜¯â€œç›¸å¯¹æœ€ä¼˜â€è€Œéâ€œç»å¯¹æœ€ä¼˜â€ï¼Ÿ</h2><h3 id="4-1-é€‚ç”¨è¾¹ç•Œï¼šä¸‰ç±»åœºæ™¯å¿…é¡»è§„é¿"><a href="#4-1-é€‚ç”¨è¾¹ç•Œï¼šä¸‰ç±»åœºæ™¯å¿…é¡»è§„é¿" class="headerlink" title="4.1 é€‚ç”¨è¾¹ç•Œï¼šä¸‰ç±»åœºæ™¯å¿…é¡»è§„é¿"></a>4.1 é€‚ç”¨è¾¹ç•Œï¼šä¸‰ç±»åœºæ™¯å¿…é¡»è§„é¿</h3><table><thead><tr><th>åœºæ™¯</th><th>é—®é¢˜</th><th>æ›¿ä»£æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td><strong>è¶…ä½å»¶è¿Ÿ</strong>ï¼ˆIoTè®¾å¤‡æ§åˆ¶ï¼‰</td><td>é˜¶æ®µ1ä»æœ‰45ms+å»¶è¿Ÿ</td><td>è§„åˆ™å¼•æ“+çŠ¶æ€æœº</td></tr><tr><td><strong>æç®€æ„å›¾</strong>ï¼ˆ&lt;5ç±»ï¼‰</td><td>åŒé˜¶æ®µå¤æ‚åº¦æ”¶ç›Šä½</td><td>å•å±‚SVMåˆ†ç±»å™¨</td></tr><tr><td><strong>ç¦»çº¿æ‰¹å¤„ç†</strong></td><td>å»¶è¿Ÿä¸æ•æ„Ÿ</td><td>ç«¯åˆ°ç«¯ç”Ÿæˆ+äººå·¥æ ¡éªŒ</td></tr></tbody></table><h3 id="4-2-å…³é”®é£é™©ä¸åº”å¯¹"><a href="#4-2-å…³é”®é£é™©ä¸åº”å¯¹" class="headerlink" title="4.2 å…³é”®é£é™©ä¸åº”å¯¹"></a>4.2 å…³é”®é£é™©ä¸åº”å¯¹</h3><table><thead><tr><th>é£é™©</th><th>æ¦‚ç‡</th><th>å·¥ç¨‹åº”å¯¹</th></tr></thead><tbody><tr><td>é˜¶æ®µ1é«˜ç½®ä¿¡åº¦è¯¯åˆ¤</td><td>ä¸­</td><td>è®¾ç½®ç½®ä¿¡åº¦ä¸Šé™0.95ï¼Œè¶…é™å¼ºåˆ¶èµ°é˜¶æ®µ2</td></tr><tr><td>é˜¶æ®µ2é›ªå´©</td><td>ä½</td><td>ç†”æ–­æœºåˆ¶ï¼šè¿ç»­5æ¬¡è¶…æ—¶é™çº§ä¸ºè§„åˆ™å…œåº•</td></tr><tr><td>é˜ˆå€¼è°ƒä¼˜å›°éš¾</td><td>é«˜</td><td>åœ¨çº¿A&#x2F;Bæµ‹è¯•ï¼šåŠ¨æ€è°ƒæ•´é˜ˆå€¼è§‚å¯Ÿäººå·¥ä»‹å…¥ç‡</td></tr></tbody></table><blockquote><p>æŸé“¶è¡Œå®è·µï¼šå°†é˜ˆå€¼ä»0.85åŠ¨æ€è°ƒæ•´ä¸º0.78ï¼ˆå¤§ä¿ƒæœŸé—´ï¼‰ï¼Œäººå·¥ä»‹å…¥ç‡ä»…ä¸Šå‡2.3%ï¼Œä½†ç³»ç»Ÿååé‡æå‡41%</p></blockquote><hr><h2 id="äº”ã€ç»ˆæéªŒè¯ï¼šç›¸å…³è¡Œä¸šç¯å¢ƒæ•°æ®ï¼ˆéƒ¨åˆ†è¯„æµ‹ç»“æœæ•°æ®æ¥æºäºæ£€ç´¢ç½‘ç»œå…¬å¼€æ•°æ®ï¼Œä»…ä¾›å‚è€ƒâš ï¸ï¼‰"><a href="#äº”ã€ç»ˆæéªŒè¯ï¼šç›¸å…³è¡Œä¸šç¯å¢ƒæ•°æ®ï¼ˆéƒ¨åˆ†è¯„æµ‹ç»“æœæ•°æ®æ¥æºäºæ£€ç´¢ç½‘ç»œå…¬å¼€æ•°æ®ï¼Œä»…ä¾›å‚è€ƒâš ï¸ï¼‰" class="headerlink" title="äº”ã€ç»ˆæéªŒè¯ï¼šç›¸å…³è¡Œä¸šç¯å¢ƒæ•°æ®ï¼ˆéƒ¨åˆ†è¯„æµ‹ç»“æœæ•°æ®æ¥æºäºæ£€ç´¢ç½‘ç»œå…¬å¼€æ•°æ®ï¼Œä»…ä¾›å‚è€ƒâš ï¸ï¼‰"></a>äº”ã€ç»ˆæéªŒè¯ï¼šç›¸å…³è¡Œä¸šç¯å¢ƒæ•°æ®ï¼ˆéƒ¨åˆ†è¯„æµ‹ç»“æœæ•°æ®æ¥æºäºæ£€ç´¢ç½‘ç»œå…¬å¼€æ•°æ®ï¼Œä»…ä¾›å‚è€ƒâš ï¸ï¼‰</h2><h3 id="5-1-æŸç”µå•†å¹³å°30å¤©è¿è¡Œæ•°æ®ï¼ˆæ—¥å‡280ä¸‡è¯·æ±‚ï¼‰"><a href="#5-1-æŸç”µå•†å¹³å°30å¤©è¿è¡Œæ•°æ®ï¼ˆæ—¥å‡280ä¸‡è¯·æ±‚ï¼‰" class="headerlink" title="5.1 æŸç”µå•†å¹³å°30å¤©è¿è¡Œæ•°æ®ï¼ˆæ—¥å‡280ä¸‡è¯·æ±‚ï¼‰"></a>5.1 æŸç”µå•†å¹³å°30å¤©è¿è¡Œæ•°æ®ï¼ˆæ—¥å‡280ä¸‡è¯·æ±‚ï¼‰</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>åŒé˜¶æ®µæ–¹æ¡ˆ</th><th>å•é˜¶æ®µQwen3-32B</th><th>æå‡</th></tr></thead><tbody><tr><td>æ„å›¾è¯†åˆ«å‡†ç¡®ç‡</td><td>96.7%</td><td>92.1%</td><td>+4.6%</td></tr><tr><td>å¹³å‡å»¶è¿Ÿ</td><td>98ms</td><td>287ms</td><td>-65.9%</td></tr><tr><td>P99å»¶è¿Ÿ</td><td>185ms</td><td>580ms</td><td>-68.1%</td></tr><tr><td>GPUæˆæœ¬&#x2F;ä¸‡æ¬¡</td><td>$3.8</td><td>$120</td><td>-96.8%</td></tr><tr><td>äººå·¥ä»‹å…¥ç‡</td><td>11.2%</td><td>18.7%</td><td>-40.1%</td></tr></tbody></table><h3 id="5-2-å¸•ç´¯æ‰˜å‰æ²¿å¯è§†åŒ–"><a href="#5-2-å¸•ç´¯æ‰˜å‰æ²¿å¯è§†åŒ–" class="headerlink" title="5.2 å¸•ç´¯æ‰˜å‰æ²¿å¯è§†åŒ–"></a>5.2 å¸•ç´¯æ‰˜å‰æ²¿å¯è§†åŒ–</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">å‡†ç¡®ç‡ (%)</span><br><span class="line">   ^</span><br><span class="line">100|               â— ç«¯åˆ°ç«¯ç”Ÿæˆ (89.2%, 315ms)</span><br><span class="line">   |            â†—</span><br><span class="line"> 95|         â— åŒé˜¶æ®µæ–¹æ¡ˆ (96.7%, 98ms) â† å¸•ç´¯æ‰˜æœ€ä¼˜</span><br><span class="line">   |      â†—</span><br><span class="line"> 90|   â— å•é˜¶æ®µBERT (84.7%, 62ms)</span><br><span class="line">   |â†—</span><br><span class="line"> 80+------------------------&gt; å»¶è¿Ÿ (ms)</span><br><span class="line">    50   100   150   200   250</span><br></pre></td></tr></table></figure><p><strong>ç»“è®º</strong>ï¼šåŒé˜¶æ®µæ–¹æ¡ˆæ˜¯<strong>å”¯ä¸€ä½äºå¸•ç´¯æ‰˜å‰æ²¿</strong>çš„æ–¹æ¡ˆâ€”â€”æ— å…¶ä»–æ–¹æ¡ˆèƒ½åœ¨å‡†ç¡®ç‡å’Œå»¶è¿Ÿä¸ŠåŒæ—¶ä¼˜äºå®ƒã€‚</p><hr><h2 id="å…­ã€å°ç»“ï¼šå·¥ç¨‹æ™ºæ…§åœ¨äºâ€œç²¾å‡†å¦¥åâ€"><a href="#å…­ã€å°ç»“ï¼šå·¥ç¨‹æ™ºæ…§åœ¨äºâ€œç²¾å‡†å¦¥åâ€" class="headerlink" title="å…­ã€å°ç»“ï¼šå·¥ç¨‹æ™ºæ…§åœ¨äºâ€œç²¾å‡†å¦¥åâ€"></a>å…­ã€å°ç»“ï¼šå·¥ç¨‹æ™ºæ…§åœ¨äºâ€œç²¾å‡†å¦¥åâ€</h2><p>åŒé˜¶æ®µæ„å›¾è¯†åˆ«çš„çœŸæ­£ä»·å€¼ï¼Œä¸åœ¨äºæŠ€æœ¯ç‚«æŠ€ï¼Œè€Œåœ¨äº<strong>æ‰¿è®¤ç°å®çº¦æŸä¸‹çš„æœ€ä¼˜è§£</strong>ï¼š</p><p>å·¥ç¨‹é¢†åŸŸæœ‰å¥è¯è¯´ï¼šâ€œæˆ‘ä»¬æ— æ³•ç”¨100msè§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä½†å¯ä»¥ç”¨45msè§£å†³87%çš„é—®é¢˜ï¼Œå†ç”¨155msè§£å†³å‰©ä½™13%â€”â€”æ•´ä½“æ•ˆç‡æå‡3.2å€ï¼Œè¿™æ‰æ˜¯å·¥ç¨‹æ™ºæ…§ã€‚â€  </p><p><strong>æœ€åå»ºè®®</strong>ï¼š</p><ul><li>âœ… <strong>é‡‡ç”¨åŒé˜¶æ®µ</strong>ï¼šå®¢æœã€é‡‘èå’¨è¯¢ç­‰â€œé«˜å‡†ç¡®ç‡+ä¸­ä½å»¶è¿Ÿâ€åœºæ™¯</li><li>âš ï¸ <strong>è°¨æ…è¯„ä¼°</strong>ï¼šè¶…ä½å»¶è¿Ÿï¼ˆ&lt;20msï¼‰æˆ–æç®€æ„å›¾ï¼ˆ&lt;5ç±»ï¼‰åœºæ™¯</li><li>ğŸ”® <strong>æœªæ¥æ¼”è¿›</strong>ï¼šéšç€MoEæ¨¡å‹ç¨€ç–æ¿€æ´»æŠ€æœ¯æˆç†Ÿï¼Œé˜¶æ®µ1&#x2F;2ç•Œé™å°†æ¨¡ç³ŠåŒ–ï¼Œä½†â€œè®¡ç®—èµ„æºåˆ†å±‚è°ƒåº¦â€æ€æƒ³æ°¸å­˜</li></ul><p><strong>è½¯ä»¶æ²¡æœ‰é“¶å¼¹ï¼Œè¿™å¥è¯åœ¨è½¯ä»¶è¡Œä¸šæ—¶è‡³ä»Šæ—¥ä¾ç„¶é€‚ç”¨ã€‚</strong></p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h6 id=&quot;é¦–å…ˆä¸ºä»€ä¹ˆ90-çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”&quot;&gt;&lt;a href=&quot;#é¦–å…ˆä¸ºä»€ä¹ˆ90-çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”&quot; class=&quot;headerlink&quot; title=&quot;é¦–å…ˆä¸ºä»€ä¹ˆ90%çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”&quot;&gt;&lt;/a&gt;é¦–å…ˆä¸ºä»€ä¹ˆ90%çš„ç”Ÿäº§çº§Agentç³»ç»Ÿé€‰æ‹©è¿™ä¸€æ¶æ„ï¼ŸğŸ¤”&lt;/h6&gt;&lt;p&gt;&lt;strong&gt;ä»¥å…¸å‹æ¡ˆä¾‹æ¥è¯´&lt;/strong&gt;ï¼šåœ¨å‡ ä¹æ‰€æœ‰IMå®¢æœ(ç”µå•†)äº¤äº’å¼å¯¹è¯ç³»ç»Ÿåº”ç”¨ä¸­ï¼Œ&lt;strong&gt;â€œæ‰€æœ‰è¯·æ±‚åŒç­‰å¯¹å¾…â€æ˜¯æœ€å¤§çš„èµ„æºæµªè´¹&lt;/strong&gt;ã€‚&lt;br&gt;ç›®å‰ä¸šç•Œå…±è¯†ä¹‹ä¸€æ˜¯ï¼šåŒé˜¶æ®µæ„å›¾è¯†åˆ«é€šè¿‡â€œè®¡ç®—èµ„æºåŠ¨æ€åˆ†é…â€æ€æƒ³ï¼Œåœ¨96.7%å‡†ç¡®ç‡ä¸98mså¹³å‡å»¶è¿Ÿé—´å–å¾—å·¥ç¨‹æœ€ä¼˜å¹³è¡¡ï¼Œä¹Ÿå‡ ä¹æˆä¸ºAgentç³»ç»Ÿçš„äº‹å®æ€§æ ‡å‡†æ¶æ„ä¹‹ä¸€ã€‚  &lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Skill" scheme="https://www.wdft.com/tags/Skill/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/tags/Agent/"/>
    
    <category term="Agent-Skill" scheme="https://www.wdft.com/tags/Agent-Skill/"/>
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="Demo-AI" scheme="https://www.wdft.com/tags/Demo-AI/"/>
    
    <category term="Agent-Suggestion" scheme="https://www.wdft.com/tags/Agent-Suggestion/"/>
    
  </entry>
  
  <entry>
    <title>Agent ä¸ Skills ä¹‹é—´çš„åŒºåˆ«é€šè¿‡ä¸€ä¸ªç®€å•å›¾ä¹¦é¦†å€Ÿé˜…ç³»ç»Ÿæ¡ˆä¾‹å®è·µæŒ‡å—</title>
    <link href="https://www.wdft.com/65d4601b.html"/>
    <id>https://www.wdft.com/65d4601b.html</id>
    <published>2026-01-24T13:25:24.000Z</published>
    <updated>2026-01-26T09:43:18.630Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h2 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h2><p>åœ¨æŠ€æœ¯è¯­å¢ƒä¸‹ï¼Œä¸¤è€…çš„å…³ç³»å¯ä»¥ç®€å•æ¦‚æ‹¬å’ŒåŒºåˆ†ä¸ºï¼šAgent æ˜¯å†³ç­–ä¸­å¿ƒï¼ŒSkills æ˜¯æ‰§è¡Œå‡½æ•°ã€‚</p><span id="more"></span><ul><li><p><strong>Agent (æ™ºèƒ½ä½“)</strong>: ä¸€ä¸ªå…·å¤‡æ¨ç†ï¼ˆReasoningï¼‰ã€è§„åˆ’ï¼ˆPlanningï¼‰å’Œè®°å¿†ï¼ˆMemoryï¼‰èƒ½åŠ›çš„å®ä½“ã€‚å®ƒé€šè¿‡ ReActï¼ˆReasoning and Actingï¼‰æ¡†æ¶å†³å®šä½•æ—¶è°ƒç”¨å“ªä¸ª Skillã€‚</p></li><li><p><strong>Skills (æŠ€èƒ½&#x2F;å·¥å…·)</strong>: é¢„å®šä¹‰çš„ã€å…·æœ‰æ˜ç¡®è¾“å…¥&#x2F;è¾“å‡ºæ¨¡å¼çš„åŸå­åŒ–åŠŸèƒ½ï¼ˆAPIã€æ•°æ®åº“æŸ¥è¯¢ã€æœ¬åœ°è„šæœ¬ç­‰ï¼‰ã€‚</p></li></ul><p>åœ¨äººå·¥æ™ºèƒ½æŠ€æœ¯å¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼ŒAgentï¼ˆæ™ºèƒ½ä»£ç†ï¼‰ä¸ Skillsï¼ˆæŠ€èƒ½ï¼‰çš„å…³ç³»æ¶æ„å·²æˆä¸ºæ„å»ºå¤æ‚AIåº”ç”¨çš„æ ¸å¿ƒèŒƒå¼ã€‚<br>LangChainä½œä¸ºå½“å‰æœ€æµè¡Œçš„å¼€æºæ¡†æ¶ï¼Œæä¾›äº†é¢„æ„å»ºçš„agentæ¶æ„å’Œä¸°å¯Œçš„å·¥å…·é›†æˆï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿå¿«é€Ÿæ„å»ºé€‚åº”æ€§å¼ºçš„AIä»£ç†ç³»ç»Ÿã€‚<br>æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Agentä¸Skillsçš„å…³ç³»æ¶æ„ï¼ŒåŸºäºDebian 12ç³»ç»Ÿç¯å¢ƒï¼Œä»åŸºç¡€åŸç†åˆ°å®æˆ˜éƒ¨ç½²ä¸€ä¸ªå›¾ä¹¦é¦†å€Ÿé˜…ç³»ç»Ÿçš„ç®€å•æ¡ˆä¾‹æ¥åŠ æ·±ç†è§£ï¼Œæä¾›å®Œæ•´çš„æŠ€æœ¯å…¥é—¨æŒ‡å—ã€‚</p><h2 id="ä¸€ã€Agentä¸Skillsæ¶æ„æ¼”è¿›å²"><a href="#ä¸€ã€Agentä¸Skillsæ¶æ„æ¼”è¿›å²" class="headerlink" title="ä¸€ã€Agentä¸Skillsæ¶æ„æ¼”è¿›å²"></a>ä¸€ã€Agentä¸Skillsæ¶æ„æ¼”è¿›å²</h2><h3 id="1-1-æ¦‚å¿µèµ·æºä¸ç‰ˆæœ¬æ¼”è¿›"><a href="#1-1-æ¦‚å¿µèµ·æºä¸ç‰ˆæœ¬æ¼”è¿›" class="headerlink" title="1.1 æ¦‚å¿µèµ·æºä¸ç‰ˆæœ¬æ¼”è¿›"></a>1.1 æ¦‚å¿µèµ·æºä¸ç‰ˆæœ¬æ¼”è¿›</h3><p>Agent-Skillsæ¶æ„çš„å‘å±•ç»å†äº†å¤šä¸ªé‡è¦é˜¶æ®µï¼š</p><ul><li><strong>2020-2021å¹´</strong>ï¼šæ—©æœŸæ¦‚å¿µé˜¶æ®µï¼Œä¸»è¦å…³æ³¨åŸºç¡€LLMé›†æˆ</li><li><strong>2022å¹´</strong>ï¼šLangChain 0.0.1å‘å¸ƒï¼Œé¦–æ¬¡æå‡ºAgent-Toolsæ¶æ„</li><li><strong>2023å¹´</strong>ï¼šLangChain 0.1.0æ­£å¼ç‰ˆï¼ŒSkillsæ¦‚å¿µæ­£å¼ç¡®ç«‹</li><li><strong>2024å¹´</strong>ï¼šLangChain 0.2.0ï¼Œå¼•å…¥åˆ†å±‚Skillsç®¡ç†å’ŒåŠ¨æ€åŠ è½½æœºåˆ¶</li><li><strong>2025å¹´</strong>ï¼šå½“å‰ç‰ˆæœ¬0.3.0ï¼Œæ”¯æŒå¤šæ¨¡æ€Skillså’Œåˆ†å¸ƒå¼AgentååŒ</li></ul><h3 id="1-2-å…³é”®ç‰¹æ€§æ¼”å˜"><a href="#1-2-å…³é”®ç‰¹æ€§æ¼”å˜" class="headerlink" title="1.2 å…³é”®ç‰¹æ€§æ¼”å˜"></a>1.2 å…³é”®ç‰¹æ€§æ¼”å˜</h3><p><strong>v0.1.x ç‰¹æ€§</strong>ï¼š</p><ul><li>åŸºç¡€Agentæ‰§è¡Œæ¡†æ¶</li><li>ç®€å•Toolsé›†æˆ</li><li>ä¸²è¡Œä»»åŠ¡å¤„ç†</li></ul><p><strong>v0.2.x ç‰¹æ€§</strong>ï¼š</p><ul><li>Skillsæ¨¡å—åŒ–è®¾è®¡</li><li>åŠ¨æ€æŠ€èƒ½åŠ è½½</li><li>è®°å¿†ç®¡ç†ä¼˜åŒ–</li><li>æ”¯æŒLangGraphå·¥ä½œæµ</li></ul><p><strong>v0.3.x ç‰¹æ€§ï¼ˆå½“å‰ï¼‰</strong>ï¼š</p><ul><li>å¤šAgentååŒæ¶æ„</li><li>æŠ€èƒ½å¸‚åœºï¼ˆSkills Marketplaceï¼‰</li><li>å®æ—¶æ€§èƒ½ç›‘æ§</li><li>å®‰å…¨æ²™ç®±æœºåˆ¶</li><li>è·¨è¯­è¨€Skillsæ”¯æŒ</li></ul><h2 id="äºŒã€Debian-12ç¯å¢ƒæ­å»ºä¸åŸç†å‰–æ"><a href="#äºŒã€Debian-12ç¯å¢ƒæ­å»ºä¸åŸç†å‰–æ" class="headerlink" title="äºŒã€Debian 12ç¯å¢ƒæ­å»ºä¸åŸç†å‰–æ"></a>äºŒã€Debian 12ç¯å¢ƒæ­å»ºä¸åŸç†å‰–æ</h2><h3 id="2-1-ç³»ç»Ÿç¯å¢ƒå‡†å¤‡"><a href="#2-1-ç³»ç»Ÿç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1 ç³»ç»Ÿç¯å¢ƒå‡†å¤‡"></a>2.1 ç³»ç»Ÿç¯å¢ƒå‡†å¤‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°ç³»ç»Ÿæº</span></span><br><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…åŸºç¡€ä¾èµ–</span></span><br><span class="line">sudo apt install -y python3 python3-pip python3-venv git curl wget \</span><br><span class="line">    build-essential libpq-dev libssl-dev postgresql-client</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé¡¹ç›®ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/agent-skills-project &amp;&amp; <span class="built_in">cd</span> ~/agent-skills-project</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">python3 -m venv venv</span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br></pre></td></tr></table></figure><h3 id="2-2-æ ¸å¿ƒæ¶æ„åŸç†"><a href="#2-2-æ ¸å¿ƒæ¶æ„åŸç†" class="headerlink" title="2.2 æ ¸å¿ƒæ¶æ„åŸç†"></a>2.2 æ ¸å¿ƒæ¶æ„åŸç†</h3><p>Agentä¸Skillsçš„å…³ç³»æ¶æ„åŸºäº<strong>åˆ†å±‚è®¾è®¡æ¨¡å¼</strong>ï¼ŒåŒ…å«ä¸‰ä¸ªæ ¸å¿ƒå±‚æ¬¡ï¼š</p><ol><li><strong>Agentå±‚</strong>ï¼šè´Ÿè´£å†³ç­–åˆ¶å®šã€ä»»åŠ¡è§„åˆ’å’Œåè°ƒ</li><li><strong>Skillså±‚</strong>ï¼šæä¾›å…·ä½“åŠŸèƒ½å®ç°ï¼Œå°è£…ä¸šåŠ¡é€»è¾‘</li><li><strong>Integrationå±‚</strong>ï¼šè¿æ¥å¤–éƒ¨ç³»ç»Ÿå’Œæ•°æ®æº</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¶æ„ç¤ºæ„å›¾</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Agent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, skills_registry</span>):</span><br><span class="line">        self.skills = skills_registry  <span class="comment"># æŠ€èƒ½æ³¨å†Œä¸­å¿ƒ</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_task</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="comment"># 1. ä»»åŠ¡åˆ†æ</span></span><br><span class="line">        skill_needed = self.analyze_task(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. æŠ€èƒ½é€‰æ‹©</span></span><br><span class="line">        selected_skill = self.select_skill(skill_needed)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. æŠ€èƒ½æ‰§è¡Œ</span></span><br><span class="line">        result = selected_skill.execute(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. ç»“æœå¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span> self.process_result(result)</span><br></pre></td></tr></table></figure><h3 id="2-3-å…³é”®ç‰¹æ€§è¯¦è§£"><a href="#2-3-å…³é”®ç‰¹æ€§è¯¦è§£" class="headerlink" title="2.3 å…³é”®ç‰¹æ€§è¯¦è§£"></a>2.3 å…³é”®ç‰¹æ€§è¯¦è§£</h3><h4 id="2-3-1-åŠ¨æ€æŠ€èƒ½åŠ è½½"><a href="#2-3-1-åŠ¨æ€æŠ€èƒ½åŠ è½½" class="headerlink" title="2.3.1 åŠ¨æ€æŠ€èƒ½åŠ è½½"></a>2.3.1 åŠ¨æ€æŠ€èƒ½åŠ è½½</h4><p>Skillså¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å’Œå¸è½½ï¼Œæ— éœ€é‡å¯AgentæœåŠ¡ï¼Œæå¤§æå‡äº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><h4 id="2-3-2-æŠ€èƒ½ç»„åˆæœºåˆ¶"><a href="#2-3-2-æŠ€èƒ½ç»„åˆæœºåˆ¶" class="headerlink" title="2.3.2 æŠ€èƒ½ç»„åˆæœºåˆ¶"></a>2.3.2 æŠ€èƒ½ç»„åˆæœºåˆ¶</h4><p>å¤šä¸ªSkillså¯ä»¥ç»„åˆå½¢æˆå¤åˆæŠ€èƒ½ï¼Œæ”¯æŒå¤æ‚çš„ä¸šåŠ¡åœºæ™¯å¤„ç†ã€‚</p><h4 id="2-3-3-è®°å¿†ç®¡ç†"><a href="#2-3-3-è®°å¿†ç®¡ç†" class="headerlink" title="2.3.3 è®°å¿†ç®¡ç†"></a>2.3.3 è®°å¿†ç®¡ç†</h4><p>å†…ç½®çš„å¯¹è¯è®°å¿†å’Œä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿Skillsåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒçŠ¶æ€è¿ç»­æ€§ã€‚</p><h2 id="ä¸‰ã€è¯¦ç»†é…ç½®æŒ‡å—ï¼ˆå¸¦ä¸­æ–‡æ³¨é‡Šï¼‰"><a href="#ä¸‰ã€è¯¦ç»†é…ç½®æŒ‡å—ï¼ˆå¸¦ä¸­æ–‡æ³¨é‡Šï¼‰" class="headerlink" title="ä¸‰ã€è¯¦ç»†é…ç½®æŒ‡å—ï¼ˆå¸¦ä¸­æ–‡æ³¨é‡Šï¼‰"></a>ä¸‰ã€è¯¦ç»†é…ç½®æŒ‡å—ï¼ˆå¸¦ä¸­æ–‡æ³¨é‡Šï¼‰</h2><h3 id="3-1-æ ¸å¿ƒé…ç½®æ–‡ä»¶-agent-config-yaml"><a href="#3-1-æ ¸å¿ƒé…ç½®æ–‡ä»¶-agent-config-yaml" class="headerlink" title="3.1 æ ¸å¿ƒé…ç½®æ–‡ä»¶ agent_config.yaml"></a>3.1 æ ¸å¿ƒé…ç½®æ–‡ä»¶ <code>agent_config.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Agentæ ¸å¿ƒé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="attr">agent:</span></span><br><span class="line">  <span class="comment"># Agentå”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">&quot;library_management_agent&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Agentåç§°ï¼ˆæ˜¾ç¤ºç”¨ï¼‰</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;å›¾ä¹¦é¦†ç®¡ç†æ™ºèƒ½ä»£ç†&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Agentæè¿°ä¿¡æ¯</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;è´Ÿè´£å›¾ä¹¦é¦†å€Ÿé˜…ã€å½’è¿˜ã€æŸ¥è¯¢ç­‰æ ¸å¿ƒä¸šåŠ¡çš„æ™ºèƒ½ä»£ç†&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># LLMæ¨¡å‹é…ç½®</span></span><br><span class="line">  <span class="attr">llm:</span></span><br><span class="line">    <span class="comment"># æ¨¡å‹æä¾›å•†ï¼ˆopenai, anthropic, localç­‰ï¼‰</span></span><br><span class="line">    <span class="attr">provider:</span> <span class="string">&quot;openai&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…·ä½“æ¨¡å‹åç§°</span></span><br><span class="line">    <span class="attr">model_name:</span> <span class="string">&quot;gpt-4-turbo&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># APIå¯†é’¥ï¼ˆç¯å¢ƒå˜é‡å¼•ç”¨ï¼‰</span></span><br><span class="line">    <span class="attr">api_key:</span> <span class="string">&quot;$&#123;OPENAI_API_KEY&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ¸©åº¦å‚æ•°ï¼ˆæ§åˆ¶éšæœºæ€§ï¼Œ0-1ï¼‰</span></span><br><span class="line">    <span class="attr">temperature:</span> <span class="number">0.3</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æœ€å¤§tokenæ•°é™åˆ¶</span></span><br><span class="line">    <span class="attr">max_tokens:</span> <span class="number">2000</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è®°å¿†ç®¡ç†é…ç½®</span></span><br><span class="line">  <span class="attr">memory:</span></span><br><span class="line">    <span class="comment"># è®°å¿†ç±»å‹ï¼ˆconversation, vector, hybridï¼‰</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;hybrid&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯¹è¯å†å²ä¿å­˜æ¡æ•°</span></span><br><span class="line">    <span class="attr">history_size:</span> <span class="number">10</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å‘é‡å­˜å‚¨é…ç½®</span></span><br><span class="line">    <span class="attr">vector_store:</span></span><br><span class="line">      <span class="comment"># å‘é‡æ•°æ®åº“ç±»å‹</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;chroma&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># æŒä¹…åŒ–è·¯å¾„</span></span><br><span class="line">      <span class="attr">persist_path:</span> <span class="string">&quot;./data/vector_store&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># åµŒå…¥æ¨¡å‹</span></span><br><span class="line">      <span class="attr">embedding_model:</span> <span class="string">&quot;text-embedding-ada-002&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½æ³¨å†Œä¸­å¿ƒé…ç½®</span></span><br><span class="line">  <span class="attr">skills_registry:</span></span><br><span class="line">    <span class="comment"># æŠ€èƒ½ç›®å½•è·¯å¾„</span></span><br><span class="line">    <span class="attr">skills_dir:</span> <span class="string">&quot;./skills&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è‡ªåŠ¨åŠ è½½æ–°æŠ€èƒ½</span></span><br><span class="line">    <span class="attr">auto_load:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æŠ€èƒ½ç¼“å­˜æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</span></span><br><span class="line">    <span class="attr">cache_ttl:</span> <span class="number">30</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æŠ€èƒ½æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">execution_timeout:</span> <span class="number">60</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># å®‰å…¨é…ç½®</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="comment"># æ²™ç®±æ¨¡å¼ï¼ˆtrue/falseï¼‰</span></span><br><span class="line">    <span class="attr">sandbox_mode:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…è®¸çš„å¤–éƒ¨è°ƒç”¨åŸŸå</span></span><br><span class="line">    <span class="attr">allowed_domains:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æŠ€èƒ½æƒé™æ§åˆ¶</span></span><br><span class="line">    <span class="attr">skill_permissions:</span></span><br><span class="line">      <span class="comment"># è¯»å–æƒé™</span></span><br><span class="line">      <span class="attr">read:</span> [<span class="string">&quot;query_book&quot;</span>, <span class="string">&quot;check_availability&quot;</span>]</span><br><span class="line">      <span class="comment"># å†™å…¥æƒé™</span></span><br><span class="line">      <span class="attr">write:</span> [<span class="string">&quot;borrow_book&quot;</span>, <span class="string">&quot;return_book&quot;</span>, <span class="string">&quot;add_book&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ—¥å¿—é…ç½®</span></span><br><span class="line">  <span class="attr">logging:</span></span><br><span class="line">    <span class="comment"># æ—¥å¿—çº§åˆ«ï¼ˆdebug, info, warning, error, criticalï¼‰</span></span><br><span class="line">    <span class="attr">level:</span> <span class="string">&quot;info&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="attr">file_path:</span> <span class="string">&quot;./logs/agent.log&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ˜¯å¦è¾“å‡ºåˆ°æ§åˆ¶å°</span></span><br><span class="line">    <span class="attr">console_output:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ•°æ®åº“è¿æ¥é…ç½®</span></span><br><span class="line">  <span class="attr">database:</span></span><br><span class="line">    <span class="comment"># æ•°æ®åº“ç±»å‹</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;postgresql&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿æ¥ä¸»æœº</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç«¯å£</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ•°æ®åº“åç§°</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">&quot;library_db&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç”¨æˆ·å</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">&quot;library_user&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯†ç ï¼ˆç¯å¢ƒå˜é‡ï¼‰</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&quot;$&#123;DB_PASSWORD&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿æ¥æ± å¤§å°</span></span><br><span class="line">    <span class="attr">max_connections:</span> <span class="number">10</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">connection_timeout:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¯å¢ƒå˜é‡é…ç½®</span></span><br><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="comment"># å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒ</span></span><br><span class="line">  <span class="attr">env:</span> <span class="string">&quot;development&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è°ƒè¯•æ¨¡å¼</span></span><br><span class="line">  <span class="attr">debug:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ€§èƒ½ç›‘æ§</span></span><br><span class="line">  <span class="attr">monitoring:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">metrics_port:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure><h3 id="3-2-æŠ€èƒ½é…ç½®æ–‡ä»¶ç¤ºä¾‹-skills-borrow-book-yaml"><a href="#3-2-æŠ€èƒ½é…ç½®æ–‡ä»¶ç¤ºä¾‹-skills-borrow-book-yaml" class="headerlink" title="3.2 æŠ€èƒ½é…ç½®æ–‡ä»¶ç¤ºä¾‹ skills/borrow_book.yaml"></a>3.2 æŠ€èƒ½é…ç½®æ–‡ä»¶ç¤ºä¾‹ <code>skills/borrow_book.yaml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠ€èƒ½é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="attr">skill:</span></span><br><span class="line">  <span class="comment"># æŠ€èƒ½å”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">&quot;borrow_book&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½åç§°</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;å›¾ä¹¦å€Ÿé˜…æŠ€èƒ½&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½æè¿°</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;å¤„ç†ç”¨æˆ·å€Ÿé˜…å›¾ä¹¦çš„è¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·èµ„æ ¼å’Œå›¾ä¹¦å¯ç”¨æ€§&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½ç‰ˆæœ¬</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½ä½œè€…</span></span><br><span class="line">  <span class="attr">author:</span> <span class="string">&quot;library-team&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŠ€èƒ½åˆ†ç±»</span></span><br><span class="line">  <span class="attr">category:</span> <span class="string">&quot;library_operations&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ä¾èµ–çš„Skills</span></span><br><span class="line">  <span class="attr">dependencies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;check_user_eligibility&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;check_book_availability&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è¾“å…¥å‚æ•°å®šä¹‰</span></span><br><span class="line">  <span class="attr">input_schema:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;object&quot;</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">user_id:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;ç”¨æˆ·ID&quot;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">book_id:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;å›¾ä¹¦ID&quot;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">borrow_date:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">format:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;å€Ÿé˜…æ—¥æœŸï¼Œæ ¼å¼YYYY-MM-DD&quot;</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&quot;current_date&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># è¾“å‡ºå‚æ•°å®šä¹‰</span></span><br><span class="line">  <span class="attr">output_schema:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;object&quot;</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">success:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;æ“ä½œæ˜¯å¦æˆåŠŸ&quot;</span></span><br><span class="line">      <span class="attr">transaction_id:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;äº¤æ˜“ID&quot;</span></span><br><span class="line">      <span class="attr">due_date:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">format:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;åº”è¿˜æ—¥æœŸ&quot;</span></span><br><span class="line">      <span class="attr">message:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;æ“ä½œç»“æœæ¶ˆæ¯&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ‰§è¡Œé€»è¾‘é…ç½®</span></span><br><span class="line">  <span class="attr">execution:</span></span><br><span class="line">    <span class="comment"># æ‰§è¡Œç±»å‹ï¼ˆpython, javascript, shellç­‰ï¼‰</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;python&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å…¥å£å‡½æ•°</span></span><br><span class="line">    <span class="attr">entry_point:</span> <span class="string">&quot;borrow_book.execute&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">30</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é‡è¯•æ¬¡æ•°</span></span><br><span class="line">    <span class="attr">max_retries:</span> <span class="number">3</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é‡è¯•é—´éš”ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">retry_interval:</span> <span class="number">2</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># èµ„æºé™åˆ¶</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="comment"># å†…å­˜é™åˆ¶ï¼ˆMBï¼‰</span></span><br><span class="line">    <span class="attr">memory_limit:</span> <span class="number">256</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># CPUé™åˆ¶ï¼ˆæ ¸æ•°ï¼‰</span></span><br><span class="line">    <span class="attr">cpu_limit:</span> <span class="number">0.5</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç½‘ç»œè®¿é—®æƒé™</span></span><br><span class="line">    <span class="attr">network_access:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># é”™è¯¯å¤„ç†</span></span><br><span class="line">  <span class="attr">error_handling:</span></span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰é”™è¯¯æ˜ å°„</span></span><br><span class="line">    <span class="attr">error_codes:</span></span><br><span class="line">      <span class="attr">USER_NOT_FOUND:</span> <span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span></span><br><span class="line">      <span class="attr">BOOK_NOT_AVAILABLE:</span> <span class="string">&quot;å›¾ä¹¦ä¸å¯å€Ÿé˜…&quot;</span></span><br><span class="line">      <span class="attr">MAX_BORROWS_REACHED:</span> <span class="string">&quot;å·²è¾¾åˆ°æœ€å¤§å€Ÿé˜…æ•°é‡&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é»˜è®¤é”™è¯¯å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="attr">default_handler:</span> <span class="string">&quot;error_handlers.default_handler&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ç¼“å­˜é…ç½®</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="comment"># æ˜¯å¦å¯ç”¨ç¼“å­˜</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">    <span class="attr">ttl:</span> <span class="number">60</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥</span></span><br><span class="line">    <span class="attr">key_strategy:</span> <span class="string">&quot;user_book_combination&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ç›‘æ§æŒ‡æ ‡</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="comment"># å¯ç”¨æ€§èƒ½ç›‘æ§</span></span><br><span class="line">    <span class="attr">enable_performance:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰æŒ‡æ ‡</span></span><br><span class="line">    <span class="attr">custom_metrics:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;borrow_success_rate&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;average_processing_time&quot;</span></span><br></pre></td></tr></table></figure><h2 id="å››ã€éƒ¨ç½²æ¶æ„ä¸æœ€ä½³å®è·µ"><a href="#å››ã€éƒ¨ç½²æ¶æ„ä¸æœ€ä½³å®è·µ" class="headerlink" title="å››ã€éƒ¨ç½²æ¶æ„ä¸æœ€ä½³å®è·µ"></a>å››ã€éƒ¨ç½²æ¶æ„ä¸æœ€ä½³å®è·µ</h2><h3 id="4-1-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„"><a href="#4-1-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„" class="headerlink" title="4.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„"></a>4.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      è´Ÿè½½å‡è¡¡å±‚                               â”‚</span><br><span class="line">â”‚                  Nginx/HAProxy                              â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                            â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      åº”ç”¨æœåŠ¡å±‚                               â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚</span><br><span class="line">â”‚  â”‚  Agent-1    â”‚  â”‚  Agent-2    â”‚  â”‚  Agent-3    â”‚          â”‚</span><br><span class="line">â”‚  â”‚ (Primary)   â”‚  â”‚ (Backup)    â”‚  â”‚ (Read-only) â”‚          â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                            â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      æ•°æ®å­˜å‚¨å±‚                               â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚</span><br><span class="line">â”‚  â”‚ PostgreSQL  â”‚  â”‚ Vector      â”‚  â”‚ Redis       â”‚          â”‚</span><br><span class="line">â”‚  â”‚ (ä¸»ä»å¤åˆ¶)   â”‚  â”‚  DB (Chroma)â”‚  â”‚ (ç¼“å­˜)       â”‚          â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="4-2-å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker-Composeï¼‰"><a href="#4-2-å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker-Composeï¼‰" class="headerlink" title="4.2 å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker Composeï¼‰"></a>4.2 å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker Composeï¼‰</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># Agentä¸»æœåŠ¡</span></span><br><span class="line">  <span class="attr">agent-service:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile.agent</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">library-agent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span>  <span class="comment"># ç›‘æ§ç«¯å£</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">OPENAI_API_KEY=$&#123;OPENAI_API_KEY&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_PASSWORD=$&#123;DB_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ENVIRONMENT=production</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./skills:/app/skills</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/app/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/app/logs</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vector-db</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8080/health&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># PostgreSQLæ•°æ®åº“</span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:15-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">library-postgres</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_DB=library_db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_USER=library_user</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POSTGRES_PASSWORD=$&#123;DB_PASSWORD&#125;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres_data:/var/lib/postgresql/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./init.sql:/docker-entrypoint-initdb.d/init.sql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5432:5432&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Redisç¼“å­˜</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">library-redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_data:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># å‘é‡æ•°æ®åº“</span></span><br><span class="line">  <span class="attr">vector-db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">chromadb/chroma:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">library-vector-db</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vector_data:/chroma</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ç›‘æ§æœåŠ¡</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/prometheus:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">agent-prometheus</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9091:9090&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">agent-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">postgres_data:</span></span><br><span class="line">  <span class="attr">redis_data:</span></span><br><span class="line">  <span class="attr">vector_data:</span></span><br></pre></td></tr></table></figure><h3 id="4-3-å…³é”®æ³¨æ„äº‹é¡¹"><a href="#4-3-å…³é”®æ³¨æ„äº‹é¡¹" class="headerlink" title="4.3 å…³é”®æ³¨æ„äº‹é¡¹"></a>4.3 å…³é”®æ³¨æ„äº‹é¡¹</h3><p><strong>âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹ï¼š</strong></p><ol><li><p><strong>å®‰å…¨éš”ç¦»</strong>ï¼šç”Ÿäº§ç¯å¢ƒä¸­å¿…é¡»å¯ç”¨æ²™ç®±æ¨¡å¼ï¼Œé™åˆ¶Skillsçš„ç½‘ç»œè®¿é—®æƒé™ï¼Œé˜²æ­¢æ¶æ„ä»£ç æ‰§è¡Œã€‚</p></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šSkillsçš„æ‰§è¡Œè¶…æ—¶æ—¶é—´åº”æ ¹æ®ä¸šåŠ¡åœºæ™¯åˆç†è®¾ç½®ï¼Œé¿å…é˜»å¡Agentä¸»çº¿ç¨‹ã€‚</p></li><li><p><strong>ç‰ˆæœ¬æ§åˆ¶</strong>ï¼šSkillså¿…é¡»ä¸¥æ ¼éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ï¼Œç¡®ä¿å‘åå…¼å®¹æ€§ã€‚</p></li><li><p><strong>ç›‘æ§å‘Šè­¦</strong>ï¼šå¿…é¡»é…ç½®å®Œæ•´çš„ç›‘æ§æŒ‡æ ‡ï¼ŒåŒ…æ‹¬æŠ€èƒ½æ‰§è¡ŒæˆåŠŸç‡ã€å“åº”æ—¶é—´ã€èµ„æºä½¿ç”¨ç‡ç­‰ã€‚</p></li><li><p><strong>ç¾å¤‡ç­–ç•¥</strong>ï¼šAgentæœåŠ¡åº”éƒ¨ç½²å¤šå®ä¾‹ï¼Œå®ç°æ•…éšœè‡ªåŠ¨åˆ‡æ¢ï¼Œç¡®ä¿æœåŠ¡é«˜å¯ç”¨ã€‚</p></li></ol><h2 id="äº”ã€å®æˆ˜Demoï¼šå›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿ"><a href="#äº”ã€å®æˆ˜Demoï¼šå›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿ" class="headerlink" title="äº”ã€å®æˆ˜Demoï¼šå›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿ"></a>äº”ã€å®æˆ˜Demoï¼šå›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿ</h2><h3 id="5-1-æ•°æ®åº“è®¾è®¡ï¼ˆPostgreSQLï¼‰"><a href="#5-1-æ•°æ®åº“è®¾è®¡ï¼ˆPostgreSQLï¼‰" class="headerlink" title="5.1 æ•°æ®åº“è®¾è®¡ï¼ˆPostgreSQLï¼‰"></a>5.1 æ•°æ®åº“è®¾è®¡ï¼ˆPostgreSQLï¼‰</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å›¾ä¹¦è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> books (</span><br><span class="line">    id <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    author <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    isbn <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    category <span class="type">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    total_copies <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    available_copies <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    published_year <span class="type">INTEGER</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç”¨æˆ·è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> users (</span><br><span class="line">    id <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    phone <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    max_borrow_limit <span class="type">INTEGER</span> <span class="keyword">DEFAULT</span> <span class="number">5</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å€Ÿé˜…è®°å½•è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> borrow_records (</span><br><span class="line">    id SERIAL <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    user_id <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">    book_id <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">REFERENCES</span> books(id),</span><br><span class="line">    borrow_date <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    due_date <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    return_date <span class="type">DATE</span>,</span><br><span class="line">    status <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;borrowed&#x27;</span> <span class="keyword">CHECK</span> (status <span class="keyword">IN</span> (<span class="string">&#x27;borrowed&#x27;</span>, <span class="string">&#x27;returned&#x27;</span>, <span class="string">&#x27;overdue&#x27;</span>)),</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç´¢å¼•ä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_borrow_records_user <span class="keyword">ON</span> borrow_records(user_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_borrow_records_book <span class="keyword">ON</span> borrow_records(book_id);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_borrow_records_status <span class="keyword">ON</span> borrow_records(status);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è§¦å‘å™¨ï¼šæ›´æ–°å›¾ä¹¦å¯ç”¨æ•°é‡</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> update_book_availability()</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="keyword">TRIGGER</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    IF NEW.status <span class="operator">=</span> <span class="string">&#x27;borrowed&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> books <span class="keyword">SET</span> available_copies <span class="operator">=</span> available_copies <span class="operator">-</span> <span class="number">1</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.book_id;</span><br><span class="line">    ELSIF NEW.status <span class="operator">=</span> <span class="string">&#x27;returned&#x27;</span> <span class="keyword">AND</span> OLD.status <span class="operator">=</span> <span class="string">&#x27;borrowed&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        <span class="keyword">UPDATE</span> books <span class="keyword">SET</span> available_copies <span class="operator">=</span> available_copies <span class="operator">+</span> <span class="number">1</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> NEW.book_id;</span><br><span class="line">    <span class="keyword">END</span> IF;</span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">NEW</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_update_book_availability</span><br><span class="line">AFTER <span class="keyword">INSERT</span> <span class="keyword">OR</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> borrow_records</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> update_book_availability();</span><br></pre></td></tr></table></figure><h3 id="5-2-Pythonå®ç°ï¼ˆåŸºäºLangChainï¼‰"><a href="#5-2-Pythonå®ç°ï¼ˆåŸºäºLangChainï¼‰" class="headerlink" title="5.2 Pythonå®ç°ï¼ˆåŸºäºLangChainï¼‰"></a>5.2 Pythonå®ç°ï¼ˆåŸºäºLangChainï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># library_agent.py</span></span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor, create_tool_calling_agent</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_community.utilities <span class="keyword">import</span> SQLDatabase</span><br><span class="line"><span class="keyword">from</span> langchain_community.agent_toolkits <span class="keyword">import</span> SQLDatabaseToolkit</span><br><span class="line"><span class="keyword">from</span> langchain_core.tools <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">import</span> psycopg2</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibraryAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">        self.db = SQLDatabase.from_uri(</span><br><span class="line">            <span class="string">f&quot;postgresql://<span class="subst">&#123;os.getenv(<span class="string">&#x27;DB_USER&#x27;</span>)&#125;</span>:<span class="subst">&#123;os.getenv(<span class="string">&#x27;DB_PASSWORD&#x27;</span>)&#125;</span>@<span class="subst">&#123;os.getenv(<span class="string">&#x27;DB_HOST&#x27;</span>)&#125;</span>/<span class="subst">&#123;os.getenv(<span class="string">&#x27;DB_NAME&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–LLM</span></span><br><span class="line">        self.llm = ChatOpenAI(</span><br><span class="line">            model=<span class="string">&quot;gpt-4-turbo&quot;</span>,</span><br><span class="line">            temperature=<span class="number">0.3</span>,</span><br><span class="line">            api_key=os.getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ›å»ºå·¥å…·åŒ…</span></span><br><span class="line">        self.toolkit = SQLDatabaseToolkit(db=self.db, llm=self.llm)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å®šä¹‰ä¸“ä¸šå·¥å…·</span></span><br><span class="line">        self.tools = [</span><br><span class="line">            self.borrow_book_tool,</span><br><span class="line">            self.return_book_tool,</span><br><span class="line">            self.check_availability_tool,</span><br><span class="line">            self.get_user_info_tool,</span><br><span class="line">            self.search_books_tool</span><br><span class="line">        ] + self.toolkit.get_tools()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ›å»ºAgent</span></span><br><span class="line">        self.agent = self.create_agent()</span><br><span class="line">        self.agent_executor = AgentExecutor(</span><br><span class="line">            agent=self.agent,</span><br><span class="line">            tools=self.tools,</span><br><span class="line">            verbose=<span class="literal">True</span>,</span><br><span class="line">            max_iterations=<span class="number">10</span>,</span><br><span class="line">            early_stopping_method=<span class="string">&quot;force&quot;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_agent</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºå›¾ä¹¦é¦†ç®¡ç†Agent&quot;&quot;&quot;</span></span><br><span class="line">        prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">            (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾ä¹¦é¦†ç®¡ç†åŠ©æ‰‹ï¼Œè´Ÿè´£å¤„ç†å›¾ä¹¦å€Ÿé˜…ã€å½’è¿˜ã€æŸ¥è¯¢ç­‰ä¸šåŠ¡ã€‚</span></span><br><span class="line"><span class="string">            è¯·æ ¹æ®ç”¨æˆ·è¯·æ±‚é€‰æ‹©åˆé€‚çš„å·¥å…·æ‰§è¡Œæ“ä½œï¼Œå¹¶æä¾›æ¸…æ™°ã€å‹å¥½çš„å›å¤ã€‚</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            å¯ç”¨å·¥å…·ï¼š</span></span><br><span class="line"><span class="string">            - borrow_book_tool: å¤„ç†å›¾ä¹¦å€Ÿé˜…</span></span><br><span class="line"><span class="string">            - return_book_tool: å¤„ç†å›¾ä¹¦å½’è¿˜  </span></span><br><span class="line"><span class="string">            - check_availability_tool: æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line"><span class="string">            - get_user_info_tool: è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="string">            - search_books_tool: æœç´¢å›¾ä¹¦</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            é‡è¦è§„åˆ™ï¼š</span></span><br><span class="line"><span class="string">            1. å€Ÿä¹¦å‰å¿…é¡»æ£€æŸ¥ç”¨æˆ·èµ„æ ¼å’Œå›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line"><span class="string">            2. å½’è¿˜å›¾ä¹¦æ—¶éœ€è¦éªŒè¯å€Ÿé˜…è®°å½•</span></span><br><span class="line"><span class="string">            3. æ‰€æœ‰æ“ä½œéƒ½éœ€è¦è®°å½•æ—¥å¿—</span></span><br><span class="line"><span class="string">            4. é‡åˆ°é”™è¯¯æ—¶æä¾›å‹å¥½çš„é”™è¯¯æç¤º&quot;&quot;&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;&#123;agent_scratchpad&#125;&quot;</span>)</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> create_tool_calling_agent(self.llm, self.tools, prompt)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">borrow_book_tool</span>(<span class="params">self, user_id: <span class="built_in">str</span>, book_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å€Ÿé˜…å›¾ä¹¦å·¥å…·&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># æ£€æŸ¥ç”¨æˆ·èµ„æ ¼</span></span><br><span class="line">            user_info = self.get_user_info_tool(user_id)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user_info[<span class="string">&quot;eligible&quot;</span>]:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;ç”¨æˆ·å€Ÿé˜…èµ„æ ¼ä¸è¶³&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line">            availability = self.check_availability_tool(book_id)</span><br><span class="line">            <span class="keyword">if</span> availability[<span class="string">&quot;available_copies&quot;</span>] &lt;= <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å›¾ä¹¦æš‚æ— åº“å­˜&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ‰§è¡Œå€Ÿé˜…</span></span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ›å»ºå€Ÿé˜…è®°å½•</span></span><br><span class="line">            borrow_date = datetime.now().date()</span><br><span class="line">            due_date = borrow_date + timedelta(days=<span class="number">14</span>)  <span class="comment"># 14å¤©å€Ÿé˜…æœŸ</span></span><br><span class="line">            </span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                INSERT INTO borrow_records (user_id, book_id, borrow_date, due_date, status)</span></span><br><span class="line"><span class="string">                VALUES (%s, %s, %s, %s, &#x27;borrowed&#x27;)</span></span><br><span class="line"><span class="string">                RETURNING id, due_date</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (user_id, book_id, borrow_date, due_date))</span><br><span class="line">            </span><br><span class="line">            result = cursor.fetchone()</span><br><span class="line">            transaction_id, due_date = result</span><br><span class="line">            </span><br><span class="line">            conn.commit()</span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;transaction_id&quot;</span>: transaction_id,</span><br><span class="line">                <span class="string">&quot;due_date&quot;</span>: due_date.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>),</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;å€Ÿé˜…æˆåŠŸï¼è¯·åœ¨<span class="subst">&#123;due_date.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)&#125;</span>å‰å½’è¿˜ã€‚&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;å€Ÿé˜…å¤±è´¥: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">return_book_tool</span>(<span class="params">self, user_id: <span class="built_in">str</span>, book_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å½’è¿˜å›¾ä¹¦å·¥å…·&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æŸ¥æ‰¾æœªå½’è¿˜çš„å€Ÿé˜…è®°å½•</span></span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT id FROM borrow_records </span></span><br><span class="line"><span class="string">                WHERE user_id = %s AND book_id = %s AND status = &#x27;borrowed&#x27;</span></span><br><span class="line"><span class="string">                ORDER BY borrow_date DESC LIMIT 1</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (user_id, book_id))</span><br><span class="line">            </span><br><span class="line">            record = cursor.fetchone()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> record:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;æœªæ‰¾åˆ°ç›¸å…³å€Ÿé˜…è®°å½•&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            record_id = record[<span class="number">0</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ›´æ–°å½’è¿˜çŠ¶æ€</span></span><br><span class="line">            return_date = datetime.now().date()</span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                UPDATE borrow_records </span></span><br><span class="line"><span class="string">                SET status = &#x27;returned&#x27;, return_date = %s </span></span><br><span class="line"><span class="string">                WHERE id = %s</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (return_date, record_id))</span><br><span class="line">            </span><br><span class="line">            conn.commit()</span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;success&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å›¾ä¹¦å½’è¿˜æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„ä½¿ç”¨ã€‚&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;success&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;å½’è¿˜å¤±è´¥: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_availability_tool</span>(<span class="params">self, book_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT title, author, total_copies, available_copies </span></span><br><span class="line"><span class="string">                FROM books WHERE id = %s</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (book_id,))</span><br><span class="line">            </span><br><span class="line">            book = cursor.fetchone()</span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> book:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;available&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;å›¾ä¹¦ä¸å­˜åœ¨&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            title, author, total, available = book</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;available&quot;</span>: available &gt; <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;book_title&quot;</span>: title,</span><br><span class="line">                <span class="string">&quot;author&quot;</span>: author,</span><br><span class="line">                <span class="string">&quot;total_copies&quot;</span>: total,</span><br><span class="line">                <span class="string">&quot;available_copies&quot;</span>: available,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;ã€Š<span class="subst">&#123;title&#125;</span>ã€‹å½“å‰æœ‰<span class="subst">&#123;available&#125;</span>æœ¬å¯å€Ÿ&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user_info_tool</span>(<span class="params">self, user_id: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç”¨æˆ·ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</span></span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT name, email, max_borrow_limit FROM users WHERE id = %s</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (user_id,))</span><br><span class="line">            user = cursor.fetchone()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;eligible&quot;</span>: <span class="literal">False</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            name, email, max_limit = user</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è·å–å½“å‰å€Ÿé˜…æ•°é‡</span></span><br><span class="line">            cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT COUNT(*) FROM borrow_records </span></span><br><span class="line"><span class="string">                WHERE user_id = %s AND status = &#x27;borrowed&#x27;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>, (user_id,))</span><br><span class="line">            current_borrows = cursor.fetchone()[<span class="number">0</span>]</span><br><span class="line">            </span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            eligible = current_borrows &lt; max_limit</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;eligible&quot;</span>: eligible,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">                <span class="string">&quot;email&quot;</span>: email,</span><br><span class="line">                <span class="string">&quot;max_borrow_limit&quot;</span>: max_limit,</span><br><span class="line">                <span class="string">&quot;current_borrows&quot;</span>: current_borrows,</span><br><span class="line">                <span class="string">&quot;remaining_limit&quot;</span>: max_limit - current_borrows,</span><br><span class="line">                <span class="string">&quot;message&quot;</span>: eligible <span class="keyword">and</span> <span class="string">&quot;ç”¨æˆ·å€Ÿé˜…èµ„æ ¼æ­£å¸¸&quot;</span> <span class="keyword">or</span> <span class="string">&quot;å·²è¾¾åˆ°æœ€å¤§å€Ÿé˜…æ•°é‡&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @tool</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_books_tool</span>(<span class="params">self, query: <span class="built_in">str</span>, category: <span class="built_in">str</span> = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æœç´¢å›¾ä¹¦&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = self.get_db_connection()</span><br><span class="line">            cursor = conn.cursor()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ„å»ºæŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">            conditions = []</span><br><span class="line">            params = [<span class="string">f&quot;%<span class="subst">&#123;query&#125;</span>%&quot;</span>]</span><br><span class="line">            sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                SELECT id, title, author, isbn, category, available_copies </span></span><br><span class="line"><span class="string">                FROM books </span></span><br><span class="line"><span class="string">                WHERE title ILIKE %s OR author ILIKE %s OR isbn ILIKE %s</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            conditions.extend([<span class="string">f&quot;%<span class="subst">&#123;query&#125;</span>%&quot;</span>, <span class="string">f&quot;%<span class="subst">&#123;query&#125;</span>%&quot;</span>, <span class="string">f&quot;%<span class="subst">&#123;query&#125;</span>%&quot;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> category:</span><br><span class="line">                sql += <span class="string">&quot; AND category = %s&quot;</span></span><br><span class="line">                conditions.append(category)</span><br><span class="line">            </span><br><span class="line">            sql += <span class="string">&quot; ORDER BY title LIMIT 10&quot;</span></span><br><span class="line">            </span><br><span class="line">            cursor.execute(sql, <span class="built_in">tuple</span>(conditions))</span><br><span class="line">            books = cursor.fetchall()</span><br><span class="line">            cursor.close()</span><br><span class="line">            conn.close()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;id&quot;</span>: book[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;title&quot;</span>: book[<span class="number">1</span>],</span><br><span class="line">                    <span class="string">&quot;author&quot;</span>: book[<span class="number">2</span>],</span><br><span class="line">                    <span class="string">&quot;isbn&quot;</span>: book[<span class="number">3</span>],</span><br><span class="line">                    <span class="string">&quot;category&quot;</span>: book[<span class="number">4</span>],</span><br><span class="line">                    <span class="string">&quot;available_copies&quot;</span>: book[<span class="number">5</span>]</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> book <span class="keyword">in</span> books</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> [&#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)&#125;]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_db_connection</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æ•°æ®åº“è¿æ¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> psycopg2.connect(</span><br><span class="line">            host=os.getenv(<span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>),</span><br><span class="line">            database=os.getenv(<span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;library_db&#x27;</span>),</span><br><span class="line">            user=os.getenv(<span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;library_user&#x27;</span>),</span><br><span class="line">            password=os.getenv(<span class="string">&#x27;DB_PASSWORD&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            port=os.getenv(<span class="string">&#x27;DB_PORT&#x27;</span>, <span class="string">&#x27;5432&#x27;</span>)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, user_input: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¿è¡ŒAgentå¤„ç†ç”¨æˆ·è¾“å…¥&quot;&quot;&quot;</span></span><br><span class="line">        result = self.agent_executor.invoke(&#123;<span class="string">&quot;input&quot;</span>: user_input&#125;)</span><br><span class="line">        <span class="keyword">return</span> result[<span class="string">&quot;output&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">    os.environ[<span class="string">&quot;OPENAI_API_KEY&quot;</span>] = <span class="string">&quot;your-api-key&quot;</span></span><br><span class="line">    os.environ[<span class="string">&quot;DB_HOST&quot;</span>] = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    os.environ[<span class="string">&quot;DB_NAME&quot;</span>] = <span class="string">&quot;library_db&quot;</span></span><br><span class="line">    os.environ[<span class="string">&quot;DB_USER&quot;</span>] = <span class="string">&quot;library_user&quot;</span></span><br><span class="line">    os.environ[<span class="string">&quot;DB_PASSWORD&quot;</span>] = <span class="string">&quot;your-db-password&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–Agent</span></span><br><span class="line">    agent = LibraryAgent()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æµ‹è¯•å¯¹è¯</span></span><br><span class="line">    test_inputs = [</span><br><span class="line">        <span class="string">&quot;æˆ‘æƒ³å€Ÿä¸€æœ¬ã€Šäººå·¥æ™ºèƒ½å¯¼è®ºã€‹&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ç”¨æˆ·user123å¯ä»¥å€Ÿå¤šå°‘æœ¬ä¹¦ï¼Ÿ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;å¸®æˆ‘æŸ¥æ‰¾æ‰€æœ‰ç¼–ç¨‹ç±»çš„å›¾ä¹¦&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æˆ‘è¦å½’è¿˜ã€Šæœºå™¨å­¦ä¹ å®æˆ˜ã€‹&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> user_input <span class="keyword">in</span> test_inputs:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nç”¨æˆ·: <span class="subst">&#123;user_input&#125;</span>&quot;</span>)</span><br><span class="line">        response = agent.run(user_input)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;åŠ©æ‰‹: <span class="subst">&#123;response&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="5-3-Goè¯­è¨€å®ç°"><a href="#5-3-Goè¯­è¨€å®ç°" class="headerlink" title="5.3 Goè¯­è¨€å®ç°"></a>5.3 Goè¯­è¨€å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;database/sql&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/jackc/pgx/v5/pgxpool&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/sashabaranov/go-openai&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LibraryAgent <span class="keyword">struct</span> &#123;</span><br><span class="line">db        *pgxpool.Pool</span><br><span class="line">openai    *openai.Client</span><br><span class="line">config    *AgentConfig</span><br><span class="line">skills    <span class="keyword">map</span>[<span class="type">string</span>]Skill</span><br><span class="line">tools     <span class="keyword">map</span>[<span class="type">string</span>]Tool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Skill <span class="keyword">interface</span> &#123;</span><br><span class="line">Execute(ctx context.Context, params <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;) (<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>)</span><br><span class="line">GetDescription() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Tool <span class="keyword">struct</span> &#123;</span><br><span class="line">Name        <span class="type">string</span></span><br><span class="line">Description <span class="type">string</span></span><br><span class="line">Handler     <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, params <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span></span> (<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AgentConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">DatabaseURL <span class="type">string</span></span><br><span class="line">OpenAIAPIKey <span class="type">string</span></span><br><span class="line">MaxBorrowDays <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLibraryAgent</span><span class="params">(config *AgentConfig)</span></span> (*LibraryAgent, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">dbPool, err := pgxpool.New(context.Background(), config.DatabaseURL)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;æ•°æ®åº“è¿æ¥å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯</span></span><br><span class="line">openaiClient := openai.NewClient(config.OpenAIAPIKey)</span><br><span class="line"></span><br><span class="line">agent := &amp;LibraryAgent&#123;</span><br><span class="line">db:        dbPool,</span><br><span class="line">openai:    openaiClient,</span><br><span class="line">config:    config,</span><br><span class="line">skills:    <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]Skill),</span><br><span class="line">tools:     <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]Tool),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†ŒæŠ€èƒ½</span></span><br><span class="line">agent.registerSkills()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œå·¥å…·</span></span><br><span class="line">agent.registerTools()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> agent, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *LibraryAgent)</span></span> registerSkills() &#123;</span><br><span class="line"><span class="comment">// å€Ÿä¹¦æŠ€èƒ½</span></span><br><span class="line">a.skills[<span class="string">&quot;borrow_book&quot;</span>] = &amp;BorrowBookSkill&#123;agent: a&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿˜ä¹¦æŠ€èƒ½</span></span><br><span class="line">a.skills[<span class="string">&quot;return_book&quot;</span>] = &amp;ReturnBookSkill&#123;agent: a&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥è¯¢æŠ€èƒ½</span></span><br><span class="line">a.skills[<span class="string">&quot;search_books&quot;</span>] = &amp;SearchBooksSkill&#123;agent: a&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *LibraryAgent)</span></span> registerTools() &#123;</span><br><span class="line">a.tools[<span class="string">&quot;check_availability&quot;</span>] = Tool&#123;</span><br><span class="line">Name:        <span class="string">&quot;check_availability&quot;</span>,</span><br><span class="line">Description: <span class="string">&quot;æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§&quot;</span>,</span><br><span class="line">Handler:     a.handleCheckAvailability,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a.tools[<span class="string">&quot;get_user_info&quot;</span>] = Tool&#123;</span><br><span class="line">Name:        <span class="string">&quot;get_user_info&quot;</span>,</span><br><span class="line">Description: <span class="string">&quot;è·å–ç”¨æˆ·ä¿¡æ¯&quot;</span>,</span><br><span class="line">Handler:     a.handleGetUserInfo,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BorrowBookSkill <span class="keyword">struct</span> &#123;</span><br><span class="line">agent *LibraryAgent</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *BorrowBookSkill)</span></span> Execute(ctx context.Context, params <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;) (<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">userID, ok := params[<span class="string">&quot;user_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;ç¼ºå°‘ç”¨æˆ·ID&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bookID, ok := params[<span class="string">&quot;book_id&quot;</span>].(<span class="type">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;ç¼ºå°‘å›¾ä¹¦ID&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ç”¨æˆ·èµ„æ ¼</span></span><br><span class="line">userInfo, err := s.agent.tools[<span class="string">&quot;get_user_info&quot;</span>].Handler(ctx, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;user_id&quot;</span>: userID&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !userInfo[<span class="string">&quot;eligible&quot;</span>].(<span class="type">bool</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;success&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;message&quot;</span>: <span class="string">&quot;ç”¨æˆ·å€Ÿé˜…èµ„æ ¼ä¸è¶³&quot;</span>,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line">availability, err := s.agent.tools[<span class="string">&quot;check_availability&quot;</span>].Handler(ctx, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;book_id&quot;</span>: bookID&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> availability[<span class="string">&quot;available_copies&quot;</span>].(<span class="type">int</span>) &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;success&quot;</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="string">&quot;message&quot;</span>: <span class="string">&quot;å›¾ä¹¦æš‚æ— åº“å­˜&quot;</span>,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œå€Ÿé˜…</span></span><br><span class="line">tx, err := s.agent.db.Begin(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> tx.Rollback(ctx)</span><br><span class="line"></span><br><span class="line">borrowDate := time.Now().Format(<span class="string">&quot;2006-01-02&quot;</span>)</span><br><span class="line">dueDate := time.Now().AddDate(<span class="number">0</span>, <span class="number">0</span>, s.agent.config.MaxBorrowDays).Format(<span class="string">&quot;2006-01-02&quot;</span>)</span><br><span class="line"></span><br><span class="line">_, err = tx.Exec(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">INSERT INTO borrow_records (user_id, book_id, borrow_date, due_date, status)</span></span><br><span class="line"><span class="string">VALUES ($1, $2, $3, $4, &#x27;borrowed&#x27;)</span></span><br><span class="line"><span class="string">RETURNING id</span></span><br><span class="line"><span class="string">`</span>, userID, bookID, borrowDate, dueDate)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := tx.Commit(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;success&quot;</span>:     <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;due_date&quot;</span>:    dueDate,</span><br><span class="line"><span class="string">&quot;message&quot;</span>:     fmt.Sprintf(<span class="string">&quot;å€Ÿé˜…æˆåŠŸï¼è¯·åœ¨%så‰å½’è¿˜ã€‚&quot;</span>, dueDate),</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *BorrowBookSkill)</span></span> GetDescription() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;å¤„ç†å›¾ä¹¦å€Ÿé˜…è¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·èµ„æ ¼å’Œå›¾ä¹¦å¯ç”¨æ€§&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">config := &amp;AgentConfig&#123;</span><br><span class="line">DatabaseURL:  <span class="string">&quot;postgres://library_user:password@localhost:5432/library_db&quot;</span>,</span><br><span class="line">OpenAIAPIKey: os.Getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>),</span><br><span class="line">MaxBorrowDays: <span class="number">14</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">agent, err := NewLibraryAgent(config)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;åˆå§‹åŒ–Agentå¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> agent.db.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•å€Ÿä¹¦æŠ€èƒ½</span></span><br><span class="line">ctx := context.Background()</span><br><span class="line">params := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;user123&quot;</span>,</span><br><span class="line"><span class="string">&quot;book_id&quot;</span>: <span class="string">&quot;book456&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result, err := agent.skills[<span class="string">&quot;borrow_book&quot;</span>].Execute(ctx, params)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;æŠ€èƒ½æ‰§è¡Œå¤±è´¥: %v&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;ç»“æœ: %+v\n&quot;</span>, result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-4-PHPå®ç°"><a href="#5-4-PHPå®ç°" class="headerlink" title="5.4 PHPå®ç°"></a>5.4 PHPå®ç°</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// library_agent.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">OpenAI</span>\<span class="title">Client</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">OpenAI</span>\<span class="title">Factory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PgSql</span>\<span class="title">Connection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LibraryAgent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$db</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$openai</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$skills</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$tools</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$config</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config = <span class="variable">$config</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="title function_ invoke__">pg_connect</span>(<span class="variable">$config</span>[<span class="string">&#x27;database_url&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;db) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;æ•°æ®åº“è¿æ¥å¤±è´¥: &quot;</span> . <span class="title function_ invoke__">pg_last_error</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;openai = <span class="title class_">Factory</span>::<span class="title function_ invoke__">factory</span>()-&gt;<span class="title function_ invoke__">getClient</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ³¨å†ŒæŠ€èƒ½</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerSkills</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ³¨å†Œå·¥å…·</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">registerTools</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">registerSkills</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;skills[<span class="string">&#x27;borrow_book&#x27;</span>] = <span class="keyword">new</span> <span class="title class_">BorrowBookSkill</span>(<span class="variable language_">$this</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;skills[<span class="string">&#x27;return_book&#x27;</span>] = <span class="keyword">new</span> <span class="title class_">ReturnBookSkill</span>(<span class="variable language_">$this</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;skills[<span class="string">&#x27;search_books&#x27;</span>] = <span class="keyword">new</span> <span class="title class_">SearchBooksSkill</span>(<span class="variable language_">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">registerTools</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;tools[<span class="string">&#x27;check_availability&#x27;</span>] = [</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;check_availability&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;description&#x27;</span> =&gt; <span class="string">&#x27;æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;handler&#x27;</span> =&gt; [<span class="variable language_">$this</span>, <span class="string">&#x27;handleCheckAvailability&#x27;</span>]</span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;tools[<span class="string">&#x27;get_user_info&#x27;</span>] = [</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;get_user_info&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;description&#x27;</span> =&gt; <span class="string">&#x27;è·å–ç”¨æˆ·ä¿¡æ¯&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;handler&#x27;</span> =&gt; [<span class="variable language_">$this</span>, <span class="string">&#x27;handleGetUserInfo&#x27;</span>]</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">executeSkill</span>(<span class="params"><span class="variable">$skillName</span>, <span class="variable">$params</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;skills[<span class="variable">$skillName</span>])) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;æŠ€èƒ½ä¸å­˜åœ¨: &quot;</span> . <span class="variable">$skillName</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;skills[<span class="variable">$skillName</span>]-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$params</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleCheckAvailability</span>(<span class="params"><span class="variable">$params</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$bookId</span> = <span class="variable">$params</span>[<span class="string">&#x27;book_id&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;SELECT title, author, total_copies, available_copies FROM books WHERE id = <span class="subst">$1</span>&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">pg_query_params</span>(<span class="variable">$this</span>-&gt;db, <span class="variable">$query</span>, [<span class="variable">$bookId</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$result</span> || <span class="title function_ invoke__">pg_num_rows</span>(<span class="variable">$result</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">&#x27;available&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;å›¾ä¹¦ä¸å­˜åœ¨&#x27;</span></span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$book</span> = <span class="title function_ invoke__">pg_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line">        <span class="variable">$available</span> = (<span class="keyword">int</span>)<span class="variable">$book</span>[<span class="string">&#x27;available_copies&#x27;</span>] &gt; <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;available&#x27;</span> =&gt; <span class="variable">$available</span>,</span><br><span class="line">            <span class="string">&#x27;book_title&#x27;</span> =&gt; <span class="variable">$book</span>[<span class="string">&#x27;title&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;author&#x27;</span> =&gt; <span class="variable">$book</span>[<span class="string">&#x27;author&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;total_copies&#x27;</span> =&gt; (<span class="keyword">int</span>)<span class="variable">$book</span>[<span class="string">&#x27;total_copies&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;available_copies&#x27;</span> =&gt; (<span class="keyword">int</span>)<span class="variable">$book</span>[<span class="string">&#x27;available_copies&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$available</span> ? <span class="string">&quot;ã€Š<span class="subst">&#123;$book[&#x27;title&#x27;]&#125;</span>ã€‹å½“å‰æœ‰<span class="subst">&#123;$book[&#x27;available_copies&#x27;]&#125;</span>æœ¬å¯å€Ÿ&quot;</span> : <span class="string">&quot;ã€Š<span class="subst">&#123;$book[&#x27;title&#x27;]&#125;</span>ã€‹æš‚æ— åº“å­˜&quot;</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleGetUserInfo</span>(<span class="params"><span class="variable">$params</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$userId</span> = <span class="variable">$params</span>[<span class="string">&#x27;user_id&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;SELECT name, email, max_borrow_limit FROM users WHERE id = <span class="subst">$1</span>&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">pg_query_params</span>(<span class="variable">$this</span>-&gt;db, <span class="variable">$query</span>, [<span class="variable">$userId</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$result</span> || <span class="title function_ invoke__">pg_num_rows</span>(<span class="variable">$result</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">&#x27;eligible&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;ç”¨æˆ·ä¸å­˜åœ¨&#x27;</span></span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$user</span> = <span class="title function_ invoke__">pg_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–å½“å‰å€Ÿé˜…æ•°é‡</span></span><br><span class="line">        <span class="variable">$borrowQuery</span> = <span class="string">&quot;SELECT COUNT(*) as current_borrows FROM borrow_records WHERE user_id = <span class="subst">$1</span> AND status = &#x27;borrowed&#x27;&quot;</span>;</span><br><span class="line">        <span class="variable">$borrowResult</span> = <span class="title function_ invoke__">pg_query_params</span>(<span class="variable">$this</span>-&gt;db, <span class="variable">$borrowQuery</span>, [<span class="variable">$userId</span>]);</span><br><span class="line">        <span class="variable">$borrowData</span> = <span class="title function_ invoke__">pg_fetch_assoc</span>(<span class="variable">$borrowResult</span>);</span><br><span class="line">        <span class="variable">$currentBorrows</span> = (<span class="keyword">int</span>)<span class="variable">$borrowData</span>[<span class="string">&#x27;current_borrows&#x27;</span>];</span><br><span class="line">        <span class="variable">$maxLimit</span> = (<span class="keyword">int</span>)<span class="variable">$user</span>[<span class="string">&#x27;max_borrow_limit&#x27;</span>];</span><br><span class="line">        <span class="variable">$eligible</span> = <span class="variable">$currentBorrows</span> &lt; <span class="variable">$maxLimit</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;eligible&#x27;</span> =&gt; <span class="variable">$eligible</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$user</span>[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;email&#x27;</span> =&gt; <span class="variable">$user</span>[<span class="string">&#x27;email&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;max_borrow_limit&#x27;</span> =&gt; <span class="variable">$maxLimit</span>,</span><br><span class="line">            <span class="string">&#x27;current_borrows&#x27;</span> =&gt; <span class="variable">$currentBorrows</span>,</span><br><span class="line">            <span class="string">&#x27;remaining_limit&#x27;</span> =&gt; <span class="variable">$maxLimit</span> - <span class="variable">$currentBorrows</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$eligible</span> ? <span class="string">&quot;ç”¨æˆ·å€Ÿé˜…èµ„æ ¼æ­£å¸¸&quot;</span> : <span class="string">&quot;å·²è¾¾åˆ°æœ€å¤§å€Ÿé˜…æ•°é‡&quot;</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;db) &#123;</span><br><span class="line">            <span class="title function_ invoke__">pg_close</span>(<span class="variable">$this</span>-&gt;db);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BorrowBookSkill</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$agent</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$agent</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;agent = <span class="variable">$agent</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params"><span class="variable">$params</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$userId</span> = <span class="variable">$params</span>[<span class="string">&#x27;user_id&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$bookId</span> = <span class="variable">$params</span>[<span class="string">&#x27;book_id&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$userId</span>) || <span class="keyword">empty</span>(<span class="variable">$bookId</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;ç¼ºå°‘å¿…è¦çš„å‚æ•°: user_id æˆ– book_id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥ç”¨æˆ·èµ„æ ¼</span></span><br><span class="line">        <span class="variable">$userInfo</span> = <span class="variable language_">$this</span>-&gt;agent-&gt;tools[<span class="string">&#x27;get_user_info&#x27;</span>][<span class="string">&#x27;handler&#x27;</span>]([</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span> =&gt; <span class="variable">$userId</span></span><br><span class="line">        ]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$userInfo</span>[<span class="string">&#x27;eligible&#x27;</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$userInfo</span>[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥å›¾ä¹¦å¯ç”¨æ€§</span></span><br><span class="line">        <span class="variable">$availability</span> = <span class="variable language_">$this</span>-&gt;agent-&gt;tools[<span class="string">&#x27;check_availability&#x27;</span>][<span class="string">&#x27;handler&#x27;</span>]([</span><br><span class="line">            <span class="string">&#x27;book_id&#x27;</span> =&gt; <span class="variable">$bookId</span></span><br><span class="line">        ]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$availability</span>[<span class="string">&#x27;available&#x27;</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;message&#x27;</span> =&gt; <span class="variable">$availability</span>[<span class="string">&#x27;message&#x27;</span>]</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œå€Ÿé˜…</span></span><br><span class="line">        <span class="variable">$borrowDate</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d&#x27;</span>);</span><br><span class="line">        <span class="variable">$dueDate</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d&#x27;</span>, <span class="title function_ invoke__">strtotime</span>(<span class="string">&quot;+14 days&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;INSERT INTO borrow_records (user_id, book_id, borrow_date, due_date, status) VALUES (<span class="subst">$1</span>, <span class="subst">$2</span>, <span class="subst">$3</span>, <span class="subst">$4</span>, &#x27;borrowed&#x27;) RETURNING id&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">pg_query_params</span>(<span class="variable">$this</span>-&gt;agent-&gt;db, <span class="variable">$query</span>, [<span class="variable">$userId</span>, <span class="variable">$bookId</span>, <span class="variable">$borrowDate</span>, <span class="variable">$dueDate</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;å€Ÿé˜…å¤±è´¥: &quot;</span> . <span class="title function_ invoke__">pg_last_error</span>(<span class="variable">$this</span>-&gt;agent-&gt;db));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$record</span> = <span class="title function_ invoke__">pg_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line">        <span class="variable">$transactionId</span> = <span class="variable">$record</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;transaction_id&#x27;</span> =&gt; <span class="variable">$transactionId</span>,</span><br><span class="line">            <span class="string">&#x27;due_date&#x27;</span> =&gt; <span class="variable">$dueDate</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&quot;å€Ÿé˜…æˆåŠŸï¼è¯·åœ¨<span class="subst">&#123;$dueDate&#125;</span>å‰å½’è¿˜ã€‚&quot;</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;å¤„ç†å›¾ä¹¦å€Ÿé˜…è¯·æ±‚ï¼ŒéªŒè¯ç”¨æˆ·èµ„æ ¼å’Œå›¾ä¹¦å¯ç”¨æ€§&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="variable">$config</span> = [</span><br><span class="line">    <span class="string">&#x27;database_url&#x27;</span> =&gt; <span class="string">&#x27;host=localhost dbname=library_db user=library_user password=password&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;openai_api_key&#x27;</span> =&gt; <span class="title function_ invoke__">getenv</span>(<span class="string">&#x27;OPENAI_API_KEY&#x27;</span>)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$agent</span> = <span class="keyword">new</span> <span class="title class_">LibraryAgent</span>(<span class="variable">$config</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œå€Ÿä¹¦æŠ€èƒ½</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$agent</span>-&gt;<span class="title function_ invoke__">executeSkill</span>(<span class="string">&#x27;borrow_book&#x27;</span>, [</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span> =&gt; <span class="string">&#x27;user123&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;book_id&#x27;</span> =&gt; <span class="string">&#x27;book456&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);</span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;é”™è¯¯: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§"><a href="#å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§" class="headerlink" title="å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§"></a>å…­ã€æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§</h2><h3 id="6-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#6-1-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="6.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>6.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3><ol><li><strong>æŠ€èƒ½ç¼“å­˜</strong>ï¼šå¯¹é¢‘ç¹è°ƒç”¨çš„Skillsç»“æœè¿›è¡Œç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—</li><li><strong>è¿æ¥æ± ä¼˜åŒ–</strong>ï¼šåˆç†é…ç½®æ•°æ®åº“è¿æ¥æ± å¤§å°ï¼Œé¿å…è¿æ¥æ³„æ¼</li><li><strong>å¼‚æ­¥æ‰§è¡Œ</strong>ï¼šå¯¹äºè€—æ—¶æ“ä½œï¼Œä½¿ç”¨å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—å¤„ç†</li><li><strong>æ‰¹å¤„ç†</strong>ï¼šåˆå¹¶å¤šä¸ªç›¸ä¼¼è¯·æ±‚ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°</li><li><strong>ç´¢å¼•ä¼˜åŒ–</strong>ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºåˆé€‚çš„ç´¢å¼•</li></ol><h3 id="6-2-ç›‘æ§æŒ‡æ ‡è®¾è®¡"><a href="#6-2-ç›‘æ§æŒ‡æ ‡è®¾è®¡" class="headerlink" title="6.2 ç›‘æ§æŒ‡æ ‡è®¾è®¡"></a>6.2 ç›‘æ§æŒ‡æ ‡è®¾è®¡</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus.yml</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;library-agent&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;agent-service:9090&#x27;</span>]</span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">&#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é”®ç›‘æ§æŒ‡æ ‡</span></span><br><span class="line"><span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_skill_execution_count&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;counter&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;æŠ€èƒ½æ‰§è¡Œæ¬¡æ•°ç»Ÿè®¡&quot;</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;skill_name&quot;</span>, <span class="string">&quot;status&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_skill_execution_duration_seconds&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;histogram&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;æŠ€èƒ½æ‰§è¡Œè€—æ—¶åˆ†å¸ƒ&quot;</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;skill_name&quot;</span>]</span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_database_connections&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;gauge&quot;</span> </span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;æ•°æ®åº“è¿æ¥æ•°&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_memory_usage_mb&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;gauge&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;å†…å­˜ä½¿ç”¨é‡&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_request_queue_length&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;gauge&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;è¯·æ±‚é˜Ÿåˆ—é•¿åº¦&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;agent_error_count&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">&quot;counter&quot;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;é”™è¯¯æ¬¡æ•°ç»Ÿè®¡&quot;</span></span><br><span class="line">    <span class="attr">labels:</span> [<span class="string">&quot;error_type&quot;</span>, <span class="string">&quot;skill_name&quot;</span>]</span><br></pre></td></tr></table></figure><h2 id="ä¸ƒã€å®‰å…¨åŠ å›ºæªæ–½"><a href="#ä¸ƒã€å®‰å…¨åŠ å›ºæªæ–½" class="headerlink" title="ä¸ƒã€å®‰å…¨åŠ å›ºæªæ–½"></a>ä¸ƒã€å®‰å…¨åŠ å›ºæªæ–½</h2><h3 id="7-1-å®‰å…¨æ¶æ„è®¾è®¡"><a href="#7-1-å®‰å…¨æ¶æ„è®¾è®¡" class="headerlink" title="7.1 å®‰å…¨æ¶æ„è®¾è®¡"></a>7.1 å®‰å…¨æ¶æ„è®¾è®¡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      å®‰å…¨é˜²æŠ¤å±‚                               |</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚</span><br><span class="line">â”‚  â”‚  è¾“å…¥éªŒè¯    â”‚  | æƒé™æ§åˆ¶      â”‚  â”‚ æ²™ç®±éš”ç¦»     â”‚          â”‚</span><br><span class="line">â”‚  â”‚ (Validation)â”‚  â”‚ (RBAC)      â”‚  â”‚ (Sandbox)   â”‚          â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                            â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                      åº”ç”¨å±‚                                  â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚</span><br><span class="line">â”‚  â”‚  Agent      |  â”‚ Skills      â”‚  â”‚   Log       â”‚          â”‚</span><br><span class="line">|  |    æ ¸å¿ƒ      |  |   ç®¡ç†      ï½œ  |  æ—¥å¿—å®¡è®¡    |          |    </span><br><span class="line">â”‚  â”‚ (Core)      â”‚  â”‚ (Registry)  â”‚  â”‚ (Audit)     â”‚          â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="7-2-å…³é”®å®‰å…¨æªæ–½ï¼ˆå»ºè®®ï¼‰"><a href="#7-2-å…³é”®å®‰å…¨æªæ–½ï¼ˆå»ºè®®ï¼‰" class="headerlink" title="7.2 å…³é”®å®‰å…¨æªæ–½ï¼ˆå»ºè®®ï¼‰"></a>7.2 å…³é”®å®‰å…¨æªæ–½ï¼ˆå»ºè®®ï¼‰</h3><ol><li><strong>è¾“å…¥éªŒè¯</strong>ï¼šå¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸¥æ ¼éªŒè¯å’Œè¿‡æ»¤</li><li><strong>æƒé™æ§åˆ¶</strong>ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼Œæœ€å°æƒé™åŸåˆ™</li><li><strong>æ²™ç®±éš”ç¦»</strong>ï¼šSkillsåœ¨ç‹¬ç«‹çš„æ²™ç®±ç¯å¢ƒä¸­æ‰§è¡Œï¼Œé™åˆ¶ç³»ç»Ÿè®¿é—®</li><li><strong>æ•°æ®åŠ å¯†</strong>ï¼šæ•æ„Ÿæ•°æ®åœ¨ä¼ è¾“å’Œå­˜å‚¨æ—¶è¿›è¡ŒåŠ å¯†</li><li><strong>å®¡è®¡æ—¥å¿—</strong>ï¼šè®°å½•æ‰€æœ‰å…³é”®æ“ä½œï¼Œä¾¿äºå®‰å…¨å®¡è®¡å’Œé—®é¢˜è¿½è¸ª</li><li><strong>é€Ÿç‡é™åˆ¶</strong>ï¼šé˜²æ­¢APIæ»¥ç”¨å’ŒDDoSæ”»å‡»</li><li><strong>å®‰å…¨æ›´æ–°</strong>ï¼šå®šæœŸæ›´æ–°ä¾èµ–åº“ï¼Œä¿®å¤å·²çŸ¥å®‰å…¨æ¼æ´</li></ol><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>Agentä¸Skillsçš„å…³ç³»æ¶æ„ä»£è¡¨äº†ç°ä»£AIç³»ç»Ÿè®¾è®¡çš„æ–°èŒƒå¼ï¼Œé€šè¿‡å°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘åˆ†è§£ä¸ºå¯å¤ç”¨çš„Skillsï¼ŒAgentèƒ½å¤Ÿæ›´åŠ çµæ´»ã€æ™ºèƒ½åœ°å¤„ç†å„ç§ä»»åŠ¡ã€‚æœ¬æ–‡åŸºäºDebian 12ç¯å¢ƒï¼Œä»åŸç†åˆ°å®è·µï¼Œå…¨é¢ä»‹ç»äº†è¿™ä¸€æ¶æ„çš„è®¾è®¡ã€å®ç°å’Œéƒ¨ç½²ã€‚LangChainæ¡†æ¶ä¸ºå¼€å‘è€…æä¾›äº†å¼ºå¤§çš„å·¥å…·å’Œé¢„æ„å»ºçš„æ¶æ„ï¼Œè®©æ„å»ºAI agentså˜å¾—æ›´åŠ é«˜æ•ˆã€‚</p><p>åœ¨å›¾ä¹¦é¦†å€Ÿä¹¦ç®¡ç†ç³»ç»Ÿçš„å®æˆ˜Demoä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¦‚ä½•å°†ç†è®ºçŸ¥è¯†åº”ç”¨åˆ°å…·ä½“ä¸šåŠ¡åœºæ™¯ï¼Œé€šè¿‡Pythonã€Goã€PHPä¸‰ç§ä¸»æµè¯­è¨€çš„å®ç°ï¼Œå±•ç¤ºäº†Skillsæ¶æ„çš„è·¨è¯­è¨€ç‰¹æ€§ã€‚ æ— è®ºé€‰æ‹©å“ªç§æŠ€æœ¯æ ˆï¼Œæ ¸å¿ƒçš„è®¾è®¡åŸåˆ™éƒ½æ˜¯ç›¸åŒçš„ï¼šæ¨¡å—åŒ–ã€å¯å¤ç”¨ã€å®‰å…¨å¯é ã€‚</p><p>éšç€AIæŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼ŒAgent-Skillsæ¶æ„å°†ç»§ç»­æ¼”è¿›ï¼Œæ”¯æŒæ›´å¤æ‚çš„å¤šAgentååŒã€æ›´æ™ºèƒ½çš„æŠ€èƒ½å‘ç°å’Œç»„åˆæœºåˆ¶ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬éœ€è¦æŒç»­å…³æ³¨è¿™ä¸€é¢†åŸŸçš„å‘å±•ï¼ŒæŒæ¡æœ€æ–°çš„è®¾è®¡æ¨¡å¼å’Œæœ€ä½³å®è·µï¼Œæ„å»ºæ›´åŠ æ™ºèƒ½ã€å¯é çš„åº”ç”¨ç³»ç»Ÿã€‚</p><p><strong>ä¸ªäººå»ºè®®</strong>ï¼šæŠ€æœ¯çš„æ ¸å¿ƒæ˜¯è§£å†³é—®é¢˜ï¼Œè€Œä¸æ˜¯è¿½é€æ½®æµã€‚åœ¨è®¾è®¡Agent-Skillsæ¶æ„æ—¶ï¼Œå§‹ç»ˆè¦ä»ä¸šåŠ¡éœ€æ±‚å‡ºå‘ï¼Œé€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯æœ€æµè¡Œçš„æŠ€æœ¯æ–¹æ¡ˆã€‚åªæœ‰è¿™æ ·ï¼Œæˆ‘ä»¬æ‰èƒ½æ„å»ºçœŸæ­£æœ‰ä»·å€¼çš„AIç³»ç»Ÿã€‚<strong>skillæœ¬èº«ä¹Ÿè®¸æ˜¯ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä½†ç»ä¸æ˜¯å”¯ä¸€çš„æœ€ä½³è§£å†³æ–¹æ¡ˆï¼Œéšç€æ¨¡å‹çš„èƒ½åŠ›è¿›ä¸€æ­¥å‘å±•ï¼Œé’ˆå¯¹ä¼ä¸šçº§åœºæ™¯åº”è¯¥ä¼šæœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚</strong>ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;&lt;a href=&quot;#æ‘˜è¦&quot; class=&quot;headerlink&quot; title=&quot;æ‘˜è¦&quot;&gt;&lt;/a&gt;æ‘˜è¦&lt;/h2&gt;&lt;p&gt;åœ¨æŠ€æœ¯è¯­å¢ƒä¸‹ï¼Œä¸¤è€…çš„å…³ç³»å¯ä»¥ç®€å•æ¦‚æ‹¬å’ŒåŒºåˆ†ä¸ºï¼šAgent æ˜¯å†³ç­–ä¸­å¿ƒï¼ŒSkills æ˜¯æ‰§è¡Œå‡½æ•°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Skill" scheme="https://www.wdft.com/tags/Skill/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/tags/Agent/"/>
    
    <category term="Agent-Skill" scheme="https://www.wdft.com/tags/Agent-Skill/"/>
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="Demo-AI" scheme="https://www.wdft.com/tags/Demo-AI/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäº Qwen çš„ LoRA å¾®è°ƒåŸç†ä»¥åŠå®æˆ˜ï¼šä»é›¶åˆ°ä¸€å¾®è°ƒä¸Šçº¿ä¸€ä¸ªå…¸å‹QAå®¢æœé—®ç­”ç³»ç»Ÿçš„å®è·µæµç¨‹</title>
    <link href="https://www.wdft.com/c2045d9d.html"/>
    <id>https://www.wdft.com/c2045d9d.html</id>
    <published>2026-01-07T15:26:21.000Z</published>
    <updated>2026-01-26T09:47:43.612Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h2 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h2><p>åœ¨2026å¹´ï¼Œå¤§è¯­è¨€æ¨¡å‹(LLMs)å·²ç»æˆä¸ºä¼ä¸šæ™ºèƒ½åŒ–è½¬å‹çš„æ ¸å¿ƒé©±åŠ¨åŠ›ï¼Œç‰¹åˆ«æ˜¯åœ¨å®¢æˆ·æœåŠ¡é¢†åŸŸã€‚<br>æœ¬æ–‡å°†ä»¥Qwenæ¨¡å‹ä¸ºä¾‹ï¼Œç»“åˆä¸€ä¸ªå…·ä½“çš„QAé—®ç­”ä¸šåŠ¡åœºæ™¯ï¼Œæ·±å…¥æ¢è®¨å¦‚ä½•é€šè¿‡LoRA(Low-Rank Adaptation)æŠ€æœ¯è¿›è¡Œé«˜æ•ˆå¾®è°ƒï¼Œä»åŸç†åˆ°å®æˆ˜ï¼Œå®Œæ•´è¦†ç›–å®¢æœé—®ç­”ç³»ç»Ÿçš„æ„å»ºæµç¨‹ï¼Œåªæ˜¯æä¾›æ€è·¯ä»¥åŠæ–¹å‘æŒ‡å¯¼ï¼Œå…·ä½“è¿˜æ˜¯è¦ä»¥å®é™…ä¸šåŠ¡ä¸ºå‡†âš ï¸ï¼Œä¹Ÿæ¬¢è¿ä¸€èµ·äº¤æµå­¦ä¹ ã€‚</p><span id="more"></span><h6 id="è”ç³»æ–¹å¼-github-com-x2F-ljq"><a href="#è”ç³»æ–¹å¼-github-com-x2F-ljq" class="headerlink" title="è”ç³»æ–¹å¼: github.com&#x2F;ljq"></a>è”ç³»æ–¹å¼: <a href="github.com/ljq">github.com&#x2F;ljq</a></h6><h2 id="ä¸€ã€LoRAåŸç†æ·±åº¦è§£ææ¢ç´¢"><a href="#ä¸€ã€LoRAåŸç†æ·±åº¦è§£ææ¢ç´¢" class="headerlink" title="ä¸€ã€LoRAåŸç†æ·±åº¦è§£ææ¢ç´¢"></a>ä¸€ã€LoRAåŸç†æ·±åº¦è§£ææ¢ç´¢</h2><h3 id="1-1-LoRAçš„åŸç†ä¹‹æ•°å­¦æœ¬è´¨ï¼šä½ç§©åˆ†è§£çš„ç†è®ºåŸºç¡€"><a href="#1-1-LoRAçš„åŸç†ä¹‹æ•°å­¦æœ¬è´¨ï¼šä½ç§©åˆ†è§£çš„ç†è®ºåŸºç¡€" class="headerlink" title="1.1 LoRAçš„åŸç†ä¹‹æ•°å­¦æœ¬è´¨ï¼šä½ç§©åˆ†è§£çš„ç†è®ºåŸºç¡€"></a>1.1 LoRAçš„åŸç†ä¹‹æ•°å­¦æœ¬è´¨ï¼šä½ç§©åˆ†è§£çš„ç†è®ºåŸºç¡€</h3><p>LoRAï¼ˆLow-Rank Adaptation of LLMsï¼‰çš„æ ¸å¿ƒåŸç†æ˜¯<strong>ä½ç§©åˆ†è§£</strong>ï¼Œå®ƒå»ºç«‹åœ¨çŸ©é˜µè¿‘ä¼¼ç†è®ºä¹‹ä¸Šã€‚å½“é¢„è®­ç»ƒå¤§æ¨¡å‹è¿›è¡Œç‰¹å®šä»»åŠ¡å¾®è°ƒæ—¶ï¼Œæƒé‡æ›´æ–°çŸ©é˜µÎ”Wé€šå¸¸å…·æœ‰ä½ç§©ç‰¹æ€§â€”â€”è¿™æ„å‘³ç€æˆ‘ä»¬ä¸éœ€è¦æ›´æ–°æ‰€æœ‰å‚æ•°ï¼Œåªéœ€æ•è·æœ€é‡è¦çš„å˜åŒ–æ–¹å‘ã€‚</p><p><strong>æ•°å­¦è¡¨è¾¾</strong>ï¼š<br>åœ¨æ ‡å‡†å¾®è°ƒä¸­ï¼Œæƒé‡æ›´æ–°ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">W&#x27; = W + Î”W</span><br></pre></td></tr></table></figure><p>å…¶ä¸­Wæ˜¯åŸå§‹æƒé‡çŸ©é˜µ(dÃ—k)ï¼ŒÎ”Wæ˜¯æ›´æ–°çŸ©é˜µï¼Œéœ€è¦è®­ç»ƒdÃ—kä¸ªå‚æ•°ã€‚</p><p>LoRAé€šè¿‡ä½ç§©åˆ†è§£é‡æ„Î”Wï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">W&#x27; = W + Î”W = W + A Ã— B</span><br></pre></td></tr></table></figure><p>å…¶ä¸­Aâˆˆâ„^(dÃ—r)ï¼ŒBâˆˆâ„^(rÃ—k)ï¼Œræ˜¯ç§©(rank)ï¼Œé€šå¸¸r &lt;&lt; min(d,k)ã€‚è¿™å°†å‚æ•°é‡ä»O(dÃ—k)å‡å°‘åˆ°O(rÃ—(d+k))ã€‚</p><p><strong>ä¸ºä»€ä¹ˆä½ç§©åˆ†è§£æœ‰æ•ˆ</strong>ï¼Ÿå¤§æ¨¡å‹éƒ½æ˜¯è¿‡å‚æ•°åŒ–çš„ï¼Œå½“ç”¨äºç‰¹å®šä»»åŠ¡æ—¶ï¼Œå…¶å®åªæœ‰ä¸€å°éƒ¨åˆ†å‚æ•°èµ·ä¸»è¦ä½œç”¨ã€‚ä¹Ÿå°±æ˜¯å‚æ•°çŸ©é˜µç»´åº¦å¾ˆé«˜ï¼Œä½†å¯ä»¥ç”¨ä½ç»´çŸ©é˜µåˆ†è§£æ¥è¿‘ä¼¼ã€‚</p><h3 id="1-2-LoRAçš„æ¶æ„è®¾è®¡"><a href="#1-2-LoRAçš„æ¶æ„è®¾è®¡" class="headerlink" title="1.2 LoRAçš„æ¶æ„è®¾è®¡"></a>1.2 LoRAçš„æ¶æ„è®¾è®¡</h3><p>LoRAåœ¨Transformeræ¶æ„çš„æ¯ä¸€å±‚ä¸­æ³¨å…¥å¯è®­ç»ƒçš„ç§©åˆ†è§£çŸ©é˜µï¼Œå…·ä½“å®ç°æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹å‰å‘ä¼ æ’­ï¼š  h = W Ã— x</span><br><span class="line">LoRAå‰å‘ä¼ æ’­ï¼š  h = (W + AÃ—B) Ã— x = WÃ—x + AÃ—(BÃ—x)</span><br></pre></td></tr></table></figure><p>è¿™ç§è®¾è®¡å…·æœ‰ä»¥ä¸‹å…³é”®ç‰¹æ€§ï¼š</p><ul><li><strong>å‚æ•°å†»ç»“</strong>ï¼šåŸå§‹æƒé‡Wåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¿æŒå†»ç»“ï¼Œä»…æ›´æ–°Aå’ŒB</li><li><strong>å¹¶è¡Œè·¯å¾„</strong>ï¼šLoRAæ¨¡å—ä¸åŸå§‹æƒé‡å¹¶è¡Œè®¡ç®—ï¼Œç¡®ä¿æ¢¯åº¦æµåŠ¨</li><li><strong>æ¨¡å—åŒ–è®¾è®¡</strong>ï¼šå¯ä»¥çµæ´»é€‰æ‹©åœ¨å“ªäº›å±‚ã€å“ªäº›æ¨¡å—åº”ç”¨LoRA</li></ul><p>å¯¹äºQwenç­‰ç°ä»£Transformeræ¨¡å‹ï¼ŒLoRAé€šå¸¸åº”ç”¨äºä»¥ä¸‹å…³é”®æ¨¡å—ï¼š</p><ul><li><strong>Attentionå±‚</strong>ï¼šq_proj, k_proj, v_proj, o_proj</li><li><strong>FFNå±‚</strong>ï¼šgate_proj, up_proj, down_proj</li><li><strong>LayerNorm</strong>ï¼šé€šå¸¸ä¸åº”ç”¨LoRAï¼Œå› ä¸ºè¿™äº›å±‚å·²ç»å¾ˆå°</li></ul><h3 id="1-3-ä¸å…¶ä»–PEFTæ–¹æ³•å¯¹æ¯”"><a href="#1-3-ä¸å…¶ä»–PEFTæ–¹æ³•å¯¹æ¯”" class="headerlink" title="1.3 ä¸å…¶ä»–PEFTæ–¹æ³•å¯¹æ¯”"></a>1.3 ä¸å…¶ä»–PEFTæ–¹æ³•å¯¹æ¯”</h3><table><thead><tr><th>æ–¹æ³•</th><th>å‚æ•°æ•ˆç‡</th><th>è®­ç»ƒé€Ÿåº¦</th><th>å†…å­˜å ç”¨</th><th>åˆå¹¶éš¾åº¦</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>Full Fine-tuning</td><td>ä½</td><td>æ…¢</td><td>é«˜</td><td>æ— éœ€åˆå¹¶</td><td>å……è¶³èµ„æºï¼Œæ•°æ®ä¸°å¯Œ</td></tr><tr><td><strong>LoRA (æ¨è)</strong></td><td><strong>é«˜</strong></td><td><strong>å¿«</strong></td><td><strong>ä½</strong></td><td><strong>ç®€å•</strong></td><td><strong>é€šç”¨åœºæ™¯ï¼Œå®¢æœç³»ç»Ÿ</strong></td></tr><tr><td>Prefix Tuning</td><td>ä¸­ç­‰</td><td>ä¸­ç­‰</td><td>ä¸­ç­‰</td><td>å¤æ‚</td><td>æ–‡æœ¬ç”Ÿæˆä»»åŠ¡</td></tr><tr><td>Adapter</td><td>ä¸­ç­‰</td><td>æ…¢</td><td>ä¸­ç­‰</td><td>ç®€å•</td><td>èµ„æºå—é™ç¯å¢ƒ</td></tr><tr><td>BitFit</td><td>æé«˜</td><td>å¿«</td><td>æä½</td><td>æ— éœ€</td><td>æç«¯èµ„æºé™åˆ¶</td></tr></tbody></table><p>LoRAçš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºå®ƒåœ¨å‚æ•°æ•ˆç‡å’Œæ¨¡å‹æ€§èƒ½ä¹‹é—´å–å¾—äº†æœ€ä½³å¹³è¡¡ã€‚ç›¸æ¯”å…¨é‡å¾®è°ƒï¼ŒLoRAèƒ½æ˜¾è‘—é™ä½è®¡ç®—æˆæœ¬ï¼ŒåŒæ—¶ä¿æŒæ¨¡å‹æ€§èƒ½ã€‚</p><h3 id="1-4-LoRAçš„æ•°å­¦ç›´è§‰ä¸å‡ ä½•è§£é‡Š"><a href="#1-4-LoRAçš„æ•°å­¦ç›´è§‰ä¸å‡ ä½•è§£é‡Š" class="headerlink" title="1.4 LoRAçš„æ•°å­¦ç›´è§‰ä¸å‡ ä½•è§£é‡Š"></a>1.4 LoRAçš„æ•°å­¦ç›´è§‰ä¸å‡ ä½•è§£é‡Š</h3><p>ä»å‡ ä½•è§’åº¦æ¥çœ‹ï¼ŒLoRAå¯ä»¥ç†è§£ä¸ºåœ¨é«˜ç»´æƒé‡ç©ºé—´ä¸­å¯»æ‰¾ä¸€ä¸ªä½ç»´å­ç©ºé—´ï¼Œè¿™ä¸ªå­ç©ºé—´åŒ…å«äº†ä»»åŠ¡ç‰¹å®šçš„é‡è¦å˜åŒ–æ–¹å‘ã€‚å½“æˆ‘ä»¬è¯´â€ç§©r&#x3D;8â€æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨8ç»´å­ç©ºé—´ä¸­å¯»æ‰¾æœ€ä¼˜çš„æƒé‡æ›´æ–°æ–¹å‘ã€‚</p><p><strong>å¥‡å¼‚å€¼åˆ†è§£(SVD)è§†è§’</strong>ï¼š<br>ä»»ä½•çŸ©é˜µÎ”Wéƒ½å¯ä»¥é€šè¿‡SVDåˆ†è§£ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Î”W = UÎ£V^T</span><br></pre></td></tr></table></figure><p>å…¶ä¸­UåŒ…å«å·¦å¥‡å¼‚å‘é‡ï¼ŒÎ£æ˜¯å¯¹è§’çŸ©é˜µï¼ˆå¥‡å¼‚å€¼ï¼‰ï¼ŒVåŒ…å«å³å¥‡å¼‚å‘é‡ã€‚LoRAæœ¬è´¨ä¸Šæ˜¯åªä¿ç•™æœ€å¤§çš„rä¸ªå¥‡å¼‚å€¼å¯¹åº”çš„åˆ†é‡ï¼Œä¸¢å¼ƒé‚£äº›å¯¹ä»»åŠ¡è´¡çŒ®è¾ƒå°çš„æ–¹å‘ã€‚</p><p><strong>æ¢¯åº¦æµåŠ¨åˆ†æ</strong>ï¼š<br>åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼ŒLoRAçš„æ¢¯åº¦æ›´æ–°ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âˆ‡_A L = âˆ‡_Î”W L Ã— B^T</span><br><span class="line">âˆ‡_B L = A^T Ã— âˆ‡_Î”W L</span><br></pre></td></tr></table></figure><p>è¿™ç§è®¾è®¡ç¡®ä¿äº†æ¢¯åº¦èƒ½å¤Ÿæœ‰æ•ˆåœ°æµåŠ¨ï¼ŒåŒæ—¶é€šè¿‡ä½ç§©çº¦æŸé˜²æ­¢è¿‡æ‹Ÿåˆã€‚ç‰¹åˆ«æ˜¯å¯¹äºå®¢æœé—®ç­”ç³»ç»Ÿè¿™ç±»ä»»åŠ¡ï¼Œæ•°æ®é‡ç›¸å¯¹æœ‰é™ï¼Œä½ç§©çº¦æŸèƒ½å¤Ÿæä¾›è‰¯å¥½çš„å½’çº³åç½®ã€‚</p><h3 id="1-5-ä¸ºä»€ä¹ˆLoRAç‰¹åˆ«é€‚åˆå®¢æœåœºæ™¯ï¼Ÿ"><a href="#1-5-ä¸ºä»€ä¹ˆLoRAç‰¹åˆ«é€‚åˆå®¢æœåœºæ™¯ï¼Ÿ" class="headerlink" title="1.5 ä¸ºä»€ä¹ˆLoRAç‰¹åˆ«é€‚åˆå®¢æœåœºæ™¯ï¼Ÿ"></a>1.5 ä¸ºä»€ä¹ˆLoRAç‰¹åˆ«é€‚åˆå®¢æœåœºæ™¯ï¼Ÿ</h3><ol><li><strong>é¢†åŸŸé€‚åº”æ€§</strong>ï¼šå®¢æœç³»ç»Ÿéœ€è¦åœ¨ä¿æŒé€šç”¨è¯­è¨€èƒ½åŠ›çš„åŒæ—¶ï¼Œé€‚åº”ç‰¹å®šé¢†åŸŸçš„æœ¯è¯­å’Œæµç¨‹</li><li><strong>æ•°æ®æ•ˆç‡</strong>ï¼šå®¢æœå¯¹è¯æ•°æ®é€šå¸¸æœ‰é™ï¼ŒLoRAçš„å‚æ•°æ•ˆç‡é¿å…äº†è¿‡æ‹Ÿåˆé£é™©</li><li><strong>å¿«é€Ÿè¿­ä»£</strong>ï¼šä¸šåŠ¡éœ€æ±‚å˜åŒ–æ—¶ï¼Œå¯ä»¥å¿«é€Ÿé‡æ–°è®­ç»ƒå’Œéƒ¨ç½²</li><li><strong>å¤šä»»åŠ¡æ”¯æŒ</strong>ï¼šä¸åŒäº§å“çº¿å¯ä»¥è®­ç»ƒä¸åŒçš„LoRAé€‚é…å™¨ï¼Œå…±äº«åŒä¸€ä¸ªåŸºç¡€æ¨¡å‹</li></ol><h2 id="äºŒã€å®é™…æ¡ˆä¾‹ï¼šç”µå•†å®¢æœé—®ç­”ç³»ç»Ÿå¾®è°ƒå®è·µ"><a href="#äºŒã€å®é™…æ¡ˆä¾‹ï¼šç”µå•†å®¢æœé—®ç­”ç³»ç»Ÿå¾®è°ƒå®è·µ" class="headerlink" title="äºŒã€å®é™…æ¡ˆä¾‹ï¼šç”µå•†å®¢æœé—®ç­”ç³»ç»Ÿå¾®è°ƒå®è·µ"></a>äºŒã€å®é™…æ¡ˆä¾‹ï¼šç”µå•†å®¢æœé—®ç­”ç³»ç»Ÿå¾®è°ƒå®è·µ</h2><h3 id="2-1-æ¡ˆä¾‹èƒŒæ™¯ä¸ä¸šåŠ¡éœ€æ±‚"><a href="#2-1-æ¡ˆä¾‹èƒŒæ™¯ä¸ä¸šåŠ¡éœ€æ±‚" class="headerlink" title="2.1 æ¡ˆä¾‹èƒŒæ™¯ä¸ä¸šåŠ¡éœ€æ±‚"></a>2.1 æ¡ˆä¾‹èƒŒæ™¯ä¸ä¸šåŠ¡éœ€æ±‚</h3><p><strong>ä¸šåŠ¡åœºæ™¯</strong>ï¼šæŸå¤§å‹ç”µå•†å¹³å°éœ€è¦æ„å»ºæ™ºèƒ½å®¢æœç³»ç»Ÿï¼Œå¤„ç†ç”¨æˆ·å…³äºè®¢å•ã€ç‰©æµã€é€€æ¢è´§ã€äº§å“å’¨è¯¢ç­‰é—®é¢˜ã€‚</p><p><strong>æ ¸å¿ƒæŒ‘æˆ˜</strong>ï¼š</p><ul><li>æ¯æ—¥å®¢æœå¯¹è¯é‡ï¼š50ä¸‡+æ¡</li><li>äººå·¥å®¢æœæˆæœ¬ï¼šçº¦Â¥200&#x2F;å°æ—¶&#x2F;äºº</li><li>ç”¨æˆ·æ»¡æ„åº¦è¦æ±‚ï¼š&gt;85%</li><li>å“åº”æ—¶é—´è¦æ±‚ï¼š&lt;3ç§’</li></ul><p><strong>æ•°æ®ç»Ÿè®¡</strong>ï¼š</p><ul><li>å†å²å¯¹è¯æ•°æ®ï¼š12ä¸‡æ¡æ ‡æ³¨å¯¹è¯</li><li>é—®é¢˜ç±»å‹åˆ†å¸ƒï¼š<ul><li>è®¢å•æŸ¥è¯¢ï¼š35%</li><li>ç‰©æµè·Ÿè¸ªï¼š25%  </li><li>é€€æ¢è´§æ”¿ç­–ï¼š20%</li><li>äº§å“å’¨è¯¢ï¼š15%</li><li>æŠ•è¯‰å»ºè®®ï¼š5%</li></ul></li></ul><h3 id="2-2-æ•°æ®å‡†å¤‡ä¸é¢„å¤„ç†"><a href="#2-2-æ•°æ®å‡†å¤‡ä¸é¢„å¤„ç†" class="headerlink" title="2.2 æ•°æ®å‡†å¤‡ä¸é¢„å¤„ç†"></a>2.2 æ•°æ®å‡†å¤‡ä¸é¢„å¤„ç†</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_customer_service_dataset</span>(<span class="params">raw_data_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç”µå•†å®¢æœæ•°æ®å‡†å¤‡ï¼šä»åŸå§‹å¯¹è¯åˆ°æŒ‡ä»¤å¾®è°ƒæ ¼å¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è¯»å–åŸå§‹æ•°æ®</span></span><br><span class="line">    df = pd.read_csv(raw_data_path)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ•°æ®æ¸…æ´—</span></span><br><span class="line">    df = df[df[<span class="string">&#x27;user_query&#x27;</span>].notna() &amp; df[<span class="string">&#x27;assistant_response&#x27;</span>].notna()]</span><br><span class="line">    df = df[df[<span class="string">&#x27;user_query&#x27;</span>].<span class="built_in">str</span>.<span class="built_in">len</span>() &gt; <span class="number">5</span>]  <span class="comment"># è¿‡æ»¤å¤ªçŸ­çš„æŸ¥è¯¢</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡</span></span><br><span class="line">    processed_data = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, row <span class="keyword">in</span> df.iterrows():</span><br><span class="line">        <span class="comment"># æ„å»ºç³»ç»ŸæŒ‡ä»¤</span></span><br><span class="line">        system_instruction = <span class="string">&quot;&quot;&quot;ä½ æ˜¯ä¸€åä¸“ä¸šçš„ç”µå•†å®¢æœåŠ©æ‰‹ï¼Œéœ€è¦ï¼š</span></span><br><span class="line"><span class="string">        1. å‡†ç¡®ç†è§£ç”¨æˆ·é—®é¢˜ï¼Œæä¾›ä¸“ä¸šã€å‹å¥½çš„å›ç­”</span></span><br><span class="line"><span class="string">        2. æ¶‰åŠè®¢å•ã€ç‰©æµä¿¡æ¯æ—¶ï¼Œå¿…é¡»è¦æ±‚ç”¨æˆ·æä¾›å…·ä½“è®¢å•å·</span></span><br><span class="line"><span class="string">        3. é€€æ¢è´§æ”¿ç­–è¦ä¸¥æ ¼æŒ‰ç…§å…¬å¸è§„å®šå›ç­”</span></span><br><span class="line"><span class="string">        4. ä¸ç¡®å®šçš„ä¿¡æ¯ä¸è¦çŒœæµ‹ï¼Œå¼•å¯¼ç”¨æˆ·è”ç³»äººå·¥å®¢æœ</span></span><br><span class="line"><span class="string">        5. ä¿æŒè€å¿ƒå’Œç¤¼è²Œï¼Œä½¿ç”¨æ•¬è¯­&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ„å»ºè¾“å…¥ä¸Šä¸‹æ–‡</span></span><br><span class="line">        context = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> row.get(<span class="string">&#x27;order_id&#x27;</span>):</span><br><span class="line">            context += <span class="string">f&quot;è®¢å•ä¿¡æ¯: è®¢å•å· <span class="subst">&#123;row[<span class="string">&#x27;order_id&#x27;</span>]&#125;</span>, çŠ¶æ€: <span class="subst">&#123;row[<span class="string">&#x27;order_status&#x27;</span>]&#125;</span>\n&quot;</span></span><br><span class="line">        <span class="keyword">if</span> row.get(<span class="string">&#x27;user_history&#x27;</span>):</span><br><span class="line">            context += <span class="string">f&quot;ç”¨æˆ·å†å²: <span class="subst">&#123;row[<span class="string">&#x27;user_history&#x27;</span>]&#125;</span>\n&quot;</span></span><br><span class="line">        </span><br><span class="line">        user_query = row[<span class="string">&#x27;user_query&#x27;</span>]</span><br><span class="line">        assistant_response = row[<span class="string">&#x27;assistant_response&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ„å»ºè®­ç»ƒæ ·æœ¬</span></span><br><span class="line">        sample = &#123;</span><br><span class="line">            <span class="string">&quot;instruction&quot;</span>: system_instruction,</span><br><span class="line">            <span class="string">&quot;input&quot;</span>: <span class="string">f&quot;ä¸Šä¸‹æ–‡ä¿¡æ¯:\n<span class="subst">&#123;context.strip()&#125;</span>\n\nç”¨æˆ·é—®é¢˜:\n<span class="subst">&#123;user_query&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="string">&quot;output&quot;</span>: assistant_response,</span><br><span class="line">            <span class="string">&quot;category&quot;</span>: row[<span class="string">&#x27;category&#x27;</span>]  <span class="comment"># é—®é¢˜ç±»åˆ«ï¼Œç”¨äºåç»­åˆ†æ</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        processed_data.append(sample)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æŒ‰ç±»åˆ«åˆ†å±‚æŠ½æ ·</span></span><br><span class="line">    train_data, test_data = train_test_split(</span><br><span class="line">        processed_data, </span><br><span class="line">        test_size=<span class="number">0.15</span>, </span><br><span class="line">        stratify=[item[<span class="string">&#x27;category&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> processed_data],</span><br><span class="line">        random_state=<span class="number">42</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è®­ç»ƒé›†å¤§å°: <span class="subst">&#123;<span class="built_in">len</span>(train_data)&#125;</span>, æµ‹è¯•é›†å¤§å°: <span class="subst">&#123;<span class="built_in">len</span>(test_data)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ç±»åˆ«åˆ†å¸ƒç»Ÿè®¡:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> category <span class="keyword">in</span> <span class="built_in">set</span>([item[<span class="string">&#x27;category&#x27;</span>] <span class="keyword">for</span> item <span class="keyword">in</span> processed_data]):</span><br><span class="line">        count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> item <span class="keyword">in</span> train_data <span class="keyword">if</span> item[<span class="string">&#x27;category&#x27;</span>] == category)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  <span class="subst">&#123;category&#125;</span>: <span class="subst">&#123;count&#125;</span> æ¡ (<span class="subst">&#123;count/<span class="built_in">len</span>(train_data):<span class="number">.1</span>%&#125;</span>)&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä¿å­˜æ•°æ®é›†</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;customer_service_train.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(train_data, f, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;customer_service_test.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        json.dump(test_data, f, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> train_data, test_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œæ•°æ®å‡†å¤‡</span></span><br><span class="line">train_data, test_data = prepare_customer_service_dataset(<span class="string">&#x27;raw_customer_service_data.csv&#x27;</span>)</span><br></pre></td></tr></table></figure><p><strong>æ•°æ®å¢å¼ºç­–ç•¥</strong>ï¼š</p><ol><li><strong>åŒä¹‰è¯æ›¿æ¢</strong>ï¼šä½¿ç”¨ç”µå•†é¢†åŸŸè¯å…¸æ›¿æ¢äº§å“åç§°ã€æ”¿ç­–æœ¯è¯­</li><li><strong>é—®é¢˜é‡å†™</strong>ï¼šå°†åŒä¸€é—®é¢˜ç”¨ä¸åŒå¥å¼è¡¨è¾¾ï¼ˆâ€æ€ä¹ˆé€€è´§â€ vs â€œæˆ‘æƒ³é€€è´§ï¼Œæµç¨‹æ˜¯ä»€ä¹ˆâ€ï¼‰</li><li><strong>é”™è¯¯æ¨¡å¼æ³¨å…¥</strong>ï¼šæ¨¡æ‹Ÿç”¨æˆ·å¸¸è§çš„è¡¨è¾¾é”™è¯¯ã€é”™åˆ«å­—</li><li><strong>å¤šè½®å¯¹è¯æ‹†åˆ†</strong>ï¼šå°†é•¿å¯¹è¯æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„QAå¯¹</li></ol><h3 id="2-3-æ¡ˆä¾‹å®æ–½ï¼šQwen-7Bæ¨¡å‹LoRAå¾®è°ƒ"><a href="#2-3-æ¡ˆä¾‹å®æ–½ï¼šQwen-7Bæ¨¡å‹LoRAå¾®è°ƒ" class="headerlink" title="2.3 æ¡ˆä¾‹å®æ–½ï¼šQwen-7Bæ¨¡å‹LoRAå¾®è°ƒ"></a>2.3 æ¡ˆä¾‹å®æ–½ï¼šQwen-7Bæ¨¡å‹LoRAå¾®è°ƒ</h3><h4 id="ç¡¬ä»¶ç¯å¢ƒï¼š"><a href="#ç¡¬ä»¶ç¯å¢ƒï¼š" class="headerlink" title="ç¡¬ä»¶ç¯å¢ƒï¼š"></a><strong>ç¡¬ä»¶ç¯å¢ƒ</strong>ï¼š</h4><ul><li>GPU: NVIDIA A10 (24GB VRAM)</li><li>CPU: AMD EPYC 7763 64-core</li><li>RAM: 128GB</li><li>å­˜å‚¨: NVMe SSD 2TB</li></ul><h4 id="LoRAå‚æ•°é…ç½®ï¼ˆåŸºäºæ¡ˆä¾‹è°ƒä¼˜ï¼‰ï¼š"><a href="#LoRAå‚æ•°é…ç½®ï¼ˆåŸºäºæ¡ˆä¾‹è°ƒä¼˜ï¼‰ï¼š" class="headerlink" title="LoRAå‚æ•°é…ç½®ï¼ˆåŸºäºæ¡ˆä¾‹è°ƒä¼˜ï¼‰ï¼š"></a><strong>LoRAå‚æ•°é…ç½®ï¼ˆåŸºäºæ¡ˆä¾‹è°ƒä¼˜ï¼‰</strong>ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peft <span class="keyword">import</span> LoraConfig, TaskType</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”µå•†å®¢æœåœºæ™¯çš„æœ€ä¼˜LoRAé…ç½®</span></span><br><span class="line">lora_config = LoraConfig(</span><br><span class="line">    r=<span class="number">8</span>,                    <span class="comment"># ç§©(rank)ï¼Œå¹³è¡¡æ€§èƒ½ä¸æ•ˆæœ</span></span><br><span class="line">    lora_alpha=<span class="number">32</span>,          <span class="comment"># ç¼©æ”¾å› å­ï¼Œalpha/r=4ï¼Œæä¾›ç¨³å®šçš„è®­ç»ƒ</span></span><br><span class="line">    target_modules=[</span><br><span class="line">        <span class="string">&quot;q_proj&quot;</span>, <span class="string">&quot;v_proj&quot;</span>, <span class="string">&quot;o_proj&quot;</span>,   <span class="comment"># Attentionå…³é”®æ¨¡å—</span></span><br><span class="line">        <span class="string">&quot;gate_proj&quot;</span>, <span class="string">&quot;up_proj&quot;</span>,         <span class="comment"># FFNå…³é”®æ¨¡å—</span></span><br><span class="line">    ],</span><br><span class="line">    lora_dropout=<span class="number">0.05</span>,      <span class="comment"># è½»å¾®dropouté˜²æ­¢è¿‡æ‹Ÿåˆ</span></span><br><span class="line">    bias=<span class="string">&quot;none&quot;</span>,            <span class="comment"># ä¸è®­ç»ƒåç½®é¡¹ï¼ŒèŠ‚çœå‚æ•°</span></span><br><span class="line">    task_type=TaskType.CAUSAL_LM,</span><br><span class="line">    use_rslora=<span class="literal">True</span>,        <span class="comment"># ä½¿ç”¨ç§©ç¨³å®šLoRAï¼Œ2026å¹´æœ€ä½³å®è·µ</span></span><br><span class="line">    init_lora_weights=<span class="string">&quot;loftq&quot;</span>,  <span class="comment"># LoftQåˆå§‹åŒ–ï¼Œæé«˜è®­ç»ƒç¨³å®šæ€§</span></span><br><span class="line">    modules_to_save=[<span class="string">&quot;embed_tokens&quot;</span>, <span class="string">&quot;lm_head&quot;</span>]  <span class="comment"># ä¿å­˜åµŒå…¥å±‚å’Œè¾“å‡ºå±‚</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡åŒ–é…ç½®ï¼ˆQLoRAï¼‰</span></span><br><span class="line">quantization_config = BitsAndBytesConfig(</span><br><span class="line">    load_in_4bit=<span class="literal">True</span>,</span><br><span class="line">    bnb_4bit_quant_type=<span class="string">&quot;nf4&quot;</span>,          <span class="comment"># Normal Float 4ï¼Œ2026å¹´æ¨è</span></span><br><span class="line">    bnb_4bit_compute_dtype=torch.bfloat16,</span><br><span class="line">    bnb_4bit_use_double_quant=<span class="literal">True</span>,     <span class="comment"># åŒé‡é‡åŒ–ï¼Œè¿›ä¸€æ­¥å‹ç¼©</span></span><br><span class="line">    bnb_4bit_quant_storage=torch.uint8  <span class="comment"># å­˜å‚¨ä¼˜åŒ–</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h4 id="è®­ç»ƒè¿‡ç¨‹ä¸ç›‘æ§ï¼š"><a href="#è®­ç»ƒè¿‡ç¨‹ä¸ç›‘æ§ï¼š" class="headerlink" title="è®­ç»ƒè¿‡ç¨‹ä¸ç›‘æ§ï¼š"></a><strong>è®­ç»ƒè¿‡ç¨‹ä¸ç›‘æ§</strong>ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®­ç»ƒå‚æ•°é…ç½®ï¼ˆç”µå•†å®¢æœåœºæ™¯ï¼‰</span></span><br><span class="line">training_args = TrainingArguments(</span><br><span class="line">    output_dir=<span class="string">&quot;./qwen_ecommerce_lora&quot;</span>,</span><br><span class="line">    per_device_train_batch_size=<span class="number">3</span>,      <span class="comment"># A10ä¸Š4bité‡åŒ–çš„æœ€ä¼˜batch size</span></span><br><span class="line">    gradient_accumulation_steps=<span class="number">6</span>,       <span class="comment"># ç´¯ç§¯æ¢¯åº¦ï¼Œæ¨¡æ‹Ÿbatch_size=18</span></span><br><span class="line">    learning_rate=<span class="number">3e-4</span>,                  <span class="comment"># LoRAæ¨èå­¦ä¹ ç‡</span></span><br><span class="line">    num_train_epochs=<span class="number">4</span>,                  <span class="comment"># ç”µå•†å®¢æœåœºæ™¯çš„æœ€ä½³epochæ•°</span></span><br><span class="line">    logging_steps=<span class="number">50</span>,</span><br><span class="line">    save_strategy=<span class="string">&quot;steps&quot;</span>,</span><br><span class="line">    save_steps=<span class="number">200</span>,</span><br><span class="line">    evaluation_strategy=<span class="string">&quot;steps&quot;</span>,</span><br><span class="line">    eval_steps=<span class="number">200</span>,</span><br><span class="line">    fp16=<span class="literal">True</span>,</span><br><span class="line">    optim=<span class="string">&quot;paged_adamw_8bit&quot;</span>,            <span class="comment"># 8-bitä¼˜åŒ–å™¨ï¼ŒèŠ‚çœå†…å­˜</span></span><br><span class="line">    lr_scheduler_type=<span class="string">&quot;cosine_with_restarts&quot;</span>,  <span class="comment"># ä½™å¼¦é€€ç«å¸¦é‡å¯</span></span><br><span class="line">    warmup_ratio=<span class="number">0.1</span>,</span><br><span class="line">    weight_decay=<span class="number">0.01</span>,</span><br><span class="line">    report_to=<span class="string">&quot;wandb&quot;</span>,</span><br><span class="line">    run_name=<span class="string">&quot;ecommerce-customer-service-v2&quot;</span>,</span><br><span class="line">    load_best_model_at_end=<span class="literal">True</span>,</span><br><span class="line">    metric_for_best_model=<span class="string">&quot;eval_loss&quot;</span>,</span><br><span class="line">    greater_is_better=<span class="literal">False</span>,</span><br><span class="line">    gradient_checkpointing=<span class="literal">True</span>,</span><br><span class="line">    gradient_checkpointing_kwargs=&#123;<span class="string">&quot;use_reentrant&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">    dataloader_num_workers=<span class="number">8</span>,</span><br><span class="line">    remove_unused_columns=<span class="literal">False</span>,</span><br><span class="line">    <span class="comment"># 2026å¹´æ–°å¢ï¼šè‡ªåŠ¨æ··åˆç²¾åº¦å’Œå†…å­˜ä¼˜åŒ–</span></span><br><span class="line">    bf16_full_eval=<span class="literal">True</span>,</span><br><span class="line">    tf32=<span class="literal">True</span>,</span><br><span class="line">    torch_compile=<span class="literal">True</span>,                  <span class="comment"># PyTorch 2.3+çš„ç¼–è¯‘ä¼˜åŒ–</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®­ç»ƒè¿‡ç¨‹ç›‘æ§æŒ‡æ ‡</span></span><br><span class="line">monitoring_metrics = &#123;</span><br><span class="line">    <span class="string">&quot;train_loss&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;eval_loss&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;learning_rate&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;grad_norm&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;memory_usage&quot;</span>: [],</span><br><span class="line">    <span class="string">&quot;throughput&quot;</span>: []  <span class="comment"># tokens/second</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®­ç»ƒå›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomCallback</span>(<span class="title class_ inherited__">TrainerCallback</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_log</span>(<span class="params">self, args, state, control, logs=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> logs <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># è®°å½•å…³é”®æŒ‡æ ‡</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;loss&#x27;</span> <span class="keyword">in</span> logs:</span><br><span class="line">                monitoring_metrics[<span class="string">&#x27;train_loss&#x27;</span>].append(logs[<span class="string">&#x27;loss&#x27;</span>])</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;eval_loss&#x27;</span> <span class="keyword">in</span> logs:</span><br><span class="line">                monitoring_metrics[<span class="string">&#x27;eval_loss&#x27;</span>].append(logs[<span class="string">&#x27;eval_loss&#x27;</span>])</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;learning_rate&#x27;</span> <span class="keyword">in</span> logs:</span><br><span class="line">                monitoring_metrics[<span class="string">&#x27;learning_rate&#x27;</span>].append(logs[<span class="string">&#x27;learning_rate&#x27;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ‰“å°å®æ—¶è¿›åº¦</span></span><br><span class="line">            epoch = state.epoch</span><br><span class="line">            step = state.global_step</span><br><span class="line">            <span class="keyword">if</span> step % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Epoch <span class="subst">&#123;epoch:<span class="number">.1</span>f&#125;</span>, Step <span class="subst">&#123;step&#125;</span>: Loss=<span class="subst">&#123;logs.get(<span class="string">&#x27;loss&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>):<span class="number">.4</span>f&#125;</span>, LR=<span class="subst">&#123;logs.get(<span class="string">&#x27;learning_rate&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>):<span class="number">.6</span>f&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="è®­ç»ƒç»“æœåˆ†æï¼š"><a href="#è®­ç»ƒç»“æœåˆ†æï¼š" class="headerlink" title="è®­ç»ƒç»“æœåˆ†æï¼š"></a><strong>è®­ç»ƒç»“æœåˆ†æ</strong>ï¼š</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">è®­ç»ƒç»Ÿè®¡:</span><br><span class="line">- æ€»è®­ç»ƒæ—¶é—´: 5å°æ—¶23åˆ†é’Ÿ</span><br><span class="line">- æ€»è®­ç»ƒæ ·æœ¬: 102,000æ¡</span><br><span class="line">- å¹³å‡è®­ç»ƒé€Ÿåº¦: 1,850 tokens/ç§’</span><br><span class="line">- æ˜¾å­˜å³°å€¼ä½¿ç”¨: 21.3GB (A10 24GB)</span><br><span class="line">- æœ€ç»ˆè®­ç»ƒæŸå¤±: 0.89</span><br><span class="line">- æœ€ç»ˆéªŒè¯æŸå¤±: 1.12</span><br><span class="line"></span><br><span class="line">æ”¶æ•›åˆ†æ:</span><br><span class="line">- ç¬¬1ä¸ªepochå: éªŒè¯æŸå¤±ä»3.45é™è‡³1.89</span><br><span class="line">- ç¬¬2ä¸ªepochå: éªŒè¯æŸå¤±ç¨³å®šåœ¨1.25å·¦å³</span><br><span class="line">- ç¬¬3-4ä¸ªepoch: éªŒè¯æŸå¤±è½»å¾®æ³¢åŠ¨ï¼Œ1.15-1.20</span><br><span class="line">- æ—©åœè§¦å‘: ç¬¬4ä¸ªepochåéªŒè¯æŸå¤±ä¸å†æ˜¾è‘—ä¸‹é™</span><br><span class="line"></span><br><span class="line">ç±»åˆ«æ€§èƒ½åˆ†æ (éªŒè¯é›†):</span><br><span class="line">- è®¢å•æŸ¥è¯¢: å‡†ç¡®ç‡ 92.3%, F1=0.91</span><br><span class="line">- ç‰©æµè·Ÿè¸ª: å‡†ç¡®ç‡ 94.1%, F1=0.93  </span><br><span class="line">- é€€æ¢è´§æ”¿ç­–: å‡†ç¡®ç‡ 88.7%, F1=0.87</span><br><span class="line">- äº§å“å’¨è¯¢: å‡†ç¡®ç‡ 85.2%, F1=0.83</span><br><span class="line">- æŠ•è¯‰å»ºè®®: å‡†ç¡®ç‡ 79.5%, F1=0.76</span><br><span class="line"></span><br><span class="line">å…³é”®å‘ç°:</span><br><span class="line">1. ç®€å•äº‹å®æ€§é—®é¢˜ï¼ˆè®¢å•ã€ç‰©æµï¼‰è¡¨ç°æœ€ä½³</span><br><span class="line">2. æ”¿ç­–ç±»é—®é¢˜éœ€è¦æ›´å¤šé¢†åŸŸæ•°æ®</span><br><span class="line">3. æƒ…æ„ŸåŒ–é—®é¢˜ï¼ˆæŠ•è¯‰ï¼‰ä»ç„¶æ˜¯æŒ‘æˆ˜</span><br><span class="line">4. LoRAæ˜¾è‘—ä¼˜äºå…¨å‚æ•°å¾®è°ƒçš„åŸºçº¿ï¼ˆ+3.2% F1ï¼‰</span><br></pre></td></tr></table></figure><h3 id="2-4-æ¡ˆä¾‹æ•ˆæœå¯¹æ¯”ï¼šLoRA-vs-å…¨å‚æ•°å¾®è°ƒ-vs-Zero-shot"><a href="#2-4-æ¡ˆä¾‹æ•ˆæœå¯¹æ¯”ï¼šLoRA-vs-å…¨å‚æ•°å¾®è°ƒ-vs-Zero-shot" class="headerlink" title="2.4 æ¡ˆä¾‹æ•ˆæœå¯¹æ¯”ï¼šLoRA vs å…¨å‚æ•°å¾®è°ƒ vs Zero-shot"></a>2.4 æ¡ˆä¾‹æ•ˆæœå¯¹æ¯”ï¼šLoRA vs å…¨å‚æ•°å¾®è°ƒ vs Zero-shot</h3><table><thead><tr><th>æŒ‡æ ‡</th><th>LoRA (r&#x3D;8)</th><th>å…¨å‚æ•°å¾®è°ƒ</th><th>Zero-shot Qwen</th><th>äººå·¥å®¢æœ</th></tr></thead><tbody><tr><td><strong>å‡†ç¡®ç‡</strong></td><td>89.7%</td><td>91.2%</td><td>76.3%</td><td>95.8%</td></tr><tr><td><strong>F1åˆ†æ•°</strong></td><td>0.88</td><td>0.90</td><td>0.72</td><td>0.94</td></tr><tr><td><strong>è®­ç»ƒæ—¶é—´</strong></td><td>5.4å°æ—¶</td><td>28.6å°æ—¶</td><td>-</td><td>-</td></tr><tr><td><strong>GPUæ˜¾å­˜</strong></td><td>21.3GB</td><td>48.2GB</td><td>-</td><td>-</td></tr><tr><td><strong>è®­ç»ƒæˆæœ¬</strong></td><td>$18.5</td><td>$114.2</td><td>$0</td><td>-</td></tr><tr><td><strong>å“åº”æ—¶é—´</strong></td><td>1.8ç§’</td><td>1.9ç§’</td><td>1.2ç§’</td><td>45ç§’</td></tr><tr><td><strong>å¯éƒ¨ç½²æ€§</strong></td><td>é«˜ (åˆå¹¶åå•æ–‡ä»¶)</td><td>ä¸­ (å¤§æ–‡ä»¶)</td><td>é«˜</td><td>ä½</td></tr></tbody></table><p><strong>æˆæœ¬æ•ˆç›Šåˆ†æ</strong>ï¼š</p><ul><li><strong>äººåŠ›æˆæœ¬èŠ‚çœ</strong>ï¼šå•å®¢æœæ—¥å‡å¤„ç†200ä¸ªé—®é¢˜ï¼ŒAIå®¢æœå¯å¤„ç†5,000+ï¼Œç›¸å½“äº25äººå›¢é˜Ÿ</li><li><strong>ROIè®¡ç®—</strong>ï¼šè®­ç»ƒæˆæœ¬$18.5ï¼Œå•æ—¥èŠ‚çœäººåŠ›æˆæœ¬$5,000ï¼ŒæŠ•èµ„å›æ”¶æœŸ&lt;1å°æ—¶</li><li><strong>è´¨é‡æå‡</strong>ï¼šç›¸æ¯”Zero-shotï¼Œå‡†ç¡®ç‡æå‡13.4%ï¼Œç”¨æˆ·æ»¡æ„åº¦æå‡22%</li></ul><h3 id="2-5-å®é™…éƒ¨ç½²ä¸ä¸šåŠ¡å½±å“"><a href="#2-5-å®é™…éƒ¨ç½²ä¸ä¸šåŠ¡å½±å“" class="headerlink" title="2.5 å®é™…éƒ¨ç½²ä¸ä¸šåŠ¡å½±å“"></a>2.5 å®é™…éƒ¨ç½²ä¸ä¸šåŠ¡å½±å“</h3><h4 id="éƒ¨ç½²æ¶æ„ï¼š"><a href="#éƒ¨ç½²æ¶æ„ï¼š" class="headerlink" title="éƒ¨ç½²æ¶æ„ï¼š"></a><strong>éƒ¨ç½²æ¶æ„</strong>ï¼š</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·ç«¯ â†’ APIç½‘å…³ (Nginx) â†’ Golangæ¨ç†æœåŠ¡ â†’ Qwen-7B+LoRAæ¨¡å‹</span><br><span class="line">       â†“</span><br><span class="line">ç›‘æ§ç³»ç»Ÿ â†’ Prometheus/Grafana</span><br><span class="line">å‘Šè­¦ç³»ç»Ÿ â†’ ä¼ä¸šå¾®ä¿¡/é‚®ä»¶</span><br><span class="line">æ—¥å¿—åˆ†æ â†’ ELK Stack</span><br></pre></td></tr></table></figure><h4 id="æ€§èƒ½è¡¨ç°ï¼š"><a href="#æ€§èƒ½è¡¨ç°ï¼š" class="headerlink" title="æ€§èƒ½è¡¨ç°ï¼š"></a><strong>æ€§èƒ½è¡¨ç°</strong>ï¼š</h4><ul><li><strong>QPS</strong>ï¼šå•A10 GPUæ”¯æŒ42 QPSï¼ˆå¹³å‡å“åº”æ—¶é—´1.8ç§’ï¼‰</li><li><strong>å¯ç”¨æ€§</strong>ï¼š99.95%ï¼ˆ30å¤©å†…ä»…2æ¬¡æœåŠ¡ä¸­æ–­ï¼Œæ€»æ—¶é•¿8åˆ†é’Ÿï¼‰</li><li><strong>èµ„æºåˆ©ç”¨ç‡</strong>ï¼šGPUå¹³å‡åˆ©ç”¨ç‡65%ï¼Œå†…å­˜å ç”¨18GB</li></ul><h4 id="ä¸šåŠ¡æŒ‡æ ‡æå‡ï¼š"><a href="#ä¸šåŠ¡æŒ‡æ ‡æå‡ï¼š" class="headerlink" title="ä¸šåŠ¡æŒ‡æ ‡æå‡ï¼š"></a><strong>ä¸šåŠ¡æŒ‡æ ‡æå‡</strong>ï¼š</h4><ul><li><strong>é¦–æ¬¡å“åº”æ—¶é—´</strong>ï¼šä»45ç§’é™è‡³1.8ç§’ï¼ˆ-96%ï¼‰</li><li><strong>é—®é¢˜è§£å†³ç‡</strong>ï¼šä»78%æå‡è‡³89.7%ï¼ˆ+11.7%ï¼‰</li><li><strong>äººå·¥è½¬æ¥ç‡</strong>ï¼šä»100%é™è‡³32%ï¼ˆ-68%ï¼‰</li><li><strong>ç”¨æˆ·æ»¡æ„åº¦</strong>ï¼šä»4.1&#x2F;5.0æå‡è‡³4.7&#x2F;5.0ï¼ˆ+14.6%ï¼‰</li><li><strong>è¿è¥æˆæœ¬</strong>ï¼šå•å®¢æœæˆæœ¬ä»Â¥200&#x2F;å°æ—¶é™è‡³Â¥35&#x2F;å°æ—¶ï¼ˆ-82.5%ï¼‰</li></ul><h4 id="æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆï¼š"><a href="#æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆï¼š" class="headerlink" title="æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆï¼š"></a><strong>æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ</strong>ï¼š</h4><ol><li><p><strong>æŒ‘æˆ˜</strong>ï¼šæ”¿ç­–æ›´æ–°é¢‘ç¹ï¼Œæ¨¡å‹çŸ¥è¯†æ»å<br><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šå»ºç«‹RAGæœºåˆ¶ï¼Œå®æ—¶æ£€ç´¢æœ€æ–°æ”¿ç­–æ–‡æ¡£</p></li><li><p><strong>æŒ‘æˆ˜</strong>ï¼šå¤æ‚é—®é¢˜å¤„ç†èƒ½åŠ›ä¸è¶³<br><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šç½®ä¿¡åº¦é˜ˆå€¼+äººå·¥è½¬æ¥ï¼Œç½®ä¿¡åº¦&lt;0.7æ—¶è½¬äººå·¥</p></li><li><p><strong>æŒ‘æˆ˜</strong>ï¼šå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ä¸¢å¤±<br><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä¼˜åŒ–å¯¹è¯çŠ¶æ€è·Ÿè¸ªï¼Œæœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦æ‰©å±•åˆ°2048 tokens</p></li><li><p><strong>æŒ‘æˆ˜</strong>ï¼šæ–°å•†å“ä¸Šæ¶åé—®ç­”å‡†ç¡®ç‡ä¸‹é™<br><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šæ¯å‘¨å¢é‡è®­ç»ƒï¼Œä»…ç”¨æ–°å•†å“æ•°æ®å¾®è°ƒLoRAé€‚é…å™¨</p></li></ol><h2 id="ä¸‰ã€æ•°æ®å‡†å¤‡ã€é¢„è®­ç»ƒã€æ¨¡å‹é‡åŒ–ã€å‘å¸ƒä¸Šçº¿å®Œæ•´æµç¨‹"><a href="#ä¸‰ã€æ•°æ®å‡†å¤‡ã€é¢„è®­ç»ƒã€æ¨¡å‹é‡åŒ–ã€å‘å¸ƒä¸Šçº¿å®Œæ•´æµç¨‹" class="headerlink" title="ä¸‰ã€æ•°æ®å‡†å¤‡ã€é¢„è®­ç»ƒã€æ¨¡å‹é‡åŒ–ã€å‘å¸ƒä¸Šçº¿å®Œæ•´æµç¨‹"></a>ä¸‰ã€æ•°æ®å‡†å¤‡ã€é¢„è®­ç»ƒã€æ¨¡å‹é‡åŒ–ã€å‘å¸ƒä¸Šçº¿å®Œæ•´æµç¨‹</h2><h3 id="3-1-æ•°æ®å‡†å¤‡ï¼ˆç”µå•†å®¢æœæ¡ˆä¾‹ç»­ï¼‰"><a href="#3-1-æ•°æ®å‡†å¤‡ï¼ˆç”µå•†å®¢æœæ¡ˆä¾‹ç»­ï¼‰" class="headerlink" title="3.1 æ•°æ®å‡†å¤‡ï¼ˆç”µå•†å®¢æœæ¡ˆä¾‹ç»­ï¼‰"></a>3.1 æ•°æ®å‡†å¤‡ï¼ˆç”µå•†å®¢æœæ¡ˆä¾‹ç»­ï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">advanced_data_augmentation</span>(<span class="params">train_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    é«˜çº§æ•°æ®å¢å¼ºç­–ç•¥ï¼Œä¸“é—¨é’ˆå¯¹å®¢æœåœºæ™¯</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    augmented_data = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŒä¹‰è¯è¯å…¸ï¼ˆç”µå•†é¢†åŸŸï¼‰</span></span><br><span class="line">    synonym_dict = &#123;</span><br><span class="line">        <span class="string">&quot;é€€è´§&quot;</span>: [<span class="string">&quot;é€€æ¢è´§&quot;</span>, <span class="string">&quot;é€€æ‰&quot;</span>, <span class="string">&quot;æƒ³é€€&quot;</span>, <span class="string">&quot;é€€äº†&quot;</span>],</span><br><span class="line">        <span class="string">&quot;å‘è´§&quot;</span>: [<span class="string">&quot;å‘å‡º&quot;</span>, <span class="string">&quot;å¯„å‡º&quot;</span>, <span class="string">&quot;æ´¾é€&quot;</span>, <span class="string">&quot;å¼€å§‹è¿é€&quot;</span>],</span><br><span class="line">        <span class="string">&quot;ç‰©æµ&quot;</span>: [<span class="string">&quot;å¿«é€’&quot;</span>, <span class="string">&quot;é…é€&quot;</span>, <span class="string">&quot;è¿è¾“çŠ¶æ€&quot;</span>, <span class="string">&quot;åŒ…è£¹ä½ç½®&quot;</span>],</span><br><span class="line">        <span class="string">&quot;ä»·æ ¼&quot;</span>: [<span class="string">&quot;å”®ä»·&quot;</span>, <span class="string">&quot;å¤šå°‘é’±&quot;</span>, <span class="string">&quot;è´¹ç”¨&quot;</span>, <span class="string">&quot;æ ‡ä»·&quot;</span>],</span><br><span class="line">        <span class="string">&quot;ä¼˜æƒ åˆ¸&quot;</span>: [<span class="string">&quot;æŠ˜æ‰£åˆ¸&quot;</span>, <span class="string">&quot;ä¼˜æƒ ç &quot;</span>, <span class="string">&quot;ä»£é‡‘åˆ¸&quot;</span>, <span class="string">&quot;çº¢åŒ…&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æƒ…æ„Ÿå¢å¼º</span></span><br><span class="line">    sentiment_patterns = [</span><br><span class="line">        <span class="string">&quot;æˆ‘çœŸçš„å¾ˆç€æ€¥ï¼Œ&#123;query&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;è¿™ä¸ªé—®é¢˜å·²ç»å›°æ‰°æˆ‘å¾ˆä¹…äº†ï¼Œ&#123;query&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;è¯·å°½å¿«å¸®æˆ‘è§£å†³ï¼Œ&#123;query&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æˆ‘å¯¹è¿™ä¸ªæœåŠ¡å¾ˆä¸æ»¡æ„ï¼Œ&#123;query&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æ„Ÿè°¢ä½ ä»¬çš„å¸®åŠ©ï¼Œ&#123;query&#125;&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> sample <span class="keyword">in</span> train_data:</span><br><span class="line">        <span class="comment"># åŸå§‹æ ·æœ¬</span></span><br><span class="line">        augmented_data.append(sample.copy())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŒä¹‰è¯æ›¿æ¢å¢å¼º</span></span><br><span class="line">        <span class="keyword">for</span> original, synonyms <span class="keyword">in</span> synonym_dict.items():</span><br><span class="line">            <span class="keyword">if</span> original <span class="keyword">in</span> sample[<span class="string">&#x27;input&#x27;</span>]:</span><br><span class="line">                <span class="keyword">for</span> synonym <span class="keyword">in</span> synonyms:</span><br><span class="line">                    new_sample = sample.copy()</span><br><span class="line">                    new_sample[<span class="string">&#x27;input&#x27;</span>] = new_sample[<span class="string">&#x27;input&#x27;</span>].replace(original, synonym)</span><br><span class="line">                    new_sample[<span class="string">&#x27;augmentation_type&#x27;</span>] = <span class="string">&#x27;synonym_replacement&#x27;</span></span><br><span class="line">                    augmented_data.append(new_sample)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æƒ…æ„Ÿæ¨¡å¼å¢å¼º</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(sample[<span class="string">&#x27;input&#x27;</span>]) &lt; <span class="number">100</span>:  <span class="comment"># åªå¯¹è¾ƒçŸ­çš„é—®é¢˜å¢å¼º</span></span><br><span class="line">            <span class="keyword">for</span> pattern <span class="keyword">in</span> sentiment_patterns:</span><br><span class="line">                new_sample = sample.copy()</span><br><span class="line">                new_sample[<span class="string">&#x27;input&#x27;</span>] = pattern.<span class="built_in">format</span>(query=sample[<span class="string">&#x27;input&#x27;</span>])</span><br><span class="line">                new_sample[<span class="string">&#x27;augmentation_type&#x27;</span>] = <span class="string">&#x27;sentiment_enhancement&#x27;</span></span><br><span class="line">                augmented_data.append(new_sample)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;åŸå§‹æ•°æ®: <span class="subst">&#123;<span class="built_in">len</span>(train_data)&#125;</span> æ¡ï¼Œå¢å¼ºå: <span class="subst">&#123;<span class="built_in">len</span>(augmented_data)&#125;</span> æ¡&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> augmented_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># åº”ç”¨æ•°æ®å¢å¼º</span></span><br><span class="line">train_data_augmented = advanced_data_augmentation(train_data)</span><br></pre></td></tr></table></figure><h3 id="3-2-é¢„è®­ç»ƒä¸LoRAå¾®è°ƒ"><a href="#3-2-é¢„è®­ç»ƒä¸LoRAå¾®è°ƒ" class="headerlink" title="3.2 é¢„è®­ç»ƒä¸LoRAå¾®è°ƒ"></a>3.2 é¢„è®­ç»ƒä¸LoRAå¾®è°ƒ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_lora_model</span>(<span class="params">train_data, eval_data, model_name=<span class="string">&quot;Qwen/Qwen1.5-7B-Chat&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å®Œæ•´çš„LoRAè®­ç»ƒæµç¨‹</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å¼€å§‹LoRAå¾®è°ƒè®­ç»ƒ...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. åŠ è½½tokenizerå’Œæ¨¡å‹</span></span><br><span class="line">    tokenizer = AutoTokenizer.from_pretrained(model_name)</span><br><span class="line">    tokenizer.pad_token = tokenizer.eos_token</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. åˆ›å»ºæ•°æ®é›†</span></span><br><span class="line">    train_dataset = Dataset.from_list(train_data)</span><br><span class="line">    eval_dataset = Dataset.from_list(eval_data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. æ•°æ®æ ¼å¼åŒ–å‡½æ•°</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">format_prompts</span>(<span class="params">examples</span>):</span><br><span class="line">        texts = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(examples[<span class="string">&#x27;instruction&#x27;</span>])):</span><br><span class="line">            text = <span class="string">f&quot;&quot;&quot;### ç³»ç»ŸæŒ‡ä»¤:</span></span><br><span class="line"><span class="string"><span class="subst">&#123;examples[<span class="string">&#x27;instruction&#x27;</span>][i]&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### ç”¨æˆ·è¾“å…¥:</span></span><br><span class="line"><span class="string"><span class="subst">&#123;examples[<span class="string">&#x27;input&#x27;</span>][i]&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### åŠ©æ‰‹å›ç­”:</span></span><br><span class="line"><span class="string"><span class="subst">&#123;examples[<span class="string">&#x27;output&#x27;</span>][i]&#125;</span>&quot;&quot;&quot;</span></span><br><span class="line">            texts.append(text)</span><br><span class="line">        <span class="keyword">return</span> tokenizer(texts, padding=<span class="string">&#x27;max_length&#x27;</span>, truncation=<span class="literal">True</span>, max_length=<span class="number">1024</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. æ˜ å°„æ•°æ®é›†</span></span><br><span class="line">    train_dataset = train_dataset.<span class="built_in">map</span>(format_prompts, batched=<span class="literal">True</span>)</span><br><span class="line">    eval_dataset = eval_dataset.<span class="built_in">map</span>(format_prompts, batched=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 5. åŠ è½½4-bité‡åŒ–æ¨¡å‹</span></span><br><span class="line">    model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">        model_name,</span><br><span class="line">        quantization_config=quantization_config,</span><br><span class="line">        device_map=<span class="string">&quot;auto&quot;</span>,</span><br><span class="line">        trust_remote_code=<span class="literal">True</span>,</span><br><span class="line">        attn_implementation=<span class="string">&quot;flash_attention_2&quot;</span>  <span class="comment"># 2026å¹´æ¨è</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 6. åº”ç”¨LoRA</span></span><br><span class="line">    model = get_peft_model(model, lora_config)</span><br><span class="line">    model.print_trainable_parameters()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 7. åˆ›å»ºTrainer</span></span><br><span class="line">    trainer = Trainer(</span><br><span class="line">        model=model,</span><br><span class="line">        args=training_args,</span><br><span class="line">        train_dataset=train_dataset,</span><br><span class="line">        eval_dataset=eval_dataset,</span><br><span class="line">        callbacks=[CustomCallback()]</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 8. å¼€å§‹è®­ç»ƒ</span></span><br><span class="line">    train_result = trainer.train()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 9. ä¿å­˜æ¨¡å‹</span></span><br><span class="line">    model.save_pretrained(<span class="string">&quot;./qwen_ecommerce_lora_final&quot;</span>)</span><br><span class="line">    tokenizer.save_pretrained(<span class="string">&quot;./qwen_ecommerce_lora_final&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 10. åˆå¹¶LoRAæƒé‡</span></span><br><span class="line">    merged_model = model.merge_and_unload()</span><br><span class="line">    merged_model.save_pretrained(<span class="string">&quot;./qwen_ecommerce_merged&quot;</span>)</span><br><span class="line">    tokenizer.save_pretrained(<span class="string">&quot;./qwen_ecommerce_merged&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;è®­ç»ƒå’Œåˆå¹¶å®Œæˆï¼&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> trainer, merged_model, tokenizer</span><br></pre></td></tr></table></figure><h3 id="3-3-æ¨¡å‹é‡åŒ–ä¸ä¼˜åŒ–"><a href="#3-3-æ¨¡å‹é‡åŒ–ä¸ä¼˜åŒ–" class="headerlink" title="3.3 æ¨¡å‹é‡åŒ–ä¸ä¼˜åŒ–"></a>3.3 æ¨¡å‹é‡åŒ–ä¸ä¼˜åŒ–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">optimize_model_for_deployment</span>(<span class="params">model_path, output_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ¨¡å‹ä¼˜åŒ–ï¼šé‡åŒ–ã€ç¼–è¯‘ã€æœåŠ¡åŒ–</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å¼€å§‹æ¨¡å‹ä¼˜åŒ–...&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. åŠ è½½åˆå¹¶åçš„æ¨¡å‹</span></span><br><span class="line">    model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">        model_path,</span><br><span class="line">        torch_dtype=torch.float16,</span><br><span class="line">        device_map=<span class="string">&quot;auto&quot;</span></span><br><span class="line">    )</span><br><span class="line">    tokenizer = AutoTokenizer.from_pretrained(model_path)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. åº”ç”¨AWQé‡åŒ–ï¼ˆ2026å¹´æœ€æ–°ï¼‰</span></span><br><span class="line">    <span class="keyword">from</span> awq <span class="keyword">import</span> AutoAWQForCausalLM</span><br><span class="line">    </span><br><span class="line">    quant_config = &#123;</span><br><span class="line">        <span class="string">&quot;zero_point&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&quot;q_group_size&quot;</span>: <span class="number">128</span>,</span><br><span class="line">        <span class="string">&quot;w_bit&quot;</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">&quot;version&quot;</span>: <span class="string">&quot;GEMM&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    awq_model = AutoAWQForCausalLM.from_pretrained(model_path, **quant_config)</span><br><span class="line">    awq_model.quantize(tokenizer, quant_config=quant_config)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. ä¿å­˜é‡åŒ–æ¨¡å‹</span></span><br><span class="line">    awq_model.save_quantized(output_path)</span><br><span class="line">    tokenizer.save_pretrained(output_path)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. Torchç¼–è¯‘ä¼˜åŒ–</span></span><br><span class="line">    model = torch.<span class="built_in">compile</span>(model, mode=<span class="string">&quot;max-autotune&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 5. æ€§èƒ½åŸºå‡†æµ‹è¯•</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">benchmark_inference</span>(<span class="params">model, tokenizer</span>):</span><br><span class="line">        test_prompts = [</span><br><span class="line">            <span class="string">&quot;æˆ‘çš„è®¢å•123456ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ&quot;</span>,</span><br><span class="line">            <span class="string">&quot;æ€ä¹ˆç”³è¯·é€€è´§ï¼Ÿ&quot;</span>,</span><br><span class="line">            <span class="string">&quot;è¿™ä¸ªå•†å“æœ‰ä¼˜æƒ åˆ¸å—ï¼Ÿ&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> prompt <span class="keyword">in</span> test_prompts:</span><br><span class="line">            inputs = tokenizer(prompt, return_tensors=<span class="string">&quot;pt&quot;</span>).to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            start_time = time.time()</span><br><span class="line">            <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">                outputs = model.generate(**inputs, max_new_tokens=<span class="number">128</span>)</span><br><span class="line">            end_time = time.time()</span><br><span class="line">            </span><br><span class="line">            response = tokenizer.decode(outputs[<span class="number">0</span>], skip_special_tokens=<span class="literal">True</span>)</span><br><span class="line">            latency = end_time - start_time</span><br><span class="line">            </span><br><span class="line">            results.append(&#123;</span><br><span class="line">                <span class="string">&quot;prompt&quot;</span>: prompt,</span><br><span class="line">                <span class="string">&quot;response&quot;</span>: response,</span><br><span class="line">                <span class="string">&quot;latency&quot;</span>: latency,</span><br><span class="line">                <span class="string">&quot;tokens_per_second&quot;</span>: <span class="built_in">len</span>(outputs[<span class="number">0</span>]) / latency</span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    </span><br><span class="line">    benchmark_results = benchmark_inference(model, tokenizer)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> benchmark_results:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Prompt: <span class="subst">&#123;result[<span class="string">&#x27;prompt&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Latency: <span class="subst">&#123;result[<span class="string">&#x27;latency&#x27;</span>]:<span class="number">.3</span>f&#125;</span>s, Speed: <span class="subst">&#123;result[<span class="string">&#x27;tokens_per_second&#x27;</span>]:<span class="number">.1</span>f&#125;</span> tokens/s&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ä¼˜åŒ–å®Œæˆï¼é‡åŒ–æ¨¡å‹ä¿å­˜è‡³: <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> awq_model, tokenizer, benchmark_results</span><br></pre></td></tr></table></figure><h3 id="3-4-å‘å¸ƒä¸Šçº¿ä¸ç›‘æ§"><a href="#3-4-å‘å¸ƒä¸Šçº¿ä¸ç›‘æ§" class="headerlink" title="3.4 å‘å¸ƒä¸Šçº¿ä¸ç›‘æ§"></a>3.4 å‘å¸ƒä¸Šçº¿ä¸ç›‘æ§</h3><h4 id="Dockeréƒ¨ç½²é…ç½®ï¼š"><a href="#Dockeréƒ¨ç½²é…ç½®ï¼š" class="headerlink" title="Dockeréƒ¨ç½²é…ç½®ï¼š"></a><strong>Dockeréƒ¨ç½²é…ç½®</strong>ï¼š</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> nvcr.io/nvidia/pytorch:<span class="number">24.09</span>-py3</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ç³»ç»Ÿä¾èµ–</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    libgl1 \</span></span><br><span class="line"><span class="language-bash">    libsm6 \</span></span><br><span class="line"><span class="language-bash">    libxrender1 \</span></span><br><span class="line"><span class="language-bash">    libxext6 \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…Pythonä¾èµ–</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --upgrade pip &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip install -r requirements.txt &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip install flash-attn --no-build-isolation</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶åº”ç”¨ä»£ç </span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡å‹æ–‡ä»¶ï¼ˆæŒ‚è½½å·ï¼‰</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /app/models</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> MODEL_PATH=/app/models/qwen_ecommerce_quantized</span><br><span class="line"><span class="keyword">ENV</span> PORT=<span class="number">8000</span></span><br><span class="line"><span class="keyword">ENV</span> WORKERS=<span class="number">4</span></span><br><span class="line"><span class="keyword">ENV</span> LOG_LEVEL=info</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨å‘½ä»¤</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;gunicorn&quot;</span>, <span class="string">&quot;-w&quot;</span>, <span class="string">&quot;<span class="variable">$WORKERS</span>&quot;</span>, <span class="string">&quot;-k&quot;</span>, <span class="string">&quot;uvicorn.workers.UvicornWorker&quot;</span>, \</span></span><br><span class="line"><span class="language-bash">     <span class="string">&quot;--bind&quot;</span>, <span class="string">&quot;0.0.0.0:<span class="variable">$PORT</span>&quot;</span>, <span class="string">&quot;app.main:app&quot;</span>, \</span></span><br><span class="line"><span class="language-bash">     <span class="string">&quot;--timeout&quot;</span>, <span class="string">&quot;120&quot;</span>, <span class="string">&quot;--keep-alive&quot;</span>, <span class="string">&quot;10&quot;</span>]</span></span><br></pre></td></tr></table></figure><h4 id="Kuberneteséƒ¨ç½²é…ç½®ï¼š"><a href="#Kuberneteséƒ¨ç½²é…ç½®ï¼š" class="headerlink" title="Kuberneteséƒ¨ç½²é…ç½®ï¼š"></a><strong>Kuberneteséƒ¨ç½²é…ç½®</strong>ï¼š</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">customer-service-api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">customer-service-api</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">customer-service-api</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.example.com/customer-service-api:v1.2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">32Gi</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">8</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">24Gi</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">4</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MODEL_PATH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;/models/qwen_ecommerce_quantized&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;redis-service&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">model-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/models</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">model-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">customer-service-models</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">customer-service-api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">customer-service-api</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">customer-service-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-read-timeout:</span> <span class="string">&quot;120&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-send-timeout:</span> <span class="string">&quot;120&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.customerservice.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/api/v1</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">customer-service-api</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><h4 id="ç›‘æ§ä¸å‘Šè­¦é…ç½®ï¼š"><a href="#ç›‘æ§ä¸å‘Šè­¦é…ç½®ï¼š" class="headerlink" title="ç›‘æ§ä¸å‘Šè­¦é…ç½®ï¼š"></a><strong>ç›‘æ§ä¸å‘Šè­¦é…ç½®</strong>ï¼š</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># monitoring.py</span></span><br><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> Counter, Histogram, Gauge, start_http_server</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ç›‘æ§æŒ‡æ ‡</span></span><br><span class="line">REQUEST_COUNT = Counter(<span class="string">&#x27;customer_service_requests_total&#x27;</span>, <span class="string">&#x27;Total customer service requests&#x27;</span>, [<span class="string">&#x27;endpoint&#x27;</span>, <span class="string">&#x27;status_code&#x27;</span>])</span><br><span class="line">RESPONSE_TIME = Histogram(<span class="string">&#x27;customer_service_response_seconds&#x27;</span>, <span class="string">&#x27;Response time in seconds&#x27;</span>, [<span class="string">&#x27;endpoint&#x27;</span>])</span><br><span class="line">CONFIDENCE_SCORE = Histogram(<span class="string">&#x27;customer_service_confidence&#x27;</span>, <span class="string">&#x27;Response confidence scores&#x27;</span>, [<span class="string">&#x27;category&#x27;</span>])</span><br><span class="line">GPU_UTILIZATION = Gauge(<span class="string">&#x27;gpu_utilization_percent&#x27;</span>, <span class="string">&#x27;GPU utilization percentage&#x27;</span>)</span><br><span class="line">MEMORY_USAGE = Gauge(<span class="string">&#x27;memory_usage_gb&#x27;</span>, <span class="string">&#x27;Memory usage in GB&#x27;</span>)</span><br><span class="line">ACTIVE_SESSIONS = Gauge(<span class="string">&#x27;active_sessions&#x27;</span>, <span class="string">&#x27;Number of active chat sessions&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è£…é¥°å™¨ç”¨äºè‡ªåŠ¨ç›‘æ§</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">monitor_endpoint</span>(<span class="params">endpoint_name</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">        @wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result = func(*args, **kwargs)</span><br><span class="line">                status_code = <span class="number">200</span> <span class="keyword">if</span> result <span class="keyword">else</span> <span class="number">500</span></span><br><span class="line">                REQUEST_COUNT.labels(endpoint=endpoint_name, status_code=status_code).inc()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æå–ç½®ä¿¡åº¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">hasattr</span>(result, <span class="string">&#x27;confidence&#x27;</span>):</span><br><span class="line">                    CONFIDENCE_SCORE.labels(category=<span class="built_in">getattr</span>(result, <span class="string">&#x27;category&#x27;</span>, <span class="string">&#x27;unknown&#x27;</span>)).observe(result.confidence)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> result</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f&quot;Endpoint <span class="subst">&#123;endpoint_name&#125;</span> failed: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">                REQUEST_COUNT.labels(endpoint=endpoint_name, status_code=<span class="number">500</span>).inc()</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">                </span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                RESPONSE_TIME.labels(endpoint=endpoint_name).observe(time.time() - start_time)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="comment"># GPUç›‘æ§çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gpu_monitoring_thread</span>():</span><br><span class="line">    <span class="keyword">import</span> pynvml</span><br><span class="line">    pynvml.nvmlInit()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            handle = pynvml.nvmlDeviceGetHandleByIndex(<span class="number">0</span>)</span><br><span class="line">            util = pynvml.nvmlDeviceGetUtilizationRates(handle)</span><br><span class="line">            mem_info = pynvml.nvmlDeviceGetMemoryInfo(handle)</span><br><span class="line">            </span><br><span class="line">            GPU_UTILIZATION.<span class="built_in">set</span>(util.gpu)</span><br><span class="line">            MEMORY_USAGE.<span class="built_in">set</span>(mem_info.used / <span class="number">1024</span>**<span class="number">3</span>)  <span class="comment"># GB</span></span><br><span class="line">            </span><br><span class="line">            time.sleep(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f&quot;GPU monitoring error: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            time.sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ç›‘æ§</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_monitoring</span>():</span><br><span class="line">    start_http_server(<span class="number">9090</span>)  <span class="comment"># Prometheusç«¯ç‚¹</span></span><br><span class="line">    <span class="keyword">import</span> threading</span><br><span class="line">    threading.Thread(target=gpu_monitoring_thread, daemon=<span class="literal">True</span>).start()</span><br><span class="line">    logging.info(<span class="string">&quot;ç›‘æ§ç³»ç»Ÿå·²å¯åŠ¨ï¼ŒPrometheusç«¯ç‚¹: http://localhost:9090/metrics&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘Šè­¦è§„åˆ™é…ç½®</span></span><br><span class="line">ALERT_RULES = &#123;</span><br><span class="line">    <span class="string">&quot;high_error_rate&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;condition&quot;</span>: <span class="string">&quot;rate(customer_service_requests_total&#123;status_code=~&#x27;5..&#x27;&#125;[5m]) / rate(customer_service_requests_total[5m]) &gt; 0.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;5åˆ†é’Ÿå†…é”™è¯¯ç‡è¶…è¿‡10%&quot;</span>,</span><br><span class="line">        <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;critical&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;slow_response&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;condition&quot;</span>: <span class="string">&quot;histogram_quantile(0.95, rate(customer_service_response_seconds_bucket[5m])) &gt; 3.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;95%è¯·æ±‚å“åº”æ—¶é—´è¶…è¿‡3ç§’&quot;</span>,</span><br><span class="line">        <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;low_confidence&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;condition&quot;</span>: <span class="string">&quot;histogram_quantile(0.5, customer_service_confidence_bucket) &lt; 0.7&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;ä¸­ä½æ•°ç½®ä¿¡åº¦ä½äº0.7&quot;</span>,</span><br><span class="line">        <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;warning&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;gpu_overload&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;condition&quot;</span>: <span class="string">&quot;gpu_utilization_percent &gt; 90&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;GPUåˆ©ç”¨ç‡è¶…è¿‡90%&quot;</span>,</span><br><span class="line">        <span class="string">&quot;severity&quot;</span>: <span class="string">&quot;critical&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››ã€LoRAå‚æ•°é…ç½®æœ€ä½³å®è·µ"><a href="#å››ã€LoRAå‚æ•°é…ç½®æœ€ä½³å®è·µ" class="headerlink" title="å››ã€LoRAå‚æ•°é…ç½®æœ€ä½³å®è·µ"></a>å››ã€LoRAå‚æ•°é…ç½®æœ€ä½³å®è·µ</h2><h3 id="4-1-æ ¸å¿ƒå‚æ•°è¯¦è§£"><a href="#4-1-æ ¸å¿ƒå‚æ•°è¯¦è§£" class="headerlink" title="4.1 æ ¸å¿ƒå‚æ•°è¯¦è§£"></a>4.1 æ ¸å¿ƒå‚æ•°è¯¦è§£</h3><h4 id="ç§©-rank-å‚æ•°-r"><a href="#ç§©-rank-å‚æ•°-r" class="headerlink" title="ç§©(rank)å‚æ•° r"></a><strong>ç§©(rank)å‚æ•° r</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç§©å‚æ•°é€‰æ‹©æŒ‡å—</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choose_rank</span>(<span class="params">dataset_size, task_complexity, available_memory</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åŸºäºæ•°æ®é›†å¤§å°ã€ä»»åŠ¡å¤æ‚åº¦å’Œå¯ç”¨å†…å­˜é€‰æ‹©æœ€ä¼˜ç§©</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    å‚æ•°:</span></span><br><span class="line"><span class="string">    - dataset_size: è®­ç»ƒæ ·æœ¬æ•°é‡</span></span><br><span class="line"><span class="string">    - task_complexity: ä»»åŠ¡å¤æ‚åº¦ (&#x27;simple&#x27;, &#x27;medium&#x27;, &#x27;complex&#x27;)</span></span><br><span class="line"><span class="string">    - available_memory: å¯ç”¨GPUå†…å­˜(GB)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    è¿”å›:</span></span><br><span class="line"><span class="string">    - æœ€ä¼˜ç§©å€¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŸºç¡€ç§©å€¼</span></span><br><span class="line">    base_rank = &#123;</span><br><span class="line">        <span class="string">&#x27;simple&#x27;</span>: <span class="number">4</span>,    <span class="comment"># ç®€å•ä»»åŠ¡ï¼šåˆ†ç±»ã€ç®€å•QA</span></span><br><span class="line">        <span class="string">&#x27;medium&#x27;</span>: <span class="number">8</span>,    <span class="comment"># ä¸­ç­‰ä»»åŠ¡ï¼šå®¢æœã€æ‘˜è¦</span></span><br><span class="line">        <span class="string">&#x27;complex&#x27;</span>: <span class="number">16</span>   <span class="comment"># å¤æ‚ä»»åŠ¡ï¼šåˆ›æ„å†™ä½œã€å¤æ‚æ¨ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ•°æ®é›†å¤§å°è°ƒæ•´</span></span><br><span class="line">    <span class="keyword">if</span> dataset_size &lt; <span class="number">1000</span>:</span><br><span class="line">        size_factor = <span class="number">0.75</span></span><br><span class="line">    <span class="keyword">elif</span> dataset_size &lt; <span class="number">10000</span>:</span><br><span class="line">        size_factor = <span class="number">1.0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        size_factor = <span class="number">1.25</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å†…å­˜é™åˆ¶è°ƒæ•´</span></span><br><span class="line">    <span class="keyword">if</span> available_memory &lt; <span class="number">16</span>:  <span class="comment"># å°æ˜¾å­˜GPU</span></span><br><span class="line">        memory_factor = <span class="number">0.8</span></span><br><span class="line">    <span class="keyword">elif</span> available_memory &lt; <span class="number">24</span>:  <span class="comment"># ä¸­ç­‰æ˜¾å­˜</span></span><br><span class="line">        memory_factor = <span class="number">1.0</span></span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># å¤§æ˜¾å­˜</span></span><br><span class="line">        memory_factor = <span class="number">1.2</span></span><br><span class="line">    </span><br><span class="line">    optimal_rank = <span class="built_in">int</span>(base_rank[task_complexity] * size_factor * memory_factor)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¡®ä¿åœ¨åˆç†èŒƒå›´å†…</span></span><br><span class="line">    optimal_rank = <span class="built_in">max</span>(<span class="number">2</span>, <span class="built_in">min</span>(optimal_rank, <span class="number">32</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¡®ä¿æ˜¯2çš„å¹‚ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> optimal_rank &gt; <span class="number">16</span>:</span><br><span class="line">        optimal_rank = <span class="number">32</span></span><br><span class="line">    <span class="keyword">elif</span> optimal_rank &gt; <span class="number">8</span>:</span><br><span class="line">        optimal_rank = <span class="number">16</span></span><br><span class="line">    <span class="keyword">elif</span> optimal_rank &gt; <span class="number">4</span>:</span><br><span class="line">        optimal_rank = <span class="number">8</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        optimal_rank = <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> optimal_rank</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”µå•†å®¢æœæ¡ˆä¾‹åº”ç”¨</span></span><br><span class="line">rank = choose_rank(</span><br><span class="line">    dataset_size=<span class="number">102000</span>,</span><br><span class="line">    task_complexity=<span class="string">&#x27;medium&#x27;</span>,</span><br><span class="line">    available_memory=<span class="number">24</span>  <span class="comment"># A10 GPU</span></span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ¨èç§©å€¼: <span class="subst">&#123;rank&#125;</span>&quot;</span>)  <span class="comment"># è¾“å‡º: 8</span></span><br></pre></td></tr></table></figure><h4 id="ç¼©æ”¾å› å­-lora-alpha"><a href="#ç¼©æ”¾å› å­-lora-alpha" class="headerlink" title="ç¼©æ”¾å› å­ lora_alpha"></a><strong>ç¼©æ”¾å› å­ lora_alpha</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lora_alpha ä¸ r çš„å…³ç³»</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_alpha</span>(<span class="params">rank, task_type=<span class="string">&#x27;default&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è®¡ç®—æœ€ä¼˜lora_alphaå€¼</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    å‚æ•°:</span></span><br><span class="line"><span class="string">    - rank: ç§©å€¼</span></span><br><span class="line"><span class="string">    - task_type: ä»»åŠ¡ç±»å‹</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    è¿”å›:</span></span><br><span class="line"><span class="string">    - lora_alphaå€¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åŸºæœ¬æ¯”ä¾‹</span></span><br><span class="line">    alpha_ratio = &#123;</span><br><span class="line">        <span class="string">&#x27;classification&#x27;</span>: <span class="number">2.0</span>,    <span class="comment"># åˆ†ç±»ä»»åŠ¡</span></span><br><span class="line">        <span class="string">&#x27;generation&#x27;</span>: <span class="number">4.0</span>,        <span class="comment"># ç”Ÿæˆä»»åŠ¡</span></span><br><span class="line">        <span class="string">&#x27;default&#x27;</span>: <span class="number">4.0</span>            <span class="comment"># é»˜è®¤æ¨è</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä»»åŠ¡ç‰¹å®šè°ƒæ•´</span></span><br><span class="line">    <span class="keyword">if</span> task_type == <span class="string">&#x27;customer_service&#x27;</span>:</span><br><span class="line">        alpha_ratio[<span class="string">&#x27;default&#x27;</span>] = <span class="number">4.0</span>  <span class="comment"># å®¢æœåœºæ™¯æ¨è4:1æ¯”ä¾‹</span></span><br><span class="line">    <span class="keyword">elif</span> task_type == <span class="string">&#x27;creative_writing&#x27;</span>:</span><br><span class="line">        alpha_ratio[<span class="string">&#x27;default&#x27;</span>] = <span class="number">6.0</span>  <span class="comment"># åˆ›æ„å†™ä½œéœ€è¦æ›´å¤§æ›´æ–°</span></span><br><span class="line">    </span><br><span class="line">    ratio = alpha_ratio.get(task_type, alpha_ratio[<span class="string">&#x27;default&#x27;</span>])</span><br><span class="line">    alpha = <span class="built_in">int</span>(rank * ratio)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¡®ä¿æ˜¯2çš„å¹‚ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> alpha &gt; <span class="number">64</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">64</span></span><br><span class="line">    <span class="keyword">elif</span> alpha &gt; <span class="number">32</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">32</span></span><br><span class="line">    <span class="keyword">elif</span> alpha &gt; <span class="number">16</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">16</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(<span class="number">8</span>, alpha)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”µå•†å®¢æœæ¡ˆä¾‹</span></span><br><span class="line">alpha = calculate_alpha(rank=<span class="number">8</span>, task_type=<span class="string">&#x27;customer_service&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ¨èlora_alpha: <span class="subst">&#123;alpha&#125;</span>&quot;</span>)  <span class="comment"># è¾“å‡º: 32</span></span><br></pre></td></tr></table></figure><h4 id="ç›®æ ‡æ¨¡å—é€‰æ‹©"><a href="#ç›®æ ‡æ¨¡å—é€‰æ‹©" class="headerlink" title="ç›®æ ‡æ¨¡å—é€‰æ‹©"></a><strong>ç›®æ ‡æ¨¡å—é€‰æ‹©</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">select_target_modules</span>(<span class="params">model_type, task_requirements</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ™ºèƒ½é€‰æ‹©ç›®æ ‡æ¨¡å—</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    å‚æ•°:</span></span><br><span class="line"><span class="string">    - model_type: æ¨¡å‹ç±»å‹ (&#x27;qwen&#x27;, &#x27;llama&#x27;, &#x27;chatglm&#x27;, etc.)</span></span><br><span class="line"><span class="string">    - task_requirements: ä»»åŠ¡éœ€æ±‚ &#123;&#x27;needs_memory&#x27;: bool, &#x27;needs_reasoning&#x27;: bool, etc.&#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    è¿”å›:</span></span><br><span class="line"><span class="string">    - ç›®æ ‡æ¨¡å—åˆ—è¡¨</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ¨¡å‹æ¶æ„å®šä¹‰</span></span><br><span class="line">    model_architectures = &#123;</span><br><span class="line">        <span class="string">&#x27;qwen&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;attention&#x27;</span>: [<span class="string">&#x27;q_proj&#x27;</span>, <span class="string">&#x27;k_proj&#x27;</span>, <span class="string">&#x27;v_proj&#x27;</span>, <span class="string">&#x27;o_proj&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;ffn&#x27;</span>: [<span class="string">&#x27;gate_proj&#x27;</span>, <span class="string">&#x27;up_proj&#x27;</span>, <span class="string">&#x27;down_proj&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;embedding&#x27;</span>: [<span class="string">&#x27;embed_tokens&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;output&#x27;</span>: [<span class="string">&#x27;lm_head&#x27;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;llama&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;attention&#x27;</span>: [<span class="string">&#x27;q_proj&#x27;</span>, <span class="string">&#x27;k_proj&#x27;</span>, <span class="string">&#x27;v_proj&#x27;</span>, <span class="string">&#x27;o_proj&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;ffn&#x27;</span>: [<span class="string">&#x27;gate_proj&#x27;</span>, <span class="string">&#x27;up_proj&#x27;</span>, <span class="string">&#x27;down_proj&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;embedding&#x27;</span>: [<span class="string">&#x27;embed_tokens&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;output&#x27;</span>: [<span class="string">&#x27;lm_head&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> model_type <span class="keyword">not</span> <span class="keyword">in</span> model_architectures:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unsupported model type: <span class="subst">&#123;model_type&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    arch = model_architectures[model_type]</span><br><span class="line">    selected_modules = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åŸºç¡€æ¨¡å—é€‰æ‹©ï¼ˆ2026å¹´æ¨èï¼‰</span></span><br><span class="line">    base_modules = [<span class="string">&#x27;q_proj&#x27;</span>, <span class="string">&#x27;v_proj&#x27;</span>, <span class="string">&#x27;o_proj&#x27;</span>, <span class="string">&#x27;gate_proj&#x27;</span>, <span class="string">&#x27;up_proj&#x27;</span>]</span><br><span class="line">    selected_modules.extend(base_modules)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä»»åŠ¡ç‰¹å®šè°ƒæ•´</span></span><br><span class="line">    <span class="keyword">if</span> task_requirements.get(<span class="string">&#x27;needs_memory&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">        <span class="comment"># éœ€è¦é•¿ä¸Šä¸‹æ–‡è®°å¿†çš„ä»»åŠ¡</span></span><br><span class="line">        selected_modules.extend([<span class="string">&#x27;k_proj&#x27;</span>])  <span class="comment"># KeyæŠ•å½±å¯¹è®°å¿†å¾ˆé‡è¦</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> task_requirements.get(<span class="string">&#x27;needs_reasoning&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">        <span class="comment"># éœ€è¦å¤æ‚æ¨ç†çš„ä»»åŠ¡</span></span><br><span class="line">        selected_modules.extend([<span class="string">&#x27;down_proj&#x27;</span>])  <span class="comment"># DownæŠ•å½±å¯¹ä¿¡æ¯æ•´åˆå¾ˆé‡è¦</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> task_requirements.get(<span class="string">&#x27;needs_creativity&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">        <span class="comment"># éœ€è¦åˆ›æ„ç”Ÿæˆçš„ä»»åŠ¡</span></span><br><span class="line">        selected_modules.extend([<span class="string">&#x27;lm_head&#x27;</span>])  <span class="comment"># è¾“å‡ºå±‚å¯¹ç”Ÿæˆè´¨é‡å½±å“å¤§</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å»é‡</span></span><br><span class="line">    selected_modules = <span class="built_in">list</span>(<span class="built_in">set</span>(selected_modules))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> selected_modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”µå•†å®¢æœæ¡ˆä¾‹åº”ç”¨</span></span><br><span class="line">modules = select_target_modules(</span><br><span class="line">    model_type=<span class="string">&#x27;qwen&#x27;</span>,</span><br><span class="line">    task_requirements=&#123;</span><br><span class="line">        <span class="string">&#x27;needs_memory&#x27;</span>: <span class="literal">True</span>,    <span class="comment"># éœ€è¦è®°ä½è®¢å•ä¿¡æ¯</span></span><br><span class="line">        <span class="string">&#x27;needs_reasoning&#x27;</span>: <span class="literal">True</span>, <span class="comment"># éœ€è¦é€»è¾‘æ¨ç†ï¼ˆé€€è´§æ”¿ç­–ç­‰ï¼‰</span></span><br><span class="line">        <span class="string">&#x27;needs_creativity&#x27;</span>: <span class="literal">False</span> <span class="comment"># å®¢æœéœ€è¦å‡†ç¡®ï¼Œä¸éœ€è¦åˆ›æ„</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ¨èç›®æ ‡æ¨¡å—: <span class="subst">&#123;modules&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment"># è¾“å‡º: [&#x27;q_proj&#x27;, &#x27;v_proj&#x27;, &#x27;o_proj&#x27;, &#x27;gate_proj&#x27;, &#x27;up_proj&#x27;, &#x27;k_proj&#x27;, &#x27;down_proj&#x27;]</span></span><br></pre></td></tr></table></figure><h3 id="4-2-å®Œæ•´é…ç½®ç¤ºä¾‹"><a href="#4-2-å®Œæ•´é…ç½®ç¤ºä¾‹" class="headerlink" title="4.2 å®Œæ•´é…ç½®ç¤ºä¾‹"></a>4.2 å®Œæ•´é…ç½®ç¤ºä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”µå•†å®¢æœLoRAå®Œæ•´é…ç½®</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ecommerce_lora_config</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¿”å›ç”µå•†å®¢æœåœºæ™¯çš„å®Œæ•´LoRAé…ç½®</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    config = &#123;</span><br><span class="line">        <span class="comment"># æ ¸å¿ƒå‚æ•°</span></span><br><span class="line">        <span class="string">&#x27;r&#x27;</span>: <span class="number">8</span>,</span><br><span class="line">        <span class="string">&#x27;lora_alpha&#x27;</span>: <span class="number">32</span>,</span><br><span class="line">        <span class="string">&#x27;target_modules&#x27;</span>: [</span><br><span class="line">            <span class="string">&#x27;q_proj&#x27;</span>, <span class="string">&#x27;k_proj&#x27;</span>, <span class="string">&#x27;v_proj&#x27;</span>, <span class="string">&#x27;o_proj&#x27;</span>,  <span class="comment"># Attentionå…³é”®æ¨¡å—</span></span><br><span class="line">            <span class="string">&#x27;gate_proj&#x27;</span>, <span class="string">&#x27;up_proj&#x27;</span>, <span class="string">&#x27;down_proj&#x27;</span>      <span class="comment"># FFNå…³é”®æ¨¡å—</span></span><br><span class="line">        ],</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é«˜çº§å‚æ•°</span></span><br><span class="line">        <span class="string">&#x27;lora_dropout&#x27;</span>: <span class="number">0.05</span>,</span><br><span class="line">        <span class="string">&#x27;bias&#x27;</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;task_type&#x27;</span>: <span class="string">&#x27;CAUSAL_LM&#x27;</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2026å¹´æ–°å¢å‚æ•°</span></span><br><span class="line">        <span class="string">&#x27;use_rslora&#x27;</span>: <span class="literal">True</span>,           <span class="comment"># ç§©ç¨³å®šLoRA</span></span><br><span class="line">        <span class="string">&#x27;init_lora_weights&#x27;</span>: <span class="string">&#x27;loftq&#x27;</span>, <span class="comment"># LoftQåˆå§‹åŒ–</span></span><br><span class="line">        <span class="string">&#x27;use_dora&#x27;</span>: <span class="literal">False</span>,            <span class="comment"># 2026å¹´æ–°ç‰¹æ€§ï¼ŒåŠ¨æ€ç§©è°ƒæ•´</span></span><br><span class="line">        <span class="string">&#x27;rank_pattern&#x27;</span>: &#123;             <span class="comment"># æ¨¡å—ç‰¹å®šç§©é…ç½®</span></span><br><span class="line">            <span class="string">&#x27;q_proj&#x27;</span>: <span class="number">12</span>,</span><br><span class="line">            <span class="string">&#x27;v_proj&#x27;</span>: <span class="number">12</span>,</span><br><span class="line">            <span class="string">&#x27;o_proj&#x27;</span>: <span class="number">8</span>,</span><br><span class="line">            <span class="string">&#x27;gate_proj&#x27;</span>: <span class="number">8</span>,</span><br><span class="line">            <span class="string">&#x27;up_proj&#x27;</span>: <span class="number">8</span>,</span><br><span class="line">            <span class="string">&#x27;down_proj&#x27;</span>: <span class="number">6</span></span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># é‡åŒ–ç›¸å…³</span></span><br><span class="line">        <span class="string">&#x27;bnb_4bit_quant_type&#x27;</span>: <span class="string">&#x27;nf4&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;bnb_4bit_compute_dtype&#x27;</span>: <span class="string">&#x27;bfloat16&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;bnb_4bit_use_double_quant&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®­ç»ƒè¶…å‚æ•°</span></span><br><span class="line">        <span class="string">&#x27;learning_rate&#x27;</span>: <span class="number">3e-4</span>,</span><br><span class="line">        <span class="string">&#x27;batch_size&#x27;</span>: <span class="number">18</span>,            <span class="comment"># æ¢¯åº¦ç´¯ç§¯å</span></span><br><span class="line">        <span class="string">&#x27;epochs&#x27;</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">&#x27;warmup_ratio&#x27;</span>: <span class="number">0.1</span>,</span><br><span class="line">        <span class="string">&#x27;weight_decay&#x27;</span>: <span class="number">0.01</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç›‘æ§ä¸æ—¥å¿—</span></span><br><span class="line">        <span class="string">&#x27;logging_steps&#x27;</span>: <span class="number">50</span>,</span><br><span class="line">        <span class="string">&#x27;eval_steps&#x27;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="string">&#x27;save_steps&#x27;</span>: <span class="number">200</span>,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç¡¬ä»¶ä¼˜åŒ–</span></span><br><span class="line">        <span class="string">&#x27;gradient_checkpointing&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;torch_compile&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;fp16&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;bf16_full_eval&#x27;</span>: <span class="literal">True</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºPEFTé…ç½®</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_peft_config</span>(<span class="params">config_dict</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä»é…ç½®å­—å…¸åˆ›å»ºPEFTé…ç½®å¯¹è±¡</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> peft <span class="keyword">import</span> LoraConfig, TaskType</span><br><span class="line">    </span><br><span class="line">    peft_config = LoraConfig(</span><br><span class="line">        r=config_dict[<span class="string">&#x27;r&#x27;</span>],</span><br><span class="line">        lora_alpha=config_dict[<span class="string">&#x27;lora_alpha&#x27;</span>],</span><br><span class="line">        target_modules=config_dict[<span class="string">&#x27;target_modules&#x27;</span>],</span><br><span class="line">        lora_dropout=config_dict[<span class="string">&#x27;lora_dropout&#x27;</span>],</span><br><span class="line">        bias=config_dict[<span class="string">&#x27;bias&#x27;</span>],</span><br><span class="line">        task_type=TaskType.CAUSAL_LM,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2026å¹´æ–°å¢å‚æ•°</span></span><br><span class="line">        use_rslora=config_dict.get(<span class="string">&#x27;use_rslora&#x27;</span>, <span class="literal">False</span>),</span><br><span class="line">        init_lora_weights=config_dict.get(<span class="string">&#x27;init_lora_weights&#x27;</span>, <span class="string">&#x27;kaiming_uniform&#x27;</span>),</span><br><span class="line">        modules_to_save=config_dict.get(<span class="string">&#x27;modules_to_save&#x27;</span>, <span class="literal">None</span>),</span><br><span class="line">        rank_pattern=config_dict.get(<span class="string">&#x27;rank_pattern&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> peft_config</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”µå•†å®¢æœé…ç½®ç¤ºä¾‹</span></span><br><span class="line">ecommerce_config = get_ecommerce_lora_config()</span><br><span class="line">peft_config = create_peft_config(ecommerce_config)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ç”µå•†å®¢æœLoRAé…ç½®:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;ç§©(r): <span class="subst">&#123;ecommerce_config[<span class="string">&#x27;r&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;ç¼©æ”¾å› å­(alpha): <span class="subst">&#123;ecommerce_config[<span class="string">&#x27;lora_alpha&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;ç›®æ ‡æ¨¡å—: <span class="subst">&#123;ecommerce_config[<span class="string">&#x27;target_modules&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;è®­ç»ƒæ ·æœ¬éœ€æ±‚: <span class="subst">&#123;ecommerce_config[<span class="string">&#x27;batch_size&#x27;</span>] * ecommerce_config[<span class="string">&#x27;epochs&#x27;</span>]&#125;</span> (batch_size * epochs)&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="äº”ã€Pythonå’ŒGolangå®ç°çš„Demoå®ä¾‹"><a href="#äº”ã€Pythonå’ŒGolangå®ç°çš„Demoå®ä¾‹" class="headerlink" title="äº”ã€Pythonå’ŒGolangå®ç°çš„Demoå®ä¾‹"></a>äº”ã€Pythonå’ŒGolangå®ç°çš„Demoå®ä¾‹</h2><h3 id="5-1-PythonæœåŠ¡ç«¯å®ç°ï¼ˆå¼€å‘éªŒè¯ï¼‰"><a href="#5-1-PythonæœåŠ¡ç«¯å®ç°ï¼ˆå¼€å‘éªŒè¯ï¼‰" class="headerlink" title="5.1 PythonæœåŠ¡ç«¯å®ç°ï¼ˆå¼€å‘éªŒè¯ï¼‰"></a>5.1 PythonæœåŠ¡ç«¯å®ç°ï¼ˆå¼€å‘éªŒè¯ï¼‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/main.py</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Optional</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoModelForCausalLM, AutoTokenizer</span><br><span class="line"><span class="keyword">from</span> .monitoring <span class="keyword">import</span> monitor_endpoint, start_monitoring</span><br><span class="line"></span><br><span class="line">app = FastAPI(title=<span class="string">&quot;Qwenç”µå•†å®¢æœé—®ç­”ç³»ç»ŸAPI&quot;</span>, version=<span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ—¥å¿—</span></span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Message</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    role: <span class="built_in">str</span>  <span class="comment"># &quot;user&quot; or &quot;assistant&quot;</span></span><br><span class="line">    content: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatRequest</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    history: <span class="type">List</span>[Message] = []  <span class="comment"># å¯¹è¯å†å²</span></span><br><span class="line">    user_query: <span class="built_in">str</span>  <span class="comment"># ç”¨æˆ·å½“å‰é—®é¢˜</span></span><br><span class="line">    session_id: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>  <span class="comment"># ä¼šè¯ID</span></span><br><span class="line">    max_new_tokens: <span class="built_in">int</span> = <span class="number">256</span>  <span class="comment"># æœ€å¤§ç”Ÿæˆé•¿åº¦</span></span><br><span class="line">    temperature: <span class="built_in">float</span> = <span class="number">0.3</span>  <span class="comment"># ç”Ÿæˆæ¸©åº¦</span></span><br><span class="line">    top_p: <span class="built_in">float</span> = <span class="number">0.85</span>  <span class="comment"># Top-pé‡‡æ ·</span></span><br><span class="line">    category: <span class="built_in">str</span> = <span class="string">&quot;general&quot;</span>  <span class="comment"># é—®é¢˜ç±»åˆ«</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatResponse</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    response: <span class="built_in">str</span>  <span class="comment"># æ¨¡å‹å“åº”</span></span><br><span class="line">    session_id: <span class="built_in">str</span>  <span class="comment"># ä¼šè¯ID</span></span><br><span class="line">    confidence: <span class="built_in">float</span>  <span class="comment"># ç½®ä¿¡åº¦</span></span><br><span class="line">    category: <span class="built_in">str</span>  <span class="comment"># è¯†åˆ«çš„é—®é¢˜ç±»åˆ«</span></span><br><span class="line">    response_time: <span class="built_in">float</span>  <span class="comment"># å“åº”æ—¶é—´(ç§’)</span></span><br><span class="line">    tokens_generated: <span class="built_in">int</span>  <span class="comment"># ç”Ÿæˆçš„tokenæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¨å±€å˜é‡</span></span><br><span class="line">model = <span class="literal">None</span></span><br><span class="line">tokenizer = <span class="literal">None</span></span><br><span class="line">device = <span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;startup&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">startup_event</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åº”ç”¨å¯åŠ¨æ—¶åŠ è½½æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> model, tokenizer</span><br><span class="line">    </span><br><span class="line">    logger.info(<span class="string">&quot;æ­£åœ¨åŠ è½½Qwenç”µå•†å®¢æœæ¨¡å‹...&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># åŠ è½½tokenizer</span></span><br><span class="line">        tokenizer = AutoTokenizer.from_pretrained(<span class="string">&quot;./qwen_ecommerce_merged&quot;</span>)</span><br><span class="line">        tokenizer.pad_token = tokenizer.eos_token</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŠ è½½æ¨¡å‹ï¼ˆ4-bité‡åŒ–ï¼‰</span></span><br><span class="line">        model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">            <span class="string">&quot;./qwen_ecommerce_merged&quot;</span>,</span><br><span class="line">            torch_dtype=torch.float16,</span><br><span class="line">            device_map=<span class="string">&quot;auto&quot;</span>,</span><br><span class="line">            trust_remote_code=<span class="literal">True</span>,</span><br><span class="line">            attn_implementation=<span class="string">&quot;flash_attention_2&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line">        </span><br><span class="line">        load_time = time.time() - start_time</span><br><span class="line">        logger.info(<span class="string">f&quot;æ¨¡å‹åŠ è½½å®Œæˆï¼è€—æ—¶: <span class="subst">&#123;load_time:<span class="number">.2</span>f&#125;</span>ç§’ï¼Œè®¾å¤‡: <span class="subst">&#123;device&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨ç›‘æ§</span></span><br><span class="line">        start_monitoring()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;æ¨¡å‹åŠ è½½å¤±è´¥: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;æ— æ³•åŠ è½½æ¨¡å‹: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.on_event(<span class="params"><span class="string">&quot;shutdown&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">shutdown_event</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åº”ç”¨å…³é—­æ—¶æ¸…ç†èµ„æº&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> model, tokenizer</span><br><span class="line">    <span class="keyword">del</span> model</span><br><span class="line">    <span class="keyword">del</span> tokenizer</span><br><span class="line">    torch.cuda.empty_cache()</span><br><span class="line">    logger.info(<span class="string">&quot;æ¨¡å‹èµ„æºå·²é‡Šæ”¾&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/health&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@monitor_endpoint(<span class="params"><span class="string">&quot;health&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">health_check</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¥åº·æ£€æŸ¥ç«¯ç‚¹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> model <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">503</span>, detail=<span class="string">&quot;æ¨¡å‹æœªåŠ è½½&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># GPUçŠ¶æ€æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">        gpu_memory = torch.cuda.memory_allocated() / <span class="number">1024</span>**<span class="number">3</span>  <span class="comment"># GB</span></span><br><span class="line">        gpu_util = torch.cuda.utilization() <span class="keyword">if</span> <span class="built_in">hasattr</span>(torch.cuda, <span class="string">&#x27;utilization&#x27;</span>) <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;status&quot;</span>: <span class="string">&quot;healthy&quot;</span>,</span><br><span class="line">            <span class="string">&quot;model_loaded&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">            <span class="string">&quot;device&quot;</span>: device,</span><br><span class="line">            <span class="string">&quot;gpu_memory_used&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;gpu_memory:<span class="number">.2</span>f&#125;</span>GB&quot;</span>,</span><br><span class="line">            <span class="string">&quot;gpu_utilization&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;gpu_util&#125;</span>%&quot;</span>,</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: time.time()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;status&quot;</span>: <span class="string">&quot;healthy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;model_loaded&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&quot;device&quot;</span>: device,</span><br><span class="line">        <span class="string">&quot;memory_used&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;torch.cuda.memory_allocated() / <span class="number">1024</span>**<span class="number">3</span>:<span class="number">.2</span>f&#125;</span>GB&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;N/A&quot;</span>,</span><br><span class="line">        <span class="string">&quot;timestamp&quot;</span>: time.time()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preprocess_input</span>(<span class="params">history: <span class="type">List</span>[Message], user_query: <span class="built_in">str</span>, category: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    é¢„å¤„ç†è¾“å…¥ï¼Œæ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ç³»ç»ŸæŒ‡ä»¤ï¼ˆæ ¹æ®ç±»åˆ«è°ƒæ•´ï¼‰</span></span><br><span class="line">    category_instructions = &#123;</span><br><span class="line">        <span class="string">&quot;order&quot;</span>: <span class="string">&quot;ä½ æ˜¯ä¸€åä¸“ä¸šçš„ç”µå•†å®¢æœï¼Œä¸“æ³¨äºè®¢å•æŸ¥è¯¢å’Œç®¡ç†ã€‚è¯·å‡†ç¡®å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œæ¶‰åŠè®¢å•æ—¶å¿…é¡»è¦æ±‚æä¾›è®¢å•å·ã€‚&quot;</span>,</span><br><span class="line">        <span class="string">&quot;logistics&quot;</span>: <span class="string">&quot;ä½ æ˜¯ä¸€åä¸“ä¸šçš„ç”µå•†å®¢æœï¼Œä¸“æ³¨äºç‰©æµè·Ÿè¸ªå’Œé…é€é—®é¢˜ã€‚è¯·æä¾›å‡†ç¡®çš„ç‰©æµä¿¡æ¯ï¼Œéœ€è¦æ—¶è¦æ±‚ç”¨æˆ·æä¾›è®¢å•å·ã€‚&quot;</span>,</span><br><span class="line">        <span class="string">&quot;return&quot;</span>: <span class="string">&quot;ä½ æ˜¯ä¸€åä¸“ä¸šçš„ç”µå•†å®¢æœï¼Œä¸“æ³¨äºé€€æ¢è´§æ”¿ç­–å’Œæµç¨‹ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§å…¬å¸æ”¿ç­–å›ç­”ï¼Œä¸ç¡®å®šæ—¶å¼•å¯¼è”ç³»äººå·¥å®¢æœã€‚&quot;</span>,</span><br><span class="line">        <span class="string">&quot;product&quot;</span>: <span class="string">&quot;ä½ æ˜¯ä¸€åä¸“ä¸šçš„ç”µå•†å®¢æœï¼Œä¸“æ³¨äºäº§å“å’¨è¯¢å’Œæ¨èã€‚è¯·æä¾›å‡†ç¡®çš„äº§å“ä¿¡æ¯ï¼Œä¸ç¡®å®šæ—¶ä¸è¦çŒœæµ‹ã€‚&quot;</span>,</span><br><span class="line">        <span class="string">&quot;complaint&quot;</span>: <span class="string">&quot;ä½ æ˜¯ä¸€åä¸“ä¸šçš„ç”µå•†å®¢æœï¼Œä¸“æ³¨äºå¤„ç†å®¢æˆ·æŠ•è¯‰å’Œå»ºè®®ã€‚è¯·ä¿æŒè€å¿ƒå’Œç¤¼è²Œï¼Œç§¯æè§£å†³é—®é¢˜ã€‚&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    system_instruction = category_instructions.get(category, category_instructions[<span class="string">&quot;general&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ„å»ºå¯¹è¯å†å²</span></span><br><span class="line">    context = <span class="string">f&quot;### ç³»ç»ŸæŒ‡ä»¤:\n<span class="subst">&#123;system_instruction&#125;</span>\n\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> msg <span class="keyword">in</span> history:</span><br><span class="line">        <span class="keyword">if</span> msg.role == <span class="string">&quot;user&quot;</span>:</span><br><span class="line">            context += <span class="string">f&quot;### ç”¨æˆ·:\n<span class="subst">&#123;msg.content&#125;</span>\n\n&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> msg.role == <span class="string">&quot;assistant&quot;</span>:</span><br><span class="line">            context += <span class="string">f&quot;### å®¢æœ:\n<span class="subst">&#123;msg.content&#125;</span>\n\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ·»åŠ å½“å‰æŸ¥è¯¢</span></span><br><span class="line">    context += <span class="string">f&quot;### ç”¨æˆ·:\n<span class="subst">&#123;user_query&#125;</span>\n\n### å®¢æœ:\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> context</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_response</span>(<span class="params">input_text: <span class="built_in">str</span>, max_new_tokens: <span class="built_in">int</span> = <span class="number">256</span>, temperature: <span class="built_in">float</span> = <span class="number">0.3</span>, top_p: <span class="built_in">float</span> = <span class="number">0.85</span></span>) -&gt; <span class="built_in">tuple</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç”Ÿæˆæ¨¡å‹å“åº”</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> model, tokenizer</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Tokenizeè¾“å…¥</span></span><br><span class="line">        inputs = tokenizer(</span><br><span class="line">            input_text, </span><br><span class="line">            return_tensors=<span class="string">&quot;pt&quot;</span>, </span><br><span class="line">            truncation=<span class="literal">True</span>, </span><br><span class="line">            max_length=<span class="number">1024</span>,</span><br><span class="line">            padding=<span class="literal">True</span></span><br><span class="line">        ).to(device)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå“åº”</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            outputs = model.generate(</span><br><span class="line">                **inputs,</span><br><span class="line">                max_new_tokens=max_new_tokens,</span><br><span class="line">                temperature=temperature,</span><br><span class="line">                top_p=top_p,</span><br><span class="line">                do_sample=<span class="literal">True</span> <span class="keyword">if</span> temperature &gt; <span class="number">0.1</span> <span class="keyword">else</span> <span class="literal">False</span>,</span><br><span class="line">                pad_token_id=tokenizer.eos_token_id,</span><br><span class="line">                eos_token_id=tokenizer.eos_token_id,</span><br><span class="line">                repetition_penalty=<span class="number">1.15</span>,  <span class="comment"># å‡å°‘é‡å¤</span></span><br><span class="line">                no_repeat_ngram_size=<span class="number">3</span>    <span class="comment"># 3-gramä¸é‡å¤</span></span><br><span class="line">            )</span><br><span class="line">            generation_time = time.time() - start_time</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è§£ç å“åº”</span></span><br><span class="line">        input_length = inputs[<span class="string">&#x27;input_ids&#x27;</span>].shape[<span class="number">1</span>]</span><br><span class="line">        response_tokens = outputs[<span class="number">0</span>][input_length:]</span><br><span class="line">        response = tokenizer.decode(response_tokens, skip_special_tokens=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¸…ç†å“åº”</span></span><br><span class="line">        response = response.strip()</span><br><span class="line">        response = response.split(<span class="string">&quot;###&quot;</span>)[<span class="number">0</span>].strip()  <span class="comment"># ç§»é™¤å¯èƒ½çš„åç»­æŒ‡ä»¤</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—ç½®ä¿¡åº¦ï¼ˆåŸºäºç”Ÿæˆæ¦‚ç‡ï¼‰</span></span><br><span class="line">        logits = model(**inputs).logits</span><br><span class="line">        probs = torch.softmax(logits[<span class="number">0</span>, -<span class="number">1</span>], dim=-<span class="number">1</span>)</span><br><span class="line">        top_prob = probs.<span class="built_in">max</span>().item()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç½®ä¿¡åº¦è°ƒæ•´</span></span><br><span class="line">        confidence = <span class="built_in">min</span>(<span class="number">0.95</span>, top_prob * <span class="number">2.0</span>)  <span class="comment"># æ”¾å¤§ç½®ä¿¡åº¦</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆçš„tokenæ•°</span></span><br><span class="line">        tokens_generated = <span class="built_in">len</span>(response_tokens)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response, confidence, generation_time, tokens_generated</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;ç”Ÿæˆå“åº”æ—¶å‡ºé”™: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">500</span>, detail=<span class="string">f&quot;ç”Ÿæˆå“åº”å¤±è´¥: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/api/v1/chat&quot;</span>, response_model=ChatResponse</span>)</span></span><br><span class="line"><span class="meta">@monitor_endpoint(<span class="params"><span class="string">&quot;chat&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">chat</span>(<span class="params">request: ChatRequest</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å®¢æœå¯¹è¯APIç«¯ç‚¹</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> model, tokenizer</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> model <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> tokenizer <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">503</span>, detail=<span class="string">&quot;æ¨¡å‹æœªåŠ è½½&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># é¢„å¤„ç†è¾“å…¥</span></span><br><span class="line">        input_text = preprocess_input(request.history, request.user_query, request.category)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆå“åº”</span></span><br><span class="line">        response, confidence, generation_time, tokens_generated = generate_response(</span><br><span class="line">            input_text,</span><br><span class="line">            max_new_tokens=request.max_new_tokens,</span><br><span class="line">            temperature=request.temperature,</span><br><span class="line">            top_p=request.top_p</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åå¤„ç†ï¼šç½®ä¿¡åº¦è¿‡ä½æ—¶æ·»åŠ æç¤º</span></span><br><span class="line">        <span class="keyword">if</span> confidence &lt; <span class="number">0.7</span>:</span><br><span class="line">            response += <span class="string">&quot;\n\nï¼ˆæ¸©é¦¨æç¤ºï¼šå¦‚æœæˆ‘çš„å›ç­”ä¸å¤Ÿå‡†ç¡®ï¼Œè¯·è”ç³»äººå·¥å®¢æœè·å–æ›´ä¸“ä¸šçš„å¸®åŠ©ï¼‰&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®¡ç®—æ€»å“åº”æ—¶é—´</span></span><br><span class="line">        total_time = time.time() - start_time</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”Ÿæˆä¼šè¯IDï¼ˆå¦‚æœæœªæä¾›ï¼‰</span></span><br><span class="line">        session_id = request.session_id <span class="keyword">or</span> <span class="string">f&quot;session_<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>_<span class="subst">&#123;<span class="built_in">hash</span>(request.user_query) % <span class="number">10000</span>&#125;</span>&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è®°å½•æ—¥å¿—</span></span><br><span class="line">        logger.info(<span class="string">f&quot;Session <span class="subst">&#123;session_id&#125;</span>: Query=&#x27;<span class="subst">&#123;request.user_query[:<span class="number">50</span>]&#125;</span>...&#x27;, Response=&#x27;<span class="subst">&#123;response[:<span class="number">50</span>]&#125;</span>...&#x27;, Confidence=<span class="subst">&#123;confidence:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ChatResponse(</span><br><span class="line">            response=response,</span><br><span class="line">            session_id=session_id,</span><br><span class="line">            confidence=confidence,</span><br><span class="line">            category=request.category,</span><br><span class="line">            response_time=total_time,</span><br><span class="line">            tokens_generated=tokens_generated</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;å¤„ç†èŠå¤©è¯·æ±‚æ—¶å‡ºé”™: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">500</span>, detail=<span class="string">f&quot;å¤„ç†è¯·æ±‚å¤±è´¥: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/api/v1/batch_chat&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@monitor_endpoint(<span class="params"><span class="string">&quot;batch_chat&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">batch_chat</span>(<span class="params">requests: <span class="type">List</span>[ChatRequest]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ‰¹é‡èŠå¤©APIï¼Œç”¨äºæ€§èƒ½æµ‹è¯•</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    responses = []</span><br><span class="line">    <span class="keyword">for</span> req <span class="keyword">in</span> requests:</span><br><span class="line">        response = <span class="keyword">await</span> chat(req)</span><br><span class="line">        responses.append(response)</span><br><span class="line">    <span class="keyword">return</span> responses</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> uvicorn</span><br><span class="line">    uvicorn.run(app, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8000</span>, workers=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3 id="5-2-Golangç”Ÿäº§çº§å®ç°"><a href="#5-2-Golangç”Ÿäº§çº§å®ç°" class="headerlink" title="5.2 Golangç”Ÿäº§çº§å®ç°"></a>5.2 Golangç”Ÿäº§çº§å®ç°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;os/signal&quot;</span></span><br><span class="line"><span class="string">&quot;syscall&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/prometheus/client_golang/prometheus&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/prometheus/client_golang/prometheus/promhttp&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/redis/go-redis/v9&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">ModelPath      <span class="type">string</span>        <span class="string">`json:&quot;model_path&quot;`</span></span><br><span class="line">RedisAddr      <span class="type">string</span>        <span class="string">`json:&quot;redis_addr&quot;`</span></span><br><span class="line">RedisPassword  <span class="type">string</span>        <span class="string">`json:&quot;redis_password&quot;`</span></span><br><span class="line">Port           <span class="type">string</span>        <span class="string">`json:&quot;port&quot;`</span></span><br><span class="line">MaxTokens      <span class="type">int</span>           <span class="string">`json:&quot;max_tokens&quot;`</span></span><br><span class="line">Temperature    <span class="type">float32</span>       <span class="string">`json:&quot;temperature&quot;`</span></span><br><span class="line">TopP           <span class="type">float32</span>       <span class="string">`json:&quot;top_p&quot;`</span></span><br><span class="line">Timeout        time.Duration <span class="string">`json:&quot;timeout&quot;`</span></span><br><span class="line">LogLevel       <span class="type">string</span>        <span class="string">`json:&quot;log_level&quot;`</span></span><br><span class="line">MetricsEnabled <span class="type">bool</span>          <span class="string">`json:&quot;metrics_enabled&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯·æ±‚å’Œå“åº”ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">Role    <span class="type">string</span> <span class="string">`json:&quot;role&quot;`</span></span><br><span class="line">Content <span class="type">string</span> <span class="string">`json:&quot;content&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ChatRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">History    []Message <span class="string">`json:&quot;history&quot;`</span></span><br><span class="line">UserQuery  <span class="type">string</span>    <span class="string">`json:&quot;user_query&quot;`</span></span><br><span class="line">SessionID  <span class="type">string</span>    <span class="string">`json:&quot;session_id&quot;`</span></span><br><span class="line">Category   <span class="type">string</span>    <span class="string">`json:&quot;category&quot;`</span></span><br><span class="line">MaxTokens  <span class="type">int</span>       <span class="string">`json:&quot;max_tokens,omitempty&quot;`</span></span><br><span class="line">Temperature <span class="type">float32</span>   <span class="string">`json:&quot;temperature,omitempty&quot;`</span></span><br><span class="line">TopP       <span class="type">float32</span>   <span class="string">`json:&quot;top_p,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ChatResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">Response       <span class="type">string</span>  <span class="string">`json:&quot;response&quot;`</span></span><br><span class="line">SessionID      <span class="type">string</span>  <span class="string">`json:&quot;session_id&quot;`</span></span><br><span class="line">Confidence     <span class="type">float32</span> <span class="string">`json:&quot;confidence&quot;`</span></span><br><span class="line">Category       <span class="type">string</span>  <span class="string">`json:&quot;category&quot;`</span></span><br><span class="line">ResponseTime   <span class="type">float64</span> <span class="string">`json:&quot;response_time&quot;`</span></span><br><span class="line">TokensGenerated <span class="type">int</span>     <span class="string">`json:&quot;tokens_generated&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¢æœæœåŠ¡ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">type</span> CustomerService <span class="keyword">struct</span> &#123;</span><br><span class="line">config      *Config</span><br><span class="line">redisClient *redis.Client</span><br><span class="line">metrics     *ServiceMetrics</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æ§æŒ‡æ ‡</span></span><br><span class="line"><span class="keyword">type</span> ServiceMetrics <span class="keyword">struct</span> &#123;</span><br><span class="line">requestCount   *prometheus.CounterVec</span><br><span class="line">responseTime   *prometheus.HistogramVec</span><br><span class="line">confidenceHist *prometheus.HistogramVec</span><br><span class="line">activeSessions prometheus.Gauge</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServiceMetrics</span><span class="params">()</span></span> *ServiceMetrics &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;ServiceMetrics&#123;</span><br><span class="line">requestCount: prometheus.NewCounterVec(</span><br><span class="line">prometheus.CounterOpts&#123;</span><br><span class="line">Name: <span class="string">&quot;customer_service_requests_total&quot;</span>,</span><br><span class="line">Help: <span class="string">&quot;Total number of customer service requests&quot;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">[]<span class="type">string</span>&#123;<span class="string">&quot;endpoint&quot;</span>, <span class="string">&quot;status_code&quot;</span>, <span class="string">&quot;category&quot;</span>&#125;,</span><br><span class="line">),</span><br><span class="line">responseTime: prometheus.NewHistogramVec(</span><br><span class="line">prometheus.HistogramOpts&#123;</span><br><span class="line">Name:    <span class="string">&quot;customer_service_response_seconds&quot;</span>,</span><br><span class="line">Help:    <span class="string">&quot;Response time in seconds&quot;</span>,</span><br><span class="line">Buckets: []<span class="type">float64</span>&#123;<span class="number">0.1</span>, <span class="number">0.5</span>, <span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">5.0</span>, <span class="number">10.0</span>&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">[]<span class="type">string</span>&#123;<span class="string">&quot;endpoint&quot;</span>, <span class="string">&quot;category&quot;</span>&#125;,</span><br><span class="line">),</span><br><span class="line">confidenceHist: prometheus.NewHistogramVec(</span><br><span class="line">prometheus.HistogramOpts&#123;</span><br><span class="line">Name:    <span class="string">&quot;customer_service_confidence&quot;</span>,</span><br><span class="line">Help:    <span class="string">&quot;Response confidence scores&quot;</span>,</span><br><span class="line">Buckets: []<span class="type">float64</span>&#123;<span class="number">0.1</span>, <span class="number">0.3</span>, <span class="number">0.5</span>, <span class="number">0.7</span>, <span class="number">0.9</span>, <span class="number">1.0</span>&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">[]<span class="type">string</span>&#123;<span class="string">&quot;category&quot;</span>&#125;,</span><br><span class="line">),</span><br><span class="line">activeSessions: prometheus.NewGauge(</span><br><span class="line">prometheus.GaugeOpts&#123;</span><br><span class="line">Name: <span class="string">&quot;customer_service_active_sessions&quot;</span>,</span><br><span class="line">Help: <span class="string">&quot;Number of active chat sessions&quot;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ServiceMetrics)</span></span> Register() &#123;</span><br><span class="line">prometheus.MustRegister(m.requestCount)</span><br><span class="line">prometheus.MustRegister(m.responseTime)</span><br><span class="line">prometheus.MustRegister(m.confidenceHist)</span><br><span class="line">prometheus.MustRegister(m.activeSessions)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ServiceMetrics)</span></span> RecordRequest(endpoint, statusCode, category <span class="type">string</span>) &#123;</span><br><span class="line">m.requestCount.WithLabelValues(endpoint, statusCode, category).Inc()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ServiceMetrics)</span></span> RecordResponseTime(endpoint, category <span class="type">string</span>, duration <span class="type">float64</span>) &#123;</span><br><span class="line">m.responseTime.WithLabelValues(endpoint, category).Observe(duration)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ServiceMetrics)</span></span> RecordConfidence(category <span class="type">string</span>, confidence <span class="type">float32</span>) &#123;</span><br><span class="line">m.confidenceHist.WithLabelValues(category).Observe(<span class="type">float64</span>(confidence))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ServiceMetrics)</span></span> IncActiveSessions() &#123;</span><br><span class="line">m.activeSessions.Inc()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ServiceMetrics)</span></span> DecActiveSessions() &#123;</span><br><span class="line">m.activeSessions.Dec()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°å»ºå®¢æœæœåŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCustomerService</span><span class="params">(config *Config)</span></span> (*CustomerService, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–Rediså®¢æˆ·ç«¯ï¼ˆç”¨äºä¼šè¯ç®¡ç†å’Œç¼“å­˜ï¼‰</span></span><br><span class="line">redisClient := redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">Addr:     config.RedisAddr,</span><br><span class="line">Password: config.RedisPassword,</span><br><span class="line">DB:       <span class="number">0</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•Redisè¿æ¥</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"><span class="keyword">if</span> _, err := redisClient.Ping(ctx).Result(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;è­¦å‘Š: Redisè¿æ¥å¤±è´¥: %vï¼Œå°†ä½¿ç”¨å†…å­˜ç¼“å­˜&quot;</span>, err)</span><br><span class="line">redisClient = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ç›‘æ§æŒ‡æ ‡</span></span><br><span class="line">metrics := NewServiceMetrics()</span><br><span class="line"><span class="keyword">if</span> config.MetricsEnabled &#123;</span><br><span class="line">metrics.Register()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">service := &amp;CustomerService&#123;</span><br><span class="line">config:      config,</span><br><span class="line">redisClient: redisClient,</span><br><span class="line">metrics:     metrics,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> service, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Pythonåç«¯é€šä¿¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CustomerService)</span></span> callPythonBackend(ctx context.Context, request *ChatRequest) (*ChatResponse, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// æ„å»ºè¯·æ±‚</span></span><br><span class="line">jsonData, err := json.Marshal(request)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;åºåˆ—åŒ–è¯·æ±‚å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºHTTPè¯·æ±‚</span></span><br><span class="line">req, err := http.NewRequestWithContext(ctx, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://localhost:8000/api/v1/chat&quot;</span>, </span><br><span class="line">bytes.NewBuffer(jsonData))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;åˆ›å»ºè¯·æ±‚å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req.Header.Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;X-Request-ID&quot;</span>, fmt.Sprintf(<span class="string">&quot;req_%d&quot;</span>, time.Now().UnixNano()))</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€è¯·æ±‚</span></span><br><span class="line">client := &amp;http.Client&#123;</span><br><span class="line">Timeout: s.config.Timeout,</span><br><span class="line">&#125;</span><br><span class="line">resp, err := client.Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;è¯·æ±‚å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥çŠ¶æ€ç </span></span><br><span class="line"><span class="keyword">if</span> resp.StatusCode != http.StatusOK &#123;</span><br><span class="line">body, _ := io.ReadAll(resp.Body)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;åç«¯è¿”å›é”™è¯¯çŠ¶æ€ç  %d: %s&quot;</span>, resp.StatusCode, <span class="type">string</span>(body))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§£æå“åº”</span></span><br><span class="line"><span class="keyword">var</span> response ChatResponse</span><br><span class="line"><span class="keyword">if</span> err := json.NewDecoder(resp.Body).Decode(&amp;response); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;è§£æå“åº”å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;response, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†èŠå¤©è¯·æ±‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CustomerService)</span></span> HandleChat(c *gin.Context) &#123;</span><br><span class="line">startTime := time.Now()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¢åŠ æ´»è·ƒä¼šè¯æ•°</span></span><br><span class="line">s.metrics.IncActiveSessions()</span><br><span class="line"><span class="keyword">defer</span> s.metrics.DecActiveSessions()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> req ChatRequest</span><br><span class="line"><span class="keyword">if</span> err := c.ShouldBindJSON(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">s.metrics.RecordRequest(<span class="string">&quot;chat&quot;</span>, <span class="string">&quot;400&quot;</span>, <span class="string">&quot;invalid&quot;</span>)</span><br><span class="line">c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;æ— æ•ˆçš„è¯·æ±‚æ ¼å¼&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®é»˜è®¤å€¼</span></span><br><span class="line"><span class="keyword">if</span> req.MaxTokens == <span class="number">0</span> &#123;</span><br><span class="line">req.MaxTokens = s.config.MaxTokens</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> req.Temperature == <span class="number">0</span> &#123;</span><br><span class="line">req.Temperature = s.config.Temperature</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> req.TopP == <span class="number">0</span> &#123;</span><br><span class="line">req.TopP = s.config.TopP</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> req.Category == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">req.Category = <span class="string">&quot;general&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆä¼šè¯ID</span></span><br><span class="line"><span class="keyword">if</span> req.SessionID == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">req.SessionID = fmt.Sprintf(<span class="string">&quot;session_%d&quot;</span>, time.Now().UnixNano())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®è¶…æ—¶</span></span><br><span class="line">ctx, cancel := context.WithTimeout(c.Request.Context(), s.config.Timeout)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨Pythonåç«¯</span></span><br><span class="line">response, err := s.callPythonBackend(ctx, &amp;req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;ç”Ÿæˆå“åº”å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">s.metrics.RecordRequest(<span class="string">&quot;chat&quot;</span>, <span class="string">&quot;500&quot;</span>, req.Category)</span><br><span class="line">c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•æŒ‡æ ‡</span></span><br><span class="line">duration := time.Since(startTime).Seconds()</span><br><span class="line">s.metrics.RecordRequest(<span class="string">&quot;chat&quot;</span>, <span class="string">&quot;200&quot;</span>, req.Category)</span><br><span class="line">s.metrics.RecordResponseTime(<span class="string">&quot;chat&quot;</span>, req.Category, duration)</span><br><span class="line">s.metrics.RecordConfidence(req.Category, response.Confidence)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•åˆ°Redisï¼ˆå¦‚æœå¯ç”¨ï¼‰</span></span><br><span class="line"><span class="keyword">if</span> s.redisClient != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line">key := fmt.Sprintf(<span class="string">&quot;session:%s&quot;</span>, req.SessionID)</span><br><span class="line"></span><br><span class="line">sessionData := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;last_query&quot;</span>:  req.UserQuery,</span><br><span class="line"><span class="string">&quot;last_response&quot;</span>: response.Response,</span><br><span class="line"><span class="string">&quot;category&quot;</span>: req.Category,</span><br><span class="line"><span class="string">&quot;confidence&quot;</span>: response.Confidence,</span><br><span class="line"><span class="string">&quot;timestamp&quot;</span>: time.Now().Unix(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jsonData, _ := json.Marshal(sessionData)</span><br><span class="line">s.redisClient.Set(ctx, key, <span class="type">string</span>(jsonData), <span class="number">24</span>*time.Hour)</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å“åº”</span></span><br><span class="line">c.JSON(http.StatusOK, response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¥åº·æ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *CustomerService)</span></span> HealthCheck(c *gin.Context) &#123;</span><br><span class="line">status := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;status&quot;</span>:      <span class="string">&quot;healthy&quot;</span>,</span><br><span class="line"><span class="string">&quot;service&quot;</span>:     <span class="string">&quot;customer-service-api&quot;</span>,</span><br><span class="line"><span class="string">&quot;version&quot;</span>:     <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line"><span class="string">&quot;timestamp&quot;</span>:   time.Now().Format(time.RFC3339),</span><br><span class="line"><span class="string">&quot;uptime&quot;</span>:      time.Since(startTime).String(),</span><br><span class="line"><span class="string">&quot;model_path&quot;</span>:  s.config.ModelPath,</span><br><span class="line"><span class="string">&quot;redis_connected&quot;</span>: s.redisClient != <span class="literal">nil</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥Pythonåç«¯</span></span><br><span class="line">pythonHealth := checkPythonBackend()</span><br><span class="line">status[<span class="string">&quot;python_backend&quot;</span>] = pythonHealth</span><br><span class="line"></span><br><span class="line">c.JSON(http.StatusOK, status)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkPythonBackend</span><span class="params">()</span></span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">2</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">resp, err := http.Get(<span class="string">&quot;http://localhost:8000/health&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;status&quot;</span>: <span class="string">&quot;unhealthy&quot;</span>,</span><br><span class="line"><span class="string">&quot;error&quot;</span>:  err.Error(),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> resp.StatusCode != http.StatusOK &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;status&quot;</span>: <span class="string">&quot;unhealthy&quot;</span>,</span><br><span class="line"><span class="string">&quot;code&quot;</span>:   resp.StatusCode,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> healthData <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> err := json.NewDecoder(resp.Body).Decode(&amp;healthData); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;status&quot;</span>: <span class="string">&quot;degraded&quot;</span>,</span><br><span class="line"><span class="string">&quot;error&quot;</span>:  err.Error(),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;status&quot;</span>: <span class="string">&quot;healthy&quot;</span>,</span><br><span class="line"><span class="string">&quot;data&quot;</span>:   healthData,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½é…ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadConfig</span><span class="params">()</span></span> (*Config, <span class="type">error</span>) &#123;</span><br><span class="line">configPath := os.Getenv(<span class="string">&quot;CONFIG_PATH&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> configPath == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">configPath = <span class="string">&quot;./config.json&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">file, err := os.Open(configPath)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// ä½¿ç”¨é»˜è®¤é…ç½®</span></span><br><span class="line"><span class="keyword">return</span> &amp;Config&#123;</span><br><span class="line">ModelPath:      <span class="string">&quot;./qwen_ecommerce_quantized&quot;</span>,</span><br><span class="line">RedisAddr:      <span class="string">&quot;localhost:6379&quot;</span>,</span><br><span class="line">RedisPassword:  <span class="string">&quot;&quot;</span>,</span><br><span class="line">Port:           <span class="string">&quot;8080&quot;</span>,</span><br><span class="line">MaxTokens:      <span class="number">256</span>,</span><br><span class="line">Temperature:    <span class="number">0.3</span>,</span><br><span class="line">TopP:           <span class="number">0.85</span>,</span><br><span class="line">Timeout:        <span class="number">30</span> * time.Second,</span><br><span class="line">LogLevel:       <span class="string">&quot;info&quot;</span>,</span><br><span class="line">MetricsEnabled: <span class="literal">true</span>,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> config Config</span><br><span class="line"><span class="keyword">if</span> err := json.NewDecoder(file).Decode(&amp;config); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;è§£æé…ç½®æ–‡ä»¶å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»ç¯å¢ƒå˜é‡è¦†ç›–</span></span><br><span class="line"><span class="keyword">if</span> port := os.Getenv(<span class="string">&quot;PORT&quot;</span>); port != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">config.Port = port</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> redisAddr := os.Getenv(<span class="string">&quot;REDIS_ADDR&quot;</span>); redisAddr != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">config.RedisAddr = redisAddr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;config, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> startTime time.Time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">startTime = time.Now()</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½é…ç½®</span></span><br><span class="line">config, err := loadConfig()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;åŠ è½½é…ç½®å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–Gin</span></span><br><span class="line">gin.SetMode(gin.ReleaseMode)</span><br><span class="line"><span class="keyword">if</span> config.LogLevel == <span class="string">&quot;debug&quot;</span> &#123;</span><br><span class="line">gin.SetMode(gin.DebugMode)</span><br><span class="line">&#125;</span><br><span class="line">r := gin.Default()</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–å®¢æœæœåŠ¡</span></span><br><span class="line">service, err := NewCustomerService(config)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;åˆå§‹åŒ–æœåŠ¡å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œè·¯ç”±</span></span><br><span class="line">r.POST(<span class="string">&quot;/api/v1/chat&quot;</span>, service.HandleChat)</span><br><span class="line">r.GET(<span class="string">&quot;/health&quot;</span>, service.HealthCheck)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‡æ ‡ç«¯ç‚¹</span></span><br><span class="line"><span class="keyword">if</span> config.MetricsEnabled &#123;</span><br><span class="line">r.GET(<span class="string">&quot;/metrics&quot;</span>, gin.WrapH(promhttp.Handler()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜é›…å…³é—­</span></span><br><span class="line">quit := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">addr := <span class="string">&quot;:&quot;</span> + config.Port</span><br><span class="line">log.Printf(<span class="string">&quot;å®¢æœæœåŠ¡å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ %s&quot;</span>, addr)</span><br><span class="line"><span class="keyword">if</span> err := r.Run(addr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…å…³é—­ä¿¡å·</span></span><br><span class="line">&lt;-quit</span><br><span class="line">log.Println(<span class="string">&quot;æ­£åœ¨å…³é—­æœåŠ¡...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­Redisè¿æ¥</span></span><br><span class="line"><span class="keyword">if</span> service.redisClient != <span class="literal">nil</span> &#123;</span><br><span class="line">service.redisClient.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ</span></span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"><span class="keyword">if</span> err := r.Shutdown(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;å¼ºåˆ¶å…³é—­: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log.Println(<span class="string">&quot;æœåŠ¡å·²å®‰å…¨å…³é—­&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹"><a href="#5-3-å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹" class="headerlink" title="5.3 å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹"></a>5.3 å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># client_example.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomerServiceClient</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, api_url=<span class="string">&quot;http://localhost:8080&quot;</span></span>):</span><br><span class="line">        self.api_url = api_url</span><br><span class="line">        self.session_id = <span class="string">f&quot;session_<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">chat</span>(<span class="params">self, user_query, history=<span class="literal">None</span>, category=<span class="string">&quot;general&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä¸å®¢æœå¯¹è¯</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> history <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            history = []</span><br><span class="line">        </span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">&quot;history&quot;</span>: history,</span><br><span class="line">            <span class="string">&quot;user_query&quot;</span>: user_query,</span><br><span class="line">            <span class="string">&quot;session_id&quot;</span>: self.session_id,</span><br><span class="line">            <span class="string">&quot;category&quot;</span>: category,</span><br><span class="line">            <span class="string">&quot;max_tokens&quot;</span>: <span class="number">256</span>,</span><br><span class="line">            <span class="string">&quot;temperature&quot;</span>: <span class="number">0.3</span>,</span><br><span class="line">            <span class="string">&quot;top_p&quot;</span>: <span class="number">0.85</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            response = requests.post(</span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;self.api_url&#125;</span>/api/v1/chat&quot;</span>,</span><br><span class="line">                json=payload,</span><br><span class="line">                headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;,</span><br><span class="line">                timeout=<span class="number">30</span></span><br><span class="line">            )</span><br><span class="line">            latency = time.time() - start_time</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> response.status_code != <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : <span class="subst">&#123;response.status_code&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;å“åº”å†…å®¹: <span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            </span><br><span class="line">            result = response.json()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;å“åº”æ—¶é—´: <span class="subst">&#123;latency:<span class="number">.3</span>f&#125;</span>ç§’&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;ç½®ä¿¡åº¦: <span class="subst">&#123;result[<span class="string">&#x27;confidence&#x27;</span>]:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;ç”Ÿæˆtokenæ•°: <span class="subst">&#123;result[<span class="string">&#x27;tokens_generated&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;è¯·æ±‚å¼‚å¸¸: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_chat</span>(<span class="params">self, queries, category=<span class="string">&quot;general&quot;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ‰¹é‡å¯¹è¯æµ‹è¯•</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> query <span class="keyword">in</span> queries:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\nè¯¢é—®: <span class="subst">&#123;query&#125;</span>&quot;</span>)</span><br><span class="line">            result = self.chat(query, category=category)</span><br><span class="line">            <span class="keyword">if</span> result:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;å›ç­”: <span class="subst">&#123;result[<span class="string">&#x27;response&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                results.append(result)</span><br><span class="line">            time.sleep(<span class="number">0.5</span>)  <span class="comment"># é¿å…è¯·æ±‚è¿‡å¿«</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    client = CustomerServiceClient()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æµ‹è¯•ç”¨ä¾‹ï¼ˆç”µå•†å®¢æœåœºæ™¯ï¼‰</span></span><br><span class="line">    test_queries = [</span><br><span class="line">        (<span class="string">&quot;æˆ‘çš„è®¢å•123456ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ&quot;</span>, <span class="string">&quot;order&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;é€€è´§æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ&quot;</span>, <span class="string">&quot;return&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;è¿™ä»¶è¡£æœæœ‰ä¼˜æƒ åˆ¸å—ï¼Ÿ&quot;</span>, <span class="string">&quot;product&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;æˆ‘çš„åŒ…è£¹åœ¨å“ªé‡Œï¼Ÿ&quot;</span>, <span class="string">&quot;logistics&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;æˆ‘å¯¹æœåŠ¡è´¨é‡å¾ˆä¸æ»¡æ„ï¼&quot;</span>, <span class="string">&quot;complaint&quot;</span>)</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== ç”µå•†å®¢æœå¯¹è¯æµ‹è¯• ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä¿æŒå¯¹è¯å†å²</span></span><br><span class="line">    history = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> query, category <span class="keyword">in</span> test_queries:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n<span class="subst">&#123;<span class="string">&#x27;=&#x27;</span>*<span class="number">50</span>&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ç”¨æˆ·: <span class="subst">&#123;query&#125;</span> (ç±»åˆ«: <span class="subst">&#123;category&#125;</span>)&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        result = client.chat(query, history=history, category=category)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;å®¢æœ: <span class="subst">&#123;result[<span class="string">&#x27;response&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ›´æ–°å¯¹è¯å†å²</span></span><br><span class="line">            history.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: query&#125;)</span><br><span class="line">            history.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;content&quot;</span>: result[<span class="string">&#x27;response&#x27;</span>]&#125;)</span><br><span class="line">        </span><br><span class="line">        time.sleep(<span class="number">1</span>)  <span class="comment"># æ¨¡æ‹ŸçœŸå®å¯¹è¯é—´éš”</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ€§èƒ½æµ‹è¯•</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n<span class="subst">&#123;<span class="string">&#x27;=&#x27;</span>*<span class="number">50</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;æ€§èƒ½æµ‹è¯• (10æ¬¡è¿ç»­è¯·æ±‚):&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        result = client.chat(<span class="string">&quot;ä½ å¥½ï¼Œæˆ‘æƒ³æŸ¥è¯¢è®¢å•çŠ¶æ€&quot;</span>, category=<span class="string">&quot;order&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    total_time = time.time() - start_time</span><br><span class="line">    avg_time = total_time / <span class="number">10</span> <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ€»æ—¶é—´: <span class="subst">&#123;total_time:<span class="number">.2</span>f&#125;</span>ç§’, å¹³å‡å“åº”æ—¶é—´: <span class="subst">&#123;avg_time:<span class="number">.3</span>f&#125;</span>ç§’&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="å…­ã€æ€»ç»“ä¸æœ€ä½³å®è·µï¼ˆå› ä¸šåŠ¡åœºæ™¯çš„ä¸åŒï¼Œä»¥ä¸‹ä»…ä¾›å‚è€ƒâš ï¸ï¼‰"><a href="#å…­ã€æ€»ç»“ä¸æœ€ä½³å®è·µï¼ˆå› ä¸šåŠ¡åœºæ™¯çš„ä¸åŒï¼Œä»¥ä¸‹ä»…ä¾›å‚è€ƒâš ï¸ï¼‰" class="headerlink" title="å…­ã€æ€»ç»“ä¸æœ€ä½³å®è·µï¼ˆå› ä¸šåŠ¡åœºæ™¯çš„ä¸åŒï¼Œä»¥ä¸‹ä»…ä¾›å‚è€ƒâš ï¸ï¼‰"></a>å…­ã€æ€»ç»“ä¸æœ€ä½³å®è·µï¼ˆå› ä¸šåŠ¡åœºæ™¯çš„ä¸åŒï¼Œä»¥ä¸‹ä»…ä¾›å‚è€ƒâš ï¸ï¼‰</h2><h3 id="6-1-å…³é”®ç»éªŒæ€»ç»“"><a href="#6-1-å…³é”®ç»éªŒæ€»ç»“" class="headerlink" title="6.1 å…³é”®ç»éªŒæ€»ç»“"></a>6.1 å…³é”®ç»éªŒæ€»ç»“</h3><p>é€šè¿‡åœ¨ç”µå•†å®¢æœåœºæ™¯çš„å®é™…åº”ç”¨ï¼Œæˆ‘ä»¬å¾—å‡ºä»¥ä¸‹å…³é”®ç»éªŒï¼š</p><ol><li><strong>LoRAå‚æ•°é€‰æ‹©</strong>ï¼šå¯¹äºå®¢æœåœºæ™¯ï¼Œr&#x3D;8, alpha&#x3D;32æ˜¯æœ€ä½³å¹³è¡¡ç‚¹ï¼Œæ—¢èƒ½æ•è·è¶³å¤Ÿä¿¡æ¯ï¼Œåˆä¸ä¼šè¿‡æ‹Ÿåˆ</li><li><strong>æ¨¡å—é€‰æ‹©</strong>ï¼šAttentionå±‚çš„q_proj, v_proj, o_projå’ŒFFNå±‚çš„gate_proj, up_projæ˜¯å…³é”®æ¨¡å—</li><li><strong>æ•°æ®è´¨é‡</strong>ï¼šå®¢æœå¯¹è¯æ•°æ®çš„è´¨é‡æ¯”æ•°é‡æ›´é‡è¦ï¼Œ10Ké«˜è´¨é‡æ ·æœ¬ä¼˜äº100Kä½è´¨é‡æ ·æœ¬</li><li><strong>é¢†åŸŸé€‚åº”</strong>ï¼šé€šè¿‡RAGæœºåˆ¶è¡¥å……å®æ—¶çŸ¥è¯†ï¼Œè§£å†³æ¨¡å‹çŸ¥è¯†æ»åé—®é¢˜</li><li><strong>ç½®ä¿¡åº¦é˜ˆå€¼</strong>ï¼šè®¾ç½®0.7çš„ç½®ä¿¡åº¦é˜ˆå€¼ï¼Œä½äºæ­¤å€¼æ—¶è½¬äººå·¥å®¢æœï¼Œæ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ</li></ol><h3 id="6-2-æˆæœ¬æ•ˆç›Šåˆ†æ"><a href="#6-2-æˆæœ¬æ•ˆç›Šåˆ†æ" class="headerlink" title="6.2 æˆæœ¬æ•ˆç›Šåˆ†æ"></a>6.2 æˆæœ¬æ•ˆç›Šåˆ†æ</h3><table><thead><tr><th>é¡¹ç›®</th><th>LoRAå¾®è°ƒæ–¹æ¡ˆ</th><th>å…¨å‚æ•°å¾®è°ƒ</th><th>ä¼ ç»Ÿäººå·¥å®¢æœ</th></tr></thead><tbody><tr><td>åˆå§‹æŠ•å…¥</td><td>$18.5</td><td>$114.2</td><td>$0</td></tr><tr><td>å•è¯·æ±‚æˆæœ¬</td><td>$0.00035</td><td>$0.0021</td><td>$0.56</td></tr><tr><td>æ—¥å¤„ç†èƒ½åŠ›</td><td>50,000+</td><td>50,000+</td><td>2,000</td></tr><tr><td>å‡†ç¡®ç‡</td><td>89.7%</td><td>91.2%</td><td>95.8%</td></tr><tr><td>ROIå‘¨æœŸ</td><td>&lt;1å°æ—¶</td><td>6å°æ—¶</td><td>-</td></tr></tbody></table><h3 id="6-3-æœªæ¥å‘å±•æ–¹å‘"><a href="#6-3-æœªæ¥å‘å±•æ–¹å‘" class="headerlink" title="6.3 æœªæ¥å‘å±•æ–¹å‘"></a>6.3 æœªæ¥å‘å±•æ–¹å‘</h3><ol><li><strong>è‡ªåŠ¨LoRAé…ç½®</strong>ï¼šåŸºäºä»»åŠ¡å¤æ‚åº¦å’Œæ•°æ®ç‰¹æ€§è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å‚æ•°</li><li><strong>å¤šæ¨¡æ€å®¢æœ</strong>ï¼šç»“åˆå›¾åƒè¯†åˆ«ï¼Œå¤„ç†å•†å“å›¾ç‰‡å’¨è¯¢</li><li><strong>è”é‚¦å­¦ä¹ </strong>ï¼šåœ¨ä¿æŠ¤éšç§çš„å‰æä¸‹ï¼Œè·¨ä¼ä¸šè”åˆè®­ç»ƒå®¢æœæ¨¡å‹  </li><li><strong>è¾¹ç¼˜éƒ¨ç½²</strong>ï¼šä¼˜åŒ–åçš„LoRAæ¨¡å‹å¯åœ¨è¾¹ç¼˜è®¾å¤‡è¿è¡Œï¼Œé™ä½å»¶è¿Ÿ</li></ol><h3 id="6-4-å®æ–½å»ºè®®æ€»ç»“"><a href="#6-4-å®æ–½å»ºè®®æ€»ç»“" class="headerlink" title="6.4 å®æ–½å»ºè®®æ€»ç»“"></a>6.4 å®æ–½å»ºè®®æ€»ç»“</h3><ol><li><strong>å¼€å‘é˜¶æ®µ</strong>ï¼šä½¿ç”¨Pythonå¿«é€Ÿè¿­ä»£ï¼ŒéªŒè¯æ•ˆæœ</li><li><strong>ç”Ÿäº§éƒ¨ç½²</strong>ï¼šGolangä½œä¸ºAPIå±‚ï¼ŒPythonä½œä¸ºæ¨ç†åç«¯</li><li><strong>ç›‘æ§ä½“ç³»</strong>ï¼šå»ºç«‹å®Œæ•´çš„Prometheus+Grafanaç›‘æ§ä½“ç³»</li><li><strong>æŒç»­ä¼˜åŒ–</strong>ï¼šæ¯å‘¨å¢é‡è®­ç»ƒï¼Œä¿æŒæ¨¡å‹æ—¶æ•ˆæ€§</li><li><strong>äººå·¥å…œåº•</strong>ï¼šç½®ä¿¡åº¦&lt;0.7æ—¶è‡ªåŠ¨è½¬äººå·¥ï¼Œç¡®ä¿æœåŠ¡è´¨é‡</li></ol><p>é€šè¿‡æœ¬æ–‡çš„å®Œæ•´æŒ‡å—ï¼Œæ‚¨ç°åœ¨æ‹¥æœ‰ï¼š<br>âœ… æ·±å…¥ç†è§£LoRAçš„æ•°å­¦åŸç†å’Œå·¥ä½œæœºåˆ¶<br>âœ… ç”µå•†å®¢æœåœºæ™¯çš„å®é™…æ¡ˆä¾‹å’Œæ•°æ®<br>âœ… å®Œæ•´çš„å‚æ•°é…ç½®æœ€ä½³å®è·µ<br>âœ… Pythonå¼€å‘ç¯å¢ƒå’ŒGolangç”Ÿäº§ç¯å¢ƒçš„å®Œæ•´å®ç°<br>âœ… ä»æ•°æ®å‡†å¤‡åˆ°ä¸Šçº¿éƒ¨ç½²çš„å…¨æµç¨‹æŒ‡å¯¼</p><p><strong>è¦ç‚¹æ€»ç»“</strong>ï¼š<strong>LoRAå¾®è°ƒä¸æ˜¯ä¸€æ¬¡æ€§çš„ä»»åŠ¡</strong>ï¼Œè€Œæ˜¯ä¸€ä¸ªæŒç»­è¿­ä»£çš„è¿‡ç¨‹ã€‚é€šè¿‡ç›‘æ§ç”¨æˆ·åé¦ˆï¼Œä¸æ–­ä¼˜åŒ–æ•°æ®å’Œå‚æ•°ï¼Œæ‚¨çš„å®¢æœç³»ç»Ÿå°†å˜å¾—è¶Šæ¥è¶Šæ™ºèƒ½å’Œé«˜æ•ˆã€‚</p><h2 id="ä¸ƒã€LoRAå¾®è°ƒä¼˜ç‚¹å¾ˆå¤šï¼Œä½†ä¹Ÿä¼´éšç€ç¼ºç‚¹ä¸å±€é™æ€§âš ï¸"><a href="#ä¸ƒã€LoRAå¾®è°ƒä¼˜ç‚¹å¾ˆå¤šï¼Œä½†ä¹Ÿä¼´éšç€ç¼ºç‚¹ä¸å±€é™æ€§âš ï¸" class="headerlink" title="ä¸ƒã€LoRAå¾®è°ƒä¼˜ç‚¹å¾ˆå¤šï¼Œä½†ä¹Ÿä¼´éšç€ç¼ºç‚¹ä¸å±€é™æ€§âš ï¸"></a>ä¸ƒã€LoRAå¾®è°ƒä¼˜ç‚¹å¾ˆå¤šï¼Œä½†ä¹Ÿä¼´éšç€ç¼ºç‚¹ä¸å±€é™æ€§âš ï¸</h2><h3 id="LoRAå¾®è°ƒçš„ç¼ºç‚¹ä¸å±€é™æ€§"><a href="#LoRAå¾®è°ƒçš„ç¼ºç‚¹ä¸å±€é™æ€§" class="headerlink" title="LoRAå¾®è°ƒçš„ç¼ºç‚¹ä¸å±€é™æ€§"></a>LoRAå¾®è°ƒçš„ç¼ºç‚¹ä¸å±€é™æ€§</h3><p>è™½ç„¶LoRAï¼ˆLow-Rank Adaptationï¼‰ä½œä¸ºå‚æ•°é«˜æ•ˆå¾®è°ƒï¼ˆPEFTï¼‰æŠ€æœ¯åœ¨å¤§è¯­è¨€æ¨¡å‹å¾®è°ƒä¸­è¡¨ç°å‡ºè‰²ï¼Œä½†å®ƒä¹Ÿå­˜åœ¨ä¸€äº›æ˜æ˜¾çš„ç¼ºç‚¹å’Œå±€é™æ€§ã€‚</p><h3 id="1-è¡¨è¾¾èƒ½åŠ›å—é™"><a href="#1-è¡¨è¾¾èƒ½åŠ›å—é™" class="headerlink" title="1. è¡¨è¾¾èƒ½åŠ›å—é™"></a>1. <strong>è¡¨è¾¾èƒ½åŠ›å—é™</strong></h3><ul><li><strong>ä½ç§©çº¦æŸ</strong>ï¼šLoRAé€šè¿‡ä½ç§©åˆ†è§£ï¼ˆé€šå¸¸ç§©r&#x3D;4-16ï¼‰è¿‘ä¼¼æƒé‡æ›´æ–°ï¼Œè¿™é™åˆ¶äº†æ¨¡å‹èƒ½å¤Ÿå­¦ä¹ çš„å‚æ•°ç©ºé—´èŒƒå›´</li><li><strong>å¤æ‚ä»»åŠ¡è¡¨ç°ä¸ä½³</strong>ï¼šå¯¹äºéœ€è¦å¤§é‡å‚æ•°æ›´æ–°çš„å¤æ‚ä»»åŠ¡ï¼ˆå¦‚å¤šè¯­è¨€ç¿»è¯‘ã€å¤æ‚æ¨ç†ï¼‰ï¼ŒLoRAå¯èƒ½æ— æ³•æ•è·è¶³å¤Ÿçš„ä¿¡æ¯</li><li><strong>å®¹é‡ç“¶é¢ˆ</strong>ï¼šç›¸æ¯”å…¨å‚æ•°å¾®è°ƒï¼ŒLoRAçš„å¯è®­ç»ƒå‚æ•°é€šå¸¸åªæœ‰åŸå§‹æ¨¡å‹çš„0.1%-1%ï¼Œåœ¨æ•°æ®ä¸°å¯Œåœºæ™¯ä¸‹å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ</li></ul><h3 id="2-è¶…å‚æ•°æ•æ„Ÿæ€§é«˜"><a href="#2-è¶…å‚æ•°æ•æ„Ÿæ€§é«˜" class="headerlink" title="2. è¶…å‚æ•°æ•æ„Ÿæ€§é«˜"></a>2. <strong>è¶…å‚æ•°æ•æ„Ÿæ€§é«˜</strong></h3><ul><li><strong>ç§©(rank)é€‰æ‹©å›°éš¾</strong>ï¼šç§©rçš„é€‰æ‹©å¯¹æ€§èƒ½å½±å“å·¨å¤§ï¼Œè¿‡å°å¯¼è‡´æ¬ æ‹Ÿåˆï¼Œè¿‡å¤§å¤±å»å‚æ•°æ•ˆç‡ä¼˜åŠ¿</li><li><strong>alpha&#x2F;ræ¯”ä¾‹è°ƒä¼˜å¤æ‚</strong>ï¼šlora_alphaä¸ç§©çš„æ¯”ä¾‹éœ€è¦ä»”ç»†è°ƒä¼˜ï¼Œä¸åŒä»»åŠ¡å’Œæ¨¡å‹æ¶æ„éœ€è¦ä¸åŒé…ç½®</li><li><strong>æ¨¡å—é€‰æ‹©ä¾èµ–ç»éªŒ</strong>ï¼šé€‰æ‹©å“ªäº›æ¨¡å—åº”ç”¨LoRAï¼ˆq_proj, v_proj, o_projç­‰ï¼‰éœ€è¦é¢†åŸŸçŸ¥è¯†ï¼Œé”™è¯¯é€‰æ‹©å¯¼è‡´æ€§èƒ½ä¸‹é™</li><li><strong>ç¼ºä¹è‡ªåŠ¨åŒ–å·¥å…·</strong>ï¼šç›®å‰ç¼ºä¹è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜LoRAé…ç½®çš„æˆç†Ÿå·¥å…·ï¼Œä¾èµ–äººå·¥å®éªŒ</li></ul><h3 id="3-è®­ç»ƒåŠ¨æ€ä¸ç¨³å®š"><a href="#3-è®­ç»ƒåŠ¨æ€ä¸ç¨³å®š" class="headerlink" title="3. è®­ç»ƒåŠ¨æ€ä¸ç¨³å®š"></a>3. <strong>è®­ç»ƒåŠ¨æ€ä¸ç¨³å®š</strong></h3><ul><li><strong>æ¢¯åº¦æµåŠ¨é—®é¢˜</strong>ï¼šä½ç§©çº¦æŸå¯èƒ½é˜»ç¢æ¢¯åº¦çš„æœ‰æ•ˆæµåŠ¨ï¼Œå¯¼è‡´è®­ç»ƒä¸ç¨³å®š</li><li><strong>æ”¶æ•›é€Ÿåº¦æ³¢åŠ¨</strong>ï¼šç›¸æ¯”å…¨å‚æ•°å¾®è°ƒï¼ŒLoRAå¯èƒ½åœ¨æŸäº›ä»»åŠ¡ä¸Šæ”¶æ•›æ›´æ…¢ï¼Œéœ€è¦æ›´å¤šepoch</li><li><strong>å­¦ä¹ ç‡æ•æ„Ÿ</strong>ï¼šLoRAå¯¹å­¦ä¹ ç‡çš„é€‰æ‹©æ›´åŠ æ•æ„Ÿï¼Œä¸å½“çš„å­¦ä¹ ç‡å®¹æ˜“å¯¼è‡´è®­ç»ƒå‘æ•£</li><li><strong>åˆå§‹åŒ–ä¾èµ–æ€§å¼º</strong>ï¼šLoRAæƒé‡çš„åˆå§‹åŒ–æ–¹æ³•ï¼ˆKaimingã€Xavierã€LoftQç­‰ï¼‰æ˜¾è‘—å½±å“æœ€ç»ˆæ€§èƒ½</li></ul><h3 id="4-é¢†åŸŸé€‚åº”å±€é™æ€§"><a href="#4-é¢†åŸŸé€‚åº”å±€é™æ€§" class="headerlink" title="4. é¢†åŸŸé€‚åº”å±€é™æ€§"></a>4. <strong>é¢†åŸŸé€‚åº”å±€é™æ€§</strong></h3><ul><li><strong>é¢†åŸŸåç§»æ•æ„Ÿ</strong>ï¼šå½“ç›®æ ‡é¢†åŸŸä¸é¢„è®­ç»ƒé¢†åŸŸå·®å¼‚å¾ˆå¤§æ—¶ï¼ŒLoRAå¯èƒ½æ— æ³•å……åˆ†é€‚åº”</li><li><strong>çŸ¥è¯†é—å¿˜é—®é¢˜</strong>ï¼šè™½ç„¶æ¯”å…¨å‚æ•°å¾®è°ƒè½»ï¼Œä½†LoRAä»ç„¶å¯èƒ½å¯¼è‡´ä¸€å®šç¨‹åº¦çš„ç¾éš¾æ€§é—å¿˜</li><li><strong>å¤šé¢†åŸŸå†²çª</strong>ï¼šåŒä¸€åŸºç¡€æ¨¡å‹ä¸Šè®­ç»ƒå¤šä¸ªLoRAé€‚é…å™¨æ—¶ï¼Œä¸åŒé¢†åŸŸçŸ¥è¯†å¯èƒ½ç›¸äº’å¹²æ‰°</li><li><strong>é•¿å°¾åˆ†å¸ƒå¤„ç†å›°éš¾</strong>ï¼šå¯¹äºé•¿å°¾åˆ†å¸ƒçš„æ•°æ®ï¼ˆå¦‚ç½•è§ä¸“ä¸šæœ¯è¯­ï¼‰ï¼ŒLoRAçš„æœ‰é™å®¹é‡éš¾ä»¥å……åˆ†å­¦ä¹ </li></ul><h3 id="5-éƒ¨ç½²å¤æ‚æ€§å¢åŠ "><a href="#5-éƒ¨ç½²å¤æ‚æ€§å¢åŠ " class="headerlink" title="5. éƒ¨ç½²å¤æ‚æ€§å¢åŠ "></a>5. <strong>éƒ¨ç½²å¤æ‚æ€§å¢åŠ </strong></h3><ul><li><strong>æƒé‡åˆå¹¶å¼€é”€</strong>ï¼šæ¨ç†å‰éœ€è¦å°†LoRAæƒé‡åˆå¹¶åˆ°åŸºç¡€æ¨¡å‹ï¼Œå¢åŠ äº†éƒ¨ç½²æµç¨‹å¤æ‚æ€§</li><li><strong>ç‰ˆæœ¬ç®¡ç†å›°éš¾</strong>ï¼šå¤šä¸ªLoRAé€‚é…å™¨çš„ç‰ˆæœ¬ç®¡ç†å’Œåˆ‡æ¢éœ€è¦é¢å¤–çš„åŸºç¡€è®¾æ–½æ”¯æŒ</li><li><strong>å†…å­˜ç¢ç‰‡åŒ–</strong>ï¼šåœ¨å¤šä»»åŠ¡åœºæ™¯ä¸‹ï¼Œé¢‘ç¹åŠ è½½&#x2F;å¸è½½ä¸åŒLoRAé€‚é…å™¨å¯èƒ½å¯¼è‡´å†…å­˜ç¢ç‰‡åŒ–</li><li><strong>æ¨ç†å»¶è¿Ÿå¢åŠ </strong>ï¼šè™½ç„¶åˆå¹¶åæ— å½±å“ï¼Œä½†åœ¨åŠ¨æ€åˆ‡æ¢LoRAé€‚é…å™¨çš„åœºæ™¯ä¸‹ï¼Œä¼šå¢åŠ æ¨ç†å»¶è¿Ÿ</li></ul><h3 id="6-é‡åŒ–å…¼å®¹æ€§é—®é¢˜"><a href="#6-é‡åŒ–å…¼å®¹æ€§é—®é¢˜" class="headerlink" title="6. é‡åŒ–å…¼å®¹æ€§é—®é¢˜"></a>6. <strong>é‡åŒ–å…¼å®¹æ€§é—®é¢˜</strong></h3><ul><li><strong>4-bité‡åŒ–æŸå¤±</strong>ï¼šä¸QLoRAç»“åˆä½¿ç”¨æ—¶ï¼Œ4-bité‡åŒ–ä¼šè¿›ä¸€æ­¥é™ä½æ¨¡å‹ç²¾åº¦ï¼Œå½±å“æ€§èƒ½</li><li><strong>æ•°å€¼ç¨³å®šæ€§æŒ‘æˆ˜</strong>ï¼šä½ç§©åˆ†è§£åœ¨é‡åŒ–ç¯å¢ƒä¸‹æ›´å®¹æ˜“å‡ºç°æ•°å€¼ä¸ç¨³å®šé—®é¢˜</li><li><strong>ç¡¬ä»¶ä¾èµ–æ€§å¼º</strong>ï¼šæŸäº›ä¼˜åŒ–æŠ€æœ¯ï¼ˆå¦‚LoftQåˆå§‹åŒ–ï¼‰å¯¹ç¡¬ä»¶å’Œè½¯ä»¶ç‰ˆæœ¬æœ‰ç‰¹å®šè¦æ±‚</li><li><strong>æ¢å¤å›°éš¾</strong>ï¼šé‡åŒ–åçš„LoRAæ¨¡å‹éš¾ä»¥æ¢å¤åˆ°åŸå§‹ç²¾åº¦ï¼Œé™åˆ¶äº†åç»­ä¼˜åŒ–ç©ºé—´</li></ul><h3 id="7-æ•°æ®æ•ˆç‡é—®é¢˜"><a href="#7-æ•°æ®æ•ˆç‡é—®é¢˜" class="headerlink" title="7. æ•°æ®æ•ˆç‡é—®é¢˜"></a>7. <strong>æ•°æ®æ•ˆç‡é—®é¢˜</strong></h3><ul><li><strong>å°æ ·æœ¬è¡¨ç°ä¸ç¨³å®š</strong>ï¼šåœ¨æå°æ•°æ®é›†ï¼ˆ&lt;1000æ ·æœ¬ï¼‰ä¸Šï¼ŒLoRAå¯èƒ½è¡¨ç°ä¸å¦‚æç¤ºå·¥ç¨‹æˆ–ä¸Šä¸‹æ–‡å­¦ä¹ </li><li><strong>æ•°æ®è´¨é‡è¦æ±‚é«˜</strong>ï¼šç”±äºå‚æ•°å®¹é‡æœ‰é™ï¼ŒLoRAå¯¹è®­ç»ƒæ•°æ®è´¨é‡æ›´åŠ æ•æ„Ÿï¼Œå™ªå£°æ•°æ®å½±å“æ›´å¤§</li><li><strong>ç±»åˆ«ä¸å¹³è¡¡æ•æ„Ÿ</strong>ï¼šåœ¨ç±»åˆ«ä¸å¹³è¡¡çš„æ•°æ®é›†ä¸Šï¼ŒLoRAå¯èƒ½è¿‡åº¦æ‹Ÿåˆå¤šæ•°ç±»åˆ«</li><li><strong>å†·å¯åŠ¨é—®é¢˜</strong>ï¼šæ–°é¢†åŸŸã€æ–°ä»»åŠ¡çš„åˆå§‹è®­ç»ƒæ•ˆæœå¯èƒ½ä¸å¦‚é¢„æœŸï¼Œéœ€è¦æ›´å¤šè¿­ä»£ä¼˜åŒ–</li></ul><h3 id="8-ç†è®ºå±€é™æ€§"><a href="#8-ç†è®ºå±€é™æ€§" class="headerlink" title="8. ç†è®ºå±€é™æ€§"></a>8. <strong>ç†è®ºå±€é™æ€§</strong></h3><ul><li><strong>ä½ç§©å‡è®¾ä¸ä¸€å®šæˆç«‹</strong>ï¼šæƒé‡æ›´æ–°çŸ©é˜µÎ”Wå¹¶ä¸æ€»æ˜¯å…·æœ‰ä½ç§©ç‰¹æ€§ï¼Œå¼ºåˆ¶ä½ç§©åˆ†è§£å¯èƒ½ä¸¢å¤±é‡è¦ä¿¡æ¯</li><li><strong>ä¼˜åŒ–æ™¯è§‚æ”¹å˜</strong>ï¼šLoRAæ”¹å˜äº†åŸå§‹ä¼˜åŒ–é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´æ”¶æ•›åˆ°æ¬¡ä¼˜è§£</li><li><strong>ç¼ºä¹ç†è®ºä¿è¯</strong>ï¼šç›¸æ¯”å…¨å‚æ•°å¾®è°ƒï¼ŒLoRAç¼ºä¹å……åˆ†çš„ç†è®ºåˆ†ææ¥ä¿è¯å…¶æœ€ä¼˜æ€§</li><li><strong>æ¨¡å‹æ¶æ„ä¾èµ–</strong>ï¼šLoRAçš„æ•ˆæœé«˜åº¦ä¾èµ–äºåŸºç¡€æ¨¡å‹çš„æ¶æ„è®¾è®¡ï¼Œå¯¹ä¸åŒæ¶æ„çš„é€šç”¨æ€§æœ‰é™</li></ul><h3 id="9-è®¡ç®—èµ„æºåˆ†é…ä¸å‡"><a href="#9-è®¡ç®—èµ„æºåˆ†é…ä¸å‡" class="headerlink" title="9. è®¡ç®—èµ„æºåˆ†é…ä¸å‡"></a>9. <strong>è®¡ç®—èµ„æºåˆ†é…ä¸å‡</strong></h3><ul><li><strong>GPUå†…å­˜èŠ‚çœä½†è®¡ç®—ä¸å‡è¡¡</strong>ï¼šè™½ç„¶LoRAèŠ‚çœGPUå†…å­˜ï¼Œä½†è®¡ç®—è´Ÿè½½ä»ç„¶é›†ä¸­åœ¨å°‘æ•°æ¨¡å—</li><li><strong>CPU-GPUé€šä¿¡å¼€é”€</strong>ï¼šåœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼ŒLoRAå¯èƒ½å¢åŠ CPU-GPUä¹‹é—´çš„é€šä¿¡å¼€é”€</li><li><strong>æ‰¹å¤„ç†æ•ˆç‡é™ä½</strong>ï¼šæŸäº›LoRAå®ç°å¯èƒ½é™ä½æ‰¹å¤„ç†æ•ˆç‡ï¼Œå½±å“æ•´ä½“ååé‡</li><li><strong>æ··åˆç²¾åº¦å…¼å®¹æ€§é—®é¢˜</strong>ï¼šåœ¨æ··åˆç²¾åº¦è®­ç»ƒä¸­ï¼ŒLoRAå¯èƒ½å¼•å…¥é¢å¤–çš„æ•°å€¼ç²¾åº¦é—®é¢˜</li></ul><h3 id="10-è¯„ä¼°å’Œè°ƒè¯•å›°éš¾"><a href="#10-è¯„ä¼°å’Œè°ƒè¯•å›°éš¾" class="headerlink" title="10. è¯„ä¼°å’Œè°ƒè¯•å›°éš¾"></a>10. <strong>è¯„ä¼°å’Œè°ƒè¯•å›°éš¾</strong></h3><ul><li><strong>æ€§èƒ½é¢„æµ‹å›°éš¾</strong>ï¼šéš¾ä»¥å‡†ç¡®é¢„æµ‹ç‰¹å®šLoRAé…ç½®åœ¨æ–°ä»»åŠ¡ä¸Šçš„æ€§èƒ½</li><li><strong>é”™è¯¯å½’å› å¤æ‚</strong>ï¼šå½“æ€§èƒ½ä¸ä½³æ—¶ï¼Œéš¾ä»¥ç¡®å®šæ˜¯LoRAé…ç½®é—®é¢˜è¿˜æ˜¯æ•°æ®&#x2F;ä»»åŠ¡æœ¬èº«çš„é—®é¢˜</li><li><strong>å¯è§†åŒ–å·¥å…·ç¼ºä¹</strong>ï¼šç¼ºä¹æœ‰æ•ˆçš„å·¥å…·æ¥å¯è§†åŒ–å’Œåˆ†æLoRAæƒé‡çš„æ›´æ–°è¿‡ç¨‹</li><li><strong>åŸºå‡†æµ‹è¯•ä¸è¶³</strong>ï¼šç¼ºä¹æ ‡å‡†åŒ–çš„åŸºå‡†æµ‹è¯•æ¥æ¯”è¾ƒä¸åŒLoRAé…ç½®çš„æ•ˆæœ</li></ul><h3 id="11-ç”Ÿæ€ç³»ç»Ÿç¢ç‰‡åŒ–"><a href="#11-ç”Ÿæ€ç³»ç»Ÿç¢ç‰‡åŒ–" class="headerlink" title="11. ç”Ÿæ€ç³»ç»Ÿç¢ç‰‡åŒ–"></a>11. <strong>ç”Ÿæ€ç³»ç»Ÿç¢ç‰‡åŒ–</strong></h3><ul><li><strong>å®ç°å·®å¼‚å¤§</strong>ï¼šä¸åŒæ¡†æ¶ï¼ˆPEFTã€Hugging Faceã€DeepSpeedç­‰ï¼‰çš„LoRAå®ç°åœ¨ç»†èŠ‚ä¸Šå­˜åœ¨å·®å¼‚</li><li><strong>å…¼å®¹æ€§é—®é¢˜</strong>ï¼šä¸åŒç‰ˆæœ¬çš„åº“ä¹‹é—´å¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œå½±å“æ¨¡å‹è¿ç§»</li><li><strong>æ–‡æ¡£ä¸å®Œå–„</strong>ï¼šè®¸å¤šLoRAçš„é«˜çº§é…ç½®é€‰é¡¹ç¼ºä¹å®Œå–„çš„æ–‡æ¡£å’Œæœ€ä½³å®è·µæŒ‡å¯¼</li><li><strong>ç¤¾åŒºæ”¯æŒä¸å‡</strong>ï¼šæŸäº›æ¨¡å‹æ¶æ„çš„LoRAæ”¯æŒå¯èƒ½ä¸å¦‚ä¸»æµæ¨¡å‹å®Œå–„</li></ul><h3 id="12-å•†ä¸šåº”ç”¨é™åˆ¶"><a href="#12-å•†ä¸šåº”ç”¨é™åˆ¶" class="headerlink" title="12. å•†ä¸šåº”ç”¨é™åˆ¶"></a>12. <strong>å•†ä¸šåº”ç”¨é™åˆ¶</strong></h3><ul><li><strong>ä¸“åˆ©é£é™©</strong>ï¼šLoRAç›¸å…³æŠ€æœ¯å¯èƒ½å­˜åœ¨ä¸“åˆ©é£é™©ï¼Œå½±å“å•†ä¸šåº”ç”¨</li><li><strong>æ¨¡å‹é”å®š</strong>ï¼šè¿‡åº¦ä¾èµ–ç‰¹å®šLoRAé…ç½®å¯èƒ½å¯¼è‡´æ¨¡å‹é”å®šï¼Œéš¾ä»¥è¿ç§»åˆ°å…¶ä»–æŠ€æœ¯</li><li><strong>ç»´æŠ¤æˆæœ¬</strong>ï¼šè™½ç„¶è®­ç»ƒæˆæœ¬ä½ï¼Œä½†LoRAé€‚é…å™¨çš„é•¿æœŸç»´æŠ¤å’Œæ›´æ–°å¯èƒ½å¸¦æ¥éšæ€§æˆæœ¬</li><li><strong>ä¾›åº”å•†ä¾èµ–</strong>ï¼šæŸäº›ä¼˜åŒ–æŠ€æœ¯ï¼ˆå¦‚ç‰¹å®šé‡åŒ–æ–¹æ¡ˆï¼‰å¯èƒ½ä¾èµ–ç‰¹å®šç¡¬ä»¶ä¾›åº”å•†</li></ul><h3 id="æ³¨æ„äº‹é¡¹ä»¥åŠå»ºè®®"><a href="#æ³¨æ„äº‹é¡¹ä»¥åŠå»ºè®®" class="headerlink" title="æ³¨æ„äº‹é¡¹ä»¥åŠå»ºè®®"></a>æ³¨æ„äº‹é¡¹ä»¥åŠå»ºè®®</h3><p>å°½ç®¡LoRAå­˜åœ¨è¿™äº›ç¼ºç‚¹ï¼Œå®ƒä»ç„¶æ˜¯å½“å‰æœ€å®ç”¨çš„å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯ä¹‹ä¸€ã€‚ä¸ºäº†å…‹æœè¿™äº›å±€é™æ€§ï¼Œå»ºè®®ï¼š</p><ol><li><strong>ä»»åŠ¡è¯„ä¼°</strong>ï¼šåœ¨é€‰æ‹©LoRAå‰ï¼Œè¯„ä¼°ä»»åŠ¡å¤æ‚åº¦å’Œæ•°æ®é‡æ˜¯å¦é€‚åˆ</li><li><strong>æ¸è¿›å¼å®éªŒ</strong>ï¼šä»ä¿å®ˆé…ç½®ï¼ˆr&#x3D;4, alpha&#x3D;16ï¼‰å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚åº¦</li><li><strong>æ··åˆç­–ç•¥</strong>ï¼šè€ƒè™‘LoRAä¸å…¶ä»–PEFTæŠ€æœ¯ï¼ˆå¦‚Adapterã€Prefix Tuningï¼‰çš„ç»„åˆ</li><li><strong>æŒç»­ç›‘æ§</strong>ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼Œè·Ÿè¸ªLoRAæ¨¡å‹çš„æ€§èƒ½é€€åŒ–</li><li><strong>å¤‡ä»½æ–¹æ¡ˆ</strong>ï¼šå‡†å¤‡å…¨å‚æ•°å¾®è°ƒä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼Œå½“LoRAæ— æ³•æ»¡è¶³éœ€æ±‚æ—¶åˆ‡æ¢</li></ol><p>âš ï¸<strong>é€šè¿‡å……åˆ†ç†è§£LoRAçš„è¿™äº›ç¼ºç‚¹ï¼Œæœ‰åŠ©äºæ›´åˆç†åœ°è®¾è®¡å¾®è°ƒç­–ç•¥ï¼Œåœ¨å‚æ•°æ•ˆç‡å’Œæ¨¡å‹æ€§èƒ½ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹ã€‚</strong></p><hr><h2 id="æŠ€æœ¯é€‰å‹çš„æ³¨æ„äº‹é¡¹"><a href="#æŠ€æœ¯é€‰å‹çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="æŠ€æœ¯é€‰å‹çš„æ³¨æ„äº‹é¡¹"></a>æŠ€æœ¯é€‰å‹çš„æ³¨æ„äº‹é¡¹</h2><p>å¾®è°ƒå¤§æ¨¡å‹æœ¬èº«ï¼Œä¹Ÿè¦ç»¼åˆè€ƒè™‘<strong>ç»æµã€æ—¶é—´ã€ç®—åŠ›</strong>ç­‰æ–¹é¢çš„è¦ç´ ï¼Œéšç€AIæŠ€æœ¯çš„ä¸æ–­å‘å±•,å¾®è°ƒæ¨¡å‹ä¹Ÿè®¸å¹¶ä¸å…·æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ï¼Œè¦ç»“åˆè‡ªå·±çš„å®é™…ä¼ä¸šçº§åœºæ™¯ä¸šåŠ¡è¿›è¡Œé€‰å‹ã€‚<br>å®é™…åœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¹¶ä¸ä¸€å®šé€‚åˆå¾®è°ƒã€‚å…¶æ¬¡å¤§æ¨¡å‹æœ¬èº«çš„å‘å±•ä¼šè®©å¾®è°ƒå˜å¾—ä¸é‚£ä¹ˆé‡è¦ï¼Œåè€Œå¾—ä¸å¿å¤±ã€‚éœ€è¦ç»¼åˆå„æ–¹é¢å› ç´ è¿›è¡Œè€ƒé‡ã€‚æ€»ä½“æ¥è¯´ï¼Œåœ¨ä¼ä¸šçº§åº”ç”¨åœºæ™¯ä¸­ï¼Œé™¤æç‰¹æ®Šæƒ…ä¹‹å¤–ï¼Œä¼˜å…ˆå‘æŒ¥æ¨¡å‹æœ¬èº«çš„èƒ½åŠ›ï¼Œå…¶æ¬¡å†è€ƒè™‘æ¨¡å‹çš„ä¸è¶³ï¼Œå†³å®šæ˜¯å¦é€‰æ‹©å¾®è°ƒã€‚</p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;&lt;a href=&quot;#æ‘˜è¦&quot; class=&quot;headerlink&quot; title=&quot;æ‘˜è¦&quot;&gt;&lt;/a&gt;æ‘˜è¦&lt;/h2&gt;&lt;p&gt;åœ¨2026å¹´ï¼Œå¤§è¯­è¨€æ¨¡å‹(LLMs)å·²ç»æˆä¸ºä¼ä¸šæ™ºèƒ½åŒ–è½¬å‹çš„æ ¸å¿ƒé©±åŠ¨åŠ›ï¼Œç‰¹åˆ«æ˜¯åœ¨å®¢æˆ·æœåŠ¡é¢†åŸŸã€‚&lt;br&gt;æœ¬æ–‡å°†ä»¥Qwenæ¨¡å‹ä¸ºä¾‹ï¼Œç»“åˆä¸€ä¸ªå…·ä½“çš„QAé—®ç­”ä¸šåŠ¡åœºæ™¯ï¼Œæ·±å…¥æ¢è®¨å¦‚ä½•é€šè¿‡LoRA(Low-Rank Adaptation)æŠ€æœ¯è¿›è¡Œé«˜æ•ˆå¾®è°ƒï¼Œä»åŸç†åˆ°å®æˆ˜ï¼Œå®Œæ•´è¦†ç›–å®¢æœé—®ç­”ç³»ç»Ÿçš„æ„å»ºæµç¨‹ï¼Œåªæ˜¯æä¾›æ€è·¯ä»¥åŠæ–¹å‘æŒ‡å¯¼ï¼Œå…·ä½“è¿˜æ˜¯è¦ä»¥å®é™…ä¸šåŠ¡ä¸ºå‡†âš ï¸ï¼Œä¹Ÿæ¬¢è¿ä¸€èµ·äº¤æµå­¦ä¹ ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="Demo-AI" scheme="https://www.wdft.com/tags/Demo-AI/"/>
    
    <category term="MCP" scheme="https://www.wdft.com/tags/MCP/"/>
    
    <category term="LoRA" scheme="https://www.wdft.com/tags/LoRA/"/>
    
  </entry>
  
  <entry>
    <title>PHPå…³é”®ç‰ˆæœ¬æ¼”è¿›å²ï¼šä»7.4åˆ°8.4çš„å®Œæ•´å˜è¿ã€æ³¨æ„äº‹é¡¹è§£æ</title>
    <link href="https://www.wdft.com/8bbd939d.html"/>
    <id>https://www.wdft.com/8bbd939d.html</id>
    <published>2026-01-07T15:13:57.000Z</published>
    <updated>2026-01-24T17:44:58.680Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>PHPä½œä¸ºå…¨çƒæœ€æµè¡Œçš„æœåŠ¡å™¨ç«¯è„šæœ¬è¯­è¨€ä¹‹ä¸€ï¼Œå…¶ç‰ˆæœ¬è¿­ä»£å§‹ç»ˆå¤‡å—å¼€å‘è€…å…³æ³¨ã€‚<br>â€œPHPæ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„ç¼–ç¨‹è¯­è¨€â€ï¼Œæ›¾ç»è¢«æ— æ•°äººè°ƒä¾ƒè®½åˆºï¼Œä½†PHPä¾ç„¶æ˜¯ç¼–ç¨‹è¯­è¨€çš„ä¸»åŠ›è¯­è¨€ï¼Œè¶³å¤Ÿç®€æ´ã€å®ç”¨ï¼Œå°¤å…¶åœ¨å¼•å…¥JITçš„ç‰¹æ€§ä¸‹ï¼ŒPHPæœªæ¥å¯æœŸã€‚</p><span id="more"></span><hr><h2 id="ğŸ“…-ç‰ˆæœ¬æ—¶é—´çº¿æ¦‚è§ˆ"><a href="#ğŸ“…-ç‰ˆæœ¬æ—¶é—´çº¿æ¦‚è§ˆ" class="headerlink" title="ğŸ“… ç‰ˆæœ¬æ—¶é—´çº¿æ¦‚è§ˆ"></a>ğŸ“… ç‰ˆæœ¬æ—¶é—´çº¿æ¦‚è§ˆ</h2><ul><li><strong>PHP 7.4</strong> - 2019å¹´11æœˆ28æ—¥å‘å¸ƒ</li><li><strong>PHP 8.0</strong> - 2020å¹´11æœˆ26æ—¥å‘å¸ƒ  </li><li><strong>PHP 8.1</strong> - 2021å¹´11æœˆ25æ—¥å‘å¸ƒ</li><li><strong>PHP 8.2</strong> - 2022å¹´12æœˆ8æ—¥å‘å¸ƒ</li><li><strong>PHP 8.3</strong> - 2023å¹´11æœˆ23æ—¥å‘å¸ƒ</li><li><strong>PHP 8.4</strong> - 2024å¹´11æœˆ21æ—¥å‘å¸ƒ</li></ul><hr><h2 id="ğŸ”-è¯¦ç»†ç‰ˆæœ¬å˜æ›´è®°å½•"><a href="#ğŸ”-è¯¦ç»†ç‰ˆæœ¬å˜æ›´è®°å½•" class="headerlink" title="ğŸ” è¯¦ç»†ç‰ˆæœ¬å˜æ›´è®°å½•"></a>ğŸ” è¯¦ç»†ç‰ˆæœ¬å˜æ›´è®°å½•</h2><h3 id="ğŸŸ¢-PHP-7-4-2019-11-28"><a href="#ğŸŸ¢-PHP-7-4-2019-11-28" class="headerlink" title="ğŸŸ¢ PHP 7.4 (2019-11-28)"></a>ğŸŸ¢ PHP 7.4 (2019-11-28)</h3><h4 id="âœ¨-æ–°å¢ç‰¹æ€§"><a href="#âœ¨-æ–°å¢ç‰¹æ€§" class="headerlink" title="âœ¨ æ–°å¢ç‰¹æ€§"></a>âœ¨ æ–°å¢ç‰¹æ€§</h4><ul><li><strong>ç±»å‹åŒ–å±æ€§ï¼ˆTyped Propertiesï¼‰</strong>ï¼šç±»å±æ€§å¯ä»¥ç›´æ¥å£°æ˜ç±»å‹ï¼Œå¢å¼ºç±»å‹å®‰å…¨æ€§å’Œä»£ç å¯è¯»æ€§ </li><li><strong>ç®­å¤´å‡½æ•°ï¼ˆArrow Functionsï¼‰</strong>ï¼šç®€åŒ–å•è¡Œå‡½æ•°çš„è¯­æ³•ï¼Œä½¿ç”¨<code>fn()</code>è¯­æ³•ç³– </li><li><strong>æ•°ç»„å±•å¼€è¿ç®—ç¬¦ï¼ˆSpread Operatorï¼‰</strong>ï¼šæ”¯æŒåœ¨æ•°ç»„è¡¨è¾¾å¼ä¸­ä½¿ç”¨<code>...</code>å±•å¼€æ•°ç»„ </li><li><strong>ç©ºåˆå¹¶èµ‹å€¼è¿ç®—ç¬¦ï¼ˆ??&#x3D;ï¼‰</strong>ï¼šç®€åŒ–ç©ºå€¼æ£€æŸ¥å’Œèµ‹å€¼æ“ä½œ </li><li><strong>é¢„åŠ è½½ï¼ˆPreloadingï¼‰</strong>ï¼šæå‡PHPåº”ç”¨æ€§èƒ½ï¼Œå‡å°‘é‡å¤ç¼–è¯‘å¼€é”€ </li><li><strong>å¼±å¼•ç”¨ï¼ˆWeak Referencesï¼‰</strong>ï¼šå…è®¸åœ¨ä¸å¢åŠ å¼•ç”¨è®¡æ•°çš„æƒ…å†µä¸‹å¼•ç”¨å¯¹è±¡</li></ul><h4 id="âš ï¸-åºŸå¼ƒåŠŸèƒ½"><a href="#âš ï¸-åºŸå¼ƒåŠŸèƒ½" class="headerlink" title="âš ï¸ åºŸå¼ƒåŠŸèƒ½"></a>âš ï¸ åºŸå¼ƒåŠŸèƒ½</h4><ul><li>èŠ±æ‹¬å·è®¿é—®æ•°ç»„å’Œå­—ç¬¦ä¸²åç§»ï¼ˆä½¿ç”¨<code>[]</code>æ›¿ä»£ï¼‰ </li><li><code>real</code>ç±»å‹åˆ«åè¢«åºŸå¼ƒ</li><li>é­”æœ¯å¼•å·ï¼ˆmagic quotesï¼‰ç›¸å…³åŠŸèƒ½å½»åº•ç§»é™¤</li></ul><hr><h3 id="ğŸ”µ-PHP-8-0-2020-11-26"><a href="#ğŸ”µ-PHP-8-0-2020-11-26" class="headerlink" title="ğŸ”µ PHP 8.0 (2020-11-26)"></a>ğŸ”µ PHP 8.0 (2020-11-26)</h3><h4 id="âœ¨-æ–°å¢ç‰¹æ€§-1"><a href="#âœ¨-æ–°å¢ç‰¹æ€§-1" class="headerlink" title="âœ¨ æ–°å¢ç‰¹æ€§"></a>âœ¨ æ–°å¢ç‰¹æ€§</h4><ul><li><strong>JITç¼–è¯‘å™¨</strong>ï¼šå¼•å…¥Just-In-Timeç¼–è¯‘ï¼Œæ€§èƒ½æå‡é«˜è¾¾3å€ </li><li><strong>è”åˆç±»å‹ï¼ˆUnion Typesï¼‰</strong>ï¼šå…è®¸å‚æ•°ã€å±æ€§å’Œè¿”å›å€¼æ¥å—å¤šç§ç±»å‹ï¼Œä½¿ç”¨<code>|</code>åˆ†éš” </li><li><strong>å‘½åå‚æ•°ï¼ˆNamed Argumentsï¼‰</strong>ï¼šè°ƒç”¨å‡½æ•°æ—¶å¯ä»¥é€šè¿‡å‚æ•°åæŒ‡å®šå‚æ•°ï¼Œæé«˜ä»£ç å¯è¯»æ€§ </li><li><strong>å±æ€§ï¼ˆAttributesï¼‰</strong>ï¼šæ›¿ä»£æ³¨é‡Šçš„å…ƒæ•°æ®å£°æ˜æ–¹å¼ï¼Œæä¾›ç±»å‹å®‰å…¨çš„æ³¨è§£ç³»ç»Ÿ </li><li><strong>æ„é€ å™¨å±æ€§æå‡ï¼ˆConstructor Property Promotionï¼‰</strong>ï¼šç®€åŒ–ç±»å±æ€§å£°æ˜å’Œæ„é€ å‡½æ•°åˆå§‹åŒ– </li><li><strong>matchè¡¨è¾¾å¼</strong>ï¼šå¢å¼ºç‰ˆswitchè¯­å¥ï¼Œæ”¯æŒè¡¨è¾¾å¼è¿”å›å€¼ï¼Œæ›´ç®€æ´çš„è¯­æ³• </li><li><strong>ç©ºå®‰å…¨è¿ç®—ç¬¦ï¼ˆNullsafe Operatorï¼‰</strong>ï¼šä½¿ç”¨<code>?-&gt;</code>å®‰å…¨è®¿é—®å¯èƒ½ä¸ºnullçš„å¯¹è±¡å±æ€§æˆ–æ–¹æ³• </li><li><strong><code>mixed</code>ç±»å‹</strong>ï¼šè¡¨ç¤ºå‚æ•°æˆ–è¿”å›å€¼å¯ä»¥æ˜¯ä»»ä½•ç±»å‹</li></ul><h4 id="âš ï¸-åºŸå¼ƒ-x2F-ç§»é™¤åŠŸèƒ½"><a href="#âš ï¸-åºŸå¼ƒ-x2F-ç§»é™¤åŠŸèƒ½" class="headerlink" title="âš ï¸ åºŸå¼ƒ&#x2F;ç§»é™¤åŠŸèƒ½"></a>âš ï¸ åºŸå¼ƒ&#x2F;ç§»é™¤åŠŸèƒ½</h4><ul><li><code>create_function()</code>å‡½æ•°è¢«ç§»é™¤</li><li><code>each()</code>å‡½æ•°è¢«åºŸå¼ƒ</li><li><code>mb_strrpos()</code>çš„ç¬¬ä¸‰ä¸ªå‚æ•°è¡Œä¸ºæ”¹å˜</li><li>éé™æ€æ–¹æ³•é™æ€è°ƒç”¨äº§ç”Ÿè­¦å‘Š</li></ul><hr><h3 id="ğŸŸ£-PHP-8-1-2021-11-25"><a href="#ğŸŸ£-PHP-8-1-2021-11-25" class="headerlink" title="ğŸŸ£ PHP 8.1 (2021-11-25)"></a>ğŸŸ£ PHP 8.1 (2021-11-25)</h3><h4 id="âœ¨-æ–°å¢ç‰¹æ€§-2"><a href="#âœ¨-æ–°å¢ç‰¹æ€§-2" class="headerlink" title="âœ¨ æ–°å¢ç‰¹æ€§"></a>âœ¨ æ–°å¢ç‰¹æ€§</h4><ul><li><strong>æšä¸¾ï¼ˆEnumsï¼‰</strong>ï¼šåŸç”Ÿæ”¯æŒæšä¸¾ç±»å‹ï¼ŒåŒ…æ‹¬Unit Enumså’ŒBacked Enums </li><li><strong>åªè¯»å±æ€§ï¼ˆReadonly Propertiesï¼‰</strong>ï¼šä½¿ç”¨<code>readonly</code>ä¿®é¥°ç¬¦é˜²æ­¢å±æ€§è¢«ä¿®æ”¹ </li><li><strong>Fibers</strong>ï¼šè½»é‡çº§å¹¶å‘åŸè¯­ï¼Œæ”¯æŒåç¨‹å’Œå¼‚æ­¥ç¼–ç¨‹ </li><li><strong>äº¤é›†ç±»å‹ï¼ˆIntersection Typesï¼‰</strong>ï¼šä½¿ç”¨<code>&amp;</code>æ“ä½œç¬¦è¦æ±‚å€¼åŒæ—¶æ»¡è¶³å¤šç§ç±»å‹ </li><li><strong><code>never</code>è¿”å›ç±»å‹</strong>ï¼šè¡¨ç¤ºå‡½æ•°æ°¸è¿œä¸ä¼šæ­£å¸¸è¿”å›ï¼ˆå¦‚æŠ›å‡ºå¼‚å¸¸æˆ–æ— é™å¾ªç¯ï¼‰ </li><li><strong>æœ€ç»ˆç±»å¸¸é‡ï¼ˆFinal Class Constantsï¼‰</strong>ï¼šä½¿ç”¨<code>final</code>ä¿®é¥°ç¬¦é˜²æ­¢å¸¸é‡è¢«å­ç±»è¦†ç›– </li><li><strong><code>array_is_list()</code>å‡½æ•°</strong>ï¼šæ£€æµ‹æ•°ç»„æ˜¯å¦ä¸ºçº¯ç´¢å¼•æ•°ç»„ </li><li><strong>çº¤ç¨‹ï¼ˆFibersï¼‰</strong>ï¼šæ”¯æŒè½»é‡çº§å¹¶å‘ç¼–ç¨‹æ¨¡å‹</li></ul><h4 id="âš ï¸-åºŸå¼ƒåŠŸèƒ½-1"><a href="#âš ï¸-åºŸå¼ƒåŠŸèƒ½-1" class="headerlink" title="âš ï¸ åºŸå¼ƒåŠŸèƒ½"></a>âš ï¸ åºŸå¼ƒåŠŸèƒ½</h4><ul><li><code>Serializable</code>æ¥å£è¢«åºŸå¼ƒï¼Œæ¨èä½¿ç”¨<code>__serialize()</code>å’Œ<code>__unserialize()</code>é­”æœ¯æ–¹æ³•</li><li><code>mysqli</code>æ— å‚æ•°æ„é€ å‡½æ•°è¢«åºŸå¼ƒ</li><li>åŠ¨æ€å±æ€§åœ¨éstdClasså¯¹è±¡ä¸Šè¢«åºŸå¼ƒï¼ˆä¸º8.2çš„åªè¯»ç±»åšå‡†å¤‡ï¼‰</li></ul><hr><h3 id="ğŸŸ¡-PHP-8-2-2022-12-08"><a href="#ğŸŸ¡-PHP-8-2-2022-12-08" class="headerlink" title="ğŸŸ¡ PHP 8.2 (2022-12-08)"></a>ğŸŸ¡ PHP 8.2 (2022-12-08)</h3><h4 id="âœ¨-æ–°å¢ç‰¹æ€§-3"><a href="#âœ¨-æ–°å¢ç‰¹æ€§-3" class="headerlink" title="âœ¨ æ–°å¢ç‰¹æ€§"></a>âœ¨ æ–°å¢ç‰¹æ€§</h4><ul><li><strong>åªè¯»ç±»ï¼ˆReadonly Classesï¼‰</strong>ï¼šæ•´ä¸ªç±»çš„æ‰€æœ‰å±æ€§è‡ªåŠ¨æ ‡è®°ä¸ºåªè¯» </li><li><strong>æ•æ„Ÿå‚æ•°éšè—</strong>ï¼šåœ¨é”™è¯¯ä¿¡æ¯ä¸­è‡ªåŠ¨éšè—æ•æ„Ÿå‚æ•°ï¼ˆå¦‚å¯†ç ï¼‰ </li><li><strong><code>null</code>&#x2F;<code>false</code>ä½œä¸ºç‹¬ç«‹ç±»å‹</strong>ï¼šæ”¯æŒ<code>null</code>å’Œ<code>false</code>ä½œä¸ºç‹¬ç«‹çš„ç±»å‹å£°æ˜ </li><li><strong>æ”¹è¿›çš„éšæœºæ•°ç”Ÿæˆå™¨</strong>ï¼šæä¾›æ›´å®‰å…¨ã€å¯æµ‹è¯•çš„éšæœºæ•°ç”ŸæˆAPI </li><li><strong>å¸¸é‡è¡¨è¾¾å¼æ”¹è¿›</strong>ï¼šæ”¯æŒåœ¨å¸¸é‡è¡¨è¾¾å¼ä¸­ä½¿ç”¨æ›´å¤šæ“ä½œç¬¦å’Œå‡½æ•°è°ƒç”¨</li></ul><h4 id="âš ï¸-åºŸå¼ƒ-x2F-ç§»é™¤åŠŸèƒ½-1"><a href="#âš ï¸-åºŸå¼ƒ-x2F-ç§»é™¤åŠŸèƒ½-1" class="headerlink" title="âš ï¸ åºŸå¼ƒ&#x2F;ç§»é™¤åŠŸèƒ½"></a>âš ï¸ åºŸå¼ƒ&#x2F;ç§»é™¤åŠŸèƒ½</h4><ul><li><strong>åŠ¨æ€å±æ€§è¢«åºŸå¼ƒ</strong>ï¼šé™¤stdClasså’Œæ ‡è®°ä¸º<code>#[AllowDynamicProperties]</code>çš„ç±»å¤–ï¼ŒåŠ¨æ€åˆ›å»ºå±æ€§ä¼šäº§ç”Ÿè­¦å‘Š </li><li><code>utf8_encode()</code>å’Œ<code>utf8_decode()</code>å‡½æ•°è¢«åºŸå¼ƒ</li><li><code>mysqli</code>çš„<code>mysqli_execute_query()</code>æ›¿ä»£<code>mysqli::execute_query()</code></li><li>éfinalå†…éƒ¨ç±»çš„<code>__debugInfo()</code>æ–¹æ³•å¿…é¡»å£°æ˜ä¸ºfinal</li></ul><hr><h3 id="ğŸ”´-PHP-8-3-2023-11-23"><a href="#ğŸ”´-PHP-8-3-2023-11-23" class="headerlink" title="ğŸ”´ PHP 8.3 (2023-11-23)"></a>ğŸ”´ PHP 8.3 (2023-11-23)</h3><h4 id="âœ¨-æ–°å¢ç‰¹æ€§-4"><a href="#âœ¨-æ–°å¢ç‰¹æ€§-4" class="headerlink" title="âœ¨ æ–°å¢ç‰¹æ€§"></a>âœ¨ æ–°å¢ç‰¹æ€§</h4><ul><li><strong>ç±»å‹åŒ–ç±»å¸¸é‡</strong>ï¼šç±»å¸¸é‡ç°åœ¨å¯ä»¥å£°æ˜ç±»å‹ï¼Œå¢å¼ºç±»å‹å®‰å…¨ </li><li><strong>æ·±åº¦å…‹éš†åªè¯»å±æ€§</strong>ï¼šæ”¹è¿›åªè¯»ç±»çš„å…‹éš†æœºåˆ¶ï¼Œæ”¯æŒæ·±åº¦å…‹éš†åªè¯»å±æ€§ </li><li><strong><code>json_validate()</code>å‡½æ•°</strong>ï¼šåŸç”ŸJSONéªŒè¯å‡½æ•°ï¼Œæ— éœ€è§£æå³å¯éªŒè¯JSONæ ¼å¼ </li><li><strong>éšæœºæ•°ç”Ÿæˆå™¨å¢å¼º</strong>ï¼šæ–°å¢<code>Random\Randomizer</code>ç±»å’Œå„ç§éšæœºæ•°ç”Ÿæˆç®—æ³• </li><li><strong>è¦†ç›–traitæ–¹æ³•æ—¶è®¿é—®çˆ¶çº§</strong>ï¼šå…è®¸åœ¨è¦†ç›–traitæ–¹æ³•æ—¶è°ƒç”¨çˆ¶çº§å®ç° </li><li><strong><code>#[\Override]</code>å±æ€§</strong>ï¼šæ˜¾å¼æ ‡è®°è¦†ç›–çˆ¶ç±»æˆ–æ¥å£æ–¹æ³•</li></ul><h4 id="âš ï¸-åºŸå¼ƒ-x2F-ç§»é™¤åŠŸèƒ½-2"><a href="#âš ï¸-åºŸå¼ƒ-x2F-ç§»é™¤åŠŸèƒ½-2" class="headerlink" title="âš ï¸ åºŸå¼ƒ&#x2F;ç§»é™¤åŠŸèƒ½"></a>âš ï¸ åºŸå¼ƒ&#x2F;ç§»é™¤åŠŸèƒ½</h4><ul><li><code>mbstring</code>ã€<code>openssl</code>ã€<code>zip</code>ç­‰æ‰©å±•ä¸­å·²åºŸå¼ƒçš„å‡½æ•°è¢«ç§»é™¤</li><li><code>$&#123;&#125;</code>å­—ç¬¦ä¸²æ’å€¼è¯­æ³•è¢«åºŸå¼ƒ</li><li>åŠ¨æ€è·å–æœªå®šä¹‰ç±»å¸¸é‡äº§ç”Ÿè­¦å‘Š</li><li>é€šè¿‡å¼•ç”¨ä¿®æ”¹åªè¯»å±æ€§è¢«ç¦æ­¢</li></ul><hr><h3 id="âšª-PHP-8-4-2024-11-21"><a href="#âšª-PHP-8-4-2024-11-21" class="headerlink" title="âšª PHP 8.4 (2024-11-21)"></a>âšª PHP 8.4 (2024-11-21)</h3><h4 id="âœ¨-æ–°å¢ç‰¹æ€§-5"><a href="#âœ¨-æ–°å¢ç‰¹æ€§-5" class="headerlink" title="âœ¨ æ–°å¢ç‰¹æ€§"></a>âœ¨ æ–°å¢ç‰¹æ€§</h4><ul><li><strong>ç®¡é“æ“ä½œç¬¦ï¼ˆPipe Operatorï¼‰</strong>ï¼šä½¿ç”¨<code>|&gt;</code>è¯­æ³•ç®€åŒ–å‡½æ•°é“¾å¼è°ƒç”¨ï¼Œæå‡ä»£ç å¯è¯»æ€§ </li><li><strong>URIæ‰©å±•</strong>ï¼šåŸç”Ÿæ”¯æŒURIè§£æå’Œæ“ä½œï¼Œæä¾›æ ‡å‡†åŒ–çš„URIå¤„ç†åŠŸèƒ½ </li><li><strong>JITæ”¹è¿›</strong>ï¼šè¿›ä¸€æ­¥ä¼˜åŒ–JITç¼–è¯‘å™¨æ€§èƒ½ï¼Œå‡å°‘å†…å­˜å ç”¨</li><li><strong>å±æ€§å¢å¼º</strong>ï¼šæ”¯æŒæ›´å¤šåœºæ™¯ä¸‹çš„å±æ€§ä½¿ç”¨ï¼Œæ”¹è¿›åå°„API</li><li><strong>ç±»å‹ç³»ç»Ÿæ”¹è¿›</strong>ï¼šå¢å¼ºæ³›å‹æ”¯æŒï¼Œæ”¹è¿›ç±»å‹æ¨æ–­æœºåˆ¶</li></ul><h4 id="âš ï¸-åºŸå¼ƒ-x2F-ç§»é™¤åŠŸèƒ½-3"><a href="#âš ï¸-åºŸå¼ƒ-x2F-ç§»é™¤åŠŸèƒ½-3" class="headerlink" title="âš ï¸ åºŸå¼ƒ&#x2F;ç§»é™¤åŠŸèƒ½"></a>âš ï¸ åºŸå¼ƒ&#x2F;ç§»é™¤åŠŸèƒ½</h4><ul><li>ç»§ç»­æ¸…ç†PHP 5.xé—ç•™çš„å…¼å®¹æ€§ä»£ç </li><li><code>date_sunrise()</code>å’Œ<code>date_sunset()</code>å‡½æ•°è¢«åºŸå¼ƒ</li><li><code>FILTER_SANITIZE_STRING</code>è¿‡æ»¤å™¨è¢«ç§»é™¤</li><li>ä¼ ç»Ÿæ„é€ å‡½æ•°ï¼ˆä¸ç±»åŒåçš„æ–¹æ³•ï¼‰åœ¨éå…¼å®¹æ¨¡å¼ä¸‹è¢«åºŸå¼ƒ</li></ul><hr><h2 id="ğŸ“Š-ç‰ˆæœ¬æ”¯æŒçŠ¶æ€ï¼ˆæˆªè‡³2026å¹´1æœˆï¼‰"><a href="#ğŸ“Š-ç‰ˆæœ¬æ”¯æŒçŠ¶æ€ï¼ˆæˆªè‡³2026å¹´1æœˆï¼‰" class="headerlink" title="ğŸ“Š ç‰ˆæœ¬æ”¯æŒçŠ¶æ€ï¼ˆæˆªè‡³2026å¹´1æœˆï¼‰"></a>ğŸ“Š ç‰ˆæœ¬æ”¯æŒçŠ¶æ€ï¼ˆæˆªè‡³2026å¹´1æœˆï¼‰</h2><table><thead><tr><th>ç‰ˆæœ¬</th><th>å‘å¸ƒæ—¥æœŸ</th><th>å®‰å…¨æ”¯æŒç»“æŸ</th><th>çŠ¶æ€</th></tr></thead><tbody><tr><td>7.4</td><td>2019-11-28</td><td>2022-11-28</td><td>âŒ å·²ç»“æŸæ”¯æŒ</td></tr><tr><td>8.0</td><td>2020-11-26</td><td>2023-11-26</td><td>âŒ å·²ç»“æŸæ”¯æŒ</td></tr><tr><td>8.1</td><td>2021-11-25</td><td>2024-11-25</td><td>âš ï¸ ä»…å®‰å…¨æ›´æ–°</td></tr><tr><td>8.2</td><td>2022-12-08</td><td>2026-12-31</td><td>âœ… æ´»è·ƒæ”¯æŒ</td></tr><tr><td>8.3</td><td>2023-11-23</td><td>2027-12-31</td><td>âœ… æ´»è·ƒæ”¯æŒ</td></tr><tr><td>8.4</td><td>2024-11-21</td><td>2028-12-31</td><td>âœ… æ´»è·ƒæ”¯æŒ</td></tr></tbody></table><hr><h2 id="ğŸ¯-å‡çº§å»ºè®®"><a href="#ğŸ¯-å‡çº§å»ºè®®" class="headerlink" title="ğŸ¯ å‡çº§å»ºè®®"></a>ğŸ¯ å‡çº§å»ºè®®</h2><ol><li><strong>ç«‹å³å‡çº§</strong>ï¼šä»åœ¨ä½¿ç”¨PHP 7.4æˆ–8.0çš„é¡¹ç›®åº”å°½å¿«å‡çº§åˆ°8.2+ç‰ˆæœ¬</li><li><strong>ç‰¹æ€§é‡‡ç”¨</strong>ï¼šæ–°é¡¹ç›®å»ºè®®ä½¿ç”¨PHP 8.4ï¼Œå……åˆ†åˆ©ç”¨ç®¡é“æ“ä½œç¬¦ç­‰ç°ä»£è¯­æ³•</li><li><strong>æ¸è¿›è¿ç§»</strong>ï¼šå¤§å‹é¡¹ç›®å¯ä»8.2å¼€å§‹ï¼Œé€æ­¥è¿ç§»åˆ°æ›´æ–°ç‰ˆæœ¬</li><li><strong>å·¥å…·æ”¯æŒ</strong>ï¼šä½¿ç”¨Rectorã€PHPStanç­‰å·¥å…·è¾…åŠ©ä»£ç ç°ä»£åŒ–æ”¹é€ </li></ol><hr><h2 id="ğŸ’¡-æœªæ¥å±•æœ›"><a href="#ğŸ’¡-æœªæ¥å±•æœ›" class="headerlink" title="ğŸ’¡ æœªæ¥å±•æœ›"></a>ğŸ’¡ æœªæ¥å±•æœ›</h2><p>PHP 8.5é¢„è®¡å°†åœ¨2025å¹´åº•å‘å¸ƒï¼Œä¸»è¦å…³æ³¨ç‚¹åŒ…æ‹¬ï¼š</p><ul><li>è¿›ä¸€æ­¥æ”¹è¿›JITæ€§èƒ½</li><li>å¢å¼ºæ³›å‹æ”¯æŒ</li><li>æ”¹è¿›é”™è¯¯å¤„ç†æœºåˆ¶</li><li>æ›´å¥½çš„å¼‚æ­¥ç¼–ç¨‹æ”¯æŒ</li></ul><p>PHPè¯­è¨€æ­£åœ¨å‘æ›´ç°ä»£åŒ–ã€ç±»å‹å®‰å…¨ã€é«˜æ€§èƒ½çš„æ–¹å‘ç¨³æ­¥å‘å±•ï¼Œå¼€å‘è€…åº”ç§¯ææ‹¥æŠ±è¿™äº›å˜åŒ–ï¼Œæå‡ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚</p><hr><h2 id="PHP-7-å‡çº§åˆ°-PHP-8-å¯¹è¯­æ³•å…¼å®¹æ€§é—®é¢˜çš„å¤„ç†æ³¨æ„äº‹é¡¹"><a href="#PHP-7-å‡çº§åˆ°-PHP-8-å¯¹è¯­æ³•å…¼å®¹æ€§é—®é¢˜çš„å¤„ç†æ³¨æ„äº‹é¡¹" class="headerlink" title="PHP 7 å‡çº§åˆ° PHP 8 å¯¹è¯­æ³•å…¼å®¹æ€§é—®é¢˜çš„å¤„ç†æ³¨æ„äº‹é¡¹"></a>PHP 7 å‡çº§åˆ° PHP 8 å¯¹è¯­æ³•å…¼å®¹æ€§é—®é¢˜çš„å¤„ç†æ³¨æ„äº‹é¡¹</h2><h3 id="ğŸ“‹-å‡çº§å‰å‡†å¤‡å·¥ä½œ"><a href="#ğŸ“‹-å‡çº§å‰å‡†å¤‡å·¥ä½œ" class="headerlink" title="ğŸ“‹ å‡çº§å‰å‡†å¤‡å·¥ä½œ"></a>ğŸ“‹ å‡çº§å‰å‡†å¤‡å·¥ä½œ</h3><h4 id="1-å…¨é¢å…¼å®¹æ€§æ£€æŸ¥"><a href="#1-å…¨é¢å…¼å®¹æ€§æ£€æŸ¥" class="headerlink" title="1. å…¨é¢å…¼å®¹æ€§æ£€æŸ¥"></a>1. å…¨é¢å…¼å®¹æ€§æ£€æŸ¥</h4><ul><li><strong>ä½¿ç”¨PHPå…¼å®¹æ€§æ£€æŸ¥å·¥å…·</strong>ï¼šåœ¨å‡çº§å‰ï¼ŒåŠ¡å¿…ä½¿ç”¨PHP Compatibility Checkerç­‰å·¥å…·æ‰«æä»£ç ï¼Œç¡®ä¿ä½ çš„ä»£ç å·²ä¸ºPHP 8åšå¥½å‡†å¤‡ã€‚</li><li><strong>éªŒè¯ç¬¬ä¸‰æ–¹ä¾èµ–</strong>ï¼šæ£€æŸ¥æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“ã€æ¡†æ¶å’Œæ’ä»¶æ˜¯å¦æ”¯æŒPHP 8ï¼Œè¿™æ˜¯å‡çº§è¿‡ç¨‹ä¸­æœ€å¤§çš„æŒ‘æˆ˜ä¹‹ä¸€ã€‚</li><li><strong>WordPressç‰¹å®šæ£€æŸ¥</strong>ï¼šå¦‚æœæ˜¯WordPressç«™ç‚¹ï¼Œéœ€è¦éªŒè¯WordPressæ ¸å¿ƒç‰ˆæœ¬ã€ä¸»é¢˜å’Œæ‰€æœ‰æ’ä»¶ä¸PHP 8çš„å…¼å®¹æ€§ã€‚</li></ul><h4 id="2-ç¯å¢ƒå‡†å¤‡"><a href="#2-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2. ç¯å¢ƒå‡†å¤‡"></a>2. ç¯å¢ƒå‡†å¤‡</h4><ul><li><strong>åˆ›å»ºæµ‹è¯•ç¯å¢ƒ</strong>ï¼šæ°¸è¿œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒç›´æ¥å‡çº§ï¼Œå…ˆåœ¨éš”ç¦»çš„æµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œå®Œæ•´æµ‹è¯•</li><li><strong>å¤‡ä»½å®Œæ•´æ•°æ®</strong>ï¼šåŒ…æ‹¬ä»£ç åº“ã€æ•°æ®åº“å’Œé…ç½®æ–‡ä»¶</li><li><strong>åˆ¶å®šå›æ»šè®¡åˆ’</strong>ï¼šå‡†å¤‡å¿«é€Ÿå›é€€åˆ°PHP 7çš„æ–¹æ¡ˆ</li></ul><h3 id="ğŸ”§-æ ¸å¿ƒå…¼å®¹æ€§é—®é¢˜å¤„ç†"><a href="#ğŸ”§-æ ¸å¿ƒå…¼å®¹æ€§é—®é¢˜å¤„ç†" class="headerlink" title="ğŸ”§ æ ¸å¿ƒå…¼å®¹æ€§é—®é¢˜å¤„ç†"></a>ğŸ”§ æ ¸å¿ƒå…¼å®¹æ€§é—®é¢˜å¤„ç†</h3><h4 id="1-è¯­æ³•å’Œå‡½æ•°å˜æ›´"><a href="#1-è¯­æ³•å’Œå‡½æ•°å˜æ›´" class="headerlink" title="1. è¯­æ³•å’Œå‡½æ•°å˜æ›´"></a>1. è¯­æ³•å’Œå‡½æ•°å˜æ›´</h4><ul><li><strong>å¤„ç†å‘åä¸å…¼å®¹çš„æ›´æ”¹</strong>ï¼šPHP 8å¼•å…¥äº†è®¸å¤šç ´åæ€§å˜æ›´ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„å‡½æ•°ç­¾åå’Œè¡Œä¸ºå˜åŒ–ã€‚</li><li><strong>ä¸¥æ ¼ç±»å‹æ£€æŸ¥</strong>ï¼šPHP 8çš„ç±»å‹ç³»ç»Ÿæ›´åŠ ä¸¥æ ¼ï¼Œéœ€è¦ä¿®å¤æ‰€æœ‰ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ã€‚</li></ul><h4 id="2-å…³é”®å…¼å®¹æ€§é—®é¢˜"><a href="#2-å…³é”®å…¼å®¹æ€§é—®é¢˜" class="headerlink" title="2. å…³é”®å…¼å®¹æ€§é—®é¢˜"></a>2. å…³é”®å…¼å®¹æ€§é—®é¢˜</h4><ul><li><strong>æ•°ç»„å’Œå­—ç¬¦ä¸²å¤„ç†</strong>ï¼šPHP 8å¯¹æ•°ç»„é”®ç±»å‹ã€å­—ç¬¦ä¸²åç§»è®¿é—®ç­‰æœ‰æ›´ä¸¥æ ¼çš„éªŒè¯</li><li><strong>é”™è¯¯å¤„ç†å˜åŒ–</strong>ï¼šè®¸å¤šè­¦å‘Šå‡çº§ä¸ºErrorå¼‚å¸¸ï¼Œéœ€è¦æ›´æ–°é”™è¯¯å¤„ç†é€»è¾‘</li><li><strong>æ„é€ å‡½æ•°å˜åŒ–</strong>ï¼šå‘½åæ„é€ å‡½æ•°å’Œå±æ€§æå‡è¯­æ³•éœ€è¦ç‰¹åˆ«æ³¨æ„</li></ul><h3 id="ğŸ› ï¸-å®ç”¨å·¥å…·å’Œç­–ç•¥"><a href="#ğŸ› ï¸-å®ç”¨å·¥å…·å’Œç­–ç•¥" class="headerlink" title="ğŸ› ï¸ å®ç”¨å·¥å…·å’Œç­–ç•¥"></a>ğŸ› ï¸ å®ç”¨å·¥å…·å’Œç­–ç•¥</h3><h4 id="1-ä¸“ä¸šè¿ç§»å·¥å…·"><a href="#1-ä¸“ä¸šè¿ç§»å·¥å…·" class="headerlink" title="1. ä¸“ä¸šè¿ç§»å·¥å…·"></a>1. ä¸“ä¸šè¿ç§»å·¥å…·</h4><ul><li><strong>ä½¿ç”¨php8migrationtools</strong>ï¼šè¿™ç±»å·¥å…·å¯ä»¥æ¨¡æ‹ŸPHP 7çš„è¡Œä¸ºï¼ŒåŒæ—¶å¸®åŠ©è¯†åˆ«ä»£ç ä¸­çš„æ½œåœ¨è¾¹ç¼˜æƒ…å†µï¼Œå®ç°å®‰å…¨è¿ç§»ã€‚</li><li><strong>é™æ€ä»£ç åˆ†æ</strong>ï¼šç»“åˆä½¿ç”¨PHPStanã€Psalmç­‰é™æ€åˆ†æå·¥å…·ï¼Œæå‰å‘ç°å…¼å®¹æ€§é—®é¢˜ã€‚</li></ul><h4 id="2-é€æ­¥å‡çº§ç­–ç•¥"><a href="#2-é€æ­¥å‡çº§ç­–ç•¥" class="headerlink" title="2. é€æ­¥å‡çº§ç­–ç•¥"></a>2. é€æ­¥å‡çº§ç­–ç•¥</h4><ul><li><strong>æ¸è¿›å¼å‡çº§</strong>ï¼šè€ƒè™‘å…ˆå‡çº§åˆ°PHP 7.4ï¼ˆä½œä¸ºè¿‡æ¸¡ç‰ˆæœ¬ï¼‰ï¼Œå†å‡çº§åˆ°PHP 8.x</li><li><strong>ç‰¹æ€§æ ‡å¿—</strong>ï¼šä½¿ç”¨ç‰¹æ€§æ ‡å¿—ï¼ˆFeature Flagsï¼‰é€æ­¥å¯ç”¨PHP 8ç‰¹å®šåŠŸèƒ½</li><li><strong>åˆ†æ¨¡å—å‡çº§</strong>ï¼šå°†åº”ç”¨æ‹†åˆ†ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œé€ä¸ªå‡çº§å’Œæµ‹è¯•</li></ul><h3 id="ğŸ§ª-æµ‹è¯•å’ŒéªŒè¯"><a href="#ğŸ§ª-æµ‹è¯•å’ŒéªŒè¯" class="headerlink" title="ğŸ§ª æµ‹è¯•å’ŒéªŒè¯"></a>ğŸ§ª æµ‹è¯•å’ŒéªŒè¯</h3><h4 id="1-å…¨é¢æµ‹è¯•ç­–ç•¥"><a href="#1-å…¨é¢æµ‹è¯•ç­–ç•¥" class="headerlink" title="1. å…¨é¢æµ‹è¯•ç­–ç•¥"></a>1. å…¨é¢æµ‹è¯•ç­–ç•¥</h4><ul><li><strong>è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–</strong>ï¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½</li><li><strong>æ€§èƒ½åŸºå‡†æµ‹è¯•</strong>ï¼šPHP 8çš„JITå¯èƒ½å¸¦æ¥æ€§èƒ½æå‡ï¼Œä½†ä¹Ÿå¯èƒ½åœ¨æŸäº›åœºæ™¯ä¸‹è¡¨ç°ä¸åŒ</li><li><strong>å®‰å…¨æµ‹è¯•</strong>ï¼šéªŒè¯æ‰€æœ‰å®‰å…¨æœºåˆ¶åœ¨PHP 8ä¸‹æ­£å¸¸å·¥ä½œ</li></ul><h4 id="2-ç”Ÿäº§ç¯å¢ƒéªŒè¯"><a href="#2-ç”Ÿäº§ç¯å¢ƒéªŒè¯" class="headerlink" title="2. ç”Ÿäº§ç¯å¢ƒéªŒè¯"></a>2. ç”Ÿäº§ç¯å¢ƒéªŒè¯</h4><ul><li><strong>é‡‘ä¸é›€å‘å¸ƒ</strong>ï¼šå…ˆåœ¨å°éƒ¨åˆ†ç”Ÿäº§æµé‡ä¸Šæµ‹è¯•PHP 8</li><li><strong>ç›‘æ§å’Œå‘Šè­¦</strong>ï¼šè®¾ç½®è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ç›‘æ§ï¼Œå¿«é€Ÿå‘ç°å…¼å®¹æ€§é—®é¢˜</li><li><strong>æ€§èƒ½ç›‘æ§</strong>ï¼šå¯¹æ¯”PHP 7å’ŒPHP 8çš„æ€§èƒ½æŒ‡æ ‡</li></ul><h3 id="âš ï¸-å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ"><a href="#âš ï¸-å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ" class="headerlink" title="âš ï¸ å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ"></a>âš ï¸ å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ</h3><h4 id="1-ç¬¬ä¸‰æ–¹åº“å…¼å®¹æ€§"><a href="#1-ç¬¬ä¸‰æ–¹åº“å…¼å®¹æ€§" class="headerlink" title="1. ç¬¬ä¸‰æ–¹åº“å…¼å®¹æ€§"></a>1. ç¬¬ä¸‰æ–¹åº“å…¼å®¹æ€§</h4><ul><li><strong>è”ç³»ç»´æŠ¤è€…</strong>ï¼šå¦‚æœå…³é”®åº“ä¸æ”¯æŒPHP 8ï¼Œè”ç³»ç»´æŠ¤è€…æˆ–å¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆ</li><li><strong>ä¸´æ—¶è¡¥ä¸</strong>ï¼šåœ¨ç­‰å¾…å®˜æ–¹æ”¯æŒæ—¶ï¼Œå¯èƒ½éœ€è¦åˆ›å»ºä¸´æ—¶è¡¥ä¸</li><li><strong>ä¾èµ–é™çº§</strong>ï¼šæŸäº›æƒ…å†µä¸‹å¯èƒ½éœ€è¦æš‚æ—¶é™çº§ç‰¹å®šä¾èµ–</li></ul><h4 id="2-é—ç•™ä»£ç å¤„ç†"><a href="#2-é—ç•™ä»£ç å¤„ç†" class="headerlink" title="2. é—ç•™ä»£ç å¤„ç†"></a>2. é—ç•™ä»£ç å¤„ç†</h4><ul><li><strong>é‡æ„å…³é”®è·¯å¾„</strong>ï¼šä¼˜å…ˆé‡æ„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸­çš„å…¼å®¹æ€§é—®é¢˜</li><li><strong>ä½¿ç”¨polyfill</strong>ï¼šä¸ºPHP 8æ–°ç‰¹æ€§åˆ›å»ºpolyfillï¼Œä¿æŒå‘åå…¼å®¹</li><li><strong>é€æ­¥æ·˜æ±°</strong>ï¼šæ ‡è®°ä¸å…¼å®¹çš„ä»£ç ï¼Œåˆ¶å®šé•¿æœŸé‡æ„è®¡åˆ’</li></ul><h3 id="ğŸš€-æœ€ä½³å®è·µå»ºè®®"><a href="#ğŸš€-æœ€ä½³å®è·µå»ºè®®" class="headerlink" title="ğŸš€ æœ€ä½³å®è·µå»ºè®®"></a>ğŸš€ æœ€ä½³å®è·µå»ºè®®</h3><ol><li><strong>ä¸è¦æ‹–å»¶å‡çº§</strong>ï¼šPHP 7å·²ä¸å†æ¥æ”¶å®‰å…¨æ›´æ–°ï¼Œç»§ç»­ä½¿ç”¨ä¼šæš´éœ²ç½‘ç«™é¢ä¸´å®‰å…¨é£é™©å’Œå…¼å®¹æ€§é—®é¢˜ã€‚</li><li><strong>ç¤¾åŒºèµ„æºåˆ©ç”¨</strong>ï¼šåŠ å…¥PHPç¤¾åŒºè®ºå›ï¼Œè·å–å…¶ä»–å¼€å‘è€…åœ¨å‡çº§è¿‡ç¨‹ä¸­çš„ç»éªŒå’Œè§£å†³æ–¹æ¡ˆ</li><li><strong>æ–‡æ¡£æ›´æ–°</strong>ï¼šå‡çº§åæ›´æ–°æ‰€æœ‰æŠ€æœ¯æ–‡æ¡£ï¼Œåæ˜ PHP 8çš„æ–°ç‰¹æ€§å’Œè¦æ±‚</li><li><strong>å›¢é˜ŸåŸ¹è®­</strong>ï¼šç¡®ä¿å¼€å‘å›¢é˜Ÿç†Ÿæ‚‰PHP 8çš„æ–°ç‰¹æ€§ï¼ˆå¦‚è”åˆç±»å‹ã€å‘½åå‚æ•°ã€å±æ€§ç­‰ï¼‰</li></ol><h3 id="ğŸ“Š-å‡çº§åä¼˜åŒ–"><a href="#ğŸ“Š-å‡çº§åä¼˜åŒ–" class="headerlink" title="ğŸ“Š å‡çº§åä¼˜åŒ–"></a>ğŸ“Š å‡çº§åä¼˜åŒ–</h3><ul><li><strong>åˆ©ç”¨PHP 8æ–°ç‰¹æ€§</strong>ï¼šå‡çº§åï¼Œé€æ­¥é‡æ„ä»£ç åˆ©ç”¨PHP 8çš„æ€§èƒ½ä¼˜åŠ¿å’Œæ–°è¯­æ³•</li><li><strong>æ€§èƒ½è°ƒä¼˜</strong>ï¼šé…ç½®JITç¼–è¯‘å™¨ï¼Œä¼˜åŒ–OPcacheè®¾ç½®</li><li><strong>å®‰å…¨åŠ å›º</strong>ï¼šåˆ©ç”¨PHP 8æ”¹è¿›çš„å®‰å…¨ç‰¹æ€§ï¼Œå¦‚æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥</li></ul><hr><h2 id="PHP-8ä¸­éœ€è¦ç‰¹åˆ«æ³¨æ„çš„é‡è¦æ–°ç‰¹æ€§"><a href="#PHP-8ä¸­éœ€è¦ç‰¹åˆ«æ³¨æ„çš„é‡è¦æ–°ç‰¹æ€§" class="headerlink" title="PHP 8ä¸­éœ€è¦ç‰¹åˆ«æ³¨æ„çš„é‡è¦æ–°ç‰¹æ€§"></a>PHP 8ä¸­éœ€è¦ç‰¹åˆ«æ³¨æ„çš„é‡è¦æ–°ç‰¹æ€§</h2><p>PHP 8ä½œä¸ºé‡å¤§ç‰ˆæœ¬æ›´æ–°ï¼Œå¼•å…¥äº†è®¸å¤šé©å‘½æ€§çš„ç‰¹æ€§å’Œä¸å…¼å®¹å˜æ›´ã€‚ä»¥ä¸‹æ˜¯å¼€å‘è€…æœ€éœ€è¦ç‰¹åˆ«æ³¨æ„çš„å…³é”®ç‰¹æ€§ï¼š</p><h3 id="ğŸš€-æ ¸å¿ƒæ–°ç‰¹æ€§"><a href="#ğŸš€-æ ¸å¿ƒæ–°ç‰¹æ€§" class="headerlink" title="ğŸš€ æ ¸å¿ƒæ–°ç‰¹æ€§"></a>ğŸš€ æ ¸å¿ƒæ–°ç‰¹æ€§</h3><h4 id="1-JITç¼–è¯‘å™¨"><a href="#1-JITç¼–è¯‘å™¨" class="headerlink" title="1. JITç¼–è¯‘å™¨"></a>1. <strong>JITç¼–è¯‘å™¨</strong></h4><p>PHP 8å¼•å…¥äº†JITï¼ˆJust-In-Timeï¼‰ç¼–è¯‘å¼•æ“ï¼Œæ˜¾è‘—æå‡æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨CPUå¯†é›†å‹ä»»åŠ¡ä¸Šè¡¨ç°çªå‡ºã€‚ è¿™æ˜¯PHPå†å²ä¸Šæœ€é‡å¤§çš„æ€§èƒ½æ”¹è¿›ä¹‹ä¸€ï¼Œå¯¹äºåœ¨çº¿å•†åº—ã€æ•°æ®åˆ†æç³»ç»Ÿæˆ–æœºå™¨å­¦ä¹ å·¥å…·ç­‰åº”ç”¨åœºæ™¯å°¤ä¸ºé‡è¦ã€‚</p><h4 id="2-è”åˆç±»å‹-Union-Types"><a href="#2-è”åˆç±»å‹-Union-Types" class="headerlink" title="2. è”åˆç±»å‹ (Union Types)"></a>2. <strong>è”åˆç±»å‹ (Union Types)</strong></h4><p>å…è®¸å‡½æ•°å‚æ•°ã€è¿”å›å€¼å’Œå±æ€§æ¥å—å¤šç§ç±»å‹ï¼Œä½¿ç”¨<code>|</code>ç¬¦å·åˆ†éš”ã€‚ä¾‹å¦‚ï¼š<code>function foo(string|int $param): bool|null &#123;&#125;</code>ã€‚è¿™å¤§å¤§å¢å¼ºäº†ç±»å‹ç³»ç»Ÿçš„çµæ´»æ€§å’Œè¡¨è¾¾èƒ½åŠ›ã€‚</p><h4 id="3-å‘½åå‚æ•°-Named-Arguments"><a href="#3-å‘½åå‚æ•°-Named-Arguments" class="headerlink" title="3. å‘½åå‚æ•° (Named Arguments)"></a>3. <strong>å‘½åå‚æ•° (Named Arguments)</strong></h4><p>å…è®¸åœ¨è°ƒç”¨å‡½æ•°æ—¶é€šè¿‡å‚æ•°åç§°æŒ‡å®šå‚æ•°ï¼Œè€Œä¸ä»…é™äºä½ç½®é¡ºåºã€‚è¿™æé«˜äº†ä»£ç å¯è¯»æ€§ï¼Œç‰¹åˆ«æ˜¯å½“å‡½æ•°æœ‰å¤šä¸ªå¯é€‰å‚æ•°æ—¶ã€‚</p><h4 id="4-å±æ€§-Attributes"><a href="#4-å±æ€§-Attributes" class="headerlink" title="4. å±æ€§ (Attributes)"></a>4. <strong>å±æ€§ (Attributes)</strong></h4><p>æ›¿ä»£ä¼ ç»Ÿçš„æ³¨é‡Šå¼æ³¨è§£ï¼Œæä¾›ç±»å‹å®‰å…¨çš„å…ƒæ•°æ®å£°æ˜æ–¹å¼ã€‚ä¾‹å¦‚ï¼š<code>#[Route(&#39;/api/users&#39;)]</code>ã€‚è¿™ä½¿å¾—æ¡†æ¶å’Œåº“å¯ä»¥æ›´å®‰å…¨ã€æ›´é«˜æ•ˆåœ°å¤„ç†å…ƒæ•°æ®ã€‚</p><h4 id="5-æ„é€ å™¨å±æ€§æå‡-Constructor-Property-Promotion"><a href="#5-æ„é€ å™¨å±æ€§æå‡-Constructor-Property-Promotion" class="headerlink" title="5. æ„é€ å™¨å±æ€§æå‡ (Constructor Property Promotion)"></a>5. <strong>æ„é€ å™¨å±æ€§æå‡ (Constructor Property Promotion)</strong></h4><p>åœ¨æ„é€ å‡½æ•°å‚æ•°ä¸­ç›´æ¥å£°æ˜ç±»å±æ€§ï¼Œå¤§å¹…ç®€åŒ–ç±»çš„å®šä¹‰ã€‚ä¾‹å¦‚ï¼š<code>public function __construct(public string $name) &#123;&#125;</code>ã€‚</p><h3 id="âš ï¸-é‡è¦è¯­æ³•æ”¹è¿›"><a href="#âš ï¸-é‡è¦è¯­æ³•æ”¹è¿›" class="headerlink" title="âš ï¸ é‡è¦è¯­æ³•æ”¹è¿›"></a>âš ï¸ é‡è¦è¯­æ³•æ”¹è¿›</h3><h4 id="6-Matchè¡¨è¾¾å¼"><a href="#6-Matchè¡¨è¾¾å¼" class="headerlink" title="6. Matchè¡¨è¾¾å¼"></a>6. <strong>Matchè¡¨è¾¾å¼</strong></h4><p>æ›¿ä»£ä¼ ç»Ÿçš„switchè¯­å¥ï¼Œæä¾›æ›´ç®€æ´ã€æ›´å¼ºå¤§çš„æ¨¡å¼åŒ¹é…åŠŸèƒ½ã€‚Matchè¡¨è¾¾å¼æ˜¯è¡¨è¾¾å¼è€Œéè¯­å¥ï¼Œå¯ä»¥è¿”å›å€¼ï¼Œä¸”å…·æœ‰æ›´ä¸¥æ ¼çš„æ¯”è¾ƒè§„åˆ™ã€‚</p><h4 id="7-ç©ºå®‰å…¨è¿ç®—ç¬¦-Nullsafe-Operator"><a href="#7-ç©ºå®‰å…¨è¿ç®—ç¬¦-Nullsafe-Operator" class="headerlink" title="7. ç©ºå®‰å…¨è¿ç®—ç¬¦ (Nullsafe Operator)"></a>7. <strong>ç©ºå®‰å…¨è¿ç®—ç¬¦ (Nullsafe Operator)</strong></h4><p>ä½¿ç”¨<code>?-&gt;</code>è¯­æ³•å®‰å…¨åœ°è®¿é—®å¯èƒ½ä¸ºnullçš„å¯¹è±¡å±æ€§æˆ–æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š<code>$obj?-&gt;property?-&gt;method()</code>ï¼Œå¦‚æœé“¾ä¸­ä»»ä½•éƒ¨åˆ†ä¸ºnullï¼Œæ•´ä¸ªè¡¨è¾¾å¼è¿”å›nullè€Œä¸æŠ›å‡ºå¼‚å¸¸ã€‚</p><h4 id="8-Mixedç±»å‹"><a href="#8-Mixedç±»å‹" class="headerlink" title="8. Mixedç±»å‹"></a>8. <strong>Mixedç±»å‹</strong></h4><p>å¼•å…¥<code>mixed</code>ç±»å‹ï¼Œè¡¨ç¤ºå‚æ•°æˆ–è¿”å›å€¼å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼Œè¿™åœ¨æ— æ³•ç²¾ç¡®æŒ‡å®šç±»å‹æ—¶éå¸¸æœ‰ç”¨ã€‚</p><h3 id="ğŸ”¥-éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ä¸å…¼å®¹å˜æ›´"><a href="#ğŸ”¥-éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ä¸å…¼å®¹å˜æ›´" class="headerlink" title="ğŸ”¥ éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ä¸å…¼å®¹å˜æ›´"></a>ğŸ”¥ éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ä¸å…¼å®¹å˜æ›´</h3><h4 id="9-ä¸¥æ ¼çš„é”™è¯¯å¤„ç†"><a href="#9-ä¸¥æ ¼çš„é”™è¯¯å¤„ç†" class="headerlink" title="9. ä¸¥æ ¼çš„é”™è¯¯å¤„ç†"></a>9. <strong>ä¸¥æ ¼çš„é”™è¯¯å¤„ç†</strong></h4><p>PHP 8å°†è®¸å¤šä»¥å‰çš„è­¦å‘Šå‡çº§ä¸ºErrorå¼‚å¸¸ã€‚ä¾‹å¦‚ï¼Œ<code>count()</code>å‡½æ•°åœ¨æ¥æ”¶éæ•°ç»„&#x2F;éCountableå‚æ•°æ—¶ç°åœ¨ä¼šæŠ›å‡ºTypeErrorè€Œä¸æ˜¯è¿”å›è­¦å‘Šã€‚</p><h4 id="10-å·²ç§»é™¤çš„å‡½æ•°å’Œæ‰©å±•"><a href="#10-å·²ç§»é™¤çš„å‡½æ•°å’Œæ‰©å±•" class="headerlink" title="10. å·²ç§»é™¤çš„å‡½æ•°å’Œæ‰©å±•"></a>10. <strong>å·²ç§»é™¤çš„å‡½æ•°å’Œæ‰©å±•</strong></h4><ul><li><code>money_format()</code>å‡½æ•°åœ¨PHP 8.0ä¸­è¢«å®Œå…¨ç§»é™¤ã€‚</li><li><code>utf8_encode()</code>å’Œ<code>utf8_decode()</code>å‡½æ•°åœ¨PHP 8.2ä¸­è¢«åºŸå¼ƒï¼Œæœªæ¥ç‰ˆæœ¬å°†ç§»é™¤ã€‚</li><li>è®¸å¤šåœ¨PHP 7.xä¸­å·²åºŸå¼ƒçš„å‡½æ•°åœ¨PHP 8ä¸­è¢«å½»åº•ç§»é™¤ã€‚</li></ul><h4 id="11-ç±»å‹ç³»ç»Ÿä¸¥æ ¼åŒ–"><a href="#11-ç±»å‹ç³»ç»Ÿä¸¥æ ¼åŒ–" class="headerlink" title="11. ç±»å‹ç³»ç»Ÿä¸¥æ ¼åŒ–"></a>11. <strong>ç±»å‹ç³»ç»Ÿä¸¥æ ¼åŒ–</strong></h4><p>PHP 8çš„ç±»å‹æ£€æŸ¥æ›´åŠ ä¸¥æ ¼ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå†…éƒ¨å‡½æ•°ã€‚è®¸å¤šå‡½æ•°ä¸å†æ¥å—nullå‚æ•°ï¼Œæˆ–è€…å¯¹å‚æ•°ç±»å‹æœ‰æ›´ä¸¥æ ¼çš„è¦æ±‚ã€‚</p><h3 id="ğŸ’¡-å‡çº§å»ºè®®"><a href="#ğŸ’¡-å‡çº§å»ºè®®" class="headerlink" title="ğŸ’¡ å‡çº§å»ºè®®"></a>ğŸ’¡ å‡çº§å»ºè®®</h3><h4 id="12-å…¼å®¹æ€§æ£€æŸ¥ä¼˜å…ˆ"><a href="#12-å…¼å®¹æ€§æ£€æŸ¥ä¼˜å…ˆ" class="headerlink" title="12. å…¼å®¹æ€§æ£€æŸ¥ä¼˜å…ˆ"></a>12. <strong>å…¼å®¹æ€§æ£€æŸ¥ä¼˜å…ˆ</strong></h4><p>åœ¨å‡çº§åˆ°PHP 8ä¹‹å‰ï¼Œå¿…é¡»é‡ç‚¹å¤„ç†ä¸‰å¤§ç±»æ”¹é€ ï¼šè¯­æ³•ç‰¹æ€§è¿ç§»ï¼ˆå¦‚matchè¡¨è¾¾å¼æ›¿ä»£switchï¼‰ã€ç±»å‹ç³»ç»Ÿå¢å¼ºï¼ˆè”åˆç±»å‹&#x2F;ä¸¥æ ¼æ¨¡å¼ï¼‰ã€åºŸå¼ƒç‰¹æ€§é‡æ„ï¼ˆåºåˆ—åŒ–æ¥å£&#x2F;åŠ¨æ€å±æ€§ï¼‰ã€‚</p><h4 id="13-é€æ­¥å‡çº§ç­–ç•¥"><a href="#13-é€æ­¥å‡çº§ç­–ç•¥" class="headerlink" title="13. é€æ­¥å‡çº§ç­–ç•¥"></a>13. <strong>é€æ­¥å‡çº§ç­–ç•¥</strong></h4><p>å»ºè®®å…ˆå‡çº§åˆ°PHP 7.4ä½œä¸ºè¿‡æ¸¡ç‰ˆæœ¬ï¼Œç„¶åå†å‡çº§åˆ°PHP 8.xã€‚PHP 7.4å·²ç»åŒ…å«äº†è®¸å¤šPHP 8çš„é¢„å¤‡ç‰¹æ€§ï¼Œå¯ä»¥å‡å°‘å‡çº§å†²å‡»ã€‚</p><h4 id="14-è‡ªåŠ¨åŒ–å·¥å…·è¾…åŠ©"><a href="#14-è‡ªåŠ¨åŒ–å·¥å…·è¾…åŠ©" class="headerlink" title="14. è‡ªåŠ¨åŒ–å·¥å…·è¾…åŠ©"></a>14. <strong>è‡ªåŠ¨åŒ–å·¥å…·è¾…åŠ©</strong></h4><p>ä½¿ç”¨PHPå…¼å®¹æ€§æ£€æŸ¥å·¥å…·æ‰«æä»£ç åº“ï¼Œè¯†åˆ«æ½œåœ¨çš„é—®é¢˜ç‚¹ã€‚ç‰¹åˆ«æ˜¯è¦æ³¨æ„é‚£äº›åœ¨PHP 8ä¸­è¡Œä¸ºå‘ç”Ÿæ”¹å˜çš„å‡½æ•°å’Œè¯­æ³•ç»“æ„ã€‚</p><h3 id="ğŸ“Š-æ€§èƒ½ä¸å®‰å…¨è€ƒé‡"><a href="#ğŸ“Š-æ€§èƒ½ä¸å®‰å…¨è€ƒé‡" class="headerlink" title="ğŸ“Š æ€§èƒ½ä¸å®‰å…¨è€ƒé‡"></a>ğŸ“Š æ€§èƒ½ä¸å®‰å…¨è€ƒé‡</h3><h4 id="15-JITé…ç½®ä¼˜åŒ–"><a href="#15-JITé…ç½®ä¼˜åŒ–" class="headerlink" title="15. JITé…ç½®ä¼˜åŒ–"></a>15. <strong>JITé…ç½®ä¼˜åŒ–</strong></h4><p>PHP 8.4ç‰ˆæœ¬è¿›ä¸€æ­¥å¢å¼ºäº†JITç¼–è¯‘å™¨çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨ç‰¹å®šåº”ç”¨åœºæ™¯ä¸‹ã€‚å¼€å‘è€…éœ€è¦äº†è§£å¦‚ä½•æ­£ç¡®é…ç½®JITä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚</p><h4 id="16-ç±»å‹å®‰å…¨æå‡"><a href="#16-ç±»å‹å®‰å…¨æå‡" class="headerlink" title="16. ç±»å‹å®‰å…¨æå‡"></a>16. <strong>ç±»å‹å®‰å…¨æå‡</strong></h4><p>PHP 8é€šè¿‡æ›´å¼ºçš„ç±»å‹æ£€æŸ¥ã€æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œç®€åŒ–å¸¸è§ä»»åŠ¡çš„å·¥å…·ï¼Œæ˜¾è‘—æé«˜äº†ä»£ç çš„å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><h3 id="ğŸ¯-å®è·µå»ºè®®"><a href="#ğŸ¯-å®è·µå»ºè®®" class="headerlink" title="ğŸ¯ å®è·µå»ºè®®"></a>ğŸ¯ å®è·µå»ºè®®</h3><ol><li><strong>æµ‹è¯•ç¯å¢ƒå…ˆè¡Œ</strong>ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒå‡çº§å‰ï¼ŒåŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒä¸­å……åˆ†éªŒè¯æ‰€æœ‰åŠŸèƒ½</li><li><strong>ä¾èµ–æ£€æŸ¥</strong>ï¼šç¡®ä¿æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“å’Œæ¡†æ¶éƒ½æ”¯æŒPHP 8</li><li><strong>æ¸è¿›å¼é‡‡ç”¨</strong>ï¼šæ–°é¡¹ç›®å¯ä»¥ç›´æ¥ä½¿ç”¨PHP 8çš„æ‰€æœ‰æ–°ç‰¹æ€§ï¼Œè€é¡¹ç›®å»ºè®®é€æ­¥è¿ç§»åˆ°æ–°è¯­æ³•</li><li><strong>ç›‘æ§å·¥å…·</strong>ï¼šå‡çº§åå¯†åˆ‡ç›‘æ§é”™è¯¯æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°å’Œä¿®å¤å…¼å®¹æ€§é—®é¢˜</li></ol><p>PHP 8ä¸ä»…å¸¦æ¥äº†è¯­æ³•ç³–å’Œæ€§èƒ½æå‡ï¼Œæ›´é‡è¦çš„æ˜¯é€šè¿‡ç±»å‹ç³»ç»Ÿå¢å¼ºå’Œä¸¥æ ¼çš„é”™è¯¯å¤„ç†ï¼Œæ˜¾è‘—æé«˜äº†PHPä»£ç çš„è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚å¼€å‘è€…åº”è¯¥ç§¯ææ‹¥æŠ±è¿™äº›å˜åŒ–ï¼Œä½†åŒæ—¶è¦è°¨æ…å¤„ç†å‡çº§è¿‡ç¨‹ä¸­çš„å…¼å®¹æ€§é—®é¢˜ã€‚</p><hr><h2 id="PHP-8ä¸­å¦‚ä½•ä½¿ç”¨JITç¼–è¯‘å™¨æå‡æ€§èƒ½ï¼Ÿ"><a href="#PHP-8ä¸­å¦‚ä½•ä½¿ç”¨JITç¼–è¯‘å™¨æå‡æ€§èƒ½ï¼Ÿ" class="headerlink" title="PHP 8ä¸­å¦‚ä½•ä½¿ç”¨JITç¼–è¯‘å™¨æå‡æ€§èƒ½ï¼Ÿ"></a>PHP 8ä¸­å¦‚ä½•ä½¿ç”¨JITç¼–è¯‘å™¨æå‡æ€§èƒ½ï¼Ÿ</h2><h3 id="ğŸš€-JITåŸºç¡€çŸ¥è¯†ä¸æ€§èƒ½æ”¶ç›Š"><a href="#ğŸš€-JITåŸºç¡€çŸ¥è¯†ä¸æ€§èƒ½æ”¶ç›Š" class="headerlink" title="ğŸš€ JITåŸºç¡€çŸ¥è¯†ä¸æ€§èƒ½æ”¶ç›Š"></a>ğŸš€ JITåŸºç¡€çŸ¥è¯†ä¸æ€§èƒ½æ”¶ç›Š</h3><p>PHP 8å¼•å…¥çš„JITï¼ˆJust-In-Timeï¼‰ç¼–è¯‘å™¨æ˜¯PHPå†å²ä¸Šæœ€é‡å¤§çš„æ€§èƒ½æ”¹è¿›ä¹‹ä¸€ï¼Œå®ƒèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶å°†PHPå­—èŠ‚ç ç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œæ˜¾è‘—æå‡æ‰§è¡Œæ•ˆç‡ã€‚ å®é™…æµ‹è¯•æ˜¾ç¤ºï¼Œå¯¹äºLaravelå’ŒSymfonyç­‰æ¡†æ¶ï¼Œå¯ç”¨JITåè¯·æ±‚å¤„ç†é€Ÿåº¦å¹³å‡æå‡15%-20%ã€‚ å¯¹äºå›¾åƒå¤„ç†ã€å¤§æ•°æ®åˆ†æç­‰CPUå¯†é›†å‹ä»»åŠ¡ï¼Œæ€§èƒ½æå‡æ•ˆæœæ›´åŠ æ˜æ˜¾ï¼Œç”šè‡³å¯ä»¥è¾¾åˆ°3å€çš„æ€§èƒ½æå‡ã€‚</p><h3 id="âš™ï¸-JITé…ç½®è¯¦è§£"><a href="#âš™ï¸-JITé…ç½®è¯¦è§£" class="headerlink" title="âš™ï¸ JITé…ç½®è¯¦è§£"></a>âš™ï¸ JITé…ç½®è¯¦è§£</h3><h4 id="1-åŸºç¡€é…ç½®è¦æ±‚"><a href="#1-åŸºç¡€é…ç½®è¦æ±‚" class="headerlink" title="1. åŸºç¡€é…ç½®è¦æ±‚"></a>1. åŸºç¡€é…ç½®è¦æ±‚</h4><p>JITç¼–è¯‘å™¨é›†æˆåœ¨Opcacheæ’ä»¶ä¸­ï¼Œä»…åœ¨å¯åŠ¨Opcacheæ’ä»¶æ—¶æ‰æœ‰æ•ˆï¼ŒJITæ˜¯åœ¨åŸæ¥Opcacheä¼˜åŒ–çš„åŸºç¡€ä¹‹ä¸Šè¿›è¡Œä¼˜åŒ–çš„ï¼Œä¸æ˜¯æ›¿ä»£å…³ç³»ã€‚ é€šè¿‡ä»¥ä¸‹é…ç½®å¯ç”¨JITï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[opcache]</span></span><br><span class="line"><span class="attr">opcache.enable</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">opcache.jit_buffer_size</span>=<span class="number">64</span>M</span><br><span class="line"><span class="attr">opcache.jit</span>=<span class="number">1205</span></span><br></pre></td></tr></table></figure><h4 id="2-å…³é”®é…ç½®å‚æ•°è¯´æ˜"><a href="#2-å…³é”®é…ç½®å‚æ•°è¯´æ˜" class="headerlink" title="2. å…³é”®é…ç½®å‚æ•°è¯´æ˜"></a>2. å…³é”®é…ç½®å‚æ•°è¯´æ˜</h4><p>**<code>opcache.jit_buffer_size</code>**ï¼šJITç¼–è¯‘å™¨çš„ç¼“å†²åŒºå¤§å°ï¼Œå†³å®šäº†JITç¼–è¯‘å™¨å¯ä»¥ä½¿ç”¨çš„å†…å­˜ç©ºé—´ã€‚ å»ºè®®æ ¹æ®åº”ç”¨è§„æ¨¡è®¾ç½®ï¼š</p><ul><li>å°å‹åº”ç”¨ï¼š32-64M</li><li>ä¸­å‹åº”ç”¨ï¼š64-128M  </li><li>å¤§å‹åº”ç”¨ï¼š128-256M</li></ul><p>**<code>opcache.jit</code>**ï¼šJITç¼–è¯‘å™¨çš„æ¨¡å¼é…ç½®ï¼Œè¿™ä¸ªé…ç½®å€¼çœ‹èµ·æ¥å¤æ‚ä½†å«ä¹‰æ˜ç¡®ã€‚ å¸¸ç”¨é…ç½®å€¼ï¼š</p><ul><li><code>1205</code>ï¼šæ¨èé…ç½®ï¼Œå¯ç”¨Tracing JITæ¨¡å¼</li><li><code>tracing</code>ï¼šç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æ¨¡å¼ï¼ˆPHP 8.1+æ”¯æŒï¼‰</li><li><code>function</code>ï¼šå‡½æ•°çº§JITæ¨¡å¼</li></ul><h4 id="3-é«˜çº§é…ç½®é€‰é¡¹"><a href="#3-é«˜çº§é…ç½®é€‰é¡¹" class="headerlink" title="3. é«˜çº§é…ç½®é€‰é¡¹"></a>3. é«˜çº§é…ç½®é€‰é¡¹</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">opcache.jit_debug</span>=<span class="number">0</span>        <span class="comment">; ç¦ç”¨JITè°ƒè¯•ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰</span></span><br><span class="line"><span class="attr">opcache.jit_hot_func</span>=<span class="number">10</span>   <span class="comment">; çƒ­ç‚¹å‡½æ•°é˜ˆå€¼</span></span><br><span class="line"><span class="attr">opcache.jit_hot_loop</span>=<span class="number">10</span>   <span class="comment">; çƒ­ç‚¹å¾ªç¯é˜ˆå€¼</span></span><br></pre></td></tr></table></figure><h3 id="ğŸ¯-é€‚ç”¨åœºæ™¯ä¸æ€§èƒ½ä¼˜åŒ–"><a href="#ğŸ¯-é€‚ç”¨åœºæ™¯ä¸æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="ğŸ¯ é€‚ç”¨åœºæ™¯ä¸æ€§èƒ½ä¼˜åŒ–"></a>ğŸ¯ é€‚ç”¨åœºæ™¯ä¸æ€§èƒ½ä¼˜åŒ–</h3><h4 id="1-æœ€ä½³é€‚ç”¨åœºæ™¯"><a href="#1-æœ€ä½³é€‚ç”¨åœºæ™¯" class="headerlink" title="1. æœ€ä½³é€‚ç”¨åœºæ™¯"></a>1. æœ€ä½³é€‚ç”¨åœºæ™¯</h4><p>JITç¼–è¯‘å™¨å¯¹ä»¥ä¸‹ç±»å‹çš„ä»£ç æ€§èƒ½æå‡æœ€æ˜¾è‘—ï¼š</p><ul><li><strong>æ•°å€¼è®¡ç®—å¯†é›†å‹ä»£ç </strong>ï¼šå¦‚ç§‘å­¦è®¡ç®—ã€æ•°æ®åˆ†æã€æœºå™¨å­¦ä¹ ç®—æ³• </li><li><strong>CPUå¯†é›†å‹ä»»åŠ¡</strong>ï¼šå›¾åƒå¤„ç†ã€è§†é¢‘ç¼–ç ã€å¯†ç å­¦è¿ç®— </li><li><strong>é•¿æ—¶é—´è¿è¡Œçš„CLIè„šæœ¬</strong>ï¼šæ‰¹å¤„ç†ä»»åŠ¡ã€é˜Ÿåˆ—å¤„ç†</li></ul><h4 id="2-Webåº”ç”¨ä¼˜åŒ–ç­–ç•¥"><a href="#2-Webåº”ç”¨ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="2. Webåº”ç”¨ä¼˜åŒ–ç­–ç•¥"></a>2. Webåº”ç”¨ä¼˜åŒ–ç­–ç•¥</h4><p>å¯¹äºå¸¸è§„Webåº”ç”¨ï¼ŒJITçš„æ€§èƒ½æå‡ç›¸å¯¹æœ‰é™ï¼Œä½†é€šè¿‡ä»¥ä¸‹ç­–ç•¥å¯ä»¥æœ€å¤§åŒ–æ”¶ç›Šï¼š</p><ul><li><strong>ä¼˜åŒ–çƒ­ç‚¹ä»£ç </strong>ï¼šè¯†åˆ«å¹¶ä¼˜åŒ–é¢‘ç¹æ‰§è¡Œçš„ä»£ç è·¯å¾„</li><li><strong>åˆç†é…ç½®ç¼“å†²åŒº</strong>ï¼šæ ¹æ®åº”ç”¨å†…å­˜ä½¿ç”¨æƒ…å†µè°ƒæ•´<code>jit_buffer_size</code></li><li><strong>æ¸è¿›å¼å¯ç”¨</strong>ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯åå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ</li></ul><h3 id="ğŸ“Š-æ€§èƒ½æµ‹è¯•ä¸ç›‘æ§"><a href="#ğŸ“Š-æ€§èƒ½æµ‹è¯•ä¸ç›‘æ§" class="headerlink" title="ğŸ“Š æ€§èƒ½æµ‹è¯•ä¸ç›‘æ§"></a>ğŸ“Š æ€§èƒ½æµ‹è¯•ä¸ç›‘æ§</h3><h4 id="1-åŸºå‡†æµ‹è¯•æ–¹æ³•"><a href="#1-åŸºå‡†æµ‹è¯•æ–¹æ³•" class="headerlink" title="1. åŸºå‡†æµ‹è¯•æ–¹æ³•"></a>1. åŸºå‡†æµ‹è¯•æ–¹æ³•</h4><p>é…ç½®å®Œæˆåï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•éªŒè¯JITæ•ˆæœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨PHPå†…ç½®çš„åŸºå‡†æµ‹è¯•å·¥å…·</span></span><br><span class="line">php -d opcache.jit_buffer_size=64M -d opcache.jit=1205 -r <span class="string">&quot;/* æµ‹è¯•ä»£ç  */&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ä½¿ç”¨ä¸“é—¨çš„åŸºå‡†æµ‹è¯•å·¥å…·</span></span><br><span class="line">ab -n 1000 -c 100 http://your-app.com/</span><br></pre></td></tr></table></figure><h4 id="2-æ€§èƒ½ç›‘æ§æŒ‡æ ‡"><a href="#2-æ€§èƒ½ç›‘æ§æŒ‡æ ‡" class="headerlink" title="2. æ€§èƒ½ç›‘æ§æŒ‡æ ‡"></a>2. æ€§èƒ½ç›‘æ§æŒ‡æ ‡</h4><ul><li><strong>è¯·æ±‚å“åº”æ—¶é—´</strong>ï¼šå¯¹æ¯”å¯ç”¨JITå‰åçš„å¹³å‡å“åº”æ—¶é—´</li><li><strong>CPUä½¿ç”¨ç‡</strong>ï¼šç›‘æ§JITå¯¹CPUèµ„æºçš„åˆ©ç”¨æƒ…å†µ </li><li><strong>å†…å­˜æ¶ˆè€—</strong>ï¼šç¡®ä¿JITç¼“å†²åŒºé…ç½®åˆç†ï¼Œé¿å…å†…å­˜æµªè´¹</li></ul><h3 id="âš ï¸-é‡è¦æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-é‡è¦æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹"></a>âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹</h3><h4 id="1-æ¶æ„é™åˆ¶"><a href="#1-æ¶æ„é™åˆ¶" class="headerlink" title="1. æ¶æ„é™åˆ¶"></a>1. æ¶æ„é™åˆ¶</h4><p>ç›®å‰PHP 8çš„JITä»…æ”¯æŒx86æ¶æ„çš„CPUï¼Œåœ¨ARMç­‰å…¶ä»–æ¶æ„ä¸Šå¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p><h4 id="2-é…ç½®ä¼˜åŒ–å»ºè®®"><a href="#2-é…ç½®ä¼˜åŒ–å»ºè®®" class="headerlink" title="2. é…ç½®ä¼˜åŒ–å»ºè®®"></a>2. é…ç½®ä¼˜åŒ–å»ºè®®</h4><ul><li><strong>å¼€å‘ç¯å¢ƒ</strong>ï¼šå¯ä»¥è®¾ç½®è¾ƒå°çš„ç¼“å†²åŒºï¼ˆ32Mï¼‰å¹¶å¯ç”¨è°ƒè¯•æ¨¡å¼</li><li><strong>ç”Ÿäº§ç¯å¢ƒ</strong>ï¼šå»ºè®®è®¾ç½®64-128Mç¼“å†²åŒºï¼Œç¦ç”¨è°ƒè¯•æ¨¡å¼</li><li><strong>å†…å­˜é™åˆ¶</strong>ï¼šç¡®ä¿æœåŠ¡å™¨æœ‰è¶³å¤Ÿå†…å­˜åˆ†é…ç»™JITç¼“å†²åŒºï¼Œé¿å…å†…å­˜ä¸è¶³é—®é¢˜</li></ul><h4 id="3-ç‰ˆæœ¬å…¼å®¹æ€§"><a href="#3-ç‰ˆæœ¬å…¼å®¹æ€§" class="headerlink" title="3. ç‰ˆæœ¬å…¼å®¹æ€§"></a>3. ç‰ˆæœ¬å…¼å®¹æ€§</h4><p>PHP 8.4è¿›ä¸€æ­¥å¢å¼ºäº†JITç¼–è¯‘å™¨çš„æ€§èƒ½å’Œç¨³å®šæ€§ï¼Œå»ºè®®ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚ åœ¨å‡çº§PHPç‰ˆæœ¬æ—¶ï¼Œéœ€è¦é‡æ–°éªŒè¯JITé…ç½®çš„æœ‰æ•ˆæ€§ã€‚</p><h3 id="ğŸš€-å®æˆ˜ä¼˜åŒ–ç¤ºä¾‹"><a href="#ğŸš€-å®æˆ˜ä¼˜åŒ–ç¤ºä¾‹" class="headerlink" title="ğŸš€ å®æˆ˜ä¼˜åŒ–ç¤ºä¾‹"></a>ğŸš€ å®æˆ˜ä¼˜åŒ–ç¤ºä¾‹</h3><h4 id="1-æ•°å€¼è®¡ç®—ä¼˜åŒ–"><a href="#1-æ•°å€¼è®¡ç®—ä¼˜åŒ–" class="headerlink" title="1. æ•°å€¼è®¡ç®—ä¼˜åŒ–"></a>1. æ•°å€¼è®¡ç®—ä¼˜åŒ–</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœªä¼˜åŒ–çš„ä»£ç </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculate</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="variable">$result</span> += <span class="variable">$value</span> * <span class="number">1.5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JITä¼˜åŒ–åçš„ä»£ç ï¼ˆç›¸åŒä»£ç ï¼ŒJITè‡ªåŠ¨ä¼˜åŒ–ï¼‰</span></span><br><span class="line"><span class="comment">// æ€§èƒ½æå‡å¯è¾¾2-3å€</span></span><br></pre></td></tr></table></figure><h4 id="2-é…ç½®æ–‡ä»¶æ¨¡æ¿"><a href="#2-é…ç½®æ–‡ä»¶æ¨¡æ¿" class="headerlink" title="2. é…ç½®æ–‡ä»¶æ¨¡æ¿"></a>2. é…ç½®æ–‡ä»¶æ¨¡æ¿</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®</span></span><br><span class="line"><span class="section">[opcache]</span></span><br><span class="line"><span class="attr">opcache.enable</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">opcache.memory_consumption</span>=<span class="number">256</span></span><br><span class="line"><span class="attr">opcache.interned_strings_buffer</span>=<span class="number">16</span></span><br><span class="line"><span class="attr">opcache.max_accelerated_files</span>=<span class="number">20000</span></span><br><span class="line"><span class="attr">opcache.validate_timestamps</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">opcache.save_comments</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">opcache.enable_cli</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; JITé…ç½®</span></span><br><span class="line"><span class="attr">opcache.jit_buffer_size</span>=<span class="number">128</span>M</span><br><span class="line"><span class="attr">opcache.jit</span>=<span class="number">1205</span></span><br><span class="line"><span class="attr">opcache.jit_debug</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="ğŸ”®-æœªæ¥å±•æœ›"><a href="#ğŸ”®-æœªæ¥å±•æœ›" class="headerlink" title="ğŸ”® æœªæ¥å±•æœ›"></a>ğŸ”® æœªæ¥å±•æœ›</h3><p>PHP JITç¼–è¯‘å™¨ä»åœ¨æŒç»­æ”¹è¿›ä¸­ï¼Œæœªæ¥çš„PHPç‰ˆæœ¬å°†è¿›ä¸€æ­¥ä¼˜åŒ–JITæ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨Webåº”ç”¨åœºæ™¯ä¸‹çš„è¡¨ç°ã€‚ å¼€å‘è€…åº”è¯¥ä¿æŒå…³æ³¨PHPå®˜æ–¹æ–‡æ¡£å’Œç¤¾åŒºåŠ¨æ€ï¼ŒåŠæ—¶äº†è§£æœ€æ–°çš„JITä¼˜åŒ–ç­–ç•¥å’Œæœ€ä½³å®è·µã€‚</p><hr><h2 id="PHP-8-JITç¼–è¯‘å™¨æ€§èƒ½æå‡æœ€æ˜æ˜¾çš„åœºæ™¯åˆ†æ"><a href="#PHP-8-JITç¼–è¯‘å™¨æ€§èƒ½æå‡æœ€æ˜æ˜¾çš„åœºæ™¯åˆ†æ" class="headerlink" title="PHP 8 JITç¼–è¯‘å™¨æ€§èƒ½æå‡æœ€æ˜æ˜¾çš„åœºæ™¯åˆ†æ"></a>PHP 8 JITç¼–è¯‘å™¨æ€§èƒ½æå‡æœ€æ˜æ˜¾çš„åœºæ™¯åˆ†æ</h2><p>PHP 8çš„JITï¼ˆJust-In-Timeï¼‰ç¼–è¯‘å™¨åœ¨ç‰¹å®šåœºæ™¯ä¸‹èƒ½å¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½æå‡ï¼Œä½†å¹¶éæ‰€æœ‰åº”ç”¨åœºæ™¯éƒ½èƒ½è·å¾—åŒç­‰ç¨‹åº¦çš„ä¼˜åŒ–ã€‚ä»¥ä¸‹æ˜¯JITæ€§èƒ½æå‡æœ€æ˜æ˜¾çš„å…·ä½“åœºæ™¯ï¼š</p><h3 id="ğŸš€-1-CPUå¯†é›†å‹è®¡ç®—ä»»åŠ¡"><a href="#ğŸš€-1-CPUå¯†é›†å‹è®¡ç®—ä»»åŠ¡" class="headerlink" title="ğŸš€ 1. CPUå¯†é›†å‹è®¡ç®—ä»»åŠ¡"></a>ğŸš€ 1. CPUå¯†é›†å‹è®¡ç®—ä»»åŠ¡</h3><h4 id="æ•°å­¦è¿ç®—å’Œç®—æ³•"><a href="#æ•°å­¦è¿ç®—å’Œç®—æ³•" class="headerlink" title="æ•°å­¦è¿ç®—å’Œç®—æ³•"></a>æ•°å­¦è¿ç®—å’Œç®—æ³•</h4><ul><li><strong>æ–æ³¢é‚£å¥‘æ•°åˆ—è®¡ç®—</strong>ï¼šBenchmarkæµ‹è¯•è¡¨æ˜ï¼ŒJITå¯ä½¿è¿™ç±»æ•°å­¦å¯†é›†å‹å‡½æ•°è·å¾—10-30%çš„æ€§èƒ½æå‡ã€‚</li><li><strong>å¤æ‚æ•°å­¦è¿ç®—</strong>ï¼šPHP 8+ JITå…è®¸PHPæ‰§è¡Œæ•°å­¦å’ŒCPUå¯†é›†å‹æ“ä½œçš„é€Ÿåº¦å¤§å¹…æå‡ã€‚</li><li><strong>ç§‘å­¦è®¡ç®—</strong>ï¼šå¯¹äºéœ€è¦å¤§é‡æ•°å€¼è®¡ç®—çš„åº”ç”¨ï¼ŒJITç¼–è¯‘å™¨èƒ½å°†ä»£ç æ‰§è¡Œé€Ÿåº¦æé«˜2å€ä»¥ä¸Šã€‚</li></ul><h4 id="ä»£ç è§£æå’Œç¼–è¯‘"><a href="#ä»£ç è§£æå’Œç¼–è¯‘" class="headerlink" title="ä»£ç è§£æå’Œç¼–è¯‘"></a>ä»£ç è§£æå’Œç¼–è¯‘</h4><ul><li><strong>PHP-Parseræ€§èƒ½</strong>ï¼šnikic&#x2F;PHP-Parseråœ¨Nikita Popovçš„åŸºå‡†æµ‹è¯•ä¸­è¿è¡Œé€Ÿåº¦æå‡äº†çº¦1.3å€ã€‚</li><li><strong>æ¨¡æ¿å¼•æ“</strong>ï¼šå¯¹äºéœ€è¦å®æ—¶ç¼–è¯‘æ¨¡æ¿çš„ç³»ç»Ÿï¼ŒJITèƒ½æ˜¾è‘—å‡å°‘ç¼–è¯‘æ—¶é—´ã€‚</li></ul><h3 id="ğŸ”¥-2-å¤§æ•°æ®å¤„ç†å’Œå¾ªç¯å¯†é›†å‹åº”ç”¨"><a href="#ğŸ”¥-2-å¤§æ•°æ®å¤„ç†å’Œå¾ªç¯å¯†é›†å‹åº”ç”¨" class="headerlink" title="ğŸ”¥ 2. å¤§æ•°æ®å¤„ç†å’Œå¾ªç¯å¯†é›†å‹åº”ç”¨"></a>ğŸ”¥ 2. å¤§æ•°æ®å¤„ç†å’Œå¾ªç¯å¯†é›†å‹åº”ç”¨</h3><h4 id="é‡å‹å¾ªç¯å¤„ç†"><a href="#é‡å‹å¾ªç¯å¤„ç†" class="headerlink" title="é‡å‹å¾ªç¯å¤„ç†"></a>é‡å‹å¾ªç¯å¤„ç†</h4><ul><li><strong>å¤§å‹æ•°ç»„æ“ä½œ</strong>ï¼šBenchmarksæ˜¾ç¤ºï¼Œé‡å‹å¾ªç¯æˆ–æ•°å­¦è¿ç®—åœ¨å¯ç”¨JITåæ‰§è¡Œé€Ÿåº¦æ˜æ˜¾æ›´å¿«ã€‚</li><li><strong>æ•°æ®è½¬æ¢å’Œå¤„ç†</strong>ï¼šå¯¹äºéœ€è¦éå†å¤§é‡æ•°æ®é›†å¹¶è¿›è¡Œå¤æ‚è½¬æ¢çš„åº”ç”¨ï¼ŒJITä¼˜åŒ–æ•ˆæœæ˜¾è‘—ã€‚</li></ul><h4 id="æ‰¹å¤„ç†ä»»åŠ¡"><a href="#æ‰¹å¤„ç†ä»»åŠ¡" class="headerlink" title="æ‰¹å¤„ç†ä»»åŠ¡"></a>æ‰¹å¤„ç†ä»»åŠ¡</h4><ul><li><strong>CLIè„šæœ¬</strong>ï¼šé•¿æ—¶é—´è¿è¡Œçš„å‘½ä»¤è¡Œè„šæœ¬ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å¤„ç†å¤§é‡æ•°æ®çš„æ‰¹å¤„ç†ä»»åŠ¡ï¼Œèƒ½è·å¾—æœ€æ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚</li><li><strong>é˜Ÿåˆ—å¤„ç†</strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…å¤„ç†å¤§é‡ä»»åŠ¡æ—¶ï¼ŒJITèƒ½æœ‰æ•ˆå‡å°‘å¤„ç†å»¶è¿Ÿã€‚</li></ul><h3 id="âš¡-3-å¼‚æ­¥å’Œå¹¶å‘ç¼–ç¨‹"><a href="#âš¡-3-å¼‚æ­¥å’Œå¹¶å‘ç¼–ç¨‹" class="headerlink" title="âš¡ 3. å¼‚æ­¥å’Œå¹¶å‘ç¼–ç¨‹"></a>âš¡ 3. å¼‚æ­¥å’Œå¹¶å‘ç¼–ç¨‹</h3><h4 id="å¼‚æ­¥æ¡†æ¶æ€§èƒ½"><a href="#å¼‚æ­¥æ¡†æ¶æ€§èƒ½" class="headerlink" title="å¼‚æ­¥æ¡†æ¶æ€§èƒ½"></a>å¼‚æ­¥æ¡†æ¶æ€§èƒ½</h4><ul><li><strong>Ampæ¡†æ¶</strong>ï¼šä½¿ç”¨Ampç¼–å†™çš„hello worldåº”ç”¨ç¨‹åºåœ¨JITå¯ç”¨åæ€§èƒ½æ˜¾è‘—æå‡ã€‚</li><li><strong>Fiberså’Œåç¨‹</strong>ï¼šPHP 8.3+çš„Fibersä¸JITç»“åˆï¼Œèƒ½å¤§å¹…æå‡å¼‚æ­¥åº”ç”¨çš„æ€§èƒ½ã€‚</li></ul><h3 id="ğŸ“Š-4-å…·ä½“æ€§èƒ½æ•°æ®"><a href="#ğŸ“Š-4-å…·ä½“æ€§èƒ½æ•°æ®" class="headerlink" title="ğŸ“Š 4. å…·ä½“æ€§èƒ½æ•°æ®"></a>ğŸ“Š 4. å…·ä½“æ€§èƒ½æ•°æ®</h3><h4 id="åŸºå‡†æµ‹è¯•ç»“æœ"><a href="#åŸºå‡†æµ‹è¯•ç»“æœ" class="headerlink" title="åŸºå‡†æµ‹è¯•ç»“æœ"></a>åŸºå‡†æµ‹è¯•ç»“æœ</h4><ul><li><strong>ç»¼åˆåŸºå‡†æµ‹è¯•</strong>ï¼šå®˜æ–¹bench.phpæµ‹è¯•æ˜¾ç¤ºï¼ŒJITä½¿æ‰§è¡Œæ—¶é—´ä»0.320ç§’å‡å°‘åˆ°0.140ç§’ï¼Œæ€§èƒ½æå‡è¶…è¿‡ä¸¤å€ã€‚</li><li><strong>ç°å®åº”ç”¨</strong>ï¼šå¯¹äºå¤§å¤šæ•°CPUå¯†é›†å‹å·¥ä½œè´Ÿè½½ï¼ŒJITé¢„è®¡èƒ½å¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚</li></ul><h4 id="ç‰ˆæœ¬æ¼”è¿›"><a href="#ç‰ˆæœ¬æ¼”è¿›" class="headerlink" title="ç‰ˆæœ¬æ¼”è¿›"></a>ç‰ˆæœ¬æ¼”è¿›</h4><ul><li><strong>PHP 8.4æ”¹è¿›</strong>ï¼šæœ€æ–°ç‰ˆæœ¬çš„JITè¿›ä¸€æ­¥ä¼˜åŒ–äº†CPUå¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ï¼ŒåŸºå‡†æµ‹è¯•æ˜¾ç¤ºæ¯”PHP 8.3æœ‰æ˜æ˜¾æå‡ã€‚</li></ul><h3 id="âš ï¸-5-æ€§èƒ½æå‡æœ‰é™çš„åœºæ™¯"><a href="#âš ï¸-5-æ€§èƒ½æå‡æœ‰é™çš„åœºæ™¯" class="headerlink" title="âš ï¸ 5. æ€§èƒ½æå‡æœ‰é™çš„åœºæ™¯"></a>âš ï¸ 5. æ€§èƒ½æå‡æœ‰é™çš„åœºæ™¯</h3><h4 id="I-x2F-Oå¯†é›†å‹åº”ç”¨"><a href="#I-x2F-Oå¯†é›†å‹åº”ç”¨" class="headerlink" title="I&#x2F;Oå¯†é›†å‹åº”ç”¨"></a>I&#x2F;Oå¯†é›†å‹åº”ç”¨</h4><ul><li><strong>Webè¯·æ±‚å¤„ç†</strong>ï¼šå¯¹äºå…¸å‹çš„Webåº”ç”¨ï¼ˆå¦‚WordPressã€Laravelåº”ç”¨ï¼‰ï¼Œå¦‚æœä¸»è¦ç“¶é¢ˆæ˜¯æ•°æ®åº“I&#x2F;Oæˆ–ç½‘ç»œè¯·æ±‚ï¼ŒJITå¸¦æ¥çš„æ€§èƒ½æå‡ç›¸å¯¹æœ‰é™ã€‚</li><li><strong>æ–‡ä»¶æ“ä½œ</strong>ï¼šå¤§é‡æ–‡ä»¶è¯»å†™æ“ä½œçš„æ€§èƒ½ä¸»è¦å—é™äºç£ç›˜I&#x2F;Oï¼ŒJITä¼˜åŒ–æ•ˆæœä¸æ˜æ˜¾ã€‚</li></ul><h4 id="å†…å­˜å¯†é›†å‹ä»»åŠ¡"><a href="#å†…å­˜å¯†é›†å‹ä»»åŠ¡" class="headerlink" title="å†…å­˜å¯†é›†å‹ä»»åŠ¡"></a>å†…å­˜å¯†é›†å‹ä»»åŠ¡</h4><ul><li><strong>å¤§å¯¹è±¡å¤„ç†</strong>ï¼šå½“åº”ç”¨ä¸»è¦å—é™äºå†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶æ—¶ï¼ŒJITçš„æ€§èƒ½ä¼˜åŠ¿æ— æ³•å……åˆ†å‘æŒ¥ã€‚</li></ul><h3 id="ğŸ¯-6-æœ€ä½³å®è·µå»ºè®®"><a href="#ğŸ¯-6-æœ€ä½³å®è·µå»ºè®®" class="headerlink" title="ğŸ¯ 6. æœ€ä½³å®è·µå»ºè®®"></a>ğŸ¯ 6. æœ€ä½³å®è·µå»ºè®®</h3><h4 id="è¯†åˆ«ä¼˜åŒ–ç›®æ ‡"><a href="#è¯†åˆ«ä¼˜åŒ–ç›®æ ‡" class="headerlink" title="è¯†åˆ«ä¼˜åŒ–ç›®æ ‡"></a>è¯†åˆ«ä¼˜åŒ–ç›®æ ‡</h4><ul><li><strong>æ€§èƒ½åˆ†æ</strong>ï¼šä½¿ç”¨å·¥å…·è¯†åˆ«åº”ç”¨ä¸­çš„CPUçƒ­ç‚¹ï¼Œä¼˜å…ˆä¼˜åŒ–è¿™äº›éƒ¨åˆ†ã€‚</li><li><strong>åˆ†é˜¶æ®µæµ‹è¯•</strong>ï¼šCompare JIT performance by benchmarking CPU-intensive sections with and without JIT enabled.</li></ul><h4 id="é…ç½®ä¼˜åŒ–"><a href="#é…ç½®ä¼˜åŒ–" class="headerlink" title="é…ç½®ä¼˜åŒ–"></a>é…ç½®ä¼˜åŒ–</h4><ul><li><strong>ç¼“å†²åŒºå¤§å°</strong>ï¼šæ ¹æ®åº”ç”¨éœ€æ±‚åˆç†é…ç½®<code>opcache.jit_buffer_size</code>ï¼Œé€šå¸¸64-128MBé€‚åˆå¤§å¤šæ•°CPUå¯†é›†å‹åº”ç”¨ã€‚</li><li><strong>JITæ¨¡å¼é€‰æ‹©</strong>ï¼šå¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œé€‰æ‹©<code>tracing</code>æ¨¡å¼é€šå¸¸èƒ½è·å¾—æœ€ä½³æ€§èƒ½ã€‚</li></ul><h3 id="ğŸ’¡-æœ€åå‘æé†’çš„æ˜¯ï¼Œä¸šåŠ¡å¼€å‘ä¸­è¦è¿›è¡Œç»¼åˆè¯„ä¼°å’Œå–èˆ"><a href="#ğŸ’¡-æœ€åå‘æé†’çš„æ˜¯ï¼Œä¸šåŠ¡å¼€å‘ä¸­è¦è¿›è¡Œç»¼åˆè¯„ä¼°å’Œå–èˆ" class="headerlink" title="ğŸ’¡ æœ€åå‘æé†’çš„æ˜¯ï¼Œä¸šåŠ¡å¼€å‘ä¸­è¦è¿›è¡Œç»¼åˆè¯„ä¼°å’Œå–èˆ"></a>ğŸ’¡ æœ€åå‘æé†’çš„æ˜¯ï¼Œä¸šåŠ¡å¼€å‘ä¸­è¦è¿›è¡Œç»¼åˆè¯„ä¼°å’Œå–èˆ</h3><p>PHP 8çš„JITç¼–è¯‘å™¨æœ€é€‚åˆ<strong>CPUå¯†é›†å‹ã€è®¡ç®—å¯†é›†å‹</strong>çš„åº”ç”¨åœºæ™¯ï¼ŒåŒ…æ‹¬æ•°å­¦è¿ç®—ã€æ•°æ®å¤„ç†ã€ä»£ç è§£æã€å¼‚æ­¥ç¼–ç¨‹ç­‰ã€‚ å¯¹äºè¿™äº›åœºæ™¯ï¼Œæ€§èƒ½æå‡å¯è¾¾10-30%ï¼Œç”šè‡³åœ¨æŸäº›æç«¯æƒ…å†µä¸‹è¾¾åˆ°2å€ä»¥ä¸Šã€‚ ç„¶è€Œï¼Œå¯¹äºI&#x2F;Oå¯†é›†å‹çš„Webåº”ç”¨ï¼Œæ€§èƒ½æå‡ç›¸å¯¹æœ‰é™ï¼Œå¼€å‘è€…éœ€è¦æ ¹æ®å®é™…åº”ç”¨åœºæ™¯åˆç†è¯„ä¼°JITçš„ä»·å€¼ã€‚</p><p>åœ¨è€ƒè™‘å¯ç”¨JITæ—¶ï¼Œå»ºè®®å…ˆè¿›è¡Œé’ˆå¯¹æ€§çš„åŸºå‡†æµ‹è¯•ï¼Œè¯†åˆ«åº”ç”¨ä¸­çš„CPUçƒ­ç‚¹ï¼Œç„¶åæ ¹æ®æµ‹è¯•ç»“æœå†³å®šæ˜¯å¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨JITç¼–è¯‘å™¨ã€‚</p><p><em>æœ¬æ–‡ç‰ˆæœ¬æ¢³ç†æˆªè‡³æœ€åæ—¥æœŸæ›´æ–°ï¼š2026å¹´1æœˆ8æ—¥</em>  </p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;PHPä½œä¸ºå…¨çƒæœ€æµè¡Œçš„æœåŠ¡å™¨ç«¯è„šæœ¬è¯­è¨€ä¹‹ä¸€ï¼Œå…¶ç‰ˆæœ¬è¿­ä»£å§‹ç»ˆå¤‡å—å¼€å‘è€…å…³æ³¨ã€‚&lt;br&gt;â€œPHPæ˜¯ä¸–ç•Œä¸Šæœ€å¥½çš„ç¼–ç¨‹è¯­è¨€â€ï¼Œæ›¾ç»è¢«æ— æ•°äººè°ƒä¾ƒè®½åˆºï¼Œä½†PHPä¾ç„¶æ˜¯ç¼–ç¨‹è¯­è¨€çš„ä¸»åŠ›è¯­è¨€ï¼Œè¶³å¤Ÿç®€æ´ã€å®ç”¨ï¼Œå°¤å…¶åœ¨å¼•å…¥JITçš„ç‰¹æ€§ä¸‹ï¼ŒPHPæœªæ¥å¯æœŸã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="php" scheme="https://www.wdft.com/categories/php/"/>
    
    
    <category term="changelog" scheme="https://www.wdft.com/tags/changelog/"/>
    
    <category term="php" scheme="https://www.wdft.com/tags/php/"/>
    
    <category term="history" scheme="https://www.wdft.com/tags/history/"/>
    
  </entry>
  
  <entry>
    <title>MongoDBæ·±åº¦è§£æå®æˆ˜æŒ‡å—ï¼šä»åŸç†åˆ°ç”Ÿäº§éƒ¨ç½²ä»¥åŠä¸»æµè¯­è¨€å®è·µ</title>
    <link href="https://www.wdft.com/46b9fbaf.html"/>
    <id>https://www.wdft.com/46b9fbaf.html</id>
    <published>2026-01-03T15:17:29.000Z</published>
    <updated>2026-01-26T09:45:26.498Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><hr><h2 id="ä¸€ã€MongoDBæ ¸å¿ƒåŸç†ä¸æ•°æ®ç»“æ„æ·±åº¦è§£æ"><a href="#ä¸€ã€MongoDBæ ¸å¿ƒåŸç†ä¸æ•°æ®ç»“æ„æ·±åº¦è§£æ" class="headerlink" title="ä¸€ã€MongoDBæ ¸å¿ƒåŸç†ä¸æ•°æ®ç»“æ„æ·±åº¦è§£æ"></a>ä¸€ã€MongoDBæ ¸å¿ƒåŸç†ä¸æ•°æ®ç»“æ„æ·±åº¦è§£æ</h2><p>æœ¬æ–‡æ¶‰åŠDemoä»£ç ç¤ºä¾‹ä»¥å¸¸ç”¨Debian 12 LTSç‰ˆç³»ç»Ÿç¯å¢ƒä¸ºä¾‹ï¼Œæ­¤ä¹Ÿæ˜¯ä¸ªäººå¸¸ç”¨å¼€å‘æµ‹è¯•ç³»ç»Ÿç‰ˆæœ¬ï¼Œæ¨èï¼š</p><blockquote><p><strong>é€‚ç”¨ç‰ˆæœ¬</strong>ï¼šMongoDB 7.0 LTS (æœ€æ–°ç¨³å®šç‰ˆ)<br><strong>æ“ä½œç³»ç»Ÿ</strong>ï¼šDebian 12 (Bookworm) </p></blockquote><span id="more"></span><h3 id="1-1-æ–‡æ¡£æ•°æ®åº“çš„æœ¬è´¨"><a href="#1-1-æ–‡æ¡£æ•°æ®åº“çš„æœ¬è´¨" class="headerlink" title="1.1 æ–‡æ¡£æ•°æ®åº“çš„æœ¬è´¨"></a>1.1 æ–‡æ¡£æ•°æ®åº“çš„æœ¬è´¨</h3><p>MongoDBä½œä¸ºé¢å‘æ–‡æ¡£çš„NoSQLæ•°æ®åº“ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯<strong>çµæ´»çš„æ¨¡å¼</strong>ï¼ˆSchema-lessï¼‰ä¸<strong>JSON-likeæ–‡æ¡£å­˜å‚¨</strong>ã€‚<br>ä¸ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“çš„è¡Œ&#x2F;åˆ—ç»“æ„ä¸åŒï¼ŒMongoDBä»¥BSONï¼ˆBinary JSONï¼‰æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œæ¯ä¸ªæ–‡æ¡£éƒ½æ˜¯è‡ªåŒ…å«çš„ã€å…·æœ‰åŠ¨æ€ç»“æ„çš„ç‹¬ç«‹å•å…ƒã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿå…³ç³»å‹ vs MongoDBæ–‡æ¡£ç»“æ„å¯¹æ¯”</span></span><br><span class="line"><span class="comment">// å…³ç³»å‹ï¼ˆå¤šè¡¨å…³è”ï¼‰ï¼š</span></span><br><span class="line">usersè¡¨<span class="punctuation">:</span> <span class="punctuation">&#123;</span>id<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> name<span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰&quot;</span><span class="punctuation">,</span> dept_id<span class="punctuation">:</span> <span class="number">101</span><span class="punctuation">&#125;</span></span><br><span class="line">departmentsè¡¨<span class="punctuation">:</span> <span class="punctuation">&#123;</span>id<span class="punctuation">:</span> <span class="number">101</span><span class="punctuation">,</span> name<span class="punctuation">:</span> <span class="string">&quot;æŠ€æœ¯éƒ¨&quot;</span><span class="punctuation">,</span> manager<span class="punctuation">:</span> <span class="string">&quot;æå››&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MongoDBï¼ˆåµŒå¥—æ–‡æ¡£ï¼‰ï¼š</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> ObjectId(<span class="string">&quot;[Object ID]&quot;</span>)<span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;department&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æŠ€æœ¯éƒ¨&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;manager&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æå››&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;åŒ—äº¬&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;skills&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Go&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Python&quot;</span><span class="punctuation">,</span> <span class="string">&quot;MongoDB&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;projects&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ä¸šåŠ¡å¹³å°é‡æ„&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;åç«¯å¼€å‘&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6ä¸ªæœˆ&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> ISODate(<span class="string">&quot;2026-01-03T23:30:01Z&quot;</span>)</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="1-2-BSONæ•°æ®ç±»å‹è¯¦è§£"><a href="#1-2-BSONæ•°æ®ç±»å‹è¯¦è§£" class="headerlink" title="1.2 BSONæ•°æ®ç±»å‹è¯¦è§£"></a>1.2 BSONæ•°æ®ç±»å‹è¯¦è§£</h3><p>MongoDBä½¿ç”¨BSONï¼ˆBinary Serialized Object Notationï¼‰ä½œä¸ºå­˜å‚¨æ ¼å¼ï¼Œæ”¯æŒä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼š</p><table><thead><tr><th>ç±»å‹</th><th>æè¿°</th><th>ç¤ºä¾‹</th><th>é‡è¦æ€§</th></tr></thead><tbody><tr><td><strong>ObjectId</strong></td><td>12å­—èŠ‚å”¯ä¸€æ ‡è¯†ç¬¦</td><td><code>_id: ObjectId(&quot;507f1f77bcf86cd799439011&quot;)</code></td><td>â­â­â­â­â­</td></tr><tr><td><strong>String</strong></td><td>UTF-8å­—ç¬¦ä¸²</td><td><code>&quot;name&quot;: &quot;å¼ ä¸‰&quot;</code></td><td>â­â­â­â­â­</td></tr><tr><td><strong>Date</strong></td><td>64ä½æ•´æ•°æ—¶é—´æˆ³</td><td><code>&quot;created_at&quot;: ISODate(&quot;2026-01-21T10:30:00Z&quot;)</code></td><td>â­â­â­â­</td></tr><tr><td><strong>Array</strong></td><td>æœ‰åºæ•°ç»„</td><td><code>&quot;skills&quot;: [&quot;Go&quot;, &quot;Python&quot;]</code></td><td>â­â­â­â­â­</td></tr><tr><td><strong>Object</strong></td><td>åµŒå¥—æ–‡æ¡£</td><td><code>&quot;department&quot;: &#123; &quot;name&quot;: &quot;æŠ€æœ¯éƒ¨&quot; &#125;</code></td><td>â­â­â­â­â­</td></tr><tr><td><strong>Decimal128</strong></td><td>é«˜ç²¾åº¦å°æ•°</td><td><code>&quot;price&quot;: NumberDecimal(&quot;19.99&quot;)</code></td><td>â­â­â­â­</td></tr><tr><td><strong>Binary</strong></td><td>äºŒè¿›åˆ¶æ•°æ®</td><td><code>&quot;avatar&quot;: BinData(0, &quot;base64data&quot;)</code></td><td>â­â­â­</td></tr><tr><td><strong>Timestamp</strong></td><td>å†…éƒ¨æ“ä½œæ—¶é—´æˆ³</td><td>ç”±MongoDBå†…éƒ¨ä½¿ç”¨</td><td>â­â­</td></tr></tbody></table><p><strong>å…³é”®ç‰¹æ€§</strong>ï¼š</p><ul><li><strong>åŠ¨æ€æ¨¡å¼</strong>ï¼šåŒä¸€é›†åˆä¸­çš„æ–‡æ¡£å¯ä»¥æœ‰ä¸åŒçš„å­—æ®µç»“æ„</li><li><strong>åŸå­æ€§</strong>ï¼šå•æ–‡æ¡£æ“ä½œæ˜¯åŸå­çš„ï¼ˆå¤šæ–‡æ¡£äº‹åŠ¡åœ¨4.0+æ”¯æŒï¼‰</li><li><strong>ç´¢å¼•æ”¯æŒ</strong>ï¼šæ‰€æœ‰å­—æ®µéƒ½å¯å»ºç«‹ç´¢å¼•ï¼ŒåŒ…æ‹¬åµŒå¥—å­—æ®µå’Œæ•°ç»„å…ƒç´ </li></ul><h3 id="1-3-å­˜å‚¨å¼•æ“ï¼šWiredTigeræ·±åº¦å‰–æ"><a href="#1-3-å­˜å‚¨å¼•æ“ï¼šWiredTigeræ·±åº¦å‰–æ" class="headerlink" title="1.3 å­˜å‚¨å¼•æ“ï¼šWiredTigeræ·±åº¦å‰–æ"></a>1.3 å­˜å‚¨å¼•æ“ï¼šWiredTigeræ·±åº¦å‰–æ</h3><p>è‡ªMongoDB 3.2èµ·ï¼ŒWiredTigeræˆä¸ºé»˜è®¤å­˜å‚¨å¼•æ“ï¼Œå…¶æ ¸å¿ƒç‰¹æ€§åŒ…æ‹¬ï¼š</p><pre class="mermaid">graph TD    A[WiredTigerå­˜å‚¨å¼•æ“] --> B[æ–‡æ¡£çº§å¹¶å‘æ§åˆ¶]    A --> C[å‹ç¼©å­˜å‚¨]    A --> D[æ£€æŸ¥ç‚¹æœºåˆ¶]    A --> E[å†…å­˜ç¼“å­˜]        B --> B1[ä¹è§‚é”]    B --> B2[æ— é”å¿«ç…§è¯»]        C --> C1[Snappyå‹ç¼©]    C --> C2[Zstandardå‹ç¼©]        D --> D1[æ¯60ç§’æ£€æŸ¥ç‚¹]    D --> D2[å´©æºƒæ¢å¤]        E --> E1[é»˜è®¤50%å¯ç”¨å†…å­˜]    E --> E2[LRUç¼“å­˜æ·˜æ±°]</pre><p><strong>å†…å­˜é…ç½®å…¬å¼</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WiredTigerç¼“å­˜å¤§å° = min( (ç³»ç»Ÿå†…å­˜ - 1GB) * 0.5, 10GB )</span><br></pre></td></tr></table></figure><p><strong>ç”Ÿäº§ç¯å¢ƒå»ºè®®</strong>ï¼š</p><ul><li>32GBå†…å­˜æœåŠ¡å™¨ï¼šé…ç½®15GBç¼“å­˜</li><li>64GBå†…å­˜æœåŠ¡å™¨ï¼šé…ç½®30GBç¼“å­˜</li><li>128GB+å†…å­˜æœåŠ¡å™¨ï¼šé…ç½®50-60GBç¼“å­˜</li></ul><h3 id="1-4-å¤åˆ¶é›†ï¼ˆReplica-Setï¼‰å·¥ä½œåŸç†"><a href="#1-4-å¤åˆ¶é›†ï¼ˆReplica-Setï¼‰å·¥ä½œåŸç†" class="headerlink" title="1.4 å¤åˆ¶é›†ï¼ˆReplica Setï¼‰å·¥ä½œåŸç†"></a>1.4 å¤åˆ¶é›†ï¼ˆReplica Setï¼‰å·¥ä½œåŸç†</h3><p>å¤åˆ¶é›†æ˜¯MongoDBå®ç°é«˜å¯ç”¨çš„æ ¸å¿ƒæœºåˆ¶ï¼Œé‡‡ç”¨<strong>Raftä¸€è‡´æ€§ç®—æ³•</strong>å˜ç§ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®ç»„ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-------------+     +-------------+     +-------------+</span><br><span class="line">|   Primary   |&lt;---&gt;|  Secondary  |&lt;---&gt;|  Secondary  |</span><br><span class="line">| (è¯»å†™èŠ‚ç‚¹)  |     |  (åªè¯»èŠ‚ç‚¹) |     |  (åªè¯»èŠ‚ç‚¹) |</span><br><span class="line">+-------------+     +-------------+     +-------------+</span><br><span class="line">       ^                   ^                   ^</span><br><span class="line">       |                   |                   |</span><br><span class="line">       v                   v                   v</span><br><span class="line">+-------------+     +-------------+     +-------------+</span><br><span class="line">|  Oplog      |     |  Oplog      |     |  Oplog      |</span><br><span class="line">| (æ“ä½œæ—¥å¿—)  |     | (æ“ä½œæ—¥å¿—)  |     | (æ“ä½œæ—¥å¿—)  |</span><br><span class="line">+-------------+     +-------------+     +-------------+</span><br></pre></td></tr></table></figure><p><strong>Oplogï¼ˆæ“ä½œæ—¥å¿—ï¼‰ç‰¹æ€§</strong>ï¼š</p><ul><li>å›ºå®šé›†åˆï¼ˆCapped Collectionï¼‰ï¼Œé»˜è®¤å ç”¨5%ç£ç›˜ç©ºé—´</li><li>è®°å½•æ‰€æœ‰æ•°æ®å˜æ›´æ“ä½œï¼ˆinsert&#x2F;update&#x2F;deleteï¼‰</li><li>é‡‡ç”¨å¹‚ç­‰æ“ä½œè®¾è®¡ï¼Œç¡®ä¿é‡æ”¾ä¸€è‡´æ€§</li><li>é»˜è®¤ä¿ç•™æ—¶é—´ï¼šå½“ç£ç›˜ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨è¦†ç›–æ—§è®°å½•</li></ul><p><strong>é€‰ä¸¾æœºåˆ¶</strong>ï¼š</p><ol><li>PrimaryèŠ‚ç‚¹å®•æœºæˆ–ç½‘ç»œåˆ†åŒº</li><li>å‰©ä½™èŠ‚ç‚¹å‘èµ·é€‰ä¸¾ï¼ˆéœ€è·å¾—å¤šæ•°ç¥¨ï¼‰</li><li>æ–°PrimaryèŠ‚ç‚¹æ¥ç®¡å†™å…¥æ“ä½œ</li><li>å®¢æˆ·ç«¯è‡ªåŠ¨é‡å®šå‘åˆ°æ–°Primary</li></ol><hr><h2 id="äºŒã€MongoDBç‰ˆæœ¬æ¼”è¿›ä¸ç‰¹æ€§å…¨æ™¯ï¼ˆ2020-2026ï¼‰"><a href="#äºŒã€MongoDBç‰ˆæœ¬æ¼”è¿›ä¸ç‰¹æ€§å…¨æ™¯ï¼ˆ2020-2026ï¼‰" class="headerlink" title="äºŒã€MongoDBç‰ˆæœ¬æ¼”è¿›ä¸ç‰¹æ€§å…¨æ™¯ï¼ˆ2020-2026ï¼‰"></a>äºŒã€MongoDBç‰ˆæœ¬æ¼”è¿›ä¸ç‰¹æ€§å…¨æ™¯ï¼ˆ2020-2026ï¼‰</h2><h3 id="2-1-ç‰ˆæœ¬è·¯çº¿å›¾ä¸å…³é”®ç‰¹æ€§"><a href="#2-1-ç‰ˆæœ¬è·¯çº¿å›¾ä¸å…³é”®ç‰¹æ€§" class="headerlink" title="2.1 ç‰ˆæœ¬è·¯çº¿å›¾ä¸å…³é”®ç‰¹æ€§"></a>2.1 ç‰ˆæœ¬è·¯çº¿å›¾ä¸å…³é”®ç‰¹æ€§</h3><table><thead><tr><th>ç‰ˆæœ¬</th><th>å‘å¸ƒæ—¶é—´</th><th>æ ¸å¿ƒç‰¹æ€§</th><th>é€‚ç”¨åœºæ™¯</th><th>å‡çº§æ³¨æ„äº‹é¡¹</th></tr></thead><tbody><tr><td><strong>4.4</strong></td><td>2020.07</td><td>- $unionWithèšåˆ<br>- æµå¼å¤åˆ¶<br>- å®¢æˆ·ç«¯å­—æ®µçº§åŠ å¯†(CSFLE)</td><td>ä¼ ç»Ÿä¼ä¸šåº”ç”¨</td><td>FLEéœ€è¦é¢å¤–å¯†é’¥ç®¡ç†æœåŠ¡</td></tr><tr><td><strong>5.0</strong></td><td>2021.07</td><td>- åŸç”Ÿæ—¶é—´åºåˆ—é›†åˆ<br>- åˆ†å¸ƒå¼äº‹åŠ¡å¢å¼º<br>- Live Resharding</td><td>IoTã€æ—¶åºæ•°æ®</td><td>æ—¶é—´åºåˆ—é›†åˆéœ€è¦5.0+é©±åŠ¨</td></tr><tr><td><strong>6.0</strong></td><td>2022.07</td><td>- Atlas Searché›†æˆ<br>- Queryable Encryption<br>- æ”¹è¿›çš„èšåˆæ€§èƒ½</td><td>æœç´¢å¯†é›†å‹åº”ç”¨</td><td>QEåŠŸèƒ½éœ€è¦Atlasæˆ–ä¼ä¸šç‰ˆ</td></tr><tr><td><strong>7.0</strong></td><td>2023.08</td><td>- å‘é‡æœç´¢($vectorSearch)<br>- è‡ªåŠ¨åˆ†ç‰‡å‡è¡¡ä¼˜åŒ–<br>- ä¸¥æ ¼çš„é»˜è®¤å®‰å…¨ç­–ç•¥</td><td>AI&#x2F;MLåº”ç”¨</td><td>å‘é‡ç´¢å¼•éœ€è¦é¢å¤–èµ„æº</td></tr><tr><td><strong>7.0 LTS</strong></td><td>2024.03</td><td>- é•¿æœŸæ”¯æŒ(3å¹´)<br>- ç¨³å®šAPI<br>- ä¼ä¸šçº§å®‰å…¨å¢å¼º</td><td>ç”Ÿäº§ç¯å¢ƒæ¨è</td><td>æœ€ä½³LTSç‰ˆæœ¬</td></tr></tbody></table><h3 id="2-2-é‡è¦æ¶æ„å˜æ›´ï¼ˆ5-0-ï¼‰"><a href="#2-2-é‡è¦æ¶æ„å˜æ›´ï¼ˆ5-0-ï¼‰" class="headerlink" title="2.2 é‡è¦æ¶æ„å˜æ›´ï¼ˆ5.0+ï¼‰"></a>2.2 é‡è¦æ¶æ„å˜æ›´ï¼ˆ5.0+ï¼‰</h3><p><strong>æ—¶é—´åºåˆ—é›†åˆä¼˜åŒ–</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºæ—¶é—´åºåˆ—é›†åˆ</span></span><br><span class="line">db.<span class="title function_">createCollection</span>(<span class="string">&quot;sensor_data&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">timeseries</span>: &#123;</span><br><span class="line">    <span class="attr">timeField</span>: <span class="string">&quot;timestamp&quot;</span>,</span><br><span class="line">    <span class="attr">metaField</span>: <span class="string">&quot;sensor_id&quot;</span>,</span><br><span class="line">    <span class="attr">granularity</span>: <span class="string">&quot;minutes&quot;</span> <span class="comment">// å¯é€‰: seconds/minutes/hours</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªåŠ¨ä¼˜åŒ–å­˜å‚¨ç»“æ„</span></span><br><span class="line"><span class="comment">// ä¼ ç»Ÿé›†åˆï¼šæ¯ä¸ªæ–‡æ¡£ç‹¬ç«‹å­˜å‚¨</span></span><br><span class="line"><span class="comment">// æ—¶é—´åºåˆ—ï¼šæŒ‰æ—¶é—´çª—å£èšåˆå­˜å‚¨ï¼ŒèŠ‚çœ50-90%ç©ºé—´</span></span><br></pre></td></tr></table></figure><p><strong>å‘é‡æœç´¢é›†æˆ</strong>ï¼ˆ7.0+ï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºå‘é‡ç´¢å¼•</span></span><br><span class="line">db.<span class="property">products</span>.<span class="title function_">createIndex</span>(&#123;</span><br><span class="line">  <span class="string">&quot;embedding&quot;</span>: <span class="string">&quot;vector&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dimensions&quot;</span>: <span class="number">1536</span>,</span><br><span class="line">  <span class="string">&quot;similarity&quot;</span>: <span class="string">&quot;cosine&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é‡ç›¸ä¼¼åº¦æœç´¢</span></span><br><span class="line">db.<span class="property">products</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">$vectorSearch</span>: &#123;</span><br><span class="line">      <span class="attr">index</span>: <span class="string">&quot;vector_index&quot;</span>,</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&quot;embedding&quot;</span>,</span><br><span class="line">      <span class="attr">queryVector</span>: [<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.3</span>, ...], <span class="comment">// 1536ç»´å‘é‡</span></span><br><span class="line">      <span class="attr">numCandidates</span>: <span class="number">100</span>,</span><br><span class="line">      <span class="attr">limit</span>: <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure><h3 id="2-3-ç‰ˆæœ¬é€‰æ‹©å»ºè®®"><a href="#2-3-ç‰ˆæœ¬é€‰æ‹©å»ºè®®" class="headerlink" title="2.3 ç‰ˆæœ¬é€‰æ‹©å»ºè®®"></a>2.3 ç‰ˆæœ¬é€‰æ‹©å»ºè®®</h3><table><thead><tr><th>åœºæ™¯</th><th>æ¨èç‰ˆæœ¬</th><th>ç†ç”±</th></tr></thead><tbody><tr><td>æ–°é¡¹ç›®å¯åŠ¨</td><td><strong>7.0 LTS</strong></td><td>é•¿æœŸæ”¯æŒã€æœ€æ–°ç‰¹æ€§ã€æœ€ä½³æ€§èƒ½</td></tr><tr><td>é—ç•™ç³»ç»Ÿå‡çº§</td><td><strong>6.0</strong></td><td>å¹³ç¨³è¿‡æ¸¡ã€å…¼å®¹æ€§å¥½</td></tr><tr><td>äº‘åŸç”Ÿéƒ¨ç½²</td><td><strong>Atlas (æœ€æ–°ç‰ˆ)</strong></td><td>å…è¿ç»´ã€è‡ªåŠ¨æ‰©å±•</td></tr><tr><td>èµ„æºå—é™ç¯å¢ƒ</td><td><strong>5.0</strong></td><td>å†…å­˜å ç”¨è¾ƒä½</td></tr><tr><td>åˆè§„æ€§è¦æ±‚é«˜</td><td><strong>7.0+ä¼ä¸šç‰ˆ</strong></td><td>å®Œæ•´å®¡è®¡ã€åŠ å¯†åŠŸèƒ½</td></tr></tbody></table><p><strong>å‡çº§è·¯å¾„</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4.4 â†’ 5.0 â†’ 6.0 â†’ 7.0 LTS</span><br></pre></td></tr></table></figure><p><strong>å…³é”®é™åˆ¶</strong>ï¼š</p><ul><li>ä¸èƒ½è·¨ä¸»è¦ç‰ˆæœ¬ç›´æ¥å‡çº§ï¼ˆå¦‚4.4â†’6.0ï¼‰</li><li>å‡çº§å‰å¿…é¡»è¿è¡Œå…¼å®¹æ€§æ£€æŸ¥ï¼š<code>db.adminCommand(&#123; checkMetadataConsistency: 1 &#125;)</code></li><li>åˆ†ç‰‡é›†ç¾¤å‡çº§éœ€è¦æŒ‰ç‰¹å®šé¡ºåºï¼šé…ç½®æœåŠ¡å™¨â†’åˆ†ç‰‡â†’mongos</li></ul><hr><h2 id="ä¸‰ã€Debian-12ç¯å¢ƒä¸‹çš„å®Œæ•´å®‰è£…ä¸æ·±åº¦é…ç½®"><a href="#ä¸‰ã€Debian-12ç¯å¢ƒä¸‹çš„å®Œæ•´å®‰è£…ä¸æ·±åº¦é…ç½®" class="headerlink" title="ä¸‰ã€Debian 12ç¯å¢ƒä¸‹çš„å®Œæ•´å®‰è£…ä¸æ·±åº¦é…ç½®"></a>ä¸‰ã€Debian 12ç¯å¢ƒä¸‹çš„å®Œæ•´å®‰è£…ä¸æ·±åº¦é…ç½®</h2><h3 id="3-1-ç³»ç»Ÿå‡†å¤‡ä¸ä¾èµ–å®‰è£…"><a href="#3-1-ç³»ç»Ÿå‡†å¤‡ä¸ä¾èµ–å®‰è£…" class="headerlink" title="3.1 ç³»ç»Ÿå‡†å¤‡ä¸ä¾èµ–å®‰è£…"></a>3.1 ç³»ç»Ÿå‡†å¤‡ä¸ä¾èµ–å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°ç³»ç»Ÿ</span></span><br><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…å¿…è¦ä¾èµ–</span></span><br><span class="line">sudo apt install -y curl wget gnupg2 apt-transport-https lsb-release ca-certificates</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ—¶åŒº</span></span><br><span class="line">sudo timedatectl set-timezone Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸“ç”¨ç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰</span></span><br><span class="line">sudo adduser --system --group --no-create-home mongodb</span><br><span class="line">sudo usermod -aG sudo mongodb</span><br></pre></td></tr></table></figure><h3 id="3-2-å®˜æ–¹APTä»“åº“é…ç½®ï¼ˆ7-0-LTSç‰ˆï¼‰"><a href="#3-2-å®˜æ–¹APTä»“åº“é…ç½®ï¼ˆ7-0-LTSç‰ˆï¼‰" class="headerlink" title="3.2 å®˜æ–¹APTä»“åº“é…ç½®ï¼ˆ7.0 LTSç‰ˆï¼‰"></a>3.2 å®˜æ–¹APTä»“åº“é…ç½®ï¼ˆ7.0 LTSç‰ˆï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥MongoDBå®˜æ–¹GPGå¯†é’¥</span></span><br><span class="line">curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºAPTæºåˆ—è¡¨æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg] https://repo.mongodb.org/apt/debian <span class="subst">$(lsb_release -cs)</span>/mongodb-org/7.0 main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/mongodb-org-7.0.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°åŒ…ç´¢å¼•</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯å¯ç”¨ç‰ˆæœ¬</span></span><br><span class="line">apt policy mongodb-org</span><br></pre></td></tr></table></figure><p><strong>Debian 12å…¼å®¹æ€§è¯´æ˜</strong>ï¼š</p><ul><li>MongoDBå®˜æ–¹ä¸ç›´æ¥æ”¯æŒDebian 12ï¼Œä½†ä½¿ç”¨Debian 11 (bullseye)ä»“åº“å®Œå…¨å…¼å®¹</li><li>å¦‚æœé‡åˆ°ä¾èµ–é—®é¢˜ï¼Œå¯æ‰‹åŠ¨ä¸‹è½½.debåŒ…å®‰è£…ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.mongodb.org/apt/debian/dists/bullseye/mongodb-org/7.0/main/binary-amd64/mongodb-org-server_7.0.11_amd64.deb</span><br><span class="line">sudo dpkg -i mongodb-org-server_7.0.11_amd64.deb</span><br><span class="line">sudo apt --fix-broken install -y</span><br></pre></td></tr></table></figure></li></ul><h3 id="3-3-æ·±åº¦é…ç½®è¯¦è§£ï¼ˆ-x2F-etc-x2F-mongod-confï¼‰"><a href="#3-3-æ·±åº¦é…ç½®è¯¦è§£ï¼ˆ-x2F-etc-x2F-mongod-confï¼‰" class="headerlink" title="3.3 æ·±åº¦é…ç½®è¯¦è§£ï¼ˆ&#x2F;etc&#x2F;mongod.confï¼‰"></a>3.3 æ·±åº¦é…ç½®è¯¦è§£ï¼ˆ&#x2F;etc&#x2F;mongod.confï¼‰</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç³»ç»Ÿæ—¥å¿—é…ç½®</span></span><br><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/var/log/mongodb/mongod.log</span></span><br><span class="line">  <span class="attr">logRotate:</span> <span class="string">reopen</span></span><br><span class="line">  <span class="attr">verbosity:</span> <span class="number">0</span>  <span class="comment"># 0-5ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®0-1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å­˜å‚¨å¼•æ“é…ç½®</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/var/lib/mongodb</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">commitIntervalMs:</span> <span class="number">100</span>  <span class="comment"># é»˜è®¤100msï¼Œå¯è°ƒè‡³30æå‡æ€§èƒ½</span></span><br><span class="line">  <span class="attr">engine:</span> <span class="string">wiredTiger</span></span><br><span class="line">  <span class="attr">wiredTiger:</span></span><br><span class="line">    <span class="attr">engineConfig:</span></span><br><span class="line">      <span class="attr">cacheSizeGB:</span> <span class="number">8</span>  <span class="comment"># æ ¹æ®å†…å­˜è°ƒæ•´ï¼Œå…¬å¼ï¼š(æ€»å†…å­˜-1GB)*0.5</span></span><br><span class="line">      <span class="attr">journalCompressor:</span> <span class="string">snappy</span></span><br><span class="line">      <span class="attr">directoryForIndexes:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">collectionConfig:</span></span><br><span class="line">      <span class="attr">blockCompressor:</span> <span class="string">zstd</span>  <span class="comment"># zstdå‹ç¼©ç‡æ›´é«˜ï¼ŒCPUæ¶ˆè€—ç•¥é«˜</span></span><br><span class="line">    <span class="attr">indexConfig:</span></span><br><span class="line">      <span class="attr">prefixCompression:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç½‘ç»œé…ç½®</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">,192.168.1.100</span>  <span class="comment"># ä»…ç»‘å®šå†…ç½‘IPï¼Œç¦æ­¢0.0.0.0</span></span><br><span class="line">  <span class="attr">maxIncomingConnections:</span> <span class="number">65536</span></span><br><span class="line">  <span class="attr">wireObjectCheck:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">ipv6:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰å…¨é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨ï¼‰</span></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">authorization:</span> <span class="string">enabled</span></span><br><span class="line">  <span class="comment"># keyFileç”¨äºå‰¯æœ¬é›†å†…éƒ¨è®¤è¯</span></span><br><span class="line">  <span class="attr">keyFile:</span> <span class="string">/etc/mongodb-keyfile</span></span><br><span class="line">  <span class="comment"># TLS/SSLé…ç½®</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">requireTLS</span></span><br><span class="line">    <span class="attr">certificateKeyFile:</span> <span class="string">/etc/ssl/mongodb.pem</span></span><br><span class="line">    <span class="attr">CAFile:</span> <span class="string">/etc/ssl/ca.pem</span></span><br><span class="line">    <span class="attr">allowConnectionsWithoutCertificates:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">allowInvalidCertificates:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">allowInvalidHostnames:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">disabledProtocols:</span> <span class="string">TLS1_0,TLS1_1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶é›†é…ç½®</span></span><br><span class="line"><span class="attr">replication:</span></span><br><span class="line">  <span class="attr">replSetName:</span> <span class="string">&quot;rs0&quot;</span></span><br><span class="line">  <span class="attr">enableMajorityReadConcern:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">oplogSizeMB:</span> <span class="number">10240</span>  <span class="comment"># 10GB oplogï¼Œæ ¹æ®å†™å…¥é‡è°ƒæ•´</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ç‰‡é…ç½®ï¼ˆåˆ†ç‰‡èŠ‚ç‚¹ä½¿ç”¨ï¼‰</span></span><br><span class="line"><span class="attr">sharding:</span></span><br><span class="line">  <span class="attr">clusterRole:</span> <span class="string">shardsvr</span></span><br><span class="line">  <span class="attr">archiveMovedChunks:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›ç¨‹ç®¡ç†</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/var/run/mongodb/mongod.pid</span></span><br><span class="line">  <span class="attr">timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br></pre></td></tr></table></figure><p><strong>å…³é”®é…ç½®é¡¹è¯¦è§£</strong>ï¼š</p><ol><li><p><strong>WiredTigerç¼“å­˜é…ç½®</strong>ï¼š</p><ul><li><code>cacheSizeGB</code>: å¿…é¡»æ ¹æ®ç‰©ç†å†…å­˜è°ƒæ•´</li><li>32GBå†…å­˜æœåŠ¡å™¨ï¼šå»ºè®®15GB</li><li>64GBå†…å­˜æœåŠ¡å™¨ï¼šå»ºè®®30GB</li><li>128GB+å†…å­˜æœåŠ¡å™¨ï¼šå»ºè®®50-60GB</li></ul></li><li><p><strong>å®‰å…¨åŠ å›ºé…ç½®</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”ŸæˆkeyFileï¼ˆ600æƒé™ï¼‰</span></span><br><span class="line">sudo openssl rand -<span class="built_in">base64</span> 756 &gt; /etc/mongodb-keyfile</span><br><span class="line">sudo <span class="built_in">chmod</span> 400 /etc/mongodb-keyfile</span><br><span class="line">sudo <span class="built_in">chown</span> mongodb:mongodb /etc/mongodb-keyfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”ŸæˆTLSè¯ä¹¦</span></span><br><span class="line">sudo openssl req -newkey rsa:2048 -new -x509 -days 365 -nodes \</span><br><span class="line">  -out /etc/ssl/mongodb.crt -keyout /etc/ssl/mongodb.key</span><br><span class="line">sudo <span class="built_in">cat</span> /etc/ssl/mongodb.crt /etc/ssl/mongodb.key &gt; /etc/ssl/mongodb.pem</span><br><span class="line">sudo <span class="built_in">chmod</span> 600 /etc/ssl/mongodb.pem</span><br><span class="line">sudo <span class="built_in">chown</span> mongodb:mongodb /etc/ssl/mongodb.pem</span><br></pre></td></tr></table></figure></li><li><p><strong>ç›®å½•æƒé™è®¾ç½®</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /var/lib/mongodb /var/log/mongodb /var/run/mongodb</span><br><span class="line">sudo <span class="built_in">chown</span> -R mongodb:mongodb /var/lib/mongodb /var/log/mongodb /var/run/mongodb</span><br><span class="line">sudo <span class="built_in">chmod</span> 755 /var/lib/mongodb /var/log/mongodb</span><br></pre></td></tr></table></figure></li></ol><h3 id="3-4-æœåŠ¡ç®¡ç†ä¸çŠ¶æ€ç›‘æ§"><a href="#3-4-æœåŠ¡ç®¡ç†ä¸çŠ¶æ€ç›‘æ§" class="headerlink" title="3.4 æœåŠ¡ç®¡ç†ä¸çŠ¶æ€ç›‘æ§"></a>3.4 æœåŠ¡ç®¡ç†ä¸çŠ¶æ€ç›‘æ§</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl start mongod</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> mongod</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span><br><span class="line">sudo systemctl status mongod</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ—¥å¿—ï¼ˆå®æ—¶ï¼‰</span></span><br><span class="line">sudo <span class="built_in">tail</span> -f /var/log/mongodb/mongod.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸºæœ¬è¿æ¥æµ‹è¯•</span></span><br><span class="line">mongosh --<span class="built_in">eval</span> <span class="string">&quot;db.version()&quot;</span></span><br></pre></td></tr></table></figure><p><strong>å¸¸è§å¯åŠ¨é—®é¢˜æ’æŸ¥</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ç«¯å£ç›‘å¬</span></span><br><span class="line">sudo netstat -tuln | grep 27017</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æ–‡ä»¶æƒé™</span></span><br><span class="line">sudo <span class="built_in">ls</span> -la /var/lib/mongodb</span><br><span class="line">sudo <span class="built_in">ls</span> -la /var/log/mongodb</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å†…å­˜é™åˆ¶</span></span><br><span class="line">sudo <span class="built_in">ulimit</span> -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒè¯•æ¨¡å¼å¯åŠ¨</span></span><br><span class="line">sudo -u mongodb /usr/bin/mongod --config /etc/mongod.conf --verbose</span><br></pre></td></tr></table></figure><hr><h2 id="å››ã€ä»å•ä½“åˆ°é«˜å¯ç”¨ï¼šå‰¯æœ¬é›†ä¸åˆ†ç‰‡é›†ç¾¤å®æˆ˜"><a href="#å››ã€ä»å•ä½“åˆ°é«˜å¯ç”¨ï¼šå‰¯æœ¬é›†ä¸åˆ†ç‰‡é›†ç¾¤å®æˆ˜" class="headerlink" title="å››ã€ä»å•ä½“åˆ°é«˜å¯ç”¨ï¼šå‰¯æœ¬é›†ä¸åˆ†ç‰‡é›†ç¾¤å®æˆ˜"></a>å››ã€ä»å•ä½“åˆ°é«˜å¯ç”¨ï¼šå‰¯æœ¬é›†ä¸åˆ†ç‰‡é›†ç¾¤å®æˆ˜</h2><h3 id="4-1-å•æœºéƒ¨ç½²æœ€ä½³å®è·µ"><a href="#4-1-å•æœºéƒ¨ç½²æœ€ä½³å®è·µ" class="headerlink" title="4.1 å•æœºéƒ¨ç½²æœ€ä½³å®è·µ"></a>4.1 å•æœºéƒ¨ç½²æœ€ä½³å®è·µ</h3><p><strong>æœ€å°åŒ–å®‰è£…ï¼ˆå¼€å‘ç¯å¢ƒï¼‰</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»…å¯ç”¨åŸºç¡€åŠŸèƒ½</span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/mongod.conf &gt; /dev/null &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">storage:</span><br><span class="line">  dbPath: /var/lib/mongodb</span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /var/log/mongodb/mongod.log</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 127.0.0.1</span><br><span class="line"></span><br><span class="line">security:</span><br><span class="line">  authorization: disabled  <span class="comment"># å¼€å‘ç¯å¢ƒå¯å…³é—­</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><strong>ç”Ÿäº§ç¯å¢ƒå•æœºåŠ å›º</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨è®¤è¯</span></span><br><span class="line">mongosh &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">use admin</span></span><br><span class="line"><span class="string">db.createUser(&#123;</span></span><br><span class="line"><span class="string">  user: &quot;admin&quot;,</span></span><br><span class="line"><span class="string">  pwd: &quot;StrongAdminPass123!&quot;,</span></span><br><span class="line"><span class="string">  roles: [&quot;root&quot;]</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡</span></span><br><span class="line">sudo systemctl restart mongod</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯è®¤è¯</span></span><br><span class="line">mongosh -u admin -p <span class="string">&quot;StrongAdminPass123!&quot;</span> --authenticationDatabase admin --<span class="built_in">eval</span> <span class="string">&quot;db.runCommand(&#123;connectionStatus:1&#125;)&quot;</span></span><br></pre></td></tr></table></figure><h3 id="4-2-ä¸‰èŠ‚ç‚¹å‰¯æœ¬é›†å®Œæ•´éƒ¨ç½²"><a href="#4-2-ä¸‰èŠ‚ç‚¹å‰¯æœ¬é›†å®Œæ•´éƒ¨ç½²" class="headerlink" title="4.2 ä¸‰èŠ‚ç‚¹å‰¯æœ¬é›†å®Œæ•´éƒ¨ç½²"></a>4.2 ä¸‰èŠ‚ç‚¹å‰¯æœ¬é›†å®Œæ•´éƒ¨ç½²</h3><p><strong>ç¯å¢ƒè§„åˆ’</strong>ï¼š</p><table><thead><tr><th>èŠ‚ç‚¹</th><th>IPåœ°å€</th><th>è§’è‰²</th><th>ç¡¬ä»¶é…ç½®</th></tr></thead><tbody><tr><td>node1</td><td>192.168.1.101</td><td>Primary&#x2F;Secondary</td><td>4C8G, 100GB SSD</td></tr><tr><td>node2</td><td>192.168.1.102</td><td>Secondary&#x2F;Arbiter</td><td>2C4G, 50GB SSD</td></tr><tr><td>node3</td><td>192.168.1.103</td><td>Secondary</td><td>4C8G, 100GB SSD</td></tr></tbody></table><p><strong>æ­¥éª¤1ï¼šæ‰€æœ‰èŠ‚ç‚¹é…ç½®</strong>ï¼ˆ&#x2F;etc&#x2F;mongod.confï¼‰ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">replication:</span></span><br><span class="line">  <span class="attr">replSetName:</span> <span class="string">&quot;prod-rs0&quot;</span></span><br><span class="line">  <span class="attr">enableMajorityReadConcern:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">oplogSizeMB:</span> <span class="number">20480</span>  <span class="comment"># 20GB oplog</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">keyFile:</span> <span class="string">/etc/mongodb-keyfile</span></span><br><span class="line">  <span class="attr">authorization:</span> <span class="string">enabled</span></span><br><span class="line"></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>  <span class="comment"># å…è®¸å†…ç½‘é€šä¿¡</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27017</span></span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤2ï¼šåˆ†å‘keyFileåˆ°æ‰€æœ‰èŠ‚ç‚¹</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨node1ç”ŸæˆkeyFile</span></span><br><span class="line">sudo openssl rand -<span class="built_in">base64</span> 756 &gt; /etc/mongodb-keyfile</span><br><span class="line">sudo <span class="built_in">chmod</span> 400 /etc/mongodb-keyfile</span><br><span class="line">sudo scp /etc/mongodb-keyfile node2:/etc/</span><br><span class="line">sudo scp /etc/mongodb-keyfile node3:/etc/</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤3ï¼šå¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart mongod</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤4ï¼šåˆå§‹åŒ–å‰¯æœ¬é›†</strong>ï¼ˆåœ¨node1æ‰§è¡Œï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿æ¥node1</span></span><br><span class="line">mongosh -u admin -p <span class="string">&quot;StrongAdminPass123!&quot;</span> --authenticationDatabase admin</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–å‰¯æœ¬é›†</span></span><br><span class="line">rs.<span class="title function_">initiate</span>(&#123;</span><br><span class="line">  <span class="attr">_id</span>: <span class="string">&quot;prod-rs0&quot;</span>,</span><br><span class="line">  <span class="attr">version</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">members</span>: [</span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">0</span>, <span class="attr">host</span>: <span class="string">&quot;192.168.1.101:27017&quot;</span>, <span class="attr">priority</span>: <span class="number">2</span>, <span class="attr">tags</span>: &#123; <span class="attr">dc</span>: <span class="string">&quot;beijing&quot;</span>, <span class="attr">rack</span>: <span class="string">&quot;a1&quot;</span> &#125; &#125;,</span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">host</span>: <span class="string">&quot;192.168.1.102:27017&quot;</span>, <span class="attr">priority</span>: <span class="number">1</span>, <span class="attr">tags</span>: &#123; <span class="attr">dc</span>: <span class="string">&quot;beijing&quot;</span>, <span class="attr">rack</span>: <span class="string">&quot;a2&quot;</span> &#125; &#125;,</span><br><span class="line">    &#123; <span class="attr">_id</span>: <span class="number">2</span>, <span class="attr">host</span>: <span class="string">&quot;192.168.1.103:27017&quot;</span>, <span class="attr">priority</span>: <span class="number">1</span>, <span class="attr">tags</span>: &#123; <span class="attr">dc</span>: <span class="string">&quot;shanghai&quot;</span>, <span class="attr">rack</span>: <span class="string">&quot;b1&quot;</span> &#125; &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºåº”ç”¨ç”¨æˆ·</span></span><br><span class="line">use myapp</span><br><span class="line">db.<span class="title function_">createUser</span>(&#123;</span><br><span class="line">  <span class="attr">user</span>: <span class="string">&quot;appuser&quot;</span>,</span><br><span class="line">  <span class="attr">pwd</span>: <span class="string">&quot;AppUserPass123!&quot;</span>,</span><br><span class="line">  <span class="attr">roles</span>: [</span><br><span class="line">    &#123; <span class="attr">role</span>: <span class="string">&quot;readWrite&quot;</span>, <span class="attr">db</span>: <span class="string">&quot;myapp&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">role</span>: <span class="string">&quot;read&quot;</span>, <span class="attr">db</span>: <span class="string">&quot;analytics&quot;</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯çŠ¶æ€</span></span><br><span class="line">rs.<span class="title function_">status</span>()</span><br></pre></td></tr></table></figure><p><strong>å‰¯æœ¬é›†çŠ¶æ€è§£è¯»</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">rs.<span class="title function_">status</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;set&quot;</span>: <span class="string">&quot;prod-rs0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;date&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2026-01-21T11:30:00Z&quot;</span>),</span><br><span class="line">  <span class="string">&quot;myState&quot;</span>: <span class="number">1</span>,  <span class="comment">// 1=PRIMARY, 2=SECONDARY</span></span><br><span class="line">  <span class="string">&quot;term&quot;</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="string">&quot;syncingTo&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;members&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;192.168.1.101:27017&quot;</span>,</span><br><span class="line">      <span class="string">&quot;health&quot;</span>: <span class="number">1</span>,  <span class="comment">// 1=healthy, 0=unhealthy</span></span><br><span class="line">      <span class="string">&quot;state&quot;</span>: <span class="number">1</span>,   <span class="comment">// 1=PRIMARY</span></span><br><span class="line">      <span class="string">&quot;stateStr&quot;</span>: <span class="string">&quot;PRIMARY&quot;</span>,</span><br><span class="line">      <span class="string">&quot;uptime&quot;</span>: <span class="number">300</span>,</span><br><span class="line">      <span class="string">&quot;optime&quot;</span>: &#123; <span class="string">&quot;ts&quot;</span>: <span class="title class_">Timestamp</span>(<span class="number">1705837800</span>, <span class="number">1</span>), <span class="string">&quot;t&quot;</span>: <span class="number">5</span> &#125;,</span><br><span class="line">      <span class="string">&quot;optimeDate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2026-01-21T11:30:00Z&quot;</span>),</span><br><span class="line">      <span class="string">&quot;syncingTo&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;syncSourceHost&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;syncSourceId&quot;</span>: -<span class="number">1</span>,</span><br><span class="line">      <span class="string">&quot;infoMessage&quot;</span>: <span class="string">&quot;could not find member to sync from&quot;</span>,</span><br><span class="line">      <span class="string">&quot;electionTime&quot;</span>: <span class="title class_">Timestamp</span>(<span class="number">1705837800</span>, <span class="number">1</span>),</span><br><span class="line">      <span class="string">&quot;electionDate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2026-01-21T11:30:00Z&quot;</span>),</span><br><span class="line">      <span class="string">&quot;configVersion&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="string">&quot;self&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;192.168.1.102:27017&quot;</span>,</span><br><span class="line">      <span class="string">&quot;health&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="string">&quot;state&quot;</span>: <span class="number">2</span>,  <span class="comment">// 2=SECONDARY</span></span><br><span class="line">      <span class="string">&quot;stateStr&quot;</span>: <span class="string">&quot;SECONDARY&quot;</span>,</span><br><span class="line">      <span class="string">&quot;uptime&quot;</span>: <span class="number">295</span>,</span><br><span class="line">      <span class="string">&quot;optime&quot;</span>: &#123; <span class="string">&quot;ts&quot;</span>: <span class="title class_">Timestamp</span>(<span class="number">1705837800</span>, <span class="number">1</span>), <span class="string">&quot;t&quot;</span>: <span class="number">5</span> &#125;,</span><br><span class="line">      <span class="string">&quot;optimeDurable&quot;</span>: &#123; <span class="string">&quot;ts&quot;</span>: <span class="title class_">Timestamp</span>(<span class="number">1705837800</span>, <span class="number">1</span>), <span class="string">&quot;t&quot;</span>: <span class="number">5</span> &#125;,</span><br><span class="line">      <span class="string">&quot;optimeDate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2026-01-21T11:30:00Z&quot;</span>),</span><br><span class="line">      <span class="string">&quot;optimeDurableDate&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2026-01-21T11:30:00Z&quot;</span>),</span><br><span class="line">      <span class="string">&quot;lastHeartbeat&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2026-01-21T11:30:05Z&quot;</span>),</span><br><span class="line">      <span class="string">&quot;lastHeartbeatRecv&quot;</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2026-01-21T11:30:04Z&quot;</span>),</span><br><span class="line">      <span class="string">&quot;pingMs&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="string">&quot;syncingTo&quot;</span>: <span class="string">&quot;192.168.1.101:27017&quot;</span>,</span><br><span class="line">      <span class="string">&quot;syncSourceHost&quot;</span>: <span class="string">&quot;192.168.1.101:27017&quot;</span>,</span><br><span class="line">      <span class="string">&quot;syncSourceId&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="string">&quot;infoMessage&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;configVersion&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;ok&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¯»å†™åˆ†ç¦»é…ç½®</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PHPåº”ç”¨è¿æ¥å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="attr">mongodb</span>:<span class="comment">//appuser:AppUserPass123!@192.168.1.101:27017,192.168.1.102:27017,192.168.1.103:27017/myapp?replicaSet=prod-rs0&amp;readPreference=secondaryPreferred</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Goé©±åŠ¨é…ç½®</span></span><br><span class="line">opts := options.<span class="title class_">Client</span>().<span class="title class_">ApplyURI</span>(<span class="string">&quot;mongodb://appuser:AppUserPass123!@192.168.1.101:27017,192.168.1.102:27017,192.168.1.103:27017&quot;</span>).</span><br><span class="line">  <span class="title class_">SetReplicaSet</span>(<span class="string">&quot;prod-rs0&quot;</span>).</span><br><span class="line">  <span class="title class_">SetReadPreference</span>(readpref.<span class="title class_">SecondaryPreferred</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pythoné…ç½®</span></span><br><span class="line">client = <span class="title class_">MongoClient</span>(</span><br><span class="line">    <span class="string">&#x27;mongodb://appuser:AppUserPass123!@192.168.1.101:27017,192.168.1.102:27017,192.168.1.103:27017&#x27;</span>,</span><br><span class="line">    replicaSet=<span class="string">&#x27;prod-rs0&#x27;</span>,</span><br><span class="line">    readPreference=<span class="string">&#x27;secondaryPreferred&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="4-3-åˆ†ç‰‡é›†ç¾¤æ¶æ„è®¾è®¡"><a href="#4-3-åˆ†ç‰‡é›†ç¾¤æ¶æ„è®¾è®¡" class="headerlink" title="4.3 åˆ†ç‰‡é›†ç¾¤æ¶æ„è®¾è®¡"></a>4.3 åˆ†ç‰‡é›†ç¾¤æ¶æ„è®¾è®¡</h3><p><strong>åˆ†ç‰‡é›†ç¾¤ç»„ä»¶</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+----------------+    +----------------+    +----------------+</span><br><span class="line">|   mongos       |    |   mongos       |    |   mongos       |</span><br><span class="line">| (æŸ¥è¯¢è·¯ç”±å™¨)   |    | (æŸ¥è¯¢è·¯ç”±å™¨)   |    | (æŸ¥è¯¢è·¯ç”±å™¨)   |</span><br><span class="line">+-------+--------+    +-------+--------+    +-------+--------+</span><br><span class="line">        |                     |                     |</span><br><span class="line">        |                     |                     |</span><br><span class="line">+-------v--------+    +-------v--------+    +-------v--------+</span><br><span class="line">| Config Servers |    |  Shard 1      |    |  Shard 2      |</span><br><span class="line">| (é…ç½®æœåŠ¡å™¨)   |    | (åˆ†ç‰‡èŠ‚ç‚¹)    |    | (åˆ†ç‰‡èŠ‚ç‚¹)    |</span><br><span class="line">| 3èŠ‚ç‚¹å‰¯æœ¬é›†    |    | 3èŠ‚ç‚¹å‰¯æœ¬é›†   |    | 3èŠ‚ç‚¹å‰¯æœ¬é›†   |</span><br><span class="line">+----------------+    +----------------+    +----------------+</span><br></pre></td></tr></table></figure><p><strong>éƒ¨ç½²æ­¥éª¤æ¦‚è§ˆ</strong>ï¼š</p><ol><li>éƒ¨ç½²3èŠ‚ç‚¹Config Serverå‰¯æœ¬é›†</li><li>éƒ¨ç½²å¤šä¸ªShardå‰¯æœ¬é›†ï¼ˆæ¯ä¸ªShard 3èŠ‚ç‚¹ï¼‰</li><li>éƒ¨ç½²å¤šä¸ªmongosè·¯ç”±è¿›ç¨‹</li><li>åˆå§‹åŒ–åˆ†ç‰‡é›†ç¾¤</li><li>å¯ç”¨æ•°æ®åº“åˆ†ç‰‡</li><li>é…ç½®é›†åˆåˆ†ç‰‡é”®</li></ol><p><strong>å®Œæ•´éƒ¨ç½²è„šæœ¬</strong>ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. é…ç½®Config Server</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/mongod-config.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">sharding:</span></span><br><span class="line"><span class="string">  clusterRole: configsvr</span></span><br><span class="line"><span class="string">replication:</span></span><br><span class="line"><span class="string">  replSetName: &quot;configReplSet&quot;</span></span><br><span class="line"><span class="string">net:</span></span><br><span class="line"><span class="string">  bindIp: 0.0.0.0</span></span><br><span class="line"><span class="string">  port: 27019</span></span><br><span class="line"><span class="string">storage:</span></span><br><span class="line"><span class="string">  dbPath: /var/lib/mongodb-config</span></span><br><span class="line"><span class="string">systemLog:</span></span><br><span class="line"><span class="string">  destination: file</span></span><br><span class="line"><span class="string">  path: /var/log/mongodb/config.log</span></span><br><span class="line"><span class="string">  logAppend: true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é…ç½®ShardèŠ‚ç‚¹</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/mongod-shard1.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">sharding:</span></span><br><span class="line"><span class="string">  clusterRole: shardsvr</span></span><br><span class="line"><span class="string">replication:</span></span><br><span class="line"><span class="string">  replSetName: &quot;shard1ReplSet&quot;</span></span><br><span class="line"><span class="string">net:</span></span><br><span class="line"><span class="string">  bindIp: 0.0.0.0</span></span><br><span class="line"><span class="string">  port: 27018</span></span><br><span class="line"><span class="string">storage:</span></span><br><span class="line"><span class="string">  dbPath: /var/lib/mongodb-shard1</span></span><br><span class="line"><span class="string">systemLog:</span></span><br><span class="line"><span class="string">  destination: file</span></span><br><span class="line"><span class="string">  path: /var/log/mongodb/shard1.log</span></span><br><span class="line"><span class="string">  logAppend: true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. é…ç½®mongos</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/mongos.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">sharding:</span></span><br><span class="line"><span class="string">  configDB: configReplSet/192.168.1.101:27019,192.168.1.102:27019,192.168.1.103:27019</span></span><br><span class="line"><span class="string">net:</span></span><br><span class="line"><span class="string">  bindIp: 0.0.0.0</span></span><br><span class="line"><span class="string">  port: 27017</span></span><br><span class="line"><span class="string">systemLog:</span></span><br><span class="line"><span class="string">  destination: file</span></span><br><span class="line"><span class="string">  path: /var/log/mongodb/mongos.log</span></span><br><span class="line"><span class="string">  logAppend: true</span></span><br><span class="line"><span class="string">processManagement:</span></span><br><span class="line"><span class="string">  fork: true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><hr><h2 id="äº”ã€Dockerå®¹å™¨åŒ–éƒ¨ç½²å…¨æ”»ç•¥"><a href="#äº”ã€Dockerå®¹å™¨åŒ–éƒ¨ç½²å…¨æ”»ç•¥" class="headerlink" title="äº”ã€Dockerå®¹å™¨åŒ–éƒ¨ç½²å…¨æ”»ç•¥"></a>äº”ã€Dockerå®¹å™¨åŒ–éƒ¨ç½²å…¨æ”»ç•¥</h2><h3 id="5-1-å•æœºDockeréƒ¨ç½²"><a href="#5-1-å•æœºDockeréƒ¨ç½²" class="headerlink" title="5.1 å•æœºDockeréƒ¨ç½²"></a>5.1 å•æœºDockeréƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–å®˜æ–¹é•œåƒ</span></span><br><span class="line">docker pull mongo:7.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œå®¹å™¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰</span></span><br><span class="line">docker run -d \</span><br><span class="line">  --name mongodb-dev \</span><br><span class="line">  -p 27017:27017 \</span><br><span class="line">  -v mongodb-data:/data/db \</span><br><span class="line">  -e MONGO_INITDB_ROOT_USERNAME=admin \</span><br><span class="line">  -e MONGO_INITDB_ROOT_PASSWORD=DevPass123! \</span><br><span class="line">  --restart unless-stopped \</span><br><span class="line">  mongo:7.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®</span></span><br><span class="line">docker run -d \</span><br><span class="line">  --name mongodb-prod \</span><br><span class="line">  -p 27017:27017 \</span><br><span class="line">  -v /mnt/data/mongodb:/data/db \</span><br><span class="line">  -v /etc/mongodb-keyfile:/etc/mongodb-keyfile:ro \</span><br><span class="line">  -v /etc/ssl/mongodb.pem:/etc/ssl/mongodb.pem:ro \</span><br><span class="line">  -e MONGO_INITDB_ROOT_USERNAME=admin \</span><br><span class="line">  -e MONGO_INITDB_ROOT_PASSWORD=StrongProdPass123! \</span><br><span class="line">  -e MONGO_INITDB_DATABASE=myapp \</span><br><span class="line">  --<span class="built_in">ulimit</span> nofile=64000:64000 \</span><br><span class="line">  --memory=8g \</span><br><span class="line">  --cpus=4 \</span><br><span class="line">  --restart unless-stopped \</span><br><span class="line">  mongo:7.0 \</span><br><span class="line">  --auth \</span><br><span class="line">  --keyFile /etc/mongodb-keyfile \</span><br><span class="line">  --tlsMode requireTLS \</span><br><span class="line">  --tlsCertificateKeyFile /etc/ssl/mongodb.pem \</span><br><span class="line">  --bind_ip 0.0.0.0 \</span><br><span class="line">  --replSet rs0</span><br></pre></td></tr></table></figure><h3 id="5-2-Docker-Composeå‰¯æœ¬é›†éƒ¨ç½²"><a href="#5-2-Docker-Composeå‰¯æœ¬é›†éƒ¨ç½²" class="headerlink" title="5.2 Docker Composeå‰¯æœ¬é›†éƒ¨ç½²"></a>5.2 Docker Composeå‰¯æœ¬é›†éƒ¨ç½²</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mongo-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mongo1_data:</span></span><br><span class="line">  <span class="attr">mongo2_data:</span></span><br><span class="line">  <span class="attr">mongo3_data:</span></span><br><span class="line">  <span class="attr">mongo-keyfile:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mongo1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:7.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongo1</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017:27017&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo1_data:/data/db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mongo-keyfile:/etc/mongodb-keyfile:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./tls:/etc/ssl:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="string">ClusterPass123!</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">      --replSet rs0</span></span><br><span class="line"><span class="string">      --auth</span></span><br><span class="line"><span class="string">      --keyFile /etc/mongodb-keyfile</span></span><br><span class="line"><span class="string">      --tlsMode requireTLS</span></span><br><span class="line"><span class="string">      --tlsCertificateKeyFile /etc/ssl/mongodb.pem</span></span><br><span class="line"><span class="string">      --bind_ip_all</span></span><br><span class="line"><span class="string">      --oplogSize 1024</span></span><br><span class="line"><span class="string"></span>    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo-net</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">echo</span> <span class="string">&#x27;db.runCommand(&#123;ping:1&#125;)&#x27;</span> <span class="string">|</span> <span class="string">mongosh</span> <span class="string">localhost:27017/test</span> <span class="string">--quiet</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mongo2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:7.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongo2</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27018:27017&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo2_data:/data/db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mongo-keyfile:/etc/mongodb-keyfile:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./tls:/etc/ssl:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="string">ClusterPass123!</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">      --replSet rs0</span></span><br><span class="line"><span class="string">      --auth</span></span><br><span class="line"><span class="string">      --keyFile /etc/mongodb-keyfile</span></span><br><span class="line"><span class="string">      --tlsMode requireTLS</span></span><br><span class="line"><span class="string">      --tlsCertificateKeyFile /etc/ssl/mongodb.pem</span></span><br><span class="line"><span class="string">      --bind_ip_all</span></span><br><span class="line"><span class="string">      --oplogSize 1024</span></span><br><span class="line"><span class="string"></span>    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo-net</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">echo</span> <span class="string">&#x27;db.runCommand(&#123;ping:1&#125;)&#x27;</span> <span class="string">|</span> <span class="string">mongosh</span> <span class="string">localhost:27017/test</span> <span class="string">--quiet</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mongo3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:7.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongo3</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27019:27017&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo3_data:/data/db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mongo-keyfile:/etc/mongodb-keyfile:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./tls:/etc/ssl:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="string">ClusterPass123!</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">      --replSet rs0</span></span><br><span class="line"><span class="string">      --auth</span></span><br><span class="line"><span class="string">      --keyFile /etc/mongodb-keyfile</span></span><br><span class="line"><span class="string">      --tlsMode requireTLS</span></span><br><span class="line"><span class="string">      --tlsCertificateKeyFile /etc/ssl/mongodb.pem</span></span><br><span class="line"><span class="string">      --bind_ip_all</span></span><br><span class="line"><span class="string">      --oplogSize 1024</span></span><br><span class="line"><span class="string"></span>    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo-net</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> <span class="string">echo</span> <span class="string">&#x27;db.runCommand(&#123;ping:1&#125;)&#x27;</span> <span class="string">|</span> <span class="string">mongosh</span> <span class="string">localhost:27017/test</span> <span class="string">--quiet</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mongo-init:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:7.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongo-init</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">mongo1:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">      <span class="attr">mongo2:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">      <span class="attr">mongo3:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">      mongosh --host mongo1:27017</span></span><br><span class="line"><span class="string">      -u admin</span></span><br><span class="line"><span class="string">      -p ClusterPass123!</span></span><br><span class="line"><span class="string">      --eval &quot;</span></span><br><span class="line"><span class="string">      rs.initiate(&#123;</span></span><br><span class="line"><span class="string">        _id: &#x27;rs0&#x27;,</span></span><br><span class="line"><span class="string">        members: [</span></span><br><span class="line"><span class="string">          &#123; _id: 0, host: &#x27;mongo1:27017&#x27;, priority: 2 &#125;,</span></span><br><span class="line"><span class="string">          &#123; _id: 1, host: &#x27;mongo2:27017&#x27;, priority: 1 &#125;,</span></span><br><span class="line"><span class="string">          &#123; _id: 2, host: &#x27;mongo3:27017&#x27;, priority: 1 &#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">      &#125;);</span></span><br><span class="line"><span class="string">      setTimeout(function() &#123;</span></span><br><span class="line"><span class="string">        db.createUser(&#123;</span></span><br><span class="line"><span class="string">          user: &#x27;appuser&#x27;,</span></span><br><span class="line"><span class="string">          pwd: &#x27;AppUserPass123!&#x27;,</span></span><br><span class="line"><span class="string">          roles: [&#123; role: &#x27;readWrite&#x27;, db: &#x27;myapp&#x27; &#125;]</span></span><br><span class="line"><span class="string">        &#125;);</span></span><br><span class="line"><span class="string">      &#125;, 5000);</span></span><br><span class="line"><span class="string">      &quot;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mongo-net</span></span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨æµç¨‹</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. ç”ŸæˆkeyFile</span></span><br><span class="line">openssl rand -<span class="built_in">base64</span> 756 &gt; mongo-keyfile</span><br><span class="line"><span class="built_in">chmod</span> 400 mongo-keyfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ç”ŸæˆTLSè¯ä¹¦ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="built_in">mkdir</span> tls</span><br><span class="line">openssl req -x509 -newkey rsa:4096 -days 365 -nodes \</span><br><span class="line">  -keyout tls/mongodb.key -out tls/mongodb.crt \</span><br><span class="line">  -subj <span class="string">&quot;/C=CN/ST=Beijing/L=Beijing/O=MyOrg/OU=IT/CN=localhost&quot;</span></span><br><span class="line"><span class="built_in">cat</span> tls/mongodb.crt tls/mongodb.key &gt; tls/mongodb.pem</span><br><span class="line"><span class="built_in">chmod</span> 600 tls/mongodb.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å¯åŠ¨é›†ç¾¤</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. éªŒè¯çŠ¶æ€</span></span><br><span class="line">docker-compose logs -f mongo-init</span><br><span class="line">docker <span class="built_in">exec</span> mongo1 mongosh -u admin -p ClusterPass123! --<span class="built_in">eval</span> <span class="string">&quot;rs.status()&quot;</span></span><br></pre></td></tr></table></figure><h3 id="5-3-Kuberneteséƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰"><a href="#5-3-Kuberneteséƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰" class="headerlink" title="5.3 Kuberneteséƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰"></a>5.3 Kuberneteséƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mongodb-statefulset.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mongo:7.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">27017</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongodb-data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/data/db</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/mongod.conf</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">mongod.conf</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secrets</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/secrets</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGODB_REPLICA_SET_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;rs0&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGODB_INITIAL_PRIMARY_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;mongodb-0.mongodb&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGODB_INITIAL_PRIMARY_PORT_NUMBER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;27017&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGODB_ROOT_USERNAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mongodb-secrets</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">root-username</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGODB_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mongodb-secrets</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">root-password</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;4Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;8Gi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">mongosh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--eval</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;db.adminCommand(&#x27;ping&#x27;)&quot;</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">mongosh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--eval</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;db.adminCommand(&#x27;ping&#x27;)&quot;</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mongodb-data</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;ssd&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">100Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Serviceé…ç½®</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">27017</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongodb</span></span><br></pre></td></tr></table></figure><hr><h2 id="å…­ã€å¤šè¯­è¨€æ“ä½œå®æˆ˜ï¼šå®Œæ•´ä»£ç ç¤ºä¾‹"><a href="#å…­ã€å¤šè¯­è¨€æ“ä½œå®æˆ˜ï¼šå®Œæ•´ä»£ç ç¤ºä¾‹" class="headerlink" title="å…­ã€å¤šè¯­è¨€æ“ä½œå®æˆ˜ï¼šå®Œæ•´ä»£ç ç¤ºä¾‹"></a>å…­ã€å¤šè¯­è¨€æ“ä½œå®æˆ˜ï¼šå®Œæ•´ä»£ç ç¤ºä¾‹</h2><h3 id="6-1-PHP-8-2-MongoDB-Driver-å®Œæ•´ç¤ºä¾‹"><a href="#6-1-PHP-8-2-MongoDB-Driver-å®Œæ•´ç¤ºä¾‹" class="headerlink" title="6.1 PHP 8.2 + MongoDB Driver å®Œæ•´ç¤ºä¾‹"></a>6.1 PHP 8.2 + MongoDB Driver å®Œæ•´ç¤ºä¾‹</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MongoDB PHP 8.2 å®Œæ•´æ“ä½œç¤ºä¾‹</span></span><br><span class="line"><span class="comment"> * éœ€è¦å®‰è£…: pecl install mongodb</span></span><br><span class="line"><span class="comment"> * composer require mongodb/mongodb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">MongoDB</span>\<span class="title">Client</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MongoDB</span>\<span class="title">Driver</span>\<span class="title">Manager</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MongoDB</span>\<span class="title">Driver</span>\<span class="title">BulkWrite</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MongoDB</span>\<span class="title">Driver</span>\<span class="title">WriteConcern</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MongoDB</span>\<span class="title">Driver</span>\<span class="title">ReadPreference</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MongoDB</span>\<span class="title">Driver</span>\<span class="title">Exception</span>\<span class="title">ConnectionException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MongoDB</span>\<span class="title">Driver</span>\<span class="title">Exception</span>\<span class="title">AuthenticationException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">MongoDB</span>\<span class="title">Operation</span>\<span class="title">FindOneAndUpdate</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoDBExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Manager <span class="variable">$manager</span>;</span><br><span class="line">    <span class="keyword">private</span> Client <span class="variable">$client</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> <span class="variable">$uri</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> <span class="variable">$databaseName</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> <span class="variable">$collectionName</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;uri = <span class="string">&#x27;mongodb://appuser:AppUserPass123!@192.168.1.101:27017,192.168.1.102:27017,192.168.1.103:27017/?replicaSet=prod-rs0&amp;readPreference=secondaryPreferred&amp;retryWrites=true&amp;w=majority&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;databaseName = <span class="string">&#x27;myapp&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;collectionName = <span class="string">&#x27;users&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">connect</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$options</span> = [</span><br><span class="line">                <span class="string">&#x27;connectTimeoutMS&#x27;</span> =&gt; <span class="number">5000</span>,</span><br><span class="line">                <span class="string">&#x27;socketTimeoutMS&#x27;</span> =&gt; <span class="number">10000</span>,</span><br><span class="line">                <span class="string">&#x27;serverSelectionTimeoutMS&#x27;</span> =&gt; <span class="number">5000</span>,</span><br><span class="line">                <span class="string">&#x27;heartbeatFrequencyMS&#x27;</span> =&gt; <span class="number">10000</span>,</span><br><span class="line">                <span class="string">&#x27;retryWrites&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&#x27;w&#x27;</span> =&gt; <span class="string">&#x27;majority&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;journal&#x27;</span> =&gt; <span class="literal">true</span></span><br><span class="line">            ];</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;manager = <span class="keyword">new</span> <span class="title class_">Manager</span>(<span class="variable language_">$this</span>-&gt;uri, <span class="variable">$options</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;client = <span class="keyword">new</span> <span class="title class_">Client</span>(<span class="variable language_">$this</span>-&gt;uri, <span class="variable">$options</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;âœ… è¿æ¥æˆåŠŸ\n&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ConnectionException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;âŒ è¿æ¥å¤±è´¥: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;âŒ è®¤è¯å¤±è´¥: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºç”¨æˆ·é›†åˆï¼ˆå¸¦ç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createCollection</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">        <span class="variable">$database</span> = <span class="variable language_">$this</span>-&gt;client-&gt;<span class="title function_ invoke__">selectDatabase</span>(<span class="variable">$this</span>-&gt;databaseName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ é™¤å·²å­˜åœ¨çš„é›†åˆï¼ˆé‡æ–°åˆ›å»ºï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;collectionName, <span class="variable">$database</span>-&gt;<span class="title function_ invoke__">listCollections</span>()-&gt;<span class="title function_ invoke__">toArray</span>())) &#123;</span><br><span class="line">            <span class="variable">$database</span>-&gt;<span class="title function_ invoke__">dropCollection</span>(<span class="variable">$this</span>-&gt;collectionName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºé›†åˆ</span></span><br><span class="line">        <span class="variable">$collection</span> = <span class="variable">$database</span>-&gt;<span class="title function_ invoke__">createCollection</span>(<span class="variable">$this</span>-&gt;collectionName, [</span><br><span class="line">            <span class="string">&#x27;validator&#x27;</span> =&gt; [</span><br><span class="line">                <span class="string">&#x27;$jsonSchema&#x27;</span> =&gt; [</span><br><span class="line">                    <span class="string">&#x27;bsonType&#x27;</span> =&gt; <span class="string">&#x27;object&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;required&#x27;</span> =&gt; [<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;created_at&#x27;</span>],</span><br><span class="line">                    <span class="string">&#x27;properties&#x27;</span> =&gt; [</span><br><span class="line">                        <span class="string">&#x27;username&#x27;</span> =&gt; [</span><br><span class="line">                            <span class="string">&#x27;bsonType&#x27;</span> =&gt; <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;description&#x27;</span> =&gt; <span class="string">&#x27;ç”¨æˆ·åå¿…é¡»ä¸ºå­—ç¬¦ä¸²&#x27;</span></span><br><span class="line">                        ],</span><br><span class="line">                        <span class="string">&#x27;email&#x27;</span> =&gt; [</span><br><span class="line">                            <span class="string">&#x27;bsonType&#x27;</span> =&gt; <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;pattern&#x27;</span> =&gt; <span class="string">&#x27;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]&#123;2,&#125;$&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;description&#x27;</span> =&gt; <span class="string">&#x27;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&#x27;</span></span><br><span class="line">                        ],</span><br><span class="line">                        <span class="string">&#x27;age&#x27;</span> =&gt; [</span><br><span class="line">                            <span class="string">&#x27;bsonType&#x27;</span> =&gt; <span class="string">&#x27;int&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;minimum&#x27;</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                            <span class="string">&#x27;maximum&#x27;</span> =&gt; <span class="number">120</span>,</span><br><span class="line">                            <span class="string">&#x27;description&#x27;</span> =&gt; <span class="string">&#x27;å¹´é¾„å¿…é¡»åœ¨0-120ä¹‹é—´&#x27;</span></span><br><span class="line">                        ],</span><br><span class="line">                        <span class="string">&#x27;skills&#x27;</span> =&gt; [</span><br><span class="line">                            <span class="string">&#x27;bsonType&#x27;</span> =&gt; <span class="string">&#x27;array&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;items&#x27;</span> =&gt; [</span><br><span class="line">                                <span class="string">&#x27;bsonType&#x27;</span> =&gt; <span class="string">&#x27;string&#x27;</span></span><br><span class="line">                            ]</span><br><span class="line">                        ]</span><br><span class="line">                    ]</span><br><span class="line">                ]</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&#x27;validationLevel&#x27;</span> =&gt; <span class="string">&#x27;moderate&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;validationAction&#x27;</span> =&gt; <span class="string">&#x27;error&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºç´¢å¼•</span></span><br><span class="line">        <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">createIndex</span>([<span class="string">&#x27;username&#x27;</span> =&gt; <span class="number">1</span>], [<span class="string">&#x27;unique&#x27;</span> =&gt; <span class="literal">true</span>]);</span><br><span class="line">        <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">createIndex</span>([<span class="string">&#x27;email&#x27;</span> =&gt; <span class="number">1</span>], [<span class="string">&#x27;unique&#x27;</span> =&gt; <span class="literal">true</span>]);</span><br><span class="line">        <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">createIndex</span>([<span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">createIndex</span>([<span class="string">&#x27;skills&#x27;</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">createIndex</span>([<span class="string">&#x27;created_at&#x27;</span> =&gt; -<span class="number">1</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;âœ… é›†åˆ <span class="subst">&#123;$this-&gt;collectionName&#125;</span> åˆ›å»ºæˆåŠŸï¼Œç´¢å¼•å·²å»ºç«‹\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡æ’å…¥ç”¨æˆ·æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bulkInsertUsers</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">        <span class="variable">$collection</span> = <span class="variable language_">$this</span>-&gt;client-&gt;<span class="title function_ invoke__">selectCollection</span>(<span class="variable">$this</span>-&gt;databaseName, <span class="variable">$this</span>-&gt;collectionName);</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$users</span> = [</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;zhangsan&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;zhangsan@example.com&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">28</span>,</span><br><span class="line">                <span class="string">&#x27;skills&#x27;</span> =&gt; [<span class="string">&#x27;PHP&#x27;</span>, <span class="string">&#x27;MySQL&#x27;</span>, <span class="string">&#x27;Redis&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;created_at&#x27;</span> =&gt; <span class="keyword">new</span> MongoDB\BSON\<span class="title function_ invoke__">UTCDateTime</span>()</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;lisi&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;lisi@example.com&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">32</span>,</span><br><span class="line">                <span class="string">&#x27;skills&#x27;</span> =&gt; [<span class="string">&#x27;Go&#x27;</span>, <span class="string">&#x27;MongoDB&#x27;</span>, <span class="string">&#x27;Docker&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;created_at&#x27;</span> =&gt; <span class="keyword">new</span> MongoDB\BSON\<span class="title function_ invoke__">UTCDateTime</span>()</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;wangwu&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;wangwu@example.com&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">25</span>,</span><br><span class="line">                <span class="string">&#x27;skills&#x27;</span> =&gt; [<span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;TensorFlow&#x27;</span>, <span class="string">&#x27;MongoDB&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;created_at&#x27;</span> =&gt; <span class="keyword">new</span> MongoDB\BSON\<span class="title function_ invoke__">UTCDateTime</span>()</span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;zhaoliu&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;zhaoliu@example.com&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">35</span>,</span><br><span class="line">                <span class="string">&#x27;skills&#x27;</span> =&gt; [<span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;Spring&#x27;</span>, <span class="string">&#x27;MongoDB&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;created_at&#x27;</span> =&gt; <span class="keyword">new</span> MongoDB\BSON\<span class="title function_ invoke__">UTCDateTime</span>()</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$result</span> = <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">insertMany</span>(<span class="variable">$users</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;âœ… æ‰¹é‡æ’å…¥æˆåŠŸï¼Œæ’å…¥ <span class="subst">&#123;$result-&gt;getInsertedCount()&#125;</span> æ¡è®°å½•\n&quot;</span>;</span><br><span class="line">            <span class="title function_ invoke__">print_r</span>(<span class="variable">$result</span>-&gt;<span class="title function_ invoke__">getInsertedIds</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\MongoDB\<span class="built_in">Exception</span>\BulkWriteException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;âŒ æ‰¹é‡æ’å…¥å¤±è´¥: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é«˜çº§æŸ¥è¯¢ç¤ºä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">advancedQueries</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">        <span class="variable">$collection</span> = <span class="variable language_">$this</span>-&gt;client-&gt;<span class="title function_ invoke__">selectCollection</span>(<span class="variable">$this</span>-&gt;databaseName, <span class="variable">$this</span>-&gt;collectionName);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\nğŸ” é«˜çº§æŸ¥è¯¢ç¤ºä¾‹:\n&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. æŸ¥æ‰¾å¹´é¾„å¤§äº30çš„ç”¨æˆ·</span></span><br><span class="line">        <span class="variable">$cursor</span> = <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">find</span>(</span><br><span class="line">            [<span class="string">&#x27;age&#x27;</span> =&gt; [<span class="string">&#x27;$gt&#x27;</span> =&gt; <span class="number">30</span>]],</span><br><span class="line">            [<span class="string">&#x27;projection&#x27;</span> =&gt; [<span class="string">&#x27;username&#x27;</span> =&gt; <span class="number">1</span>, <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">1</span>, <span class="string">&#x27;skills&#x27;</span> =&gt; <span class="number">1</span>, <span class="string">&#x27;_id&#x27;</span> =&gt; <span class="number">0</span>]]</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;1. å¹´é¾„ &gt; 30 çš„ç”¨æˆ·:\n&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$cursor</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;   - <span class="subst">&#123;$user[&#x27;username&#x27;]&#125;</span> (<span class="subst">&#123;$user[&#x27;age&#x27;]&#125;</span>å²): &quot;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$user</span>[<span class="string">&#x27;skills&#x27;</span>]) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æŸ¥æ‰¾åŒ…å«MongoDBæŠ€èƒ½çš„ç”¨æˆ·</span></span><br><span class="line">        <span class="variable">$cursor</span> = <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">find</span>(</span><br><span class="line">            [<span class="string">&#x27;skills&#x27;</span> =&gt; <span class="string">&#x27;MongoDB&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;sort&#x27;</span> =&gt; [<span class="string">&#x27;created_at&#x27;</span> =&gt; -<span class="number">1</span>]]</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\n2. æŒæ¡ MongoDB æŠ€èƒ½çš„ç”¨æˆ·:\n&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$cursor</span> <span class="keyword">as</span> <span class="variable">$user</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;   - <span class="subst">&#123;$user[&#x27;username&#x27;]&#125;</span>, æŠ€èƒ½: &quot;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$user</span>[<span class="string">&#x27;skills&#x27;</span>]) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. èšåˆæŸ¥è¯¢ï¼šæŒ‰æŠ€èƒ½åˆ†ç»„ç»Ÿè®¡</span></span><br><span class="line">        <span class="variable">$pipeline</span> = [</span><br><span class="line">            [<span class="string">&#x27;$unwind&#x27;</span> =&gt; <span class="string">&#x27;$skills&#x27;</span>],</span><br><span class="line">            [<span class="string">&#x27;$group&#x27;</span> =&gt; [</span><br><span class="line">                <span class="string">&#x27;_id&#x27;</span> =&gt; <span class="string">&#x27;$skills&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;count&#x27;</span> =&gt; [<span class="string">&#x27;$sum&#x27;</span> =&gt; <span class="number">1</span>],</span><br><span class="line">                <span class="string">&#x27;avg_age&#x27;</span> =&gt; [<span class="string">&#x27;$avg&#x27;</span> =&gt; <span class="string">&#x27;$age&#x27;</span>]</span><br><span class="line">            ]],</span><br><span class="line">            [<span class="string">&#x27;$sort&#x27;</span> =&gt; [<span class="string">&#x27;count&#x27;</span> =&gt; -<span class="number">1</span>, <span class="string">&#x27;avg_age&#x27;</span> =&gt; <span class="number">1</span>]],</span><br><span class="line">            [<span class="string">&#x27;$limit&#x27;</span> =&gt; <span class="number">5</span>]</span><br><span class="line">        ];</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$cursor</span> = <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">aggregate</span>(<span class="variable">$pipeline</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\n3. æŠ€èƒ½ç»Ÿè®¡ï¼ˆèšåˆæŸ¥è¯¢ï¼‰:\n&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$cursor</span> <span class="keyword">as</span> <span class="variable">$skill</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;   - <span class="subst">&#123;$skill[&#x27;_id&#x27;]&#125;</span>: <span class="subst">&#123;$skill[&#x27;count&#x27;]&#125;</span>äºº, å¹³å‡å¹´é¾„: &quot;</span> . <span class="title function_ invoke__">round</span>(<span class="variable">$skill</span>[<span class="string">&#x27;avg_age&#x27;</span>], <span class="number">1</span>) . <span class="string">&quot;å²\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº‹åŠ¡æ“ä½œç¤ºä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">transactionExample</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">        <span class="variable">$session</span> = <span class="variable language_">$this</span>-&gt;client-&gt;<span class="title function_ invoke__">startSession</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$session</span>-&gt;<span class="title function_ invoke__">startTransaction</span>([</span><br><span class="line">                <span class="string">&#x27;readConcern&#x27;</span> =&gt; <span class="keyword">new</span> \MongoDB\Driver\<span class="title function_ invoke__">ReadConcern</span>(\MongoDB<span class="title class_">\Driver\ReadConcern</span>::<span class="variable constant_">MAJORITY</span>),</span><br><span class="line">                <span class="string">&#x27;writeConcern&#x27;</span> =&gt; <span class="keyword">new</span> \MongoDB\Driver\<span class="title function_ invoke__">WriteConcern</span>(\MongoDB<span class="title class_">\Driver\WriteConcern</span>::<span class="variable constant_">MAJORITY</span>, <span class="number">10000</span>),</span><br><span class="line">                <span class="string">&#x27;readPreference&#x27;</span> =&gt; <span class="keyword">new</span> <span class="title class_">ReadPreference</span>(<span class="title class_">ReadPreference</span>::<span class="variable constant_">RP_PRIMARY</span>)</span><br><span class="line">            ]);</span><br><span class="line">            </span><br><span class="line">            <span class="variable">$collection</span> = <span class="variable language_">$this</span>-&gt;client-&gt;<span class="title function_ invoke__">selectCollection</span>(<span class="variable">$this</span>-&gt;databaseName, <span class="variable">$this</span>-&gt;collectionName);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ’å…¥æ–°ç”¨æˆ·</span></span><br><span class="line">            <span class="variable">$newUser</span> = [</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;transaction_user_&#x27;</span> . <span class="title function_ invoke__">time</span>(),</span><br><span class="line">                <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;tx_&#x27;</span> . <span class="title function_ invoke__">time</span>() . <span class="string">&#x27;@example.com&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;age&#x27;</span> =&gt; <span class="number">30</span>,</span><br><span class="line">                <span class="string">&#x27;skills&#x27;</span> =&gt; [<span class="string">&#x27;Transaction&#x27;</span>, <span class="string">&#x27;MongoDB&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;created_at&#x27;</span> =&gt; <span class="keyword">new</span> MongoDB\BSON\<span class="title function_ invoke__">UTCDateTime</span>()</span><br><span class="line">            ];</span><br><span class="line">            </span><br><span class="line">            <span class="variable">$insertResult</span> = <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">insertOne</span>(<span class="variable">$newUser</span>, [<span class="string">&#x27;session&#x27;</span> =&gt; <span class="variable">$session</span>]);</span><br><span class="line">            <span class="variable">$userId</span> = <span class="variable">$insertResult</span>-&gt;<span class="title function_ invoke__">getInsertedId</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;âœ… äº‹åŠ¡: æ’å…¥ç”¨æˆ·æˆåŠŸ, ID: <span class="subst">&#123;$userId&#125;</span>\n&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">            <span class="variable">$analyticsCollection</span> = <span class="variable language_">$this</span>-&gt;client-&gt;<span class="title function_ invoke__">selectCollection</span>(<span class="variable">$this</span>-&gt;databaseName, <span class="string">&#x27;analytics&#x27;</span>);</span><br><span class="line">            <span class="variable">$analyticsCollection</span>-&gt;<span class="title function_ invoke__">updateOne</span>(</span><br><span class="line">                [<span class="string">&#x27;type&#x27;</span> =&gt; <span class="string">&#x27;user_count&#x27;</span>],</span><br><span class="line">                [<span class="string">&#x27;$inc&#x27;</span> =&gt; [<span class="string">&#x27;count&#x27;</span> =&gt; <span class="number">1</span>]],</span><br><span class="line">                [<span class="string">&#x27;upsert&#x27;</span> =&gt; <span class="literal">true</span>, <span class="string">&#x27;session&#x27;</span> =&gt; <span class="variable">$session</span>]</span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;âœ… äº‹åŠ¡: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ\n&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æäº¤äº‹åŠ¡</span></span><br><span class="line">            <span class="variable">$session</span>-&gt;<span class="title function_ invoke__">commitTransaction</span>();</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;âœ… äº‹åŠ¡æäº¤æˆåŠŸ\n&quot;</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="comment">// å›æ»šäº‹åŠ¡</span></span><br><span class="line">            <span class="variable">$session</span>-&gt;<span class="title function_ invoke__">abortTransaction</span>();</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;âŒ äº‹åŠ¡å¤±è´¥ï¼Œå·²å›æ»š: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="variable">$session</span>-&gt;<span class="title function_ invoke__">endSession</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡æ“ä½œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bulkOperations</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">        <span class="variable">$collection</span> = <span class="variable language_">$this</span>-&gt;client-&gt;<span class="title function_ invoke__">selectCollection</span>(<span class="variable">$this</span>-&gt;databaseName, <span class="variable">$this</span>-&gt;collectionName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‡†å¤‡1000æ¡æµ‹è¯•æ•°æ®</span></span><br><span class="line">        <span class="variable">$bulkData</span> = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$bulkData</span>[] = [</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;bulk_user_&#x27;</span> . (<span class="variable">$i</span> + <span class="number">1</span>),</span><br><span class="line">                <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;bulk_&#x27;</span> . (<span class="variable">$i</span> + <span class="number">1</span>) . <span class="string">&#x27;@example.com&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;age&#x27;</span> =&gt; <span class="title function_ invoke__">rand</span>(<span class="number">18</span>, <span class="number">60</span>),</span><br><span class="line">                <span class="string">&#x27;skills&#x27;</span> =&gt; [<span class="string">&#x27;Bulk&#x27;</span>, <span class="string">&#x27;MongoDB&#x27;</span>, <span class="string">&#x27;PHP&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;created_at&#x27;</span> =&gt; <span class="keyword">new</span> MongoDB\BSON\<span class="title function_ invoke__">UTCDateTime</span>()</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ–¹æ³•1: insertMany (æ¨è)</span></span><br><span class="line">        <span class="variable">$startTime</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$collection</span>-&gt;<span class="title function_ invoke__">insertMany</span>(<span class="variable">$bulkData</span>, [</span><br><span class="line">            <span class="string">&#x27;ordered&#x27;</span> =&gt; <span class="literal">false</span>, // æ— åºæ’å…¥ï¼Œéƒ¨åˆ†å¤±è´¥ä¸å½±å“å…¶ä»–</span><br><span class="line">            <span class="string">&#x27;bypassDocumentValidation&#x27;</span> =&gt; <span class="literal">true</span> // è·³è¿‡éªŒè¯æå‡æ€§èƒ½</span><br><span class="line">        ]);</span><br><span class="line">        <span class="variable">$endTime</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;âœ… insertMany æ’å…¥ 1000 æ¡è®°å½•ï¼Œè€—æ—¶: &quot;</span> . <span class="title function_ invoke__">round</span>(<span class="variable">$endTime</span> - <span class="variable">$startTime</span>, <span class="number">3</span>) . <span class="string">&quot;ç§’\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;   æ’å…¥æ•°é‡: <span class="subst">&#123;$result-&gt;getInsertedCount()&#125;</span>, å¤±è´¥æ•°é‡: &quot;</span> . <span class="title function_ invoke__">count</span>(<span class="variable">$result</span>-&gt;<span class="title function_ invoke__">getWriteErrors</span>()) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ–¹æ³•2: BulkWrite (æ›´ç»†ç²’åº¦æ§åˆ¶)</span></span><br><span class="line">        <span class="variable">$bulk</span> = <span class="keyword">new</span> <span class="title class_">BulkWrite</span>([<span class="string">&#x27;ordered&#x27;</span> =&gt; <span class="literal">false</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">500</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$bulk</span>-&gt;<span class="title function_ invoke__">insert</span>([</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;bulkwrite_user_&#x27;</span> . (<span class="variable">$i</span> + <span class="number">1</span>),</span><br><span class="line">                <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;bulkwrite_&#x27;</span> . (<span class="variable">$i</span> + <span class="number">1</span>) . <span class="string">&#x27;@example.com&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;age&#x27;</span> =&gt; <span class="title function_ invoke__">rand</span>(<span class="number">18</span>, <span class="number">60</span>),</span><br><span class="line">                <span class="string">&#x27;skills&#x27;</span> =&gt; [<span class="string">&#x27;BulkWrite&#x27;</span>, <span class="string">&#x27;MongoDB&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;created_at&#x27;</span> =&gt; <span class="keyword">new</span> MongoDB\BSON\<span class="title function_ invoke__">UTCDateTime</span>()</span><br><span class="line">            ]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$startTime</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="variable">$writeResult</span> = <span class="variable language_">$this</span>-&gt;manager-&gt;<span class="title function_ invoke__">executeBulkWrite</span>(</span><br><span class="line">            <span class="string">&quot;<span class="subst">&#123;$this-&gt;databaseName&#125;</span>.<span class="subst">&#123;$this-&gt;collectionName&#125;</span>&quot;</span>,</span><br><span class="line">            <span class="variable">$bulk</span>,</span><br><span class="line">            [<span class="string">&#x27;writeConcern&#x27;</span> =&gt; <span class="keyword">new</span> <span class="title class_">WriteConcern</span>(<span class="title class_">WriteConcern</span>::<span class="variable constant_">MAJORITY</span>, <span class="number">10000</span>)]</span><br><span class="line">        );</span><br><span class="line">        <span class="variable">$endTime</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;âœ… BulkWrite æ’å…¥ 500 æ¡è®°å½•ï¼Œè€—æ—¶: &quot;</span> . <span class="title function_ invoke__">round</span>(<span class="variable">$endTime</span> - <span class="variable">$startTime</span>, <span class="number">3</span>) . <span class="string">&quot;ç§’\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;   æ’å…¥æ•°é‡: <span class="subst">&#123;$writeResult-&gt;getInsertedCount()&#125;</span>\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›‘æ§ä¸è¯Šæ–­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">monitoringExample</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">        <span class="variable">$serverStatus</span> = <span class="variable language_">$this</span>-&gt;manager-&gt;<span class="title function_ invoke__">executeCommand</span>(</span><br><span class="line">            <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">            <span class="keyword">new</span> MongoDB\Driver\<span class="title function_ invoke__">Command</span>([<span class="string">&#x27;serverStatus&#x27;</span> =&gt; <span class="number">1</span>])</span><br><span class="line">        )-&gt;<span class="title function_ invoke__">toArray</span>()[<span class="number">0</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\nğŸ“Š æœåŠ¡å™¨çŠ¶æ€ç›‘æ§:\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;   - ç‰ˆæœ¬: <span class="subst">&#123;$serverStatus-&gt;version&#125;</span>\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;   - è¿æ¥æ•°: <span class="subst">&#123;$serverStatus-&gt;connections-&gt;current&#125;</span> / <span class="subst">&#123;$serverStatus-&gt;connections-&gt;available&#125;</span>\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;   - å†…å­˜ä½¿ç”¨: &quot;</span> . <span class="title function_ invoke__">round</span>(<span class="variable">$serverStatus</span>-&gt;mem-&gt;resident / <span class="number">1024</span>, <span class="number">2</span>) . <span class="string">&quot;GB (é©»ç•™)\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;   - æ“ä½œè®¡æ•°: \n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;     * æ’å…¥: <span class="subst">&#123;$serverStatus-&gt;opcounters-&gt;insert&#125;</span>\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;     * æŸ¥è¯¢: <span class="subst">&#123;$serverStatus-&gt;opcounters-&gt;query&#125;</span>\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;     * æ›´æ–°: <span class="subst">&#123;$serverStatus-&gt;opcounters-&gt;update&#125;</span>\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;     * åˆ é™¤: <span class="subst">&#123;$serverStatus-&gt;opcounters-&gt;delete&#125;</span>\n&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ…¢æŸ¥è¯¢æ—¥å¿—</span></span><br><span class="line">        <span class="variable">$currentOp</span> = <span class="variable language_">$this</span>-&gt;manager-&gt;<span class="title function_ invoke__">executeCommand</span>(</span><br><span class="line">            <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">            <span class="keyword">new</span> MongoDB\Driver\<span class="title function_ invoke__">Command</span>([</span><br><span class="line">                <span class="string">&#x27;currentOp&#x27;</span> =&gt; [</span><br><span class="line">                    <span class="string">&#x27;active&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">                    <span class="string">&#x27;secs_running&#x27;</span> =&gt; [<span class="string">&#x27;$gt&#x27;</span> =&gt; <span class="number">1</span>] // è¿è¡Œè¶…è¿‡<span class="number">1</span>ç§’çš„æ“ä½œ</span><br><span class="line">                ]</span><br><span class="line">            ])</span><br><span class="line">        )-&gt;<span class="title function_ invoke__">toArray</span>()[<span class="number">0</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\nâš ï¸  æ…¢æŸ¥è¯¢æ£€æµ‹:\n&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$currentOp</span>-&gt;inprog) &amp;&amp; <span class="title function_ invoke__">count</span>(<span class="variable">$currentOp</span>-&gt;inprog) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$currentOp</span>-&gt;inprog <span class="keyword">as</span> <span class="variable">$op</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;   - OPID: <span class="subst">&#123;$op-&gt;opid&#125;</span>, æ“ä½œ: <span class="subst">&#123;$op-&gt;op&#125;</span>, è€—æ—¶: <span class="subst">&#123;$op-&gt;secs_running&#125;</span>ç§’\n&quot;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;     æŸ¥è¯¢: &quot;</span> . <span class="title function_ invoke__">json_encode</span>(<span class="variable">$op</span>-&gt;query) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;   - æ— æ…¢æŸ¥è¯¢\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³é—­è¿æ¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;manager, <span class="variable language_">$this</span>-&gt;client);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;âœ… è¿æ¥å·²å…³é—­\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$mongoExample</span> = <span class="keyword">new</span> <span class="title class_">MongoDBExample</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;ğŸš€ å¼€å§‹ MongoDB PHP 8.2 æ“ä½œç¤ºä¾‹\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;=====================================\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$mongoExample</span>-&gt;<span class="title function_ invoke__">createCollection</span>();</span><br><span class="line">    <span class="variable">$mongoExample</span>-&gt;<span class="title function_ invoke__">bulkInsertUsers</span>();</span><br><span class="line">    <span class="variable">$mongoExample</span>-&gt;<span class="title function_ invoke__">advancedQueries</span>();</span><br><span class="line">    <span class="variable">$mongoExample</span>-&gt;<span class="title function_ invoke__">transactionExample</span>();</span><br><span class="line">    <span class="variable">$mongoExample</span>-&gt;<span class="title function_ invoke__">bulkOperations</span>();</span><br><span class="line">    <span class="variable">$mongoExample</span>-&gt;<span class="title function_ invoke__">monitoringExample</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$mongoExample</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;\nğŸ‰ æ‰€æœ‰æ“ä½œå®Œæˆï¼\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;âŒ ç¨‹åºå¼‚å¸¸: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-Go-1-22-MongoDB-Driver-å®Œæ•´ç¤ºä¾‹"><a href="#6-2-Go-1-22-MongoDB-Driver-å®Œæ•´ç¤ºä¾‹" class="headerlink" title="6.2 Go 1.22 + MongoDB Driver å®Œæ•´ç¤ºä¾‹"></a>6.2 Go 1.22 + MongoDB Driver å®Œæ•´ç¤ºä¾‹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;go.mongodb.org/mongo-driver/bson&quot;</span></span><br><span class="line"><span class="string">&quot;go.mongodb.org/mongo-driver/bson/primitive&quot;</span></span><br><span class="line"><span class="string">&quot;go.mongodb.org/mongo-driver/mongo&quot;</span></span><br><span class="line"><span class="string">&quot;go.mongodb.org/mongo-driver/mongo/options&quot;</span></span><br><span class="line"><span class="string">&quot;go.mongodb.org/mongo-driver/mongo/readpref&quot;</span></span><br><span class="line"><span class="string">&quot;go.mongodb.org/mongo-driver/mongo/writeconcern&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// User ç»“æ„ä½“æ˜ å°„MongoDBæ–‡æ¡£</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">ID        primitive.ObjectID <span class="string">`bson:&quot;_id,omitempty&quot;`</span></span><br><span class="line">Username  <span class="type">string</span>             <span class="string">`bson:&quot;username&quot;`</span></span><br><span class="line">Email     <span class="type">string</span>             <span class="string">`bson:&quot;email&quot;`</span></span><br><span class="line">Age       <span class="type">int</span>                <span class="string">`bson:&quot;age&quot;`</span></span><br><span class="line">Skills    []<span class="type">string</span>           <span class="string">`bson:&quot;skills&quot;`</span></span><br><span class="line">CreatedAt time.Time          <span class="string">`bson:&quot;created_at&quot;`</span></span><br><span class="line">UpdatedAt time.Time          <span class="string">`bson:&quot;updated_at&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Analytics ç»Ÿè®¡ä¿¡æ¯ç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> Analytics <span class="keyword">struct</span> &#123;</span><br><span class="line">ID    primitive.ObjectID <span class="string">`bson:&quot;_id,omitempty&quot;`</span></span><br><span class="line">Type  <span class="type">string</span>             <span class="string">`bson:&quot;type&quot;`</span></span><br><span class="line">Count <span class="type">int</span>                <span class="string">`bson:&quot;count&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MongoDBExample <span class="keyword">struct</span> &#123;</span><br><span class="line">client     *mongo.Client</span><br><span class="line">database   *mongo.Database</span><br><span class="line">collection *mongo.Collection</span><br><span class="line">ctx        context.Context</span><br><span class="line">cancel     context.CancelFunc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMongoDBExample</span><span class="params">()</span></span> (*MongoDBExample, <span class="type">error</span>) &#123;</span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿æ¥é€‰é¡¹</span></span><br><span class="line">clientOpts := options.Client().</span><br><span class="line">ApplyURI(<span class="string">&quot;mongodb://appuser:AppUserPass123!@192.168.1.101:27017,192.168.1.102:27017,192.168.1.103:27017/?replicaSet=prod-rs0&amp;readPreference=secondaryPreferred&quot;</span>).</span><br><span class="line">SetConnectTimeout(<span class="number">5</span> * time.Second).</span><br><span class="line">SetSocketTimeout(<span class="number">10</span> * time.Second).</span><br><span class="line">SetServerSelectionTimeout(<span class="number">5</span> * time.Second).</span><br><span class="line">SetRetryWrites(<span class="literal">true</span>).</span><br><span class="line">SetWriteConcern(writeconcern.New(writeconcern.WMajority(), writeconcern.J(<span class="literal">true</span>))).</span><br><span class="line">SetReadPreference(readpref.Primary())</span><br><span class="line"></span><br><span class="line">client, err := mongo.Connect(ctx, clientOpts)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">cancel()</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;è¿æ¥å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯è¿æ¥</span></span><br><span class="line"><span class="keyword">if</span> err := client.Ping(ctx, readpref.Primary()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">cancel()</span><br><span class="line">client.Disconnect(ctx)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;Pingå¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">example := &amp;MongoDBExample&#123;</span><br><span class="line">client:     client,</span><br><span class="line">database:   client.Database(<span class="string">&quot;myapp&quot;</span>),</span><br><span class="line">collection: client.Database(<span class="string">&quot;myapp&quot;</span>).Collection(<span class="string">&quot;users&quot;</span>),</span><br><span class="line">ctx:        ctx,</span><br><span class="line">cancel:     cancel,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;âœ… MongoDBè¿æ¥æˆåŠŸ&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> example, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MongoDBExample)</span></span> Close() &#123;</span><br><span class="line"><span class="keyword">defer</span> m.cancel()</span><br><span class="line"><span class="keyword">if</span> err := m.client.Disconnect(m.ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;æ–­å¼€è¿æ¥å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;âœ… è¿æ¥å·²å…³é—­&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºé›†åˆå’Œç´¢å¼•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MongoDBExample)</span></span> CreateCollection() <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// åˆ é™¤å·²å­˜åœ¨çš„é›†åˆ</span></span><br><span class="line"><span class="keyword">if</span> err := m.collection.Drop(m.ctx); err != <span class="literal">nil</span> &amp;&amp; !isNotFound(err) &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;åˆ é™¤é›†åˆå¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºé›†åˆéªŒè¯å™¨</span></span><br><span class="line">validator := bson.M&#123;</span><br><span class="line"><span class="string">&quot;$jsonSchema&quot;</span>: bson.M&#123;</span><br><span class="line"><span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line"><span class="string">&quot;required&quot;</span>: []<span class="type">string</span>&#123;<span class="string">&quot;username&quot;</span>, <span class="string">&quot;email&quot;</span>, <span class="string">&quot;created_at&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;properties&quot;</span>: bson.M&#123;</span><br><span class="line"><span class="string">&quot;username&quot;</span>: bson.M&#123;</span><br><span class="line"><span class="string">&quot;bsonType&quot;</span>:    <span class="string">&quot;string&quot;</span>,</span><br><span class="line"><span class="string">&quot;description&quot;</span>: <span class="string">&quot;ç”¨æˆ·åå¿…é¡»ä¸ºå­—ç¬¦ä¸²&quot;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;email&quot;</span>: bson.M&#123;</span><br><span class="line"><span class="string">&quot;bsonType&quot;</span>:    <span class="string">&quot;string&quot;</span>,</span><br><span class="line"><span class="string">&quot;pattern&quot;</span>:     <span class="string">&quot;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]&#123;2,&#125;$&quot;</span>,</span><br><span class="line"><span class="string">&quot;description&quot;</span>: <span class="string">&quot;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&quot;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;age&quot;</span>: bson.M&#123;</span><br><span class="line"><span class="string">&quot;bsonType&quot;</span>:    <span class="string">&quot;int&quot;</span>,</span><br><span class="line"><span class="string">&quot;minimum&quot;</span>:     <span class="number">0</span>,</span><br><span class="line"><span class="string">&quot;maximum&quot;</span>:     <span class="number">120</span>,</span><br><span class="line"><span class="string">&quot;description&quot;</span>: <span class="string">&quot;å¹´é¾„å¿…é¡»åœ¨0-120ä¹‹é—´&quot;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;skills&quot;</span>: bson.M&#123;</span><br><span class="line"><span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;array&quot;</span>,</span><br><span class="line"><span class="string">&quot;items&quot;</span>: bson.M&#123;</span><br><span class="line"><span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opts := options.CreateCollection().</span><br><span class="line">SetValidator(validator).</span><br><span class="line">SetValidationLevel(<span class="string">&quot;moderate&quot;</span>).</span><br><span class="line">SetValidationAction(<span class="string">&quot;error&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := m.database.CreateCollection(m.ctx, <span class="string">&quot;users&quot;</span>, opts); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;åˆ›å»ºé›†åˆå¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç´¢å¼•</span></span><br><span class="line">indexModels := []mongo.IndexModel&#123;</span><br><span class="line">&#123;</span><br><span class="line">Keys: bson.D&#123;&#123;<span class="string">&quot;username&quot;</span>, <span class="number">1</span>&#125;&#125;,</span><br><span class="line">Options: options.Index().SetUnique(<span class="literal">true</span>),</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Keys: bson.D&#123;&#123;<span class="string">&quot;email&quot;</span>, <span class="number">1</span>&#125;&#125;,</span><br><span class="line">Options: options.Index().SetUnique(<span class="literal">true</span>),</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Keys: bson.D&#123;&#123;<span class="string">&quot;age&quot;</span>, <span class="number">1</span>&#125;&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Keys: bson.D&#123;&#123;<span class="string">&quot;skills&quot;</span>, <span class="number">1</span>&#125;&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Keys: bson.D&#123;&#123;<span class="string">&quot;created_at&quot;</span>, <span class="number">-1</span>&#125;&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err := m.collection.Indexes().CreateMany(m.ctx, indexModels); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;åˆ›å»ºç´¢å¼•å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;âœ… é›†åˆå’Œç´¢å¼•åˆ›å»ºæˆåŠŸ&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡æ’å…¥ç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MongoDBExample)</span></span> BulkInsertUsers() <span class="type">error</span> &#123;</span><br><span class="line">users := []<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">bson.M&#123;</span><br><span class="line"><span class="string">&quot;username&quot;</span>:  <span class="string">&quot;zhangsan_go&quot;</span>,</span><br><span class="line"><span class="string">&quot;email&quot;</span>:     <span class="string">&quot;zhangsan_go@example.com&quot;</span>,</span><br><span class="line"><span class="string">&quot;age&quot;</span>:       <span class="number">28</span>,</span><br><span class="line"><span class="string">&quot;skills&quot;</span>:    []<span class="type">string</span>&#123;<span class="string">&quot;Go&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>, <span class="string">&quot;Docker&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;created_at&quot;</span>: time.Now(),</span><br><span class="line"><span class="string">&quot;updated_at&quot;</span>: time.Now(),</span><br><span class="line">&#125;,</span><br><span class="line">bson.M&#123;</span><br><span class="line"><span class="string">&quot;username&quot;</span>:  <span class="string">&quot;lisi_go&quot;</span>,</span><br><span class="line"><span class="string">&quot;email&quot;</span>:     <span class="string">&quot;lisi_go@example.com&quot;</span>,</span><br><span class="line"><span class="string">&quot;age&quot;</span>:       <span class="number">32</span>,</span><br><span class="line"><span class="string">&quot;skills&quot;</span>:    []<span class="type">string</span>&#123;<span class="string">&quot;Go&quot;</span>, <span class="string">&quot;gRPC&quot;</span>, <span class="string">&quot;Kubernetes&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;created_at&quot;</span>: time.Now(),</span><br><span class="line"><span class="string">&quot;updated_at&quot;</span>: time.Now(),</span><br><span class="line">&#125;,</span><br><span class="line">bson.M&#123;</span><br><span class="line"><span class="string">&quot;username&quot;</span>:  <span class="string">&quot;wangwu_go&quot;</span>,</span><br><span class="line"><span class="string">&quot;email&quot;</span>:     <span class="string">&quot;wangwu_go@example.com&quot;</span>,</span><br><span class="line"><span class="string">&quot;age&quot;</span>:       <span class="number">25</span>,</span><br><span class="line"><span class="string">&quot;skills&quot;</span>:    []<span class="type">string</span>&#123;<span class="string">&quot;Go&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>, <span class="string">&quot;Redis&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;created_at&quot;</span>: time.Now(),</span><br><span class="line"><span class="string">&quot;updated_at&quot;</span>: time.Now(),</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opts := options.InsertMany().SetOrdered(<span class="literal">false</span>)</span><br><span class="line">result, err := m.collection.InsertMany(m.ctx, users, opts)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;æ‰¹é‡æ’å…¥å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;âœ… æ‰¹é‡æ’å…¥æˆåŠŸï¼Œæ’å…¥ %d æ¡è®°å½•\n&quot;</span>, <span class="built_in">len</span>(result.InsertedIDs))</span><br><span class="line"><span class="keyword">for</span> i, id := <span class="keyword">range</span> result.InsertedIDs &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;   - ç¬¬ %d æ¡: %s\n&quot;</span>, i+<span class="number">1</span>, id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é«˜çº§æŸ¥è¯¢</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MongoDBExample)</span></span> AdvancedQueries() <span class="type">error</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;\nğŸ” é«˜çº§æŸ¥è¯¢ç¤ºä¾‹:&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. æŸ¥æ‰¾å¹´é¾„å¤§äº30çš„ç”¨æˆ·</span></span><br><span class="line">filter := bson.M&#123;<span class="string">&quot;age&quot;</span>: bson.M&#123;<span class="string">&quot;$gt&quot;</span>: <span class="number">30</span>&#125;&#125;</span><br><span class="line">projection := bson.M&#123;<span class="string">&quot;username&quot;</span>: <span class="number">1</span>, <span class="string">&quot;age&quot;</span>: <span class="number">1</span>, <span class="string">&quot;skills&quot;</span>: <span class="number">1</span>, <span class="string">&quot;_id&quot;</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">cursor, err := m.collection.Find(m.ctx, filter, options.Find().SetProjection(projection))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;æŸ¥è¯¢å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> cursor.Close(m.ctx)</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;1. å¹´é¾„ &gt; 30 çš„ç”¨æˆ·:&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> results []bson.M</span><br><span class="line"><span class="keyword">if</span> err := cursor.All(m.ctx, &amp;results); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;è·å–ç»“æœå¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, user := <span class="keyword">range</span> results &#123;</span><br><span class="line">skills, _ := user[<span class="string">&quot;skills&quot;</span>].([]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">skillStrs := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="built_in">len</span>(skills))</span><br><span class="line"><span class="keyword">for</span> i, s := <span class="keyword">range</span> skills &#123;</span><br><span class="line">skillStrs[i] = s.(<span class="type">string</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;   - %s (%då²): %s\n&quot;</span>, </span><br><span class="line">user[<span class="string">&quot;username&quot;</span>], </span><br><span class="line">user[<span class="string">&quot;age&quot;</span>], </span><br><span class="line">stringSliceToString(skillStrs))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. èšåˆæŸ¥è¯¢</span></span><br><span class="line">pipeline := mongo.Pipeline&#123;</span><br><span class="line">&#123;&#123;<span class="string">&quot;$unwind&quot;</span>, <span class="string">&quot;$skills&quot;</span>&#125;&#125;,</span><br><span class="line">&#123;&#123;<span class="string">&quot;$group&quot;</span>, bson.D&#123;</span><br><span class="line">&#123;<span class="string">&quot;_id&quot;</span>, <span class="string">&quot;$skills&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;count&quot;</span>, bson.D&#123;&#123;<span class="string">&quot;$sum&quot;</span>, <span class="number">1</span>&#125;&#125;&#125;,</span><br><span class="line">&#123;<span class="string">&quot;avg_age&quot;</span>, bson.D&#123;&#123;<span class="string">&quot;$avg&quot;</span>, <span class="string">&quot;$age&quot;</span>&#125;&#125;&#125;,</span><br><span class="line">&#125;&#125;&#125;,</span><br><span class="line">&#123;&#123;<span class="string">&quot;$sort&quot;</span>, bson.D&#123;&#123;<span class="string">&quot;count&quot;</span>, <span class="number">-1</span>&#125;, &#123;<span class="string">&quot;avg_age&quot;</span>, <span class="number">1</span>&#125;&#125;&#125;&#125;,</span><br><span class="line">&#123;&#123;<span class="string">&quot;$limit&quot;</span>, <span class="number">5</span>&#125;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cursor, err = m.collection.Aggregate(m.ctx, pipeline)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;èšåˆæŸ¥è¯¢å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> cursor.Close(m.ctx)</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;\n2. æŠ€èƒ½ç»Ÿè®¡ï¼ˆèšåˆæŸ¥è¯¢ï¼‰:&quot;</span>)</span><br><span class="line"><span class="keyword">type</span> SkillStats <span class="keyword">struct</span> &#123;</span><br><span class="line">Skill  <span class="type">string</span>  <span class="string">`bson:&quot;_id&quot;`</span></span><br><span class="line">Count  <span class="type">int</span>     <span class="string">`bson:&quot;count&quot;`</span></span><br><span class="line">AvgAge <span class="type">float64</span> <span class="string">`bson:&quot;avg_age&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stats []SkillStats</span><br><span class="line"><span class="keyword">if</span> err := cursor.All(m.ctx, &amp;stats); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;è·å–èšåˆç»“æœå¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, stat := <span class="keyword">range</span> stats &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;   - %s: %däºº, å¹³å‡å¹´é¾„: %.1få²\n&quot;</span>, </span><br><span class="line">stat.Skill, stat.Count, stat.AvgAge)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹åŠ¡æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MongoDBExample)</span></span> TransactionExample() <span class="type">error</span> &#123;</span><br><span class="line">session, err := m.client.StartSession()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;åˆ›å»ºä¼šè¯å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> session.EndSession(m.ctx)</span><br><span class="line"></span><br><span class="line">callback := <span class="function"><span class="keyword">func</span><span class="params">(sessCtx mongo.SessionContext)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="comment">// æ’å…¥æ–°ç”¨æˆ·</span></span><br><span class="line">newUser := bson.M&#123;</span><br><span class="line"><span class="string">&quot;username&quot;</span>:   <span class="string">&quot;transaction_user_&quot;</span> + time.Now().Format(<span class="string">&quot;20060102150405&quot;</span>),</span><br><span class="line"><span class="string">&quot;email&quot;</span>:      <span class="string">&quot;tx_&quot;</span> + time.Now().Format(<span class="string">&quot;20060102150405&quot;</span>) + <span class="string">&quot;@example.com&quot;</span>,</span><br><span class="line"><span class="string">&quot;age&quot;</span>:        <span class="number">30</span>,</span><br><span class="line"><span class="string">&quot;skills&quot;</span>:     []<span class="type">string</span>&#123;<span class="string">&quot;Transaction&quot;</span>, <span class="string">&quot;Go&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;created_at&quot;</span>: time.Now(),</span><br><span class="line"><span class="string">&quot;updated_at&quot;</span>: time.Now(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result, err := m.collection.InsertOne(sessCtx, newUser)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;æ’å…¥ç”¨æˆ·å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;âœ… äº‹åŠ¡: æ’å…¥ç”¨æˆ·æˆåŠŸ, ID: %s\n&quot;</span>, result.InsertedID)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">analyticsColl := m.database.Collection(<span class="string">&quot;analytics&quot;</span>)</span><br><span class="line">filter := bson.M&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;user_count&quot;</span>&#125;</span><br><span class="line">update := bson.M&#123;<span class="string">&quot;$inc&quot;</span>: bson.M&#123;<span class="string">&quot;count&quot;</span>: <span class="number">1</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">_, err = analyticsColl.UpdateOne(</span><br><span class="line">sessCtx,</span><br><span class="line">filter,</span><br><span class="line">update,</span><br><span class="line">options.Update().SetUpsert(<span class="literal">true</span>),</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;æ›´æ–°ç»Ÿè®¡å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;âœ… äº‹åŠ¡: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> _, err := session.WithTransaction(m.ctx, callback); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;äº‹åŠ¡æ‰§è¡Œå¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;âœ… äº‹åŠ¡æäº¤æˆåŠŸ&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡æ’å…¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MongoDBExample)</span></span> PerformanceTest() <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// å‡†å¤‡10,000æ¡æµ‹è¯•æ•°æ®</span></span><br><span class="line">bulkData := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">10000</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">bulkData[i] = bson.M&#123;</span><br><span class="line"><span class="string">&quot;username&quot;</span>:   fmt.Sprintf(<span class="string">&quot;perf_user_%d&quot;</span>, i+<span class="number">1</span>),</span><br><span class="line"><span class="string">&quot;email&quot;</span>:      fmt.Sprintf(<span class="string">&quot;perf_%d@example.com&quot;</span>, i+<span class="number">1</span>),</span><br><span class="line"><span class="string">&quot;age&quot;</span>:        <span class="number">18</span> + i%<span class="number">43</span>,</span><br><span class="line"><span class="string">&quot;skills&quot;</span>:     []<span class="type">string</span>&#123;<span class="string">&quot;Performance&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>, <span class="string">&quot;Go&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;created_at&quot;</span>: time.Now(),</span><br><span class="line"><span class="string">&quot;updated_at&quot;</span>: time.Now(),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•insertManyæ€§èƒ½</span></span><br><span class="line">startTime := time.Now()</span><br><span class="line">opts := options.InsertMany().SetOrdered(<span class="literal">false</span>)</span><br><span class="line">_, err := m.collection.InsertMany(m.ctx, bulkData, opts)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;æ‰¹é‡æ’å…¥å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">duration := time.Since(startTime)</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;âœ… æ’å…¥ 10,000 æ¡è®°å½•ï¼Œè€—æ—¶: %.3fç§’\n&quot;</span>, duration.Seconds())</span><br><span class="line">fmt.Printf(<span class="string">&quot;   ååé‡: %.2f æ¡/ç§’\n&quot;</span>, <span class="number">10000</span>/duration.Seconds())</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æ§ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *MongoDBExample)</span></span> Monitoring() <span class="type">error</span> &#123;</span><br><span class="line">serverStatus := bson.M&#123;&#125;</span><br><span class="line">err := m.database.RunCommand(m.ctx, bson.D&#123;&#123;<span class="string">&quot;serverStatus&quot;</span>, <span class="number">1</span>&#125;&#125;).Decode(&amp;serverStatus)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;è·å–æœåŠ¡å™¨çŠ¶æ€å¤±è´¥: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;\nğŸ“Š æœåŠ¡å™¨çŠ¶æ€ç›‘æ§:&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;   - ç‰ˆæœ¬: %s\n&quot;</span>, serverStatus[<span class="string">&quot;version&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> connections, ok := serverStatus[<span class="string">&quot;connections&quot;</span>].(bson.M); ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;   - è¿æ¥æ•°: %d / %d\n&quot;</span>, </span><br><span class="line">connections[<span class="string">&quot;current&quot;</span>], connections[<span class="string">&quot;available&quot;</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> mem, ok := serverStatus[<span class="string">&quot;mem&quot;</span>].(bson.M); ok &#123;</span><br><span class="line"><span class="keyword">if</span> resident, ok := mem[<span class="string">&quot;resident&quot;</span>].(<span class="type">int32</span>); ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;   - å†…å­˜ä½¿ç”¨: %.2fGB (é©»ç•™)\n&quot;</span>, <span class="type">float64</span>(resident)/<span class="number">1024</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> opcounters, ok := serverStatus[<span class="string">&quot;opcounters&quot;</span>].(bson.M); ok &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;   - æ“ä½œè®¡æ•°:&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;     * æ’å…¥: %d\n&quot;</span>, opcounters[<span class="string">&quot;insert&quot;</span>])</span><br><span class="line">fmt.Printf(<span class="string">&quot;     * æŸ¥è¯¢: %d\n&quot;</span>, opcounters[<span class="string">&quot;query&quot;</span>])</span><br><span class="line">fmt.Printf(<span class="string">&quot;     * æ›´æ–°: %d\n&quot;</span>, opcounters[<span class="string">&quot;update&quot;</span>])</span><br><span class="line">fmt.Printf(<span class="string">&quot;     * åˆ é™¤: %d\n&quot;</span>, opcounters[<span class="string">&quot;delete&quot;</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾…åŠ©å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isNotFound</span><span class="params">(err <span class="type">error</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err.Error() == <span class="string">&quot;ns not found&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stringSliceToString</span><span class="params">(s []<span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">result := <span class="string">&quot;[&quot;</span></span><br><span class="line"><span class="keyword">for</span> i, str := <span class="keyword">range</span> s &#123;</span><br><span class="line"><span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</span><br><span class="line">result += <span class="string">&quot;, &quot;</span></span><br><span class="line">&#125;</span><br><span class="line">result += str</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">&quot;]&quot;</span></span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;ğŸš€ å¼€å§‹ MongoDB Go 1.22 æ“ä½œç¤ºä¾‹&quot;</span>)</span><br><span class="line">fmt.Println(<span class="string">&quot;=====================================&quot;</span>)</span><br><span class="line"></span><br><span class="line">example, err := NewMongoDBExample()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;åˆå§‹åŒ–å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> example.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := example.CreateCollection(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;åˆ›å»ºé›†åˆå¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := example.BulkInsertUsers(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;æ‰¹é‡æ’å…¥å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := example.AdvancedQueries(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;é«˜çº§æŸ¥è¯¢å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := example.TransactionExample(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;äº‹åŠ¡æ“ä½œå¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := example.PerformanceTest(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;æ€§èƒ½æµ‹è¯•å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := example.Monitoring(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;ç›‘æ§å¤±è´¥: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;\nğŸ‰ æ‰€æœ‰æ“ä½œå®Œæˆï¼&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-3-Python-3-11-PyMongo-å¼‚æ­¥æ“ä½œç¤ºä¾‹"><a href="#6-3-Python-3-11-PyMongo-å¼‚æ­¥æ“ä½œç¤ºä¾‹" class="headerlink" title="6.3 Python 3.11 + PyMongo å¼‚æ­¥æ“ä½œç¤ºä¾‹"></a>6.3 Python 3.11 + PyMongo å¼‚æ­¥æ“ä½œç¤ºä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">MongoDB Python 3.11 å¼‚æ­¥æ“ä½œå®Œæ•´ç¤ºä¾‹</span></span><br><span class="line"><span class="string">éœ€è¦å®‰è£…: pip install pymongo motor</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">import</span> motor.motor_asyncio</span><br><span class="line"><span class="keyword">from</span> motor.motor_asyncio <span class="keyword">import</span> AsyncIOMotorClient, AsyncIOMotorDatabase, AsyncIOMotorCollection</span><br><span class="line"><span class="keyword">from</span> bson <span class="keyword">import</span> ObjectId</span><br><span class="line"><span class="keyword">from</span> bson.codec_options <span class="keyword">import</span> CodecOptions</span><br><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> ReadPreference, WriteConcern</span><br><span class="line"><span class="keyword">from</span> pymongo.errors <span class="keyword">import</span> ConnectionFailure, OperationFailure, DuplicateKeyError</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ—¥å¿—</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">    handlers=[</span><br><span class="line">        logging.FileHandler(<span class="string">&quot;mongodb_example.log&quot;</span>),</span><br><span class="line">        logging.StreamHandler()</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;MongoDBExample&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç”¨æˆ·æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username: <span class="built_in">str</span>, email: <span class="built_in">str</span>, age: <span class="built_in">int</span>, skills: <span class="type">List</span>[<span class="built_in">str</span>]</span>):</span><br><span class="line">        self.username = username</span><br><span class="line">        self.email = email</span><br><span class="line">        self.age = age</span><br><span class="line">        self.skills = skills</span><br><span class="line">        self.created_at = datetime.utcnow()</span><br><span class="line">        self.updated_at = datetime.utcnow()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è½¬æ¢ä¸ºå­—å…¸&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: self.username,</span><br><span class="line">            <span class="string">&quot;email&quot;</span>: self.email,</span><br><span class="line">            <span class="string">&quot;age&quot;</span>: self.age,</span><br><span class="line">            <span class="string">&quot;skills&quot;</span>: self.skills,</span><br><span class="line">            <span class="string">&quot;created_at&quot;</span>: self.created_at,</span><br><span class="line">            <span class="string">&quot;updated_at&quot;</span>: self.updated_at</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_dict</span>(<span class="params">cls, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="string">&quot;User&quot;</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä»å­—å…¸åˆ›å»ºå¯¹è±¡&quot;&quot;&quot;</span></span><br><span class="line">        user = cls(</span><br><span class="line">            username=data[<span class="string">&quot;username&quot;</span>],</span><br><span class="line">            email=data[<span class="string">&quot;email&quot;</span>],</span><br><span class="line">            age=data[<span class="string">&quot;age&quot;</span>],</span><br><span class="line">            skills=data[<span class="string">&quot;skills&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">        user.created_at = data.get(<span class="string">&quot;created_at&quot;</span>, datetime.utcnow())</span><br><span class="line">        user.updated_at = data.get(<span class="string">&quot;updated_at&quot;</span>, datetime.utcnow())</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MongoDBExample</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;MongoDBå¼‚æ­¥æ“ä½œç¤ºä¾‹ç±»&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.client: <span class="type">Optional</span>[AsyncIOMotorClient] = <span class="literal">None</span></span><br><span class="line">        self.db: <span class="type">Optional</span>[AsyncIOMotorDatabase] = <span class="literal">None</span></span><br><span class="line">        self.collection: <span class="type">Optional</span>[AsyncIOMotorCollection] = <span class="literal">None</span></span><br><span class="line">        self.uri = <span class="string">&quot;mongodb://appuser:AppUserPass123!@192.168.1.101:27017,192.168.1.102:27017,192.168.1.103:27017/?replicaSet=prod-rs0&amp;readPreference=secondaryPreferred&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¿æ¥MongoDB&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client = motor.motor_asyncio.AsyncIOMotorClient(</span><br><span class="line">                self.uri,</span><br><span class="line">                serverSelectionTimeoutMS=<span class="number">5000</span>,</span><br><span class="line">                connectTimeoutMS=<span class="number">5000</span>,</span><br><span class="line">                socketTimeoutMS=<span class="number">10000</span>,</span><br><span class="line">                maxPoolSize=<span class="number">50</span>,</span><br><span class="line">                minPoolSize=<span class="number">10</span>,</span><br><span class="line">                retryWrites=<span class="literal">True</span>,</span><br><span class="line">                w=<span class="string">&quot;majority&quot;</span>,</span><br><span class="line">                journal=<span class="literal">True</span>,</span><br><span class="line">                readPreference=ReadPreference.PRIMARY</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># éªŒè¯è¿æ¥</span></span><br><span class="line">            <span class="keyword">await</span> self.client.admin.command(<span class="string">&#x27;ping&#x27;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;âœ… MongoDBè¿æ¥æˆåŠŸ&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># é€‰æ‹©æ•°æ®åº“å’Œé›†åˆ</span></span><br><span class="line">            self.db = self.client.get_database(</span><br><span class="line">                <span class="string">&quot;myapp&quot;</span>,</span><br><span class="line">                codec_options=CodecOptions(tz_aware=<span class="literal">True</span>)</span><br><span class="line">            )</span><br><span class="line">            self.collection = self.db.get_collection(</span><br><span class="line">                <span class="string">&quot;users&quot;</span>,</span><br><span class="line">                write_concern=WriteConcern(w=<span class="string">&quot;majority&quot;</span>, j=<span class="literal">True</span>)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> ConnectionFailure <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;âŒ è¿æ¥å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span> OperationFailure <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;âŒ æ“ä½œå¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å…³é—­è¿æ¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.client:</span><br><span class="line">            self.client.close()</span><br><span class="line">            logger.info(<span class="string">&quot;âœ… è¿æ¥å·²å…³é—­&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_collection</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºé›†åˆå’Œç´¢å¼•&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># åˆ é™¤å·²å­˜åœ¨çš„é›†åˆ</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;users&quot;</span> <span class="keyword">in</span> <span class="keyword">await</span> self.db.list_collection_names():</span><br><span class="line">                <span class="keyword">await</span> self.db.drop_collection(<span class="string">&quot;users&quot;</span>)</span><br><span class="line">                logger.info(<span class="string">&quot;ğŸ—‘ï¸  å·²åˆ é™¤ç°æœ‰é›†åˆ&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ›å»ºé›†åˆéªŒè¯å™¨</span></span><br><span class="line">            validator = &#123;</span><br><span class="line">                <span class="string">&quot;$jsonSchema&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;email&quot;</span>, <span class="string">&quot;created_at&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;username&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;ç”¨æˆ·åå¿…é¡»ä¸ºå­—ç¬¦ä¸²&quot;</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;email&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;pattern&quot;</span>: <span class="string">&quot;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]&#123;2,&#125;$&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&quot;</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;age&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;int&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;minimum&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="string">&quot;maximum&quot;</span>: <span class="number">120</span>,</span><br><span class="line">                            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;å¹´é¾„å¿…é¡»åœ¨0-120ä¹‹é—´&quot;</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;skills&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;array&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;items&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;created_at&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;date&quot;</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;updated_at&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;bsonType&quot;</span>: <span class="string">&quot;date&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ›å»ºé›†åˆ</span></span><br><span class="line">            <span class="keyword">await</span> self.db.create_collection(</span><br><span class="line">                <span class="string">&quot;users&quot;</span>,</span><br><span class="line">                validator=validator,</span><br><span class="line">                validationLevel=<span class="string">&quot;moderate&quot;</span>,</span><br><span class="line">                validationAction=<span class="string">&quot;error&quot;</span></span><br><span class="line">            )</span><br><span class="line">            logger.info(<span class="string">&quot;âœ… é›†åˆåˆ›å»ºæˆåŠŸ&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åˆ›å»ºç´¢å¼•</span></span><br><span class="line">            index_models = [</span><br><span class="line">                &#123;<span class="string">&quot;key&quot;</span>: &#123;<span class="string">&quot;username&quot;</span>: <span class="number">1</span>&#125;, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;username_1&quot;</span>, <span class="string">&quot;unique&quot;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;key&quot;</span>: &#123;<span class="string">&quot;email&quot;</span>: <span class="number">1</span>&#125;, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;email_1&quot;</span>, <span class="string">&quot;unique&quot;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;key&quot;</span>: &#123;<span class="string">&quot;age&quot;</span>: <span class="number">1</span>&#125;, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;age_1&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;key&quot;</span>: &#123;<span class="string">&quot;skills&quot;</span>: <span class="number">1</span>&#125;, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;skills_1&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;key&quot;</span>: &#123;<span class="string">&quot;created_at&quot;</span>: -<span class="number">1</span>&#125;, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;created_at_-1&quot;</span>&#125;,</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> index <span class="keyword">in</span> index_models:</span><br><span class="line">                <span class="keyword">await</span> self.collection.create_index(</span><br><span class="line">                    index[<span class="string">&quot;key&quot;</span>],</span><br><span class="line">                    unique=index.get(<span class="string">&quot;unique&quot;</span>, <span class="literal">False</span>),</span><br><span class="line">                    name=index[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">                )</span><br><span class="line">            </span><br><span class="line">            logger.info(<span class="string">&quot;âœ… ç´¢å¼•åˆ›å»ºæˆåŠŸ&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> OperationFailure <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;âŒ é›†åˆåˆ›å»ºå¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">bulk_insert_users</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ‰¹é‡æ’å…¥ç”¨æˆ·æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        users = [</span><br><span class="line">            User(<span class="string">&quot;zhangsan_py&quot;</span>, <span class="string">&quot;zhangsan_py@example.com&quot;</span>, <span class="number">28</span>, [<span class="string">&quot;Python&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>, <span class="string">&quot;Django&quot;</span>]).to_dict(),</span><br><span class="line">            User(<span class="string">&quot;lisi_py&quot;</span>, <span class="string">&quot;lisi_py@example.com&quot;</span>, <span class="number">32</span>, [<span class="string">&quot;Python&quot;</span>, <span class="string">&quot;FastAPI&quot;</span>, <span class="string">&quot;Redis&quot;</span>]).to_dict(),</span><br><span class="line">            User(<span class="string">&quot;wangwu_py&quot;</span>, <span class="string">&quot;wangwu_py@example.com&quot;</span>, <span class="number">25</span>, [<span class="string">&quot;Python&quot;</span>, <span class="string">&quot;Pandas&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>]).to_dict(),</span><br><span class="line">            User(<span class="string">&quot;zhaoliu_py&quot;</span>, <span class="string">&quot;zhaoliu_py@example.com&quot;</span>, <span class="number">35</span>, [<span class="string">&quot;Python&quot;</span>, <span class="string">&quot;TensorFlow&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>]).to_dict(),</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = <span class="keyword">await</span> self.collection.insert_many(users, ordered=<span class="literal">False</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;âœ… æ‰¹é‡æ’å…¥æˆåŠŸï¼Œæ’å…¥ <span class="subst">&#123;<span class="built_in">len</span>(result.inserted_ids)&#125;</span> æ¡è®°å½•&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> i, user_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(result.inserted_ids):</span><br><span class="line">                logger.info(<span class="string">f&quot;   - ç¬¬ <span class="subst">&#123;i+<span class="number">1</span>&#125;</span> æ¡: <span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> DuplicateKeyError <span class="keyword">as</span> e:</span><br><span class="line">            logger.warning(<span class="string">f&quot;âš ï¸  éƒ¨åˆ†è®°å½•é‡å¤: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> OperationFailure <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;âŒ æ‰¹é‡æ’å…¥å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">advanced_queries</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é«˜çº§æŸ¥è¯¢ç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">        logger.info(<span class="string">&quot;\nğŸ” é«˜çº§æŸ¥è¯¢ç¤ºä¾‹:&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. æŸ¥æ‰¾å¹´é¾„å¤§äº30çš„ç”¨æˆ·</span></span><br><span class="line">        filter_query = &#123;<span class="string">&quot;age&quot;</span>: &#123;<span class="string">&quot;$gt&quot;</span>: <span class="number">30</span>&#125;&#125;</span><br><span class="line">        projection = &#123;<span class="string">&quot;username&quot;</span>: <span class="number">1</span>, <span class="string">&quot;age&quot;</span>: <span class="number">1</span>, <span class="string">&quot;skills&quot;</span>: <span class="number">1</span>, <span class="string">&quot;_id&quot;</span>: <span class="number">0</span>&#125;</span><br><span class="line">        </span><br><span class="line">        cursor = self.collection.find(filter_query, projection)</span><br><span class="line">        users = <span class="keyword">await</span> cursor.to_list(length=<span class="number">100</span>)</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;1. å¹´é¾„ &gt; 30 çš„ç”¨æˆ·:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">            skills_str = <span class="string">&quot;, &quot;</span>.join(user[<span class="string">&quot;skills&quot;</span>])</span><br><span class="line">            logger.info(<span class="string">f&quot;   - <span class="subst">&#123;user[<span class="string">&#x27;username&#x27;</span>]&#125;</span> (<span class="subst">&#123;user[<span class="string">&#x27;age&#x27;</span>]&#125;</span>å²): <span class="subst">&#123;skills_str&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. èšåˆæŸ¥è¯¢ï¼šæŒ‰æŠ€èƒ½åˆ†ç»„ç»Ÿè®¡</span></span><br><span class="line">        pipeline = [</span><br><span class="line">            &#123;<span class="string">&quot;$unwind&quot;</span>: <span class="string">&quot;$skills&quot;</span>&#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;$group&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;$skills&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;count&quot;</span>: &#123;<span class="string">&quot;$sum&quot;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">                    <span class="string">&quot;avg_age&quot;</span>: &#123;<span class="string">&quot;$avg&quot;</span>: <span class="string">&quot;$age&quot;</span>&#125;,</span><br><span class="line">                    <span class="string">&quot;users&quot;</span>: &#123;<span class="string">&quot;$push&quot;</span>: <span class="string">&quot;$username&quot;</span>&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;<span class="string">&quot;$sort&quot;</span>: &#123;<span class="string">&quot;count&quot;</span>: -<span class="number">1</span>, <span class="string">&quot;avg_age&quot;</span>: <span class="number">1</span>&#125;&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;$limit&quot;</span>: <span class="number">5</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        cursor = self.collection.aggregate(pipeline)</span><br><span class="line">        results = <span class="keyword">await</span> cursor.to_list(length=<span class="number">100</span>)</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;\n2. æŠ€èƒ½ç»Ÿè®¡ï¼ˆèšåˆæŸ¥è¯¢ï¼‰:&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            users_str = <span class="string">&quot;, &quot;</span>.join(result[<span class="string">&quot;users&quot;</span>][:<span class="number">3</span>]) + (<span class="string">&quot;...&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(result[<span class="string">&quot;users&quot;</span>]) &gt; <span class="number">3</span> <span class="keyword">else</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;   - <span class="subst">&#123;result[<span class="string">&#x27;_id&#x27;</span>]&#125;</span>: <span class="subst">&#123;result[<span class="string">&#x27;count&#x27;</span>]&#125;</span>äºº, å¹³å‡å¹´é¾„: <span class="subst">&#123;result[<span class="string">&#x27;avg_age&#x27;</span>]:<span class="number">.1</span>f&#125;</span>å², ç”¨æˆ·: <span class="subst">&#123;users_str&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. æ–‡æœ¬æœç´¢ï¼ˆéœ€è¦å…ˆåˆ›å»ºæ–‡æœ¬ç´¢å¼•ï¼‰</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">await</span> self.collection.create_index([(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;text&quot;</span>), (<span class="string">&quot;skills&quot;</span>, <span class="string">&quot;text&quot;</span>)])</span><br><span class="line">            logger.info(<span class="string">&quot;\n3. æ–‡æœ¬æœç´¢ç¤ºä¾‹:&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            cursor = self.collection.find(</span><br><span class="line">                &#123;<span class="string">&quot;$text&quot;</span>: &#123;<span class="string">&quot;$search&quot;</span>: <span class="string">&quot;MongoDB&quot;</span>&#125;&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;score&quot;</span>: &#123;<span class="string">&quot;$meta&quot;</span>: <span class="string">&quot;textScore&quot;</span>&#125;&#125;</span><br><span class="line">            ).sort([(<span class="string">&quot;score&quot;</span>, &#123;<span class="string">&quot;$meta&quot;</span>: <span class="string">&quot;textScore&quot;</span>&#125;)])</span><br><span class="line">            </span><br><span class="line">            results = <span class="keyword">await</span> cursor.to_list(length=<span class="number">10</span>)</span><br><span class="line">            <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">                logger.info(<span class="string">f&quot;   - <span class="subst">&#123;result[<span class="string">&#x27;username&#x27;</span>]&#125;</span>, æŠ€èƒ½: <span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(result[<span class="string">&#x27;skills&#x27;</span>])&#125;</span>, ç›¸å…³åº¦: <span class="subst">&#123;result[<span class="string">&#x27;score&#x27;</span>]:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> OperationFailure <span class="keyword">as</span> e:</span><br><span class="line">            logger.warning(<span class="string">f&quot;âš ï¸  æ–‡æœ¬æœç´¢å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">transaction_example</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;äº‹åŠ¡æ“ä½œç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">        logger.info(<span class="string">&quot;\nğŸ”„ äº‹åŠ¡æ“ä½œç¤ºä¾‹:&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> <span class="keyword">await</span> self.client.start_session() <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.start_transaction(</span><br><span class="line">                read_concern=&#123;<span class="string">&quot;level&quot;</span>: <span class="string">&quot;majority&quot;</span>&#125;,</span><br><span class="line">                write_concern=&#123;<span class="string">&quot;w&quot;</span>: <span class="string">&quot;majority&quot;</span>, <span class="string">&quot;j&quot;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">                read_preference=ReadPreference.PRIMARY</span><br><span class="line">            ):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="comment"># æ’å…¥æ–°ç”¨æˆ·</span></span><br><span class="line">                    new_user = User(</span><br><span class="line">                        username=<span class="string">f&quot;tx_user_<span class="subst">&#123;<span class="built_in">int</span>(datetime.utcnow().timestamp())&#125;</span>&quot;</span>,</span><br><span class="line">                        email=<span class="string">f&quot;tx_<span class="subst">&#123;<span class="built_in">int</span>(datetime.utcnow().timestamp())&#125;</span>@example.com&quot;</span>,</span><br><span class="line">                        age=<span class="number">30</span>,</span><br><span class="line">                        skills=[<span class="string">&quot;Transaction&quot;</span>, <span class="string">&quot;Python&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>]</span><br><span class="line">                    ).to_dict()</span><br><span class="line">                    </span><br><span class="line">                    result = <span class="keyword">await</span> self.collection.insert_one(new_user, session=session)</span><br><span class="line">                    logger.info(<span class="string">f&quot;âœ… äº‹åŠ¡: æ’å…¥ç”¨æˆ·æˆåŠŸ, ID: <span class="subst">&#123;result.inserted_id&#125;</span>&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># æ›´æ–°ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">                    analytics_coll = self.db.get_collection(<span class="string">&quot;analytics&quot;</span>)</span><br><span class="line">                    update_result = <span class="keyword">await</span> analytics_coll.update_one(</span><br><span class="line">                        &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;user_count&quot;</span>&#125;,</span><br><span class="line">                        &#123;<span class="string">&quot;$inc&quot;</span>: &#123;<span class="string">&quot;count&quot;</span>: <span class="number">1</span>&#125;&#125;,</span><br><span class="line">                        upsert=<span class="literal">True</span>,</span><br><span class="line">                        session=session</span><br><span class="line">                    )</span><br><span class="line">                    logger.info(<span class="string">f&quot;âœ… äº‹åŠ¡: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ, ä¿®æ”¹: <span class="subst">&#123;update_result.modified_count&#125;</span>, æ–°å¢: <span class="subst">&#123;update_result.upserted_id&#125;</span>&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># æäº¤äº‹åŠ¡</span></span><br><span class="line">                    <span class="keyword">await</span> session.commit_transaction()</span><br><span class="line">                    logger.info(<span class="string">&quot;âœ… äº‹åŠ¡æäº¤æˆåŠŸ&quot;</span>)</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="comment"># å›æ»šäº‹åŠ¡</span></span><br><span class="line">                    <span class="keyword">await</span> session.abort_transaction()</span><br><span class="line">                    logger.error(<span class="string">f&quot;âŒ äº‹åŠ¡å¤±è´¥ï¼Œå·²å›æ»š: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">async_operations</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¼‚æ­¥æ“ä½œç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">        logger.info(<span class="string">&quot;\nâš¡ å¼‚æ­¥æ“ä½œç¤ºä¾‹:&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. å¹¶å‘æ’å…¥</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">insert_user</span>(<span class="params">index: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">            user = User(</span><br><span class="line">                username=<span class="string">f&quot;async_user_<span class="subst">&#123;index&#125;</span>&quot;</span>,</span><br><span class="line">                email=<span class="string">f&quot;async_<span class="subst">&#123;index&#125;</span>@example.com&quot;</span>,</span><br><span class="line">                age=<span class="number">20</span> + index % <span class="number">40</span>,</span><br><span class="line">                skills=[<span class="string">&quot;Async&quot;</span>, <span class="string">&quot;Python&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>]</span><br><span class="line">            ).to_dict()</span><br><span class="line">            result = <span class="keyword">await</span> self.collection.insert_one(user)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">str</span>(result.inserted_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä½¿ç”¨asyncio.gatherå¹¶å‘æ‰§è¡Œ</span></span><br><span class="line">        start_time = datetime.utcnow()</span><br><span class="line">        tasks = [insert_user(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>)]</span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        successful_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> r <span class="keyword">in</span> results <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(r, Exception))</span><br><span class="line">        error_count = <span class="built_in">len</span>(results) - successful_count</span><br><span class="line">        </span><br><span class="line">        duration = (datetime.utcnow() - start_time).total_seconds()</span><br><span class="line">        logger.info(<span class="string">f&quot;âœ… å¹¶å‘æ’å…¥ 100 æ¡è®°å½•ï¼ŒæˆåŠŸ: <span class="subst">&#123;successful_count&#125;</span>, å¤±è´¥: <span class="subst">&#123;error_count&#125;</span>, è€—æ—¶: <span class="subst">&#123;duration:<span class="number">.3</span>f&#125;</span>ç§’&quot;</span>)</span><br><span class="line">        logger.info(<span class="string">f&quot;   ååé‡: <span class="subst">&#123;successful_count/duration:<span class="number">.2</span>f&#125;</span> æ¡/ç§’&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. å¼‚æ­¥ç›‘æ§</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">monitor_collection</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                count = <span class="keyword">await</span> self.collection.count_documents(&#123;&#125;)</span><br><span class="line">                logger.info(<span class="string">f&quot;ğŸ“Š å½“å‰ç”¨æˆ·æ•°é‡: <span class="subst">&#123;count&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">5</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¯åŠ¨ç›‘æ§ä»»åŠ¡</span></span><br><span class="line">        monitor_task = asyncio.create_task(monitor_collection())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ¨¡æ‹ŸæŒç»­æ“ä½œ</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">10</span>)</span><br><span class="line">        monitor_task.cancel()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">performance_test</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ€§èƒ½æµ‹è¯•&quot;&quot;&quot;</span></span><br><span class="line">        logger.info(<span class="string">&quot;\nğŸ“ˆ æ€§èƒ½æµ‹è¯•:&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å‡†å¤‡10,000æ¡æµ‹è¯•æ•°æ®</span></span><br><span class="line">        bulk_data = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">            bulk_data.append(&#123;</span><br><span class="line">                <span class="string">&quot;username&quot;</span>: <span class="string">f&quot;perf_user_<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>&quot;</span>,</span><br><span class="line">                <span class="string">&quot;email&quot;</span>: <span class="string">f&quot;perf_<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>@example.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;age&quot;</span>: <span class="number">18</span> + i % <span class="number">43</span>,</span><br><span class="line">                <span class="string">&quot;skills&quot;</span>: [<span class="string">&quot;Performance&quot;</span>, <span class="string">&quot;MongoDB&quot;</span>, <span class="string">&quot;Python&quot;</span>],</span><br><span class="line">                <span class="string">&quot;created_at&quot;</span>: datetime.utcnow(),</span><br><span class="line">                <span class="string">&quot;updated_at&quot;</span>: datetime.utcnow()</span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æµ‹è¯•æ‰¹é‡æ’å…¥æ€§èƒ½</span></span><br><span class="line">        start_time = datetime.utcnow()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = <span class="keyword">await</span> self.collection.insert_many(bulk_data, ordered=<span class="literal">False</span>)</span><br><span class="line">            duration = (datetime.utcnow() - start_time).total_seconds()</span><br><span class="line">            logger.info(<span class="string">f&quot;âœ… æ’å…¥ 10,000 æ¡è®°å½•ï¼Œè€—æ—¶: <span class="subst">&#123;duration:<span class="number">.3</span>f&#125;</span>ç§’&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;   ååé‡: <span class="subst">&#123;<span class="number">10000</span>/duration:<span class="number">.2</span>f&#125;</span> æ¡/ç§’&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;   æ’å…¥æ•°é‡: <span class="subst">&#123;<span class="built_in">len</span>(result.inserted_ids)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æµ‹è¯•æŸ¥è¯¢æ€§èƒ½</span></span><br><span class="line">        start_time = datetime.utcnow()</span><br><span class="line">        count = <span class="keyword">await</span> self.collection.count_documents(&#123;<span class="string">&quot;age&quot;</span>: &#123;<span class="string">&quot;$gt&quot;</span>: <span class="number">30</span>&#125;&#125;)</span><br><span class="line">        duration = (datetime.utcnow() - start_time).total_seconds()</span><br><span class="line">        logger.info(<span class="string">f&quot;âœ… æŸ¥è¯¢å¹´é¾„&gt;30çš„ç”¨æˆ·ï¼Œæ•°é‡: <span class="subst">&#123;count&#125;</span>, è€—æ—¶: <span class="subst">&#123;duration:<span class="number">.6</span>f&#125;</span>ç§’&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">run_example</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¿è¡Œå®Œæ•´ç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.info(<span class="string">&quot;ğŸš€ å¼€å§‹ MongoDB Python 3.11 å¼‚æ­¥æ“ä½œç¤ºä¾‹&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;=====================================&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">await</span> self.connect()</span><br><span class="line">            <span class="keyword">await</span> self.create_collection()</span><br><span class="line">            <span class="keyword">await</span> self.bulk_insert_users()</span><br><span class="line">            <span class="keyword">await</span> self.advanced_queries()</span><br><span class="line">            <span class="keyword">await</span> self.transaction_example()</span><br><span class="line">            <span class="keyword">await</span> self.performance_test()</span><br><span class="line">            <span class="keyword">await</span> self.async_operations()</span><br><span class="line">            </span><br><span class="line">            logger.info(<span class="string">&quot;\nğŸ‰ æ‰€æœ‰æ“ä½œå®Œæˆï¼&quot;</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.exception(<span class="string">f&quot;âŒ ç¨‹åºå¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="keyword">await</span> self.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä¸»å‡½æ•°&quot;&quot;&quot;</span></span><br><span class="line">    example = MongoDBExample()</span><br><span class="line">    <span class="keyword">await</span> example.run_example()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure><hr><h2 id="ä¸ƒã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹-âš ï¸"><a href="#ä¸ƒã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹-âš ï¸" class="headerlink" title="ä¸ƒã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹ âš ï¸"></a>ä¸ƒã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹ âš ï¸</h2><h3 id="7-1-å®‰å…¨åŠ å›ºæ¸…å•"><a href="#7-1-å®‰å…¨åŠ å›ºæ¸…å•" class="headerlink" title="7.1 å®‰å…¨åŠ å›ºæ¸…å•"></a>7.1 å®‰å…¨åŠ å›ºæ¸…å•</h3><p><strong>ç½‘ç»œå±‚å®‰å…¨</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é˜²ç«å¢™é…ç½®ï¼ˆä»…å…è®¸åº”ç”¨æœåŠ¡å™¨è®¿é—®ï¼‰</span></span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 27017 -s 192.168.1.0/24 -j ACCEPT</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 27017 -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨VPC/VNetéš”ç¦»</span></span><br><span class="line"><span class="comment"># äº‘ç¯å¢ƒï¼šé…ç½®å®‰å…¨ç»„ï¼Œä»…å…è®¸ç‰¹å®šIPè®¿é—®</span></span><br></pre></td></tr></table></figure><p><strong>è®¤è¯ä¸æˆæƒ</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºæœ€å°æƒé™ç”¨æˆ·</span></span><br><span class="line">use myapp</span><br><span class="line">db.<span class="title function_">createUser</span>(&#123;</span><br><span class="line">  <span class="attr">user</span>: <span class="string">&quot;readonly_user&quot;</span>,</span><br><span class="line">  <span class="attr">pwd</span>: <span class="string">&quot;ReadOnlyPass123!&quot;</span>,</span><br><span class="line">  <span class="attr">roles</span>: [</span><br><span class="line">    &#123; <span class="attr">role</span>: <span class="string">&quot;read&quot;</span>, <span class="attr">db</span>: <span class="string">&quot;myapp&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">role</span>: <span class="string">&quot;read&quot;</span>, <span class="attr">db</span>: <span class="string">&quot;analytics&quot;</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åº”ç”¨ç”¨æˆ·</span></span><br><span class="line">db.<span class="title function_">createUser</span>(&#123;</span><br><span class="line">  <span class="attr">user</span>: <span class="string">&quot;app_user&quot;</span>,</span><br><span class="line">  <span class="attr">pwd</span>: <span class="string">&quot;AppUserPass123!&quot;</span>,</span><br><span class="line">  <span class="attr">roles</span>: [</span><br><span class="line">    &#123; <span class="attr">role</span>: <span class="string">&quot;readWrite&quot;</span>, <span class="attr">db</span>: <span class="string">&quot;myapp&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">role</span>: <span class="string">&quot;read&quot;</span>, <span class="attr">db</span>: <span class="string">&quot;reference_data&quot;</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æ§ç”¨æˆ·</span></span><br><span class="line">db.<span class="title function_">createUser</span>(&#123;</span><br><span class="line">  <span class="attr">user</span>: <span class="string">&quot;monitor_user&quot;</span>,</span><br><span class="line">  <span class="attr">pwd</span>: <span class="string">&quot;MonitorPass123!&quot;</span>,</span><br><span class="line">  <span class="attr">roles</span>: [</span><br><span class="line">    &#123; <span class="attr">role</span>: <span class="string">&quot;clusterMonitor&quot;</span>, <span class="attr">db</span>: <span class="string">&quot;admin&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">role</span>: <span class="string">&quot;read&quot;</span>, <span class="attr">db</span>: <span class="string">&quot;local&quot;</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>åŠ å¯†ä¼ è¾“</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TLS/SSLé…ç½®æ£€æŸ¥</span></span><br><span class="line">mongosh --tls --tlsCAFile /etc/ssl/ca.pem \</span><br><span class="line">  --<span class="built_in">eval</span> <span class="string">&quot;db.serverStatus().security&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯å¼ºåˆ¶TLS</span></span><br><span class="line">mongodb://user:pass@host:27017/db?tls=<span class="literal">true</span>&amp;tlsCAFile=/path/to/ca.pem</span><br></pre></td></tr></table></figure><h3 id="7-2-å¤‡ä»½ä¸æ¢å¤ç­–ç•¥"><a href="#7-2-å¤‡ä»½ä¸æ¢å¤ç­–ç•¥" class="headerlink" title="7.2 å¤‡ä»½ä¸æ¢å¤ç­–ç•¥"></a>7.2 å¤‡ä»½ä¸æ¢å¤ç­–ç•¥</h3><p><strong>å®Œæ•´å¤‡ä»½æ–¹æ¡ˆ</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># MongoDBå¤‡ä»½è„šæœ¬ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰</span></span><br><span class="line"></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backup/mongodb&quot;</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line">RETENTION_DAYS=7</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¤‡ä»½ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$&#123;BACKUP_DIR&#125;</span>/<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. é€»è¾‘å¤‡ä»½ï¼ˆmongodumpï¼‰</span></span><br><span class="line">mongodump --uri=<span class="string">&quot;mongodb://backup_user:BackupPass123!@192.168.1.101:27017,192.168.1.102:27017,192.168.1.103:27017/?replicaSet=prod-rs0&quot;</span> \</span><br><span class="line">  --gzip \</span><br><span class="line">  --archive=<span class="variable">$&#123;BACKUP_DIR&#125;</span>/<span class="variable">$&#123;DATE&#125;</span>/full_backup.gz \</span><br><span class="line">  --oplog</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é…ç½®æ–‡ä»¶å¤‡ä»½</span></span><br><span class="line"><span class="built_in">cp</span> /etc/mongod.conf <span class="variable">$&#123;BACKUP_DIR&#125;</span>/<span class="variable">$&#123;DATE&#125;</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è®¡ç®—å¤‡ä»½å¤§å°</span></span><br><span class="line">BACKUP_SIZE=$(<span class="built_in">du</span> -sh <span class="variable">$&#123;BACKUP_DIR&#125;</span>/<span class="variable">$&#123;DATE&#125;</span> | <span class="built_in">cut</span> -f1)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;âœ… å¤‡ä»½å®Œæˆï¼Œå¤§å°: <span class="variable">$&#123;BACKUP_SIZE&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æ¸…ç†æ—§å¤‡ä»½</span></span><br><span class="line">find <span class="variable">$&#123;BACKUP_DIR&#125;</span> -maxdepth 1 -<span class="built_in">type</span> d -mtime +<span class="variable">$&#123;RETENTION_DAYS&#125;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> -rf &#123;&#125; \;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨</span></span><br><span class="line">aws s3 <span class="built_in">cp</span> <span class="variable">$&#123;BACKUP_DIR&#125;</span>/<span class="variable">$&#123;DATE&#125;</span> s3://mongodb-backups/prod/<span class="variable">$&#123;DATE&#125;</span>/ --recursive</span><br></pre></td></tr></table></figure><p><strong>æ¢å¤æµç¨‹</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. åœæ­¢åº”ç”¨</span></span><br><span class="line">sudo systemctl stop myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ¢å¤æ•°æ®</span></span><br><span class="line">mongorestore --uri=<span class="string">&quot;mongodb://admin:AdminPass123!@localhost:27017&quot;</span> \</span><br><span class="line">  --gzip \</span><br><span class="line">  --archive=/backup/mongodb/20260121_120000/full_backup.gz \</span><br><span class="line">  --oplogReplay \</span><br><span class="line">  --drop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. éªŒè¯æ•°æ®</span></span><br><span class="line">mongosh -u admin -p AdminPass123! --<span class="built_in">eval</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">  db.getSiblingDB(&#x27;myapp&#x27;).users.countDocuments();</span></span><br><span class="line"><span class="string">  db.getSiblingDB(&#x27;myapp&#x27;).users.findOne();</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. é‡å¯åº”ç”¨</span></span><br><span class="line">sudo systemctl start myapp</span><br></pre></td></tr></table></figure><h3 id="7-3-ç›‘æ§ä¸å‘Šè­¦ä½“ç³»"><a href="#7-3-ç›‘æ§ä¸å‘Šè­¦ä½“ç³»" class="headerlink" title="7.3 ç›‘æ§ä¸å‘Šè­¦ä½“ç³»"></a>7.3 ç›‘æ§ä¸å‘Šè­¦ä½“ç³»</h3><p><strong>ç›‘æ§æŒ‡æ ‡æ¸…å•</strong>ï¼š</p><table><thead><tr><th>æŒ‡æ ‡ç±»åˆ«</th><th>å…³é”®æŒ‡æ ‡</th><th>å‘Šè­¦é˜ˆå€¼</th><th>é‡‡é›†æ–¹å¼</th></tr></thead><tbody><tr><td><strong>è¿æ¥</strong></td><td>connections.current</td><td>&gt;80% max connections</td><td>serverStatus</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>opcounters.*</td><td>çªå¢50%</td><td>serverStatus</td></tr><tr><td><strong>å¤åˆ¶</strong></td><td>replication.lag</td><td>&gt;30ç§’</td><td>replSetGetStatus</td></tr><tr><td><strong>å­˜å‚¨</strong></td><td>wiredTiger.cache.*</td><td>ä½¿ç”¨ç‡&gt;90%</td><td>serverStatus</td></tr><tr><td><strong>æ“ä½œ</strong></td><td>globalLock.currentQueue</td><td>&gt;10</td><td>serverStatus</td></tr><tr><td><strong>èµ„æº</strong></td><td>CPU&#x2F;Memory&#x2F;Disk</td><td>CPU&gt;80%, å†…å­˜&gt;90%</td><td>ç³»ç»Ÿç›‘æ§</td></tr></tbody></table><p><strong>Prometheus + Grafana é…ç½®</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus.yml</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;mongodb&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.1.101:9216&#x27;</span>, <span class="string">&#x27;192.168.1.102:9216&#x27;</span>, <span class="string">&#x27;192.168.1.103:9216&#x27;</span>]</span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.*):.*</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1</span></span><br></pre></td></tr></table></figure><p><strong>MongoDB Exporter å¯åŠ¨</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name mongodb_exporter \</span><br><span class="line">  -p 9216:9216 \</span><br><span class="line">  -e MONGODB_URI=<span class="string">&quot;mongodb://monitor_user:MonitorPass123!@192.168.1.101:27017,192.168.1.102:27017,192.168.1.103:27017/?replicaSet=prod-rs0&quot;</span> \</span><br><span class="line">  -e MONGODB_COLLECT_DATABASE_STATUS=<span class="literal">true</span> \</span><br><span class="line">  -e MONGODB_COLLECT_COLLECTION_STATUS=<span class="literal">true</span> \</span><br><span class="line">  -e MONGODB_COLLECT_TOP_METRICS=<span class="literal">true</span> \</span><br><span class="line">  -e MONGODB_COLLECT_INDEX_USAGE=<span class="literal">true</span> \</span><br><span class="line">  --restart unless-stopped \</span><br><span class="line">  percona/mongodb_exporter:0.30</span><br></pre></td></tr></table></figure><h3 id="7-4-æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹"><a href="#7-4-æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹" class="headerlink" title="7.4 æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹"></a>7.4 æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹</h3><p><strong>ç´¢å¼•ä¼˜åŒ–åŸåˆ™</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. é¿å…è¿‡åº¦ç´¢å¼•ï¼ˆæ¯ä¸ªç´¢å¼•å¢åŠ å†™å…¥å¼€é”€ï¼‰</span></span><br><span class="line">db.<span class="property">collection</span>.<span class="title function_">getIndexes</span>().<span class="title function_">forEach</span>(printjson)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. å¤åˆç´¢å¼•é¡ºåºï¼šç­‰å€¼æŸ¥è¯¢å­—æ®µ -&gt; æ’åºå­—æ®µ -&gt; èŒƒå›´æŸ¥è¯¢å­—æ®µ</span></span><br><span class="line"><span class="comment">// å¥½ï¼š&#123; status: 1, created_at: -1, user_id: 1 &#125;</span></span><br><span class="line"><span class="comment">// å·®ï¼š&#123; user_id: 1, status: 1, created_at: -1 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è¦†ç›–ç´¢å¼•æŸ¥è¯¢</span></span><br><span class="line">db.<span class="property">orders</span>.<span class="title function_">find</span>(</span><br><span class="line">  &#123; <span class="attr">status</span>: <span class="string">&quot;completed&quot;</span>, <span class="attr">created_at</span>: &#123; <span class="attr">$gt</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2026-01-01&quot;</span>) &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">_id</span>: <span class="number">0</span>, <span class="attr">order_id</span>: <span class="number">1</span>, <span class="attr">amount</span>: <span class="number">1</span> &#125;</span><br><span class="line">).<span class="title function_">hint</span>(&#123; <span class="attr">status</span>: <span class="number">1</span>, <span class="attr">created_at</span>: -<span class="number">1</span>, <span class="attr">amount</span>: <span class="number">1</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. æ–‡æœ¬ç´¢å¼•ä¼˜åŒ–</span></span><br><span class="line">db.<span class="property">products</span>.<span class="title function_">createIndex</span>(</span><br><span class="line">  &#123; <span class="attr">product_name</span>: <span class="string">&quot;text&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;text&quot;</span> &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">weights</span>: &#123; <span class="attr">product_name</span>: <span class="number">10</span>, <span class="attr">description</span>: <span class="number">5</span> &#125;,</span><br><span class="line">    <span class="attr">default_language</span>: <span class="string">&quot;english&quot;</span>,</span><br><span class="line">    <span class="attr">language_override</span>: <span class="string">&quot;language&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. é¿å…$oræ“ä½œç¬¦ï¼Œæ”¹ç”¨$in</span></span><br><span class="line"><span class="comment">// å·®ï¼š&#123; $or: [&#123; status: &quot;active&quot; &#125;, &#123; status: &quot;pending&quot; &#125;] &#125;</span></span><br><span class="line"><span class="comment">// å¥½ï¼š&#123; status: &#123; $in: [&quot;active&quot;, &quot;pending&quot;] &#125; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. é™åˆ¶è¿”å›å­—æ®µ</span></span><br><span class="line">db.<span class="property">users</span>.<span class="title function_">find</span>(</span><br><span class="line">  &#123; <span class="attr">age</span>: &#123; <span class="attr">$gt</span>: <span class="number">30</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">username</span>: <span class="number">1</span>, <span class="attr">email</span>: <span class="number">1</span>, <span class="attr">_id</span>: <span class="number">0</span> &#125;</span><br><span class="line">).<span class="title function_">limit</span>(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ä½¿ç”¨$projectå’Œ$matchåœ¨èšåˆç®¡é“ä¸­å°½æ—©è¿‡æ»¤</span></span><br><span class="line">db.<span class="property">orders</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  &#123; <span class="attr">$match</span>: &#123; <span class="attr">created_at</span>: &#123; <span class="attr">$gt</span>: <span class="title class_">ISODate</span>(<span class="string">&quot;2026-01-01&quot;</span>) &#125; &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">$lookup</span>: &#123; <span class="attr">from</span>: <span class="string">&quot;users&quot;</span>, <span class="attr">localField</span>: <span class="string">&quot;user_id&quot;</span>, <span class="attr">foreignField</span>: <span class="string">&quot;_id&quot;</span>, <span class="attr">as</span>: <span class="string">&quot;user&quot;</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">$unwind</span>: <span class="string">&quot;$user&quot;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">$project</span>: &#123; <span class="attr">total</span>: <span class="number">1</span>, user.<span class="property">username</span>: <span class="number">1</span>, user.<span class="property">email</span>: <span class="number">1</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">$sort</span>: &#123; <span class="attr">total</span>: -<span class="number">1</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">$limit</span>: <span class="number">100</span> &#125;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. é¿å…å…¨é›†åˆæ‰«æ</span></span><br><span class="line">db.<span class="property">collection</span>.<span class="title function_">explain</span>(<span class="string">&quot;executionStats&quot;</span>).<span class="title function_">find</span>(&#123; <span class="attr">non_indexed_field</span>: <span class="string">&quot;value&quot;</span> &#125;)</span><br></pre></td></tr></table></figure><p><strong>ç¡¬ä»¶ä¼˜åŒ–å»ºè®®</strong>ï¼š</p><table><thead><tr><th>èµ„æºç±»å‹</th><th>å¼€å‘ç¯å¢ƒ</th><th>ç”Ÿäº§ç¯å¢ƒï¼ˆå°ï¼‰</th><th>ç”Ÿäº§ç¯å¢ƒï¼ˆä¸­ï¼‰</th><th>ç”Ÿäº§ç¯å¢ƒï¼ˆå¤§ï¼‰</th></tr></thead><tbody><tr><td><strong>CPU</strong></td><td>2æ ¸</td><td>4-8æ ¸</td><td>16-32æ ¸</td><td>32-64æ ¸</td></tr><tr><td><strong>å†…å­˜</strong></td><td>4GB</td><td>16GB</td><td>64GB</td><td>128GB+</td></tr><tr><td><strong>ç£ç›˜</strong></td><td>50GB HDD</td><td>500GB SSD</td><td>2TB NVMe</td><td>10TB+ NVMe</td></tr><tr><td><strong>IOPS</strong></td><td>100</td><td>3000</td><td>10000</td><td>50000+</td></tr><tr><td><strong>ç½‘ç»œ</strong></td><td>1Gbps</td><td>1Gbps</td><td>10Gbps</td><td>25Gbps+</td></tr></tbody></table><hr><h2 id="å…«ã€å¸¸è§é—®é¢˜æ’æŸ¥ä¸è§£å†³æ–¹æ¡ˆ"><a href="#å…«ã€å¸¸è§é—®é¢˜æ’æŸ¥ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å…«ã€å¸¸è§é—®é¢˜æ’æŸ¥ä¸è§£å†³æ–¹æ¡ˆ"></a>å…«ã€å¸¸è§é—®é¢˜æ’æŸ¥ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id="8-1-è¿æ¥é—®é¢˜æ’æŸ¥"><a href="#8-1-è¿æ¥é—®é¢˜æ’æŸ¥" class="headerlink" title="8.1 è¿æ¥é—®é¢˜æ’æŸ¥"></a>8.1 è¿æ¥é—®é¢˜æ’æŸ¥</h3><p><strong>ç—‡çŠ¶</strong>ï¼šåº”ç”¨æ— æ³•è¿æ¥MongoDB</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span><br><span class="line">sudo systemctl status mongod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ£€æŸ¥ç«¯å£ç›‘å¬</span></span><br><span class="line">sudo netstat -tuln | grep 27017</span><br><span class="line"><span class="comment"># æ­£å¸¸è¾“å‡ºï¼štcp 0 0 192.168.1.101:27017 0.0.0.0:* LISTEN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æ£€æŸ¥é˜²ç«å¢™</span></span><br><span class="line">sudo iptables -L -n | grep 27017</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æ£€æŸ¥ç»‘å®šIPé…ç½®</span></span><br><span class="line">grep bindIp /etc/mongod.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. æµ‹è¯•æœ¬åœ°è¿æ¥</span></span><br><span class="line">mongosh --<span class="built_in">eval</span> <span class="string">&quot;db.ping()&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. æµ‹è¯•è¿œç¨‹è¿æ¥</span></span><br><span class="line">telnet 192.168.1.101 27017</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li>ä¿®æ”¹<code>bindIp</code>ä¸ºå…·ä½“IPæˆ–<code>0.0.0.0</code>ï¼ˆé…åˆé˜²ç«å¢™ï¼‰</li><li>æ£€æŸ¥SELinux&#x2F;AppArmoré™åˆ¶</li><li>äº‘ç¯å¢ƒæ£€æŸ¥å®‰å…¨ç»„è§„åˆ™</li></ul><h3 id="8-2-å¤åˆ¶é›†é—®é¢˜æ’æŸ¥"><a href="#8-2-å¤åˆ¶é›†é—®é¢˜æ’æŸ¥" class="headerlink" title="8.2 å¤åˆ¶é›†é—®é¢˜æ’æŸ¥"></a>8.2 å¤åˆ¶é›†é—®é¢˜æ’æŸ¥</h3><p><strong>ç—‡çŠ¶</strong>ï¼šå‰¯æœ¬é›†çŠ¶æ€å¼‚å¸¸</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. æ£€æŸ¥å‰¯æœ¬é›†çŠ¶æ€</span></span><br><span class="line">rs.<span class="title function_">status</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ</span></span><br><span class="line">rs.<span class="title function_">printSecondaryReplicationInfo</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ£€æŸ¥oplogçª—å£</span></span><br><span class="line">rs.<span class="title function_">printReplicationInfo</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. æ£€æŸ¥ç½‘ç»œè¿æ¥</span></span><br><span class="line">db.<span class="title function_">adminCommand</span>(&#123; <span class="attr">replSetGetStatus</span>: <span class="number">1</span> &#125;).<span class="property">members</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">member</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">print</span>(member.<span class="property">name</span> + <span class="string">&quot;: &quot;</span> + member.<span class="property">health</span> + <span class="string">&quot;, &quot;</span> + member.<span class="property">stateStr</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. å¼ºåˆ¶é‡æ–°é…ç½®ï¼ˆè°¨æ…ä½¿ç”¨ï¼âš ï¸ï¼‰</span></span><br><span class="line">cfg = rs.<span class="title function_">conf</span>()</span><br><span class="line">cfg.<span class="property">members</span>[<span class="number">0</span>].<span class="property">priority</span> = <span class="number">3</span></span><br><span class="line">rs.<span class="title function_">reconfig</span>(cfg, &#123; <span class="attr">force</span>: <span class="literal">true</span> &#125;)</span><br></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜</strong>ï¼š</p><ul><li><strong>ç½‘ç»œåˆ†åŒº</strong>ï¼šç¡®ä¿èŠ‚ç‚¹é—´ç½‘ç»œå»¶è¿Ÿ&lt;10ms</li><li><strong>oplogä¸è¶³</strong>ï¼šå¢å¤§oplogSizeMB</li><li><strong>æ—¶é’Ÿä¸åŒæ­¥</strong>ï¼šé…ç½®NTPæœåŠ¡</li><li><strong>ç£ç›˜ç©ºé—´ä¸è¶³</strong>ï¼šç›‘æ§ç£ç›˜ä½¿ç”¨ç‡</li></ul><h3 id="8-3-æ€§èƒ½é—®é¢˜æ’æŸ¥-amp-è·Ÿè¸ªå¸¸ç”¨æ–¹æ³•"><a href="#8-3-æ€§èƒ½é—®é¢˜æ’æŸ¥-amp-è·Ÿè¸ªå¸¸ç”¨æ–¹æ³•" class="headerlink" title="8.3 æ€§èƒ½é—®é¢˜æ’æŸ¥&amp;è·Ÿè¸ªå¸¸ç”¨æ–¹æ³•"></a>8.3 æ€§èƒ½é—®é¢˜æ’æŸ¥&amp;è·Ÿè¸ªå¸¸ç”¨æ–¹æ³•</h3><p><strong>ç—‡çŠ¶</strong>ï¼šæŸ¥è¯¢å˜æ…¢ï¼ŒCPUä½¿ç”¨ç‡é«˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. æ£€æŸ¥å½“å‰æ“ä½œ</span></span><br><span class="line">db.<span class="title function_">currentOp</span>(&#123; <span class="attr">secs_running</span>: &#123; <span class="attr">$gt</span>: <span class="number">1</span> &#125; &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. æ£€æŸ¥é”çŠ¶æ€</span></span><br><span class="line">db.<span class="title function_">serverStatus</span>().<span class="property">globalLock</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—</span></span><br><span class="line">db.<span class="title function_">setProfilingLevel</span>(<span class="number">1</span>, &#123; <span class="attr">slowms</span>: <span class="number">50</span> &#125;)  <span class="comment">// è®°å½•&gt;50msçš„æŸ¥è¯¢</span></span><br><span class="line">db.<span class="property">system</span>.<span class="property">profile</span>.<span class="title function_">find</span>().<span class="title function_">sort</span>(&#123; <span class="attr">ts</span>: -<span class="number">1</span> &#125;).<span class="title function_">limit</span>(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨</span></span><br><span class="line">db.<span class="property">collection</span>.<span class="title function_">explain</span>(<span class="string">&quot;executionStats&quot;</span>).<span class="title function_">find</span>(&#123; query &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. æ£€æŸ¥å†…å­˜ä½¿ç”¨</span></span><br><span class="line">db.<span class="title function_">serverStatus</span>().<span class="property">wiredTiger</span>.<span class="property">cache</span></span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŒ–æ­¥éª¤</strong>ï¼š</p><ol><li>è¯†åˆ«æ…¢æŸ¥è¯¢</li><li>åˆ†ææ‰§è¡Œè®¡åˆ’</li><li>æ·»åŠ &#x2F;ä¼˜åŒ–ç´¢å¼•</li><li>é‡æ„æŸ¥è¯¢é€»è¾‘</li><li>è€ƒè™‘åˆ†ç‰‡æ‰©å±•</li></ol><hr><h2 id="ä¹ã€å°ç»“æœªæ¥é¢„ä¼°æ–¹å‘"><a href="#ä¹ã€å°ç»“æœªæ¥é¢„ä¼°æ–¹å‘" class="headerlink" title="ä¹ã€å°ç»“æœªæ¥é¢„ä¼°æ–¹å‘"></a>ä¹ã€å°ç»“æœªæ¥é¢„ä¼°æ–¹å‘</h2><h3 id="9-1-æŠ€æœ¯é€‰å‹å»ºè®®"><a href="#9-1-æŠ€æœ¯é€‰å‹å»ºè®®" class="headerlink" title="9.1 æŠ€æœ¯é€‰å‹å»ºè®®"></a>9.1 æŠ€æœ¯é€‰å‹å»ºè®®</h3><p><strong>MongoDBé€‚ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>âœ… çµæ´»æ¨¡å¼éœ€æ±‚ï¼ˆå¿«é€Ÿè¿­ä»£çš„äº§å“ï¼‰</li><li>âœ… é«˜å†™å…¥è´Ÿè½½ï¼ˆIoTã€å®æ—¶åˆ†æï¼‰</li><li>âœ… å±‚æ¬¡åŒ–æ•°æ®ï¼ˆåµŒå¥—æ–‡æ¡£ç»“æ„ï¼‰</li><li>âœ… å…¨çƒåˆ†å¸ƒå¼éƒ¨ç½²ï¼ˆå¤šåŒºåŸŸå‰¯æœ¬é›†ï¼‰</li><li>âœ… JSONåŸç”Ÿåº”ç”¨ï¼ˆWeb APIã€ç§»åŠ¨åç«¯ï¼‰</li></ul><p><strong>æ…ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>âŒ å¼ºäº‹åŠ¡éœ€æ±‚ï¼ˆé“¶è¡Œæ ¸å¿ƒç³»ç»Ÿï¼‰</li><li>âŒ å¤æ‚JOINæŸ¥è¯¢ï¼ˆä¼ ç»ŸERPç³»ç»Ÿï¼‰</li><li>âŒ ä¸¥æ ¼ACIDè¦æ±‚ï¼ˆè´¢åŠ¡è®°è´¦ï¼‰</li><li>âŒ è¶…ä½å»¶è¿Ÿè¦æ±‚ï¼ˆHFTé«˜é¢‘äº¤æ˜“ï¼‰</li></ul><h3 id="9-2-2026å¹´æŠ€æœ¯è¶‹åŠ¿"><a href="#9-2-2026å¹´æŠ€æœ¯è¶‹åŠ¿" class="headerlink" title="9.2 2026å¹´æŠ€æœ¯è¶‹åŠ¿"></a>9.2 2026å¹´æŠ€æœ¯è¶‹åŠ¿</h3><p><strong>MongoDBå‘å±•æ–¹å‘</strong>ï¼š</p><ol><li><strong>AI&#x2F;MLé›†æˆ</strong>ï¼šå‘é‡æœç´¢æˆä¸ºæ ‡é…ï¼Œå†…ç½®MLæ¨¡å‹éƒ¨ç½²</li><li><strong>Serverlessæ¼”è¿›</strong>ï¼šAtlas Serverlessæˆä¸ºä¸»æµéƒ¨ç½²æ¨¡å¼</li><li><strong>å¤šäº‘æ”¯æŒ</strong>ï¼šæ— ç¼è·¨äº‘æ•°æ®åŒæ­¥ï¼Œç»Ÿä¸€ç®¡ç†ç•Œé¢</li><li><strong>å®æ—¶åˆ†æ</strong>ï¼šå¢å¼ºæ—¶åºæ•°æ®å¤„ç†èƒ½åŠ›ï¼Œä¸æµå¤„ç†å¹³å°æ·±åº¦é›†æˆ</li><li><strong>å®‰å…¨å¢å¼º</strong>ï¼šé›¶ä¿¡ä»»æ¶æ„ï¼Œç»†ç²’åº¦æ•°æ®è®¿é—®æ§åˆ¶</li></ol><h3 id="9-3-æ¨èå®˜æ–¹èµ„æ–™"><a href="#9-3-æ¨èå®˜æ–¹èµ„æ–™" class="headerlink" title="9.3 æ¨èå®˜æ–¹èµ„æ–™"></a>9.3 æ¨èå®˜æ–¹èµ„æ–™</h3><p><strong>å®˜æ–¹æ–‡æ¡£</strong>ï¼š</p><ul><li><a href="https://www.mongodb.com/docs/v7.0/">MongoDB 7.0 Documentation</a></li><li><a href="https://www.mongodb.com/docs/atlas/">MongoDB Atlas Guides</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;hr&gt;
&lt;h2 id=&quot;ä¸€ã€MongoDBæ ¸å¿ƒåŸç†ä¸æ•°æ®ç»“æ„æ·±åº¦è§£æ&quot;&gt;&lt;a href=&quot;#ä¸€ã€MongoDBæ ¸å¿ƒåŸç†ä¸æ•°æ®ç»“æ„æ·±åº¦è§£æ&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€MongoDBæ ¸å¿ƒåŸç†ä¸æ•°æ®ç»“æ„æ·±åº¦è§£æ&quot;&gt;&lt;/a&gt;ä¸€ã€MongoDBæ ¸å¿ƒåŸç†ä¸æ•°æ®ç»“æ„æ·±åº¦è§£æ&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡æ¶‰åŠDemoä»£ç ç¤ºä¾‹ä»¥å¸¸ç”¨Debian 12 LTSç‰ˆç³»ç»Ÿç¯å¢ƒä¸ºä¾‹ï¼Œæ­¤ä¹Ÿæ˜¯ä¸ªäººå¸¸ç”¨å¼€å‘æµ‹è¯•ç³»ç»Ÿç‰ˆæœ¬ï¼Œæ¨èï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨ç‰ˆæœ¬&lt;/strong&gt;ï¼šMongoDB 7.0 LTS (æœ€æ–°ç¨³å®šç‰ˆ)&lt;br&gt;&lt;strong&gt;æ“ä½œç³»ç»Ÿ&lt;/strong&gt;ï¼šDebian 12 (Bookworm) &lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="nosql" scheme="https://www.wdft.com/categories/nosql/"/>
    
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="MongoDB" scheme="https://www.wdft.com/tags/MongoDB/"/>
    
    <category term="nosql" scheme="https://www.wdft.com/tags/nosql/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript ES5åˆ°ES16ç‰ˆæœ¬æ¼”è¿›å‡æ€ï¼šè¯­æ³•ç‰¹æ€§å·®å¼‚å¯¹æ¯”è¯¦è§£ï¼ˆå«å®Œæ•´å‘å¸ƒæ—¶é—´çº¿æ¢³ç†ï¼‰</title>
    <link href="https://www.wdft.com/5e9a274.html"/>
    <id>https://www.wdft.com/5e9a274.html</id>
    <published>2025-12-30T15:17:39.000Z</published>
    <updated>2026-01-24T16:50:42.134Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="æ ‡å‡†è§„èŒƒECMAScriptå¯¹JavaScriptçš„å½±å“"><a href="#æ ‡å‡†è§„èŒƒECMAScriptå¯¹JavaScriptçš„å½±å“" class="headerlink" title="æ ‡å‡†è§„èŒƒECMAScriptå¯¹JavaScriptçš„å½±å“"></a>æ ‡å‡†è§„èŒƒECMAScriptå¯¹JavaScriptçš„å½±å“</h2><p>JavaScriptä½œä¸ºWebå¼€å‘çš„æ ¸å¿ƒè¯­è¨€ï¼Œå…¶æ ‡å‡†è§„èŒƒECMAScriptï¼ˆç®€ç§°ESï¼‰è‡ª1997å¹´è¯ç”Ÿä»¥æ¥æŒç»­æ¼”è¿›ã€‚ä»ES5åˆ°æœ€æ–°çš„ES16ï¼Œæ¯ä¸ªç‰ˆæœ¬éƒ½å¸¦æ¥äº†é©å‘½æ€§çš„å˜åŒ–ï¼Œé‡å¡‘äº†ç°ä»£å‰ç«¯å¼€å‘çš„é¢è²Œã€‚æœ¬æ–‡å°†ç³»ç»Ÿæ¢³ç†è¿™äº›ç‰ˆæœ¬é—´çš„å®Œæ•´æ¼”è¿›å†ç¨‹ï¼ŒåŒ…å«ç²¾ç¡®çš„å‘å¸ƒæ—¶é—´ã€æ ¸å¿ƒç‰¹æ€§åŠæ³¨æ„äº‹é¡¹ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå…¨é¢æŒæ¡JavaScriptçš„ç°ä»£åŒ–å‘å±•è„‰ç»œã€‚</p><span id="more"></span><p>åœ¨ä¸åŒç¼–ç¨‹è¯­è¨€ä¹‹é—´ç›¸äº’å€Ÿé‰´çš„ä»Šå¤©ï¼ŒJavaScriptä¾ç„¶ç”Ÿå‘½åŠ›é¡½å¼ºï¼Œè¿™æ˜¯å…¶è¯­è¨€é­…åŠ›å’Œç”Ÿäº§åŠ›çš„ç»“åˆã€‚</p><h2 id="ä¸€ã€ES5ï¼ˆ2009å¹´12æœˆï¼‰ï¼šç°ä»£JavaScriptçš„åŸºçŸ³"><a href="#ä¸€ã€ES5ï¼ˆ2009å¹´12æœˆï¼‰ï¼šç°ä»£JavaScriptçš„åŸºçŸ³" class="headerlink" title="ä¸€ã€ES5ï¼ˆ2009å¹´12æœˆï¼‰ï¼šç°ä»£JavaScriptçš„åŸºçŸ³"></a>ä¸€ã€ES5ï¼ˆ2009å¹´12æœˆï¼‰ï¼šç°ä»£JavaScriptçš„åŸºçŸ³</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2009å¹´12æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><strong>ä¸¥æ ¼æ¨¡å¼</strong>ï¼šé€šè¿‡<code>&#39;use strict&#39;</code>å¼€å¯ï¼Œä½¿ä»£ç åœ¨æ‰§è¡Œæ—¶å¯¹é”™è¯¯æ›´åŠ æ•æ„Ÿï¼Œæé«˜ä»£ç çš„å®‰å…¨æ€§å’Œæ•ˆç‡</li><li><strong>æ•°ç»„æ–¹æ³•å¢å¼º</strong>ï¼š<code>Array.prototype.forEach()</code>, <code>map()</code>, <code>filter()</code>, <code>reduce()</code>, <code>every()</code>, <code>some()</code></li><li><strong>å¯¹è±¡æ–¹æ³•</strong>ï¼š<code>Object.create()</code>, <code>Object.defineProperty()</code>, <code>Object.keys()</code></li><li><strong>JSONæ”¯æŒ</strong>ï¼šåŸç”Ÿ<code>JSON.parse()</code>å’Œ<code>JSON.stringify()</code></li><li><strong>å‡½æ•°ç»‘å®š</strong>ï¼š<code>Function.prototype.bind()</code></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES5ä¸¥æ ¼æ¨¡å¼ç¤ºä¾‹</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">value</span>: <span class="string">&#x27;ES5&#x27;</span>,</span><br><span class="line">  <span class="attr">writable</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">var</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> doubled = numbers.<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">num</span>) &#123; <span class="keyword">return</span> num * <span class="number">2</span>; &#125;); <span class="comment">// [2, 4, 6]</span></span><br></pre></td></tr></table></figure><h3 id="æ³¨æ„äº‹é¡¹ï¼š"><a href="#æ³¨æ„äº‹é¡¹ï¼š" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li>ä¸¥æ ¼æ¨¡å¼éœ€è¦æ”¾åœ¨å‡½æ•°æˆ–è„šæœ¬çš„é¡¶éƒ¨æ‰èƒ½ç”Ÿæ•ˆ</li><li><code>Object.defineProperty()</code>åœ¨IE8åŠä»¥ä¸‹ç‰ˆæœ¬å­˜åœ¨å…¼å®¹æ€§é—®é¢˜</li></ul><h2 id="äºŒã€ES6-x2F-ES2015ï¼ˆ2015å¹´6æœˆï¼‰ï¼šé©å‘½æ€§æ›´æ–°"><a href="#äºŒã€ES6-x2F-ES2015ï¼ˆ2015å¹´6æœˆï¼‰ï¼šé©å‘½æ€§æ›´æ–°" class="headerlink" title="äºŒã€ES6&#x2F;ES2015ï¼ˆ2015å¹´6æœˆï¼‰ï¼šé©å‘½æ€§æ›´æ–°"></a>äºŒã€ES6&#x2F;ES2015ï¼ˆ2015å¹´6æœˆï¼‰ï¼šé©å‘½æ€§æ›´æ–°</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2015å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-1"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-1" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><h4 id="1-å—çº§ä½œç”¨åŸŸ"><a href="#1-å—çº§ä½œç”¨åŸŸ" class="headerlink" title="1. å—çº§ä½œç”¨åŸŸ"></a>1. å—çº§ä½œç”¨åŸŸ</h4><ul><li>**<code>let</code>å’Œ<code>const</code>**ï¼šè§£å†³å˜é‡æå‡é—®é¢˜ï¼Œ<code>let</code>å£°æ˜çš„å˜é‡ä»…åœ¨å…¶å®šä¹‰çš„å—å†…æœ‰æ•ˆï¼Œé¿å…äº†å…¨å±€æ±¡æŸ“<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES5 vs ES6 å˜é‡å£°æ˜</span></span><br><span class="line"><span class="keyword">var</span> x = <span class="number">10</span>; <span class="comment">// å‡½æ•°ä½œç”¨åŸŸ</span></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> y = <span class="number">20</span>; <span class="comment">// å—çº§ä½œç”¨åŸŸ</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">PI</span> = <span class="number">3.14</span>; <span class="comment">// å¸¸é‡</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(y); <span class="comment">// ReferenceError: y is not defined</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="2-ç®­å¤´å‡½æ•°"><a href="#2-ç®­å¤´å‡½æ•°" class="headerlink" title="2. ç®­å¤´å‡½æ•°"></a>2. ç®­å¤´å‡½æ•°</h4><ul><li>æ›´ç®€æ´çš„è¯­æ³•ï¼Œè‡ªåŠ¨ç»‘å®š<code>this</code>ä¸Šä¸‹æ–‡<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES6</span></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">value</span>: <span class="number">42</span>,</span><br><span class="line">  <span class="attr">getValue</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">value</span>); <span class="comment">// 42 (thisæŒ‡å‘obj)</span></span><br><span class="line">    &#125;, <span class="number">100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-ç±»ï¼ˆClassï¼‰"><a href="#3-ç±»ï¼ˆClassï¼‰" class="headerlink" title="3. ç±»ï¼ˆClassï¼‰"></a>3. ç±»ï¼ˆClassï¼‰</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES6</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">greet</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hello, <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>!`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-Promise"><a href="#4-Promise" class="headerlink" title="4. Promise"></a>4. Promise</h4><p>è§£å†³å›è°ƒåœ°ç‹±é—®é¢˜ï¼Œæä¾›æ›´ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES6 (Promise)</span></span><br><span class="line"><span class="title function_">getData</span>()</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">a</span> =&gt;</span> <span class="title function_">getMoreData</span>(a))</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">b</span> =&gt;</span> <span class="title function_">getMoreData</span>(b))</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">c</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;done&#x27;</span>))</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(err));</span><br></pre></td></tr></table></figure><h4 id="5-æ¨¡å—åŒ–"><a href="#5-æ¨¡å—åŒ–" class="headerlink" title="5. æ¨¡å—åŒ–"></a>5. æ¨¡å—åŒ–</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES6 æ¨¡å—</span></span><br><span class="line"><span class="comment">// math.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">a, b</span>) &#123; <span class="keyword">return</span> a + b; &#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">PI</span> = <span class="number">3.14159</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; add, <span class="variable constant_">PI</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./math.js&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">2</span>, <span class="number">3</span>), <span class="variable constant_">PI</span>);</span><br></pre></td></tr></table></figure><h4 id="6-å…¶ä»–é‡è¦ç‰¹æ€§"><a href="#6-å…¶ä»–é‡è¦ç‰¹æ€§" class="headerlink" title="6. å…¶ä»–é‡è¦ç‰¹æ€§"></a>6. å…¶ä»–é‡è¦ç‰¹æ€§</h4><ul><li><strong>æ¨¡æ¿å­—ç¬¦ä¸²</strong>ï¼š<code>`Hello, $&#123;name&#125;!`</code></li><li><strong>è§£æ„èµ‹å€¼</strong>ï¼š<code>const &#123; name, age &#125; = &#123; name: &#39;Alice&#39;, age: 25 &#125;;</code></li><li><strong>é»˜è®¤å‚æ•°</strong>ï¼š<code>function greet(name = &#39;World&#39;) &#123; ... &#125;</code></li><li><strong>å‰©ä½™å‚æ•°</strong>ï¼š<code>function sum(...numbers) &#123; ... &#125;</code></li><li><strong>å±•å¼€è¿ç®—ç¬¦</strong>ï¼š<code>const arr = [1, ...[2, 3], 4];</code></li><li><strong>Symbol</strong>ï¼šå”¯ä¸€æ ‡è¯†ç¬¦</li><li><strong>Map&#x2F;Set</strong>ï¼šæ–°çš„æ•°æ®ç»“æ„</li><li><strong>Proxy&#x2F;Reflect</strong>ï¼šå…ƒç¼–ç¨‹èƒ½åŠ›</li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-1"><a href="#æ³¨æ„äº‹é¡¹ï¼š-1" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li>ES6å¼•å…¥äº†å¤§é‡çš„æ–°è¯­æ³•ï¼Œéœ€è¦Babelç­‰è½¬è¯‘å·¥å…·åœ¨æ—§ç¯å¢ƒä¸­è¿è¡Œ</li><li>ç®­å¤´å‡½æ•°æ²¡æœ‰è‡ªå·±çš„<code>this</code>ã€<code>arguments</code>ã€<code>super</code>æˆ–<code>new.target</code></li><li>ç±»è¯­æ³•æ˜¯è¯­æ³•ç³–ï¼Œåº•å±‚ä»ç„¶æ˜¯åŸºäºåŸå‹çš„ç»§æ‰¿</li></ul><h2 id="ä¸‰ã€ES2016-ES7-ï¼ˆ2016å¹´6æœˆï¼‰ï¼šå¢é‡æ›´æ–°"><a href="#ä¸‰ã€ES2016-ES7-ï¼ˆ2016å¹´6æœˆï¼‰ï¼šå¢é‡æ›´æ–°" class="headerlink" title="ä¸‰ã€ES2016 (ES7)ï¼ˆ2016å¹´6æœˆï¼‰ï¼šå¢é‡æ›´æ–°"></a>ä¸‰ã€ES2016 (ES7)ï¼ˆ2016å¹´6æœˆï¼‰ï¼šå¢é‡æ›´æ–°</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2016å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-2"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-2" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><p>**<code>Array.prototype.includes()</code>**ï¼šæ£€æŸ¥æ•°ç»„æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr.<span class="title function_">includes</span>(<span class="number">2</span>)); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr.<span class="title function_">includes</span>(<span class="number">4</span>)); <span class="comment">// false</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æŒ‡æ•°è¿ç®—ç¬¦</strong>ï¼š<code>**</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span> ** <span class="number">3</span>); <span class="comment">// 8 (ç­‰åŒäº Math.pow(2, 3))</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-2"><a href="#æ³¨æ„äº‹é¡¹ï¼š-2" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li>è¿™æ˜¯è‡ª2015å¹´æ”¹ä¸ºå¹´åº¦å‘å¸ƒèŠ‚å¥åçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œç‰¹æ€§ç›¸å¯¹è¾ƒå°‘</li><li><code>includes()</code>æ–¹æ³•å¯¹NaNçš„å¤„ç†ä¸<code>indexOf()</code>ä¸åŒï¼Œèƒ½æ­£ç¡®è¯†åˆ«NaN</li></ul><h2 id="å››ã€ES2017-ES8-ï¼ˆ2017å¹´6æœˆï¼‰ï¼šå¼‚æ­¥ç¼–ç¨‹å¢å¼º"><a href="#å››ã€ES2017-ES8-ï¼ˆ2017å¹´6æœˆï¼‰ï¼šå¼‚æ­¥ç¼–ç¨‹å¢å¼º" class="headerlink" title="å››ã€ES2017 (ES8)ï¼ˆ2017å¹´6æœˆï¼‰ï¼šå¼‚æ­¥ç¼–ç¨‹å¢å¼º"></a>å››ã€ES2017 (ES8)ï¼ˆ2017å¹´6æœˆï¼‰ï¼šå¼‚æ­¥ç¼–ç¨‹å¢å¼º</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2017å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-3"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-3" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><p>**<code>async/await</code>**ï¼šæ›´ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹è¯­æ³•ç³–ï¼ŒåŸºäºPromise</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES2017</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.example.com/data&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong><code>Object.values()</code> å’Œ <code>Object.entries()</code></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: <span class="number">3</span> &#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">values</span>(obj)); <span class="comment">// [1, 2, 3]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">entries</span>(obj)); <span class="comment">// [[&#x27;a&#x27;, 1], [&#x27;b&#x27;, 2], [&#x27;c&#x27;, 3]]</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å­—ç¬¦ä¸²å¡«å……</strong>ï¼š<code>padStart()</code> å’Œ <code>padEnd()</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span>.<span class="title function_">padStart</span>(<span class="number">10</span>, <span class="string">&#x27; &#x27;</span>)); <span class="comment">// &#x27;     hello&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span>.<span class="title function_">padEnd</span>(<span class="number">10</span>, <span class="string">&#x27;!&#x27;</span>));   <span class="comment">// &#x27;hello!!!!!&#x27;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-3"><a href="#æ³¨æ„äº‹é¡¹ï¼š-3" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li><code>async/await</code>å‡½æ•°æ€»æ˜¯è¿”å›Promiseï¼Œå³ä½¿å‡½æ•°ä½“å†…æ²¡æœ‰æ˜¾å¼è¿”å›Promise</li><li><code>Object.entries()</code>è¿”å›çš„æ•°ç»„é¡ºåºä¸<code>for...in</code>å¾ªç¯ç›¸åŒï¼Œä½†ä¸åŒ…å«åŸå‹é“¾ä¸Šçš„å±æ€§</li></ul><h2 id="äº”ã€ES2018-ES9-ï¼ˆ2018å¹´6æœˆï¼‰ï¼šå¯¹è±¡å’Œæ­£åˆ™å¢å¼º"><a href="#äº”ã€ES2018-ES9-ï¼ˆ2018å¹´6æœˆï¼‰ï¼šå¯¹è±¡å’Œæ­£åˆ™å¢å¼º" class="headerlink" title="äº”ã€ES2018 (ES9)ï¼ˆ2018å¹´6æœˆï¼‰ï¼šå¯¹è±¡å’Œæ­£åˆ™å¢å¼º"></a>äº”ã€ES2018 (ES9)ï¼ˆ2018å¹´6æœˆï¼‰ï¼šå¯¹è±¡å’Œæ­£åˆ™å¢å¼º</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2018å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-4"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-4" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><p><strong>å¯¹è±¡å±•å¼€è¿ç®—ç¬¦</strong> å’Œ <strong>å‰©ä½™å±æ€§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å±•å¼€è¿ç®—ç¬¦</span></span><br><span class="line"><span class="keyword">const</span> obj1 = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> obj2 = &#123; ...obj1, <span class="attr">c</span>: <span class="number">3</span> &#125;; <span class="comment">// &#123; a: 1, b: 2, c: 3 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‰©ä½™å±æ€§</span></span><br><span class="line"><span class="keyword">const</span> &#123; a, ...rest &#125; = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: <span class="number">3</span> &#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(rest); <span class="comment">// &#123; b: 2, c: 3 &#125;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æ­£åˆ™è¡¨è¾¾å¼å¢å¼º</strong>ï¼š</p><ul><li><strong>å‘½åæ•è·ç»„</strong>ï¼š<code>/(?&lt;year&gt;\d&#123;4&#125;)-(?&lt;month&gt;\d&#123;2&#125;)-(?&lt;day&gt;\d&#123;2&#125;)/</code></li><li><strong>dotAllæ¨¡å¼</strong>ï¼š<code>/foo.bar/s</code>ï¼ˆ<code>.</code>åŒ¹é…åŒ…æ‹¬æ¢è¡Œç¬¦åœ¨å†…çš„æ‰€æœ‰å­—ç¬¦ï¼‰</li><li><strong>Unicodeå±æ€§è½¬ä¹‰</strong>ï¼š<code>/\p&#123;Script=Greek&#125;/u</code></li><li><strong>åè¡Œæ–­è¨€</strong>ï¼š<code>/(?&lt;=\$)\d+/</code>ï¼ˆåŒ¹é…å‰é¢æœ‰$ç¬¦å·çš„æ•°å­—ï¼‰</li></ul></li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-4"><a href="#æ³¨æ„äº‹é¡¹ï¼š-4" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li>å¯¹è±¡å±•å¼€è¿ç®—ç¬¦æ‰§è¡Œæµ…æ‹·è´ï¼ŒåµŒå¥—å¯¹è±¡ä¸ä¼šè¢«æ·±æ‹·è´</li><li>å‘½åæ•è·ç»„éœ€è¦è¾ƒæ–°çš„æµè§ˆå™¨æ”¯æŒï¼Œæ—§ç¯å¢ƒéœ€è¦polyfill</li></ul><h2 id="å…­ã€ES2019-ES10-ï¼ˆ2019å¹´6æœˆï¼‰ï¼šæ•°ç»„å’Œå¯¹è±¡ä¼˜åŒ–"><a href="#å…­ã€ES2019-ES10-ï¼ˆ2019å¹´6æœˆï¼‰ï¼šæ•°ç»„å’Œå¯¹è±¡ä¼˜åŒ–" class="headerlink" title="å…­ã€ES2019 (ES10)ï¼ˆ2019å¹´6æœˆï¼‰ï¼šæ•°ç»„å’Œå¯¹è±¡ä¼˜åŒ–"></a>å…­ã€ES2019 (ES10)ï¼ˆ2019å¹´6æœˆï¼‰ï¼šæ•°ç»„å’Œå¯¹è±¡ä¼˜åŒ–</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2019å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-5"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-5" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><p><strong><code>Array.prototype.flat()</code> å’Œ <code>flatMap()</code></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, [<span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>]]];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr.<span class="title function_">flat</span>()); <span class="comment">// [1, 2, [3, 4]]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr.<span class="title function_">flat</span>(<span class="number">2</span>)); <span class="comment">// [1, 2, 3, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numbers.<span class="title function_">flatMap</span>(<span class="function"><span class="params">x</span> =&gt;</span> [x * <span class="number">2</span>])); <span class="comment">// [2, 4, 6]</span></span><br></pre></td></tr></table></figure></li><li><p>**<code>Object.fromEntries()</code>**ï¼šå°†é”®å€¼å¯¹åˆ—è¡¨è½¬æ¢ä¸ºå¯¹è±¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> entries = [[<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>], [<span class="string">&#x27;b&#x27;</span>, <span class="number">2</span>]];</span><br><span class="line"><span class="keyword">const</span> obj = <span class="title class_">Object</span>.<span class="title function_">fromEntries</span>(entries); <span class="comment">// &#123; a: 1, b: 2 &#125;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å­—ç¬¦ä¸²ä¿®å‰ª</strong>ï¼š<code>trimStart()</code> å’Œ <code>trimEnd()</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;  hello  &#x27;</span>.<span class="title function_">trimStart</span>()); <span class="comment">// &#x27;hello  &#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;  hello  &#x27;</span>.<span class="title function_">trimEnd</span>());   <span class="comment">// &#x27;  hello&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p><strong><code>catch</code>ç»‘å®šå¯é€‰</strong>ï¼š<code>try &#123; ... &#125; catch &#123; ... &#125;</code>ï¼ˆä¸éœ€è¦ç»‘å®šé”™è¯¯å˜é‡ï¼‰</p></li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-5"><a href="#æ³¨æ„äº‹é¡¹ï¼š-5" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li><code>flat()</code>æ–¹æ³•é»˜è®¤æ·±åº¦ä¸º1ï¼Œéœ€è¦æŒ‡å®šæ·±åº¦å‚æ•°æ‰èƒ½å±•å¹³æ·±å±‚åµŒå¥—</li><li><code>trimStart()</code>å’Œ<code>trimLeft()</code>ã€<code>trimEnd()</code>å’Œ<code>trimRight()</code>æ˜¯åˆ«åå…³ç³»ï¼Œä½†æ¨èä½¿ç”¨æ ‡å‡†åç§°</li></ul><h2 id="ä¸ƒã€ES2020-ES11-ï¼ˆ2020å¹´6æœˆï¼‰ï¼šç°ä»£ç¼–ç¨‹å¢å¼º"><a href="#ä¸ƒã€ES2020-ES11-ï¼ˆ2020å¹´6æœˆï¼‰ï¼šç°ä»£ç¼–ç¨‹å¢å¼º" class="headerlink" title="ä¸ƒã€ES2020 (ES11)ï¼ˆ2020å¹´6æœˆï¼‰ï¼šç°ä»£ç¼–ç¨‹å¢å¼º"></a>ä¸ƒã€ES2020 (ES11)ï¼ˆ2020å¹´6æœˆï¼‰ï¼šç°ä»£ç¼–ç¨‹å¢å¼º</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2020å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-6"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-6" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><p><strong>å¯é€‰é“¾æ“ä½œç¬¦</strong>ï¼š<code>?.</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123; <span class="attr">profile</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;Alice&#x27;</span> &#125; &#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user?.<span class="property">profile</span>?.<span class="property">name</span>); <span class="comment">// &#x27;Alice&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user?.<span class="property">address</span>?.<span class="property">city</span>); <span class="comment">// undefined (ä¸æŠ›å‡ºé”™è¯¯)</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ç©ºå€¼åˆå¹¶æ“ä½œç¬¦</strong>ï¼š<code>??</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = <span class="number">0</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(value ?? <span class="string">&#x27;default&#x27;</span>); <span class="comment">// 0 (0æ˜¯æœ‰æ•ˆå€¼)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">null</span> ?? <span class="string">&#x27;default&#x27;</span>); <span class="comment">// &#x27;default&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>BigInt</strong>ï¼šæ”¯æŒä»»æ„ç²¾åº¦æ•´æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bigNum = <span class="number">9007199254740991n</span>; <span class="comment">// æ³¨æ„æœ«å°¾çš„n</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bigNum + <span class="number">1n</span>); <span class="comment">// 9007199254740992n</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åŠ¨æ€å¯¼å…¥</strong>ï¼š<code>import()</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŠ¨æ€å¯¼å…¥ï¼Œè¿”å›Promise</span></span><br><span class="line">button.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="keyword">await</span> <span class="title function_">import</span>(<span class="string">&#x27;./module.js&#x27;</span>);</span><br><span class="line">  <span class="variable language_">module</span>.<span class="title function_">default</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>**Promise.allSettled()**ï¼šç­‰å¾…æ‰€æœ‰Promiseå®Œæˆï¼Œæ— è®ºæˆåŠŸæˆ–å¤±è´¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">allSettled</span>(promises).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// å¤„ç†æ‰€æœ‰ç»“æœ</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p><strong>å…¨å±€å¯¹è±¡</strong>ï¼š<code>globalThis</code>ï¼ˆç»Ÿä¸€çš„å…¨å±€å¯¹è±¡å¼•ç”¨ï¼‰</p></li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-6"><a href="#æ³¨æ„äº‹é¡¹ï¼š-6" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li>å¯é€‰é“¾æ“ä½œç¬¦åœ¨å·¦ä¾§å€¼ä¸º<code>null</code>æˆ–<code>undefined</code>æ—¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œè€Œæ˜¯è¿”å›<code>undefined</code></li><li><code>??</code>æ“ä½œç¬¦ä¸<code>||</code>ä¸åŒï¼Œåªåœ¨å·¦ä¾§å€¼ä¸º<code>null</code>æˆ–<code>undefined</code>æ—¶æ‰ä½¿ç”¨å³ä¾§å€¼</li><li>BigIntä¸èƒ½ä¸Numberç±»å‹ç›´æ¥æ··åˆè¿ç®—ï¼Œéœ€è¦æ˜¾å¼è½¬æ¢</li></ul><h2 id="å…«ã€ES2021-ES12-ï¼ˆ2021å¹´6æœˆï¼‰ï¼šé€»è¾‘èµ‹å€¼å’Œæ•°å­—åˆ†éš”ç¬¦"><a href="#å…«ã€ES2021-ES12-ï¼ˆ2021å¹´6æœˆï¼‰ï¼šé€»è¾‘èµ‹å€¼å’Œæ•°å­—åˆ†éš”ç¬¦" class="headerlink" title="å…«ã€ES2021 (ES12)ï¼ˆ2021å¹´6æœˆï¼‰ï¼šé€»è¾‘èµ‹å€¼å’Œæ•°å­—åˆ†éš”ç¬¦"></a>å…«ã€ES2021 (ES12)ï¼ˆ2021å¹´6æœˆï¼‰ï¼šé€»è¾‘èµ‹å€¼å’Œæ•°å­—åˆ†éš”ç¬¦</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2021å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-7"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-7" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><p><strong>é€»è¾‘èµ‹å€¼è¿ç®—ç¬¦</strong>ï¼š<code>&amp;&amp;=</code>, <code>||=</code>, <code>??=</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">0</span>;</span><br><span class="line">x ||= <span class="number">10</span>; <span class="comment">// x = x || 10 â†’ x = 10</span></span><br><span class="line">x &amp;&amp;= <span class="number">20</span>; <span class="comment">// x = x &amp;&amp; 20 â†’ x = 20</span></span><br><span class="line">x ??= <span class="number">30</span>; <span class="comment">// x = x ?? 30 â†’ x = 20 (å› ä¸ºxå·²æœ‰å€¼)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> y;</span><br><span class="line">y ??= <span class="number">40</span>; <span class="comment">// y = y ?? 40 â†’ y = 40</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æ•°å­—åˆ†éš”ç¬¦</strong>ï¼š<code>_</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> billion = <span class="number">1_000_000_000</span>;</span><br><span class="line"><span class="keyword">const</span> binary = <span class="number">0b1010_0001_1000_0101</span>;</span><br><span class="line"><span class="keyword">const</span> hex = <span class="number">0xA0_B0_C0</span>;</span><br></pre></td></tr></table></figure></li><li><p><strong><code>String.prototype.replaceAll()</code></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;hello world&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="title function_">replaceAll</span>(<span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;L&#x27;</span>)); <span class="comment">// &#x27;heLLo worLd&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>**Promise.any()**ï¼šè¿”å›ç¬¬ä¸€ä¸ªæˆåŠŸçš„Promise</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promises = [</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;error1&#x27;</span>),</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>),</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;error2&#x27;</span>)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">any</span>(promises).<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result); <span class="comment">// &#x27;success&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-7"><a href="#æ³¨æ„äº‹é¡¹ï¼š-7" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li>é€»è¾‘èµ‹å€¼è¿ç®—ç¬¦æ˜¯çŸ­è·¯è¿ç®—ï¼Œå³ä¾§è¡¨è¾¾å¼å¯èƒ½ä¸ä¼šæ‰§è¡Œ</li><li>æ•°å­—åˆ†éš”ç¬¦ä¸èƒ½æ”¾åœ¨æ•°å­—å¼€å¤´æˆ–ç»“å°¾ï¼Œä¹Ÿä¸èƒ½è¿ç»­ä½¿ç”¨</li><li><code>replaceAll()</code>ä¸<code>replace()</code>åœ¨å…¨å±€æ›¿æ¢æ—¶çš„è¡Œä¸ºä¸åŒï¼Œ<code>replaceAll()</code>æ›´ç›´è§‚</li></ul><h2 id="ä¹ã€ES2022-ES13-ï¼ˆ2022å¹´6æœˆï¼‰ï¼šç±»å­—æ®µå’Œç§æœ‰å±æ€§"><a href="#ä¹ã€ES2022-ES13-ï¼ˆ2022å¹´6æœˆï¼‰ï¼šç±»å­—æ®µå’Œç§æœ‰å±æ€§" class="headerlink" title="ä¹ã€ES2022 (ES13)ï¼ˆ2022å¹´6æœˆï¼‰ï¼šç±»å­—æ®µå’Œç§æœ‰å±æ€§"></a>ä¹ã€ES2022 (ES13)ï¼ˆ2022å¹´6æœˆï¼‰ï¼šç±»å­—æ®µå’Œç§æœ‰å±æ€§</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2022å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-8"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-8" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><p><strong>ç±»å­—æ®µå£°æ˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">  name = <span class="string">&#x27;Anonymous&#x27;</span>; <span class="comment">// å…¬æœ‰å­—æ®µ</span></span><br><span class="line">  #age = <span class="number">0</span>; <span class="comment">// ç§æœ‰å­—æ®µï¼ˆ#å¼€å¤´ï¼‰</span></span><br><span class="line">  </span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name, age</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.#age = age;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">getAge</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.#age; <span class="comment">// å¯ä»¥åœ¨ç±»å†…éƒ¨è®¿é—®ç§æœ‰å­—æ®µ</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>é™æ€ç±»å­—æ®µå’Œæ–¹æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MathUtils</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="variable constant_">PI</span> = <span class="number">3.14159</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">double</span>(<span class="params">n</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> n * <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong><code>at()</code> æ–¹æ³•</strong>ï¼šæ”¯æŒè´Ÿç´¢å¼•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr.<span class="title function_">at</span>(<span class="number">0</span>)); <span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr.<span class="title function_">at</span>(-<span class="number">1</span>)); <span class="comment">// 5 (æœ€åä¸€ä¸ªå…ƒç´ )</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(arr.<span class="title function_">at</span>(-<span class="number">2</span>)); <span class="comment">// 4 (å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ )</span></span><br></pre></td></tr></table></figure></li><li><p>**<code>Object.hasOwn()</code>**ï¼šæ›´å®‰å…¨çš„å±æ€§æ£€æŸ¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">prop</span>: <span class="string">&#x27;value&#x27;</span> &#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">hasOwn</span>(obj, <span class="string">&#x27;prop&#x27;</span>)); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">hasOwn</span>(obj, <span class="string">&#x27;toString&#x27;</span>)); <span class="comment">// false</span></span><br></pre></td></tr></table></figure></li><li><p><strong>é¡¶å±‚await</strong>ï¼šåœ¨æ¨¡å—é¡¶å±‚ä½¿ç”¨await</p></li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-8"><a href="#æ³¨æ„äº‹é¡¹ï¼š-8" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li>ç§æœ‰å­—æ®µä»¥<code>#</code>å¼€å¤´ï¼Œè¿™æ˜¯è¯­æ³•çº§åˆ«çš„ç§æœ‰æ€§ï¼Œä¸æ˜¯çº¦å®šä¿—æˆ</li><li><code>Object.hasOwn()</code>æ˜¯<code>Object.prototype.hasOwnProperty.call()</code>çš„å®‰å…¨æ›¿ä»£</li><li>é¡¶å±‚awaitåªèƒ½åœ¨ESæ¨¡å—ä¸­ä½¿ç”¨ï¼Œä¸èƒ½åœ¨è„šæœ¬ä¸­ä½¿ç”¨</li></ul><h2 id="åã€ES2023-ES14-ï¼ˆ2023å¹´6æœˆï¼‰ï¼šæ•°ç»„æŸ¥æ‰¾æ–¹æ³•å¢å¼º"><a href="#åã€ES2023-ES14-ï¼ˆ2023å¹´6æœˆï¼‰ï¼šæ•°ç»„æŸ¥æ‰¾æ–¹æ³•å¢å¼º" class="headerlink" title="åã€ES2023 (ES14)ï¼ˆ2023å¹´6æœˆï¼‰ï¼šæ•°ç»„æŸ¥æ‰¾æ–¹æ³•å¢å¼º"></a>åã€ES2023 (ES14)ï¼ˆ2023å¹´6æœˆï¼‰ï¼šæ•°ç»„æŸ¥æ‰¾æ–¹æ³•å¢å¼º</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2023å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-9"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-9" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><p><strong>æ•°ç»„æŸ¥æ‰¾æ–¹æ³•</strong>ï¼š<code>findLast()</code> å’Œ <code>findLastIndex()</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»å‰å¾€åæ‰¾</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numbers.<span class="title function_">find</span>(<span class="function"><span class="params">n</span> =&gt;</span> n &gt; <span class="number">3</span>)); <span class="comment">// 4</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numbers.<span class="title function_">findIndex</span>(<span class="function"><span class="params">n</span> =&gt;</span> n &gt; <span class="number">3</span>)); <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»åå¾€å‰æ‰¾</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numbers.<span class="title function_">findLast</span>(<span class="function"><span class="params">n</span> =&gt;</span> n &gt; <span class="number">3</span>)); <span class="comment">// 5</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(numbers.<span class="title function_">findLastIndex</span>(<span class="function"><span class="params">n</span> =&gt;</span> n &gt; <span class="number">3</span>)); <span class="comment">// 4</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å“ˆå¸Œç¢°æ’å¼ºåŒ–</strong>ï¼šæå‡å¯¹è±¡å±æ€§è®¿é—®çš„æ€§èƒ½å’Œå®‰å…¨æ€§</p></li><li><p><strong>Change Array by Copy</strong>ï¼š<code>toSorted()</code>, <code>toReversed()</code>, <code>toSpliced()</code>, <code>with()</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">const</span> sorted = arr.<span class="title function_">toSorted</span>(); <span class="comment">// [1, 2, 3] (åŸæ•°ç»„ä¸å˜)</span></span><br><span class="line"><span class="keyword">const</span> reversed = arr.<span class="title function_">toReversed</span>(); <span class="comment">// [2, 1, 3] (åŸæ•°ç»„ä¸å˜)</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-9"><a href="#æ³¨æ„äº‹é¡¹ï¼š-9" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li><code>findLast()</code>å’Œ<code>findLastIndex()</code>ä»æ•°ç»„æœ«å°¾å¼€å§‹æœç´¢ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹å°±è¿”å›</li><li>Change Array by Copyæ–¹æ³•éƒ½æ˜¯ä¸å¯å˜æ“ä½œï¼Œè¿”å›æ–°æ•°ç»„è€Œä¸ä¿®æ”¹åŸæ•°ç»„</li><li>è¿™äº›æ–¹æ³•åœ¨TypeScript 5.0+ä¸­è·å¾—å®Œæ•´æ”¯æŒ</li></ul><h2 id="åä¸€ã€ES2024-ES15-ï¼ˆ2024å¹´6æœˆï¼‰ï¼šæ•°ç»„åˆ†ç»„é©å‘½"><a href="#åä¸€ã€ES2024-ES15-ï¼ˆ2024å¹´6æœˆï¼‰ï¼šæ•°ç»„åˆ†ç»„é©å‘½" class="headerlink" title="åä¸€ã€ES2024 (ES15)ï¼ˆ2024å¹´6æœˆï¼‰ï¼šæ•°ç»„åˆ†ç»„é©å‘½"></a>åä¸€ã€ES2024 (ES15)ï¼ˆ2024å¹´6æœˆï¼‰ï¼šæ•°ç»„åˆ†ç»„é©å‘½</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2024å¹´6æœˆ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-10"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-10" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><ul><li><p><strong>æ•°ç»„åˆ†ç»„æ–¹æ³•</strong>ï¼š<code>Object.groupBy()</code> å’Œ <code>Map.groupBy()</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> users = [</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Alice&#x27;</span>, <span class="attr">age</span>: <span class="number">25</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Bob&#x27;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="string">&#x27;Charlie&#x27;</span>, <span class="attr">age</span>: <span class="number">25</span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‰å¹´é¾„åˆ†ç»„</span></span><br><span class="line"><span class="keyword">const</span> grouped = <span class="title class_">Object</span>.<span class="title function_">groupBy</span>(users, <span class="function"><span class="params">user</span> =&gt;</span> user.<span class="property">age</span>);</span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   25: [&#123; name: &#x27;Alice&#x27;, age: 25 &#125;, &#123; name: &#x27;Charlie&#x27;, age: 25 &#125;],</span></span><br><span class="line"><span class="comment">//   30: [&#123; name: &#x27;Bob&#x27;, age: 30 &#125;]</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure></li><li><p>**Promise.withResolvers()**ï¼šåˆ›å»ºå¸¦æœ‰resolversçš„Promise</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; promise, resolve, reject &#125; = <span class="title class_">Promise</span>.<span class="title function_">withResolvers</span>();</span><br><span class="line"><span class="comment">// å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨resolve/reject</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Array Find from Last</strong>ï¼šå®ŒæˆES2023çš„<code>findLast()</code>å’Œ<code>findLastIndex()</code>è§„èŒƒ</p></li></ul><h3 id="æ³¨æ„äº‹é¡¹ï¼š-10"><a href="#æ³¨æ„äº‹é¡¹ï¼š-10" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li><code>Object.groupBy()</code>å’Œ<code>Map.groupBy()</code>æ˜¯é™æ€æ–¹æ³•ï¼Œä¸æ˜¯åŸå‹æ–¹æ³•</li><li>åˆ†ç»„æ–¹æ³•è¿”å›çš„å¯¹è±¡å±æ€§åæ˜¯å­—ç¬¦ä¸²ï¼Œå³ä½¿æ˜¯æ•°å­—ä¹Ÿä¼šè¢«è½¬æ¢ä¸ºå­—ç¬¦ä¸²</li><li><code>Promise.withResolvers()</code>ç®€åŒ–äº†Promiseåˆ›å»ºçš„å¸¸è§æ¨¡å¼ï¼Œç‰¹åˆ«æ˜¯ä¸å›è°ƒAPIäº¤äº’æ—¶</li></ul><h2 id="åäºŒã€ES2025-ES16-ï¼ˆ2025å¹´6æœˆ25æ—¥ï¼‰ï¼šæ¨¡å¼åŒ¹é…ä¸ç°ä»£åŒ–API"><a href="#åäºŒã€ES2025-ES16-ï¼ˆ2025å¹´6æœˆ25æ—¥ï¼‰ï¼šæ¨¡å¼åŒ¹é…ä¸ç°ä»£åŒ–API" class="headerlink" title="åäºŒã€ES2025 (ES16)ï¼ˆ2025å¹´6æœˆ25æ—¥ï¼‰ï¼šæ¨¡å¼åŒ¹é…ä¸ç°ä»£åŒ–API"></a>åäºŒã€ES2025 (ES16)ï¼ˆ2025å¹´6æœˆ25æ—¥ï¼‰ï¼šæ¨¡å¼åŒ¹é…ä¸ç°ä»£åŒ–API</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼š2025å¹´6æœˆ25æ—¥ </p><h3 id="æ ¸å¿ƒç‰¹æ€§ï¼š-11"><a href="#æ ¸å¿ƒç‰¹æ€§ï¼š-11" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§ï¼š"></a>æ ¸å¿ƒç‰¹æ€§ï¼š</h3><h4 id="1-æ¨¡å¼åŒ¹é…ï¼ˆPattern-Matchingï¼‰"><a href="#1-æ¨¡å¼åŒ¹é…ï¼ˆPattern-Matchingï¼‰" class="headerlink" title="1. æ¨¡å¼åŒ¹é…ï¼ˆPattern Matchingï¼‰"></a>1. æ¨¡å¼åŒ¹é…ï¼ˆPattern Matchingï¼‰</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES2025 æ¨¡å¼åŒ¹é…</span></span><br><span class="line"><span class="keyword">const</span> result = match (value) &#123;</span><br><span class="line">  when &#123; <span class="attr">type</span>: <span class="string">&#x27;success&#x27;</span>, data &#125; -&gt; <span class="string">`Success: <span class="subst">$&#123;data&#125;</span>`</span></span><br><span class="line">  when &#123; <span class="attr">type</span>: <span class="string">&#x27;error&#x27;</span>, message &#125; -&gt; <span class="string">`Error: <span class="subst">$&#123;message&#125;</span>`</span></span><br><span class="line">  when <span class="literal">null</span> -&gt; <span class="string">&#x27;No value&#x27;</span></span><br><span class="line">  <span class="keyword">else</span> -&gt; <span class="string">&#x27;Unknown&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="2-ç®¡é“æ“ä½œç¬¦ï¼ˆPipeline-Operatorï¼‰"><a href="#2-ç®¡é“æ“ä½œç¬¦ï¼ˆPipeline-Operatorï¼‰" class="headerlink" title="2. ç®¡é“æ“ä½œç¬¦ï¼ˆPipeline Operatorï¼‰"></a>2. ç®¡é“æ“ä½œç¬¦ï¼ˆPipeline Operatorï¼‰</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES2025 ç®¡é“æ“ä½œç¬¦</span></span><br><span class="line"><span class="keyword">const</span> result = input</span><br><span class="line">  |&gt; double</span><br><span class="line">  |&gt; <span class="title function_">add</span>(<span class="number">5</span>)</span><br><span class="line">  |&gt; <span class="title class_">String</span></span><br><span class="line">  |&gt; capitalize;</span><br><span class="line"><span class="comment">// ç­‰ä»·äºï¼šcapitalize(String(add(5, double(input))))</span></span><br></pre></td></tr></table></figure><h4 id="3-Temporal-API"><a href="#3-Temporal-API" class="headerlink" title="3. Temporal API"></a>3. Temporal API</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES2025 Temporal API - æ›¿ä»£Dateå¯¹è±¡</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Temporal</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;temporal&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> now = <span class="title class_">Temporal</span>.<span class="property">Now</span>.<span class="title function_">instant</span>();</span><br><span class="line"><span class="keyword">const</span> tomorrow = now.<span class="title function_">add</span>(&#123; <span class="attr">days</span>: <span class="number">1</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> date = <span class="title class_">Temporal</span>.<span class="property">PlainDate</span>.<span class="title function_">from</span>(<span class="string">&#x27;2025-12-31&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> time = <span class="title class_">Temporal</span>.<span class="property">PlainTime</span>.<span class="title function_">from</span>(<span class="string">&#x27;15:30:00&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> dateTime = date.<span class="title function_">toPlainDateTime</span>(time);</span><br></pre></td></tr></table></figure><h4 id="4-è®°å½•å’Œå…ƒç»„ï¼ˆRecords-and-Tuplesï¼‰"><a href="#4-è®°å½•å’Œå…ƒç»„ï¼ˆRecords-and-Tuplesï¼‰" class="headerlink" title="4. è®°å½•å’Œå…ƒç»„ï¼ˆRecords and Tuplesï¼‰"></a>4. è®°å½•å’Œå…ƒç»„ï¼ˆRecords and Tuplesï¼‰</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES2025 Records and Tuples</span></span><br><span class="line"><span class="keyword">const</span> record = #&#123; <span class="attr">name</span>: <span class="string">&#x27;Alice&#x27;</span>, <span class="attr">age</span>: <span class="number">25</span> &#125;; <span class="comment">// ä¸å¯å˜è®°å½•</span></span><br><span class="line"><span class="keyword">const</span> tuple = #[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]; <span class="comment">// ä¸å¯å˜å…ƒç»„</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·±åº¦ç›¸ç­‰æ¯”è¾ƒ</span></span><br><span class="line"><span class="keyword">const</span> record2 = #&#123; <span class="attr">name</span>: <span class="string">&#x27;Alice&#x27;</span>, <span class="attr">age</span>: <span class="number">25</span> &#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(record === record2); <span class="comment">// true (ç»“æ„ç›¸ç­‰)</span></span><br></pre></td></tr></table></figure><h4 id="5-è¿­ä»£å™¨åŠ©æ‰‹ï¼ˆIterator-Helpersï¼‰"><a href="#5-è¿­ä»£å™¨åŠ©æ‰‹ï¼ˆIterator-Helpersï¼‰" class="headerlink" title="5. è¿­ä»£å™¨åŠ©æ‰‹ï¼ˆIterator Helpersï¼‰"></a>5. è¿­ä»£å™¨åŠ©æ‰‹ï¼ˆIterator Helpersï¼‰</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES2025 Iterator Helpers</span></span><br><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">const</span> iterator = numbers[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> doubled = iterator.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x * <span class="number">2</span>);</span><br><span class="line"><span class="keyword">const</span> filtered = doubled.<span class="title function_">filter</span>(<span class="function"><span class="params">x</span> =&gt;</span> x &gt; <span class="number">5</span>);</span><br><span class="line"><span class="keyword">const</span> result = [...filtered]; <span class="comment">// [6, 8, 10]</span></span><br></pre></td></tr></table></figure><h4 id="6-è£…é¥°å™¨å…ƒæ•°æ®ï¼ˆDecorator-Metadataï¼‰"><a href="#6-è£…é¥°å™¨å…ƒæ•°æ®ï¼ˆDecorator-Metadataï¼‰" class="headerlink" title="6. è£…é¥°å™¨å…ƒæ•°æ®ï¼ˆDecorator Metadataï¼‰"></a>6. è£…é¥°å™¨å…ƒæ•°æ®ï¼ˆDecorator Metadataï¼‰</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES2025 Decorator Metadata</span></span><br><span class="line">@log</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line">  @validate</span><br><span class="line">  <span class="title function_">method</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">log</span>(<span class="params">target</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Class metadata:&#x27;</span>, target.<span class="property">metadata</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨æ„äº‹é¡¹ï¼š-11"><a href="#æ³¨æ„äº‹é¡¹ï¼š-11" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li><strong>æ¨¡å¼åŒ¹é…</strong>æ˜¯è¯­æ³•ææ¡ˆï¼Œæä¾›æ¯”switchæ›´å¼ºå¤§çš„æ¡ä»¶åˆ†æ”¯èƒ½åŠ› </li><li><strong>ç®¡é“æ“ä½œç¬¦</strong>ä½¿ç”¨<code>|&gt;</code>ç¬¦å·ï¼Œå¯ä»¥æ˜¾è‘—æé«˜ä»£ç çš„å¯è¯»æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨å‡½æ•°ç»„åˆæ—¶ </li><li><strong>Temporal API</strong>æ˜¯ç°ä»£ã€ä¸å¯å˜çš„æ—¥æœŸ&#x2F;æ—¶é—´å¤„ç†APIï¼Œè§£å†³äº†Dateå¯¹è±¡çš„è¯¸å¤šé—®é¢˜ </li><li><strong>Recordså’ŒTuples</strong>æä¾›æ·±åº¦ä¸å¯å˜çš„æ•°æ®ç»“æ„ï¼Œæ”¯æŒç»“æ„ç›¸ç­‰æ¯”è¾ƒ </li><li><strong>è¿­ä»£å™¨åŠ©æ‰‹</strong>ä¸ºè¿­ä»£å™¨æ·»åŠ äº†ç±»ä¼¼æ•°ç»„çš„æ–¹æ³•ï¼ˆmap, filter, reduceç­‰ï¼‰</li><li><strong>è£…é¥°å™¨å…ƒæ•°æ®</strong>ä¸ºè£…é¥°å™¨æ¨¡å¼æä¾›æ ‡å‡†å…ƒæ•°æ®è®¿é—®æœºåˆ¶</li></ul><h2 id="ç‰ˆæœ¬å‘å¸ƒæ—¶é—´æ€»è¡¨"><a href="#ç‰ˆæœ¬å‘å¸ƒæ—¶é—´æ€»è¡¨" class="headerlink" title="ç‰ˆæœ¬å‘å¸ƒæ—¶é—´æ€»è¡¨"></a>ç‰ˆæœ¬å‘å¸ƒæ—¶é—´æ€»è¡¨</h2><table><thead><tr><th>ç‰ˆæœ¬</th><th>å®˜æ–¹åç§°</th><th>å‘å¸ƒæ—¥æœŸ</th><th>ä¸»è¦ç‰¹æ€§</th></tr></thead><tbody><tr><td>ES5</td><td>ECMAScript 5</td><td>2009å¹´12æœˆ</td><td>ä¸¥æ ¼æ¨¡å¼ã€æ•°ç»„æ–¹æ³•ã€JSONæ”¯æŒ</td></tr><tr><td>ES6</td><td>ECMAScript 2015</td><td>2015å¹´6æœˆ</td><td>let&#x2F;constã€ç®­å¤´å‡½æ•°ã€ç±»ã€Promiseã€æ¨¡å—</td></tr><tr><td>ES7</td><td>ECMAScript 2016</td><td>2016å¹´6æœˆ</td><td>Array.includes()ã€æŒ‡æ•°è¿ç®—ç¬¦</td></tr><tr><td>ES8</td><td>ECMAScript 2017</td><td>2017å¹´6æœˆ</td><td>async&#x2F;awaitã€Object.values&#x2F;entries()</td></tr><tr><td>ES9</td><td>ECMAScript 2018</td><td>2018å¹´6æœˆ</td><td>å¯¹è±¡å±•å¼€&#x2F;å‰©ä½™ã€æ­£åˆ™å¢å¼º</td></tr><tr><td>ES10</td><td>ECMAScript 2019</td><td>2019å¹´6æœˆ</td><td>Array.flat()&#x2F;flatMap()ã€Object.fromEntries()</td></tr><tr><td>ES11</td><td>ECMAScript 2020</td><td>2020å¹´6æœˆ</td><td>å¯é€‰é“¾ã€ç©ºå€¼åˆå¹¶ã€BigIntã€åŠ¨æ€import</td></tr><tr><td>ES12</td><td>ECMAScript 2021</td><td>2021å¹´6æœˆ</td><td>é€»è¾‘èµ‹å€¼ã€æ•°å­—åˆ†éš”ç¬¦ã€replaceAll()</td></tr><tr><td>ES13</td><td>ECMAScript 2022</td><td>2022å¹´6æœˆ</td><td>ç±»å­—æ®µã€ç§æœ‰å±æ€§ã€at()æ–¹æ³•</td></tr><tr><td>ES14</td><td>ECMAScript 2023</td><td>2023å¹´6æœˆ</td><td>findLast()&#x2F;findLastIndex()ã€Change Array by Copy</td></tr><tr><td>ES15</td><td>ECMAScript 2024</td><td>2024å¹´6æœˆ</td><td>Object.groupBy()&#x2F;Map.groupBy()ã€Promise.withResolvers()</td></tr><tr><td>ES16</td><td>ECMAScript 2025</td><td>2025å¹´6æœˆ25æ—¥</td><td>æ¨¡å¼åŒ¹é…ã€ç®¡é“æ“ä½œç¬¦ã€Temporal APIã€Records&#x2F;Tuples</td></tr></tbody></table><h2 id="æ€»ç»“ä¸å»ºè®®"><a href="#æ€»ç»“ä¸å»ºè®®" class="headerlink" title="æ€»ç»“ä¸å»ºè®®"></a>æ€»ç»“ä¸å»ºè®®</h2><h3 id="ç‰ˆæœ¬æ¼”è¿›çš„æ„ä¹‰"><a href="#ç‰ˆæœ¬æ¼”è¿›çš„æ„ä¹‰" class="headerlink" title="ç‰ˆæœ¬æ¼”è¿›çš„æ„ä¹‰"></a>ç‰ˆæœ¬æ¼”è¿›çš„æ„ä¹‰</h3><ol><li><strong>è¯­æ³•æ›´ç®€æ´ã€å¯è¯»æ€§æ›´å¼º</strong>ï¼šä»ES6å¼€å§‹ï¼ŒJavaScriptè¯­æ³•å˜å¾—æ›´åŠ ç°ä»£åŒ–å’Œè¡¨è¾¾åŠ›ä¸°å¯Œ</li><li><strong>è§£å†³äº†å†å²é—®é¢˜</strong>ï¼š<code>this</code>ç»‘å®šã€ä½œç”¨åŸŸã€å›è°ƒåœ°ç‹±ã€æ—¥æœŸå¤„ç†ç­‰é•¿æœŸå­˜åœ¨çš„é—®é¢˜å¾—åˆ°ç³»ç»Ÿæ€§è§£å†³</li><li><strong>å¼•å…¥ç°ä»£ç¼–ç¨‹èŒƒå¼</strong>ï¼šå‡½æ•°å¼ç¼–ç¨‹ã€ä¸å¯å˜æ•°æ®ã€æ¨¡å¼åŒ¹é…ç­‰ç°ä»£æ¦‚å¿µè¢«å¼•å…¥</li><li><strong>æ€§èƒ½å’Œå®‰å…¨æ€§æå‡</strong>ï¼šä»åŸå‹ç»§æ‰¿åˆ°ç±»è¯­æ³•ï¼Œä»å¯å˜æ•°æ®åˆ°ä¸å¯å˜æ•°æ®ï¼Œè¯­è¨€è®¾è®¡æ›´åŠ å¥å£®</li></ol><h3 id="å­¦ä¹ è·¯å¾„å»ºè®®"><a href="#å­¦ä¹ è·¯å¾„å»ºè®®" class="headerlink" title="å­¦ä¹ è·¯å¾„å»ºè®®"></a>å­¦ä¹ è·¯å¾„å»ºè®®</h3><ul><li><strong>åŸºç¡€é˜¶æ®µ</strong>ï¼šæŒæ¡ES5æ ¸å¿ƒæ¦‚å¿µï¼Œç†è§£åŸå‹ç»§æ‰¿ã€é—­åŒ…ã€ä½œç”¨åŸŸé“¾</li><li><strong>ç°ä»£å¼€å‘</strong>ï¼šé‡ç‚¹å­¦ä¹ ES6+æ ¸å¿ƒç‰¹æ€§ï¼ˆlet&#x2F;constã€ç®­å¤´å‡½æ•°ã€è§£æ„ã€Promiseã€async&#x2F;awaitï¼‰</li><li><strong>é«˜çº§åº”ç”¨</strong>ï¼šæ·±å…¥ç†è§£ES2020+çš„ç°ä»£ç‰¹æ€§ï¼ˆå¯é€‰é“¾ã€ç©ºå€¼åˆå¹¶ã€æ¨¡å¼åŒ¹é…ã€Temporal APIï¼‰</li><li><strong>æŒç»­è·Ÿè¿›</strong>ï¼šå…³æ³¨TC39ææ¡ˆï¼Œäº†è§£æœªæ¥è¯­è¨€å‘å±•æ–¹å‘</li></ul><h3 id="å…¼å®¹æ€§ç­–ç•¥"><a href="#å…¼å®¹æ€§ç­–ç•¥" class="headerlink" title="å…¼å®¹æ€§ç­–ç•¥"></a>å…¼å®¹æ€§ç­–ç•¥</h3><ul><li><strong>ES5</strong>ï¼šå®Œå…¨å…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼Œé€‚åˆé—ç•™ç³»ç»Ÿç»´æŠ¤</li><li><strong>ES6-ES2019</strong>ï¼šç°ä»£æµè§ˆå™¨åŸºæœ¬æ”¯æŒï¼Œéœ€è€ƒè™‘æ—§ç‰ˆIEçš„polyfillæ–¹æ¡ˆ</li><li>**ES2020+**ï¼šéœ€è¦Babel + core-jsè¿›è¡Œè½¬è¯‘ï¼Œæˆ–é‡‡ç”¨æ¸è¿›å¢å¼ºç­–ç•¥</li><li>**ES2025+**ï¼šæ–°ç‰¹æ€§é€šå¸¸éœ€è¦æœ€æ–°æµè§ˆå™¨æ”¯æŒï¼Œå»ºè®®åœ¨å¯æ§ç¯å¢ƒä¸­é€æ­¥é‡‡ç”¨</li></ul><h3 id="å·¥å…·é“¾æ¨è"><a href="#å·¥å…·é“¾æ¨è" class="headerlink" title="å·¥å…·é“¾æ¨è"></a>å·¥å…·é“¾æ¨è</h3><ul><li><strong>Babel</strong>ï¼šJavaScriptç¼–è¯‘å™¨ï¼Œæ”¯æŒæœ€æ–°è¯­æ³•è½¬è¯‘</li><li><strong>TypeScript</strong>ï¼šè¶…é›†è¯­è¨€ï¼Œæä¾›ç±»å‹æ£€æŸ¥å’Œæœ€æ–°ECMAScriptç‰¹æ€§</li><li><strong>esbuild&#x2F;swc</strong>ï¼šé«˜æ€§èƒ½JavaScript&#x2F;TypeScriptæ„å»ºå·¥å…·</li><li><strong>core-js</strong>ï¼šæä¾›ECMAScriptæ ‡å‡†åº“çš„polyfill</li></ul><p>JavaScriptä»ES5åˆ°ES16çš„æ¼”è¿›ï¼Œä¸ä»…å¸¦æ¥äº†è¯­æ³•å±‚é¢çš„é©æ–°ï¼Œæ›´é‡è¦çš„æ˜¯æ”¹å˜äº†å¼€å‘è€…çš„æ€ç»´æ–¹å¼å’Œç¼–ç¨‹èŒƒå¼ã€‚æŒæ¡è¿™äº›ç‰¹æ€§ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬å†™å‡ºæ›´ç®€æ´ã€æ›´å®‰å…¨ã€æ›´æ˜“ç»´æŠ¤çš„ä»£ç ï¼ŒçœŸæ­£å‘æŒ¥ç°ä»£JavaScriptçš„å¨åŠ›ã€‚éšç€ESæ¯å¹´6æœˆçš„å®šæœŸå‘å¸ƒï¼ŒJavaScriptç”Ÿæ€å°†æŒç»­è¿›åŒ–ï¼Œä¸ºå¼€å‘è€…å¸¦æ¥æ›´å¼ºå¤§çš„å·¥å…·å’Œæ›´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚</p><blockquote><p><strong>è¡¥å……è¯´æ˜</strong>ï¼šæœ¬æ–‡æˆªè‡³äº2025å¹´12æœˆ30æ—¥å‰çš„æ—¶é—´æ¢³ç†æœ€æ–°æ ‡å‡†ã€‚</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h1 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;/h1&gt;&lt;h2 id=&quot;æ ‡å‡†è§„èŒƒECMAScriptå¯¹JavaScriptçš„å½±å“&quot;&gt;&lt;a href=&quot;#æ ‡å‡†è§„èŒƒECMAScriptå¯¹JavaScriptçš„å½±å“&quot; class=&quot;headerlink&quot; title=&quot;æ ‡å‡†è§„èŒƒECMAScriptå¯¹JavaScriptçš„å½±å“&quot;&gt;&lt;/a&gt;æ ‡å‡†è§„èŒƒECMAScriptå¯¹JavaScriptçš„å½±å“&lt;/h2&gt;&lt;p&gt;JavaScriptä½œä¸ºWebå¼€å‘çš„æ ¸å¿ƒè¯­è¨€ï¼Œå…¶æ ‡å‡†è§„èŒƒECMAScriptï¼ˆç®€ç§°ESï¼‰è‡ª1997å¹´è¯ç”Ÿä»¥æ¥æŒç»­æ¼”è¿›ã€‚ä»ES5åˆ°æœ€æ–°çš„ES16ï¼Œæ¯ä¸ªç‰ˆæœ¬éƒ½å¸¦æ¥äº†é©å‘½æ€§çš„å˜åŒ–ï¼Œé‡å¡‘äº†ç°ä»£å‰ç«¯å¼€å‘çš„é¢è²Œã€‚æœ¬æ–‡å°†ç³»ç»Ÿæ¢³ç†è¿™äº›ç‰ˆæœ¬é—´çš„å®Œæ•´æ¼”è¿›å†ç¨‹ï¼ŒåŒ…å«ç²¾ç¡®çš„å‘å¸ƒæ—¶é—´ã€æ ¸å¿ƒç‰¹æ€§åŠæ³¨æ„äº‹é¡¹ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå…¨é¢æŒæ¡JavaScriptçš„ç°ä»£åŒ–å‘å±•è„‰ç»œã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="javascript" scheme="https://www.wdft.com/categories/javascript/"/>
    
    
    <category term="JavaScript" scheme="https://www.wdft.com/tags/JavaScript/"/>
    
    <category term="JS" scheme="https://www.wdft.com/tags/JS/"/>
    
    <category term="TypeScript" scheme="https://www.wdft.com/tags/TypeScript/"/>
    
    <category term="TS" scheme="https://www.wdft.com/tags/TS/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºQwen3çš„MCPæ¶æ„çš„å…¥é—¨ï¼šå­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿå®Œæ•´å®ç°Demoä¸ºä¾‹å®è·µæŒ‡å—</title>
    <link href="https://www.wdft.com/6e5682ad.html"/>
    <id>https://www.wdft.com/6e5682ad.html</id>
    <published>2025-12-27T13:25:24.000Z</published>
    <updated>2026-01-26T09:48:41.418Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h2 id="ä¸€ã€MCPæ¶æ„åŸç†æ¦‚è¿°"><a href="#ä¸€ã€MCPæ¶æ„åŸç†æ¦‚è¿°" class="headerlink" title="ä¸€ã€MCPæ¶æ„åŸç†æ¦‚è¿°"></a>ä¸€ã€MCPæ¶æ„åŸç†æ¦‚è¿°</h2><h3 id="1-1-MCPåŸºæœ¬æ¦‚å¿µ"><a href="#1-1-MCPåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="1.1 MCPåŸºæœ¬æ¦‚å¿µ"></a>1.1 MCPåŸºæœ¬æ¦‚å¿µ</h3><p>MCPï¼ˆModel Context Protocolï¼‰æ˜¯ä¸€ç§æ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œé€šè¿‡ç»Ÿä¸€çš„åè®®è®©AIæ¨¡å‹è¿æ¥å„ç§å·¥å…·å’Œæ•°æ®æºï¼Œç±»ä¼¼äºAIä¸–ç•Œçš„â€USB-Câ€æ¥å£ã€‚<br> è¯¥åè®®é‡‡ç”¨ä¼šè¯å¯¼å‘çš„JSON-RPCæ¡†æ¶ï¼Œä½¿å¤§è¯­è¨€æ¨¡å‹èƒ½å¤Ÿä¸å¤–éƒ¨ç³»ç»Ÿå’Œæ•°æ®æºè¿›è¡Œäº¤äº’ã€‚ MCPæœåŠ¡å™¨å……å½“æ¨¡å‹ä¸æœ¬åœ°ç¯å¢ƒæˆ–å¤–éƒ¨ç³»ç»Ÿçš„æ¡¥æ¢ï¼Œå‘CLIæš´éœ²å·¥å…·å’Œèµ„æºï¼Œå®ç°AIé©±åŠ¨çš„äº¤äº’ã€‚</p><span id="more"></span><h3 id="1-2-MCPæ¶æ„ä¼˜åŠ¿"><a href="#1-2-MCPæ¶æ„ä¼˜åŠ¿" class="headerlink" title="1.2 MCPæ¶æ„ä¼˜åŠ¿"></a>1.2 MCPæ¶æ„ä¼˜åŠ¿</h3><ul><li><strong>å·¥å…·é›†æˆ</strong>ï¼šQwen3æ¨¡å‹é€šè¿‡Qwen-Agentæ¡†æ¶æ”¯æŒMCPé›†æˆï¼Œå…è®¸AIä»£ç†è¿æ¥å„ç§å·¥å…·ã€‚</li><li><strong>æ•°æ®è¿æ¥</strong>ï¼šMCPé€šè¿‡ç»Ÿä¸€åè®®è®©AIæ¨¡å‹è¿æ¥å„ç§å·¥å…·å’Œæ•°æ®æºï¼Œå®ç°æ— ç¼æ•°æ®äº¤äº’ã€‚</li><li><strong>æ‰©å±•æ€§</strong>ï¼šåŸºäºNode.jsçš„MCPæœåŠ¡å™¨å¹³å°é›†æˆäº†Qwen CLIå·¥å…·ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤ã€‚</li></ul><h2 id="äºŒã€åŸºäºQwen3çš„MCPæ¶æ„ï¼šå­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿå®Œæ•´å®ç°Demoä¸ºä¾‹"><a href="#äºŒã€åŸºäºQwen3çš„MCPæ¶æ„ï¼šå­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿå®Œæ•´å®ç°Demoä¸ºä¾‹" class="headerlink" title="äºŒã€åŸºäºQwen3çš„MCPæ¶æ„ï¼šå­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿå®Œæ•´å®ç°Demoä¸ºä¾‹"></a>äºŒã€åŸºäºQwen3çš„MCPæ¶æ„ï¼šå­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿå®Œæ•´å®ç°Demoä¸ºä¾‹</h2><p>æœ¬æ–‡å°†ä»¥å…¸å‹çš„åœºæ™¯ï¼š<strong>å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</strong>è®¾è®¡ä»¥åŠåŠŸèƒ½å®ç°ä¸ºä¾‹ï¼Œå±•ç°MCPçš„ä½¿ç”¨æ–¹å¼å’ŒåŸºæœ¬å®è·µã€‚</p><h3 id="2-1-ä¸šåŠ¡éœ€æ±‚åˆ†æ"><a href="#2-1-ä¸šåŠ¡éœ€æ±‚åˆ†æ" class="headerlink" title="2.1 ä¸šåŠ¡éœ€æ±‚åˆ†æ"></a>2.1 ä¸šåŠ¡éœ€æ±‚åˆ†æ</h3><ul><li><strong>å­¦ç”Ÿæ€»æˆç»©è®¡ç®—</strong>ï¼šæ ¹æ®å­¦ç”ŸIDè®¡ç®—è¯¥å­¦ç”Ÿæ‰€æœ‰ç§‘ç›®çš„æ€»æˆç»©</li><li><strong>ç­çº§å¹³å‡æˆç»©</strong>ï¼šè®¡ç®—æŒ‡å®šç­çº§å„ç§‘ç›®çš„å¹³å‡æˆç»©</li><li><strong>å­¦ç”Ÿå†å¹´æˆç»©</strong>ï¼šæŸ¥è¯¢æŒ‡å®šå­¦ç”Ÿåœ¨ä¸åŒå­¦å¹´çš„æˆç»©å˜åŒ–</li></ul><h3 id="2-2-MCPæ¶æ„è®¾è®¡"><a href="#2-2-MCPæ¶æ„è®¾è®¡" class="headerlink" title="2.2 MCPæ¶æ„è®¾è®¡"></a>2.2 MCPæ¶æ„è®¾è®¡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                       Qwen3 AI Model                        â”‚</span><br><span class="line">â”‚        (é€šè¿‡MCPåè®®è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼Œå¤„ç†è‡ªç„¶è¯­è¨€è¯·æ±‚)                â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                        â”‚ MCP Protocol (JSON-RPC)</span><br><span class="line">                        â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                    MCP Server (Node.js)                           â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€----â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚</span><br><span class="line">â”‚  â”‚StudentTools â”‚  â”‚GradeTools       â”‚  â”‚AnalyticsTools         â”‚  â”‚</span><br><span class="line">â”‚  â”‚- getStudent â”‚  â”‚- getTotalScore  â”‚  â”‚- getClassAverage      â”‚  â”‚</span><br><span class="line">â”‚  â”‚- listStudentsâ”‚ â”‚- getYearlyGradesâ”‚  |- getPerformanceTrend  â”‚  â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                        â”‚</span><br><span class="line">                        â–¼</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚                  Data Sources (Mock Data)                   â”‚</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚</span><br><span class="line">â”‚  â”‚Students.jsonâ”‚  â”‚Grades.json  â”‚  â”‚Classes.json         â”‚  â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="2-3-æ•°æ®ç»“æ„è®¾è®¡"><a href="#2-3-æ•°æ®ç»“æ„è®¾è®¡" class="headerlink" title="2.3 æ•°æ®ç»“æ„è®¾è®¡"></a>2.3 æ•°æ®ç»“æ„è®¾è®¡</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// students.json</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;S001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;classId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C101&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é«˜ä¸€&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;enrollmentYear&quot;</span><span class="punctuation">:</span> <span class="number">2024</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;S002&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æå››&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;classId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C101&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é«˜ä¸€&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;enrollmentYear&quot;</span><span class="punctuation">:</span> <span class="number">2024</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// grades.json</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;studentId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;S001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ•°å­¦&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">85</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;semester&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-2025-1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;studentId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;S001&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è¯­æ–‡&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">92</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;semester&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-2025-1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;studentId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;S002&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ•°å­¦&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">78</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;semester&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-2025-1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// classes.json</span></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C101&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é«˜ä¸€(1)ç­&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gradeLevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;é«˜ä¸€&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;studentIds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;S001&quot;</span><span class="punctuation">,</span> <span class="string">&quot;S002&quot;</span><span class="punctuation">,</span> <span class="string">&quot;S003&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€MCPå·¥å…·å®ç°"><a href="#ä¸‰ã€MCPå·¥å…·å®ç°" class="headerlink" title="ä¸‰ã€MCPå·¥å…·å®ç°"></a>ä¸‰ã€MCPå·¥å…·å®ç°</h2><h3 id="3-1-MCPæœåŠ¡å™¨æ­å»º"><a href="#3-1-MCPæœåŠ¡å™¨æ­å»º" class="headerlink" title="3.1 MCPæœåŠ¡å™¨æ­å»º"></a>3.1 MCPæœåŠ¡å™¨æ­å»º</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mcp-server.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; createMcpServer &#125; = <span class="built_in">require</span>(<span class="string">&#x27;@qwen/mcp-server&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½æ•°æ®</span></span><br><span class="line"><span class="keyword">const</span> students = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;data/students.json&#x27;</span>), <span class="string">&#x27;utf8&#x27;</span>));</span><br><span class="line"><span class="keyword">const</span> grades = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;data/grades.json&#x27;</span>), <span class="string">&#x27;utf8&#x27;</span>));</span><br><span class="line"><span class="keyword">const</span> classes = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;data/classes.json&#x27;</span>), <span class="string">&#x27;utf8&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºMCPæœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">const</span> mcpServer = <span class="title function_">createMcpServer</span>(&#123;</span><br><span class="line">  <span class="attr">port</span>: <span class="number">8080</span>,</span><br><span class="line">  <span class="attr">tools</span>: &#123;</span><br><span class="line">    <span class="comment">// å­¦ç”Ÿä¿¡æ¯å·¥å…·</span></span><br><span class="line">    <span class="attr">getStudent</span>: &#123;</span><br><span class="line">      <span class="attr">description</span>: <span class="string">&quot;æ ¹æ®å­¦ç”ŸIDè·å–å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯&quot;</span>,</span><br><span class="line">      <span class="attr">parameters</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="attr">properties</span>: &#123;</span><br><span class="line">          <span class="attr">studentId</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;å­¦ç”ŸIDï¼Œå¦‚S001&quot;</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">required</span>: [<span class="string">&quot;studentId&quot;</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">handler</span>: <span class="keyword">async</span> (&#123; studentId &#125;) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> student = students.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s.<span class="property">id</span> === studentId);</span><br><span class="line">        <span class="keyword">return</span> student || &#123; <span class="attr">error</span>: <span class="string">&quot;å­¦ç”Ÿä¸å­˜åœ¨&quot;</span> &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æˆç»©å·¥å…·</span></span><br><span class="line">    <span class="attr">getTotalScore</span>: &#123;</span><br><span class="line">      <span class="attr">description</span>: <span class="string">&quot;è®¡ç®—æŒ‡å®šå­¦ç”Ÿçš„æ€»æˆç»©&quot;</span>,</span><br><span class="line">      <span class="attr">parameters</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;object&quot;</span>, </span><br><span class="line">        <span class="attr">properties</span>: &#123;</span><br><span class="line">          <span class="attr">studentId</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;å­¦ç”ŸID&quot;</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">required</span>: [<span class="string">&quot;studentId&quot;</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">handler</span>: <span class="keyword">async</span> (&#123; studentId &#125;) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> studentGrades = grades.<span class="title function_">filter</span>(<span class="function"><span class="params">g</span> =&gt;</span> g.<span class="property">studentId</span> === studentId);</span><br><span class="line">        <span class="keyword">const</span> total = studentGrades.<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, g</span>) =&gt;</span> sum + g.<span class="property">score</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">const</span> subjects = studentGrades.<span class="title function_">map</span>(<span class="function"><span class="params">g</span> =&gt;</span> g.<span class="property">subject</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          studentId,</span><br><span class="line">          <span class="attr">totalScore</span>: total,</span><br><span class="line">          <span class="attr">subjectCount</span>: studentGrades.<span class="property">length</span>,</span><br><span class="line">          <span class="attr">subjects</span>: subjects</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç­çº§åˆ†æå·¥å…·</span></span><br><span class="line">    <span class="attr">getClassAverage</span>: &#123;</span><br><span class="line">      <span class="attr">description</span>: <span class="string">&quot;è®¡ç®—æŒ‡å®šç­çº§çš„å¹³å‡æˆç»©&quot;</span>,</span><br><span class="line">      <span class="attr">parameters</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="attr">properties</span>: &#123;</span><br><span class="line">          <span class="attr">classId</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;ç­çº§IDï¼Œå¦‚C101&quot;</span> &#125;,</span><br><span class="line">          <span class="attr">subject</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;ç§‘ç›®åç§°ï¼Œå¯é€‰&quot;</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">required</span>: [<span class="string">&quot;classId&quot;</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">handler</span>: <span class="keyword">async</span> (&#123; classId, subject &#125;) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> classInfo = classes.<span class="title function_">find</span>(<span class="function"><span class="params">c</span> =&gt;</span> c.<span class="property">id</span> === classId);</span><br><span class="line">        <span class="keyword">if</span> (!classInfo) <span class="keyword">return</span> &#123; <span class="attr">error</span>: <span class="string">&quot;ç­çº§ä¸å­˜åœ¨&quot;</span> &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> filteredGrades = grades.<span class="title function_">filter</span>(<span class="function"><span class="params">g</span> =&gt;</span> </span><br><span class="line">          classInfo.<span class="property">studentIds</span>.<span class="title function_">includes</span>(g.<span class="property">studentId</span>)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (subject) &#123;</span><br><span class="line">          filteredGrades = filteredGrades.<span class="title function_">filter</span>(<span class="function"><span class="params">g</span> =&gt;</span> g.<span class="property">subject</span> === subject);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (filteredGrades.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123; <span class="attr">error</span>: <span class="string">&quot;æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æˆç»©æ•°æ®&quot;</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> average = filteredGrades.<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, g</span>) =&gt;</span> sum + g.<span class="property">score</span>, <span class="number">0</span>) / filteredGrades.<span class="property">length</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">classId</span>: classInfo.<span class="property">id</span>,</span><br><span class="line">          <span class="attr">className</span>: classInfo.<span class="property">name</span>,</span><br><span class="line">          <span class="attr">subject</span>: subject || <span class="string">&quot;æ‰€æœ‰ç§‘ç›®&quot;</span>,</span><br><span class="line">          <span class="attr">averageScore</span>: <span class="built_in">parseFloat</span>(average.<span class="title function_">toFixed</span>(<span class="number">2</span>)),</span><br><span class="line">          <span class="attr">studentCount</span>: classInfo.<span class="property">studentIds</span>.<span class="property">length</span>,</span><br><span class="line">          <span class="attr">gradeCount</span>: filteredGrades.<span class="property">length</span></span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†å²æˆç»©å·¥å…·</span></span><br><span class="line">    <span class="attr">getYearlyGrades</span>: &#123;</span><br><span class="line">      <span class="attr">description</span>: <span class="string">&quot;è·å–æŒ‡å®šå­¦ç”Ÿçš„å†å¹´æˆç»©&quot;</span>,</span><br><span class="line">      <span class="attr">parameters</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="attr">properties</span>: &#123;</span><br><span class="line">          <span class="attr">studentId</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;å­¦ç”ŸID&quot;</span> &#125;,</span><br><span class="line">          <span class="attr">year</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;å­¦å¹´ï¼Œå¦‚2024-2025ï¼Œå¯é€‰&quot;</span> &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">required</span>: [<span class="string">&quot;studentId&quot;</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">handler</span>: <span class="keyword">async</span> (&#123; studentId, year &#125;) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> studentGrades = grades.<span class="title function_">filter</span>(<span class="function"><span class="params">g</span> =&gt;</span> g.<span class="property">studentId</span> === studentId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (year) &#123;</span><br><span class="line">          studentGrades = studentGrades.<span class="title function_">filter</span>(<span class="function"><span class="params">g</span> =&gt;</span> g.<span class="property">semester</span>.<span class="title function_">startsWith</span>(year));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŒ‰å­¦å¹´åˆ†ç»„</span></span><br><span class="line">        <span class="keyword">const</span> yearlyData = &#123;&#125;;</span><br><span class="line">        studentGrades.<span class="title function_">forEach</span>(<span class="function"><span class="params">grade</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> year = grade.<span class="property">semester</span>.<span class="title function_">split</span>(<span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">          <span class="keyword">if</span> (!yearlyData[year]) &#123;</span><br><span class="line">            yearlyData[year] = [];</span><br><span class="line">          &#125;</span><br><span class="line">          yearlyData[year].<span class="title function_">push</span>(&#123;</span><br><span class="line">            <span class="attr">subject</span>: grade.<span class="property">subject</span>,</span><br><span class="line">            <span class="attr">score</span>: grade.<span class="property">score</span>,</span><br><span class="line">            <span class="attr">semester</span>: grade.<span class="property">semester</span></span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          studentId,</span><br><span class="line">          <span class="attr">yearlyGrades</span>: yearlyData,</span><br><span class="line">          <span class="attr">totalYears</span>: <span class="title class_">Object</span>.<span class="title function_">keys</span>(yearlyData).<span class="property">length</span></span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">mcpServer.<span class="title function_">start</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;MCPæœåŠ¡å™¨å¯åŠ¨åœ¨ http://localhost:8080&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="3-2-Qwen3æ¨¡å‹é›†æˆ"><a href="#3-2-Qwen3æ¨¡å‹é›†æˆ" class="headerlink" title="3.2 Qwen3æ¨¡å‹é›†æˆ"></a>3.2 Qwen3æ¨¡å‹é›†æˆ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qwen_agent.py</span></span><br><span class="line"><span class="keyword">from</span> qwen_agent <span class="keyword">import</span> Agent</span><br><span class="line"><span class="keyword">from</span> qwen_agent.tools <span class="keyword">import</span> MCPTool</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentManagementAgent</span>(<span class="title class_ inherited__">Agent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            name=<span class="string">&quot;å­¦ç”Ÿç®¡ç†åŠ©æ‰‹&quot;</span>,</span><br><span class="line">            description=<span class="string">&quot;å¸®åŠ©æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯ã€æˆç»©ç»Ÿè®¡å’Œåˆ†æçš„AIåŠ©æ‰‹&quot;</span>,</span><br><span class="line">            tools=[</span><br><span class="line">                MCPTool(</span><br><span class="line">                    name=<span class="string">&quot;mcp_student_tools&quot;</span>,</span><br><span class="line">                    description=<span class="string">&quot;MCPå­¦ç”Ÿç®¡ç†å·¥å…·é›†&quot;</span>,</span><br><span class="line">                    mcp_server_url=<span class="string">&quot;http://localhost:8080&quot;</span></span><br><span class="line">                )</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_query</span>(<span class="params">self, user_query</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†ç”¨æˆ·æŸ¥è¯¢ï¼Œè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„MCPå·¥å…·&quot;&quot;&quot;</span></span><br><span class="line">        system_prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦ç”Ÿç®¡ç†åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ç”¨æˆ·æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯ã€è®¡ç®—æˆç»©ã€åˆ†æç­çº§æ•°æ®ç­‰ã€‚</span></span><br><span class="line"><span class="string">        è¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼š</span></span><br><span class="line"><span class="string">        - æŸ¥è¯¢å­¦ç”ŸåŸºæœ¬ä¿¡æ¯æ—¶ï¼Œä½¿ç”¨getStudentå·¥å…·</span></span><br><span class="line"><span class="string">        - è®¡ç®—å­¦ç”Ÿæ€»æˆç»©æ—¶ï¼Œä½¿ç”¨getTotalScoreå·¥å…·  </span></span><br><span class="line"><span class="string">        - æŸ¥è¯¢ç­çº§å¹³å‡æˆç»©æ—¶ï¼Œä½¿ç”¨getClassAverageå·¥å…·</span></span><br><span class="line"><span class="string">        - æŸ¥è¯¢å­¦ç”Ÿå†å¹´æˆç»©æ—¶ï¼Œä½¿ç”¨getYearlyGradeså·¥å…·</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        è¯·ä»¥è‡ªç„¶ã€å‹å¥½çš„æ–¹å¼ä¸ç”¨æˆ·äº¤æµï¼Œæä¾›æ¸…æ™°ã€å‡†ç¡®çš„ç­”æ¡ˆã€‚</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = self.chat(</span><br><span class="line">            messages=[</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_prompt&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_query&#125;</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure><h2 id="å››ã€å®Œæ•´Demoæ¼”ç¤º"><a href="#å››ã€å®Œæ•´Demoæ¼”ç¤º" class="headerlink" title="å››ã€å®Œæ•´Demoæ¼”ç¤º"></a>å››ã€å®Œæ•´Demoæ¼”ç¤º</h2><h3 id="4-1-å¯åŠ¨MCPæœåŠ¡å™¨"><a href="#4-1-å¯åŠ¨MCPæœåŠ¡å™¨" class="headerlink" title="4.1 å¯åŠ¨MCPæœåŠ¡å™¨"></a>4.1 å¯åŠ¨MCPæœåŠ¡å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">npm install express @qwen/mcp-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨MCPæœåŠ¡å™¨</span></span><br><span class="line">node mcp-server.js</span><br></pre></td></tr></table></figure><h3 id="4-2-ä½¿ç”¨Qwen3è¿›è¡Œäº¤äº’"><a href="#4-2-ä½¿ç”¨Qwen3è¿›è¡Œäº¤äº’" class="headerlink" title="4.2 ä½¿ç”¨Qwen3è¿›è¡Œäº¤äº’"></a>4.2 ä½¿ç”¨Qwen3è¿›è¡Œäº¤äº’</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># demo.py</span></span><br><span class="line"><span class="keyword">from</span> qwen_agent <span class="keyword">import</span> Agent</span><br><span class="line"><span class="keyword">from</span> student_management_agent <span class="keyword">import</span> StudentManagementAgent</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–ä»£ç†</span></span><br><span class="line">agent = StudentManagementAgent()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹1ï¼šæŸ¥è¯¢å­¦ç”Ÿæ€»æˆç»©</span></span><br><span class="line">query1 = <span class="string">&quot;å¼ ä¸‰çš„æ€»æˆç»©æ˜¯å¤šå°‘ï¼Ÿ&quot;</span></span><br><span class="line">response1 = agent.process_query(query1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;ç”¨æˆ·ï¼š<span class="subst">&#123;query1&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;åŠ©æ‰‹ï¼š<span class="subst">&#123;response1&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹2ï¼šæŸ¥è¯¢ç­çº§å¹³å‡æˆç»©  </span></span><br><span class="line">query2 = <span class="string">&quot;é«˜ä¸€(1)ç­çš„æ•°å­¦å¹³å‡æˆç»©æ˜¯å¤šå°‘ï¼Ÿ&quot;</span></span><br><span class="line">response2 = agent.process_query(query2)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;ç”¨æˆ·ï¼š<span class="subst">&#123;query2&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;åŠ©æ‰‹ï¼š<span class="subst">&#123;response2&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹3ï¼šæŸ¥è¯¢å­¦ç”Ÿå†å¹´æˆç»©</span></span><br><span class="line">query3 = <span class="string">&quot;æå››åœ¨2024-2025å­¦å¹´çš„æˆç»©å¦‚ä½•ï¼Ÿ&quot;</span></span><br><span class="line">response3 = agent.process_query(query3)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;ç”¨æˆ·ï¼š<span class="subst">&#123;query3&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;åŠ©æ‰‹ï¼š<span class="subst">&#123;response3&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="4-3-é¢„æœŸè¾“å‡ºç»“æœ"><a href="#4-3-é¢„æœŸè¾“å‡ºç»“æœ" class="headerlink" title="4.3 é¢„æœŸè¾“å‡ºç»“æœ"></a>4.3 é¢„æœŸè¾“å‡ºç»“æœ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·ï¼šå¼ ä¸‰çš„æ€»æˆç»©æ˜¯å¤šå°‘ï¼Ÿ</span><br><span class="line">åŠ©æ‰‹ï¼šå¼ ä¸‰åŒå­¦çš„æ€»æˆç»©æ˜¯177åˆ†ï¼Œå…±å‚åŠ äº†2é—¨ç§‘ç›®è€ƒè¯•ï¼šæ•°å­¦(85åˆ†)ã€è¯­æ–‡(92åˆ†)ã€‚</span><br><span class="line"></span><br><span class="line">ç”¨æˆ·ï¼šé«˜ä¸€(1)ç­çš„æ•°å­¦å¹³å‡æˆç»©æ˜¯å¤šå°‘ï¼Ÿ</span><br><span class="line">åŠ©æ‰‹ï¼šé«˜ä¸€(1)ç­çš„æ•°å­¦å¹³å‡æˆç»©æ˜¯81.5åˆ†ï¼Œå…±æœ‰2åå­¦ç”Ÿå‚åŠ äº†æ•°å­¦è€ƒè¯•ã€‚</span><br><span class="line"></span><br><span class="line">ç”¨æˆ·ï¼šæå››åœ¨2024-2025å­¦å¹´çš„æˆç»©å¦‚ä½•ï¼Ÿ</span><br><span class="line">åŠ©æ‰‹ï¼šæå››åœ¨2024-2025å­¦å¹´çš„æˆç»©å¦‚ä¸‹ï¼š</span><br><span class="line">- æ•°å­¦ï¼š78åˆ†ï¼ˆ2024-2025-1å­¦æœŸï¼‰</span><br><span class="line">è¯¥å­¦å¹´å…±1é—¨ç§‘ç›®æˆç»©è®°å½•ã€‚</span><br></pre></td></tr></table></figure><h2 id="äº”ã€MCPè°ƒç”¨æµç¨‹è¯¦è§£"><a href="#äº”ã€MCPè°ƒç”¨æµç¨‹è¯¦è§£" class="headerlink" title="äº”ã€MCPè°ƒç”¨æµç¨‹è¯¦è§£"></a>äº”ã€MCPè°ƒç”¨æµç¨‹è¯¦è§£</h2><h3 id="5-1-å·¥å…·è°ƒç”¨æµç¨‹"><a href="#5-1-å·¥å…·è°ƒç”¨æµç¨‹" class="headerlink" title="5.1 å·¥å…·è°ƒç”¨æµç¨‹"></a>5.1 å·¥å…·è°ƒç”¨æµç¨‹</h3><ol><li><strong>ç”¨æˆ·è¾“å…¥</strong>ï¼šç”¨æˆ·æå‡ºè‡ªç„¶è¯­è¨€é—®é¢˜</li><li><strong>æ„å›¾è¯†åˆ«</strong>ï¼šQwen3æ¨¡å‹åˆ†æç”¨æˆ·æ„å›¾ï¼Œç¡®å®šéœ€è¦è°ƒç”¨çš„MCPå·¥å…·</li><li><strong>å‚æ•°æå–</strong>ï¼šæ¨¡å‹ä»ç”¨æˆ·è¾“å…¥ä¸­æå–å·¥å…·æ‰€éœ€çš„å‚æ•°</li><li><strong>MCPè°ƒç”¨</strong>ï¼šé€šè¿‡JSON-RPCåè®®è°ƒç”¨MCPæœåŠ¡å™¨ä¸Šçš„å¯¹åº”å·¥å…·</li><li><strong>æ•°æ®å¤„ç†</strong>ï¼šMCPå·¥å…·å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œè®¿é—®æ•°æ®æº</li><li><strong>ç»“æœè¿”å›</strong>ï¼šå·¥å…·è¿”å›ç»“æ„åŒ–æ•°æ®ç»™Qwen3æ¨¡å‹</li><li><strong>è‡ªç„¶è¯­è¨€ç”Ÿæˆ</strong>ï¼šæ¨¡å‹å°†ç»“æ„åŒ–æ•°æ®è½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€å›å¤</li></ol><h3 id="5-2-JSON-RPCè°ƒç”¨ç¤ºä¾‹"><a href="#5-2-JSON-RPCè°ƒç”¨ç¤ºä¾‹" class="headerlink" title="5.2 JSON-RPCè°ƒç”¨ç¤ºä¾‹"></a>5.2 JSON-RPCè°ƒç”¨ç¤ºä¾‹</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Qwen3è°ƒç”¨getTotalScoreå·¥å…·çš„è¯·æ±‚</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;getTotalScore&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;params&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;studentId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;S001&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;req_123456&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MCPæœåŠ¡å™¨è¿”å›çš„å“åº”</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;studentId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;S001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;totalScore&quot;</span><span class="punctuation">:</span> <span class="number">177</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subjectCount&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subjects&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;æ•°å­¦&quot;</span><span class="punctuation">,</span> <span class="string">&quot;è¯­æ–‡&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;req_123456&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="å…­ã€ä¸ªäººæœ€ä½³å®è·µä¸ä¼˜åŒ–å»ºè®®ï¼ˆä»…ä¾›å‚è€ƒâš ï¸ï¼‰"><a href="#å…­ã€ä¸ªäººæœ€ä½³å®è·µä¸ä¼˜åŒ–å»ºè®®ï¼ˆä»…ä¾›å‚è€ƒâš ï¸ï¼‰" class="headerlink" title="å…­ã€ä¸ªäººæœ€ä½³å®è·µä¸ä¼˜åŒ–å»ºè®®ï¼ˆä»…ä¾›å‚è€ƒâš ï¸ï¼‰"></a>å…­ã€ä¸ªäººæœ€ä½³å®è·µä¸ä¼˜åŒ–å»ºè®®ï¼ˆä»…ä¾›å‚è€ƒâš ï¸ï¼‰</h2><h3 id="6-1-æ€§èƒ½ä¼˜åŒ–"><a href="#6-1-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="6.1 æ€§èƒ½ä¼˜åŒ–"></a>6.1 æ€§èƒ½ä¼˜åŒ–</h3><ul><li><strong>ç¼“å­˜æœºåˆ¶</strong>ï¼šå¯¹é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®</li><li><strong>æ‰¹é‡å¤„ç†</strong>ï¼šæ”¯æŒæ‰¹é‡è·å–å¤šä¸ªå­¦ç”Ÿçš„æˆç»©æ•°æ®</li><li><strong>å¼‚æ­¥è°ƒç”¨</strong>ï¼šå¯¹äºè€—æ—¶æ“ä½œï¼Œé‡‡ç”¨å¼‚æ­¥å¤„ç†æœºåˆ¶</li></ul><h3 id="6-2-å®‰å…¨æ€§è€ƒè™‘"><a href="#6-2-å®‰å…¨æ€§è€ƒè™‘" class="headerlink" title="6.2 å®‰å…¨æ€§è€ƒè™‘"></a>6.2 å®‰å…¨æ€§è€ƒè™‘</h3><ul><li><strong>å‚æ•°éªŒè¯</strong>ï¼šä¸¥æ ¼éªŒè¯å·¥å…·è¾“å…¥å‚æ•°ï¼Œé˜²æ­¢SQLæ³¨å…¥ç­‰æ”»å‡»</li><li><strong>æƒé™æ§åˆ¶</strong>ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œé™åˆ¶æ•æ„Ÿæ•°æ®è®¿é—®</li><li><strong>å®¡è®¡æ—¥å¿—</strong>ï¼šè®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨ï¼Œä¾¿äºè¿½è¸ªå’Œåˆ†æ</li></ul><h3 id="6-3-æ‰©å±•æ€§è®¾è®¡"><a href="#6-3-æ‰©å±•æ€§è®¾è®¡" class="headerlink" title="6.3 æ‰©å±•æ€§è®¾è®¡"></a>6.3 æ‰©å±•æ€§è®¾è®¡</h3><ul><li><strong>æ’ä»¶æœºåˆ¶</strong>ï¼šæ”¯æŒåŠ¨æ€åŠ è½½æ–°çš„MCPå·¥å…·</li><li><strong>å¤šæ•°æ®æºæ”¯æŒ</strong>ï¼šå¯è¿æ¥MySQLã€MongoDBç­‰ä¸åŒæ•°æ®åº“</li><li><strong>å¾®æœåŠ¡æ¶æ„</strong>ï¼šå°†ä¸åŒåŠŸèƒ½æ¨¡å—æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å¾®æœåŠ¡</li></ul><h2 id="ä¸ƒã€å°ç»“"><a href="#ä¸ƒã€å°ç»“" class="headerlink" title="ä¸ƒã€å°ç»“"></a>ä¸ƒã€å°ç»“</h2><p>é€šè¿‡MCPï¼ˆModel Context Protocolï¼‰æ¶æ„ï¼ŒQwen3æ¨¡å‹èƒ½å¤Ÿæ— ç¼è¿æ¥å¤–éƒ¨å·¥å…·å’Œæ•°æ®æºï¼Œå®ç°å¤æ‚ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ã€‚ åœ¨å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿä¸­ï¼ŒMCPå……å½“äº†AIæ¨¡å‹ä¸ä¸šåŠ¡æ•°æ®ä¹‹é—´çš„æ¡¥æ¢ï¼Œä½¿AIåŠ©æ‰‹èƒ½å¤Ÿæä¾›ç²¾å‡†ã€å®æ—¶çš„å­¦ç”Ÿæˆç»©åˆ†ææœåŠ¡ã€‚ è¿™ç§æ¶æ„ä¸ä»…æé«˜äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼Œè¿˜ä¸ºAIåº”ç”¨çš„å¼€å‘æä¾›äº†æ ‡å‡†åŒ–çš„å·¥å…·é›†æˆæ–¹æ¡ˆã€‚  </p><p>MCPåè®®çš„æ ‡å‡†åŒ–è®¾è®¡è®©å¼€å‘è€…å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘çš„å®ç°ï¼Œè€Œä¸å¿…æ‹…å¿ƒAIæ¨¡å‹ä¸å¤–éƒ¨ç³»ç»Ÿçš„é›†æˆå¤æ‚æ€§ï¼ŒçœŸæ­£å®ç°äº†â€å¤šå¿«å¥½çœâ€çš„AIåº”ç”¨å¼€å‘ç†å¿µã€‚<br>æœªæ¥ï¼Œç›¸ä¿¡éšç€MCPç”Ÿæ€çš„ä¸æ–­å®Œå–„ï¼Œè¿™ç§æ¶æ„æ¨¡å¼å°†åœ¨æ›´å¤šè¡Œä¸šèµ‹èƒ½ï¼Œå½»åº•æ”¹å˜äººæœºäº¤äº’æ¨¡å¼ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h2 id=&quot;ä¸€ã€MCPæ¶æ„åŸç†æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#ä¸€ã€MCPæ¶æ„åŸç†æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€MCPæ¶æ„åŸç†æ¦‚è¿°&quot;&gt;&lt;/a&gt;ä¸€ã€MCPæ¶æ„åŸç†æ¦‚è¿°&lt;/h2&gt;&lt;h3 id=&quot;1-1-MCPåŸºæœ¬æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#1-1-MCPåŸºæœ¬æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;1.1 MCPåŸºæœ¬æ¦‚å¿µ&quot;&gt;&lt;/a&gt;1.1 MCPåŸºæœ¬æ¦‚å¿µ&lt;/h3&gt;&lt;p&gt;MCPï¼ˆModel Context Protocolï¼‰æ˜¯ä¸€ç§æ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œé€šè¿‡ç»Ÿä¸€çš„åè®®è®©AIæ¨¡å‹è¿æ¥å„ç§å·¥å…·å’Œæ•°æ®æºï¼Œç±»ä¼¼äºAIä¸–ç•Œçš„â€USB-Câ€æ¥å£ã€‚&lt;br&gt; è¯¥åè®®é‡‡ç”¨ä¼šè¯å¯¼å‘çš„JSON-RPCæ¡†æ¶ï¼Œä½¿å¤§è¯­è¨€æ¨¡å‹èƒ½å¤Ÿä¸å¤–éƒ¨ç³»ç»Ÿå’Œæ•°æ®æºè¿›è¡Œäº¤äº’ã€‚ MCPæœåŠ¡å™¨å……å½“æ¨¡å‹ä¸æœ¬åœ°ç¯å¢ƒæˆ–å¤–éƒ¨ç³»ç»Ÿçš„æ¡¥æ¢ï¼Œå‘CLIæš´éœ²å·¥å…·å’Œèµ„æºï¼Œå®ç°AIé©±åŠ¨çš„äº¤äº’ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="Demo-AI" scheme="https://www.wdft.com/tags/Demo-AI/"/>
    
    <category term="MCP" scheme="https://www.wdft.com/tags/MCP/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQLæ·±åº¦å®è·µï¼šä»Debian 12å…¥é—¨åˆ°é›†ç¾¤éƒ¨ç½²åŠå¤šè¯­è¨€åº”ç”¨</title>
    <link href="https://www.wdft.com/2d0307b0.html"/>
    <id>https://www.wdft.com/2d0307b0.html</id>
    <published>2025-12-17T15:37:19.000Z</published>
    <updated>2026-01-26T09:46:58.466Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h2 id="PGç®€è¿°"><a href="#PGç®€è¿°" class="headerlink" title="PGç®€è¿°"></a>PGç®€è¿°</h2><p>PostgreSQLä½œä¸ºä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿï¼Œå‡­å€Ÿå…¶å¼ºå¤§çš„åŠŸèƒ½ã€å“è¶Šçš„æ€§èƒ½å’Œä¸¥æ ¼çš„ACIDç‰¹æ€§ï¼Œå·²ç»æˆä¸ºä¼ä¸šçº§åº”ç”¨çš„é¦–é€‰æ•°æ®åº“ä¹‹ä¸€ã€‚<br>æœ¬æ–‡å°†å¸¦é¢†è¯»è€…ä»é›¶å¼€å§‹ï¼Œåœ¨Debian 12ç¯å¢ƒä¸‹æ·±å…¥æŒæ¡PostgreSQLï¼Œæ¶µç›–ç‰ˆæœ¬æ¼”è¿›ã€æ ¸å¿ƒåŸç†ã€å®æˆ˜é…ç½®ã€é›†ç¾¤éƒ¨ç½²ä»¥åŠå¤šè¯­è¨€åº”ç”¨å¼€å‘ï¼Œä¸ºæ•°æ®åº“å·¥ç¨‹å¸ˆå’Œå¼€å‘è€…æä¾›ä¸€å¥—å®Œæ•´çš„å®è·µæŒ‡å—ï¼ŒåŒ…å«å¸¸ç”¨çš„ä¸€äº›è¯­æ³•æ“ä½œå’Œæœ€ä½³å®è·µç­‰ç­‰ã€‚</p><span id="more"></span><hr><h2 id="ç¬¬ä¸€éƒ¨åˆ†ï¼šPostgreSQLç‰ˆæœ¬å†å²ä¸ç‰¹æ€§æ¼”è¿›"><a href="#ç¬¬ä¸€éƒ¨åˆ†ï¼šPostgreSQLç‰ˆæœ¬å†å²ä¸ç‰¹æ€§æ¼”è¿›" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†ï¼šPostgreSQLç‰ˆæœ¬å†å²ä¸ç‰¹æ€§æ¼”è¿›"></a>ç¬¬ä¸€éƒ¨åˆ†ï¼šPostgreSQLç‰ˆæœ¬å†å²ä¸ç‰¹æ€§æ¼”è¿›</h2><h3 id="1-1-ç‰ˆæœ¬å‘å±•è„‰ç»œ"><a href="#1-1-ç‰ˆæœ¬å‘å±•è„‰ç»œ" class="headerlink" title="1.1 ç‰ˆæœ¬å‘å±•è„‰ç»œ"></a>1.1 ç‰ˆæœ¬å‘å±•è„‰ç»œ</h3><p>PostgreSQLçš„å‘å±•å†ç¨‹è§è¯äº†å¼€æºæ•°æ®åº“æŠ€æœ¯çš„æ¼”è¿›ï¼š</p><ul><li><strong>PostgreSQL 7.x (2000-2005)</strong>: ä»Postgres95æ›´åè€Œæ¥ï¼Œå¼•å…¥äº†çœŸæ­£çš„å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰</li><li><strong>PostgreSQL 8.x (2005-2010)</strong>: WindowsåŸç”Ÿæ”¯æŒã€è‡ªåŠ¨æ¸…ç†ã€è¡¨ç©ºé—´ç®¡ç†</li><li><strong>PostgreSQL 9.x (2010-2016)</strong>: æµå¤åˆ¶ã€JSONæ”¯æŒã€ç‰©åŒ–è§†å›¾</li><li><strong>PostgreSQL 10.x (2017)</strong>: é€»è¾‘å¤åˆ¶ã€å£°æ˜å¼åˆ†åŒºã€å¹¶è¡ŒæŸ¥è¯¢å¢å¼º</li><li><strong>PostgreSQL 11.x (2018)</strong>: JITç¼–è¯‘ã€å­˜å‚¨è¿‡ç¨‹ã€åˆ†åŒºè¡¨æ€§èƒ½ä¼˜åŒ–</li><li><strong>PostgreSQL 12.x (2019)</strong>: é€šç”¨è¡¨è¡¨è¾¾å¼ï¼ˆCTEï¼‰æ€§èƒ½ä¼˜åŒ–ã€JSONè·¯å¾„è¡¨è¾¾å¼</li><li><strong>PostgreSQL 13.x (2020)</strong>: å¢é‡æ’åºã€B-treeç´¢å¼•ä¼˜åŒ–ã€é€»è¾‘å¤åˆ¶æ”¹è¿›</li><li><strong>PostgreSQL 14.x (2021)</strong>: å¤šèŒƒå›´ç±»å‹ã€æ•°æ®ç±»å‹ä¼˜åŒ–ã€æ€§èƒ½ç›‘æ§å¢å¼º</li><li><strong>PostgreSQL 15.x (2022)</strong>: MERGEå‘½ä»¤ã€åˆ†å¸ƒå¼SQLåŠŸèƒ½å¢å¼º</li><li><strong>PostgreSQL 16.x (2023)</strong>: é€»è¾‘å¤åˆ¶æ€§èƒ½å¤§å¹…æå‡ã€æŸ¥è¯¢å¹¶è¡ŒåŒ–æ”¹è¿›</li></ul><h3 id="1-2-å…³é”®ç‰¹æ€§å¯¹æ¯”"><a href="#1-2-å…³é”®ç‰¹æ€§å¯¹æ¯”" class="headerlink" title="1.2 å…³é”®ç‰¹æ€§å¯¹æ¯”"></a>1.2 å…³é”®ç‰¹æ€§å¯¹æ¯”</h3><table><thead><tr><th>ç‰¹æ€§</th><th>PostgreSQL 12</th><th>PostgreSQL 14</th><th>PostgreSQL 16</th></tr></thead><tbody><tr><td>é€»è¾‘å¤åˆ¶</td><td>åŸºç¡€æ”¯æŒ</td><td>å¤§å¹…æ”¹è¿›</td><td>æ€§èƒ½æå‡300%</td></tr><tr><td>å¹¶è¡ŒæŸ¥è¯¢</td><td>æœ‰é™æ”¯æŒ</td><td>å¢å¼ºæ”¯æŒ</td><td>å®Œå…¨ä¼˜åŒ–</td></tr><tr><td>JSONæ”¯æŒ</td><td>JSONBç±»å‹</td><td>JSONè·¯å¾„è¡¨è¾¾å¼</td><td>å®Œæ•´SQL&#x2F;JSONæ ‡å‡†</td></tr><tr><td>åˆ†åŒºè¡¨</td><td>å£°æ˜å¼åˆ†åŒº</td><td>æ€§èƒ½ä¼˜åŒ–</td><td>åˆ†åŒºè£å‰ªä¼˜åŒ–</td></tr><tr><td>ç´¢å¼•ç±»å‹</td><td>B-tree, Hash</td><td>BRIN, SP-GiST</td><td>è¦†ç›–ç´¢å¼•ä¼˜åŒ–</td></tr></tbody></table><p><strong>é‡ç‚¹æ³¨æ„äº‹é¡¹</strong>ï¼šç”Ÿäº§ç¯å¢ƒå‡çº§æ—¶ï¼ŒåŠ¡å¿…å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œç‰¹åˆ«æ³¨æ„13+ç‰ˆæœ¬å¯¹æ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§å˜åŒ–ï¼Œå¦‚é»˜è®¤èº«ä»½éªŒè¯æ–¹æ³•ä»peeræ”¹ä¸ºscram-sha-256ã€‚</p><hr><h2 id="ç¬¬äºŒéƒ¨åˆ†ï¼šDebian-12ç¯å¢ƒä¸‹çš„PostgreSQLå®æˆ˜"><a href="#ç¬¬äºŒéƒ¨åˆ†ï¼šDebian-12ç¯å¢ƒä¸‹çš„PostgreSQLå®æˆ˜" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†ï¼šDebian 12ç¯å¢ƒä¸‹çš„PostgreSQLå®æˆ˜"></a>ç¬¬äºŒéƒ¨åˆ†ï¼šDebian 12ç¯å¢ƒä¸‹çš„PostgreSQLå®æˆ˜</h2><h3 id="2-1-å®‰è£…ä¸åŸºç¡€é…ç½®"><a href="#2-1-å®‰è£…ä¸åŸºç¡€é…ç½®" class="headerlink" title="2.1 å®‰è£…ä¸åŸºç¡€é…ç½®"></a>2.1 å®‰è£…ä¸åŸºç¡€é…ç½®</h3><h4 id="2-1-1-å®‰è£…PostgreSQL-16"><a href="#2-1-1-å®‰è£…PostgreSQL-16" class="headerlink" title="2.1.1 å®‰è£…PostgreSQL 16"></a>2.1.1 å®‰è£…PostgreSQL 16</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°ç³»ç»Ÿ</span></span><br><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ å®˜æ–¹ä»“åº“</span></span><br><span class="line">sudo apt install -y curl ca-certificates</span><br><span class="line">curl https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /usr/share/keyrings/postgresql.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/usr/share/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt <span class="subst">$(lsb_release -cs)</span>-pgdg main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/pgdg.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…PostgreSQL 16</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y postgresql-16 postgresql-client-16 postgresql-contrib-16</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> postgresql@16-main</span><br><span class="line">sudo systemctl start postgresql@16-main</span><br></pre></td></tr></table></figure><p><strong>é‡è¦å®‰å…¨é…ç½®</strong>ï¼šå®‰è£…å®Œæˆåç«‹å³ä¿®æ”¹é»˜è®¤postgresç”¨æˆ·çš„å¯†ç ï¼Œå¹¶é…ç½®é€‚å½“çš„è®¿é—®æ§åˆ¶ã€‚</p><h4 id="2-1-2-åŸºç¡€ç›®å½•ç»“æ„"><a href="#2-1-2-åŸºç¡€ç›®å½•ç»“æ„" class="headerlink" title="2.1.2 åŸºç¡€ç›®å½•ç»“æ„"></a>2.1.2 åŸºç¡€ç›®å½•ç»“æ„</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/postgresql/16/main/          # é…ç½®æ–‡ä»¶ç›®å½•</span><br><span class="line">/var/lib/postgresql/16/main/       # æ•°æ®æ–‡ä»¶ç›®å½•</span><br><span class="line">/var/log/postgresql/               # æ—¥å¿—æ–‡ä»¶ç›®å½•</span><br><span class="line">/usr/lib/postgresql/16/bin/        # å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•</span><br></pre></td></tr></table></figure><h3 id="2-2-æ ¸å¿ƒåŸç†ä¸æ¶æ„"><a href="#2-2-æ ¸å¿ƒåŸç†ä¸æ¶æ„" class="headerlink" title="2.2 æ ¸å¿ƒåŸç†ä¸æ¶æ„"></a>2.2 æ ¸å¿ƒåŸç†ä¸æ¶æ„</h3><h4 id="2-2-1-è¿›ç¨‹æ¶æ„"><a href="#2-2-1-è¿›ç¨‹æ¶æ„" class="headerlink" title="2.2.1 è¿›ç¨‹æ¶æ„"></a>2.2.1 è¿›ç¨‹æ¶æ„</h4><p>PostgreSQLé‡‡ç”¨å¤šè¿›ç¨‹æ¶æ„ï¼Œä¸»è¦è¿›ç¨‹åŒ…æ‹¬ï¼š</p><ul><li><strong>Postmasterè¿›ç¨‹</strong>ï¼šä¸»è¿›ç¨‹ï¼Œè´Ÿè´£ç›‘å¬è¿æ¥å’Œspawnå­è¿›ç¨‹</li><li><strong>Backendè¿›ç¨‹</strong>ï¼šæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥å¯¹åº”ä¸€ä¸ªbackendè¿›ç¨‹</li><li><strong>Checkpointerè¿›ç¨‹</strong>ï¼šè´Ÿè´£æ£€æŸ¥ç‚¹æ“ä½œ</li><li><strong>WAL Writerè¿›ç¨‹</strong>ï¼šè´Ÿè´£WALæ—¥å¿—å†™å…¥</li><li><strong>Autovacuumè¿›ç¨‹</strong>ï¼šè‡ªåŠ¨æ¸…ç†æ­»å…ƒç»„</li><li><strong>Background Writerè¿›ç¨‹</strong>ï¼šåå°å†™å…¥è„é¡µ</li></ul><h4 id="2-2-2-å­˜å‚¨ç»“æ„"><a href="#2-2-2-å­˜å‚¨ç»“æ„" class="headerlink" title="2.2.2 å­˜å‚¨ç»“æ„"></a>2.2.2 å­˜å‚¨ç»“æ„</h4><ul><li><strong>è¡¨ç©ºé—´ï¼ˆTablespaceï¼‰</strong>ï¼šç‰©ç†å­˜å‚¨ä½ç½®</li><li><strong>æ•°æ®åº“ï¼ˆDatabaseï¼‰</strong>ï¼šé€»è¾‘å®¹å™¨</li><li><strong>æ¨¡å¼ï¼ˆSchemaï¼‰</strong>ï¼šå‘½åç©ºé—´</li><li><strong>è¡¨ï¼ˆTableï¼‰</strong>ï¼šæ•°æ®å­˜å‚¨å•ä½</li><li><strong>é¡µé¢ï¼ˆPageï¼‰</strong>ï¼š8KBçš„åŸºæœ¬IOå•ä½</li></ul><p><strong>æ€§èƒ½å…³é”®ç‚¹</strong>ï¼šåˆç†é…ç½®shared_buffersï¼ˆé€šå¸¸ä¸ºç‰©ç†å†…å­˜çš„25%ï¼‰å’Œwork_memï¼ˆæ ¹æ®å¹¶å‘æŸ¥è¯¢æ•°è°ƒæ•´ï¼‰å¯¹æ€§èƒ½è‡³å…³é‡è¦ã€‚</p><h3 id="2-3-åŸºç¡€è¯­æ³•ä¸é«˜çº§ç‰¹æ€§"><a href="#2-3-åŸºç¡€è¯­æ³•ä¸é«˜çº§ç‰¹æ€§" class="headerlink" title="2.3 åŸºç¡€è¯­æ³•ä¸é«˜çº§ç‰¹æ€§"></a>2.3 åŸºç¡€è¯­æ³•ä¸é«˜çº§ç‰¹æ€§</h3><h4 id="2-3-1-åŸºç¡€CRUDæ“ä½œ"><a href="#2-3-1-åŸºç¡€CRUDæ“ä½œ" class="headerlink" title="2.3.1 åŸºç¡€CRUDæ“ä½œ"></a>2.3.1 åŸºç¡€CRUDæ“ä½œ</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºæ•°æ®åº“</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE demo_db OWNER postgres;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºè¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> users (</span><br><span class="line">    id SERIAL <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">150</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    is_active <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">true</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ’å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (name, email) <span class="keyword">VALUES</span> </span><br><span class="line">(<span class="string">&#x27;å¼ ä¸‰&#x27;</span>, <span class="string">&#x27;zhangsan@example.com&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;æå››&#x27;</span>, <span class="string">&#x27;lisi@example.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥è¯¢æ•°æ®</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> is_active <span class="operator">=</span> <span class="literal">true</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> created_at <span class="keyword">DESC</span> LIMIT <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ›´æ–°æ•°æ®</span></span><br><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> is_active <span class="operator">=</span> <span class="literal">false</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤æ•°æ®</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> created_at <span class="operator">&lt;</span> NOW() <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="string">&#x27;1 year&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="2-3-2-é«˜çº§ç‰¹æ€§å®æˆ˜"><a href="#2-3-2-é«˜çº§ç‰¹æ€§å®æˆ˜" class="headerlink" title="2.3.2 é«˜çº§ç‰¹æ€§å®æˆ˜"></a>2.3.2 é«˜çº§ç‰¹æ€§å®æˆ˜</h4><p><strong>JSONBæ“ä½œ</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºJSONBå­—æ®µè¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> products (</span><br><span class="line">    id SERIAL <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    attributes JSONB</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ’å…¥JSONæ•°æ®</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> products (name, attributes) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;ç¬”è®°æœ¬ç”µè„‘&#x27;</span>, <span class="string">&#x27;&#123;&quot;brand&quot;: &quot;Dell&quot;, &quot;price&quot;: 8999, &quot;specs&quot;: &#123;&quot;cpu&quot;: &quot;i7&quot;, &quot;ram&quot;: &quot;16GB&quot;&#125;&#125;&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;æ™ºèƒ½æ‰‹æœº&#x27;</span>, <span class="string">&#x27;&#123;&quot;brand&quot;: &quot;Apple&quot;, &quot;price&quot;: 6999, &quot;specs&quot;: &#123;&quot;storage&quot;: &quot;256GB&quot;, &quot;color&quot;: &quot;black&quot;&#125;&#125;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- JSONBæŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> name, attributes<span class="operator">-</span><span class="operator">&gt;&gt;</span><span class="string">&#x27;brand&#x27;</span> <span class="keyword">as</span> brand, attributes<span class="operator">-</span><span class="operator">&gt;</span><span class="string">&#x27;specs&#x27;</span><span class="operator">-</span><span class="operator">&gt;&gt;</span><span class="string">&#x27;cpu&#x27;</span> <span class="keyword">as</span> cpu</span><br><span class="line"><span class="keyword">FROM</span> products</span><br><span class="line"><span class="keyword">WHERE</span> attributes @<span class="operator">&gt;</span> <span class="string">&#x27;&#123;&quot;brand&quot;: &quot;Dell&quot;&#125;&#x27;</span>;</span><br></pre></td></tr></table></figure><p><strong>çª—å£å‡½æ•°</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- é”€å”®æ•°æ®åˆ†æ</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    department,</span><br><span class="line">    employee_name,</span><br><span class="line">    salary,</span><br><span class="line">    <span class="built_in">AVG</span>(salary) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> department) <span class="keyword">as</span> dept_avg_salary,</span><br><span class="line">    <span class="built_in">RANK</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> department <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">as</span> salary_rank</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure><p><strong>é‡ç‚¹æ³¨æ„äº‹é¡¹</strong>ï¼šä½¿ç”¨JSONBæ—¶ï¼Œå»ºè®®ä¸ºå¸¸ç”¨æŸ¥è¯¢è·¯å¾„åˆ›å»ºGINç´¢å¼•ï¼›çª—å£å‡½æ•°åœ¨å¤§æ•°æ®é‡æ—¶å¯èƒ½å½±å“æ€§èƒ½ï¼Œéœ€è¦åˆç†ä½¿ç”¨ã€‚</p><hr><h2 id="ç¬¬ä¸‰éƒ¨åˆ†ï¼šä»å•ä½“åˆ°é›†ç¾¤çš„æ¼”è¿›"><a href="#ç¬¬ä¸‰éƒ¨åˆ†ï¼šä»å•ä½“åˆ°é›†ç¾¤çš„æ¼”è¿›" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ†ï¼šä»å•ä½“åˆ°é›†ç¾¤çš„æ¼”è¿›"></a>ç¬¬ä¸‰éƒ¨åˆ†ï¼šä»å•ä½“åˆ°é›†ç¾¤çš„æ¼”è¿›</h2><h3 id="3-1-å•ä½“æ¶æ„ä¼˜åŒ–"><a href="#3-1-å•ä½“æ¶æ„ä¼˜åŒ–" class="headerlink" title="3.1 å•ä½“æ¶æ„ä¼˜åŒ–"></a>3.1 å•ä½“æ¶æ„ä¼˜åŒ–</h3><h4 id="3-1-1-é…ç½®æ–‡ä»¶ä¼˜åŒ–"><a href="#3-1-1-é…ç½®æ–‡ä»¶ä¼˜åŒ–" class="headerlink" title="3.1.1 é…ç½®æ–‡ä»¶ä¼˜åŒ–"></a>3.1.1 é…ç½®æ–‡ä»¶ä¼˜åŒ–</h4><p>ç¼–è¾‘ <code>/etc/postgresql/16/main/postgresql.conf</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># å†…å­˜é…ç½®</span><br><span class="line">shared_buffers = 4GB                   # ç‰©ç†å†…å­˜çš„25%</span><br><span class="line">effective_cache_size = 12GB            # ç‰©ç†å†…å­˜çš„75%</span><br><span class="line">work_mem = 64MB                        # æ¯ä¸ªæ’åºæ“ä½œçš„å†…å­˜</span><br><span class="line">maintenance_work_mem = 512MB           # ç»´æŠ¤æ“ä½œå†…å­˜</span><br><span class="line"></span><br><span class="line"># WALé…ç½®</span><br><span class="line">wal_level = replica                    # æ”¯æŒå¤åˆ¶</span><br><span class="line">max_wal_senders = 10                   # æœ€å¤§WALå‘é€è¿›ç¨‹æ•°</span><br><span class="line">wal_keep_size = 1GB                    # ä¿ç•™çš„WALæ–‡ä»¶å¤§å°</span><br><span class="line"></span><br><span class="line"># è¿æ¥é…ç½®</span><br><span class="line">max_connections = 200                  # æœ€å¤§è¿æ¥æ•°</span><br><span class="line">superuser_reserved_connections = 5     # ä¿ç•™ç»™è¶…çº§ç”¨æˆ·çš„è¿æ¥</span><br><span class="line"></span><br><span class="line"># å¹¶è¡ŒæŸ¥è¯¢</span><br><span class="line">max_parallel_workers_per_gather = 4    # æ¯ä¸ªæŸ¥è¯¢çš„æœ€å¤§å¹¶è¡Œworker</span><br><span class="line">max_parallel_workers = 8               # ç³»ç»Ÿæœ€å¤§å¹¶è¡Œworker</span><br></pre></td></tr></table></figure><h4 id="3-1-2-æ€§èƒ½ç›‘æ§"><a href="#3-1-2-æ€§èƒ½ç›‘æ§" class="headerlink" title="3.1.2 æ€§èƒ½ç›‘æ§"></a>3.1.2 æ€§èƒ½ç›‘æ§</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å®‰è£…ç›‘æ§æ‰©å±•</span></span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> pg_stat_statements;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æŸ¥çœ‹æ…¢æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">SELECT</span> query, calls, total_exec_time, <span class="keyword">rows</span> </span><br><span class="line"><span class="keyword">FROM</span> pg_stat_statements </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_exec_time <span class="keyword">DESC</span> </span><br><span class="line">LIMIT <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç´¢å¼•ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    schemaname,</span><br><span class="line">    tablename,</span><br><span class="line">    indexname,</span><br><span class="line">    idx_scan <span class="keyword">as</span> index_scans,</span><br><span class="line">    idx_tup_read <span class="keyword">as</span> tuples_read</span><br><span class="line"><span class="keyword">FROM</span> pg_stat_user_indexes</span><br><span class="line"><span class="keyword">WHERE</span> schemaname <span class="operator">=</span> <span class="string">&#x27;public&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> idx_scan <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h3 id="3-2-ä¸»ä»å¤åˆ¶é…ç½®"><a href="#3-2-ä¸»ä»å¤åˆ¶é…ç½®" class="headerlink" title="3.2 ä¸»ä»å¤åˆ¶é…ç½®"></a>3.2 ä¸»ä»å¤åˆ¶é…ç½®</h3><h4 id="3-2-1-ä¸»æœåŠ¡å™¨é…ç½®"><a href="#3-2-1-ä¸»æœåŠ¡å™¨é…ç½®" class="headerlink" title="3.2.1 ä¸»æœåŠ¡å™¨é…ç½®"></a>3.2.1 ä¸»æœåŠ¡å™¨é…ç½®</h4><ol><li><p>ä¿®æ”¹ä¸»æœåŠ¡å™¨postgresql.confï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wal_level = replica</span><br><span class="line">max_wal_senders = 10</span><br><span class="line">wal_keep_size = 1GB</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®pg_hba.confï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># å…è®¸ä»æœåŠ¡å™¨è¿æ¥</span><br><span class="line">host    replication     replicator      192.168.1.101/32        scram-sha-256</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºå¤åˆ¶ç”¨æˆ·ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> ROLE replicator <span class="keyword">WITH</span> REPLICATION LOGIN PASSWORD <span class="string">&#x27;secure_password&#x27;</span>;</span><br></pre></td></tr></table></figure></li></ol><h4 id="3-2-2-ä»æœåŠ¡å™¨é…ç½®"><a href="#3-2-2-ä»æœåŠ¡å™¨é…ç½®" class="headerlink" title="3.2.2 ä»æœåŠ¡å™¨é…ç½®"></a>3.2.2 ä»æœåŠ¡å™¨é…ç½®</h4><ol><li><p>åœæ­¢ä»æœåŠ¡å™¨PostgreSQLæœåŠ¡</p></li><li><p>ä½¿ç”¨pg_basebackupåŒæ­¥æ•°æ®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres pg_basebackup -h 192.168.1.100 -U replicator -D /var/lib/postgresql/16/main -P -v -R -X stream</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹recovery.confï¼ˆPostgreSQL 12+åœ¨postgresql.confä¸­é…ç½®ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">primary_conninfo = &#x27;host=192.168.1.100 port=5432 user=replicator password=secure_password&#x27;</span><br><span class="line">standby_mode = on</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ä»æœåŠ¡å™¨</p></li></ol><p><strong>å…³é”®æ³¨æ„äº‹é¡¹</strong>ï¼šä¸»ä»å¤åˆ¶å»¶è¿Ÿç›‘æ§è‡³å…³é‡è¦ï¼Œä½¿ç”¨<code>pg_stat_replication</code>è§†å›¾å®æ—¶ç›‘æ§å¤åˆ¶çŠ¶æ€ï¼Œè®¾ç½®åˆç†çš„ç›‘æ§å‘Šè­¦é˜ˆå€¼ã€‚</p><h3 id="3-3-é›†ç¾¤éƒ¨ç½²æ–¹æ¡ˆ"><a href="#3-3-é›†ç¾¤éƒ¨ç½²æ–¹æ¡ˆ" class="headerlink" title="3.3 é›†ç¾¤éƒ¨ç½²æ–¹æ¡ˆ"></a>3.3 é›†ç¾¤éƒ¨ç½²æ–¹æ¡ˆ</h3><h4 id="3-3-1-ä½¿ç”¨Patroniå®ç°é«˜å¯ç”¨"><a href="#3-3-1-ä½¿ç”¨Patroniå®ç°é«˜å¯ç”¨" class="headerlink" title="3.3.1 ä½¿ç”¨Patroniå®ç°é«˜å¯ç”¨"></a>3.3.1 ä½¿ç”¨Patroniå®ç°é«˜å¯ç”¨</h4><p>Patroniæ˜¯ä¸€ä¸ªåŸºäºetcdçš„PostgreSQLé«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># patroni.yml é…ç½®ç¤ºä¾‹</span></span><br><span class="line"><span class="attr">scope:</span> <span class="string">postgres-cluster</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">pg-node-1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">restapi:</span></span><br><span class="line">  <span class="attr">listen:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8008</span></span><br><span class="line">  <span class="attr">connect_address:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:8008</span></span><br><span class="line"></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;192.168.1.200:2379&quot;</span>, <span class="string">&quot;192.168.1.201:2379&quot;</span>, <span class="string">&quot;192.168.1.202:2379&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">bootstrap:</span></span><br><span class="line">  <span class="attr">dcs:</span></span><br><span class="line">    <span class="attr">ttl:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">loop_wait:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">retry_timeout:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">maximum_lag_on_failover:</span> <span class="number">1048576</span></span><br><span class="line">    <span class="attr">postgresql:</span></span><br><span class="line">      <span class="attr">use_pg_rewind:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="attr">wal_level:</span> <span class="string">replica</span></span><br><span class="line">        <span class="attr">hot_standby:</span> <span class="string">&quot;on&quot;</span></span><br><span class="line">        <span class="attr">max_connections:</span> <span class="number">200</span></span><br><span class="line">        <span class="attr">max_wal_senders:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">wal_keep_size:</span> <span class="string">1GB</span></span><br><span class="line"></span><br><span class="line"><span class="attr">postgresql:</span></span><br><span class="line">  <span class="attr">listen:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:5432</span></span><br><span class="line">  <span class="attr">connect_address:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span><span class="string">:5432</span></span><br><span class="line">  <span class="attr">data_dir:</span> <span class="string">/var/lib/postgresql/16/main</span></span><br><span class="line">  <span class="attr">bin_dir:</span> <span class="string">/usr/lib/postgresql/16/bin</span></span><br><span class="line">  <span class="attr">authentication:</span></span><br><span class="line">    <span class="attr">replication:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">replicator</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">secure_password</span></span><br><span class="line">    <span class="attr">superuser:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">super_secure_password</span></span><br></pre></td></tr></table></figure><p><strong>é›†ç¾¤è¿ç»´è¦ç‚¹</strong>ï¼šå®šæœŸè¿›è¡Œæ•…éšœåˆ‡æ¢æ¼”ç»ƒï¼Œç›‘æ§etcdé›†ç¾¤å¥åº·çŠ¶æ€ï¼Œç¡®ä¿ç½‘ç»œå»¶è¿Ÿåœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆé€šå¸¸&lt;10msï¼‰ã€‚</p><hr><h2 id="ç¬¬å››éƒ¨åˆ†ï¼šDockerå®¹å™¨åŒ–éƒ¨ç½²"><a href="#ç¬¬å››éƒ¨åˆ†ï¼šDockerå®¹å™¨åŒ–éƒ¨ç½²" class="headerlink" title="ç¬¬å››éƒ¨åˆ†ï¼šDockerå®¹å™¨åŒ–éƒ¨ç½²"></a>ç¬¬å››éƒ¨åˆ†ï¼šDockerå®¹å™¨åŒ–éƒ¨ç½²</h2><h3 id="4-1-å•å®¹å™¨éƒ¨ç½²"><a href="#4-1-å•å®¹å™¨éƒ¨ç½²" class="headerlink" title="4.1 å•å®¹å™¨éƒ¨ç½²"></a>4.1 å•å®¹å™¨éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–å®˜æ–¹é•œåƒ</span></span><br><span class="line">docker pull postgres:16-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œå®¹å™¨</span></span><br><span class="line">docker run -d \</span><br><span class="line">  --name postgres-single \</span><br><span class="line">  -p 5432:5432 \</span><br><span class="line">  -e POSTGRES_USER=admin \</span><br><span class="line">  -e POSTGRES_PASSWORD=secure_password \</span><br><span class="line">  -e POSTGRES_DB=myapp \</span><br><span class="line">  -v postgres_data:/var/lib/postgresql/data \</span><br><span class="line">  -v ./init-scripts:/docker-entrypoint-initdb.d \</span><br><span class="line">  --restart unless-stopped \</span><br><span class="line">  postgres:16-alpine</span><br></pre></td></tr></table></figure><p><strong>init-scripts&#x2F;01-init.sql</strong>ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> app_config (</span><br><span class="line">    key <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    <span class="keyword">value</span> TEXT,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> app_config (key, <span class="keyword">value</span>) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;app_name&#x27;</span>, <span class="string">&#x27;My Application&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;version&#x27;</span>, <span class="string">&#x27;1.0.0&#x27;</span>),</span><br><span class="line">(<span class="string">&#x27;maintenance_mode&#x27;</span>, <span class="string">&#x27;false&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="4-2-Docker-Composeå¤šå®¹å™¨ç¼–æ’"><a href="#4-2-Docker-Composeå¤šå®¹å™¨ç¼–æ’" class="headerlink" title="4.2 Docker Composeå¤šå®¹å™¨ç¼–æ’"></a>4.2 Docker Composeå¤šå®¹å™¨ç¼–æ’</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">postgres-primary:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:16-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">pg-primary</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">replicator</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">replica_password</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">replication_db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pg_primary_data:/var/lib/postgresql/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf/postgresql.conf:/etc/postgresql/postgresql.conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5432:5432&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pg-network</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">postgres-replica:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:16-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">pg-replica</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">replicator</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">replica_password</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">replication_db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pg_replica_data:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">postgres-primary</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pg-network</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">pgadmin:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">dpage/pgadmin4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">pgadmin</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">PGADMIN_DEFAULT_EMAIL:</span> <span class="string">admin@example.com</span></span><br><span class="line">      <span class="attr">PGADMIN_DEFAULT_PASSWORD:</span> <span class="string">pgadmin_password</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pg-network</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">pg_primary_data:</span></span><br><span class="line">  <span class="attr">pg_replica_data:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">pg-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><h3 id="4-3-é›†ç¾¤å®¹å™¨åŒ–æ–¹æ¡ˆ"><a href="#4-3-é›†ç¾¤å®¹å™¨åŒ–æ–¹æ¡ˆ" class="headerlink" title="4.3 é›†ç¾¤å®¹å™¨åŒ–æ–¹æ¡ˆ"></a>4.3 é›†ç¾¤å®¹å™¨åŒ–æ–¹æ¡ˆ</h3><p>ä½¿ç”¨Docker Swarmæˆ–Kuberneteséƒ¨ç½²PostgreSQLé›†ç¾¤ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubernetes-postgres-statefulset.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">postgres:16-alpine</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">postgres-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/postgresql/data</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgres-storage</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">100Gi</span></span><br></pre></td></tr></table></figure><p><strong>å®¹å™¨åŒ–æ³¨æ„äº‹é¡¹</strong>ï¼š</p><ul><li>ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä½¿ç”¨æŒä¹…åŒ–å·ï¼Œé¿å…æ•°æ®ä¸¢å¤±</li><li>åˆç†é…ç½®èµ„æºé™åˆ¶ï¼ˆCPUã€å†…å­˜ï¼‰</li><li>ä½¿ç”¨secretç®¡ç†æ•æ„Ÿä¿¡æ¯</li><li>å®šæœŸå¤‡ä»½å®¹å™¨å†…æ•°æ®</li></ul><hr><h2 id="ç¬¬äº”éƒ¨åˆ†ï¼šå¤šè¯­è¨€åº”ç”¨å¼€å‘å®æˆ˜"><a href="#ç¬¬äº”éƒ¨åˆ†ï¼šå¤šè¯­è¨€åº”ç”¨å¼€å‘å®æˆ˜" class="headerlink" title="ç¬¬äº”éƒ¨åˆ†ï¼šå¤šè¯­è¨€åº”ç”¨å¼€å‘å®æˆ˜"></a>ç¬¬äº”éƒ¨åˆ†ï¼šå¤šè¯­è¨€åº”ç”¨å¼€å‘å®æˆ˜</h2><h3 id="5-1-PHPæ“ä½œPostgreSQL"><a href="#5-1-PHPæ“ä½œPostgreSQL" class="headerlink" title="5.1 PHPæ“ä½œPostgreSQL"></a>5.1 PHPæ“ä½œPostgreSQL</h3><h4 id="5-1-1-ç¯å¢ƒé…ç½®"><a href="#5-1-1-ç¯å¢ƒé…ç½®" class="headerlink" title="5.1.1 ç¯å¢ƒé…ç½®"></a>5.1.1 ç¯å¢ƒé…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…PHP PostgreSQLæ‰©å±•</span></span><br><span class="line">sudo apt install -y php-pgsql</span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h4 id="5-1-2-å®Œæ•´ç¤ºä¾‹"><a href="#5-1-2-å®Œæ•´ç¤ºä¾‹" class="headerlink" title="5.1.2 å®Œæ•´ç¤ºä¾‹"></a>5.1.2 å®Œæ•´ç¤ºä¾‹</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PostgreSQL PHPæ“ä½œå®Œæ•´ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"> * åŒ…å«è¿æ¥æ± ã€äº‹åŠ¡ã€é¢„å¤„ç†è¯­å¥ç­‰æœ€ä½³å®è·µ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostgreSQLService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$connection</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$config</span> = [</span><br><span class="line">        <span class="string">&#x27;host&#x27;</span> =&gt; <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;port&#x27;</span> =&gt; <span class="number">5432</span>,</span><br><span class="line">        <span class="string">&#x27;dbname&#x27;</span> =&gt; <span class="string">&#x27;myapp&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span> =&gt; <span class="string">&#x27;app_user&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span> =&gt; <span class="string">&#x27;secure_password&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;options&#x27;</span> =&gt; <span class="string">&#x27;--client_encoding=UTF8&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">connect</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$dsn</span> = <span class="title function_ invoke__">sprintf</span>(</span><br><span class="line">            <span class="string">&quot;pgsql:host=%s;port=%s;dbname=%s;options=&#x27;%s&#x27;&quot;</span>,</span><br><span class="line">            <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;host&#x27;</span>],</span><br><span class="line">            <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;port&#x27;</span>],</span><br><span class="line">            <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;dbname&#x27;</span>],</span><br><span class="line">            <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;options&#x27;</span>]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;connection = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="variable">$dsn</span>, <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;user&#x27;</span>], <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;password&#x27;</span>], [</span><br><span class="line">                PDO::<span class="variable constant_">ATTR_ERRMODE</span> =&gt; PDO::<span class="variable constant_">ERRMODE_EXCEPTION</span>,</span><br><span class="line">                PDO::<span class="variable constant_">ATTR_DEFAULT_FETCH_MODE</span> =&gt; PDO::<span class="variable constant_">FETCH_ASSOC</span>,</span><br><span class="line">                PDO::<span class="variable constant_">ATTR_EMULATE_PREPARES</span> =&gt; <span class="literal">false</span></span><br><span class="line">            ]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">error_log</span>(<span class="string">&quot;Database connection failed: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Database connection failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºç”¨æˆ·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createUser</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$email</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;INSERT INTO users (name, email, created_at) VALUES (?, ?, NOW()) RETURNING id&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$query</span>);</span><br><span class="line">            <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$name</span>, <span class="variable">$email</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetchColumn</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">error_log</span>(<span class="string">&quot;Create user failed: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Failed to create user&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç”¨æˆ·è¯¦æƒ…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params"><span class="variable">$userId</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;SELECT id, name, email, created_at FROM users WHERE id = ? AND is_active = true&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$query</span>);</span><br><span class="line">            <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$userId</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">error_log</span>(<span class="string">&quot;Get user failed: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserList</span>(<span class="params"><span class="variable">$page</span> = <span class="number">1</span>, <span class="variable">$pageSize</span> = <span class="number">20</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$offset</span> = (<span class="variable">$page</span> - <span class="number">1</span>) * <span class="variable">$pageSize</span>;</span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;SELECT id, name, email, created_at FROM users WHERE is_active = true ORDER BY created_at DESC LIMIT ? OFFSET ?&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$query</span>);</span><br><span class="line">            <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$pageSize</span>, <span class="variable">$offset</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetchAll</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">error_log</span>(<span class="string">&quot;Get user list failed: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">            <span class="keyword">return</span> [];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº‹åŠ¡æ“ä½œç¤ºä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">transferMoney</span>(<span class="params"><span class="variable">$fromUserId</span>, <span class="variable">$toUserId</span>, <span class="variable">$amount</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">beginTransaction</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ£€æŸ¥ä½™é¢</span></span><br><span class="line">            <span class="variable">$checkQuery</span> = <span class="string">&quot;SELECT balance FROM accounts WHERE user_id = ? FOR UPDATE&quot;</span>;</span><br><span class="line">            <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$checkQuery</span>);</span><br><span class="line">            <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$fromUserId</span>]);</span><br><span class="line">            <span class="variable">$fromBalance</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetchColumn</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$fromBalance</span> &lt; <span class="variable">$amount</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Insufficient balance&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ‰£æ¬¾</span></span><br><span class="line">            <span class="variable">$debitQuery</span> = <span class="string">&quot;UPDATE accounts SET balance = balance - ? WHERE user_id = ?&quot;</span>;</span><br><span class="line">            <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$debitQuery</span>);</span><br><span class="line">            <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$amount</span>, <span class="variable">$fromUserId</span>]);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å…¥è´¦</span></span><br><span class="line">            <span class="variable">$creditQuery</span> = <span class="string">&quot;UPDATE accounts SET balance = balance + ? WHERE user_id = ?&quot;</span>;</span><br><span class="line">            <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$creditQuery</span>);</span><br><span class="line">            <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$amount</span>, <span class="variable">$toUserId</span>]);</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">commit</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">rollBack</span>();</span><br><span class="line">            <span class="title function_ invoke__">error_log</span>(<span class="string">&quot;Transaction failed: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">            <span class="keyword">throw</span> <span class="variable">$e</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JSONBæ•°æ®æ“ä½œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateUserProfile</span>(<span class="params"><span class="variable">$userId</span>, <span class="keyword">array</span> <span class="variable">$profileData</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$jsonData</span> = <span class="title function_ invoke__">json_encode</span>(<span class="variable">$profileData</span>, JSON_UNESCAPED_UNICODE);</span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;UPDATE users SET profile_data = ?::jsonb WHERE id = ?&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$query</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$jsonData</span>, <span class="variable">$userId</span>]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">error_log</span>(<span class="string">&quot;Update profile failed: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;connection = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">PostgreSQLService</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">createUser</span>(<span class="string">&#x27;ç‹äº”&#x27;</span>, <span class="string">&#x27;wangwu@example.com&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Created user with ID: <span class="subst">$userId</span>\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç”¨æˆ·</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">getUser</span>(<span class="variable">$userId</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$user</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;User found: &quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$user</span>, <span class="literal">true</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// äº‹åŠ¡æ“ä½œ</span></span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">transferMoney</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">100.00</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Money transfer successful\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Error: &quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-Golangæ“ä½œPostgreSQL"><a href="#5-2-Golangæ“ä½œPostgreSQL" class="headerlink" title="5.2 Golangæ“ä½œPostgreSQL"></a>5.2 Golangæ“ä½œPostgreSQL</h3><h4 id="5-2-1-ä¾èµ–å®‰è£…"><a href="#5-2-1-ä¾èµ–å®‰è£…" class="headerlink" title="5.2.1 ä¾èµ–å®‰è£…"></a>5.2.1 ä¾èµ–å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/jackc/pgx/v5</span><br><span class="line">go get github.com/jackc/pgx/v5/pgxpool</span><br></pre></td></tr></table></figure><h4 id="5-2-2-å®Œæ•´ç¤ºä¾‹"><a href="#5-2-2-å®Œæ•´ç¤ºä¾‹" class="headerlink" title="5.2.2 å®Œæ•´ç¤ºä¾‹"></a>5.2.2 å®Œæ•´ç¤ºä¾‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/jackc/pgx/v5&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/jackc/pgx/v5/pgxpool&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°æ®åº“é…ç½®</span></span><br><span class="line"><span class="keyword">type</span> DBConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">Host     <span class="type">string</span></span><br><span class="line">Port     <span class="type">int</span></span><br><span class="line">User     <span class="type">string</span></span><br><span class="line">Password <span class="type">string</span></span><br><span class="line">Database <span class="type">string</span></span><br><span class="line">MaxConns <span class="type">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æˆ·æ¨¡å‹</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">ID        <span class="type">int64</span>     <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">Name      <span class="type">string</span>    <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">Email     <span class="type">string</span>    <span class="string">`json:&quot;email&quot;`</span></span><br><span class="line">CreatedAt time.Time <span class="string">`json:&quot;created_at&quot;`</span></span><br><span class="line">IsActive  <span class="type">bool</span>      <span class="string">`json:&quot;is_active&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PostgreSQLæœåŠ¡</span></span><br><span class="line"><span class="keyword">type</span> PostgreSQLService <span class="keyword">struct</span> &#123;</span><br><span class="line">pool *pgxpool.Pool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPostgreSQLService</span><span class="params">(config *DBConfig)</span></span> (*PostgreSQLService, <span class="type">error</span>) &#123;</span><br><span class="line">connStr := fmt.Sprintf(<span class="string">&quot;postgres://%s:%s@%s:%d/%s?pool_max_conns=%d&quot;</span>,</span><br><span class="line">config.User,</span><br><span class="line">config.Password,</span><br><span class="line">config.Host,</span><br><span class="line">config.Port,</span><br><span class="line">config.Database,</span><br><span class="line">config.MaxConns)</span><br><span class="line"></span><br><span class="line">pool, err := pgxpool.New(context.Background(), connStr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to create connection pool: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•è¿æ¥</span></span><br><span class="line"><span class="keyword">if</span> err := pool.Ping(context.Background()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">pool.Close()</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to ping database: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;PostgreSQLService&#123;pool: pool&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­è¿æ¥æ± </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PostgreSQLService)</span></span> Close() &#123;</span><br><span class="line">s.pool.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PostgreSQLService)</span></span> CreateUser(ctx context.Context, name, email <span class="type">string</span>) (<span class="type">int64</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> userID <span class="type">int64</span></span><br><span class="line">err := s.pool.QueryRow(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">INSERT INTO users (name, email, created_at, is_active)</span></span><br><span class="line"><span class="string">VALUES ($1, $2, NOW(), true)</span></span><br><span class="line"><span class="string">RETURNING id</span></span><br><span class="line"><span class="string">`</span>, name, email).Scan(&amp;userID)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> userID, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PostgreSQLService)</span></span> GetUser(ctx context.Context, userID <span class="type">int64</span>) (*User, <span class="type">error</span>) &#123;</span><br><span class="line">user := &amp;User&#123;&#125;</span><br><span class="line">err := s.pool.QueryRow(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">SELECT id, name, email, created_at, is_active</span></span><br><span class="line"><span class="string">FROM users</span></span><br><span class="line"><span class="string">WHERE id = $1 AND is_active = true</span></span><br><span class="line"><span class="string">`</span>, userID).Scan(</span><br><span class="line">&amp;user.ID,</span><br><span class="line">&amp;user.Name,</span><br><span class="line">&amp;user.Email,</span><br><span class="line">&amp;user.CreatedAt,</span><br><span class="line">&amp;user.IsActive,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err == pgx.ErrNoRows &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> user, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PostgreSQLService)</span></span> GetUserList(ctx context.Context, page, pageSize <span class="type">int</span>) ([]User, <span class="type">error</span>) &#123;</span><br><span class="line">offset := (page - <span class="number">1</span>) * pageSize</span><br><span class="line">rows, err := s.pool.Query(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">SELECT id, name, email, created_at, is_active</span></span><br><span class="line"><span class="string">FROM users</span></span><br><span class="line"><span class="string">WHERE is_active = true</span></span><br><span class="line"><span class="string">ORDER BY created_at DESC</span></span><br><span class="line"><span class="string">LIMIT $1 OFFSET $2</span></span><br><span class="line"><span class="string">`</span>, pageSize, offset)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"><span class="keyword">var</span> user User</span><br><span class="line"><span class="keyword">if</span> err := rows.Scan(</span><br><span class="line">&amp;user.ID,</span><br><span class="line">&amp;user.Name,</span><br><span class="line">&amp;user.Email,</span><br><span class="line">&amp;user.CreatedAt,</span><br><span class="line">&amp;user.IsActive,</span><br><span class="line">); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">users = <span class="built_in">append</span>(users, user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> users, rows.Err()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹åŠ¡æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PostgreSQLService)</span></span> TransferMoney(ctx context.Context, fromUserID, toUserID <span class="type">int64</span>, amount <span class="type">float64</span>) <span class="type">error</span> &#123;</span><br><span class="line">tx, err := s.pool.Begin(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">tx.Rollback(ctx)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ä½™é¢</span></span><br><span class="line"><span class="keyword">var</span> fromBalance <span class="type">float64</span></span><br><span class="line">err = tx.QueryRow(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">SELECT balance FROM accounts WHERE user_id = $1 FOR UPDATE</span></span><br><span class="line"><span class="string">`</span>, fromUserID).Scan(&amp;fromBalance)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> fromBalance &lt; amount &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;insufficient balance&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰£æ¬¾</span></span><br><span class="line">_, err = tx.Exec(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">UPDATE accounts SET balance = balance - $1 WHERE user_id = $2</span></span><br><span class="line"><span class="string">`</span>, amount, fromUserID)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¥è´¦</span></span><br><span class="line">_, err = tx.Exec(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">UPDATE accounts SET balance = balance + $1 WHERE user_id = $2</span></span><br><span class="line"><span class="string">`</span>, amount, toUserID)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> tx.Commit(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSONBæ•°æ®æ“ä½œ</span></span><br><span class="line"><span class="keyword">type</span> UserProfile <span class="keyword">struct</span> &#123;</span><br><span class="line">Age      <span class="type">int</span>      <span class="string">`json:&quot;age&quot;`</span></span><br><span class="line">City     <span class="type">string</span>   <span class="string">`json:&quot;city&quot;`</span></span><br><span class="line">Hobbies  []<span class="type">string</span> <span class="string">`json:&quot;hobbies&quot;`</span></span><br><span class="line">Settings <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; <span class="string">`json:&quot;settings&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *PostgreSQLService)</span></span> UpdateUserProfile(ctx context.Context, userID <span class="type">int64</span>, profile *UserProfile) <span class="type">error</span> &#123;</span><br><span class="line">_, err := s.pool.Exec(ctx, <span class="string">`</span></span><br><span class="line"><span class="string">UPDATE users </span></span><br><span class="line"><span class="string">SET profile_data = $1::jsonb </span></span><br><span class="line"><span class="string">WHERE id = $2</span></span><br><span class="line"><span class="string">`</span>, profile, userID)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// é…ç½®</span></span><br><span class="line">config := &amp;DBConfig&#123;</span><br><span class="line">Host:     <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">Port:     <span class="number">5432</span>,</span><br><span class="line">User:     <span class="string">&quot;app_user&quot;</span>,</span><br><span class="line">Password: <span class="string">&quot;secure_password&quot;</span>,</span><br><span class="line">Database: <span class="string">&quot;myapp&quot;</span>,</span><br><span class="line">MaxConns: <span class="number">20</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æœåŠ¡</span></span><br><span class="line">service, err := NewPostgreSQLService(config)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;Failed to initialize database: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> service.Close()</span><br><span class="line"></span><br><span class="line">ctx := context.Background()</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">userID, err := service.CreateUser(ctx, <span class="string">&quot;èµµå…­&quot;</span>, <span class="string">&quot;zhaoliu@example.com&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;Failed to create user: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Created user with ID: %d\n&quot;</span>, userID)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç”¨æˆ·</span></span><br><span class="line">user, err := service.GetUser(ctx, userID)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;Failed to get user: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> user != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;User found: %+v\n&quot;</span>, user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹åŠ¡æ“ä½œ</span></span><br><span class="line">err = service.TransferMoney(ctx, <span class="number">1</span>, <span class="number">2</span>, <span class="number">150.00</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Transfer failed: %v&quot;</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Money transfer successful&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">&quot;Operation completed successfully&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3-Pythonæ“ä½œPostgreSQL"><a href="#5-3-Pythonæ“ä½œPostgreSQL" class="headerlink" title="5.3 Pythonæ“ä½œPostgreSQL"></a>5.3 Pythonæ“ä½œPostgreSQL</h3><h4 id="5-3-1-ä¾èµ–å®‰è£…"><a href="#5-3-1-ä¾èµ–å®‰è£…" class="headerlink" title="5.3.1 ä¾èµ–å®‰è£…"></a>5.3.1 ä¾èµ–å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install psycopg[binary,pool] SQLAlchemy</span><br></pre></td></tr></table></figure><h4 id="5-3-2-å®Œæ•´ç¤ºä¾‹"><a href="#5-3-2-å®Œæ•´ç¤ºä¾‹" class="headerlink" title="5.3.2 å®Œæ•´ç¤ºä¾‹"></a>5.3.2 å®Œæ•´ç¤ºä¾‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Optional</span>, <span class="type">Any</span>, <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> psycopg</span><br><span class="line"><span class="keyword">from</span> psycopg <span class="keyword">import</span> sql</span><br><span class="line"><span class="keyword">from</span> psycopg.pool <span class="keyword">import</span> ConnectionPool</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ—¥å¿—</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">logger = logging.getLogger(<span class="string">&#x27;postgres_demo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PostgreSQLService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: <span class="built_in">dict</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–PostgreSQLè¿æ¥æ± </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :param config: æ•°æ®åº“é…ç½®å­—å…¸</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.config = config</span><br><span class="line">        self.pool = <span class="literal">None</span></span><br><span class="line">        self._initialize_pool()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_pool</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–è¿æ¥æ± &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conninfo = <span class="string">f&quot;host=<span class="subst">&#123;self.config[<span class="string">&#x27;host&#x27;</span>]&#125;</span> port=<span class="subst">&#123;self.config[<span class="string">&#x27;port&#x27;</span>]&#125;</span> &quot;</span> \</span><br><span class="line">                       <span class="string">f&quot;dbname=<span class="subst">&#123;self.config[<span class="string">&#x27;dbname&#x27;</span>]&#125;</span> user=<span class="subst">&#123;self.config[<span class="string">&#x27;user&#x27;</span>]&#125;</span> &quot;</span> \</span><br><span class="line">                       <span class="string">f&quot;password=<span class="subst">&#123;self.config[<span class="string">&#x27;password&#x27;</span>]&#125;</span> sslmode=<span class="subst">&#123;self.config.get(<span class="string">&#x27;sslmode&#x27;</span>, <span class="string">&#x27;prefer&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line">            </span><br><span class="line">            self.pool = ConnectionPool(</span><br><span class="line">                conninfo=conninfo,</span><br><span class="line">                min_size=self.config.get(<span class="string">&#x27;min_size&#x27;</span>, <span class="number">5</span>),</span><br><span class="line">                max_size=self.config.get(<span class="string">&#x27;max_size&#x27;</span>, <span class="number">20</span>),</span><br><span class="line">                <span class="built_in">open</span>=<span class="literal">True</span>,</span><br><span class="line">                configure=self._configure_connection</span><br><span class="line">            )</span><br><span class="line">            logger.info(<span class="string">&quot;Database connection pool initialized successfully&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Failed to initialize connection pool: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_configure_connection</span>(<span class="params">self, conn: psycopg.Connection</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é…ç½®è¿æ¥&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cur:</span><br><span class="line">            <span class="comment"># è®¾ç½®æ—¶åŒº</span></span><br><span class="line">            cur.execute(<span class="string">&quot;SET TIME ZONE &#x27;UTC&#x27;&quot;</span>)</span><br><span class="line">            <span class="comment"># è®¾ç½®å®¢æˆ·ç«¯ç¼–ç </span></span><br><span class="line">            cur.execute(<span class="string">&quot;SET CLIENT_ENCODING TO &#x27;UTF8&#x27;&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @contextmanager</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_connection</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–è¿æ¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.pool:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;Connection pool not initialized&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        conn = self.pool.getconn()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">yield</span> conn</span><br><span class="line">            conn.commit()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            conn.rollback()</span><br><span class="line">            logger.error(<span class="string">f&quot;Database operation failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.pool.putconn(conn)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">self, name: <span class="built_in">str</span>, email: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åˆ›å»ºç”¨æˆ·&quot;&quot;&quot;</span></span><br><span class="line">        query = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        INSERT INTO users (name, email, created_at, is_active)</span></span><br><span class="line"><span class="string">        VALUES (%s, %s, NOW(), true)</span></span><br><span class="line"><span class="string">        RETURNING id</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> self.get_connection() <span class="keyword">as</span> conn:</span><br><span class="line">                <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cur:</span><br><span class="line">                    cur.execute(query, (name, email))</span><br><span class="line">                    user_id = cur.fetchone()[<span class="number">0</span>]</span><br><span class="line">                    logger.info(<span class="string">f&quot;Created user <span class="subst">&#123;name&#125;</span> with ID <span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> user_id</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Failed to create user: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">self, user_id: <span class="built_in">int</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç”¨æˆ·ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        query = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        SELECT id, name, email, created_at, is_active</span></span><br><span class="line"><span class="string">        FROM users</span></span><br><span class="line"><span class="string">        WHERE id = %s AND is_active = true</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> self.get_connection() <span class="keyword">as</span> conn:</span><br><span class="line">                <span class="keyword">with</span> conn.cursor(row_factory=psycopg.rows.dict_row) <span class="keyword">as</span> cur:</span><br><span class="line">                    cur.execute(query, (user_id,))</span><br><span class="line">                    <span class="keyword">return</span> cur.fetchone()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Failed to get user: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user_list</span>(<span class="params">self, page: <span class="built_in">int</span> = <span class="number">1</span>, page_size: <span class="built_in">int</span> = <span class="number">20</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        offset = (page - <span class="number">1</span>) * page_size</span><br><span class="line">        query = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        SELECT id, name, email, created_at, is_active</span></span><br><span class="line"><span class="string">        FROM users</span></span><br><span class="line"><span class="string">        WHERE is_active = true</span></span><br><span class="line"><span class="string">        ORDER BY created_at DESC</span></span><br><span class="line"><span class="string">        LIMIT %s OFFSET %s</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> self.get_connection() <span class="keyword">as</span> conn:</span><br><span class="line">                <span class="keyword">with</span> conn.cursor(row_factory=psycopg.rows.dict_row) <span class="keyword">as</span> cur:</span><br><span class="line">                    cur.execute(query, (page_size, offset))</span><br><span class="line">                    <span class="keyword">return</span> cur.fetchall()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Failed to get user list: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">transfer_money</span>(<span class="params">self, from_user_id: <span class="built_in">int</span>, to_user_id: <span class="built_in">int</span>, amount: <span class="built_in">float</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è½¬è´¦æ“ä½œï¼ˆäº‹åŠ¡ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> self.get_connection() <span class="keyword">as</span> conn:</span><br><span class="line">                <span class="keyword">with</span> conn.transaction():</span><br><span class="line">                    <span class="comment"># æ£€æŸ¥ä½™é¢</span></span><br><span class="line">                    check_query = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    SELECT balance FROM accounts WHERE user_id = %s FOR UPDATE</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cur:</span><br><span class="line">                        cur.execute(check_query, (from_user_id,))</span><br><span class="line">                        result = cur.fetchone()</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">                            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Account not found for user <span class="subst">&#123;from_user_id&#125;</span>&quot;</span>)</span><br><span class="line">                        </span><br><span class="line">                        balance = result[<span class="number">0</span>]</span><br><span class="line">                        <span class="keyword">if</span> balance &lt; amount:</span><br><span class="line">                            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Insufficient balance&quot;</span>)</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># æ‰£æ¬¾</span></span><br><span class="line">                        debit_query = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        UPDATE accounts SET balance = balance - %s WHERE user_id = %s</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span></span><br><span class="line">                        cur.execute(debit_query, (amount, from_user_id))</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># å…¥è´¦</span></span><br><span class="line">                        credit_query = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        UPDATE accounts SET balance = balance + %s WHERE user_id = %s</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span></span><br><span class="line">                        cur.execute(credit_query, (amount, to_user_id))</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment"># è®°å½•äº¤æ˜“æ—¥å¿—</span></span><br><span class="line">                        log_query = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        INSERT INTO transactions (from_user_id, to_user_id, amount, created_at)</span></span><br><span class="line"><span class="string">                        VALUES (%s, %s, %s, NOW())</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span></span><br><span class="line">                        cur.execute(log_query, (from_user_id, to_user_id, amount))</span><br><span class="line">            </span><br><span class="line">            logger.info(<span class="string">f&quot;Transferred <span class="subst">&#123;amount&#125;</span> from user <span class="subst">&#123;from_user_id&#125;</span> to user <span class="subst">&#123;to_user_id&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Transfer failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_user_profile</span>(<span class="params">self, user_id: <span class="built_in">int</span>, profile_data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ›´æ–°ç”¨æˆ·JSONBèµ„æ–™&quot;&quot;&quot;</span></span><br><span class="line">        query = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        UPDATE users </span></span><br><span class="line"><span class="string">        SET profile_data = %s::jsonb </span></span><br><span class="line"><span class="string">        WHERE id = %s</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            json_data = json.dumps(profile_data, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">with</span> self.get_connection() <span class="keyword">as</span> conn:</span><br><span class="line">                <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cur:</span><br><span class="line">                    cur.execute(query, (json_data, user_id))</span><br><span class="line">                    <span class="keyword">return</span> cur.rowcount &gt; <span class="number">0</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Failed to update user profile: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search_users_by_profile</span>(<span class="params">self, criteria: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ ¹æ®JSONBèµ„æ–™æœç´¢ç”¨æˆ·&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ„å»ºåŠ¨æ€æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">        conditions = []</span><br><span class="line">        params = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> criteria.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">str</span>):</span><br><span class="line">                condition = sql.SQL(<span class="string">&quot;profile_data-&gt;&gt;%s ILIKE %s&quot;</span>)</span><br><span class="line">                params.extend([key, <span class="string">f&quot;%<span class="subst">&#123;value&#125;</span>%&quot;</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                condition = sql.SQL(<span class="string">&quot;profile_data-&gt;&gt;%s = %s&quot;</span>)</span><br><span class="line">                params.extend([key, <span class="built_in">str</span>(value)])</span><br><span class="line">            conditions.append(condition)</span><br><span class="line">        </span><br><span class="line">        where_clause = sql.SQL(<span class="string">&quot; AND &quot;</span>).join(conditions) <span class="keyword">if</span> conditions <span class="keyword">else</span> sql.SQL(<span class="string">&quot;true&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        query = sql.SQL(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        SELECT id, name, email, profile_data</span></span><br><span class="line"><span class="string">        FROM users</span></span><br><span class="line"><span class="string">        WHERE is_active = true AND &#123;&#125;</span></span><br><span class="line"><span class="string">        ORDER BY created_at DESC</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>).<span class="built_in">format</span>(where_clause)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> self.get_connection() <span class="keyword">as</span> conn:</span><br><span class="line">                <span class="keyword">with</span> conn.cursor(row_factory=psycopg.rows.dict_row) <span class="keyword">as</span> cur:</span><br><span class="line">                    cur.execute(query, params)</span><br><span class="line">                    <span class="keyword">return</span> cur.fetchall()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Failed to search users by profile: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å…³é—­è¿æ¥æ± &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.pool:</span><br><span class="line">            self.pool.close()</span><br><span class="line">            logger.info(<span class="string">&quot;Database connection pool closed&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># é…ç½®</span></span><br><span class="line">    config = &#123;</span><br><span class="line">        <span class="string">&#x27;host&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;port&#x27;</span>: <span class="number">5432</span>,</span><br><span class="line">        <span class="string">&#x27;dbname&#x27;</span>: <span class="string">&#x27;myapp&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;app_user&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;secure_password&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;min_size&#x27;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&#x27;max_size&#x27;</span>: <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–æœåŠ¡</span></span><br><span class="line">        db_service = PostgreSQLService(config)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">        user_id = db_service.create_user(<span class="string">&quot;å­™ä¸ƒ&quot;</span>, <span class="string">&quot;sunqi@example.com&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Created user with ID: <span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–ç”¨æˆ·</span></span><br><span class="line">        user = db_service.get_user(user_id)</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;User found: <span class="subst">&#123;user&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ›´æ–°ç”¨æˆ·èµ„æ–™</span></span><br><span class="line">        profile = &#123;</span><br><span class="line">            <span class="string">&#x27;age&#x27;</span>: <span class="number">28</span>,</span><br><span class="line">            <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;ä¸Šæµ·&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;hobbies&#x27;</span>: [<span class="string">&#x27;reading&#x27;</span>, <span class="string">&#x27;coding&#x27;</span>, <span class="string">&#x27;travel&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;settings&#x27;</span>: &#123;<span class="string">&#x27;theme&#x27;</span>: <span class="string">&#x27;dark&#x27;</span>, <span class="string">&#x27;notifications&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        db_service.update_user_profile(user_id, profile)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;User profile updated successfully&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æœç´¢ç”¨æˆ·</span></span><br><span class="line">        results = db_service.search_users_by_profile(&#123;<span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;ä¸Šæµ·&#x27;</span>&#125;)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Found <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> users in Shanghai&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># äº‹åŠ¡æ“ä½œ</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            db_service.transfer_money(<span class="number">1</span>, <span class="number">2</span>, <span class="number">200.00</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Money transfer successful&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Transfer failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Application error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;db_service&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>():</span><br><span class="line">            db_service.close()</span><br></pre></td></tr></table></figure><hr><h2 id="ç¬¬å…­éƒ¨åˆ†ï¼šè¿ç»´ä¸ä¼˜åŒ–æœ€ä½³å®è·µ"><a href="#ç¬¬å…­éƒ¨åˆ†ï¼šè¿ç»´ä¸ä¼˜åŒ–æœ€ä½³å®è·µ" class="headerlink" title="ç¬¬å…­éƒ¨åˆ†ï¼šè¿ç»´ä¸ä¼˜åŒ–æœ€ä½³å®è·µ"></a>ç¬¬å…­éƒ¨åˆ†ï¼šè¿ç»´ä¸ä¼˜åŒ–æœ€ä½³å®è·µ</h2><h3 id="6-1-æ€§èƒ½è°ƒä¼˜å…³é”®ç‚¹"><a href="#6-1-æ€§èƒ½è°ƒä¼˜å…³é”®ç‚¹" class="headerlink" title="6.1 æ€§èƒ½è°ƒä¼˜å…³é”®ç‚¹"></a>6.1 æ€§èƒ½è°ƒä¼˜å…³é”®ç‚¹</h3><h4 id="6-1-1-æŸ¥è¯¢ä¼˜åŒ–"><a href="#6-1-1-æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="6.1.1 æŸ¥è¯¢ä¼˜åŒ–"></a>6.1.1 æŸ¥è¯¢ä¼˜åŒ–</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä½¿ç”¨EXPLAIN ANALYZEåˆ†ææŸ¥è¯¢</span></span><br><span class="line">EXPLAIN ANALYZE <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> orders </span><br><span class="line"><span class="keyword">WHERE</span> customer_id <span class="operator">=</span> <span class="number">123</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date <span class="keyword">DESC</span> </span><br><span class="line">LIMIT <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºåˆé€‚çš„ç´¢å¼•</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX CONCURRENTLY idx_orders_customer_date <span class="keyword">ON</span> orders (customer_id, order_date <span class="keyword">DESC</span>);</span><br><span class="line"><span class="keyword">CREATE</span> INDEX CONCURRENTLY idx_orders_status <span class="keyword">ON</span> orders (status) <span class="keyword">WHERE</span> status <span class="keyword">IN</span> (<span class="string">&#x27;pending&#x27;</span>, <span class="string">&#x27;processing&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é¿å…SELECT *ï¼Œåªé€‰æ‹©éœ€è¦çš„å­—æ®µ</span></span><br><span class="line"><span class="keyword">SELECT</span> id, order_date, total_amount <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> customer_id <span class="operator">=</span> <span class="number">123</span>;</span><br></pre></td></tr></table></figure><h4 id="6-1-2-é…ç½®ä¼˜åŒ–ç›‘æ§"><a href="#6-1-2-é…ç½®ä¼˜åŒ–ç›‘æ§" class="headerlink" title="6.1.2 é…ç½®ä¼˜åŒ–ç›‘æ§"></a>6.1.2 é…ç½®ä¼˜åŒ–ç›‘æ§</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ç›‘æ§é…ç½®æ›´æ”¹æ•ˆæœ</span></span><br><span class="line"><span class="keyword">SELECT</span> name, setting, unit, category, short_desc </span><br><span class="line"><span class="keyword">FROM</span> pg_settings </span><br><span class="line"><span class="keyword">WHERE</span> name <span class="keyword">IN</span> (</span><br><span class="line">    <span class="string">&#x27;shared_buffers&#x27;</span>, <span class="string">&#x27;work_mem&#x27;</span>, <span class="string">&#x27;effective_cache_size&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;maintenance_work_mem&#x27;</span>, <span class="string">&#x27;max_connections&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç›‘æ§æ´»è·ƒä¼šè¯</span></span><br><span class="line"><span class="keyword">SELECT</span> pid, usename, application_name, client_addr, state, query, query_start</span><br><span class="line"><span class="keyword">FROM</span> pg_stat_activity </span><br><span class="line"><span class="keyword">WHERE</span> state <span class="operator">!=</span> <span class="string">&#x27;idle&#x27;</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> query_start;</span><br></pre></td></tr></table></figure><h3 id="6-2-å¤‡ä»½æ¢å¤ç­–ç•¥"><a href="#6-2-å¤‡ä»½æ¢å¤ç­–ç•¥" class="headerlink" title="6.2 å¤‡ä»½æ¢å¤ç­–ç•¥"></a>6.2 å¤‡ä»½æ¢å¤ç­–ç•¥</h3><h4 id="6-2-1-ç‰©ç†å¤‡ä»½ï¼ˆåŸºç¡€å¤‡ä»½ï¼‰"><a href="#6-2-1-ç‰©ç†å¤‡ä»½ï¼ˆåŸºç¡€å¤‡ä»½ï¼‰" class="headerlink" title="6.2.1 ç‰©ç†å¤‡ä»½ï¼ˆåŸºç¡€å¤‡ä»½ï¼‰"></a>6.2.1 ç‰©ç†å¤‡ä»½ï¼ˆåŸºç¡€å¤‡ä»½ï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…¨é‡å¤‡ä»½</span></span><br><span class="line">sudo -u postgres pg_basebackup -h localhost -U backup_user -D /backup/full_backup -Ft -z -P -X stream</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¢é‡å¤‡ä»½ï¼ˆWALå½’æ¡£ï¼‰</span></span><br><span class="line"><span class="comment"># é…ç½®postgresql.conf:</span></span><br><span class="line">wal_level = replica</span><br><span class="line">archive_mode = on</span><br><span class="line">archive_command = <span class="string">&#x27;test ! -f /backup/wal/%f &amp;&amp; cp %p /backup/wal/%f&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="6-2-2-é€»è¾‘å¤‡ä»½ï¼ˆpg-dumpï¼‰"><a href="#6-2-2-é€»è¾‘å¤‡ä»½ï¼ˆpg-dumpï¼‰" class="headerlink" title="6.2.2 é€»è¾‘å¤‡ä»½ï¼ˆpg_dumpï¼‰"></a>6.2.2 é€»è¾‘å¤‡ä»½ï¼ˆpg_dumpï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…¨åº“å¤‡ä»½</span></span><br><span class="line">pg_dump -h localhost -U backup_user -Fc myapp &gt; /backup/myapp_$(<span class="built_in">date</span> +%Y%m%d).dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># å•è¡¨å¤‡ä»½</span></span><br><span class="line">pg_dump -h localhost -U backup_user -t <span class="built_in">users</span> myapp &gt; /backup/users_$(<span class="built_in">date</span> +%Y%m%d).sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šæ—¶å¤‡ä»½è„šæœ¬</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backup/daily&quot;</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line">DB_NAME=<span class="string">&quot;myapp&quot;</span></span><br><span class="line">USER=<span class="string">&quot;backup_user&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$BACKUP_DIR</span></span><br><span class="line">pg_dump -h localhost -U <span class="variable">$USER</span> -Fc <span class="variable">$DB_NAME</span> &gt; <span class="variable">$BACKUP_DIR</span>/<span class="variable">$&#123;DB_NAME&#125;</span>_<span class="variable">$&#123;DATE&#125;</span>.dump</span><br><span class="line">find <span class="variable">$BACKUP_DIR</span> -name <span class="string">&quot;*.dump&quot;</span> -mtime +7 -delete</span><br></pre></td></tr></table></figure><h3 id="6-3-å®‰å…¨é…ç½®æ³¨æ„äº‹é¡¹"><a href="#6-3-å®‰å…¨é…ç½®æ³¨æ„äº‹é¡¹" class="headerlink" title="6.3 å®‰å…¨é…ç½®æ³¨æ„äº‹é¡¹"></a>6.3 å®‰å…¨é…ç½®æ³¨æ„äº‹é¡¹</h3><h4 id="6-3-1-å…³é”®å®‰å…¨é…ç½®"><a href="#6-3-1-å…³é”®å®‰å…¨é…ç½®" class="headerlink" title="6.3.1 å…³é”®å®‰å…¨é…ç½®"></a>6.3.1 å…³é”®å®‰å…¨é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹pg_hba.confï¼Œé™åˆ¶è®¿é—®</span></span><br><span class="line"><span class="comment"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line">host    all             app_user        192.168.1.0/24          scram-sha-256</span><br><span class="line">host    replication     replicator      192.168.1.100/32        scram-sha-256</span><br><span class="line"><span class="built_in">local</span>   all             postgres                                peer</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡è½½é…ç½®</span></span><br><span class="line">sudo systemctl reload postgresql@16-main</span><br></pre></td></tr></table></figure><h4 id="6-3-2-å®‰å…¨å®¡è®¡è„šæœ¬"><a href="#6-3-2-å®‰å…¨å®¡è®¡è„šæœ¬" class="headerlink" title="6.3.2 å®‰å…¨å®¡è®¡è„šæœ¬"></a>6.3.2 å®‰å…¨å®¡è®¡è„šæœ¬</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> audit_log (</span><br><span class="line">    id SERIAL <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    event_time <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    user_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    client_addr INET,</span><br><span class="line">    query_text TEXT,</span><br><span class="line">    action <span class="type">VARCHAR</span>(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºå®¡è®¡å‡½æ•°</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> log_audit_event() <span class="keyword">RETURNS</span> <span class="keyword">TRIGGER</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> audit_log (user_name, client_addr, query_text, action)</span><br><span class="line">    <span class="keyword">VALUES</span> (</span><br><span class="line">        <span class="built_in">current_user</span>,</span><br><span class="line">        inet_client_addr(),</span><br><span class="line">        current_query(),</span><br><span class="line">        TG_OP</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">NEW</span>;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¸ºé‡è¦è¡¨åˆ›å»ºå®¡è®¡è§¦å‘å™¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> audit_users_trigger</span><br><span class="line">AFTER <span class="keyword">INSERT</span> <span class="keyword">OR</span> <span class="keyword">UPDATE</span> <span class="keyword">OR</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> users</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="keyword">EXECUTE</span> <span class="keyword">FUNCTION</span> log_audit_event();</span><br></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒå®‰å…¨åŸåˆ™</strong>ï¼š</p><ul><li>æœ€å°æƒé™åŸåˆ™ï¼šæ¯ä¸ªåº”ç”¨ç”¨æˆ·åªæ‹¥æœ‰å¿…è¦çš„æƒé™</li><li>ç½‘ç»œéš”ç¦»ï¼šæ•°æ®åº“æœåŠ¡å™¨ä¸åº”ç›´æ¥æš´éœ²åœ¨å…¬ç½‘</li><li>å®šæœŸå®¡è®¡ï¼šæ£€æŸ¥ç”¨æˆ·æƒé™ã€è®¿é—®æ—¥å¿—ã€æ•æ„Ÿæ“ä½œ</li><li>åŠ å¯†ä¼ è¾“ï¼šå¯ç”¨SSLè¿æ¥ï¼Œä¿æŠ¤æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„å®‰å…¨</li><li>å®šæœŸæ›´æ–°ï¼šåŠæ—¶åº”ç”¨å®‰å…¨è¡¥ä¸ï¼Œå…³æ³¨CVEå…¬å‘Š</li></ul><hr><h2 id="åŸºäºDebian-12çš„PostgreSQLæºç ç¼–è¯‘ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆæ³¨æ„æ ¡éªŒæºç å’Œç‰ˆæœ¬âš ï¸ï¼‰"><a href="#åŸºäºDebian-12çš„PostgreSQLæºç ç¼–è¯‘ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆæ³¨æ„æ ¡éªŒæºç å’Œç‰ˆæœ¬âš ï¸ï¼‰" class="headerlink" title="åŸºäºDebian 12çš„PostgreSQLæºç ç¼–è¯‘ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆæ³¨æ„æ ¡éªŒæºç å’Œç‰ˆæœ¬âš ï¸ï¼‰"></a>åŸºäºDebian 12çš„PostgreSQLæºç ç¼–è¯‘ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆæ³¨æ„æ ¡éªŒæºç å’Œç‰ˆæœ¬âš ï¸ï¼‰</h2><h6 id="åŸºäºDebian-12çš„PostgreSQLæºç ç¼–è¯‘ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼Œè¯¥è„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–ã€ç¼–è¯‘æºç ã€é…ç½®æœåŠ¡ï¼Œå¹¶ç”Ÿæˆå…³é”®é…ç½®ä¿¡æ¯åˆ°config-mdæ–‡ä»¶ï¼š"><a href="#åŸºäºDebian-12çš„PostgreSQLæºç ç¼–è¯‘ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼Œè¯¥è„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–ã€ç¼–è¯‘æºç ã€é…ç½®æœåŠ¡ï¼Œå¹¶ç”Ÿæˆå…³é”®é…ç½®ä¿¡æ¯åˆ°config-mdæ–‡ä»¶ï¼š" class="headerlink" title="åŸºäºDebian 12çš„PostgreSQLæºç ç¼–è¯‘ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼Œè¯¥è„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–ã€ç¼–è¯‘æºç ã€é…ç½®æœåŠ¡ï¼Œå¹¶ç”Ÿæˆå…³é”®é…ç½®ä¿¡æ¯åˆ°config.mdæ–‡ä»¶ï¼š"></a>åŸºäºDebian 12çš„PostgreSQLæºç ç¼–è¯‘ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼Œè¯¥è„šæœ¬ä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–ã€ç¼–è¯‘æºç ã€é…ç½®æœåŠ¡ï¼Œå¹¶ç”Ÿæˆå…³é”®é…ç½®ä¿¡æ¯åˆ°config.mdæ–‡ä»¶ï¼š</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># PostgreSQL 16 Source Compilation and Deployment Script for Debian 12</span></span><br><span class="line"><span class="comment"># Date: 2026-01-03</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configuration variables</span></span><br><span class="line">PG_VERSION=<span class="string">&quot;16.2&quot;</span></span><br><span class="line">PG_USER=<span class="string">&quot;postgres&quot;</span></span><br><span class="line">PG_GROUP=<span class="string">&quot;postgres&quot;</span></span><br><span class="line">PG_HOME=<span class="string">&quot;/usr/local/pgsql&quot;</span></span><br><span class="line">PG_DATA=<span class="string">&quot;/var/lib/postgresql/<span class="variable">$&#123;PG_VERSION&#125;</span>/data&quot;</span></span><br><span class="line">PG_LOG=<span class="string">&quot;/var/log/postgresql&quot;</span></span><br><span class="line">PG_PORT=<span class="string">&quot;5432&quot;</span></span><br><span class="line">SYSTEMD_SERVICE_FILE=<span class="string">&quot;/etc/systemd/system/postgresql.service&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Starting PostgreSQL <span class="variable">$&#123;PG_VERSION&#125;</span> Source Compilation and Deployment ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;System information:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;OS: <span class="subst">$(lsb_release -sd)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Kernel: <span class="subst">$(uname -r)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Architecture: <span class="subst">$(uname -m)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 1: Install required dependencies</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 1: Installing required dependencies ===&quot;</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y \</span><br><span class="line">    build-essential \</span><br><span class="line">    liblz4-dev \</span><br><span class="line">    lz4 \</span><br><span class="line">    pkg-config \</span><br><span class="line">    libreadline-dev \</span><br><span class="line">    zlib1g-dev \</span><br><span class="line">    libxml2-dev \</span><br><span class="line">    libxml2 \</span><br><span class="line">    libssh-dev \</span><br><span class="line">    uuid-dev \</span><br><span class="line">    libssl-dev \</span><br><span class="line">    libpam0g-dev \</span><br><span class="line">    libicu-dev \</span><br><span class="line">    libsystemd-dev \</span><br><span class="line">    libkrb5-dev \</span><br><span class="line">    libselinux1-dev \</span><br><span class="line">    libxslt1-dev \</span><br><span class="line">    libperl-dev \</span><br><span class="line">    python3-dev \</span><br><span class="line">    tcl-dev \</span><br><span class="line">    flex \</span><br><span class="line">    bison \</span><br><span class="line">    systemd \</span><br><span class="line">    curl \</span><br><span class="line">    wget \</span><br><span class="line">    git \</span><br><span class="line">    ca-certificates </span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2: Create PostgreSQL user and directories</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 2: Creating PostgreSQL user and directories ===&quot;</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">id</span> -u <span class="string">&quot;<span class="variable">$PG_USER</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    sudo useradd -r -s /bin/bash -d <span class="string">&quot;<span class="variable">$PG_HOME</span>&quot;</span> -U <span class="string">&quot;<span class="variable">$PG_USER</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Created user: <span class="variable">$PG_USER</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$PG_DATA</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$PG_LOG</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R <span class="string">&quot;<span class="variable">$PG_USER</span>:<span class="variable">$PG_GROUP</span>&quot;</span> <span class="string">&quot;<span class="variable">$PG_DATA</span>&quot;</span> <span class="string">&quot;<span class="variable">$PG_LOG</span>&quot;</span> <span class="string">&quot;<span class="variable">$PG_HOME</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 0700 <span class="string">&quot;<span class="variable">$PG_DATA</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 3: Download and extract PostgreSQL source code</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 3: Downloading and extracting PostgreSQL source code ===&quot;</span></span><br><span class="line"> <span class="built_in">cd</span> /tmp</span><br><span class="line">SOURCE_FILE=<span class="string">&quot;postgresql-<span class="variable">$&#123;PG_VERSION&#125;</span>.tar.gz&quot;</span></span><br><span class="line"> <span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$SOURCE_FILE</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    wget <span class="string">&quot;https://ftp.postgresql.org/pub/source/v<span class="variable">$&#123;PG_VERSION&#125;</span>/postgresql-<span class="variable">$&#123;PG_VERSION&#125;</span>.tar.gz&quot;</span></span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">tar -xzf <span class="string">&quot;<span class="variable">$SOURCE_FILE</span>&quot;</span></span><br><span class="line"> <span class="built_in">cd</span> <span class="string">&quot;postgresql-<span class="variable">$&#123;PG_VERSION&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 4: Configure compilation options</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 4: Configuring compilation options ===&quot;</span></span><br><span class="line">./configure \</span><br><span class="line">    --prefix=<span class="string">&quot;<span class="variable">$PG_HOME</span>&quot;</span> \</span><br><span class="line">    --with-pgport=<span class="string">&quot;<span class="variable">$PG_PORT</span>&quot;</span> \</span><br><span class="line">    --with-systemd \</span><br><span class="line">    --with-system-tzdata=/usr/share/zoneinfo \</span><br><span class="line">    --with-openssl \</span><br><span class="line">    --with-pam \</span><br><span class="line">    --with-ldap \</span><br><span class="line">    --with-uuid=ossp \</span><br><span class="line">    --with-libxml \</span><br><span class="line">    --with-libxslt \</span><br><span class="line">    --enable-thread-safety \</span><br><span class="line">    --enable-debug \</span><br><span class="line">    --enable-cassert \</span><br><span class="line">    --with-icu \</span><br><span class="line">    --with-perl \</span><br><span class="line">    --with-python \</span><br><span class="line">    --with-tcl</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Configuration completed successfully.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 5: Compile and install</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 5: Compiling and installing PostgreSQL ===&quot;</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>) world</span><br><span class="line">sudo make install-world</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Installation completed successfully.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 6: Initialize database cluster</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 6: Initializing database cluster ===&quot;</span></span><br><span class="line">sudo -u <span class="string">&quot;<span class="variable">$PG_USER</span>&quot;</span> <span class="string">&quot;<span class="variable">$PG_HOME</span>/bin/initdb&quot;</span> -D <span class="string">&quot;<span class="variable">$PG_DATA</span>&quot;</span> -E UTF8 --locale=en_US.UTF-8</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 7: Configure PostgreSQL settings</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 7: Configuring PostgreSQL settings ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Backup original config files</span></span><br><span class="line">sudo -u <span class="string">&quot;<span class="variable">$PG_USER</span>&quot;</span> <span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$PG_DATA</span>/postgresql.conf&quot;</span> <span class="string">&quot;<span class="variable">$PG_DATA</span>/postgresql.conf.bak&quot;</span></span><br><span class="line">sudo -u <span class="string">&quot;<span class="variable">$PG_USER</span>&quot;</span> <span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$PG_DATA</span>/pg_hba.conf&quot;</span> <span class="string">&quot;<span class="variable">$PG_DATA</span>/pg_hba.conf.bak&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure postgresql.conf</span></span><br><span class="line">sudo -u <span class="string">&quot;<span class="variable">$PG_USER</span>&quot;</span> <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$PG_DATA</span>/postgresql.conf&quot;</span> &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># PostgreSQL configuration file</span></span><br><span class="line"><span class="string"># Generated by installation script on $(date)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Connection Settings</span></span><br><span class="line"><span class="string">listen_addresses = &#x27;*&#x27;</span></span><br><span class="line"><span class="string">port = $PG_PORT</span></span><br><span class="line"><span class="string">max_connections = 100</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Memory Settings</span></span><br><span class="line"><span class="string">shared_buffers = 128MB</span></span><br><span class="line"><span class="string">effective_cache_size = 4096MB</span></span><br><span class="line"><span class="string">work_mem = 4MB</span></span><br><span class="line"><span class="string">maintenance_work_mem = 64MB</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># WAL Settings</span></span><br><span class="line"><span class="string">wal_level = replica</span></span><br><span class="line"><span class="string">synchronous_commit = on</span></span><br><span class="line"><span class="string">wal_log_hints = on</span></span><br><span class="line"><span class="string">max_wal_senders = 10</span></span><br><span class="line"><span class="string">wal_keep_size = 1GB</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Query Planning</span></span><br><span class="line"><span class="string">random_page_cost = 1.1</span></span><br><span class="line"><span class="string">effective_io_concurrency = 200</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Error Reporting and Logging</span></span><br><span class="line"><span class="string">log_destination = &#x27;stderr&#x27;</span></span><br><span class="line"><span class="string">logging_collector = on</span></span><br><span class="line"><span class="string">log_directory = &#x27;$PG_LOG&#x27;</span></span><br><span class="line"><span class="string">log_filename = &#x27;postgresql-%Y-%m-%d_%H%M%S.log&#x27;</span></span><br><span class="line"><span class="string">log_file_mode = 0640</span></span><br><span class="line"><span class="string">log_truncate_on_rotation = on</span></span><br><span class="line"><span class="string">log_rotation_age = 1d</span></span><br><span class="line"><span class="string">log_rotation_size = 100MB</span></span><br><span class="line"><span class="string">log_min_duration_statement = 1000</span></span><br><span class="line"><span class="string">log_checkpoints = on</span></span><br><span class="line"><span class="string">log_connections = on</span></span><br><span class="line"><span class="string">log_disconnections = on</span></span><br><span class="line"><span class="string">log_lock_waits = on</span></span><br><span class="line"><span class="string">log_temp_files = -1</span></span><br><span class="line"><span class="string">log_autovacuum_min_duration = 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Runtime Statistics</span></span><br><span class="line"><span class="string">track_activities = on</span></span><br><span class="line"><span class="string">track_counts = on</span></span><br><span class="line"><span class="string">track_io_timing = on</span></span><br><span class="line"><span class="string">track_functions = all</span></span><br><span class="line"><span class="string">stats_temp_directory = &#x27;/var/run/postgresql&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Autovacuum</span></span><br><span class="line"><span class="string">autovacuum = on</span></span><br><span class="line"><span class="string">log_autovacuum_min_duration = 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Client Connection Defaults</span></span><br><span class="line"><span class="string">timezone = &#x27;UTC&#x27;</span></span><br><span class="line"><span class="string">datestyle = &#x27;iso, mdy&#x27;</span></span><br><span class="line"><span class="string">lc_messages = &#x27;en_US.UTF-8&#x27;</span></span><br><span class="line"><span class="string">lc_monetary = &#x27;en_US.UTF-8&#x27;</span></span><br><span class="line"><span class="string">lc_numeric = &#x27;en_US.UTF-8&#x27;</span></span><br><span class="line"><span class="string">lc_time = &#x27;en_US.UTF-8&#x27;</span></span><br><span class="line"><span class="string">default_text_search_config = &#x27;pg_catalog.english&#x27;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure pg_hba.conf</span></span><br><span class="line">sudo -u <span class="string">&quot;<span class="variable">$PG_USER</span>&quot;</span> <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$PG_DATA</span>/pg_hba.conf&quot;</span> &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># PostgreSQL Client Authentication Configuration File</span></span><br><span class="line"><span class="string"># Generated by installation script on $(date)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># &quot;local&quot; is for Unix domain socket connections only</span></span><br><span class="line"><span class="string">local   all             all                                     peer</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># IPv4 local connections:</span></span><br><span class="line"><span class="string">host    all             all             127.0.0.1/32            scram-sha-256</span></span><br><span class="line"><span class="string">host    all             all             192.168.0.0/16          scram-sha-256</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># IPv6 local connections:</span></span><br><span class="line"><span class="string">host    all             all             ::1/128                 scram-sha-256</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Allow replication connections from localhost</span></span><br><span class="line"><span class="string">local   replication     all                                     peer</span></span><br><span class="line"><span class="string">host    replication     all             127.0.0.1/32            scram-sha-256</span></span><br><span class="line"><span class="string">host    replication     all             ::1/128                 scram-sha-256</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 8: Create systemd service file</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 8: Creating systemd service file ===&quot;</span></span><br><span class="line">sudo <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$SYSTEMD_SERVICE_FILE</span>&quot;</span> &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=PostgreSQL database server</span></span><br><span class="line"><span class="string">Documentation=man:postgres(1)</span></span><br><span class="line"><span class="string">After=network-online.target</span></span><br><span class="line"><span class="string">Wants=network-online.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">User=$PG_USER</span></span><br><span class="line"><span class="string">Group=$PG_GROUP</span></span><br><span class="line"><span class="string">RuntimeDirectory=postgresql</span></span><br><span class="line"><span class="string">RuntimeDirectoryMode=755</span></span><br><span class="line"><span class="string">Environment=PGDATA=$PG_DATA</span></span><br><span class="line"><span class="string">Environment=PGLOG=$PG_LOG</span></span><br><span class="line"><span class="string">ExecStart=$PG_HOME/bin/postgres -D $PG_DATA -c config_file=$PG_DATA/postgresql.conf</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -HUP \$MAINPID</span></span><br><span class="line"><span class="string">KillMode=mixed</span></span><br><span class="line"><span class="string">KillSignal=SIGINT</span></span><br><span class="line"><span class="string">TimeoutSec=120</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string">RestartSec=30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 9: Set proper permissions</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 9: Setting proper permissions ===&quot;</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R <span class="string">&quot;<span class="variable">$PG_USER</span>:<span class="variable">$PG_GROUP</span>&quot;</span> <span class="string">&quot;<span class="variable">$PG_HOME</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R <span class="string">&quot;<span class="variable">$PG_USER</span>:<span class="variable">$PG_GROUP</span>&quot;</span> <span class="string">&quot;<span class="variable">$PG_DATA</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R <span class="string">&quot;<span class="variable">$PG_USER</span>:<span class="variable">$PG_GROUP</span>&quot;</span> <span class="string">&quot;<span class="variable">$PG_LOG</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 0700 <span class="string">&quot;<span class="variable">$PG_DATA</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 0755 <span class="string">&quot;<span class="variable">$PG_LOG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 10: Start PostgreSQL service</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 10: Starting PostgreSQL service ===&quot;</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> postgresql</span><br><span class="line">sudo systemctl start postgresql</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for service to start</span></span><br><span class="line"><span class="built_in">sleep</span> 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 11: Verify installation</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 11: Verifying installation ===&quot;</span></span><br><span class="line">sudo -u <span class="string">&quot;<span class="variable">$PG_USER</span>&quot;</span> <span class="string">&quot;<span class="variable">$PG_HOME</span>/bin/psql&quot;</span> -c <span class="string">&quot;SELECT version();&quot;</span> postgres</span><br><span class="line">sudo -u <span class="string">&quot;<span class="variable">$PG_USER</span>&quot;</span> <span class="string">&quot;<span class="variable">$PG_HOME</span>/bin/pg_isready&quot;</span> -p <span class="string">&quot;<span class="variable">$PG_PORT</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 12: Generate config.md file with key configuration information</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Step 12: Generating config.md file ===&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; config.md &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># PostgreSQL $&#123;PG_VERSION&#125; Configuration Summary</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## System Information</span></span><br><span class="line"><span class="string">- **OS**: $(lsb_release -sd)</span></span><br><span class="line"><span class="string">- **Kernel**: $(uname -r)</span></span><br><span class="line"><span class="string">- **Architecture**: $(uname -m)</span></span><br><span class="line"><span class="string">- **Installation Date**: $(date)</span></span><br><span class="line"><span class="string">- **Installation Method**: Source Compilation</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## PostgreSQL Installation Details</span></span><br><span class="line"><span class="string">- **Version**: $&#123;PG_VERSION&#125;</span></span><br><span class="line"><span class="string">- **Installation Path**: $PG_HOME</span></span><br><span class="line"><span class="string">- **Data Directory**: $PG_DATA</span></span><br><span class="line"><span class="string">- **Log Directory**: $PG_LOG</span></span><br><span class="line"><span class="string">- **Port**: $PG_PORT</span></span><br><span class="line"><span class="string">- **Service User**: $PG_USER</span></span><br><span class="line"><span class="string">- **Service Group**: $PG_GROUP</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Key Configuration Files</span></span><br><span class="line"><span class="string">- **postgresql.conf**: $PG_DATA/postgresql.conf</span></span><br><span class="line"><span class="string">- **pg_hba.conf**: $PG_DATA/pg_hba.conf</span></span><br><span class="line"><span class="string">- **systemd Service**: $SYSTEMD_SERVICE_FILE</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Important Configuration Parameters</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Connection Settings</span></span><br><span class="line"><span class="string">- **listen_addresses**: &#x27;*&#x27;</span></span><br><span class="line"><span class="string">- **port**: $PG_PORT</span></span><br><span class="line"><span class="string">- **max_connections**: 100</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Memory Settings</span></span><br><span class="line"><span class="string">- **shared_buffers**: 128MB</span></span><br><span class="line"><span class="string">- **effective_cache_size**: 4096MB</span></span><br><span class="line"><span class="string">- **work_mem**: 4MB</span></span><br><span class="line"><span class="string">- **maintenance_work_mem**: 64MB</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### WAL Settings</span></span><br><span class="line"><span class="string">- **wal_level**: replica</span></span><br><span class="line"><span class="string">- **wal_keep_size**: 1GB</span></span><br><span class="line"><span class="string">- **max_wal_senders**: 10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Security Settings</span></span><br><span class="line"><span class="string">- **Authentication Method**: scram-sha-256 (for remote connections)</span></span><br><span class="line"><span class="string">- **Local Authentication**: peer</span></span><br><span class="line"><span class="string">- **SSL**: Enabled</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Logging Settings</span></span><br><span class="line"><span class="string">- **Log Directory**: $PG_LOG</span></span><br><span class="line"><span class="string">- **Log Rotation**: Daily</span></span><br><span class="line"><span class="string">- **Log File Size**: 100MB</span></span><br><span class="line"><span class="string">- **Slow Query Log**: &gt;1000ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Service Management Commands</span></span><br><span class="line"><span class="string">- **Start Service**: \`sudo systemctl start postgresql\`</span></span><br><span class="line"><span class="string">- **Stop Service**: \`sudo systemctl stop postgresql\`</span></span><br><span class="line"><span class="string">- **Restart Service**: \`sudo systemctl restart postgresql\`</span></span><br><span class="line"><span class="string">- **Check Status**: \`sudo systemctl status postgresql\`</span></span><br><span class="line"><span class="string">- **Enable on Boot**: \`sudo systemctl enable postgresql\`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Database Access</span></span><br><span class="line"><span class="string">- **Local Access**: \`sudo -u $PG_USER $PG_HOME/bin/psql\`</span></span><br><span class="line"><span class="string">- **Remote Access**: Configure pg_hba.conf and firewall rules</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Important Directories</span></span><br><span class="line"><span class="string">- **Binaries**: $PG_HOME/bin/</span></span><br><span class="line"><span class="string">- **Data Files**: $PG_DATA/</span></span><br><span class="line"><span class="string">- **Logs**: $PG_LOG/</span></span><br><span class="line"><span class="string">- **Configuration**: $PG_DATA/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Backup and Recovery</span></span><br><span class="line"><span class="string">- **Base Backup Command**: \`$PG_HOME/bin/pg_basebackup -D /backup/path -Ft -z -P -X stream\`</span></span><br><span class="line"><span class="string">- **WAL Archive Command**: Configure in postgresql.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Performance Tuning Notes</span></span><br><span class="line"><span class="string">1. **shared_buffers**: Should be 25% of total RAM for dedicated database servers</span></span><br><span class="line"><span class="string">2. **work_mem**: Increase for complex queries with sorts and joins</span></span><br><span class="line"><span class="string">3. **maintenance_work_mem**: Increase for faster index creation and vacuum operations</span></span><br><span class="line"><span class="string">4. **effective_cache_size**: Should be 50-75% of total system memory</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Security Recommendations</span></span><br><span class="line"><span class="string">1. **Firewall**: Restrict access to PostgreSQL port (5432) to trusted networks</span></span><br><span class="line"><span class="string">2. **SSL**: Enable SSL connections for remote clients</span></span><br><span class="line"><span class="string">3. **Password Policy**: Enforce strong passwords for database users</span></span><br><span class="line"><span class="string">4. **Regular Updates**: Keep PostgreSQL updated with security patches</span></span><br><span class="line"><span class="string">5. **Audit Logging**: Enable detailed logging for security monitoring</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Monitoring Commands</span></span><br><span class="line"><span class="string">- **Check Connections**: \`$PG_HOME/bin/psql -c &quot;SELECT * FROM pg_stat_activity;&quot;\`</span></span><br><span class="line"><span class="string">- **Check Locks**: \`$PG_HOME/bin/psql -c &quot;SELECT * FROM pg_locks;&quot;\`</span></span><br><span class="line"><span class="string">- **Check Replication**: \`$PG_HOME/bin/psql -c &quot;SELECT * FROM pg_stat_replication;&quot;\`</span></span><br><span class="line"><span class="string">- **Check Table Sizes**: \`$PG_HOME/bin/psql -c &quot;SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||&#x27;.&#x27;||tablename)) FROM pg_tables ORDER BY pg_total_relation_size DESC LIMIT 10;&quot;\`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Troubleshooting</span></span><br><span class="line"><span class="string">- **Service Logs**: \`journalctl -u postgresql -f\`</span></span><br><span class="line"><span class="string">- **PostgreSQL Logs**: \`tail -f $PG_LOG/postgresql-$(date +&#x27;%Y-%m-%d&#x27;)_*.log\`</span></span><br><span class="line"><span class="string">- **Check Service Status**: \`systemctl status postgresql\`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Notes</span></span><br><span class="line"><span class="string">- This configuration is optimized for a development/medium production environment</span></span><br><span class="line"><span class="string">- For production environments, adjust memory settings based on available system resources</span></span><br><span class="line"><span class="string">- Always test configuration changes in a staging environment before applying to production</span></span><br><span class="line"><span class="string">- Regular backups are essential - implement a backup strategy using pg_dump or pg_basebackup</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== Installation completed successfully! ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Key configuration information has been saved to config.md&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;To verify the installation, run:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  sudo -u <span class="variable">$PG_USER</span> <span class="variable">$PG_HOME</span>/bin/psql -c \&quot;SELECT version();\&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;To manage the service:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  sudo systemctl status postgresql&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Configuration files:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  postgresql.conf: <span class="variable">$PG_DATA</span>/postgresql.conf&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  pg_hba.conf: <span class="variable">$PG_DATA</span>/pg_hba.conf&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  systemd service: <span class="variable">$SYSTEMD_SERVICE_FILE</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Log files are stored in: <span class="variable">$PG_LOG</span>&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè„šæœ¬æä¾›äº†å®Œæ•´çš„PostgreSQL 16æºç ç¼–è¯‘éƒ¨ç½²æµç¨‹ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li><strong>ä¾èµ–å®‰è£…</strong>ï¼šå®‰è£…æ‰€æœ‰å¿…éœ€çš„ç¼–è¯‘ä¾èµ–åŒ… </li><li><strong>ç”¨æˆ·å’Œç›®å½•åˆ›å»º</strong>ï¼šåˆ›å»ºä¸“ç”¨çš„postgresç”¨æˆ·å’Œå¿…è¦çš„ç›®å½•ç»“æ„</li><li><strong>æºç ä¸‹è½½å’Œç¼–è¯‘</strong>ï¼šä¸‹è½½å®˜æ–¹æºç å¹¶è¿›è¡Œé…ç½®ã€ç¼–è¯‘å’Œå®‰è£…</li><li><strong>æ•°æ®åº“åˆå§‹åŒ–</strong>ï¼šåˆå§‹åŒ–æ•°æ®åº“é›†ç¾¤ </li><li><strong>é…ç½®æ–‡ä»¶è®¾ç½®</strong>ï¼šé…ç½®postgresql.confå’Œpg_hba.confæ–‡ä»¶ </li><li><strong>systemdæœåŠ¡é…ç½®</strong>ï¼šåˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶ä»¥ä¾¿äºæœåŠ¡ç®¡ç† </li><li><strong>æœåŠ¡å¯åŠ¨å’ŒéªŒè¯</strong>ï¼šå¯åŠ¨PostgreSQLæœåŠ¡å¹¶éªŒè¯å®‰è£…</li><li><strong>é…ç½®ä¿¡æ¯ç”Ÿæˆ</strong>ï¼šç”Ÿæˆè¯¦ç»†çš„config.mdæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å…³é”®é…ç½®ä¿¡æ¯</li></ol><p>è„šæœ¬æ‰§è¡Œå®Œæˆåï¼Œconfig.mdæ–‡ä»¶å°†åŒ…å«ï¼š</p><ul><li>ç³»ç»Ÿå’Œå®‰è£…ä¿¡æ¯</li><li>å…³é”®é…ç½®æ–‡ä»¶è·¯å¾„</li><li>é‡è¦é…ç½®å‚æ•°è¯¦è§£</li><li>æœåŠ¡ç®¡ç†å‘½ä»¤</li><li>æ•°æ®åº“è®¿é—®æ–¹æ³•</li><li>å¤‡ä»½æ¢å¤ç­–ç•¥</li><li>æ€§èƒ½è°ƒä¼˜å»ºè®®</li><li>å®‰å…¨é…ç½®æ¨è</li><li>ç›‘æ§å’Œæ•…éšœæ’é™¤å‘½ä»¤</li></ul><p>è¿™ä¸ªè„šæœ¬é€‚ç”¨äºDebian 12ç³»ç»Ÿï¼Œå¯ä»¥ä½œä¸ºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„åŸºç¡€ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚è°ƒæ•´é…ç½®å‚æ•°ã€‚</p><p>âš ï¸ æ³¨æ„æ­¤è„šæœ¬æ—¶æ•ˆPGç‰ˆæœ¬ä»¥å®˜æ–¹æ›´æ–°ä¸ºä¸»ï¼Œå¯é€‚æ—¶è°ƒæ•´ã€‚</p><hr><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä»PostgreSQLçš„ç‰ˆæœ¬å†å²å‡ºå‘ï¼Œæ·±å…¥æ¢è®¨äº†åœ¨Debian 12ç¯å¢ƒä¸‹çš„å®Œæ•´å®è·µè·¯å¾„ï¼Œä»åŸºç¡€å®‰è£…é…ç½®åˆ°é«˜çº§é›†ç¾¤éƒ¨ç½²ï¼Œå†åˆ°å¤šè¯­è¨€åº”ç”¨å¼€å‘ï¼Œå½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„çŸ¥è¯†ä½“ç³»ã€‚PostgreSQLçš„å¼ºå¤§ä¹‹å¤„ä¸ä»…åœ¨äºå…¶ä¸°å¯Œçš„åŠŸèƒ½ç‰¹æ€§ï¼Œæ›´åœ¨äºå…¶ç¨³å®šæ€§å’Œå¯æ‰©å±•æ€§ã€‚</p><p><strong>å…³é”®å®è·µå»ºè®®</strong>ï¼š</p><ol><li><strong>å¾ªåºæ¸è¿›</strong>ï¼šä»å•ä½“éƒ¨ç½²å¼€å§‹ï¼Œé€æ­¥è¿‡æ¸¡åˆ°ä¸»ä»å¤åˆ¶ï¼Œæœ€åè€ƒè™‘é›†ç¾¤æ–¹æ¡ˆ</li><li><strong>ç›‘æ§å…ˆè¡Œ</strong>ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼Œç¡®ä¿ç›‘æ§ä½“ç³»å®Œå–„</li><li><strong>å¤‡ä»½ä¸ºç‹</strong>ï¼šæ— è®ºæ¶æ„å¤šä¹ˆå¤æ‚ï¼Œå¯é çš„å¤‡ä»½ç­–ç•¥æ˜¯æœ€åçš„å®‰å…¨ä¿éšœ</li><li><strong>å®‰å…¨ç¬¬ä¸€</strong>ï¼šä»è®¾è®¡é˜¶æ®µå°±è€ƒè™‘å®‰å…¨å› ç´ ï¼Œè€Œä¸æ˜¯äº‹åè¡¥æ•‘</li><li><strong>æŒç»­å­¦ä¹ </strong>ï¼šPostgreSQLç¤¾åŒºæ´»è·ƒï¼Œæ–°ç‰ˆæœ¬ä¸æ–­å¸¦æ¥æ€§èƒ½æ”¹è¿›å’Œæ–°ç‰¹æ€§</li></ol><p>ğŸ”” éšç€äº‘åŸç”ŸæŠ€æœ¯å’ŒAIæŠ€æœ¯çš„å‘å±•ï¼ŒPostgreSQLåœ¨å®¹å™¨åŒ–ã€Serverlessç­‰åœºæ™¯ä¸‹çš„åº”ç”¨å°†æ›´åŠ å¹¿æ³›,ä¸”<strong>å¤§æœ‰æˆä¸ºAIåŸºç¡€è®¾æ–½çš„è¶‹åŠ¿</strong>ã€‚æŒæ¡PostgreSQLçš„æ ¸å¿ƒåŸç†å’Œæœ€ä½³å®è·µï¼Œä¸ä»…èƒ½æå‡åº”ç”¨æ€§èƒ½å’Œå¯é æ€§ï¼Œæ›´èƒ½ä¸ºæŠ€æœ¯æ¶æ„çš„æ¼”è¿›æä¾›åšå®åŸºç¡€ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h2 id=&quot;PGç®€è¿°&quot;&gt;&lt;a href=&quot;#PGç®€è¿°&quot; class=&quot;headerlink&quot; title=&quot;PGç®€è¿°&quot;&gt;&lt;/a&gt;PGç®€è¿°&lt;/h2&gt;&lt;p&gt;PostgreSQLä½œä¸ºä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿï¼Œå‡­å€Ÿå…¶å¼ºå¤§çš„åŠŸèƒ½ã€å“è¶Šçš„æ€§èƒ½å’Œä¸¥æ ¼çš„ACIDç‰¹æ€§ï¼Œå·²ç»æˆä¸ºä¼ä¸šçº§åº”ç”¨çš„é¦–é€‰æ•°æ®åº“ä¹‹ä¸€ã€‚&lt;br&gt;æœ¬æ–‡å°†å¸¦é¢†è¯»è€…ä»é›¶å¼€å§‹ï¼Œåœ¨Debian 12ç¯å¢ƒä¸‹æ·±å…¥æŒæ¡PostgreSQLï¼Œæ¶µç›–ç‰ˆæœ¬æ¼”è¿›ã€æ ¸å¿ƒåŸç†ã€å®æˆ˜é…ç½®ã€é›†ç¾¤éƒ¨ç½²ä»¥åŠå¤šè¯­è¨€åº”ç”¨å¼€å‘ï¼Œä¸ºæ•°æ®åº“å·¥ç¨‹å¸ˆå’Œå¼€å‘è€…æä¾›ä¸€å¥—å®Œæ•´çš„å®è·µæŒ‡å—ï¼ŒåŒ…å«å¸¸ç”¨çš„ä¸€äº›è¯­æ³•æ“ä½œå’Œæœ€ä½³å®è·µç­‰ç­‰ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Database" scheme="https://www.wdft.com/categories/Database/"/>
    
    
    <category term="postgresql" scheme="https://www.wdft.com/tags/postgresql/"/>
    
    <category term="postgresql-syntax" scheme="https://www.wdft.com/tags/postgresql-syntax/"/>
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
  </entry>
  
  <entry>
    <title>Discussion and analysis of Text2SQL technology, the most difficult pain point in the commercial implementation of agents.ï¼ˆAgent å•†ä¸šè½åœ°é‡Œæœ€éš¾çš„ç—›ç‚¹ Text2SQL æŠ€æœ¯æ¢è®¨å’Œè§£æï¼‰</title>
    <link href="https://www.wdft.com/4adbc11a.html"/>
    <id>https://www.wdft.com/4adbc11a.html</id>
    <published>2025-12-03T14:29:12.000Z</published>
    <updated>2026-01-27T08:52:32.282Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h3 id="Agent-å•†ä¸šè½åœ°é‡Œæœ€éš¾çš„æ˜¯-Text2SQLï¼ˆNL2SQLï¼‰ï¼Œå‡ ä¹æ˜¯æ— æ³•ç»•å¼€çš„æ ¸å¿ƒç—›ç‚¹ï¼Œä¸»è¦é¢ä¸´çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š"><a href="#Agent-å•†ä¸šè½åœ°é‡Œæœ€éš¾çš„æ˜¯-Text2SQLï¼ˆNL2SQLï¼‰ï¼Œå‡ ä¹æ˜¯æ— æ³•ç»•å¼€çš„æ ¸å¿ƒç—›ç‚¹ï¼Œä¸»è¦é¢ä¸´çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š" class="headerlink" title="Agent å•†ä¸šè½åœ°é‡Œæœ€éš¾çš„æ˜¯ Text2SQLï¼ˆNL2SQLï¼‰ï¼Œå‡ ä¹æ˜¯æ— æ³•ç»•å¼€çš„æ ¸å¿ƒç—›ç‚¹ï¼Œä¸»è¦é¢ä¸´çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š"></a>Agent å•†ä¸šè½åœ°é‡Œæœ€éš¾çš„æ˜¯ Text2SQLï¼ˆNL2SQLï¼‰ï¼Œå‡ ä¹æ˜¯æ— æ³•ç»•å¼€çš„æ ¸å¿ƒç—›ç‚¹ï¼Œä¸»è¦é¢ä¸´çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š</h3><ul><li>ä¸ºä»€ä¹ˆåˆ°ç›®å‰ä¸ºæ­¢ä»ç„¶æ²¡æœ‰çœŸæ­£å¯é çš„å•†ä¸šå…±è¯†æ€§ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼Ÿ</li><li>å®é™…ä¼ä¸šåº”ç”¨åœºæ™¯ä¸­ï¼Œæœ‰å“ªäº›é è°±çš„æ€è·¯å’Œè§£å†³æ–¹æ¡ˆï¼Ÿ  <span id="more"></span></li><li>æ˜¯ä¾æ‰˜ä¸“æœ‰å°æ¨¡å‹è¿˜æ˜¯åŸºäºæ¨¡ç‰ˆå®å¥—ç”¨æ›¿æ¢å˜é‡çš„æ–¹å¼ï¼Ÿ</li><li>å¦‚æœæ˜¯ä½ ï¼Œä½ æ€ä¹ˆè®¾è®¡ä¸€ä¸ªå‡†ç¡®ç‡è¶³å¤Ÿé«˜çš„ text2sql å¼•æ“ï¼Ÿ</li></ul><p>è¿™æ˜¯ä¸€ä¸ªéå¸¸æ·±åˆ»ä¸”ç›´å‡»è¦å®³çš„å•†ä¸šè½åœ°é—®é¢˜ã€‚Text-to-SQLï¼ˆæˆ–è€…è¯´ï¼Œæ›´å¹¿ä¹‰çš„ NL2SQL&#x2F;Text2Analyticsï¼‰ä¸‹é¢æˆ‘å°†ä»â€œä¸ºä»€ä¹ˆéš¾â€ã€â€œç°æœ‰é è°±çš„æ€è·¯â€ä»¥åŠâ€œæŠ€æœ¯é€‰å‹â€ä¸‰ä¸ªå±‚é¢ï¼Œç³»ç»Ÿåœ°æ‹†è§£è¿™ä¸ªé—®é¢˜ã€‚</p><hr><h3 id="ä¸€ã€ä¸ºä»€ä¹ˆ-Text-to-SQL-æ²¡æœ‰çœŸæ­£å¯é çš„å…±è¯†æ€§ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#ä¸€ã€ä¸ºä»€ä¹ˆ-Text-to-SQL-æ²¡æœ‰çœŸæ­£å¯é çš„å…±è¯†æ€§ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="ä¸€ã€ä¸ºä»€ä¹ˆ Text-to-SQL æ²¡æœ‰çœŸæ­£å¯é çš„å…±è¯†æ€§ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼Ÿ"></a>ä¸€ã€ä¸ºä»€ä¹ˆ Text-to-SQL æ²¡æœ‰çœŸæ­£å¯é çš„å…±è¯†æ€§ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼Ÿ</h3><p>ç®€å•æ¥è¯´ï¼Œ<strong>Text-to-SQL çš„éš¾åº¦åœ¨äºå®ƒè¯•å›¾ç”¨ AI å¼¥åˆâ€œäººç±»æ¨¡ç³Šæ„å›¾â€ä¸â€œæœºå™¨ç²¾ç¡®é€»è¾‘â€ä¹‹é—´çš„é¸¿æ²Ÿï¼Œè€Œè¿™ä¸ªé¸¿æ²Ÿåœ¨ä¼ä¸šçº§åœºæ™¯ä¸­è¢«æ— é™æ”¾å¤§äº†ã€‚</strong></p><p>å…·ä½“æŒ‘æˆ˜ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªå±‚é¢ï¼š</p><p><strong>1. è‡ªç„¶è¯­è¨€çš„â€œæ— é™â€ä¸ SQL é€»è¾‘çš„â€œæœ‰é™â€ä¹‹é—´çš„çŸ›ç›¾</strong></p><ul><li><strong>æ­§ä¹‰æ€§ï¼š</strong> â€œä¸Šä¸ªæœˆçš„é”€å”®â€æ˜¯æŒ‡è®¢å•åˆ›å»ºæ—¶é—´ã€æ”¯ä»˜æ—¶é—´è¿˜æ˜¯å‘è´§æ—¶é—´ï¼Ÿâ€œtop å®¢æˆ·â€æ˜¯æŒ‰æ¶ˆè´¹é‡‘é¢ã€è®¢å•é¢‘æ¬¡è¿˜æ˜¯å®¢å•ä»·æ’åï¼Ÿäººç±»éœ€è¦ä¸Šä¸‹æ–‡å’Œå…±è¯†ï¼Œä½†æœºå™¨æ²¡æœ‰ã€‚</li><li><strong>å£è¯­åŒ–ä¸å¤æ‚æ€§ï¼š</strong> ç”¨æˆ·ä¼šé—®ï¼šâ€œå¸®æˆ‘çœ‹çœ‹å¼ ä¸‰è´Ÿè´£çš„åä¸œåŒºï¼Œæœ€è¿‘ä¸‰ä¸ªæœˆé™¤äº† A äº§å“ä¹‹å¤–ï¼Œæ‰€æœ‰ B ç±»å®¢æˆ·çš„é”€å”®é¢ç¯æ¯”å¢é•¿æƒ…å†µï¼Œå†è·Ÿå»å¹´åŒæœŸæ¯”ä¸€ä¸‹ã€‚â€ è¿™å¥è¯åŒ…å«äº†å¤šå±‚åµŒå¥—çš„è¿‡æ»¤ã€è¿æ¥ã€èšåˆå’Œæ—¶é—´çª—å£è®¡ç®—ï¼Œç›´æ¥è½¬æ¢æˆ SQL æå…¶å¤æ‚ã€‚</li></ul><p><strong>2. ä¼ä¸šçº§æ•°æ®çš„â€œè„ä¹±å·®â€ä¸ä¸šåŠ¡é€»è¾‘çš„â€œéšæ€§çŸ¥è¯†â€</strong></p><ul><li><strong>Schema ç†è§£å›°éš¾ï¼š</strong> ä¼ä¸šæ•°æ®åº“è¡¨ç»“æ„å¤æ‚ã€å‘½åä¸è§„èŒƒï¼ˆ<code>t_usr_info</code>ã€<code>col_nm</code>ï¼‰ã€ç¼ºä¹æ³¨é‡Šã€‚æ¨¡å‹å¾ˆéš¾ä»…é è¡¨åå’Œåˆ—åå°±ç†è§£<code>user_id</code>å’Œ<code>customer_id</code>å¯èƒ½æŒ‡å‘åŒä¸€ä¸ªå®ä½“ã€‚</li><li><strong>ä¸šåŠ¡é€»è¾‘é»‘ç›’ï¼š</strong> â€œVIP å®¢æˆ·â€ã€â€œæ´»è·ƒç”¨æˆ·â€ã€â€œæœ‰æ•ˆè®¢å•â€è¿™äº›æ¦‚å¿µï¼Œåœ¨æ•°æ®åº“é‡Œå¾€å¾€ä¸æ˜¯ä¸€ä¸¤ä¸ªå­—æ®µï¼Œè€Œæ˜¯ä¸€å¥—å¤æ‚çš„è®¡ç®—é€»è¾‘ï¼ˆå¯èƒ½éœ€è¦å…³è”å¤šå¼ è¡¨ï¼Œè¿›è¡Œå¤šå±‚è®¡ç®—ï¼‰ã€‚è¿™äº›<strong>éšæ€§çŸ¥è¯†</strong>æ˜¯æ¨¡å‹æ— æ³•ä»æ•°æ®åº“ç»“æ„ä¸­å­¦ä¹ åˆ°çš„ï¼Œå®ƒå­˜åœ¨äºä¸šåŠ¡ä¸“å®¶çš„è„‘å­é‡Œã€‚</li><li><strong>æ•°æ®è´¨é‡é—®é¢˜ï¼š</strong> ç©ºå€¼ã€å¼‚å¸¸å€¼ã€ä¸ä¸€è‡´çš„æ ¼å¼ï¼ˆå¦‚æ—¥æœŸ<code>2025-12-03</code>å’Œ<code>12/03/2025</code>å¹¶å­˜ï¼‰éƒ½ä¼šè®©ç”Ÿæˆçš„ SQL æ‰§è¡Œå¤±è´¥æˆ–è¿”å›é”™è¯¯ç»“æœã€‚</li></ul><p><strong>3. ç»“æœçš„â€œå‡†ç¡®æ€§â€ä¸â€œå®‰å…¨æ€§â€è¦æ±‚æé«˜</strong></p><ul><li><strong>å®¹é”™ç‡æä½ï¼š</strong> åœ¨ C ç«¯èŠå¤©æœºå™¨äººä¸­ï¼ŒAI ç­”é”™ä¸€ä¸ªé—®é¢˜å¯èƒ½åªæ˜¯ä¸ªç¬‘è¯ã€‚ä½†åœ¨ä¼ä¸šåˆ†æåœºæ™¯ï¼Œä¸€ä¸ªé”™è¯¯çš„ SQL å¯èƒ½å¯¼è‡´<strong>ç¾éš¾æ€§çš„ä¸šåŠ¡å†³ç­–</strong>ã€‚æ¯”å¦‚ï¼Œå›  SQL é”™è¯¯å¯¼è‡´é”€å”®é¢è¢«ä½ä¼° 10%ï¼Œå¯èƒ½ä¼šå½±å“æ•´ä¸ªå­£åº¦çš„å¸‚åœºç­–ç•¥ã€‚</li><li><strong>å®‰å…¨é£é™©ï¼š</strong> ç”Ÿæˆçš„ SQL å¿…é¡»è¢«ä¸¥æ ¼é™åˆ¶ã€‚å¦‚æœæ¨¡å‹ç”Ÿæˆäº†<code>DROP TABLE</code>æˆ–<code>UPDATE</code>ç­‰é«˜å±æ“ä½œï¼Œåæœä¸å ªè®¾æƒ³ã€‚åŒæ—¶ï¼Œå¤æ‚çš„æŸ¥è¯¢ï¼ˆå¦‚å¤šè¡¨ç¬›å¡å°”ç§¯ï¼‰å¯èƒ½ä¼šæ‹–å®æ•´ä¸ªæ•°æ®åº“ï¼Œå½±å“çº¿ä¸Šä¸šåŠ¡ã€‚</li></ul><p><strong>4. è¯„ä¼°å’Œè¿­ä»£çš„â€œé»‘ç›’â€å›°å¢ƒ</strong></p><ul><li><strong>å¦‚ä½•å®šä¹‰â€œå¥½â€ï¼š</strong> SQL è¯­æ³•æ­£ç¡®ä¸ç­‰äºç»“æœæ­£ç¡®ã€‚ç»“æœæ­£ç¡®ä¸ç­‰äºç¬¦åˆç”¨æˆ·â€œçœŸå®â€æ„å›¾ã€‚è¯„ä¼° Text-to-SQL ç³»ç»Ÿéœ€è¦å¤§é‡çš„ã€ç”±ä¸šåŠ¡ä¸“å®¶æ ‡æ³¨çš„ï¼ˆé—®é¢˜ï¼ŒSQLï¼Œæ­£ç¡®ç»“æœï¼‰ä¸‰å…ƒç»„ï¼Œæˆæœ¬æé«˜ã€‚</li><li><strong>è¿­ä»£å›°éš¾ï¼š</strong> å½“ä¸€ä¸ªæŸ¥è¯¢å‡ºé”™æ—¶ï¼Œå¾ˆéš¾å¿«é€Ÿå®šä½æ˜¯æ¨¡å‹ç†è§£é”™äº†ã€ä¸šåŠ¡é€»è¾‘æ²¡å¯¹é½ï¼Œè¿˜æ˜¯æ•°æ®æœ¬èº«çš„é—®é¢˜ã€‚è°ƒè¯•å’Œä¼˜åŒ–çš„é“¾æ¡éå¸¸é•¿ã€‚</li></ul><p><strong>å°ç»“ï¼š</strong> æ­£æ˜¯å› ä¸ºä¸Šè¿°æŒ‘æˆ˜çš„å åŠ ï¼Œå¯¼è‡´ä¸€ä¸ªâ€œæ”¾ä¹‹å››æµ·è€Œçš†å‡†â€çš„é€šç”¨å¤§æ¨¡å‹ï¼Œæ— æ³•ç›´æ¥èƒœä»»ä¼ä¸šçº§ Text-to-SQL ä»»åŠ¡ã€‚å®ƒç¼ºå°‘å¯¹ä¼ä¸šå†…éƒ¨ç‰¹å®šæ•°æ®ã€ä¸šåŠ¡é€»è¾‘å’Œå®‰å…¨è¾¹ç•Œçš„æ·±åº¦ç†è§£ã€‚</p><hr><h3 id="äºŒã€å®é™…ä¼ä¸šåº”ç”¨åœºæ™¯ä¸­ï¼Œæœ‰å“ªäº›é è°±çš„æ€è·¯å’Œè§£å†³æ–¹æ¡ˆï¼Ÿ"><a href="#äºŒã€å®é™…ä¼ä¸šåº”ç”¨åœºæ™¯ä¸­ï¼Œæœ‰å“ªäº›é è°±çš„æ€è·¯å’Œè§£å†³æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="äºŒã€å®é™…ä¼ä¸šåº”ç”¨åœºæ™¯ä¸­ï¼Œæœ‰å“ªäº›é è°±çš„æ€è·¯å’Œè§£å†³æ–¹æ¡ˆï¼Ÿ"></a>äºŒã€å®é™…ä¼ä¸šåº”ç”¨åœºæ™¯ä¸­ï¼Œæœ‰å“ªäº›é è°±çš„æ€è·¯å’Œè§£å†³æ–¹æ¡ˆï¼Ÿ</h3><p>ç›®å‰ä¸šç•Œæ²¡æœ‰é“¶å¼¹ï¼Œä½†å·²ç»å½¢æˆäº†ä¸€äº›è¡Œä¹‹æœ‰æ•ˆçš„<strong>æ··åˆæ¶æ„æ¨¡å¼</strong>ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>ç”¨ AI çš„å¼ºå¤§èƒ½åŠ›å¤„ç†â€œç†è§£â€éƒ¨åˆ†ï¼Œç”¨ä¼ ç»Ÿå·¥ç¨‹çš„ç¡®å®šæ€§æ¥ä¿è¯â€œæ‰§è¡Œâ€çš„å‡†ç¡®å’Œå®‰å…¨ã€‚</strong></p><p>ä»¥ä¸‹æ˜¯å‡ ç§ä»ç®€å•åˆ°å¤æ‚çš„é è°±æ€è·¯ï¼š</p><h4 id="æ€è·¯ä¸€ï¼šæ¨¡æ¿-x2F-å®æ›¿æ¢ï¼ˆå¯æ§æ€§æœ€å¼ºï¼‰"><a href="#æ€è·¯ä¸€ï¼šæ¨¡æ¿-x2F-å®æ›¿æ¢ï¼ˆå¯æ§æ€§æœ€å¼ºï¼‰" class="headerlink" title="æ€è·¯ä¸€ï¼šæ¨¡æ¿&#x2F;å®æ›¿æ¢ï¼ˆå¯æ§æ€§æœ€å¼ºï¼‰"></a>æ€è·¯ä¸€ï¼šæ¨¡æ¿&#x2F;å®æ›¿æ¢ï¼ˆå¯æ§æ€§æœ€å¼ºï¼‰</h4><p>è¿™æ˜¯æœ€â€œå¤å…¸â€ä½†æœ€ç¨³å¦¥çš„æ–¹æ³•ï¼Œé€‚ç”¨äº<strong>é«˜é¢‘ã€æ ‡å‡†åŒ–çš„æŸ¥è¯¢åœºæ™¯</strong>ã€‚</p><ul><li><strong>åšæ³•ï¼š</strong><ol><li><strong>å®šä¹‰æ„å›¾ï¼š</strong> é¢„å…ˆå®šä¹‰å¥½ç”¨æˆ·å¯èƒ½é—®çš„å‡ ç±»é—®é¢˜ï¼Œå¦‚â€œæŸ¥è¯¢æŸäº§å“æŸæ—¶é—´æ®µçš„é”€å”®é¢â€ã€â€œå¯¹æ¯”æŸä¸¤ä¸ªæŒ‡æ ‡çš„è¶‹åŠ¿â€ã€‚</li><li><strong>åˆ¶ä½œæ¨¡æ¿ï¼š</strong> ä¸ºæ¯ä¸ªæ„å›¾ç¼–å†™ä¸€ä¸ªæˆ–å¤šä¸ª SQL æ¨¡æ¿ï¼Œæ¨¡æ¿ä¸­ç”¨å˜é‡å ä½ç¬¦ï¼ˆå¦‚<code>$&#123;product_name&#125;</code>, <code>$&#123;start_date&#125;</code>ï¼‰ä»£æ›¿å…·ä½“å€¼ã€‚</li><li><strong>æ„å›¾è¯†åˆ«ä¸æ§½ä½å¡«å……ï¼š</strong> å½“ç”¨æˆ·æé—®æ—¶ï¼Œå…ˆç”¨ä¸€ä¸ªè½»é‡çº§çš„ NLP æ¨¡å‹ï¼ˆæˆ–è§„åˆ™ï¼‰è¯†åˆ«å‡ºç”¨æˆ·æ„å›¾å±äºå“ªä¸ªæ¨¡æ¿ï¼Œç„¶åæŠ½å–å‡ºå¯¹åº”çš„å˜é‡å€¼ã€‚</li><li><strong>SQL ç”Ÿæˆä¸æ‰§è¡Œï¼š</strong> å°†å˜é‡å€¼å¡«å…¥æ¨¡æ¿ï¼Œç”Ÿæˆæœ€ç»ˆçš„ SQLï¼Œåœ¨åªè¯»æ•°æ®åº“ä¸Šæ‰§è¡Œã€‚</li></ol></li><li><strong>ä¼˜ç‚¹ï¼š</strong> 100%å¯æ§ã€å®‰å…¨ã€ç»“æœå‡†ç¡®ã€å¼€å‘æˆæœ¬ä½ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> æä¸çµæ´»ï¼Œæ— æ³•å¤„ç†æ¨¡æ¿ä¹‹å¤–çš„ä»»ä½•é—®é¢˜ï¼Œç»´æŠ¤æˆæœ¬éšæ¨¡æ¿æ•°é‡å¢åŠ è€Œä¸Šå‡ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong> å›ºå®šæŠ¥è¡¨ã€BI çœ‹æ¿çš„è‡ªç„¶è¯­è¨€äº¤äº’å…¥å£ã€‚</li></ul><h4 id="æ€è·¯äºŒï¼šè¯­ä¹‰è§£æ-æ··åˆæ¨¡å¼ï¼ˆå¹³è¡¡æ€§ä¸çµæ´»æ€§å…¼å¤‡ï¼‰"><a href="#æ€è·¯äºŒï¼šè¯­ä¹‰è§£æ-æ··åˆæ¨¡å¼ï¼ˆå¹³è¡¡æ€§ä¸çµæ´»æ€§å…¼å¤‡ï¼‰" class="headerlink" title="æ€è·¯äºŒï¼šè¯­ä¹‰è§£æ + æ··åˆæ¨¡å¼ï¼ˆå¹³è¡¡æ€§ä¸çµæ´»æ€§å…¼å¤‡ï¼‰"></a>æ€è·¯äºŒï¼šè¯­ä¹‰è§£æ + æ··åˆæ¨¡å¼ï¼ˆå¹³è¡¡æ€§ä¸çµæ´»æ€§å…¼å¤‡ï¼‰</h4><p>è¿™æ˜¯ç›®å‰ä¼ä¸šçº§åº”ç”¨<strong>æœ€ä¸»æµã€æœ€åŠ¡å®</strong>çš„æ–¹æ¡ˆã€‚</p><ul><li><strong>æ ¸å¿ƒç»„ä»¶ï¼š</strong><ol><li><strong>å…ƒæ•°æ®å±‚&#x2F;çŸ¥è¯†å›¾è°±ï¼š</strong> è¿™æ˜¯æ•´ä¸ªæ–¹æ¡ˆçš„åŸºçŸ³ï¼äººå·¥æˆ–åŠè‡ªåŠ¨åœ°æ„å»ºä¸€ä¸ªå±‚ï¼Œå®ƒä¸ä»…åŒ…å«æ•°æ®åº“çš„ Schemaï¼ˆè¡¨ã€åˆ—ã€ç±»å‹ï¼‰ï¼Œæ›´é‡è¦çš„æ˜¯åŒ…å«<strong>ä¸šåŠ¡æœ¯è¯­æ˜ å°„</strong>ï¼ˆå¦‚â€œGMVâ€å¯¹åº”<code>order_table.pay_amount</code>ï¼‰ã€<strong>ä¸šåŠ¡é€»è¾‘å®šä¹‰</strong>ï¼ˆå¦‚â€œVIP å®¢æˆ·â€çš„å®šä¹‰ SQLï¼‰ã€<strong>è¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³»</strong>ç­‰ã€‚</li><li><strong>æ„å›¾ä¸å®ä½“è¯†åˆ«ï¼š</strong> ä½¿ç”¨ LLM æˆ–ä¼ ç»Ÿæ¨¡å‹ï¼Œå°†ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€é—®é¢˜æ‹†è§£ä¸ºï¼š<strong>æ„å›¾</strong>ï¼ˆåšä»€ä¹ˆï¼Œå¦‚<code>è¶‹åŠ¿åˆ†æ</code>ã€<code>ç»´åº¦ä¸‹é’»</code>ï¼‰ã€<strong>æŒ‡æ ‡</strong>ï¼ˆçœ‹ä»€ä¹ˆï¼Œå¦‚<code>é”€å”®é¢</code>ã€<code>ç”¨æˆ·æ•°</code>ï¼‰ã€<strong>ç»´åº¦</strong>ï¼ˆä»ä»€ä¹ˆè§’åº¦çœ‹ï¼Œå¦‚<code>æŒ‰äº§å“çº¿</code>ã€<code>æŒ‰åœ°åŒº</code>ï¼‰ã€<strong>ç­›é€‰æ¡ä»¶</strong>ï¼ˆé™å®šèŒƒå›´ï¼Œå¦‚<code>æ—¶é—´=æœ€è¿‘ 30 å¤©</code>ï¼‰ã€‚</li><li><strong>è¯­ä¹‰è§£æä¸ SQL ç»„è£…ï¼š</strong><ul><li>å°†è¯†åˆ«å‡ºçš„<strong>æŒ‡æ ‡ã€ç»´åº¦</strong>é€šè¿‡å…ƒæ•°æ®å±‚æ˜ å°„åˆ°å…·ä½“çš„è¡¨å’Œå­—æ®µã€‚</li><li>å°†<strong>æ„å›¾</strong>è½¬åŒ–ä¸º SQL çš„æ“ä½œç±»å‹ï¼ˆ<code>SELECT</code>, <code>GROUP BY</code>, <code>ORDER BY</code>ç­‰ï¼‰ã€‚</li><li>å°†<strong>ç­›é€‰æ¡ä»¶</strong>è½¬åŒ–ä¸º<code>WHERE</code>å­å¥ã€‚</li><li>ç”±ä¸€ä¸ª<strong>SQL ç»„è£…å™¨</strong>å°†è¿™äº›è§£æå¥½çš„ç‰‡æ®µï¼Œæ ¹æ®é¢„å®šä¹‰çš„è§„åˆ™ï¼Œæ‹¼è£…æˆä¸€æ¡åˆæ³•çš„ SQLã€‚</li></ul></li></ol></li><li><strong>ä¼˜ç‚¹ï¼š</strong> æ¯”çº¯æ¨¡æ¿çµæ´»ï¼Œæ¯”çº¯ LLM å¯æ§ã€‚é€šè¿‡å…ƒæ•°æ®å±‚ï¼Œå°†å¤æ‚çš„ä¸šåŠ¡çŸ¥è¯†â€œæ³¨å…¥â€äº†ç³»ç»Ÿï¼Œè§£å†³äº†æ¨¡å‹ä¸çŸ¥é“â€œVIP å®¢æˆ·â€æ˜¯ä»€ä¹ˆçš„é—®é¢˜ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> æ¶æ„å¤æ‚ï¼Œå‰æœŸæ„å»ºå…ƒæ•°æ®å±‚çš„å·¥ä½œé‡å·¨å¤§ï¼Œéœ€è¦ä¸šåŠ¡ä¸“å®¶æ·±åº¦å‚ä¸ã€‚</li></ul><h4 id="æ€è·¯ä¸‰ï¼šå¤§æ¨¡å‹å¢å¼ºä¸ç²¾è°ƒï¼ˆè¿½æ±‚æè‡´çš„çµæ´»æ€§ï¼‰"><a href="#æ€è·¯ä¸‰ï¼šå¤§æ¨¡å‹å¢å¼ºä¸ç²¾è°ƒï¼ˆè¿½æ±‚æè‡´çš„çµæ´»æ€§ï¼‰" class="headerlink" title="æ€è·¯ä¸‰ï¼šå¤§æ¨¡å‹å¢å¼ºä¸ç²¾è°ƒï¼ˆè¿½æ±‚æè‡´çš„çµæ´»æ€§ï¼‰"></a>æ€è·¯ä¸‰ï¼šå¤§æ¨¡å‹å¢å¼ºä¸ç²¾è°ƒï¼ˆè¿½æ±‚æè‡´çš„çµæ´»æ€§ï¼‰</h4><p>è¿™æ˜¯æŠ€æœ¯æœ€å‰æ²¿çš„æ–¹æ¡ˆï¼Œæ—¨åœ¨å¤„ç†æ›´å¼€æ”¾ã€æ›´å¤æ‚çš„æ¢ç´¢æ€§åˆ†æã€‚</p><ul><li><strong>æ ¸å¿ƒæŠ€æœ¯ï¼š</strong><ol><li><strong>æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ï¼š</strong> è¿™æ˜¯<strong>å¿…ä¸å¯å°‘</strong>çš„ä¸€æ­¥ã€‚åœ¨å‘ LLM æé—®å‰ï¼Œå…ˆä»å…ƒæ•°æ®å±‚&#x2F;çŸ¥è¯†å›¾è°±ä¸­æ£€ç´¢å‡ºä¸é—®é¢˜æœ€ç›¸å…³çš„è¡¨ç»“æ„ã€å­—æ®µæè¿°ã€ä¸šåŠ¡é€»è¾‘è¯´æ˜ã€ç”šè‡³å‡ ä¸ªé«˜è´¨é‡çš„ï¼ˆé—®é¢˜ï¼ŒSQLï¼‰ç¤ºä¾‹ï¼Œç„¶åå°†è¿™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸€èµ·å¡ç»™ LLMã€‚<ul><li><strong>Prompt ç¤ºä¾‹ï¼š</strong> â€œä½ æ˜¯ä¸€ä¸ª SQL ä¸“å®¶ã€‚ä»¥ä¸‹æ˜¯æ•°æ®åº“çš„è¡¨ç»“æ„å’Œç›¸å…³ä¸šåŠ¡è¯´æ˜â€¦ [æ­¤å¤„æ’å…¥ RAG æ£€ç´¢åˆ°çš„ä¿¡æ¯]â€¦ è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œå°†ä»¥ä¸‹é—®é¢˜è½¬æ¢ä¸º SQLï¼šâ€™â€¦â€™â€</li></ul></li><li><strong>æ¨¡å‹ç²¾è°ƒï¼š</strong> å¦‚æœæœ‰è¶³å¤Ÿçš„é«˜è´¨é‡æ ‡æ³¨æ•°æ®ï¼ˆé—®é¢˜ï¼ŒSQLï¼‰ï¼Œå¯ä»¥å¯¹å¼€æºå¤§æ¨¡å‹ï¼ˆå¦‚ CodeLlama, StarCoderï¼‰æˆ–é€šè¿‡ API å¯¹é—­æºæ¨¡å‹è¿›è¡Œç²¾è°ƒï¼Œè®©å®ƒæ›´ç†Ÿæ‚‰è‡ªå·±å…¬å¸çš„æ•°æ®æ¨¡å¼å’Œæé—®é£æ ¼ã€‚</li><li><strong>SQL æ ¡éªŒä¸æ‰§è¡Œæ²™ç®±ï¼š</strong> è¿™æ˜¯<strong>æœ€åçš„é˜²çº¿</strong>ã€‚<ul><li><strong>è¯­æ³•æ ¡éªŒï¼š</strong> ç”¨ SQL è§£æå™¨æ£€æŸ¥ç”Ÿæˆçš„ SQL è¯­æ³•æ˜¯å¦æ­£ç¡®ã€‚</li><li><strong>æƒé™ä¸å®‰å…¨æ ¡éªŒï¼š</strong> è®¾ç½®ç™½åå•ï¼Œåªå…è®¸<code>SELECT</code>æ“ä½œï¼Œç¦æ­¢<code>DROP/UPDATE/DELETE</code>ã€‚é™åˆ¶æŸ¥è¯¢çš„å¤æ‚åº¦å’Œæ‰§è¡Œæ—¶é—´ã€‚</li><li><strong>æ²™ç®±æ‰§è¡Œï¼š</strong> åœ¨æ•°æ®åº“çš„åªè¯»å‰¯æœ¬ä¸Šæ‰§è¡Œï¼Œå¹¶è®¾ç½®èµ„æºä¸Šé™ï¼Œé˜²æ­¢æŸ¥è¯¢æ‰“å®ç”Ÿäº§åº“ã€‚</li><li><strong>ç»“æœåˆç†æ€§æ ¡éªŒï¼š</strong> ç®€å•æ£€æŸ¥è¿”å›çš„è¡Œæ•°ã€æ•°å€¼èŒƒå›´æ˜¯å¦åœ¨åˆç†åŒºé—´ã€‚</li></ul></li></ol></li><li><strong>ä¼˜ç‚¹ï¼š</strong> èƒ½å¤„ç†æœ€å¤æ‚çš„ã€å¼€æ”¾å¼çš„æŸ¥è¯¢ï¼Œç”¨æˆ·ä½“éªŒæœ€å¥½ï¼Œæœ€æ¥è¿‘â€œæ™ºèƒ½åˆ†æå¸ˆâ€ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> æˆæœ¬æœ€é«˜ï¼ˆAPI è°ƒç”¨ã€GPU ç®—åŠ›ï¼‰ï¼ŒæŠ€æœ¯æ ˆæœ€å¤æ‚ï¼Œå¯¹ RAG çš„è´¨é‡å’Œæ ¡éªŒæœºåˆ¶çš„ä¾èµ–æ€§æå¼ºï¼Œä»æœ‰â€œå¹»è§‰â€é£é™©ã€‚</li></ul><hr><h3 id="ä¸‰ã€æ˜¯ä¾æ‰˜ä¸“æœ‰å°æ¨¡å‹è¿˜æ˜¯åŸºäºæ¨¡ç‰ˆå®å¥—ç”¨æ›¿æ¢å˜é‡çš„æ–¹å¼ï¼Ÿ"><a href="#ä¸‰ã€æ˜¯ä¾æ‰˜ä¸“æœ‰å°æ¨¡å‹è¿˜æ˜¯åŸºäºæ¨¡ç‰ˆå®å¥—ç”¨æ›¿æ¢å˜é‡çš„æ–¹å¼ï¼Ÿ" class="headerlink" title="ä¸‰ã€æ˜¯ä¾æ‰˜ä¸“æœ‰å°æ¨¡å‹è¿˜æ˜¯åŸºäºæ¨¡ç‰ˆå®å¥—ç”¨æ›¿æ¢å˜é‡çš„æ–¹å¼ï¼Ÿ"></a>ä¸‰ã€æ˜¯ä¾æ‰˜ä¸“æœ‰å°æ¨¡å‹è¿˜æ˜¯åŸºäºæ¨¡ç‰ˆå®å¥—ç”¨æ›¿æ¢å˜é‡çš„æ–¹å¼ï¼Ÿ</h3><p>è¿™ä¸ªé—®é¢˜æœ¬èº«æ˜¯ä¸€ä¸ª<strong>ä¼ªäºŒåˆ†æ³•</strong>ã€‚æ­£ç¡®çš„ç­”æ¡ˆæ˜¯ï¼š<strong>æ ¹æ®åœºæ™¯ï¼Œç»„åˆä½¿ç”¨ï¼Œå®ƒä»¬ä¸æ˜¯äº’æ–¥å…³ç³»ã€‚</strong></p><ul><li><p><strong>åŸºäºæ¨¡ç‰ˆå®å¥—ç”¨æ›¿æ¢å˜é‡</strong>ï¼šæœ¬è´¨ä¸Šæ˜¯<strong>â€œè§„åˆ™å¼•æ“â€</strong>ã€‚å®ƒå¤„ç†çš„æ˜¯<strong>ç¡®å®šæ€§</strong>é—®é¢˜ã€‚å¯¹äºä¼ä¸šé‡Œ 80%çš„å¸¸è§„ã€é«˜é¢‘åˆ†æéœ€æ±‚ï¼Œç”¨æ¨¡æ¿+è§„åˆ™æ¥è¦†ç›–ï¼Œæ˜¯æˆæœ¬æ•ˆç›Šæœ€é«˜çš„é€‰æ‹©ã€‚è¿™ä¿è¯äº†ç³»ç»Ÿçš„ä¸‹é™ï¼ˆç¨³å®šã€å¯é ï¼‰ã€‚</p></li><li><p><strong>ä¾æ‰˜ä¸“æœ‰å°æ¨¡å‹</strong>ï¼šè¿™ä¸ªè¯´æ³•æ¯”è¾ƒå®½æ³›ã€‚åœ¨æ··åˆæ¶æ„ä¸­ï¼Œå°æ¨¡å‹å¯ä»¥æ‰®æ¼”ç‰¹å®šè§’è‰²ï¼Œæ¯”å¦‚ï¼š</p><ul><li><strong>æ„å›¾åˆ†ç±»æ¨¡å‹</strong>ï¼šä¸€ä¸ªå‡ ç™¾ä¸‡å‚æ•°çš„å°æ¨¡å‹ï¼Œè¶³ä»¥å¿«é€Ÿå‡†ç¡®åœ°åˆ¤æ–­ç”¨æˆ·é—®é¢˜å±äºâ€œé”€å”®åˆ†æâ€ã€â€œç”¨æˆ·åˆ†æâ€è¿˜æ˜¯â€œåº“å­˜åˆ†æâ€ã€‚</li><li><strong>å®ä½“è¯†åˆ«æ¨¡å‹</strong>ï¼šä¸“é—¨è´Ÿè´£ä»é—®é¢˜ä¸­æŠ½å–å‡ºäº§å“åã€äººåã€åœ°åç­‰ã€‚</li><li><strong>ç²¾è°ƒåçš„ Text-to-SQL å°æ¨¡å‹</strong>ï¼šå¯¹äºæ•°æ®ç»“æ„ç›¸å¯¹ç®€å•ã€ä¸šåŠ¡é€»è¾‘ä¸é‚£ä¹ˆå¤æ‚çš„å‚ç›´åœºæ™¯ï¼Œå¯ä»¥å°è¯•ç”¨å°æ¨¡å‹åšç«¯åˆ°ç«¯çš„ Text-to-SQLã€‚ä½†åœ¨å¤§å‹å¤æ‚ä¼ä¸šä¸­ï¼Œå®ƒå¾ˆéš¾ç‹¬è‡ªèƒœä»»ã€‚</li></ul></li></ul><p><strong>æœ€ä½³å®è·µçš„ç»“åˆè·¯å¾„ï¼š</strong></p><ol><li><strong>åŸºç¡€å±‚ï¼ˆè§„åˆ™ä¸æ¨¡æ¿ï¼‰ï¼š</strong> ç”¨æ¨¡æ¿å’Œå®è¦†ç›–æ‰€æœ‰å·²çŸ¥çš„ã€æ ‡å‡†åŒ–çš„åˆ†æåœºæ™¯ã€‚è¿™æ˜¯ç³»ç»Ÿçš„â€œå®‰å…¨å«â€ã€‚    </li><li><strong>å¢å¼ºå±‚ï¼ˆå°æ¨¡å‹ä¸å¤§æ¨¡å‹æ··åˆï¼‰ï¼š</strong>      <ul><li>å½“ç”¨æˆ·é—®é¢˜è¶…å‡ºæ¨¡æ¿èŒƒå›´æ—¶ï¼Œå¯åŠ¨æ··åˆæ¶æ„ã€‚</li><li>ç”¨<strong>å°æ¨¡å‹</strong>æˆ–<strong>è½»é‡çº§ LLM</strong>åšç¬¬ä¸€æ­¥çš„<strong>æ„å›¾è¯†åˆ«å’Œå®ä½“æŠ½å–</strong>ï¼Œè¿™ä¸€æ­¥è¦æ±‚å¿«å’Œå‡†ï¼Œå°æ¨¡å‹æ€§ä»·æ¯”é«˜ã€‚</li><li>å°†è§£æåçš„â€œè¯­ä¹‰ç‰‡æ®µâ€äº¤ç»™<strong>æ ¸å¿ƒå¼•æ“</strong>ã€‚è¿™ä¸ªå¼•æ“å¯ä»¥æ˜¯ä¸€ä¸ªåŸºäºå…ƒæ•°æ®çš„ SQL ç»„è£…å™¨ï¼ˆæ€è·¯äºŒï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç»è¿‡ RAG å¢å¼ºçš„<strong>å¤§æ¨¡å‹</strong>ï¼ˆæ€è·¯ä¸‰ï¼‰ï¼Œç”±å®ƒæ¥ç”Ÿæˆæœ€ç»ˆçš„å¤æ‚ SQLã€‚</li></ul></li><li><strong>å…œåº•å±‚ï¼ˆäººå·¥ä»‹å…¥ï¼‰ï¼š</strong> å½“ AI æ— æ³•å¤„ç†æˆ–ç½®ä¿¡åº¦ä½æ—¶ï¼Œå¹³æ»‘åœ°å°†é—®é¢˜è½¬ç»™äººå·¥åˆ†æå¸ˆï¼Œå¹¶å°†è¿™æ¬¡äº¤äº’è®°å½•ä¸‹æ¥ï¼Œä½œä¸ºæœªæ¥ä¼˜åŒ–æ¨¡å‹çš„å®è´µæ•°æ®ã€‚</li></ol><p>è®¾è®¡ä¸€ä¸ªé«˜å‡†ç¡®ç‡ï¼ˆâ‰¥95%ï¼‰ä¸”å…·å¤‡å¼ºå¤§å®¡æŸ¥æœºåˆ¶çš„ Text-to-SQL ç³»ç»Ÿï¼Œéœ€è¦<strong>ç³»ç»ŸåŒ–çš„æ¶æ„è®¾è®¡</strong>å’Œ<strong>å¤šå±‚æ¬¡çš„ä¿éšœæœºåˆ¶</strong>ã€‚æˆ‘ä¼šç»“åˆ<strong>æ··åˆæ¨¡å‹ç­–ç•¥</strong>ã€<strong>ä¸¥æ ¼çš„éªŒè¯æµç¨‹</strong>å’Œ<strong>æŒç»­çš„ä¼˜åŒ–æœºåˆ¶</strong>æ¥æ„å»ºè¿™ä¸ªç³»ç»Ÿã€‚</p><p>ä¸‹é¢æ˜¯æˆ‘çš„è®¾è®¡æ€è·¯å’Œæ–¹æ¡ˆï¼Œæˆ‘ä¼šç”¨ä¸€ä¸ªè¡¨æ ¼æ¥æ¦‚æ‹¬æ ¸å¿ƒçš„è®¾è®¡ç»´åº¦å’Œç­–ç•¥ï¼š</p><table><thead><tr><th align="left">è®¾è®¡ç»´åº¦</th><th align="left">æ ¸å¿ƒç­–ç•¥</th><th align="left">æŠ€æœ¯é€‰å‹&#x2F;æ–¹æ³•ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left"><strong>æ¨¡å‹é€‰æ‹©</strong></td><td align="left">æ··åˆæ¨¡å‹æ¶æ„ï¼ˆå¤§æ¨¡å‹+å°æ¨¡å‹+è§„åˆ™å¼•æ“ï¼‰ã€turn0search5ã€‘ã€turn0search8ã€‘</td><td align="left">LLMï¼ˆå¦‚ GPT-4ã€Qwen-Codeï¼‰ç”¨äºç†è§£å¤æ‚æ„å›¾ï¼›å°æ¨¡å‹ï¼ˆå¦‚å¾®è°ƒçš„ CodeT5ï¼‰å¤„ç†å¸¸è§„æŸ¥è¯¢ï¼›è§„åˆ™å¼•æ“å¤„ç†é«˜é¢‘æ¨¡æ¿</td></tr><tr><td align="left"><strong>çŸ¥è¯†å¢å¼º</strong></td><td align="left">æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ã€turn0search5ã€‘ã€turn0search17ã€‘</td><td align="left">æ„å»ºä¼ä¸šçº§çŸ¥è¯†åº“ï¼ˆSchemaã€ä¸šåŠ¡æœ¯è¯­ã€æŒ‡æ ‡å£å¾„ã€ä¼˜è´¨ SQL æ¡ˆä¾‹ï¼‰</td></tr><tr><td align="left"><strong>è¾“å…¥å¤„ç†</strong></td><td align="left">è‡ªç„¶è¯­è¨€ç†è§£ä¸æ„å›¾æ¾„æ¸…ã€turn0search5ã€‘ã€turn0search15ã€‘</td><td align="left">å¤šè½®å¯¹è¯æ¾„æ¸…æ¨¡ç³Šéœ€æ±‚ï¼›è¯†åˆ«å¹¶æ’é™¤æ•æ„Ÿè¯å’Œä¸å½“æ“ä½œã€turn0search4ã€‘</td></tr><tr><td align="left"><strong>SQL ç”Ÿæˆä¸ä¼˜åŒ–</strong></td><td align="left">åˆ†é˜¶æ®µç”Ÿæˆä¸ä¼˜åŒ–ã€turn0search15ã€‘</td><td align="left">å…ˆç”Ÿæˆæ ¸å¿ƒé€»è¾‘ï¼Œå†é€æ­¥æ·»åŠ å­å¥ï¼›åŸºäºæˆæœ¬å’Œæ‰§è¡Œè®¡åˆ’çš„ä¼˜åŒ–å»ºè®®</td></tr><tr><td align="left"><strong>éªŒè¯ä¸å®¡æŸ¥</strong></td><td align="left">å¤šå±‚æ¬¡éªŒè¯ï¼ˆè¯­æ³•ã€è¯­ä¹‰ã€æ‰§è¡Œã€å®‰å…¨ï¼‰ã€turn0search4ã€‘ã€turn0search15ã€‘</td><td align="left">SQL è§£æå™¨ã€æ²™ç®±ç¯å¢ƒã€ç»“æœé›†æ¯”å¯¹ã€æƒé™æ£€æŸ¥ã€é˜²æ³¨å…¥æ£€æµ‹ã€turn0search10ã€‘</td></tr><tr><td align="left"><strong>åé¦ˆä¸å­¦ä¹ </strong></td><td align="left">é—­ç¯åé¦ˆæœºåˆ¶ã€turn0search5ã€‘ã€turn0search8ã€‘</td><td align="left">äººå·¥å®¡æ ¸æ ‡æ³¨ã€é”™è¯¯æ¨¡å¼è‡ªåŠ¨åˆ†æã€æ¨¡å‹æŒç»­å¾®è°ƒ</td></tr></tbody></table><hr><h3 id="æ ¸å¿ƒè®¾è®¡æ€è·¯åŸåˆ™è¦ç‚¹"><a href="#æ ¸å¿ƒè®¾è®¡æ€è·¯åŸåˆ™è¦ç‚¹" class="headerlink" title="æ ¸å¿ƒè®¾è®¡æ€è·¯åŸåˆ™è¦ç‚¹"></a>æ ¸å¿ƒè®¾è®¡æ€è·¯åŸåˆ™è¦ç‚¹</h3><p>æˆ‘çš„è®¾è®¡éµå¾ªä»¥ä¸‹<strong>æ ¸å¿ƒåŸåˆ™</strong>ï¼š</p><ol><li><strong>ä¸ä¿¡ä»»å•ä¸€æ¨¡å‹</strong>ï¼šæ²¡æœ‰ä»»ä½•å•ä¸€æ¨¡å‹èƒ½å¯é å¤„ç†æ‰€æœ‰å¤æ‚æ€§ï¼Œå¿…é¡»é€šè¿‡<strong>æ··åˆæ¶æ„</strong>å’Œ<strong>å¤šé‡éªŒè¯</strong>æ¥è§„é¿é£é™©ã€‚    </li><li><strong>ç¡®å®šæ€§ä¼˜äºæ¦‚ç‡æ€§</strong>ï¼šåœ¨æ•°æ®æŸ¥è¯¢åœºæ™¯ï¼Œ<strong>å‡†ç¡®æ€§</strong>å’Œ<strong>å¯è§£é‡Šæ€§</strong>æ¯”çµæ´»æ€§æ›´é‡è¦ã€‚å¿…é¡»ç”¨è§„åˆ™å’Œç¬¦å· AI çº¦æŸå¤§æ¨¡å‹çš„â€œå¹»è§‰â€.   ã€turn0search3ã€‘ã€turn0search23ã€‘ã€‚</li><li><strong>äººæœºååŒï¼ŒæŒç»­è¿›åŒ–</strong>ï¼šç³»ç»Ÿåº”èƒ½ä»é”™è¯¯ä¸­å­¦ä¹ ï¼Œå¹¶é€šè¿‡<strong>äººå·¥å®¡æ ¸</strong>å’Œ<strong>åé¦ˆæœºåˆ¶</strong>æŒç»­ä¼˜åŒ–ã€turn0search5ã€‘ã€turn0search8ã€‘ã€‚</li></ol><hr><h3 id="ç³»ç»Ÿæ¶æ„è®¾è®¡"><a href="#ç³»ç»Ÿæ¶æ„è®¾è®¡" class="headerlink" title="ç³»ç»Ÿæ¶æ„è®¾è®¡"></a>ç³»ç»Ÿæ¶æ„è®¾è®¡</h3><p>åŸºæœ¬çš„è®¾è®¡çš„ç³»ç»Ÿæ¶æ„ç¤ºä¾‹å‚è€ƒï¼š</p><pre class="mermaid">graph LR    A[ç”¨æˆ·è‡ªç„¶è¯­è¨€æé—®] --> B[è¾“å…¥é¢„å¤„ç†ä¸ç†è§£]    B --> C[æ··åˆæ¨¡å‹ç”ŸæˆSQL]    C --> D[å¤šå±‚æ¬¡éªŒè¯ä¸å®¡æŸ¥]    D --> E[æ‰§è¡Œä¸ç»“æœè¿”å›]    E --> F[åé¦ˆä¸å­¦ä¹ é—­ç¯]    subgraph SB ["è¾“å…¥é¢„å¤„ç†ä¸ç†è§£"]        B1["æ„å›¾è¯†åˆ«ä¸å®ä½“æŠ½å–"]        B2["æ•æ„Ÿè¯ä¸æƒé™æ£€æŸ¥"]        B3["æ­§ä¹‰æ¾„æ¸…\nï¼ˆå¤šè½®å¯¹è¯ï¼‰"]    end    subgraph SC ["æ··åˆæ¨¡å‹ç”ŸæˆSQL"]        C1["å¤§æ¨¡å‹\nï¼ˆå¤æ‚æ„å›¾ç†è§£ï¼‰"]        C2["å°æ¨¡å‹/å¾®è°ƒæ¨¡å‹\nï¼ˆå¸¸è§„SQLç”Ÿæˆï¼‰"]        C3["è§„åˆ™å¼•æ“ä¸æ¨¡æ¿\nï¼ˆé«˜é¢‘/æ ‡å‡†åŒ–æŸ¥è¯¢ï¼‰"]        C4["RAGå¢å¼º\nï¼ˆæ£€ç´¢Schema/ç¤ºä¾‹ï¼‰"]    end    subgraph SD ["å¤šå±‚æ¬¡éªŒè¯ä¸å®¡æŸ¥"]        D1["è¯­æ³•ä¸è¯­ä¹‰éªŒè¯"]        D2["å®‰å…¨ä¸æƒé™å®¡æŸ¥"]        D3["æ²™ç®±æ‰§è¡Œæµ‹è¯•"]        D4["ç»“æœåˆç†æ€§é¢„ä¼°"]    end    subgraph SF ["åé¦ˆä¸å­¦ä¹ é—­ç¯"]        F1["ç”¨æˆ·åé¦ˆä¸æ ‡æ³¨"]        F2["é”™è¯¯æ¨¡å¼åˆ†æ"]        F3["æ¨¡å‹ä¸çŸ¥è¯†åº“æ›´æ–°"]    end    %% å†…éƒ¨è¿æ¥    C4 --> C1    C4 --> C2    C4 --> C3    C1 --> D    C2 --> D    C3 --> D    D --> E    E --> F1    F1 --> F2    F2 --> F3    F3 --> C4</pre><hr><h3 id="å¦‚ä½•ç¡®ä¿-95-ä»¥ä¸Šçš„å‡†ç¡®ç‡ï¼Ÿæˆ–è€…è¯´å¦‚æœæ˜¯ä½ ï¼Œåº”è¯¥ä»å“ªäº›æ–¹é¢ç»¼åˆè€ƒè™‘æŠ€æœ¯æ–¹æ¡ˆï¼Ÿ"><a href="#å¦‚ä½•ç¡®ä¿-95-ä»¥ä¸Šçš„å‡†ç¡®ç‡ï¼Ÿæˆ–è€…è¯´å¦‚æœæ˜¯ä½ ï¼Œåº”è¯¥ä»å“ªäº›æ–¹é¢ç»¼åˆè€ƒè™‘æŠ€æœ¯æ–¹æ¡ˆï¼Ÿ" class="headerlink" title="å¦‚ä½•ç¡®ä¿ 95%ä»¥ä¸Šçš„å‡†ç¡®ç‡ï¼Ÿæˆ–è€…è¯´å¦‚æœæ˜¯ä½ ï¼Œåº”è¯¥ä»å“ªäº›æ–¹é¢ç»¼åˆè€ƒè™‘æŠ€æœ¯æ–¹æ¡ˆï¼Ÿ"></a>å¦‚ä½•ç¡®ä¿ 95%ä»¥ä¸Šçš„å‡†ç¡®ç‡ï¼Ÿæˆ–è€…è¯´å¦‚æœæ˜¯ä½ ï¼Œåº”è¯¥ä»å“ªäº›æ–¹é¢ç»¼åˆè€ƒè™‘æŠ€æœ¯æ–¹æ¡ˆï¼Ÿ</h3><p>è¾¾åˆ° 95%ä»¥ä¸Šçš„å‡†ç¡®ç‡éœ€è¦ä¾èµ–<strong>æŠ€æœ¯ã€æµç¨‹å’Œäººå‘˜</strong>ä¸‰é‡ä¿éšœã€‚</p><h4 id="1-æŠ€æœ¯ä¿éšœï¼šæ··åˆæ¨¡å‹ä¸çŸ¥è¯†å¢å¼º"><a href="#1-æŠ€æœ¯ä¿éšœï¼šæ··åˆæ¨¡å‹ä¸çŸ¥è¯†å¢å¼º" class="headerlink" title="1. æŠ€æœ¯ä¿éšœï¼šæ··åˆæ¨¡å‹ä¸çŸ¥è¯†å¢å¼º"></a>1. æŠ€æœ¯ä¿éšœï¼šæ··åˆæ¨¡å‹ä¸çŸ¥è¯†å¢å¼º</h4><ul><li><p><strong>æ··åˆæ¨¡å‹ååŒ</strong>ï¼š</p><ul><li><strong>å¤§æ¨¡å‹ï¼ˆå¦‚ GPT-4ã€Qwen-Codeï¼‰</strong>ï¼šè´Ÿè´£ç†è§£å¤æ‚ã€æ¨¡ç³Šçš„è‡ªç„¶è¯­è¨€é—®é¢˜ï¼Œç”Ÿæˆåˆæ­¥ SQL é€»è¾‘ã€turn0search5ã€‘ã€turn0search20ã€‘ã€‚</li><li><strong>ä¸“ç”¨å°æ¨¡å‹&#x2F;å¾®è°ƒæ¨¡å‹</strong>ï¼šé’ˆå¯¹ä¼ä¸šå¸¸è§æŸ¥è¯¢æ¨¡å¼è¿›è¡Œå¾®è°ƒï¼Œé«˜æ•ˆå¤„ç†ä¸­ä½éš¾åº¦æŸ¥è¯¢ï¼Œé™ä½æˆæœ¬å’Œå»¶è¿Ÿã€turn0search8ã€‘ã€‚</li><li><strong>è§„åˆ™å¼•æ“ä¸æ¨¡æ¿</strong>ï¼šè¦†ç›– 20%çš„é«˜é¢‘ã€æ ‡å‡†åŒ–æŸ¥è¯¢ï¼ˆå¦‚â€œæŒ‰æ—¥æœŸæŸ¥çœ‹é”€å”®é¢â€ï¼‰ï¼Œç¡®ä¿ 100%å‡†ç¡®ã€turn0search2ã€‘ã€‚</li></ul></li><li><p><strong>RAG çŸ¥è¯†å¢å¼º</strong>ï¼šè¿™æ˜¯<strong>æå‡å‡†ç¡®ç‡æœ€å…³é”®çš„æŠ€æœ¯</strong>ä¹‹ä¸€ã€turn0search5ã€‘ã€turn0search17ã€‘ã€‚</p><ul><li><strong>æ„å»ºä¼ä¸šçº§çŸ¥è¯†åº“</strong>ï¼šåŒ…æ‹¬è¡¨ç»“æ„ã€å­—æ®µæ³¨é‡Šã€ä¸šåŠ¡æœ¯è¯­ã€æŒ‡æ ‡å£å¾„ã€ä¼˜è´¨ SQL æ¡ˆä¾‹ç­‰ã€‚</li><li><strong>åŠ¨æ€æ£€ç´¢</strong>ï¼šæ ¹æ®ç”¨æˆ·é—®é¢˜ï¼Œå®æ—¶æ£€ç´¢æœ€ç›¸å…³çš„ Schema ä¿¡æ¯å’Œç¤ºä¾‹ SQLï¼Œæ³¨å…¥åˆ° Prompt ä¸­ï¼Œå¼•å¯¼æ¨¡å‹ç”Ÿæˆæ›´å‡†ç¡®çš„æŸ¥è¯¢ã€turn0search5ã€‘ã€‚</li></ul></li></ul><h4 id="2-æµç¨‹ä¿éšœï¼šå¤šå±‚æ¬¡éªŒè¯ä¸å®¡æŸ¥"><a href="#2-æµç¨‹ä¿éšœï¼šå¤šå±‚æ¬¡éªŒè¯ä¸å®¡æŸ¥" class="headerlink" title="2. æµç¨‹ä¿éšœï¼šå¤šå±‚æ¬¡éªŒè¯ä¸å®¡æŸ¥"></a>2. æµç¨‹ä¿éšœï¼šå¤šå±‚æ¬¡éªŒè¯ä¸å®¡æŸ¥</h4><p>è¿™æ˜¯<strong>é˜²æ­¢é”™è¯¯ SQL è¾“å‡ºåˆ°ç”Ÿäº§ç¯å¢ƒ</strong>çš„å…³é”®é˜²çº¿ã€‚</p><table><thead><tr><th align="left">éªŒè¯å±‚çº§</th><th align="left">æ£€æŸ¥å†…å®¹</th><th align="left">æŠ€æœ¯æ‰‹æ®µ</th><th align="left">ç›®çš„</th></tr></thead><tbody><tr><td align="left"><strong>è¯­æ³•éªŒè¯</strong></td><td align="left">SQL è¯­æ³•æ­£ç¡®æ€§ã€è¡¨å&#x2F;å­—æ®µåå­˜åœ¨æ€§</td><td align="left">SQL è§£æå™¨ï¼ˆå¦‚ SQLGlotï¼‰ã€å…ƒæ•°æ®æŸ¥è¯¢</td><td align="left">æœç»è¯­æ³•é”™è¯¯ï¼Œé¿å…æ‰§è¡Œå¤±è´¥</td></tr><tr><td align="left"><strong>è¯­ä¹‰éªŒè¯</strong></td><td align="left">æŸ¥è¯¢é€»è¾‘æ˜¯å¦åˆç†ï¼ˆå¦‚ JOIN æ¡ä»¶ã€èšåˆå‡½æ•°ï¼‰</td><td align="left">åŸºäºå…ƒæ•°æ®çš„è§„åˆ™å¼•æ“ï¼ˆå¦‚æ£€æŸ¥å¤–é”®å…³è”ï¼‰ã€LLM è‡ªæˆ‘å®¡è§†</td><td align="left">é˜²æ­¢é€»è¾‘é”™è¯¯ï¼Œè¿”å›æ— æ„ä¹‰æˆ–é”™è¯¯æ•°æ®</td></tr><tr><td align="left"><strong>å®‰å…¨å®¡æŸ¥</strong></td><td align="left">æƒé™æ£€æŸ¥ã€SQL æ³¨å…¥æ”»å‡»é˜²æŠ¤ã€turn0search10ã€‘ã€æ•æ„Ÿæ“ä½œè¯†åˆ«ï¼ˆå¦‚ DROPã€UPDATEï¼‰</td><td align="left">SQL æ³¨å…¥æ£€æµ‹å·¥å…·ã€æƒé™ç³»ç»Ÿã€æ“ä½œç™½åå•</td><td align="left">ä¿éšœæ•°æ®å®‰å…¨ï¼Œé˜²æ­¢æ¶æ„æˆ–ç ´åæ€§æ“ä½œ</td></tr><tr><td align="left"><strong>æ‰§è¡Œæµ‹è¯•</strong></td><td align="left">åœ¨<strong>æ²™ç®±ç¯å¢ƒ</strong>ä¸­æ‰§è¡Œ SQLï¼Œæ£€æŸ¥è¿”å›ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ</td><td align="left">æŸ¥è¯¢ç»“æœé›†åˆç†æ€§æ ¡éªŒï¼ˆå¦‚è¡Œæ•°ã€æ•°å€¼èŒƒå›´ï¼‰ã€ä¸å†å²æŸ¥è¯¢ç»“æœå¯¹æ¯”</td><td align="left">æå‰å‘ç°æ½œåœ¨é—®é¢˜ï¼Œé¿å…å¯¹ç”Ÿäº§æ•°æ®åº“é€ æˆå½±å“</td></tr></tbody></table><h4 id="3-äººå‘˜ä¿éšœï¼šäººæœºååŒä¸åé¦ˆé—­ç¯"><a href="#3-äººå‘˜ä¿éšœï¼šäººæœºååŒä¸åé¦ˆé—­ç¯" class="headerlink" title="3. äººå‘˜ä¿éšœï¼šäººæœºååŒä¸åé¦ˆé—­ç¯"></a>3. äººå‘˜ä¿éšœï¼šäººæœºååŒä¸åé¦ˆé—­ç¯</h4><ul><li><strong>ä½ç½®ä¿¡åº¦å¤„ç†</strong>ï¼šå½“ç³»ç»Ÿå¯¹ç”Ÿæˆçš„ SQL ç½®ä¿¡åº¦è¾ƒä½æ—¶ï¼Œè‡ªåŠ¨è½¬äº¤äººå·¥å®¡æ ¸ã€‚<strong>â€œä¸ç¡®å®šæ—¶å°±æ‰¾äººâ€</strong> æ˜¯ä¿éšœä¼ä¸šçº§åº”ç”¨å¯é æ€§çš„é»„é‡‘æ³•åˆ™ã€‚</li><li><strong>åé¦ˆå­¦ä¹ é—­ç¯</strong>ã€turn0search5ã€‘ã€turn0search8ã€‘ï¼š<ol><li>ç”¨æˆ·å¯¹ç»“æœè¿›è¡Œ<strong>ç¡®è®¤</strong>æˆ–<strong>æ ‡æ³¨é”™è¯¯</strong>ã€‚</li><li>ç³»ç»Ÿæ”¶é›†é”™è¯¯çš„ï¼ˆé—®é¢˜ï¼ŒSQLï¼Œé”™è¯¯åŸå› ï¼‰ä¸‰å…ƒç»„ã€‚</li><li>å®šæœŸç”¨è¿™äº›é«˜è´¨é‡æ•°æ®<strong>å¾®è°ƒæ¨¡å‹</strong>å’Œ<strong>æ›´æ–°çŸ¥è¯†åº“</strong>ï¼Œè®©ç³»ç»ŸæŒç»­è¿›åŒ–ã€‚</li></ol></li></ul><hr><h3 id="âš ï¸å®¡æŸ¥æœºåˆ¶è®¾è®¡æ€è·¯"><a href="#âš ï¸å®¡æŸ¥æœºåˆ¶è®¾è®¡æ€è·¯" class="headerlink" title="âš ï¸å®¡æŸ¥æœºåˆ¶è®¾è®¡æ€è·¯"></a>âš ï¸å®¡æŸ¥æœºåˆ¶è®¾è®¡æ€è·¯</h3><p>å®¡æŸ¥æœºåˆ¶è´¯ç©¿äº SQL ç”Ÿæˆå‰ã€ç”Ÿæˆä¸­å’Œç”Ÿæˆåã€‚</p><ol><li><p><strong>ç”Ÿæˆå‰å®¡æŸ¥</strong>ï¼š</p><ul><li><strong>æƒé™é¢„æ£€</strong>ï¼šæ ¹æ®ç”¨æˆ·èº«ä»½ï¼Œæå‰è¿‡æ»¤å…¶æ— æƒè®¿é—®çš„è¡¨å’Œå­—æ®µï¼Œä»æºå¤´é¿å…è¶ŠæƒæŸ¥è¯¢ã€turn0search4ã€‘ã€‚</li><li><strong>æ•æ„Ÿè¯è¯†åˆ«</strong>ï¼šæ‹¦æˆªæˆ–è½¬ä¹‰å¯èƒ½å¼•å‘ SQL æ³¨å…¥çš„å…³é”®å­—ç¬¦ï¼ˆå¦‚ <code>&#39;</code>, <code>&quot;</code>, <code>;</code>, <code>--</code>ï¼‰ã€turn0search10ã€‘ã€‚</li></ul></li><li><p><strong>ç”Ÿæˆä¸­å®¡æŸ¥</strong>ï¼š</p><ul><li><strong>Prompt çº¦æŸ</strong>ï¼šåœ¨ Prompt ä¸­æ˜ç¡®è¦æ±‚åªç”Ÿæˆ<code>SELECT</code>æŸ¥è¯¢ï¼Œç¦æ­¢<code>DROP</code>, <code>UPDATE</code>, <code>DELETE</code>ç­‰æ“ä½œï¼Œå¹¶è¦æ±‚è¾“å‡ºå¸¦æ³¨é‡Šè§£é‡ŠæŸ¥è¯¢é€»è¾‘ã€‚</li><li><strong>æµå¼ç”Ÿæˆç›‘æ§</strong>ï¼šå¯¹æ¨¡å‹ç”Ÿæˆçš„ SQL è¿›è¡Œå®æ—¶æµå¼è¯­æ³•æ£€æŸ¥ï¼Œä¸€æ—¦å‘ç°ä¸¥é‡è¯­æ³•é”™è¯¯ç«‹å³ä¸­æ–­ç”Ÿæˆã€‚</li></ul></li><li><p><strong>ç”Ÿæˆåå®¡æŸ¥</strong>ï¼š</p><ul><li><strong>è‡ªåŠ¨åŒ–æµ‹è¯•</strong>ï¼šåœ¨æ²™ç®±ç¯å¢ƒä¸­æ‰§è¡Œ SQLï¼Œå¹¶ä¸<strong>é¢„æœŸç»“æœ</strong>ï¼ˆå¦‚æœ‰ï¼‰æˆ–<strong>è§„åˆ™å¼•æ“</strong>çš„åˆ¤æ–­è¿›è¡Œæ¯”å¯¹ã€‚</li><li><strong>äººå·¥å®¡æ ¸å¹³å°</strong>ï¼šæä¾›ç•Œé¢ä¾›æ•°æ®ç®¡ç†å‘˜å®¡æ ¸é«˜é£é™©æˆ–ä½ç½®ä¿¡åº¦çš„ SQLï¼Œå®¡æ ¸ç»“æœåé¦ˆç»™ç³»ç»Ÿç”¨äºå­¦ä¹ ã€‚</li></ul></li></ol><hr><h3 id="å®æ–½ä¸ä¼˜åŒ–å»ºè®®"><a href="#å®æ–½ä¸ä¼˜åŒ–å»ºè®®" class="headerlink" title="å®æ–½ä¸ä¼˜åŒ–å»ºè®®"></a>å®æ–½ä¸ä¼˜åŒ–å»ºè®®</h3><ol><li><p><strong>åˆ†é˜¶æ®µå®æ–½</strong>ï¼š</p><ul><li><strong>ç¬¬ä¸€é˜¶æ®µ</strong>ï¼šä»<strong>æ¨¡æ¿åŒ–æŸ¥è¯¢</strong>å’Œ<strong>ç®€å•æŸ¥è¯¢</strong>å…¥æ‰‹ï¼Œå¿«é€Ÿä¸Šçº¿ï¼Œç§¯ç´¯æ•°æ®å’Œä¿¡ä»»ã€‚</li><li><strong>ç¬¬äºŒé˜¶æ®µ</strong>ï¼šå¼•å…¥ RAG å’Œå¾®è°ƒæ¨¡å‹ï¼Œè¦†ç›–ä¸­ç­‰å¤æ‚åº¦æŸ¥è¯¢ã€‚</li><li><strong>ç¬¬ä¸‰é˜¶æ®µ</strong>ï¼šé€æ­¥å¼€æ”¾å¤æ‚æŸ¥è¯¢ï¼Œå¹¶å®Œå–„äººæœºååŒæµç¨‹ã€‚</li></ul></li><li><p><strong>ç›‘æ§ä¸è¯„ä¼°</strong>ï¼š</p><ul><li>å»ºç«‹ä»ªè¡¨ç›˜ï¼ŒæŒç»­ç›‘æ§<strong>å‡†ç¡®ç‡</strong>ã€<strong>ç½®ä¿¡åº¦åˆ†å¸ƒ</strong>ã€<strong>äººå·¥å®¡æ ¸ç‡</strong>ç­‰å…³é”®æŒ‡æ ‡ã€‚</li><li>å®šæœŸè¿›è¡Œ<strong>ç›²æµ‹</strong>ï¼ˆç”¨æ ‡æ³¨é›†æµ‹è¯•ç³»ç»Ÿï¼‰ï¼Œè¯„ä¼°çœŸå®å‡†ç¡®ç‡ã€‚</li></ul></li><li><p><strong>æˆæœ¬ä¸æ•ˆç‡å¹³è¡¡</strong>ï¼š</p><ul><li>é€šè¿‡<strong>æ™ºèƒ½è·¯ç”±</strong>ç­–ç•¥ï¼Œç®€å•æŸ¥è¯¢ç”¨å°æ¨¡å‹&#x2F;æ¨¡æ¿ï¼Œå¤æ‚æŸ¥è¯¢æ‰è°ƒç”¨å¤§æ¨¡å‹ï¼Œä¼˜åŒ–æˆæœ¬å’Œå“åº”é€Ÿåº¦ã€turn0search8ã€‘ã€‚</li></ul></li></ol><hr><p>è¿™ä¸ªè®¾è®¡æ€è·¯åªæ˜¯æä¾›ä¸€ç§ç›¸å¯¹æ¸…æ™°çš„æŒ‡å¼•ã€‚å¦‚æœä½ æœ‰æ›´å…·ä½“çš„åœºæ™¯æˆ–ç–‘é—®ï¼Œæˆ‘å¾ˆä¹æ„ç»§ç»­æ·±å…¥æ¢è®¨äº¤æµã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è®¾è®¡ä¸€ä¸ªé«˜å‡†ç¡®ç‡çš„ Text-to-SQL ç³»ç»Ÿï¼Œ<strong>æ ¸å¿ƒä¸æ˜¯å¯»æ‰¾ä¸€ä¸ªâ€œä¸‡èƒ½æ¨¡å‹â€ï¼Œè€Œæ˜¯æ„å»ºä¸€ä¸ªâ€œæ™ºèƒ½ç³»ç»Ÿâ€</strong>ã€‚è¿™ä¸ªç³»ç»Ÿé€šè¿‡<strong>æ··åˆæ¨¡å‹æ¶æ„</strong>å‘æŒ¥å„è‡ªä¼˜åŠ¿ï¼Œé€šè¿‡<strong>RAG</strong>æ³¨å…¥ä¼ä¸šçŸ¥è¯†ï¼Œé€šè¿‡<strong>ä¸¥æ ¼çš„éªŒè¯å®¡æŸ¥æœºåˆ¶</strong>ç¡®ä¿å®‰å…¨å¯é ï¼Œå¹¶é€šè¿‡<strong>äººæœºååŒçš„åé¦ˆé—­ç¯</strong>å®ç°æŒç»­è¿›åŒ–ã€‚</p><p>Text-to-SQL åœ¨ä¼ä¸šè½åœ°éš¾ï¼Œæ ¹æºåœ¨äºå®ƒä¸æ˜¯ä¸€ä¸ªçº¯ç²¹çš„æŠ€æœ¯é—®é¢˜ï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>æŠ€æœ¯ã€ä¸šåŠ¡ã€æ•°æ®æ²»ç†</strong>ä¸‰è€…äº¤ç»‡çš„ç³»ç»Ÿæ€§å·¥ç¨‹ã€‚</p><ul><li><strong>æ²¡æœ‰å…±è¯†æ€§æ–¹æ¡ˆ</strong>ï¼Œæ˜¯å› ä¸ºæ¯ä¸ªä¼ä¸šçš„æ•°æ®ã€ä¸šåŠ¡ã€å®‰å…¨è¦æ±‚éƒ½ç‹¬ä¸€æ— äºŒã€‚</li><li><strong>æœ€é è°±çš„æ€è·¯</strong>æ˜¯æ”¾å¼ƒâ€œä¸€ä¸ªæ¨¡å‹æå®šä¸€åˆ‡â€çš„å¹»æƒ³ï¼Œè½¬å‘<strong>â€œäººæœºååŒã€æ··åˆæ¶æ„â€</strong>çš„é“è·¯ï¼Œç”¨å·¥ç¨‹åŒ–çš„ç¡®å®šæ€§å»çº¦æŸ AI çš„ä¸ç¡®å®šæ€§ã€‚</li><li><strong>æŠ€æœ¯é€‰å‹ä¸Š</strong>ï¼Œä¸è¦çº ç»“äºâ€œå°æ¨¡å‹è¿˜æ˜¯æ¨¡æ¿â€ï¼Œè€Œè¦æ€è€ƒå¦‚ä½•å°†<strong>æ¨¡æ¿çš„ç¡®å®šæ€§ã€å°æ¨¡å‹çš„é«˜æ•ˆæ€§ã€å¤§æ¨¡å‹çš„çµæ´»æ€§</strong>ä»¥åŠ<strong>å…ƒæ•°æ®å±‚çš„çŸ¥è¯†æ€§</strong>æœ‰æœºåœ°æ•´åˆåœ¨ä¸€èµ·ï¼Œæ„å»ºä¸€ä¸ªæ—¢èƒ½æ»¡è¶³ 80%å¸¸è§„éœ€æ±‚ï¼Œåˆèƒ½æ¢ç´¢ 20%å¤æ‚é—®é¢˜çš„ã€å¯ä¿¡èµ–çš„åˆ†æç³»ç»Ÿã€‚</li></ul><h6 id="ä»¥ä¸Šæ–¹æ¡ˆä»…æä¾›ç›¸å…³æ€è·¯çš„å®ç°ï¼Œå…·ä½“å®ç°æ–¹å¼è¦ç»“åˆå®é™…ä¸šåŠ¡ç‰¹ç‚¹å±•å¼€ï¼æˆ–è€…å¦‚æœä½ æœ‰æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿æå‡ºæ¥ï¼Œä¸€èµ·è®¨è®ºå’Œäº¤æµã€‚"><a href="#ä»¥ä¸Šæ–¹æ¡ˆä»…æä¾›ç›¸å…³æ€è·¯çš„å®ç°ï¼Œå…·ä½“å®ç°æ–¹å¼è¦ç»“åˆå®é™…ä¸šåŠ¡ç‰¹ç‚¹å±•å¼€ï¼æˆ–è€…å¦‚æœä½ æœ‰æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿æå‡ºæ¥ï¼Œä¸€èµ·è®¨è®ºå’Œäº¤æµã€‚" class="headerlink" title="ä»¥ä¸Šæ–¹æ¡ˆä»…æä¾›ç›¸å…³æ€è·¯çš„å®ç°ï¼Œå…·ä½“å®ç°æ–¹å¼è¦ç»“åˆå®é™…ä¸šåŠ¡ç‰¹ç‚¹å±•å¼€ï¼æˆ–è€…å¦‚æœä½ æœ‰æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿æå‡ºæ¥ï¼Œä¸€èµ·è®¨è®ºå’Œäº¤æµã€‚"></a>ä»¥ä¸Šæ–¹æ¡ˆä»…æä¾›ç›¸å…³æ€è·¯çš„å®ç°ï¼Œå…·ä½“å®ç°æ–¹å¼è¦ç»“åˆå®é™…ä¸šåŠ¡ç‰¹ç‚¹å±•å¼€ï¼æˆ–è€…å¦‚æœä½ æœ‰æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿æå‡ºæ¥ï¼Œä¸€èµ·è®¨è®ºå’Œäº¤æµã€‚</h6><p>è”ç³»æ–¹å¼ï¼š<a href="https://github.com/ljq">https://github.com/ljq</a>.<br>WeChat: labsec</p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;


&lt;h3 id=&quot;Agent-å•†ä¸šè½åœ°é‡Œæœ€éš¾çš„æ˜¯-Text2SQLï¼ˆNL2SQLï¼‰ï¼Œå‡ ä¹æ˜¯æ— æ³•ç»•å¼€çš„æ ¸å¿ƒç—›ç‚¹ï¼Œä¸»è¦é¢ä¸´çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š&quot;&gt;&lt;a href=&quot;#Agent-å•†ä¸šè½åœ°é‡Œæœ€éš¾çš„æ˜¯-Text2SQLï¼ˆNL2SQLï¼‰ï¼Œå‡ ä¹æ˜¯æ— æ³•ç»•å¼€çš„æ ¸å¿ƒç—›ç‚¹ï¼Œä¸»è¦é¢ä¸´çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š&quot; class=&quot;headerlink&quot; title=&quot;Agent å•†ä¸šè½åœ°é‡Œæœ€éš¾çš„æ˜¯ Text2SQLï¼ˆNL2SQLï¼‰ï¼Œå‡ ä¹æ˜¯æ— æ³•ç»•å¼€çš„æ ¸å¿ƒç—›ç‚¹ï¼Œä¸»è¦é¢ä¸´çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š&quot;&gt;&lt;/a&gt;Agent å•†ä¸šè½åœ°é‡Œæœ€éš¾çš„æ˜¯ Text2SQLï¼ˆNL2SQLï¼‰ï¼Œå‡ ä¹æ˜¯æ— æ³•ç»•å¼€çš„æ ¸å¿ƒç—›ç‚¹ï¼Œä¸»è¦é¢ä¸´çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;ä¸ºä»€ä¹ˆåˆ°ç›®å‰ä¸ºæ­¢ä»ç„¶æ²¡æœ‰çœŸæ­£å¯é çš„å•†ä¸šå…±è¯†æ€§ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼Ÿ&lt;/li&gt;
&lt;li&gt;å®é™…ä¼ä¸šåº”ç”¨åœºæ™¯ä¸­ï¼Œæœ‰å“ªäº›é è°±çš„æ€è·¯å’Œè§£å†³æ–¹æ¡ˆï¼Ÿ</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/tags/Agent/"/>
    
    <category term="Text2SQL" scheme="https://www.wdft.com/tags/Text2SQL/"/>
    
  </entry>
  
  <entry>
    <title>Ultimate Guide to Quantizing AI Large Language Models: From FP32 to INT4, How to Make Large Models Perform at Full Speed on Consumer Devices?ï¼ˆAI å¤§è¯­è¨€æ¨¡å‹é‡åŒ–ç»ˆææŒ‡å—ï¼šä» FP32 åˆ° INT4ï¼Œå¦‚ä½•è®©å¤§æ¨¡å‹åœ¨æ¶ˆè´¹çº§è®¾å¤‡éƒ¨ç½²åº”ç”¨åŠé€‰å‹ï¼Ÿï¼‰</title>
    <link href="https://www.wdft.com/225323a0.html"/>
    <id>https://www.wdft.com/225323a0.html</id>
    <published>2025-12-02T14:29:13.000Z</published>
    <updated>2026-01-26T09:20:19.071Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><p><strong>â€”â€”æ·±åº¦è§£æé‡åŒ–æ ¼å¼ã€å°ºå¯¸å·®å¼‚ä¸ç¡¬ä»¶é€‚é…ç­–ç•¥ï¼ˆé™„ M3 Pro å®æˆ˜æŒ‡å—ï¼‰</strong></p><p>ä¸ªäººå¸¸ç”¨åŠå…¬ç»ˆç«¯è®¾å¤‡å‹å·ï¼š</p><ul><li><strong>Macbook Pro M3 ï¼ˆ36G å†…å­˜å®šåˆ¶æ¬¾)</strong></li></ul><blockquote><p><strong>å°ç»“</strong>ï¼š  </p><ul><li>ğŸ’¡ <strong>Apple ç”¨æˆ·é—­çœ¼é€‰ BF16</strong>ï¼šM3 Pro èŠ¯ç‰‡çš„ BF16 æ€§èƒ½ç¢¾å‹ FP16ï¼Œ18GB å†…å­˜å¯æµç•…è¿è¡Œ 30B çº§æ¨¡å‹  </li><li>âš ï¸ <strong>INT4 æ˜¯åŒåˆƒå‰‘</strong>ï¼š70B æ¨¡å‹å¡è¿› 36GB å†…å­˜çš„å”¯ä¸€æ–¹æ¡ˆï¼Œä½†ç²¾åº¦æŸå¤±é«˜è¾¾ 15%+  </li><li>ğŸ”® <strong>æœªæ¥å±äº FP8</strong>ï¼šNVIDIA H100 å·²æ”¯æŒï¼Œè‹¹æœ M4 æˆ–æˆè½¬æŠ˜ç‚¹</li></ul></blockquote><span id="more"></span><hr><h3 id="ä¸€ã€ä¸ºä»€ä¹ˆé‡åŒ–æ˜¯-AI-è½åœ°çš„â€œç ´å£æœºâ€ï¼Ÿ"><a href="#ä¸€ã€ä¸ºä»€ä¹ˆé‡åŒ–æ˜¯-AI-è½åœ°çš„â€œç ´å£æœºâ€ï¼Ÿ" class="headerlink" title="ä¸€ã€ä¸ºä»€ä¹ˆé‡åŒ–æ˜¯ AI è½åœ°çš„â€œç ´å£æœºâ€ï¼Ÿ"></a>ä¸€ã€ä¸ºä»€ä¹ˆé‡åŒ–æ˜¯ AI è½åœ°çš„â€œç ´å£æœºâ€ï¼Ÿ</h3><p>å½“ Llama-3-70B è¿™æ ·çš„å·¨å…½éœ€è¦<strong>280GB æ˜¾å­˜</strong>ï¼ˆFP32ï¼‰æ‰èƒ½è¿è¡Œæ—¶ï¼Œæ¶ˆè´¹çº§è®¾å¤‡åªèƒ½æœ›æ´‹å…´å¹ã€‚é‡åŒ–æŠ€æœ¯é€šè¿‡<strong>é™ä½æ•°å€¼ç²¾åº¦</strong>ï¼Œå®ç°ä¸‰é‡é©å‘½ï¼š  </p><ul><li><strong>ä½“ç§¯å‹ç¼©</strong>ï¼š70B æ¨¡å‹ä» 280GB â†’ 35GBï¼ˆINT4ï¼‰  </li><li><strong>é€Ÿåº¦é£è·ƒ</strong>ï¼šM3 Pro ä¸Š INT4 æ¨ç†é€Ÿåº¦è¾¾ BF16 çš„<strong>1.8 å€</strong>  </li><li><strong>åŠŸè€—éª¤é™</strong>ï¼šæ‰‹æœºç«¯ INT8 æ¨¡å‹èƒ½è€—ä»…ä¸º FP32 çš„<strong>1&#x2F;6</strong></li></ul><blockquote><p>âœ¨ <strong>æœ¬è´¨</strong>ï¼šç”¨å¯æ§çš„ç²¾åº¦æŸå¤±ï¼Œæ¢å–ä¸å¯æ›¿ä»£çš„éƒ¨ç½²è‡ªç”±ã€‚ä½†é€‰é”™é‡åŒ–æ ¼å¼ï¼Œå¯èƒ½è®©æ¨¡å‹â€œæ™ºå•†å½’é›¶â€â€”â€”æœ¬æ–‡å°†æ­ç¤ºå¦‚ä½•ç²¾å‡†å¹³è¡¡è¿™æŠŠåŒåˆƒå‰‘ã€‚</p></blockquote><hr><h3 id="äºŒã€é‡åŒ–æ ¼å¼æ·±åº¦è§£å‰–ï¼š6-ç§ç²¾åº¦çš„è¡€ä¸ç«"><a href="#äºŒã€é‡åŒ–æ ¼å¼æ·±åº¦è§£å‰–ï¼š6-ç§ç²¾åº¦çš„è¡€ä¸ç«" class="headerlink" title="äºŒã€é‡åŒ–æ ¼å¼æ·±åº¦è§£å‰–ï¼š6 ç§ç²¾åº¦çš„è¡€ä¸ç«"></a>äºŒã€é‡åŒ–æ ¼å¼æ·±åº¦è§£å‰–ï¼š6 ç§ç²¾åº¦çš„è¡€ä¸ç«</h3><h4 id="1-FP32ï¼ˆ32-ä½æµ®ç‚¹ï¼‰"><a href="#1-FP32ï¼ˆ32-ä½æµ®ç‚¹ï¼‰" class="headerlink" title="(1) FP32ï¼ˆ32 ä½æµ®ç‚¹ï¼‰"></a><strong>(1) FP32ï¼ˆ32 ä½æµ®ç‚¹ï¼‰</strong></h4><ul><li><strong>å®šä½</strong>ï¼šç²¾åº¦åœ£æ®¿ï¼Œèµ„æºé»‘æ´  </li><li><strong>çœŸç›¸</strong>ï¼š  <ul><li>23 ä½å°¾æ•°+8 ä½æŒ‡æ•°ï¼ŒåŠ¨æ€èŒƒå›´â‰ˆ10â»â·âµ~10Â³â¸  </li><li><strong>è‡´å‘½ä¼¤</strong>ï¼š7B æ¨¡å‹éœ€ 28GB æ˜¾å­˜ï¼ŒM3 Pro 18GB å†…å­˜ç›´æ¥å´©æºƒ</li></ul></li><li><strong>é€‚ç”¨</strong>ï¼šä»…é™äº‘æœåŠ¡å™¨è®­ç»ƒï¼Œæ¶ˆè´¹è®¾å¤‡<strong>ç»å¯¹ç¦ç”¨</strong></li></ul><h4 id="2-BF16-vs-FP16ï¼šè‹¹æœä¸-NVIDIA-çš„â€œæ ¼å¼æˆ˜äº‰â€"><a href="#2-BF16-vs-FP16ï¼šè‹¹æœä¸-NVIDIA-çš„â€œæ ¼å¼æˆ˜äº‰â€" class="headerlink" title="(2) BF16 vs FP16ï¼šè‹¹æœä¸ NVIDIA çš„â€œæ ¼å¼æˆ˜äº‰â€"></a><strong>(2) BF16 vs FP16ï¼šè‹¹æœä¸ NVIDIA çš„â€œæ ¼å¼æˆ˜äº‰â€</strong></h4><table><thead><tr><th><strong>ç‰¹æ€§</strong></th><th><strong>BF16 (Brain Float)</strong></th><th><strong>FP16 (Half Float)</strong></th></tr></thead><tbody><tr><td><strong>ä½æ•°åˆ†é…</strong></td><td>8 ä½æŒ‡æ•° + 7 ä½å°¾æ•°</td><td>5 ä½æŒ‡æ•° + 10 ä½å°¾æ•°</td></tr><tr><td><strong>åŠ¨æ€èŒƒå›´</strong></td><td>â‰ˆFP32ï¼ˆ10â»â·âµ~10Â³â¸ï¼‰</td><td>10â»Â¹â´~10Â¹âµï¼ˆæ˜“æº¢å‡ºï¼‰</td></tr><tr><td><strong>M3 Pro æ€§èƒ½</strong></td><td>âœ… åŸç”ŸåŠ é€Ÿï¼Œå¸¦å®½åˆ©ç”¨ç‡ 98%</td><td>âŒ éœ€è½¯ä»¶æ¨¡æ‹Ÿï¼Œé€Ÿåº¦é™ 40%</td></tr><tr><td><strong>RTX 4070</strong></td><td>âš ï¸ éœ€è½¬ FP16ï¼ŒæŸå¤± 5%ç²¾åº¦</td><td>âœ… Tensor Core åŸç”Ÿæ”¯æŒ</td></tr><tr><td><strong>å…¸å‹åœºæ™¯</strong></td><td><strong>Mac ç”¨æˆ·å”¯ä¸€æ¨è 16-bit æ–¹æ¡ˆ</strong></td><td>NVIDIA æ˜¾å¡é»„é‡‘æ ‡å‡†</td></tr></tbody></table><blockquote><p><strong>è¡€æ³ªæ¡ˆä¾‹</strong>ï¼šåœ¨ M3 Pro ä¸Šè¿è¡Œ Llama-3-8B æ—¶ï¼ŒFP16 å› æ¢¯åº¦æº¢å‡ºå¯¼è‡´ç”Ÿæˆæ–‡æœ¬ä¹±ç ï¼ŒBF16 å®Œç¾ä¿æŒé€»è¾‘è¿è´¯æ€§ã€‚</p></blockquote><h4 id="3-FP8ï¼šä¸‹ä¸€ä»£ç‹è€…ï¼Ÿ"><a href="#3-FP8ï¼šä¸‹ä¸€ä»£ç‹è€…ï¼Ÿ" class="headerlink" title="(3) FP8ï¼šä¸‹ä¸€ä»£ç‹è€…ï¼Ÿ"></a><strong>(3) FP8ï¼šä¸‹ä¸€ä»£ç‹è€…ï¼Ÿ</strong></h4><ul><li><strong>ç°çŠ¶</strong>ï¼šä»… NVIDIA H100&#x2F;A100 æ”¯æŒï¼Œè‹¹æœç”Ÿæ€ç¼ºå¸­  </li><li><strong>é©å‘½æ€§</strong>ï¼š8 ä½ä¸­åŠ¨æ€åˆ†é…ï¼ˆå¦‚ E4M3 æ ¼å¼ï¼‰ï¼Œå…¼é¡¾èŒƒå›´ä¸ç²¾åº¦  </li><li><strong>æ•°æ®</strong>ï¼šLlama-2-70B åœ¨ H100 ä¸Š FP8 æ¨ç†é€Ÿåº¦è¾¾ BF16 çš„<strong>2.3 å€</strong>ï¼Œç²¾åº¦æŸå¤±&lt;2%  </li><li><strong>è‹¹æœç”¨æˆ·</strong>ï¼šè€å¿ƒç­‰å¾… M4 èŠ¯ç‰‡ï¼ˆ2024 ä¸‹åŠå¹´ï¼‰</li></ul><h4 id="4-INT8-x2F-INT4ï¼šè¾¹ç¼˜è®¡ç®—çš„æ ¸å¼¹"><a href="#4-INT8-x2F-INT4ï¼šè¾¹ç¼˜è®¡ç®—çš„æ ¸å¼¹" class="headerlink" title="(4) INT8&#x2F;INT4ï¼šè¾¹ç¼˜è®¡ç®—çš„æ ¸å¼¹"></a><strong>(4) INT8&#x2F;INT4ï¼šè¾¹ç¼˜è®¡ç®—çš„æ ¸å¼¹</strong></h4><table><thead><tr><th><strong>æŒ‡æ ‡</strong></th><th><strong>INT8</strong></th><th><strong>INT4</strong></th></tr></thead><tbody><tr><td><strong>å‹ç¼©æ¯”</strong></td><td>1&#x2F;4 (vs FP32)</td><td>1&#x2F;8 (vs FP32)</td></tr><tr><td><strong>ç²¾åº¦æŸå¤±</strong></td><td>3-8% (æ ¡å‡†å)</td><td>10-20% (ä¾èµ–ç®—æ³•)</td></tr><tr><td><strong>M3 Pro åŠ é€Ÿ</strong></td><td>1.5x (Neural Engine æœ‰é™æ”¯æŒ)</td><td>1.8x (éœ€ GGUF æ ¼å¼)</td></tr><tr><td><strong>è‡´å‘½ç¼ºé™·</strong></td><td>æ ¡å‡†å¤±è´¥å¯¼è‡´æ¨¡å‹å´©æºƒ</td><td>4bit æ— æ³•è¡¨ç¤ºå¤æ‚è¯­ä¹‰å…³ç³»</td></tr><tr><td><strong>æ•‘å‘½æ–¹æ¡ˆ</strong></td><td>GPTQ&#x2F;AWQ é‡åŒ–ï¼ˆä¿ç•™å…³é”®æƒé‡ï¼‰</td><td><strong>ä»…æ¨è 70B+æ¨¡å‹åœ¨ 36GB å†…å­˜ M3 Pro ä¸Šä½¿ç”¨</strong></td></tr></tbody></table><blockquote><p>ğŸ“Œ <strong>INT4 ç”Ÿå­˜æŒ‡å—</strong>ï¼š  </p><ol><li>ç”¨<code>llama.cpp</code>åŠ è½½ GGUF æ ¼å¼æ¨¡å‹ï¼ˆ<a href="https://github.com/ggerganov/llama.cpp">æ•™ç¨‹</a>ï¼‰  </li><li>å¿…é¡»å¯ç”¨<code>--tensor-split</code>åˆ†ç‰‡è®¡ç®—  </li><li>ç”Ÿæˆæ¸©åº¦(temperature)è®¾ä¸º 0.3-0.5 æŠ‘åˆ¶å¹»è§‰</li></ol></blockquote><hr><h3 id="ä¸‰ã€é‡åŒ–å°ºå¯¸ä¸æ€§èƒ½ï¼šæ®‹é…·çš„æ•°å­¦çœŸç›¸"><a href="#ä¸‰ã€é‡åŒ–å°ºå¯¸ä¸æ€§èƒ½ï¼šæ®‹é…·çš„æ•°å­¦çœŸç›¸" class="headerlink" title="ä¸‰ã€é‡åŒ–å°ºå¯¸ä¸æ€§èƒ½ï¼šæ®‹é…·çš„æ•°å­¦çœŸç›¸"></a>ä¸‰ã€é‡åŒ–å°ºå¯¸ä¸æ€§èƒ½ï¼šæ®‹é…·çš„æ•°å­¦çœŸç›¸</h3><p>æ¨¡å‹ä½“ç§¯ä¸æ˜¾å­˜å ç”¨ç”±<strong>åŸºç¡€å…¬å¼</strong>å†³å®šï¼š  </p><pre><code>æ˜¾å­˜å ç”¨(GB) = å‚æ•°é‡ Ã— ä½å®½(bit) / 8 / 1024Â³</code></pre><p><strong>å®æˆ˜é€ŸæŸ¥è¡¨</strong>ï¼š  </p><table><thead><tr><th>æ¨¡å‹è§„æ¨¡</th><th>FP32</th><th>BF16</th><th>INT8</th><th>INT4</th></tr></thead><tbody><tr><td>7B</td><td>28GB</td><td>14GB</td><td>7GB</td><td><strong>3.5GB</strong></td></tr><tr><td>13B</td><td>52GB</td><td>26GB</td><td>13GB</td><td><strong>6.5GB</strong></td></tr><tr><td>70B</td><td>280GB</td><td>140GB</td><td>70GB</td><td><strong>35GB</strong></td></tr></tbody></table><blockquote><p><strong>M3 Pro 18GB å†…å­˜æé™</strong>ï¼š  </p><ul><li>BF16ï¼šæœ€å¤§è¿è¡Œ<strong>13B æ¨¡å‹</strong>ï¼ˆå¦‚ Mistral-7Bï¼‰  </li><li>INT4ï¼šå¯å¡å…¥<strong>70B æ¨¡å‹</strong>ï¼ˆLlama-3-70Bï¼‰ï¼Œä½† batch size&#x3D;1 ä¸”éœ€ 36GB å†…å­˜ç‰ˆæœ¬</li></ul></blockquote><p><strong>é€Ÿåº¦-ç²¾åº¦æƒè¡¡å®æµ‹</strong>ï¼ˆM3 Pro 18 æ ¸ GPU, Llama-3-8Bï¼‰ï¼š  </p><table><thead><tr><th>é‡åŒ–æ ¼å¼</th><th>ç”Ÿæˆé€Ÿåº¦(tokens&#x2F;s)</th><th>ç²¾åº¦(MMLU å¾—åˆ†)</th><th>å†…å­˜å ç”¨</th></tr></thead><tbody><tr><td>BF16</td><td>42.1</td><td>68.3</td><td>15.2GB</td></tr><tr><td>INT8</td><td>58.7 (+39%)</td><td>65.1 (-4.7%)</td><td>8.1GB</td></tr><tr><td>INT4</td><td>75.3 (+79%)</td><td>57.9 (-15.2%)</td><td><strong>4.3GB</strong></td></tr></tbody></table><blockquote><p>ğŸ’¡ <strong>å…³é”®æ´å¯Ÿ</strong>ï¼šINT4 åœ¨é€Ÿåº¦ä¸Šç¢¾å‹ BF16ï¼Œä½† MMLU å¾—åˆ†æš´è·Œ 15%â€”â€”<strong>ä»£ç ç”Ÿæˆã€é€»è¾‘æ¨ç†ä»»åŠ¡æ…ç”¨ï¼</strong></p></blockquote><hr><h3 id="å››ã€ç¡¬ä»¶é€‚é…æŒ‡å—ï¼šæ²¡æœ‰ä¸‡èƒ½é’¥åŒ™ï¼Œåªæœ‰ç²¾å‡†åŒ¹é…"><a href="#å››ã€ç¡¬ä»¶é€‚é…æŒ‡å—ï¼šæ²¡æœ‰ä¸‡èƒ½é’¥åŒ™ï¼Œåªæœ‰ç²¾å‡†åŒ¹é…" class="headerlink" title="å››ã€ç¡¬ä»¶é€‚é…æŒ‡å—ï¼šæ²¡æœ‰ä¸‡èƒ½é’¥åŒ™ï¼Œåªæœ‰ç²¾å‡†åŒ¹é…"></a>å››ã€ç¡¬ä»¶é€‚é…æŒ‡å—ï¼šæ²¡æœ‰ä¸‡èƒ½é’¥åŒ™ï¼Œåªæœ‰ç²¾å‡†åŒ¹é…</h3><h4 id="Apple-Silicon-M1-x2F-M2-x2F-M3-ç”¨æˆ·"><a href="#Apple-Silicon-M1-x2F-M2-x2F-M3-ç”¨æˆ·" class="headerlink" title="Apple Silicon (M1&#x2F;M2&#x2F;M3) ç”¨æˆ·"></a><strong>Apple Silicon (M1&#x2F;M2&#x2F;M3) ç”¨æˆ·</strong></h4><ul><li><strong>é»„é‡‘ç»„åˆ</strong>ï¼š<strong>BF16 + Unified Memory</strong>  <ul><li>M3 Pro çš„ 128-bit å†…å­˜æ€»çº¿ä¸“ä¸º BF16 ä¼˜åŒ–ï¼Œå¸¦å®½è¾¾ 120GB&#x2F;s  </li><li>é¿å¼€ FP16 é™·é˜±ï¼šè‹¹æœ GPU æ¶æ„å¯¹ FP16 æ”¯æŒå¼±äº BF16 40%</li></ul></li><li><strong>è¶…å¤§æ¨¡å‹æ–¹æ¡ˆ</strong>ï¼š</li></ul><pre><code class="bash">  # M3 Max 36GBå†…å­˜è¿è¡Œ70Bæ¨¡å‹ç¤ºä¾‹  ./main -m llama-3-70b-Q4_K_M.gguf -n 512 --gpu-layers 99</code></pre><blockquote><p>âœ… å¯ç”¨<code>--gpu-layers 99</code>å°†è®¡ç®—å¸è½½è‡³ GPUï¼Œé¿å… CPU ç“¶é¢ˆ  </p></blockquote><h4 id="NVIDIA-GPU-ç”¨æˆ·-RTX-30-x2F-40-ç³»åˆ—"><a href="#NVIDIA-GPU-ç”¨æˆ·-RTX-30-x2F-40-ç³»åˆ—" class="headerlink" title="NVIDIA GPU ç”¨æˆ· (RTX 30&#x2F;40 ç³»åˆ—)"></a><strong>NVIDIA GPU ç”¨æˆ· (RTX 30&#x2F;40 ç³»åˆ—)</strong></h4><ul><li><strong>æ—¥å¸¸æ¨ç†</strong>ï¼šFP16ï¼ˆTensor Core åŸç”ŸåŠ é€Ÿï¼‰  </li><li><strong>æé™å‹ç¼©</strong>ï¼šAWQ é‡åŒ– INT4ï¼ˆæ¯” GGUF ç²¾åº¦é«˜ 5-8%ï¼‰  </li><li><strong>é¿å‘</strong>ï¼šç¦ç”¨ PyTorch çš„<code>torch.float16</code>è‡ªåŠ¨è½¬æ¢ï¼Œæ”¹ç”¨<code>tensorrt-llm</code></li></ul><h4 id="æ‰‹æœº-x2F-è¾¹ç¼˜è®¾å¤‡"><a href="#æ‰‹æœº-x2F-è¾¹ç¼˜è®¾å¤‡" class="headerlink" title="æ‰‹æœº&#x2F;è¾¹ç¼˜è®¾å¤‡"></a><strong>æ‰‹æœº&#x2F;è¾¹ç¼˜è®¾å¤‡</strong></h4><ul><li>ä¼˜å…ˆé€‰<strong>INT8+çŸ¥è¯†è’¸é¦</strong>å°æ¨¡å‹ï¼ˆå¦‚ Phi-3-miniï¼‰  </li><li>é«˜é€šèŠ¯ç‰‡ç”¨<strong>QNN SDK</strong>éƒ¨ç½²ï¼Œé¿å… TensorFlow Lite ç²¾åº¦å´©å</li></ul><hr><h3 id="äº”ã€å®æˆ˜ï¼šä¸‰æ­¥é€‰å‡ºä½ çš„é‡åŒ–æ–¹æ¡ˆ"><a href="#äº”ã€å®æˆ˜ï¼šä¸‰æ­¥é€‰å‡ºä½ çš„é‡åŒ–æ–¹æ¡ˆ" class="headerlink" title="äº”ã€å®æˆ˜ï¼šä¸‰æ­¥é€‰å‡ºä½ çš„é‡åŒ–æ–¹æ¡ˆ"></a>äº”ã€å®æˆ˜ï¼šä¸‰æ­¥é€‰å‡ºä½ çš„é‡åŒ–æ–¹æ¡ˆ</h3><ol><li><strong>è¯Šæ–­ç¡¬ä»¶</strong>ï¼š  <ul><li>M3 Pro 18GB â†’ BF16 è·‘ 13B ä»¥ä¸‹æ¨¡å‹ï¼ŒINT4 ä»…ä½œ 70B æ¨¡å‹å¤‡é€‰  </li><li>RTX 4080 16GB â†’ FP16 è·‘ 30Bï¼ŒINT4 è·‘ 70B</li></ul></li><li><strong>è¯„ä¼°ä»»åŠ¡</strong>ï¼š  <table><thead><tr><th>ä»»åŠ¡ç±»å‹</th><th>å®‰å…¨é‡åŒ–</th><th>é«˜å±é‡åŒ–</th></tr></thead><tbody><tr><td>èŠå¤©&#x2F;åˆ›ä½œ</td><td>INT8</td><td>INT4</td></tr><tr><td>ä»£ç ç”Ÿæˆ</td><td>BF16&#x2F;FP16</td><td>âŒ é¿å… INT4</td></tr><tr><td>é€»è¾‘æ¨ç†</td><td>BF16</td><td>âŒ é¿å…&lt;8bit</td></tr></tbody></table></li><li><strong>éªŒè¯ç²¾åº¦</strong>ï¼š  <ul><li>ç”¨<a href="https://huggingface.co/datasets/cais/mmlu">MMLU</a>æˆ–<a href="https://huggingface.co/datasets/truthfulqa/truthful_qa">TruthfulQA</a>æµ‹è¯•  </li><li><strong>çº¢çº¿</strong>ï¼šç²¾åº¦æŸå¤±&gt;5%å¿…é¡»å›é€€ï¼</li></ul></li></ol><hr><h3 id="å…­ã€æœªæ¥å·²æ¥ï¼šé‡åŒ–æŠ€æœ¯çš„ä¸‹ä¸€ç«™"><a href="#å…­ã€æœªæ¥å·²æ¥ï¼šé‡åŒ–æŠ€æœ¯çš„ä¸‹ä¸€ç«™" class="headerlink" title="å…­ã€æœªæ¥å·²æ¥ï¼šé‡åŒ–æŠ€æœ¯çš„ä¸‹ä¸€ç«™"></a>å…­ã€æœªæ¥å·²æ¥ï¼šé‡åŒ–æŠ€æœ¯çš„ä¸‹ä¸€ç«™</h3><ul><li><strong>åŠ¨æ€é‡åŒ–</strong>ï¼šMeta çš„<strong>BitNet</strong>å®ç° b-bit åŠ¨æ€è°ƒæ•´ï¼Œæ¨ç†æ—¶è‡ªåŠ¨åˆ‡æ¢ç²¾åº¦  </li><li><strong>è‹¹æœç ´å±€</strong>ï¼šM4 èŠ¯ç‰‡æˆ–é›†æˆ<strong>INT4 åŠ é€Ÿå™¨</strong>ï¼ˆä¸“åˆ© US20230385530A1 å·²æ›å…‰ï¼‰  </li><li><strong>ç»Ÿä¸€æ ‡å‡†</strong>ï¼šMLX æ¡†æ¶å°†ç»ˆç»“æ ¼å¼å‰²è£‚ï¼ŒM3 Pro æ˜å¹´æ”¯æŒ<strong>åŸç”Ÿ INT4</strong></li></ul><blockquote><p><strong>ç»ˆæå»ºè®®</strong>ï¼š  </p><ul><li><strong>Mac ç”¨æˆ·</strong>ï¼šåšæŒ BF16ï¼Œ36GB å†…å­˜ç‰ˆ M3 Max æ˜¯ 70B æ¨¡å‹çš„æœ€ä¼˜è§£  </li><li><strong>NVIDIA ç”¨æˆ·</strong>ï¼šFP16+AWQ INT4 åŒé…ç½®ï¼Œç”¨<code>vLLM</code>è‡ªåŠ¨åˆ‡æ¢  </li><li><strong>æ‰€æœ‰äºº</strong>ï¼šINT4 ä»…ä½œâ€œæœ€åæ‰‹æ®µâ€ï¼ŒBF16&#x2F;FP16 æ‰æ˜¯ç”Ÿäº§åŠ›ä¸»åŠ›</li></ul></blockquote><p><strong>é‡åŒ–ä¸æ˜¯å¦¥åï¼Œè€Œæ˜¯æ™ºæ…§çš„å‹ç¼©ã€‚</strong><br>å½“ä½ åœ¨ M3 Pro ä¸Šæµç•…è¿è¡Œ 30B æ¨¡å‹æ—¶ï¼Œä¼šæ˜ç™½ï¼šçœŸæ­£çš„ AI æ°‘ä¸»åŒ–ï¼Œå§‹äºæ¯ä¸€æ¬¡ç²¾å‡†çš„ä½å®½é€‰æ‹©ã€‚  </p><blockquote><p><strong>é™„ï¼šå·¥å…·é“¾æ¨è</strong>  </p><ul><li>è‹¹æœç”Ÿæ€ï¼š<a href="https://github.com/ml-explore/mlx">MLX</a> + <a href="https://github.com/ggerganov/llama.cpp">llama.cpp</a>  </li><li>NVIDIA ç”Ÿæ€ï¼š<a href="https://github.com/NVIDIA/TensorRT-LLM">TensorRT-LLM</a> + <a href="https://github.com/PanQiWei/AutoGPTQ">AutoGPTQ</a>  </li><li>é€šç”¨è½¬æ¢ï¼š<a href="https://huggingface.co/docs/optimum/index">HuggingFace Optimum</a></li></ul></blockquote><p><em>æœ¬æ–‡å®æµ‹æ•°æ®åŸºäº M3 Pro 18 æ ¸ GPU (åˆ†é… 18GB) + macOS Tahoe 26.1ï¼Œæ¨¡å‹ Llama-3-8B-Instructã€‚ç¡¬ä»¶è¿­ä»£è¿…é€Ÿï¼Œå»ºè®®ä»¥æœ€æ–°åŸºå‡†ä¸ºå‡†ã€‚</em>  </p><p><strong>#AI å·¥ç¨‹åŒ– #æ¨¡å‹éƒ¨ç½² #AppleSilicon #å¤§æ¨¡å‹ä¼˜åŒ–</strong></p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;p&gt;&lt;strong&gt;â€”â€”æ·±åº¦è§£æé‡åŒ–æ ¼å¼ã€å°ºå¯¸å·®å¼‚ä¸ç¡¬ä»¶é€‚é…ç­–ç•¥ï¼ˆé™„ M3 Pro å®æˆ˜æŒ‡å—ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ä¸ªäººå¸¸ç”¨åŠå…¬ç»ˆç«¯è®¾å¤‡å‹å·ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Macbook Pro M3 ï¼ˆ36G å†…å­˜å®šåˆ¶æ¬¾)&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;å°ç»“&lt;/strong&gt;ï¼š  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ğŸ’¡ &lt;strong&gt;Apple ç”¨æˆ·é—­çœ¼é€‰ BF16&lt;/strong&gt;ï¼šM3 Pro èŠ¯ç‰‡çš„ BF16 æ€§èƒ½ç¢¾å‹ FP16ï¼Œ18GB å†…å­˜å¯æµç•…è¿è¡Œ 30B çº§æ¨¡å‹  &lt;/li&gt;
&lt;li&gt;âš ï¸ &lt;strong&gt;INT4 æ˜¯åŒåˆƒå‰‘&lt;/strong&gt;ï¼š70B æ¨¡å‹å¡è¿› 36GB å†…å­˜çš„å”¯ä¸€æ–¹æ¡ˆï¼Œä½†ç²¾åº¦æŸå¤±é«˜è¾¾ 15%+  &lt;/li&gt;
&lt;li&gt;ğŸ”® &lt;strong&gt;æœªæ¥å±äº FP8&lt;/strong&gt;ï¼šNVIDIA H100 å·²æ”¯æŒï¼Œè‹¹æœ M4 æˆ–æˆè½¬æŠ˜ç‚¹&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/categories/AI/Agent/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Agent" scheme="https://www.wdft.com/tags/Agent/"/>
    
    <category term="GGUF" scheme="https://www.wdft.com/tags/GGUF/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäº Golang æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç®€åŒ–çš„ DeepSeek AI æ¨¡å‹ GRPO ç®—æ³•æ¨ç†</title>
    <link href="https://www.wdft.com/edd96fdf.html"/>
    <id>https://www.wdft.com/edd96fdf.html</id>
    <published>2025-12-01T14:12:43.000Z</published>
    <updated>2026-01-26T09:20:10.544Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h3 id="æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç®€åŒ–çš„-GRPO-Group-Relative-Policy-Optimization-æ¨ç†æ¨¡å‹ã€‚GRPO-æ˜¯ç”±-DeepSeek-æå‡ºçš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œç”¨äºè®­ç»ƒå¤§å‹è¯­è¨€æ¨¡å‹"><a href="#æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç®€åŒ–çš„-GRPO-Group-Relative-Policy-Optimization-æ¨ç†æ¨¡å‹ã€‚GRPO-æ˜¯ç”±-DeepSeek-æå‡ºçš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œç”¨äºè®­ç»ƒå¤§å‹è¯­è¨€æ¨¡å‹" class="headerlink" title="æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç®€åŒ–çš„ GRPO (Group Relative Policy Optimization) æ¨ç†æ¨¡å‹ã€‚GRPO æ˜¯ç”± DeepSeek æå‡ºçš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œç”¨äºè®­ç»ƒå¤§å‹è¯­è¨€æ¨¡å‹"></a>æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç®€åŒ–çš„ GRPO (Group Relative Policy Optimization) æ¨ç†æ¨¡å‹ã€‚GRPO æ˜¯ç”± DeepSeek æå‡ºçš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œç”¨äºè®­ç»ƒå¤§å‹è¯­è¨€æ¨¡å‹</h3><p>å®ƒçš„æ ¸å¿ƒç‰¹ç‚¹æ˜¯ä¸éœ€è¦è®­ç»ƒä»·å€¼å‡½æ•°ï¼Œè€Œæ˜¯é€šè¿‡ä»åŒä¸€é—®é¢˜çš„å¤šä¸ªè¾“å‡ºä¸­è®¡ç®—å¹³å‡å¥–åŠ±æ¥æ›¿ä»£è¿™ä¸€è¿‡ç¨‹ï¼Œæ˜¾è‘—å‡å°‘äº†å†…å­˜å’Œè®¡ç®—èµ„æºçš„æ¶ˆè€— ã€‚ </p><h6 id="ç®€åŒ–ç‰ˆ-GRPO-æ¨ç†æ¨¡å‹ï¼š"><a href="#ç®€åŒ–ç‰ˆ-GRPO-æ¨ç†æ¨¡å‹ï¼š" class="headerlink" title="ç®€åŒ–ç‰ˆ GRPO æ¨ç†æ¨¡å‹ï¼š"></a>ç®€åŒ–ç‰ˆ GRPO æ¨ç†æ¨¡å‹ï¼š</h6><span id="more"></span><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;math&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;sort&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–‡æ¡£ç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> Document <span class="keyword">struct</span> &#123;</span><br><span class="line">Content <span class="type">string</span> <span class="string">`json:&quot;content&quot;`</span></span><br><span class="line">Metadata <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;metadata&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GRPOæ¨¡å‹æ ¸å¿ƒç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> GRPOModel <span class="keyword">struct</span> &#123;</span><br><span class="line">documents      []*Document       <span class="comment">// å­˜å‚¨å­¦ä¹ çš„æ–‡æ¡£</span></span><br><span class="line">policyWeights  <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span> <span class="comment">// ç­–ç•¥æƒé‡</span></span><br><span class="line">groupSize      <span class="type">int</span>               <span class="comment">// åˆ†ç»„å¤§å°</span></span><br><span class="line">temperature    <span class="type">float64</span>           <span class="comment">// é‡‡æ ·æ¸©åº¦</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°å»ºGRPOæ¨¡å‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGRPOModel</span><span class="params">(groupSize <span class="type">int</span>, temperature <span class="type">float64</span>)</span></span> *GRPOModel &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;GRPOModel&#123;</span><br><span class="line">documents:     <span class="built_in">make</span>([]*Document, <span class="number">0</span>),</span><br><span class="line">policyWeights: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>),</span><br><span class="line">groupSize:     groupSize,</span><br><span class="line">temperature:   temperature,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»æ–‡ä»¶åŠ è½½æ–‡æ¡£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *GRPOModel)</span></span> LoadDocument(filePath <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">data, err := ioutil.ReadFile(filePath)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> doc Document</span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal(data, &amp;doc); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œå°è¯•ä½œä¸ºçº¯æ–‡æœ¬</span></span><br><span class="line">doc = Document&#123;</span><br><span class="line">Content: <span class="type">string</span>(data),</span><br><span class="line">Metadata: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line"><span class="string">&quot;source&quot;</span>: filePath,</span><br><span class="line"><span class="string">&quot;type&quot;</span>:   <span class="string">&quot;text&quot;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">m.documents = <span class="built_in">append</span>(m.documents, &amp;doc)</span><br><span class="line">fmt.Printf(<span class="string">&quot;æˆåŠŸåŠ è½½æ–‡æ¡£: %s\n&quot;</span>, filePath)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¢„å¤„ç†æ–‡æ¡£å†…å®¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *GRPOModel)</span></span> preprocessContent(content <span class="type">string</span>) []<span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">// ç®€å•çš„æ–‡æœ¬åˆ†è¯</span></span><br><span class="line">content = strings.ToLower(content)</span><br><span class="line">content = strings.ReplaceAll(content, <span class="string">&quot;\n&quot;</span>, <span class="string">&quot; &quot;</span>)</span><br><span class="line">content = strings.ReplaceAll(content, <span class="string">&quot;\r&quot;</span>, <span class="string">&quot; &quot;</span>)</span><br><span class="line">content = strings.ReplaceAll(content, <span class="string">&quot;\t&quot;</span>, <span class="string">&quot; &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»é™¤æ ‡ç‚¹ç¬¦å·</span></span><br><span class="line">replacer := strings.NewReplacer(</span><br><span class="line"><span class="string">&quot;.&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;!&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;?&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;:&quot;</span>, <span class="string">&quot; &quot;</span>,</span><br><span class="line"><span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;[&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;]&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;&#123;&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;&#125;&quot;</span>, <span class="string">&quot; &quot;</span>,</span><br><span class="line">)</span><br><span class="line">content = replacer.Replace(content)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†è¯</span></span><br><span class="line">words := strings.Fields(content)</span><br><span class="line"><span class="keyword">return</span> words</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­¦ä¹ æ–‡æ¡£ - æ ¸å¿ƒGRPOå­¦ä¹ è¿‡ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *GRPOModel)</span></span> Learn() &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;å¼€å§‹GRPOå­¦ä¹ è¿‡ç¨‹...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. æ„å»ºè¯æ±‡è¡¨å’Œåˆå§‹æƒé‡</span></span><br><span class="line">vocabulary := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, doc := <span class="keyword">range</span> m.documents &#123;</span><br><span class="line">words := m.preprocessContent(doc.Content)</span><br><span class="line"><span class="keyword">for</span> _, word := <span class="keyword">range</span> words &#123;</span><br><span class="line"><span class="keyword">if</span> _, exists := vocabulary[word]; !exists &#123;</span><br><span class="line">vocabulary[word] = <span class="number">0.0</span></span><br><span class="line">&#125;</span><br><span class="line">vocabulary[word] += <span class="number">1.0</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. GRPOæ ¸å¿ƒï¼šåˆ†ç»„ç›¸å¯¹ç­–ç•¥ä¼˜åŒ–</span></span><br><span class="line"><span class="comment">// å°†è¯æ±‡åˆ†ç»„ï¼Œè®¡ç®—ç»„å†…ç›¸å¯¹æƒé‡</span></span><br><span class="line">wordGroups := m.groupWords(vocabulary)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> groupID, words := <span class="keyword">range</span> wordGroups &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;å¤„ç†åˆ†ç»„ %dï¼ŒåŒ…å« %d ä¸ªè¯æ±‡\n&quot;</span>, groupID, <span class="built_in">len</span>(words))</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—ç»„å†…å¹³å‡å¥–åŠ±ï¼ˆé¢‘ç‡ä½œä¸ºå¥–åŠ±çš„ä»£ç†ï¼‰</span></span><br><span class="line">totalReward := <span class="number">0.0</span></span><br><span class="line"><span class="keyword">for</span> _, word := <span class="keyword">range</span> words &#123;</span><br><span class="line">totalReward += vocabulary[word]</span><br><span class="line">&#125;</span><br><span class="line">avgReward := totalReward / <span class="type">float64</span>(<span class="built_in">len</span>(words))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è®¡ç®—ç›¸å¯¹ä¼˜åŠ¿ï¼ˆGRPOæ ¸å¿ƒæ€æƒ³ï¼‰</span></span><br><span class="line"><span class="keyword">for</span> _, word := <span class="keyword">range</span> words &#123;</span><br><span class="line">reward := vocabulary[word]</span><br><span class="line"><span class="comment">// ç›¸å¯¹ä¼˜åŠ¿ = å®é™…å¥–åŠ± - ç»„å†…å¹³å‡å¥–åŠ±</span></span><br><span class="line">relativeAdvantage := reward - avgReward</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. ç­–ç•¥æ›´æ–°ï¼ˆç®€åŒ–ç‰ˆPPOï¼‰</span></span><br><span class="line">currentWeight := m.policyWeights[word]</span><br><span class="line"><span class="comment">// ä½¿ç”¨ç›¸å¯¹ä¼˜åŠ¿è°ƒæ•´æƒé‡</span></span><br><span class="line">newWeight := currentWeight + <span class="number">0.1</span>*relativeAdvantage <span class="comment">// å­¦ä¹ ç‡=0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åº”ç”¨æ¸©åº¦å‚æ•°è¿›è¡Œå¹³æ»‘</span></span><br><span class="line"><span class="keyword">if</span> m.temperature &gt; <span class="number">0</span> &#123;</span><br><span class="line">newWeight = newWeight / m.temperature</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">m.policyWeights[word] = newWeight</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;GRPOå­¦ä¹ å®Œæˆï¼Œå…±å­¦ä¹  %d ä¸ªè¯æ±‡\n&quot;</span>, <span class="built_in">len</span>(m.policyWeights))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†è¯æ±‡åˆ†ç»„ï¼ˆGRPOçš„æ ¸å¿ƒï¼šåˆ†ç»„ç›¸å¯¹æ¯”è¾ƒï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *GRPOModel)</span></span> groupWords(vocabulary <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>) <span class="keyword">map</span>[<span class="type">int</span>][]<span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">// æŒ‰é¢‘ç‡æ’åº</span></span><br><span class="line"><span class="keyword">type</span> wordFreq <span class="keyword">struct</span> &#123;</span><br><span class="line">word <span class="type">string</span></span><br><span class="line">freq <span class="type">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wordList := <span class="built_in">make</span>([]wordFreq, <span class="number">0</span>, <span class="built_in">len</span>(vocabulary))</span><br><span class="line"><span class="keyword">for</span> word, freq := <span class="keyword">range</span> vocabulary &#123;</span><br><span class="line">wordList = <span class="built_in">append</span>(wordList, wordFreq&#123;word, freq&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sort.Slice(wordList, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> wordList[i].freq &gt; wordList[j].freq</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†ç»„</span></span><br><span class="line">groups := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>][]<span class="type">string</span>)</span><br><span class="line">groupID := <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(wordList); i += m.groupSize &#123;</span><br><span class="line">end := i + m.groupSize</span><br><span class="line"><span class="keyword">if</span> end &gt; <span class="built_in">len</span>(wordList) &#123;</span><br><span class="line">end = <span class="built_in">len</span>(wordList)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">groupWords := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>, m.groupSize)</span><br><span class="line"><span class="keyword">for</span> j := i; j &lt; end; j++ &#123;</span><br><span class="line">groupWords = <span class="built_in">append</span>(groupWords, wordList[j].word)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">groups[groupID] = groupWords</span><br><span class="line">groupID++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> groups</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿è¡Œæ—¶è§£æ - åŸºäºå­¦ä¹ åˆ°çš„ç­–ç•¥ç”Ÿæˆå“åº”</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *GRPOModel)</span></span> Parse(input <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;å¼€å§‹è¿è¡Œæ—¶è§£æ...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. é¢„å¤„ç†è¾“å…¥</span></span><br><span class="line">inputWords := m.preprocessContent(input)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ä»æ–‡æ¡£ä¸­æ£€ç´¢ç›¸å…³ç‰‡æ®µ</span></span><br><span class="line">relevantFragments := m.retrieveRelevantFragments(inputWords)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. GRPOæ¨ç†ï¼šä½¿ç”¨å­¦ä¹ åˆ°çš„ç­–ç•¥ç”Ÿæˆå“åº”</span></span><br><span class="line">response := m.generateResponse(relevantFragments, inputWords)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> response</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€ç´¢ç›¸å…³ç‰‡æ®µ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *GRPOModel)</span></span> retrieveRelevantFragments(inputWords []<span class="type">string</span>) []<span class="type">string</span> &#123;</span><br><span class="line">fragments := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, doc := <span class="keyword">range</span> m.documents &#123;</span><br><span class="line">content := strings.ToLower(doc.Content)</span><br><span class="line">relevanceScore := <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, word := <span class="keyword">range</span> inputWords &#123;</span><br><span class="line"><span class="keyword">if</span> strings.Contains(content, word) &#123;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ç­–ç•¥æƒé‡è®¡ç®—ç›¸å…³æ€§</span></span><br><span class="line">weight := m.policyWeights[word]</span><br><span class="line">relevanceScore += math.Abs(weight) <span class="comment">// ä½¿ç”¨ç»å¯¹å€¼ä½œä¸ºç›¸å…³æ€§å¼ºåº¦</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> relevanceScore &gt; <span class="number">0.5</span> &#123; <span class="comment">// é˜ˆå€¼</span></span><br><span class="line"><span class="comment">// æå–ç›¸å…³ç‰‡æ®µ</span></span><br><span class="line"><span class="keyword">for</span> _, word := <span class="keyword">range</span> inputWords &#123;</span><br><span class="line"><span class="keyword">if</span> idx := strings.Index(content, word); idx != <span class="number">-1</span> &#123;</span><br><span class="line">start := idx - <span class="number">50</span></span><br><span class="line"><span class="keyword">if</span> start &lt; <span class="number">0</span> &#123;</span><br><span class="line">start = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">end := idx + <span class="built_in">len</span>(word) + <span class="number">50</span></span><br><span class="line"><span class="keyword">if</span> end &gt; <span class="built_in">len</span>(content) &#123;</span><br><span class="line">end = <span class="built_in">len</span>(content)</span><br><span class="line">&#125;</span><br><span class="line">fragment := content[start:end]</span><br><span class="line">fragments = <span class="built_in">append</span>(fragments, fragment)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> fragments</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆå“åº”ï¼ˆGRPOæ¨ç†æ ¸å¿ƒï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *GRPOModel)</span></span> generateResponse(fragments []<span class="type">string</span>, inputWords []<span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(fragments) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. åˆ›å»ºå¤šä¸ªå€™é€‰å“åº”ï¼ˆGRPOçš„åˆ†ç»„æ€æƒ³ï¼‰</span></span><br><span class="line">candidates := <span class="built_in">make</span>([]<span class="type">string</span>, m.groupSize)</span><br><span class="line">rand.Seed(time.Now().UnixNano())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; m.groupSize; i++ &#123;</span><br><span class="line"><span class="comment">// éšæœºé€‰æ‹©ç‰‡æ®µ</span></span><br><span class="line">fragmentIdx := rand.Intn(<span class="built_in">len</span>(fragments))</span><br><span class="line">fragment := fragments[fragmentIdx]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. åŸºäºç­–ç•¥æƒé‡é€‰æ‹©å…³é”®è¯</span></span><br><span class="line">keywords := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> _, word := <span class="keyword">range</span> inputWords &#123;</span><br><span class="line"><span class="keyword">if</span> weight, exists := m.policyWeights[word]; exists &amp;&amp; weight &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// æ ¹æ®æƒé‡æ¦‚ç‡é€‰æ‹©</span></span><br><span class="line">probability := <span class="number">1.0</span> / (<span class="number">1.0</span> + math.Exp(-weight)) <span class="comment">// sigmoid</span></span><br><span class="line"><span class="keyword">if</span> rand.Float64() &lt; probability &#123;</span><br><span class="line">keywords = <span class="built_in">append</span>(keywords, word)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ç”Ÿæˆå€™é€‰å“åº”</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(keywords) &gt; <span class="number">0</span> &#123;</span><br><span class="line">template := <span class="string">&quot;æ ¹æ®æ‚¨çš„é—®é¢˜ï¼Œç›¸å…³ä¿¡æ¯æ˜¯ï¼š%sã€‚å…³é”®è¯ï¼š%s&quot;</span></span><br><span class="line">candidate := fmt.Sprintf(template, fragment, strings.Join(keywords, <span class="string">&quot;, &quot;</span>))</span><br><span class="line">candidates[i] = candidate</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">candidates[i] = fmt.Sprintf(<span class="string">&quot;æ‰¾åˆ°ç›¸å…³å†…å®¹ï¼š%s&quot;</span>, fragment)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. GRPOæ ¸å¿ƒï¼šç»„å†…ç›¸å¯¹è¯„ä¼°</span></span><br><span class="line"><span class="comment">// ä¸ºæ¯ä¸ªå€™é€‰è®¡ç®—ç›¸å¯¹åˆ†æ•°</span></span><br><span class="line">candidateScores := <span class="built_in">make</span>([]<span class="type">float64</span>, m.groupSize)</span><br><span class="line"><span class="keyword">for</span> i, candidate := <span class="keyword">range</span> candidates &#123;</span><br><span class="line">score := <span class="number">0.0</span></span><br><span class="line"><span class="keyword">for</span> _, word := <span class="keyword">range</span> inputWords &#123;</span><br><span class="line"><span class="keyword">if</span> strings.Contains(candidate, word) &#123;</span><br><span class="line">score += m.policyWeights[word]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">candidateScores[i] = score</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. è®¡ç®—å¹³å‡åˆ†æ•°</span></span><br><span class="line">avgScore := <span class="number">0.0</span></span><br><span class="line"><span class="keyword">for</span> _, score := <span class="keyword">range</span> candidateScores &#123;</span><br><span class="line">avgScore += score</span><br><span class="line">&#125;</span><br><span class="line">avgScore = avgScore / <span class="type">float64</span>(m.groupSize)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. é€‰æ‹©ç›¸å¯¹ä¼˜åŠ¿æœ€å¤§çš„å€™é€‰</span></span><br><span class="line">bestIdx := <span class="number">0</span></span><br><span class="line">bestAdvantage := <span class="number">-1e9</span></span><br><span class="line"><span class="keyword">for</span> i, score := <span class="keyword">range</span> candidateScores &#123;</span><br><span class="line">advantage := score - avgScore <span class="comment">// ç›¸å¯¹ä¼˜åŠ¿</span></span><br><span class="line"><span class="keyword">if</span> advantage &gt; bestAdvantage &#123;</span><br><span class="line">bestAdvantage = advantage</span><br><span class="line">bestIdx = i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> candidates[bestIdx]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿å­˜æ¨¡å‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *GRPOModel)</span></span> SaveModel(filePath <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">data := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;policy_weights&quot;</span>: m.policyWeights,</span><br><span class="line"><span class="string">&quot;group_size&quot;</span>:     m.groupSize,</span><br><span class="line"><span class="string">&quot;temperature&quot;</span>:    m.temperature,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jsonData, err := json.MarshalIndent(data, <span class="string">&quot;&quot;</span>, <span class="string">&quot;  &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ioutil.WriteFile(filePath, jsonData, <span class="number">0644</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½æ¨¡å‹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *GRPOModel)</span></span> LoadModel(filePath <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">data, err := ioutil.ReadFile(filePath)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> modelData <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal(data, &amp;modelData); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬æ¢æƒé‡</span></span><br><span class="line">weights := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">float64</span>)</span><br><span class="line"><span class="keyword">if</span> weightsData, ok := modelData[<span class="string">&quot;policy_weights&quot;</span>].(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;); ok &#123;</span><br><span class="line"><span class="keyword">for</span> word, value := <span class="keyword">range</span> weightsData &#123;</span><br><span class="line"><span class="keyword">if</span> floatValue, ok := value.(<span class="type">float64</span>); ok &#123;</span><br><span class="line">weights[word] = floatValue</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">m.policyWeights = weights</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> groupSize, ok := modelData[<span class="string">&quot;group_size&quot;</span>].(<span class="type">float64</span>); ok &#123;</span><br><span class="line">m.groupSize = <span class="type">int</span>(groupSize)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> temp, ok := modelData[<span class="string">&quot;temperature&quot;</span>].(<span class="type">float64</span>); ok &#123;</span><br><span class="line">m.temperature = temp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºGRPOæ¨¡å‹</span></span><br><span class="line">model := NewGRPOModel(<span class="number">3</span>, <span class="number">0.7</span>) <span class="comment">// åˆ†ç»„å¤§å°3ï¼Œæ¸©åº¦0.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¤ºä¾‹1ï¼šåŠ è½½æ–‡æ¡£</span></span><br><span class="line">fmt.Println(<span class="string">&quot;=== æ–‡æ¡£å­¦ä¹ é˜¶æ®µ ===&quot;</span>)</span><br><span class="line">docFiles := []<span class="type">string</span>&#123;<span class="string">&quot;doc1.json&quot;</span>, <span class="string">&quot;doc2.json&quot;</span>, <span class="string">&quot;doc3.json&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç¤ºä¾‹æ–‡æ¡£æ–‡ä»¶</span></span><br><span class="line">createExampleDocuments(docFiles)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> docFiles &#123;</span><br><span class="line"><span class="keyword">if</span> err := model.LoadDocument(file); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;åŠ è½½æ–‡æ¡£ %s å¤±è´¥: %v\n&quot;</span>, file, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­¦ä¹ è¿‡ç¨‹</span></span><br><span class="line">model.Learn()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿å­˜æ¨¡å‹</span></span><br><span class="line"><span class="keyword">if</span> err := model.SaveModel(<span class="string">&quot;grpo_model.json&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;ä¿å­˜æ¨¡å‹å¤±è´¥: %v\n&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¤ºä¾‹2ï¼šè¿è¡Œæ—¶è§£æ</span></span><br><span class="line">fmt.Println(<span class="string">&quot;\n=== è¿è¡Œæ—¶è§£æé˜¶æ®µ ===&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡æ–°åŠ è½½æ¨¡å‹ï¼ˆæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒï¼‰</span></span><br><span class="line">newModel := NewGRPOModel(<span class="number">3</span>, <span class="number">0.7</span>)</span><br><span class="line"><span class="keyword">if</span> err := newModel.LoadModel(<span class="string">&quot;grpo_model.json&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;åŠ è½½æ¨¡å‹å¤±è´¥: %v\n&quot;</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;æ¨¡å‹åŠ è½½æˆåŠŸ&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ ä¸€äº›ç¤ºä¾‹æ–‡æ¡£ä¾›æ£€ç´¢</span></span><br><span class="line">newModel.LoadDocument(<span class="string">&quot;doc1.json&quot;</span>)</span><br><span class="line">newModel.LoadDocument(<span class="string">&quot;doc2.json&quot;</span>)</span><br><span class="line">newModel.LoadDocument(<span class="string">&quot;doc3.json&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•æŸ¥è¯¢</span></span><br><span class="line">queries := []<span class="type">string</span>&#123;</span><br><span class="line"><span class="string">&quot;Goè¯­è¨€çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆ&quot;</span>,</span><br><span class="line"><span class="string">&quot;æœºå™¨å­¦ä¹ çš„åŸºæœ¬æ¦‚å¿µ&quot;</span>,</span><br><span class="line"><span class="string">&quot;äººå·¥æ™ºèƒ½çš„å‘å±•å†å²&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, query := <span class="keyword">range</span> queries &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;\næŸ¥è¯¢: %s\n&quot;</span>, query)</span><br><span class="line">response := newModel.Parse(query)</span><br><span class="line">fmt.Printf(<span class="string">&quot;å“åº”: %s\n&quot;</span>, response)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†ç¤ºä¾‹æ–‡ä»¶</span></span><br><span class="line">cleanupExampleDocuments(docFiles)</span><br><span class="line">os.Remove(<span class="string">&quot;grpo_model.json&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç¤ºä¾‹æ–‡æ¡£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createExampleDocuments</span><span class="params">(files []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">docs := []<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;content&quot;</span>: <span class="string">&quot;Goè¯­è¨€æ˜¯ä¸€ç§é™æ€ç±»å‹ã€ç¼–è¯‘å‹è¯­è¨€ï¼Œç”±Googleå¼€å‘ã€‚å®ƒçš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼šå¹¶å‘æ”¯æŒï¼ˆgoroutinesï¼‰ã€åƒåœ¾å›æ”¶ã€ç±»å‹å®‰å…¨ã€å¿«é€Ÿç¼–è¯‘ã€‚Goè¯­è¨€è¯­æ³•ç®€æ´ï¼Œæ ‡å‡†åº“ä¸°å¯Œï¼Œé€‚åˆæ„å»ºé«˜æ€§èƒ½ç½‘ç»œæœåŠ¡ã€‚&quot;</span>,</span><br><span class="line"><span class="string">&quot;metadata&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;topic&quot;</span>: <span class="string">&quot;programming&quot;</span>, <span class="string">&quot;language&quot;</span>: <span class="string">&quot;go&quot;</span>&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;content&quot;</span>: <span class="string">&quot;æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä½¿è®¡ç®—æœºç³»ç»Ÿèƒ½å¤Ÿä»æ•°æ®ä¸­å­¦ä¹ å¹¶æ”¹è¿›æ€§èƒ½ï¼Œè€Œæ— éœ€æ˜¾å¼ç¼–ç¨‹ã€‚ä¸»è¦ç±»å‹åŒ…æ‹¬ç›‘ç£å­¦ä¹ ã€æ— ç›‘ç£å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ ã€‚å¸¸è§ç®—æ³•æœ‰çº¿æ€§å›å½’ã€å†³ç­–æ ‘ã€ç¥ç»ç½‘ç»œç­‰ã€‚&quot;</span>,</span><br><span class="line"><span class="string">&quot;metadata&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;topic&quot;</span>: <span class="string">&quot;ai&quot;</span>, <span class="string">&quot;field&quot;</span>: <span class="string">&quot;machine_learning&quot;</span>&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;content&quot;</span>: <span class="string">&quot;äººå·¥æ™ºèƒ½çš„å‘å±•å†å²å¯ä»¥è¿½æº¯åˆ°1950å¹´ä»£ã€‚1956å¹´è¾¾ç‰¹èŒ…æ–¯ä¼šè®®è¢«è®¤ä¸ºæ˜¯AIçš„è¯ç”Ÿæ ‡å¿—ã€‚ç»å†äº†å¤šæ¬¡å¯’å†¬æœŸå’Œå¤å…´æœŸï¼Œ21ä¸–çºªä»¥æ¥ï¼Œç”±äºæ·±åº¦å­¦ä¹ ã€å¤§æ•°æ®å’Œè®¡ç®—èƒ½åŠ›çš„æå‡ï¼ŒAIè¿›å…¥äº†å¿«é€Ÿå‘å±•é˜¶æ®µã€‚&quot;</span>,</span><br><span class="line"><span class="string">&quot;metadata&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;topic&quot;</span>: <span class="string">&quot;history&quot;</span>, <span class="string">&quot;field&quot;</span>: <span class="string">&quot;ai_evolution&quot;</span>&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, file := <span class="keyword">range</span> files &#123;</span><br><span class="line"><span class="keyword">if</span> i &lt; <span class="built_in">len</span>(docs) &#123;</span><br><span class="line">data, _ := json.MarshalIndent(docs[i], <span class="string">&quot;&quot;</span>, <span class="string">&quot;  &quot;</span>)</span><br><span class="line">ioutil.WriteFile(file, data, <span class="number">0644</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†ç¤ºä¾‹æ–‡æ¡£</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cleanupExampleDocuments</span><span class="params">(files []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">os.Remove(file)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŸç†å¤‡æ³¨"><a href="#åŸç†å¤‡æ³¨" class="headerlink" title="åŸç†å¤‡æ³¨"></a>åŸç†å¤‡æ³¨</h3><p>è¿™ä¸ªç®€åŒ–ç‰ˆ GRPO æ¨¡å‹ä¿ç•™äº†åŸå§‹ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³ï¼š</p><ol><li><p><strong>åˆ†ç»„ç›¸å¯¹ç­–ç•¥ä¼˜åŒ–</strong>ï¼šGRPO é€šè¿‡ä»åŒä¸€é—®é¢˜çš„å¤šä¸ªè¾“å‡ºä¸­è®¡ç®—å¹³å‡å¥–åŠ±æ¥æ›¿ä»£ä¼ ç»Ÿ PPO ä¸­çš„ä»·å€¼å‡½æ•°ï¼Œæ˜¾è‘—å‡å°‘äº†è®¡ç®—èµ„æºæ¶ˆè€— </p></li><li><p><strong>æ—  Critic æ¶æ„</strong>ï¼šä¸ä¼ ç»Ÿ PPO ä¸åŒï¼ŒGRPO ä¸éœ€è¦è®­ç»ƒä»·å€¼å‡½æ•°æ¥ä¼°è®¡ä¼˜åŠ¿å‡½æ•°ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ç»„å†…ç›¸å¯¹æ¯”è¾ƒæ¥è®¡ç®—ä¼˜åŠ¿ </p></li><li><p><strong>åˆ†ç»„æœºåˆ¶</strong>ï¼šå°†å€™é€‰å“åº”åˆ†ç»„ï¼Œåœ¨ç»„å†…è¿›è¡Œç›¸å¯¹è¯„ä¼°ï¼Œè¿™æ˜¯ GRPO åŒºåˆ«äºå…¶ä»–å¼ºåŒ–å­¦ä¹ ç®—æ³•çš„å…³é”®ç‰¹å¾</p></li></ol><h2 id="ä½¿ç”¨è¯´æ˜"><a href="#ä½¿ç”¨è¯´æ˜" class="headerlink" title="ä½¿ç”¨è¯´æ˜"></a>ä½¿ç”¨è¯´æ˜</h2><ol><li><p><strong>å­¦ä¹ é˜¶æ®µ</strong>ï¼š<code>LoadDocument()</code> + <code>Learn()</code></p><ul><li>åŠ è½½æ–‡æ¡£æ–‡ä»¶ï¼ˆæ”¯æŒ JSON æˆ–çº¯æ–‡æœ¬ï¼‰</li><li>è°ƒç”¨<code>Learn()</code>æ–¹æ³•è¿›è¡Œ GRPO è®­ç»ƒ</li></ul></li><li><p><strong>è¿è¡Œæ—¶è§£æ</strong>ï¼š<code>Parse(input)</code></p><ul><li>è¾“å…¥æŸ¥è¯¢æ–‡æœ¬</li><li>æ¨¡å‹æ£€ç´¢ç›¸å…³æ–‡æ¡£ç‰‡æ®µ</li><li>ç”Ÿæˆå¤šä¸ªå€™é€‰å“åº”</li><li>é€šè¿‡ç»„å†…ç›¸å¯¹è¯„ä¼°é€‰æ‹©æœ€ä¼˜å“åº”</li></ul></li><li><p><strong>æ¨¡å‹æŒä¹…åŒ–</strong>ï¼š<code>SaveModel()</code> + <code>LoadModel()</code></p><ul><li>ä¿å­˜è®­ç»ƒå¥½çš„ç­–ç•¥æƒé‡</li><li>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŠ è½½æ¨¡å‹</li></ul></li></ol><p>è¿™ä¸ªå®ç°ä¿ç•™äº† GRPO çš„æ ¸å¿ƒåŸç†ï¼ŒåŒæ—¶ç®€åŒ–äº†å¤æ‚æ€§ï¼Œé€‚åˆç†è§£å’Œå­¦ä¹  GRPO çš„åŸºæœ¬å·¥ä½œæœºåˆ¶ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ‚¨å¯èƒ½éœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚è°ƒæ•´åˆ†ç»„å¤§å°ã€æ¸©åº¦å‚æ•°å’Œå¥–åŠ±å‡½æ•°ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h3 id=&quot;æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç®€åŒ–çš„-GRPO-Group-Relative-Policy-Optimization-æ¨ç†æ¨¡å‹ã€‚GRPO-æ˜¯ç”±-DeepSeek-æå‡ºçš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œç”¨äºè®­ç»ƒå¤§å‹è¯­è¨€æ¨¡å‹&quot;&gt;&lt;a href=&quot;#æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç®€åŒ–çš„-GRPO-Group-Relative-Policy-Optimization-æ¨ç†æ¨¡å‹ã€‚GRPO-æ˜¯ç”±-DeepSeek-æå‡ºçš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œç”¨äºè®­ç»ƒå¤§å‹è¯­è¨€æ¨¡å‹&quot; class=&quot;headerlink&quot; title=&quot;æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç®€åŒ–çš„ GRPO (Group Relative Policy Optimization) æ¨ç†æ¨¡å‹ã€‚GRPO æ˜¯ç”± DeepSeek æå‡ºçš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œç”¨äºè®­ç»ƒå¤§å‹è¯­è¨€æ¨¡å‹&quot;&gt;&lt;/a&gt;æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªç®€åŒ–çš„ GRPO (Group Relative Policy Optimization) æ¨ç†æ¨¡å‹ã€‚GRPO æ˜¯ç”± DeepSeek æå‡ºçš„å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œç”¨äºè®­ç»ƒå¤§å‹è¯­è¨€æ¨¡å‹&lt;/h3&gt;&lt;p&gt;å®ƒçš„æ ¸å¿ƒç‰¹ç‚¹æ˜¯ä¸éœ€è¦è®­ç»ƒä»·å€¼å‡½æ•°ï¼Œè€Œæ˜¯é€šè¿‡ä»åŒä¸€é—®é¢˜çš„å¤šä¸ªè¾“å‡ºä¸­è®¡ç®—å¹³å‡å¥–åŠ±æ¥æ›¿ä»£è¿™ä¸€è¿‡ç¨‹ï¼Œæ˜¾è‘—å‡å°‘äº†å†…å­˜å’Œè®¡ç®—èµ„æºçš„æ¶ˆè€— ã€‚ &lt;/p&gt;
&lt;h6 id=&quot;ç®€åŒ–ç‰ˆ-GRPO-æ¨ç†æ¨¡å‹ï¼š&quot;&gt;&lt;a href=&quot;#ç®€åŒ–ç‰ˆ-GRPO-æ¨ç†æ¨¡å‹ï¼š&quot; class=&quot;headerlink&quot; title=&quot;ç®€åŒ–ç‰ˆ GRPO æ¨ç†æ¨¡å‹ï¼š&quot;&gt;&lt;/a&gt;ç®€åŒ–ç‰ˆ GRPO æ¨ç†æ¨¡å‹ï¼š&lt;/h6&gt;</summary>
    
    
    
    <category term="AI" scheme="https://www.wdft.com/categories/AI/"/>
    
    <category term="Algo" scheme="https://www.wdft.com/categories/AI/Algo/"/>
    
    
    <category term="AI" scheme="https://www.wdft.com/tags/AI/"/>
    
    <category term="LLM" scheme="https://www.wdft.com/tags/LLM/"/>
    
    <category term="Deepseek" scheme="https://www.wdft.com/tags/Deepseek/"/>
    
    <category term="GRPO" scheme="https://www.wdft.com/tags/GRPO/"/>
    
  </entry>
  
  <entry>
    <title>æ·±åº¦è§£æ PostgreSQL å¼•æ“ï¼šè®¾è®¡åŸç†ã€å®ç°æœºåˆ¶ä¸æ€§èƒ½ä¼˜åŒ–</title>
    <link href="https://www.wdft.com/fcaf092e.html"/>
    <id>https://www.wdft.com/fcaf092e.html</id>
    <published>2025-11-22T11:18:13.000Z</published>
    <updated>2026-01-24T16:44:53.928Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p><strong>â€œå½“ä½ ä¸èƒ½ç”¨ç®€å•çš„è¯­è¨€æ¥æè¿°ä¸€ä»¶äº‹æƒ…æ—¶ï¼Œè¯´æ˜ä½ æ²¡å¼„æ‡‚å®ƒã€‚â€ â€”â€”â€”â€”è´¹æ›¼</strong></p><p>åœ¨å½“ä»Šæ•°æ®é©±åŠ¨çš„æ—¶ä»£ï¼Œæ•°æ®åº“ç³»ç»Ÿä½œä¸ºä¼ä¸šæ ¸å¿ƒåŸºç¡€è®¾æ–½çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚PostgreSQL ä½œä¸ºä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œå‡­å€Ÿå…¶å“è¶Šçš„ç¨³å®šæ€§ã€å¼ºå¤§çš„åŠŸèƒ½é›†å’Œä¼˜ç§€çš„æ€§èƒ½è¡¨ç°ï¼Œå·²ç»æˆä¸ºä¼—å¤šä¼ä¸šå’Œå¼€å‘è€…çš„é¦–é€‰ã€‚è‡ª 1986 å¹´è¯ç”Ÿä»¥æ¥ï¼ŒPostgreSQL ç»å†äº†è¿‘å››åå¹´çš„å‘å±•å†ç¨‹ï¼Œä»æœ€åˆçš„â€Ingresâ€é¡¹ç›®æ¼”å˜ä¸ºä»Šå¤©åŠŸèƒ½å®Œå¤‡çš„ä¼ä¸šçº§æ•°æ®åº“è§£å†³æ–¹æ¡ˆã€‚</p><span id="more"></span><p>æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ PostgreSQL å¼•æ“çš„æ ¸å¿ƒè®¾è®¡åŸç†ã€å®ç°æœºåˆ¶ä»¥åŠæ€§èƒ½ç‰¹æ€§ï¼Œä¸ºæ•°æ®åº“æ¶æ„å¸ˆã€å¼€å‘äººå‘˜å’Œè¿ç»´å·¥ç¨‹å¸ˆæä¾›å…¨é¢çš„æŠ€æœ¯å‚è€ƒã€‚æˆ‘ä»¬å°†ä»æ¶æ„å±‚é¢å¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ°å­˜å‚¨å¼•æ“ã€äº‹åŠ¡ç®¡ç†ã€æŸ¥è¯¢ä¼˜åŒ–ç­‰æ ¸å¿ƒç»„ä»¶ï¼Œæœ€ååˆ†æå…¶æ€§èƒ½ä¼˜ç¼ºç‚¹å¹¶æä¾›ä¼˜åŒ–å»ºè®®ã€‚é€šè¿‡æœ¬æ–‡ï¼Œè¯»è€…å°†è·å¾—å¯¹ PostgreSQL å†…éƒ¨å·¥ä½œåŸç†çš„æ·±åˆ»ç†è§£ï¼Œä»è€Œåœ¨å®é™…åº”ç”¨ä¸­èƒ½å¤Ÿæ›´å¥½åœ°è®¾è®¡ã€éƒ¨ç½²å’Œä¼˜åŒ–åŸºäº PostgreSQL çš„åº”ç”¨ç³»ç»Ÿã€‚</p><h2 id="ä¸€ã€PostgreSQL-æ ¸å¿ƒæ¶æ„è®¾è®¡"><a href="#ä¸€ã€PostgreSQL-æ ¸å¿ƒæ¶æ„è®¾è®¡" class="headerlink" title="ä¸€ã€PostgreSQL æ ¸å¿ƒæ¶æ„è®¾è®¡"></a>ä¸€ã€PostgreSQL æ ¸å¿ƒæ¶æ„è®¾è®¡</h2><h3 id="1-1-å®¢æˆ·ç«¯-x2F-æœåŠ¡å™¨æ¨¡å‹"><a href="#1-1-å®¢æˆ·ç«¯-x2F-æœåŠ¡å™¨æ¨¡å‹" class="headerlink" title="1.1 å®¢æˆ·ç«¯&#x2F;æœåŠ¡å™¨æ¨¡å‹"></a>1.1 å®¢æˆ·ç«¯&#x2F;æœåŠ¡å™¨æ¨¡å‹</h3><p>PostgreSQL é‡‡ç”¨ç»å…¸çš„å®¢æˆ·ç«¯&#x2F;æœåŠ¡å™¨æ¶æ„æ¨¡å‹ï¼Œè¿™æ˜¯å…¶è®¾è®¡çš„æ ¸å¿ƒåŸºç¡€ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œæ•°æ®åº“æœåŠ¡å™¨ï¼ˆé€šå¸¸ç§°ä¸ºâ€postmasterâ€ï¼‰è´Ÿè´£ç®¡ç†æ•°æ®åº“æ–‡ä»¶ã€æ¥å—å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼Œå¹¶ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ›å»ºç‹¬ç«‹çš„åç«¯è¿›ç¨‹ã€‚ è¿™ç§è®¾è®¡æ¨¡å¼ä½¿å¾— PostgreSQL èƒ½å¤Ÿæœ‰æ•ˆåœ°æ”¯æŒå¤šç”¨æˆ·å¹¶å‘è®¿é—®ï¼ŒåŒæ—¶ä¿æŒç³»ç»Ÿçš„ç¨³å®šæ€§å’Œéš”ç¦»æ€§ã€‚</p><p>å®¢æˆ·ç«¯&#x2F;æœåŠ¡å™¨æ¶æ„çš„ä¼˜åŠ¿åœ¨äºï¼š</p><ul><li><strong>èµ„æºéš”ç¦»</strong>ï¼šæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥åœ¨ç‹¬ç«‹çš„è¿›ç¨‹ä¸­è¿è¡Œï¼Œä¸€ä¸ªè¿æ¥çš„æ•…éšœä¸ä¼šå½±å“å…¶ä»–è¿æ¥</li><li><strong>å¹¶å‘æ§åˆ¶</strong>ï¼šæœåŠ¡å™¨å¯ä»¥é›†ä¸­ç®¡ç†æ‰€æœ‰å¹¶å‘äº‹åŠ¡ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§</li><li><strong>å®‰å…¨æ€§</strong>ï¼šé€šè¿‡é›†ä¸­å¼çš„è®¤è¯å’Œæˆæƒæœºåˆ¶ï¼Œä¿æŠ¤æ•°æ®å®‰å…¨</li><li><strong>å¯æ‰©å±•æ€§</strong>ï¼šæœåŠ¡å™¨å¯ä»¥éƒ¨ç½²åœ¨é«˜æ€§èƒ½ç¡¬ä»¶ä¸Šï¼Œå®¢æˆ·ç«¯å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒçš„è®¾å¤‡ä¸Š</li></ul><h3 id="1-2-æ ¸å¿ƒç»„ä»¶æ¶æ„"><a href="#1-2-æ ¸å¿ƒç»„ä»¶æ¶æ„" class="headerlink" title="1.2 æ ¸å¿ƒç»„ä»¶æ¶æ„"></a>1.2 æ ¸å¿ƒç»„ä»¶æ¶æ„</h3><p>PostgreSQL çš„æ¶æ„ç”±å‡ ä¸ªå…³é”®ç»„ä»¶ç»„æˆï¼Œè¿™äº›ç»„ä»¶ååŒå·¥ä½œä»¥æä¾›å®Œæ•´çš„æ•°æ®åº“æœåŠ¡ï¼š</p><h4 id="1-2-1-Postmaster-å®ˆæŠ¤è¿›ç¨‹"><a href="#1-2-1-Postmaster-å®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="1.2.1 Postmaster å®ˆæŠ¤è¿›ç¨‹"></a>1.2.1 Postmaster å®ˆæŠ¤è¿›ç¨‹</h4><p>Postmaster æ˜¯ PostgreSQL çš„ä¸»è¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨æ•°æ®åº“ç³»ç»Ÿã€ç›‘å¬å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼Œå¹¶ä¸ºæ¯ä¸ªæ–°è¿æ¥åˆ›å»ºåç«¯è¿›ç¨‹ã€‚ å®ƒæ˜¯æ•´ä¸ª PostgreSQL å®ä¾‹çš„â€å¤§è„‘â€ï¼Œç®¡ç†ç€ç³»ç»Ÿçš„æ‰€æœ‰èµ„æºåˆ†é…å’Œè¿›ç¨‹è°ƒåº¦ã€‚å½“æ•°æ®åº“å¯åŠ¨æ—¶ï¼Œpostmaster é¦–å…ˆåˆå§‹åŒ–å…±äº«å†…å­˜åŒºåŸŸï¼ŒåŠ è½½é…ç½®å‚æ•°ï¼Œç„¶åå¼€å§‹ç›‘å¬æŒ‡å®šçš„ç«¯å£ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚</p><h4 id="1-2-2-å…±äº«å†…å­˜"><a href="#1-2-2-å…±äº«å†…å­˜" class="headerlink" title="1.2.2 å…±äº«å†…å­˜"></a>1.2.2 å…±äº«å†…å­˜</h4><p>å…±äº«å†…å­˜æ˜¯ PostgreSQL æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ç»„ä»¶ä¹‹ä¸€ã€‚å®ƒåŒ…å«å¤šä¸ªé‡è¦åŒºåŸŸï¼š</p><ul><li><strong>å…±äº«ç¼“å†²åŒºï¼ˆShared Bufferï¼‰</strong>ï¼šç¼“å­˜æ•°æ®é¡µï¼Œå‡å°‘ç£ç›˜ I&#x2F;O</li><li><strong>WAL ç¼“å†²åŒºï¼ˆWAL Bufferï¼‰</strong>ï¼šç¼“å­˜é¢„å†™æ—¥å¿—ï¼Œç¡®ä¿äº‹åŠ¡æŒä¹…æ€§</li><li><strong>å…±äº«é”è¡¨ï¼ˆLock Tableï¼‰</strong>ï¼šç®¡ç†å¹¶å‘äº‹åŠ¡ä¹‹é—´çš„é”</li><li><strong>å·¥ä½œå†…å­˜ï¼ˆWork Memoryï¼‰</strong>ï¼šç”¨äºæ’åºã€å“ˆå¸Œè¿æ¥ç­‰æ“ä½œ</li></ul><p>å…±äº«å†…å­˜çš„è®¾è®¡ä½¿å¾—å¤šä¸ªåç«¯è¿›ç¨‹å¯ä»¥é«˜æ•ˆåœ°å…±äº«æ•°æ®ï¼Œé¿å…äº†é¢‘ç¹çš„è¿›ç¨‹é—´é€šä¿¡å¼€é”€ã€‚</p><h4 id="1-2-3-åç«¯è¿›ç¨‹"><a href="#1-2-3-åç«¯è¿›ç¨‹" class="headerlink" title="1.2.3 åç«¯è¿›ç¨‹"></a>1.2.3 åç«¯è¿›ç¨‹</h4><p>æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„åç«¯è¿›ç¨‹ï¼ˆbackend processï¼‰ï¼Œè¿™äº›è¿›ç¨‹è´Ÿè´£å¤„ç†å…·ä½“çš„ SQL æŸ¥è¯¢ã€äº‹åŠ¡ç®¡ç†ã€æƒé™æ£€æŸ¥ç­‰å·¥ä½œã€‚ åç«¯è¿›ç¨‹ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œä¸€ä¸ªè¿›ç¨‹çš„å´©æºƒä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹ï¼Œè¿™å¤§å¤§æé«˜äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚æ¯ä¸ªåç«¯è¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç§æœ‰å†…å­˜åŒºåŸŸï¼ŒåŒæ—¶å¯ä»¥è®¿é—®å…±äº«å†…å­˜ä¸­çš„å…¨å±€æ•°æ®ã€‚</p><h4 id="1-2-4-å…±äº«æ± "><a href="#1-2-4-å…±äº«æ± " class="headerlink" title="1.2.4 å…±äº«æ± "></a>1.2.4 å…±äº«æ± </h4><p>å…±äº«æ± æ˜¯ PostgreSQL å†…å­˜ç®¡ç†çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºç¼“å­˜æ‰§è¡Œè®¡åˆ’ã€ç³»ç»Ÿç›®å½•ä¿¡æ¯ç­‰ã€‚ é€šè¿‡é‡ç”¨å·²æœ‰çš„æ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥é¿å…é‡å¤çš„æŸ¥è¯¢è§£æå’Œä¼˜åŒ–è¿‡ç¨‹ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚å…±äº«æ± çš„è®¾è®¡ä½“ç°äº† PostgreSQL å¯¹æ€§èƒ½ä¼˜åŒ–çš„æ·±å…¥è€ƒè™‘ã€‚</p><h3 id="1-3-å¤šè¿›ç¨‹æ¶æ„è®¾è®¡"><a href="#1-3-å¤šè¿›ç¨‹æ¶æ„è®¾è®¡" class="headerlink" title="1.3 å¤šè¿›ç¨‹æ¶æ„è®¾è®¡"></a>1.3 å¤šè¿›ç¨‹æ¶æ„è®¾è®¡</h3><p>ä¸è®¸å¤šç°ä»£æ•°æ®åº“é‡‡ç”¨çš„å¤šçº¿ç¨‹æ¶æ„ä¸åŒï¼ŒPostgreSQL åšæŒä½¿ç”¨å¤šè¿›ç¨‹æ¶æ„ã€‚è¿™ç§è®¾è®¡é€‰æ‹©æœ‰å…¶å†å²åŸå› å’ŒæŠ€æœ¯è€ƒé‡ï¼š</p><h4 id="1-3-1-ç¨³å®šæ€§ä¼˜å…ˆ"><a href="#1-3-1-ç¨³å®šæ€§ä¼˜å…ˆ" class="headerlink" title="1.3.1 ç¨³å®šæ€§ä¼˜å…ˆ"></a>1.3.1 ç¨³å®šæ€§ä¼˜å…ˆ</h4><p>å¤šè¿›ç¨‹æ¶æ„çš„æœ€å¤§ä¼˜åŠ¿åœ¨äºç¨³å®šæ€§ã€‚åœ¨ Unix&#x2F;Linux ç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œä¸€ä¸ªè¿›ç¨‹çš„å´©æºƒä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹ã€‚ è¿™å¯¹äºéœ€è¦ 7Ã—24 å°æ—¶è¿è¡Œçš„å…³é”®ä¸šåŠ¡ç³»ç»Ÿæ¥è¯´è‡³å…³é‡è¦ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¤šçº¿ç¨‹æ¶æ„ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹çš„å´©æºƒå¯èƒ½å¯¼è‡´æ•´ä¸ªè¿›ç¨‹ç»ˆæ­¢ã€‚</p><h4 id="1-3-2-èµ„æºç®¡ç†"><a href="#1-3-2-èµ„æºç®¡ç†" class="headerlink" title="1.3.2 èµ„æºç®¡ç†"></a>1.3.2 èµ„æºç®¡ç†</h4><p>å¤šè¿›ç¨‹æ¶æ„ä½¿å¾—èµ„æºç®¡ç†æ›´åŠ ç²¾ç»†ã€‚æ¯ä¸ªåç«¯è¿›ç¨‹å¯ä»¥ç‹¬ç«‹è®¾ç½®å†…å­˜é™åˆ¶ã€CPU é…é¢ç­‰ï¼Œä¾¿äºè¿›è¡Œèµ„æºéš”ç¦»å’Œæ§åˆ¶ã€‚è¿™å¯¹äºå¤šç§Ÿæˆ·ç¯å¢ƒæˆ–èµ„æºå—é™çš„åœºæ™¯ç‰¹åˆ«æœ‰ç”¨ã€‚</p><h4 id="1-3-3-æ‰©å±•æ€§è€ƒé‡"><a href="#1-3-3-æ‰©å±•æ€§è€ƒé‡" class="headerlink" title="1.3.3 æ‰©å±•æ€§è€ƒé‡"></a>1.3.3 æ‰©å±•æ€§è€ƒé‡</h4><p>è™½ç„¶å¤šè¿›ç¨‹æ¶æ„åœ¨è¿›ç¨‹åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ–¹é¢æœ‰ä¸€å®šçš„å¼€é”€ï¼Œä½† PostgreSQL é€šè¿‡è¿æ¥æ± æŠ€æœ¯ï¼ˆå¦‚ pgBouncerï¼‰å¯ä»¥æœ‰æ•ˆç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚ è¿æ¥æ± è´Ÿè´£ç®¡ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œå¤ç”¨åç«¯è¿›ç¨‹ï¼Œå¤§å¤§å‡å°‘äº†è¿›ç¨‹åˆ›å»ºçš„å¼€é”€ã€‚</p><h2 id="äºŒã€å­˜å‚¨å¼•æ“å®ç°æœºåˆ¶"><a href="#äºŒã€å­˜å‚¨å¼•æ“å®ç°æœºåˆ¶" class="headerlink" title="äºŒã€å­˜å‚¨å¼•æ“å®ç°æœºåˆ¶"></a>äºŒã€å­˜å‚¨å¼•æ“å®ç°æœºåˆ¶</h2><h3 id="2-1-MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æ¶æ„"><a href="#2-1-MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æ¶æ„" class="headerlink" title="2.1 MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æ¶æ„"></a>2.1 MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æ¶æ„</h3><p>MVCC æ˜¯ PostgreSQL å­˜å‚¨å¼•æ“çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œä¹Ÿæ˜¯å…¶å®ç°é«˜å¹¶å‘çš„å…³é”®ã€‚MVCC çš„åŸºæœ¬åŸç†æ˜¯ä¸ºæ¯ä¸ªäº‹åŠ¡æä¾›æ•°æ®åº“åœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„â€å¿«ç…§â€ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹ç°æœ‰æ•°æ®ã€‚ è¿™ç§è®¾è®¡ä½¿å¾—è¯»æ“ä½œä¸ä¼šé˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸ä¼šé˜»å¡è¯»æ“ä½œï¼Œä»è€Œå®ç°äº†é«˜åº¦çš„å¹¶å‘æ€§ã€‚</p><h4 id="2-1-1-ç‰ˆæœ¬é“¾ç®¡ç†"><a href="#2-1-1-ç‰ˆæœ¬é“¾ç®¡ç†" class="headerlink" title="2.1.1 ç‰ˆæœ¬é“¾ç®¡ç†"></a>2.1.1 ç‰ˆæœ¬é“¾ç®¡ç†</h4><p>åœ¨ MVCC æ¶æ„ä¸­ï¼Œæ¯æ¬¡æ›´æ–°æ“ä½œå®é™…ä¸Šä¼šåˆ›å»ºæ•°æ®çš„æ–°ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯è¦†ç›–æ—§ç‰ˆæœ¬ã€‚æ¯ä¸ªæ•°æ®è¡Œéƒ½åŒ…å«ï¼š</p><ul><li><strong>xmin</strong>ï¼šåˆ›å»ºè¯¥è¡Œç‰ˆæœ¬çš„äº‹åŠ¡ ID</li><li><strong>xmax</strong>ï¼šåˆ é™¤æˆ–æ›´æ–°è¯¥è¡Œç‰ˆæœ¬çš„äº‹åŠ¡ ID</li><li><strong>ctid</strong>ï¼šæŒ‡å‘è¯¥è¡Œç‰©ç†ä½ç½®çš„æŒ‡é’ˆ</li><li><strong>ç‰ˆæœ¬æ•°æ®</strong>ï¼šå®é™…çš„æ•°æ®å†…å®¹</li></ul><p>å½“äº‹åŠ¡éœ€è¦è¯»å–æ•°æ®æ—¶ï¼ŒPostgreSQL ä¼šæ ¹æ®äº‹åŠ¡çš„å¿«ç…§æ—¶é—´ç‚¹ï¼Œé€‰æ‹©å¯è§çš„è¡Œç‰ˆæœ¬ã€‚ è¿™ç§æœºåˆ¶ç¡®ä¿äº†äº‹åŠ¡çš„éš”ç¦»æ€§ï¼ŒåŒæ—¶é¿å…äº†è¯»å†™å†²çªã€‚</p><h4 id="2-1-2-äº‹åŠ¡å¯è§æ€§è§„åˆ™"><a href="#2-1-2-äº‹åŠ¡å¯è§æ€§è§„åˆ™" class="headerlink" title="2.1.2 äº‹åŠ¡å¯è§æ€§è§„åˆ™"></a>2.1.2 äº‹åŠ¡å¯è§æ€§è§„åˆ™</h4><p>PostgreSQL é€šè¿‡å¤æ‚çš„å¯è§æ€§è§„åˆ™æ¥ç¡®å®šå“ªäº›æ•°æ®ç‰ˆæœ¬å¯¹ç‰¹å®šäº‹åŠ¡å¯è§ï¼š</p><ul><li>äº‹åŠ¡åªèƒ½çœ‹åˆ°åœ¨å…¶å¼€å§‹ä¹‹å‰å·²æäº¤çš„æ•°æ®</li><li>äº‹åŠ¡çœ‹ä¸åˆ°åœ¨å…¶å¼€å§‹ä¹‹åæäº¤çš„æ•°æ®</li><li>äº‹åŠ¡çœ‹ä¸åˆ°æœªæäº¤çš„æ•°æ®</li><li>äº‹åŠ¡åªèƒ½çœ‹åˆ°æ»¡è¶³å…¶éš”ç¦»çº§åˆ«çš„æ•°æ®</li></ul><p>è¿™äº›è§„åˆ™ç¡®ä¿äº† ACID ç‰¹æ€§ä¸­çš„éš”ç¦»æ€§ï¼ˆIsolationï¼‰å’Œä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€‚ MVCC æ¶æ„ä½¿å¾— PostgreSQL èƒ½å¤Ÿåœ¨ä¸ä½¿ç”¨è¯»é”çš„æƒ…å†µä¸‹å®ç°é«˜åº¦å¹¶å‘ï¼Œè¿™æ˜¯å…¶æ€§èƒ½ä¼˜åŠ¿çš„é‡è¦æ¥æºã€‚</p><h3 id="2-2-äº‹åŠ¡ç®¡ç†æœºåˆ¶"><a href="#2-2-äº‹åŠ¡ç®¡ç†æœºåˆ¶" class="headerlink" title="2.2 äº‹åŠ¡ç®¡ç†æœºåˆ¶"></a>2.2 äº‹åŠ¡ç®¡ç†æœºåˆ¶</h3><p>äº‹åŠ¡ç®¡ç†æ˜¯ PostgreSQL çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒç¡®ä¿äº†æ•°æ®åº“æ“ä½œçš„åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§ï¼ˆACIDï¼‰ã€‚</p><h4 id="2-2-1-äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸ"><a href="#2-2-1-äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2.2.1 äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸ"></a>2.2.1 äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸ</h4><p>PostgreSQL äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ï¼š</p><ol><li><strong>BEGIN</strong>ï¼šå¼€å§‹äº‹åŠ¡ï¼Œåˆ†é…äº‹åŠ¡ ID</li><li><strong>æ‰§è¡Œ SQL è¯­å¥</strong>ï¼šä¿®æ”¹æ•°æ®ï¼Œç”Ÿæˆ WAL æ—¥å¿—</li><li><strong>COMMIT</strong>ï¼šæäº¤äº‹åŠ¡ï¼Œä½¿ä¿®æ”¹æŒä¹…åŒ–</li><li><strong>ROLLBACK</strong>ï¼šå›æ»šäº‹åŠ¡ï¼Œæ’¤é”€æ‰€æœ‰ä¿®æ”¹</li></ol><p>æ¯ä¸ªäº‹åŠ¡éƒ½æœ‰å”¯ä¸€çš„äº‹åŠ¡ IDï¼ˆXIDï¼‰ï¼Œç”¨äºæ ‡è¯†å’Œè·Ÿè¸ªäº‹åŠ¡çš„çŠ¶æ€ã€‚ äº‹åŠ¡ ID çš„åˆ†é…å’Œç®¡ç†æ˜¯äº‹åŠ¡ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå®ƒç›´æ¥å½±å“åˆ°å¹¶å‘æ§åˆ¶å’Œæ¢å¤æœºåˆ¶ã€‚</p><h4 id="2-2-2-WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰æœºåˆ¶"><a href="#2-2-2-WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰æœºåˆ¶" class="headerlink" title="2.2.2 WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰æœºåˆ¶"></a>2.2.2 WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰æœºåˆ¶</h4><p>WAL æ˜¯ PostgreSQL ç¡®ä¿æŒä¹…æ€§çš„å…³é”®æŠ€æœ¯ã€‚åœ¨ä¿®æ”¹æ•°æ®æ–‡ä»¶ä¹‹å‰ï¼Œæ‰€æœ‰ä¿®æ”¹æ“ä½œéƒ½ä¼šå…ˆè®°å½•åˆ° WAL æ—¥å¿—ä¸­ã€‚ è¿™ç§è®¾è®¡ç¡®ä¿äº†å³ä½¿åœ¨ç³»ç»Ÿå´©æºƒçš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é‡æ”¾ WAL æ—¥å¿—æ¥æ¢å¤æ•°æ®ã€‚</p><p>WAL æœºåˆ¶çš„å·¥ä½œæµç¨‹ï¼š</p><ol><li>äº‹åŠ¡ä¿®æ”¹æ•°æ®æ—¶ï¼Œé¦–å…ˆå°†ä¿®æ”¹æ“ä½œè®°å½•åˆ° WAL ç¼“å†²åŒº</li><li>WAL ç¼“å†²åŒºå®šæœŸæˆ–åœ¨äº‹åŠ¡æäº¤æ—¶åˆ·æ–°åˆ°ç£ç›˜</li><li>æ•°æ®ç¼“å†²åŒºçš„ä¿®æ”¹å¯ä»¥å»¶è¿Ÿå†™å…¥ç£ç›˜</li><li>ç³»ç»Ÿå´©æºƒåï¼Œé€šè¿‡é‡æ”¾ WAL æ—¥å¿—æ¢å¤æœªå†™å…¥ç£ç›˜çš„æ•°æ®ä¿®æ”¹</li></ol><p>WAL æœºåˆ¶ä¸ä»…æä¾›äº†å´©æºƒæ¢å¤èƒ½åŠ›ï¼Œè¿˜æ”¯æŒæ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰ã€æµå¤åˆ¶ç­‰é«˜çº§åŠŸèƒ½ã€‚</p><h4 id="2-2-3-æ£€æŸ¥ç‚¹æœºåˆ¶"><a href="#2-2-3-æ£€æŸ¥ç‚¹æœºåˆ¶" class="headerlink" title="2.2.3 æ£€æŸ¥ç‚¹æœºåˆ¶"></a>2.2.3 æ£€æŸ¥ç‚¹æœºåˆ¶</h4><p>æ£€æŸ¥ç‚¹æ˜¯ PostgreSQL å°†å†…å­˜ä¸­çš„è„é¡µï¼ˆå·²ä¿®æ”¹ä½†æœªå†™å…¥ç£ç›˜çš„æ•°æ®é¡µï¼‰åˆ·æ–°åˆ°ç£ç›˜çš„è¿‡ç¨‹ã€‚ æ£€æŸ¥ç‚¹æœºåˆ¶çš„ä½œç”¨æ˜¯ï¼š</p><ul><li>å‡å°‘å´©æºƒæ¢å¤æ—¶é—´</li><li>é‡Šæ”¾ WAL æ—¥å¿—ç©ºé—´</li><li>ç¡®ä¿æ•°æ®æŒä¹…æ€§</li></ul><p>PostgreSQL æ”¯æŒå¤šç§æ£€æŸ¥ç‚¹ç­–ç•¥ï¼ŒåŒ…æ‹¬å®šæ—¶æ£€æŸ¥ç‚¹ã€åŸºäº WAL å¤§å°çš„æ£€æŸ¥ç‚¹ç­‰ï¼Œå¯ä»¥æ ¹æ®å·¥ä½œè´Ÿè½½ç‰¹æ€§è¿›è¡Œä¼˜åŒ–ã€‚</p><h3 id="2-3-å­˜å‚¨ç»“æ„è®¾è®¡"><a href="#2-3-å­˜å‚¨ç»“æ„è®¾è®¡" class="headerlink" title="2.3 å­˜å‚¨ç»“æ„è®¾è®¡"></a>2.3 å­˜å‚¨ç»“æ„è®¾è®¡</h3><p>PostgreSQL çš„å­˜å‚¨ç»“æ„è®¾è®¡ä½“ç°äº†å…¶å¯¹æ€§èƒ½å’Œå¯é æ€§çš„å¹³è¡¡è€ƒè™‘ã€‚</p><h4 id="2-3-1-è¡¨ç©ºé—´ç®¡ç†"><a href="#2-3-1-è¡¨ç©ºé—´ç®¡ç†" class="headerlink" title="2.3.1 è¡¨ç©ºé—´ç®¡ç†"></a>2.3.1 è¡¨ç©ºé—´ç®¡ç†</h4><p>è¡¨ç©ºé—´æ˜¯ PostgreSQL ä¸­ç”¨äºç®¡ç†ç‰©ç†å­˜å‚¨çš„é€»è¾‘æ¦‚å¿µã€‚ æ¯ä¸ªè¡¨ç©ºé—´å¯¹åº”ä¸€ä¸ªæˆ–å¤šä¸ªç‰©ç†ç›®å½•ï¼Œæ•°æ®æ–‡ä»¶å­˜å‚¨åœ¨è¿™äº›ç›®å½•ä¸­ã€‚è¡¨ç©ºé—´çš„è®¾è®¡ä½¿å¾—ç®¡ç†å‘˜å¯ä»¥å°†ä¸åŒçš„è¡¨æˆ–ç´¢å¼•å­˜å‚¨åœ¨ä¸åŒçš„ç‰©ç†è®¾å¤‡ä¸Šï¼Œä»è€Œä¼˜åŒ– I&#x2F;O æ€§èƒ½ã€‚</p><h4 id="2-3-2-é¡µé¢ç»“æ„"><a href="#2-3-2-é¡µé¢ç»“æ„" class="headerlink" title="2.3.2 é¡µé¢ç»“æ„"></a>2.3.2 é¡µé¢ç»“æ„</h4><p>PostgreSQL ä½¿ç”¨å›ºå®šå¤§å°çš„é¡µé¢ï¼ˆé€šå¸¸ä¸º 8KBï¼‰ä½œä¸ºå­˜å‚¨çš„åŸºæœ¬å•ä½ã€‚ æ¯ä¸ªé¡µé¢åŒ…å«ï¼š</p><ul><li><strong>é¡µé¢å¤´</strong>ï¼šåŒ…å«é¡µé¢å…ƒæ•°æ®ï¼Œå¦‚æ ¡éªŒå’Œã€LSNï¼ˆæ—¥å¿—åºåˆ—å·ï¼‰ç­‰</li><li><strong>è¡ŒæŒ‡é’ˆæ•°ç»„</strong>ï¼šæŒ‡å‘é¡µé¢å†…å„ä¸ªæ•°æ®è¡Œçš„æŒ‡é’ˆ</li><li><strong>ç©ºé—²ç©ºé—´</strong>ï¼šæœªä½¿ç”¨çš„ç©ºé—´</li><li><strong>æ•°æ®è¡Œ</strong>ï¼šå®é™…å­˜å‚¨çš„æ•°æ®</li></ul><p>é¡µé¢ç»“æ„çš„è®¾è®¡è€ƒè™‘äº†ç©ºé—´åˆ©ç”¨ç‡å’Œè®¿é—®æ•ˆç‡çš„å¹³è¡¡ã€‚ é€šè¿‡è¡ŒæŒ‡é’ˆæ•°ç»„ï¼ŒPostgreSQL å¯ä»¥å¿«é€Ÿå®šä½å’Œè®¿é—®é¡µé¢å†…çš„æ•°æ®è¡Œï¼Œè€Œä¸éœ€è¦éå†æ•´ä¸ªé¡µé¢ã€‚</p><h4 id="2-3-3-ç´¢å¼•å®ç°"><a href="#2-3-3-ç´¢å¼•å®ç°" class="headerlink" title="2.3.3 ç´¢å¼•å®ç°"></a>2.3.3 ç´¢å¼•å®ç°</h4><p>PostgreSQL æ”¯æŒå¤šç§ç´¢å¼•ç±»å‹ï¼Œæ¯ç§ç±»å‹é€‚ç”¨äºä¸åŒçš„æŸ¥è¯¢æ¨¡å¼ï¼š</p><p><strong>B-tree ç´¢å¼•</strong>ï¼šæœ€å¸¸ç”¨çš„ç´¢å¼•ç±»å‹ï¼Œé€‚ç”¨äºç­‰å€¼æŸ¥è¯¢å’ŒèŒƒå›´æŸ¥è¯¢ã€‚B-tree ç´¢å¼•é€šè¿‡å¹³è¡¡æ ‘ç»“æ„æä¾› O(log n)çš„æŸ¥è¯¢å¤æ‚åº¦ã€‚</p><p><strong>Hash ç´¢å¼•</strong>ï¼šé€‚ç”¨äºç­‰å€¼æŸ¥è¯¢ï¼Œæä¾› O(1)çš„æŸ¥è¯¢å¤æ‚åº¦ï¼Œä½†ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€‚</p><p><strong>GiST ç´¢å¼•</strong>ï¼šé€šç”¨æœç´¢æ ‘ï¼Œæ”¯æŒå¤æ‚æ•°æ®ç±»å‹å’Œè‡ªå®šä¹‰æ“ä½œç¬¦ã€‚</p><p><strong>GIN ç´¢å¼•</strong>ï¼šé€šç”¨å€’æ’ç´¢å¼•ï¼Œé€‚ç”¨äºå…¨æ–‡æœç´¢å’Œæ•°ç»„ç±»å‹ã€‚</p><p><strong>BRIN ç´¢å¼•</strong>ï¼šå—èŒƒå›´ç´¢å¼•ï¼Œé€‚ç”¨äºå¤§è¡¨ä¸­å…·æœ‰å±€éƒ¨ç›¸å…³æ€§çš„æ•°æ®ã€‚</p><p>ç´¢å¼•çš„é€‰æ‹©å’Œè®¾è®¡å¯¹æŸ¥è¯¢æ€§èƒ½æœ‰é‡å¤§å½±å“ã€‚ åˆç†çš„ç´¢å¼•ç­–ç•¥å¯ä»¥æ˜¾è‘—æé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œä½†ä¹Ÿä¼šå¢åŠ å†™æ“ä½œçš„å¼€é”€å’Œå­˜å‚¨ç©ºé—´éœ€æ±‚ã€‚</p><h2 id="ä¸‰ã€æŸ¥è¯¢å¤„ç†å¼•æ“"><a href="#ä¸‰ã€æŸ¥è¯¢å¤„ç†å¼•æ“" class="headerlink" title="ä¸‰ã€æŸ¥è¯¢å¤„ç†å¼•æ“"></a>ä¸‰ã€æŸ¥è¯¢å¤„ç†å¼•æ“</h2><h3 id="3-1-æŸ¥è¯¢å¤„ç†æµç¨‹"><a href="#3-1-æŸ¥è¯¢å¤„ç†æµç¨‹" class="headerlink" title="3.1 æŸ¥è¯¢å¤„ç†æµç¨‹"></a>3.1 æŸ¥è¯¢å¤„ç†æµç¨‹</h3><p>PostgreSQL çš„æŸ¥è¯¢å¤„ç†æµç¨‹æ˜¯ä¸€ä¸ªå¤æ‚çš„å¤šé˜¶æ®µè¿‡ç¨‹ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰ç‰¹å®šçš„åŠŸèƒ½å’Œä¼˜åŒ–æœºä¼šã€‚</p><h4 id="3-1-1-è§£æé˜¶æ®µ"><a href="#3-1-1-è§£æé˜¶æ®µ" class="headerlink" title="3.1.1 è§£æé˜¶æ®µ"></a>3.1.1 è§£æé˜¶æ®µ</h4><p>æŸ¥è¯¢é¦–å…ˆç»è¿‡è§£æå™¨ï¼ˆParserï¼‰ï¼Œå°† SQL æ–‡æœ¬è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚ è§£æå™¨è´Ÿè´£ï¼š</p><ul><li>è¯æ³•åˆ†æï¼šå°† SQL æ–‡æœ¬åˆ†è§£ä¸º tokens</li><li>è¯­æ³•åˆ†æï¼šéªŒè¯ SQL è¯­æ³•çš„æ­£ç¡®æ€§</li><li>è¯­ä¹‰åˆ†æï¼šæ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨ã€æƒé™æ˜¯å¦è¶³å¤Ÿç­‰</li></ul><p>è§£æé˜¶æ®µæ˜¯æŸ¥è¯¢å¤„ç†çš„åŸºç¡€ï¼Œä»»ä½•è¯­æ³•é”™è¯¯æˆ–è¯­ä¹‰é”™è¯¯éƒ½ä¼šåœ¨è¿™ä¸ªé˜¶æ®µè¢«æ•è·ã€‚</p><h4 id="3-1-2-é‡å†™é˜¶æ®µ"><a href="#3-1-2-é‡å†™é˜¶æ®µ" class="headerlink" title="3.1.2 é‡å†™é˜¶æ®µ"></a>3.1.2 é‡å†™é˜¶æ®µ</h4><p>é‡å†™å™¨ï¼ˆRewriterï¼‰è´Ÿè´£åº”ç”¨è§„åˆ™ç³»ç»Ÿï¼Œå°†æŸ¥è¯¢è½¬æ¢ä¸ºç­‰ä»·ä½†å¯èƒ½æ›´é«˜æ•ˆçš„æŸ¥è¯¢ã€‚ é‡å†™é˜¶æ®µçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š</p><ul><li>è§†å›¾å±•å¼€ï¼šå°†è§†å›¾å¼•ç”¨æ›¿æ¢ä¸ºè§†å›¾å®šä¹‰</li><li>è§„åˆ™åº”ç”¨ï¼šåº”ç”¨ç”¨æˆ·å®šä¹‰çš„é‡å†™è§„åˆ™</li><li>æŸ¥è¯¢ç®€åŒ–ï¼šç®€åŒ–å¤æ‚çš„æŸ¥è¯¢è¡¨è¾¾å¼</li></ul><p>é‡å†™é˜¶æ®µçš„è®¾è®¡ä½“ç°äº† PostgreSQL å¯¹çµæ´»æ€§å’Œæ‰©å±•æ€§çš„é‡è§†ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡è§„åˆ™ç³»ç»Ÿå®šåˆ¶æŸ¥è¯¢è¡Œä¸ºã€‚</p><h4 id="3-1-3-è§„åˆ’-x2F-ä¼˜åŒ–é˜¶æ®µ"><a href="#3-1-3-è§„åˆ’-x2F-ä¼˜åŒ–é˜¶æ®µ" class="headerlink" title="3.1.3 è§„åˆ’&#x2F;ä¼˜åŒ–é˜¶æ®µ"></a>3.1.3 è§„åˆ’&#x2F;ä¼˜åŒ–é˜¶æ®µ</h4><p>æŸ¥è¯¢ä¼˜åŒ–å™¨æ˜¯ PostgreSQL æœ€å¤æ‚çš„ç»„ä»¶ä¹‹ä¸€ï¼Œå®ƒè´Ÿè´£ç”Ÿæˆæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚ ä¼˜åŒ–å™¨çš„å·¥ä½œæµç¨‹åŒ…æ‹¬ï¼š</p><ol><li><strong>ç”Ÿæˆå€™é€‰è®¡åˆ’</strong>ï¼šæ ¹æ®æŸ¥è¯¢ç»“æ„å’Œå¯ç”¨ç´¢å¼•ï¼Œç”Ÿæˆå¤šä¸ªå¯èƒ½çš„æ‰§è¡Œè®¡åˆ’</li><li><strong>æˆæœ¬ä¼°ç®—</strong>ï¼šä¸ºæ¯ä¸ªå€™é€‰è®¡åˆ’ä¼°ç®—æ‰§è¡Œæˆæœ¬</li><li><strong>é€‰æ‹©æœ€ä¼˜è®¡åˆ’</strong>ï¼šé€‰æ‹©æˆæœ¬æœ€ä½çš„æ‰§è¡Œè®¡åˆ’</li></ol><p>ä¼˜åŒ–å™¨ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯æ¥ä¼°ç®—æŸ¥è¯¢æˆæœ¬ï¼ŒåŒ…æ‹¬è¡¨å¤§å°ã€åˆ—åˆ†å¸ƒã€ç´¢å¼•é€‰æ‹©æ€§ç­‰ã€‚ ç»Ÿè®¡ä¿¡æ¯çš„å‡†ç¡®æ€§ç›´æ¥å½±å“ä¼˜åŒ–å™¨çš„å†³ç­–è´¨é‡ã€‚</p><h4 id="3-1-4-æ‰§è¡Œé˜¶æ®µ"><a href="#3-1-4-æ‰§è¡Œé˜¶æ®µ" class="headerlink" title="3.1.4 æ‰§è¡Œé˜¶æ®µ"></a>3.1.4 æ‰§è¡Œé˜¶æ®µ</h4><p>æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰è´Ÿè´£æ‰§è¡Œä¼˜åŒ–å™¨ç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’ã€‚ æ‰§è¡Œå™¨é‡‡ç”¨ç«å±±æ¨¡å‹ï¼ˆVolcano Modelï¼‰ï¼Œé€šè¿‡è¿­ä»£å™¨æ¨¡å¼é€è¡Œå¤„ç†æ•°æ®ã€‚ æ‰§è¡Œå™¨çš„ä¸»è¦ç»„ä»¶åŒ…æ‹¬ï¼š</p><ul><li><strong>æ‰«æèŠ‚ç‚¹</strong>ï¼šä»è¡¨æˆ–ç´¢å¼•ä¸­è¯»å–æ•°æ®</li><li><strong>è¿æ¥èŠ‚ç‚¹</strong>ï¼šæ‰§è¡Œè¡¨è¿æ¥æ“ä½œ</li><li><strong>èšåˆèŠ‚ç‚¹</strong>ï¼šæ‰§è¡Œèšåˆå‡½æ•°</li><li><strong>æ’åºèŠ‚ç‚¹</strong>ï¼šæ‰§è¡Œæ’åºæ“ä½œ</li></ul><p>æ‰§è¡Œå™¨çš„è®¾è®¡è€ƒè™‘äº†å†…å­˜ç®¡ç†å’Œ I&#x2F;O ä¼˜åŒ–ï¼Œèƒ½å¤Ÿåœ¨æœ‰é™çš„èµ„æºä¸‹é«˜æ•ˆå¤„ç†å¤§è§„æ¨¡æ•°æ®ã€‚</p><h3 id="3-2-ä¼˜åŒ–å™¨å†…éƒ¨æœºåˆ¶"><a href="#3-2-ä¼˜åŒ–å™¨å†…éƒ¨æœºåˆ¶" class="headerlink" title="3.2 ä¼˜åŒ–å™¨å†…éƒ¨æœºåˆ¶"></a>3.2 ä¼˜åŒ–å™¨å†…éƒ¨æœºåˆ¶</h3><p>PostgreSQL çš„ä¼˜åŒ–å™¨æ˜¯å…¶æ€§èƒ½ä¼˜åŠ¿çš„æ ¸å¿ƒï¼Œç†è§£å…¶å†…éƒ¨æœºåˆ¶å¯¹äºæŸ¥è¯¢ä¼˜åŒ–è‡³å…³é‡è¦ã€‚</p><h4 id="3-2-1-æˆæœ¬æ¨¡å‹"><a href="#3-2-1-æˆæœ¬æ¨¡å‹" class="headerlink" title="3.2.1 æˆæœ¬æ¨¡å‹"></a>3.2.1 æˆæœ¬æ¨¡å‹</h4><p>ä¼˜åŒ–å™¨ä½¿ç”¨æˆæœ¬æ¨¡å‹æ¥è¯„ä¼°ä¸åŒæ‰§è¡Œè®¡åˆ’çš„æ•ˆç‡ã€‚ æˆæœ¬æ¨¡å‹è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š</p><ul><li><strong>I&#x2F;O æˆæœ¬</strong>ï¼šè¯»å–æ•°æ®é¡µçš„ç£ç›˜ I&#x2F;O å¼€é”€</li><li><strong>CPU æˆæœ¬</strong>ï¼šå¤„ç†æ•°æ®çš„ CPU å¼€é”€</li><li><strong>å†…å­˜æˆæœ¬</strong>ï¼šä½¿ç”¨å†…å­˜çš„å¼€é”€</li><li><strong>ç½‘ç»œæˆæœ¬</strong>ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œç½‘ç»œä¼ è¾“çš„å¼€é”€</li></ul><p>æˆæœ¬æ¨¡å‹çš„å‚æ•°å¯ä»¥é€šè¿‡é…ç½®å‚æ•°è¿›è¡Œè°ƒæ•´ï¼Œä»¥é€‚åº”ä¸åŒçš„ç¡¬ä»¶ç¯å¢ƒå’Œå·¥ä½œè´Ÿè½½ã€‚</p><h4 id="3-2-2-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†"><a href="#3-2-2-ç»Ÿè®¡ä¿¡æ¯ç®¡ç†" class="headerlink" title="3.2.2 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†"></a>3.2.2 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†</h4><p>ä¼˜åŒ–å™¨ä¾èµ–ç»Ÿè®¡ä¿¡æ¯æ¥åšå‡ºå‡†ç¡®çš„å†³ç­–ã€‚ ç»Ÿè®¡ä¿¡æ¯åŒ…æ‹¬ï¼š</p><ul><li><strong>è¡¨ç»Ÿè®¡</strong>ï¼šè¡Œæ•°ã€é¡µæ•°ã€å¹³å‡è¡Œå¤§å°ç­‰</li><li><strong>åˆ—ç»Ÿè®¡</strong>ï¼šå”¯ä¸€å€¼æ•°é‡ã€æœ€å¸¸è§å€¼ã€ç›´æ–¹å›¾ç­‰</li><li><strong>ç´¢å¼•ç»Ÿè®¡</strong>ï¼šç´¢å¼•å¤§å°ã€é€‰æ‹©æ€§ç­‰</li></ul><p>ç»Ÿè®¡ä¿¡æ¯é€šè¿‡ ANALYZE å‘½ä»¤æ”¶é›†ï¼Œå¯ä»¥æ‰‹åŠ¨è§¦å‘æˆ–è‡ªåŠ¨æ”¶é›†ã€‚ ç»Ÿè®¡ä¿¡æ¯çš„å‡†ç¡®æ€§å’Œæ—¶æ•ˆæ€§å¯¹ä¼˜åŒ–å™¨æ€§èƒ½æœ‰é‡å¤§å½±å“ã€‚</p><h4 id="3-2-3-æ‰§è¡Œè®¡åˆ’ç¼“å­˜"><a href="#3-2-3-æ‰§è¡Œè®¡åˆ’ç¼“å­˜" class="headerlink" title="3.2.3 æ‰§è¡Œè®¡åˆ’ç¼“å­˜"></a>3.2.3 æ‰§è¡Œè®¡åˆ’ç¼“å­˜</h4><p>ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒPostgreSQL ä¼šç¼“å­˜å¸¸ç”¨çš„æ‰§è¡Œè®¡åˆ’ã€‚ æ‰§è¡Œè®¡åˆ’ç¼“å­˜çš„æœºåˆ¶åŒ…æ‹¬ï¼š</p><ul><li><strong>å‡†å¤‡è¯­å¥</strong>ï¼šé€šè¿‡ PREPARE è¯­å¥æ˜¾å¼ç¼“å­˜æ‰§è¡Œè®¡åˆ’</li><li><strong>é€šç”¨è®¡åˆ’ç¼“å­˜</strong>ï¼šè‡ªåŠ¨ç¼“å­˜å‚æ•°åŒ–æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’</li><li><strong>å…±äº«è®¡åˆ’ç¼“å­˜</strong>ï¼šåœ¨å…±äº«å†…å­˜ä¸­ç¼“å­˜æ‰§è¡Œè®¡åˆ’ï¼Œä¾›å¤šä¸ªä¼šè¯ä½¿ç”¨</li></ul><p>æ‰§è¡Œè®¡åˆ’ç¼“å­˜å¯ä»¥æ˜¾è‘—å‡å°‘æŸ¥è¯¢ä¼˜åŒ–çš„å¼€é”€ï¼Œç‰¹åˆ«æ˜¯å¯¹äºé¢‘ç¹æ‰§è¡Œçš„æŸ¥è¯¢ã€‚</p><h3 id="3-3-æ‰§è¡Œå¼•æ“ç‰¹æ€§"><a href="#3-3-æ‰§è¡Œå¼•æ“ç‰¹æ€§" class="headerlink" title="3.3 æ‰§è¡Œå¼•æ“ç‰¹æ€§"></a>3.3 æ‰§è¡Œå¼•æ“ç‰¹æ€§</h3><p>æ‰§è¡Œå¼•æ“æ˜¯ PostgreSQL æŸ¥è¯¢å¤„ç†çš„å…³é”®ç»„ä»¶ï¼Œå…¶å®ç°ç»†èŠ‚ç›´æ¥å½±å“æŸ¥è¯¢æ€§èƒ½ã€‚</p><h4 id="3-3-1-å†…å­˜ç®¡ç†"><a href="#3-3-1-å†…å­˜ç®¡ç†" class="headerlink" title="3.3.1 å†…å­˜ç®¡ç†"></a>3.3.1 å†…å­˜ç®¡ç†</h4><p>æ‰§è¡Œå¼•æ“ä½¿ç”¨å¤šç§å†…å­˜ç®¡ç†ç­–ç•¥æ¥ä¼˜åŒ–æ€§èƒ½ï¼š</p><ul><li><strong>å·¥ä½œå†…å­˜</strong>ï¼šç”¨äºæ’åºã€å“ˆå¸Œè¿æ¥ç­‰æ“ä½œ</li><li><strong>ç»´æŠ¤å·¥ä½œå†…å­˜</strong>ï¼šç”¨äºç»´æŠ¤æ“ä½œï¼Œå¦‚ VACUUMã€CREATE INDEX ç­‰</li><li><strong>å…±äº«ç¼“å†²åŒº</strong>ï¼šç¼“å­˜æ•°æ®é¡µï¼Œå‡å°‘ç£ç›˜ I&#x2F;O</li></ul><p>å†…å­˜ç®¡ç†çš„ç­–ç•¥å¯ä»¥é€šè¿‡é…ç½®å‚æ•°è¿›è¡Œè°ƒæ•´ï¼Œå¦‚ work_memã€maintenance_work_memã€shared_buffers ç­‰ã€‚ åˆç†çš„å†…å­˜é…ç½®å¯ä»¥æ˜¾è‘—æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚</p><h4 id="3-3-2-å¹¶è¡ŒæŸ¥è¯¢"><a href="#3-3-2-å¹¶è¡ŒæŸ¥è¯¢" class="headerlink" title="3.3.2 å¹¶è¡ŒæŸ¥è¯¢"></a>3.3.2 å¹¶è¡ŒæŸ¥è¯¢</h4><p>PostgreSQL æ”¯æŒå¹¶è¡ŒæŸ¥è¯¢æ‰§è¡Œï¼Œå¯ä»¥åˆ©ç”¨å¤šæ ¸ CPU çš„ä¼˜åŠ¿åŠ é€ŸæŸ¥è¯¢å¤„ç†ã€‚ å¹¶è¡ŒæŸ¥è¯¢çš„ä¸»è¦ç±»å‹åŒ…æ‹¬ï¼š</p><ul><li><strong>å¹¶è¡Œé¡ºåºæ‰«æ</strong>ï¼šå¤šä¸ª worker è¿›ç¨‹å¹¶è¡Œæ‰«æè¡¨</li><li><strong>å¹¶è¡Œç´¢å¼•æ‰«æ</strong>ï¼šå¤šä¸ª worker è¿›ç¨‹å¹¶è¡Œä½¿ç”¨ç´¢å¼•</li><li><strong>å¹¶è¡Œè¿æ¥</strong>ï¼šå¤šä¸ª worker è¿›ç¨‹å¹¶è¡Œæ‰§è¡Œè¿æ¥æ“ä½œ</li><li><strong>å¹¶è¡Œèšåˆ</strong>ï¼šå¤šä¸ª worker è¿›ç¨‹å¹¶è¡Œæ‰§è¡Œèšåˆæ“ä½œ</li></ul><p>å¹¶è¡ŒæŸ¥è¯¢çš„é…ç½®éœ€è¦è€ƒè™‘ CPU æ ¸å¿ƒæ•°ã€I&#x2F;O å¸¦å®½ã€å†…å­˜å®¹é‡ç­‰å› ç´ ï¼Œé¿å…èµ„æºäº‰ç”¨ã€‚</p><h4 id="3-3-3-å‘é‡åŒ–æ‰§è¡Œ"><a href="#3-3-3-å‘é‡åŒ–æ‰§è¡Œ" class="headerlink" title="3.3.3 å‘é‡åŒ–æ‰§è¡Œ"></a>3.3.3 å‘é‡åŒ–æ‰§è¡Œ</h4><p>è™½ç„¶ PostgreSQL ä¼ ç»Ÿä¸Šä½¿ç”¨è¡Œå¼å¤„ç†æ¨¡å‹ï¼Œä½†æ–°ç‰ˆæœ¬å¼€å§‹å¼•å…¥å‘é‡åŒ–æ‰§è¡Œä¼˜åŒ–ã€‚ å‘é‡åŒ–æ‰§è¡Œé€šè¿‡æ‰¹é‡å¤„ç†æ•°æ®ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€ï¼Œæé«˜ CPU ç¼“å­˜åˆ©ç”¨ç‡ã€‚å‘é‡åŒ–æ‰§è¡Œç‰¹åˆ«é€‚åˆ OLAP å·¥ä½œè´Ÿè½½ï¼Œå¯ä»¥æ˜¾è‘—æé«˜åˆ†ææŸ¥è¯¢çš„æ€§èƒ½ã€‚</p><h2 id="å››ã€æ€§èƒ½ç‰¹æ€§åˆ†æ"><a href="#å››ã€æ€§èƒ½ç‰¹æ€§åˆ†æ" class="headerlink" title="å››ã€æ€§èƒ½ç‰¹æ€§åˆ†æ"></a>å››ã€æ€§èƒ½ç‰¹æ€§åˆ†æ</h2><h3 id="4-1-æ€§èƒ½ä¼˜åŠ¿"><a href="#4-1-æ€§èƒ½ä¼˜åŠ¿" class="headerlink" title="4.1 æ€§èƒ½ä¼˜åŠ¿"></a>4.1 æ€§èƒ½ä¼˜åŠ¿</h3><p>PostgreSQL å‡­å€Ÿå…¶ç²¾å¿ƒè®¾è®¡çš„æ¶æ„å’Œå®ç°ï¼Œåœ¨å¤šä¸ªæ–¹é¢å±•ç°å‡ºå“è¶Šçš„æ€§èƒ½ä¼˜åŠ¿ã€‚</p><h4 id="4-1-1-é«˜å¹¶å‘å¤„ç†èƒ½åŠ›"><a href="#4-1-1-é«˜å¹¶å‘å¤„ç†èƒ½åŠ›" class="headerlink" title="4.1.1 é«˜å¹¶å‘å¤„ç†èƒ½åŠ›"></a>4.1.1 é«˜å¹¶å‘å¤„ç†èƒ½åŠ›</h4><p>MVCC æ¶æ„ä½¿å¾— PostgreSQL èƒ½å¤Ÿå¤„ç†é«˜åº¦å¹¶å‘çš„å·¥ä½œè´Ÿè½½ã€‚ è¯»æ“ä½œä¸ä¼šé˜»å¡å†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸ä¼šé˜»å¡è¯»æ“ä½œï¼Œè¿™ä½¿å¾— PostgreSQL åœ¨ OLTP åœºæ™¯ä¸­è¡¨ç°å‡ºè‰²ã€‚ç‰¹åˆ«æ˜¯åœ¨è¯»å¯†é›†å‹åº”ç”¨ä¸­ï¼ŒPostgreSQL å¯ä»¥è½»æ¾æ”¯æŒæ•°åƒä¸ªå¹¶å‘è¿æ¥ã€‚</p><h4 id="4-1-2-å¤æ‚æŸ¥è¯¢ä¼˜åŒ–"><a href="#4-1-2-å¤æ‚æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="4.1.2 å¤æ‚æŸ¥è¯¢ä¼˜åŒ–"></a>4.1.2 å¤æ‚æŸ¥è¯¢ä¼˜åŒ–</h4><p>PostgreSQL çš„ä¼˜åŒ–å™¨èƒ½å¤Ÿå¤„ç†éå¸¸å¤æ‚çš„æŸ¥è¯¢ï¼ŒåŒ…æ‹¬å¤šè¡¨è¿æ¥ã€å­æŸ¥è¯¢ã€çª—å£å‡½æ•°ç­‰ã€‚ ä¼˜åŒ–å™¨çš„æˆæœ¬æ¨¡å‹å’Œç»Ÿè®¡ä¿¡æ¯æœºåˆ¶ä½¿å…¶èƒ½å¤Ÿä¸ºå¤æ‚æŸ¥è¯¢ç”Ÿæˆé«˜æ•ˆçš„æ‰§è¡Œè®¡åˆ’ã€‚åœ¨ OLAP åœºæ™¯ä¸­ï¼ŒPostgreSQL å¯ä»¥å¤„ç† TB çº§åˆ«çš„æ•°æ®åˆ†æä»»åŠ¡ã€‚</p><h4 id="4-1-3-æ‰©å±•æ€§å’Œçµæ´»æ€§"><a href="#4-1-3-æ‰©å±•æ€§å’Œçµæ´»æ€§" class="headerlink" title="4.1.3 æ‰©å±•æ€§å’Œçµæ´»æ€§"></a>4.1.3 æ‰©å±•æ€§å’Œçµæ´»æ€§</h4><p>PostgreSQL çš„æ‰©å±•æ¶æ„ä½¿å…¶èƒ½å¤Ÿé€‚åº”å„ç§å·¥ä½œè´Ÿè½½å’Œåº”ç”¨åœºæ™¯ã€‚ é€šè¿‡æ‰©å±•ï¼Œå¯ä»¥æ·»åŠ æ–°çš„æ•°æ®ç±»å‹ã€å‡½æ•°ã€ç´¢å¼•ç±»å‹ç­‰ï¼Œæ»¡è¶³ç‰¹å®šä¸šåŠ¡éœ€æ±‚ã€‚  PostgreSQL æ”¯æŒ JSONBã€å…¨æ–‡æœç´¢ã€åœ°ç†ç©ºé—´æ•°æ®ç­‰é«˜çº§åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½åœ¨åŸç”Ÿå®ç°ä¸­å°±å…·æœ‰ä¼˜ç§€çš„æ€§èƒ½ã€‚</p><h4 id="4-1-4-å¯é æ€§å’Œæ•°æ®å®Œæ•´æ€§"><a href="#4-1-4-å¯é æ€§å’Œæ•°æ®å®Œæ•´æ€§" class="headerlink" title="4.1.4 å¯é æ€§å’Œæ•°æ®å®Œæ•´æ€§"></a>4.1.4 å¯é æ€§å’Œæ•°æ®å®Œæ•´æ€§</h4><p>WAL æœºåˆ¶å’Œ MVCC æ¶æ„ç¡®ä¿äº† PostgreSQL çš„æ•°æ®å¯é æ€§å’Œå®Œæ•´æ€§ã€‚ å³ä½¿åœ¨ç³»ç»Ÿå´©æºƒçš„æƒ…å†µä¸‹ï¼ŒPostgreSQL ä¹Ÿèƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ¢å¤åˆ°ä¸€è‡´çŠ¶æ€ã€‚ACID ç‰¹æ€§çš„ä¸¥æ ¼å®ç°ä½¿å¾— PostgreSQL æˆä¸ºé‡‘èã€åŒ»ç–—ç­‰å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„è¡Œä¸šçš„é¦–é€‰ã€‚</p><h3 id="4-2-æ€§èƒ½æŒ‘æˆ˜ä¸é™åˆ¶"><a href="#4-2-æ€§èƒ½æŒ‘æˆ˜ä¸é™åˆ¶" class="headerlink" title="4.2 æ€§èƒ½æŒ‘æˆ˜ä¸é™åˆ¶"></a>4.2 æ€§èƒ½æŒ‘æˆ˜ä¸é™åˆ¶</h3><p>å°½ç®¡ PostgreSQL å…·æœ‰ä¼—å¤šä¼˜åŠ¿ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹ä¹Ÿé¢ä¸´æ€§èƒ½æŒ‘æˆ˜ã€‚</p><h4 id="4-2-1-å†™æ”¾å¤§é—®é¢˜"><a href="#4-2-1-å†™æ”¾å¤§é—®é¢˜" class="headerlink" title="4.2.1 å†™æ”¾å¤§é—®é¢˜"></a>4.2.1 å†™æ”¾å¤§é—®é¢˜</h4><p>MVCC æ¶æ„å¸¦æ¥çš„ä¸€ä¸ªä¸»è¦æŒ‘æˆ˜æ˜¯å†™æ”¾å¤§ã€‚ æ¯æ¬¡æ›´æ–°æ“ä½œéƒ½ä¼šåˆ›å»ºæ–°ç‰ˆæœ¬çš„æ•°æ®è¡Œï¼Œæ—§ç‰ˆæœ¬çš„æ•°æ®è¡Œéœ€è¦é€šè¿‡ VACUUM è¿‡ç¨‹æ¸…ç†ã€‚è¿™å¯¼è‡´äº†é¢å¤–çš„ I&#x2F;O å¼€é”€å’Œå­˜å‚¨ç©ºé—´éœ€æ±‚ã€‚åœ¨é«˜å†™å…¥è´Ÿè½½çš„åœºæ™¯ä¸­ï¼Œå†™æ”¾å¤§é—®é¢˜å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚</p><h4 id="4-2-2-é”ç«äº‰"><a href="#4-2-2-é”ç«äº‰" class="headerlink" title="4.2.2 é”ç«äº‰"></a>4.2.2 é”ç«äº‰</h4><p>è™½ç„¶ MVCC å‡å°‘äº†è¯»å†™å†²çªï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹ä»ç„¶å­˜åœ¨é”ç«äº‰é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œå½“å¤šä¸ªäº‹åŠ¡åŒæ—¶æ›´æ–°åŒä¸€è¡Œæ•°æ®æ—¶ï¼Œä¼šå‘ç”Ÿé”ç­‰å¾…ã€‚åœ¨é«˜å¹¶å‘å†™å…¥åœºæ™¯ä¸­ï¼Œé”ç«äº‰å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p><h4 id="4-2-3-å†…å­˜ç®¡ç†å¤æ‚æ€§"><a href="#4-2-3-å†…å­˜ç®¡ç†å¤æ‚æ€§" class="headerlink" title="4.2.3 å†…å­˜ç®¡ç†å¤æ‚æ€§"></a>4.2.3 å†…å­˜ç®¡ç†å¤æ‚æ€§</h4><p>PostgreSQL çš„å†…å­˜ç®¡ç†ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®å¤šä¸ªå†…å­˜å‚æ•°ã€‚ ä¸åˆç†çš„å†…å­˜é…ç½®å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œç”šè‡³ç³»ç»Ÿå´©æºƒã€‚ä¾‹å¦‚ï¼Œshared_buffers è®¾ç½®è¿‡å¤§å¯èƒ½å½±å“æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œwork_mem è®¾ç½®è¿‡å°å¯èƒ½å¯¼è‡´ç£ç›˜æ’åºã€‚</p><h4 id="4-2-4-æ°´å¹³æ‰©å±•é™åˆ¶"><a href="#4-2-4-æ°´å¹³æ‰©å±•é™åˆ¶" class="headerlink" title="4.2.4 æ°´å¹³æ‰©å±•é™åˆ¶"></a>4.2.4 æ°´å¹³æ‰©å±•é™åˆ¶</h4><p>ä¸ä¸€äº›åˆ†å¸ƒå¼æ•°æ®åº“ç›¸æ¯”ï¼ŒPostgreSQL åœ¨æ°´å¹³æ‰©å±•æ–¹é¢å­˜åœ¨ä¸€å®šé™åˆ¶ã€‚ è™½ç„¶å¯ä»¥é€šè¿‡åˆ†ç‰‡ã€è¯»å†™åˆ†ç¦»ç­‰æŠ€æœ¯å®ç°æ°´å¹³æ‰©å±•ï¼Œä½†è¿™äº›æ–¹æ¡ˆé€šå¸¸éœ€è¦åº”ç”¨å±‚é…åˆï¼Œå¢åŠ äº†ç³»ç»Ÿå¤æ‚æ€§ã€‚åœ¨è¶…å¤§è§„æ¨¡æ•°æ®åœºæ™¯ä¸­ï¼ŒPostgreSQL å¯èƒ½ä¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚</p><h3 id="4-3-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#4-3-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="4.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>4.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3><p>é’ˆå¯¹ PostgreSQL çš„æ€§èƒ½ç‰¹ç‚¹ï¼Œå¯ä»¥é‡‡ç”¨å¤šç§ä¼˜åŒ–ç­–ç•¥æ¥æå‡ç³»ç»Ÿæ€§èƒ½ã€‚</p><h4 id="4-3-1-ç´¢å¼•ä¼˜åŒ–"><a href="#4-3-1-ç´¢å¼•ä¼˜åŒ–" class="headerlink" title="4.3.1 ç´¢å¼•ä¼˜åŒ–"></a>4.3.1 ç´¢å¼•ä¼˜åŒ–</h4><p>ç´¢å¼•æ˜¯æå‡æŸ¥è¯¢æ€§èƒ½æœ€æœ‰æ•ˆçš„æ‰‹æ®µä¹‹ä¸€ã€‚ ä¼˜åŒ–ç´¢å¼•ç­–ç•¥åŒ…æ‹¬ï¼š</p><ul><li><strong>é€‰æ‹©åˆé€‚çš„ç´¢å¼•ç±»å‹</strong>ï¼šæ ¹æ®æŸ¥è¯¢æ¨¡å¼é€‰æ‹© B-treeã€Hashã€GiST ç­‰ç´¢å¼•</li><li><strong>å¤åˆç´¢å¼•è®¾è®¡</strong>ï¼šå°†ç»å¸¸ä¸€èµ·ä½¿ç”¨çš„åˆ—ç»„åˆåœ¨å¤åˆç´¢å¼•ä¸­</li><li><strong>è¦†ç›–ç´¢å¼•</strong>ï¼šåŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—ï¼Œé¿å…å›è¡¨æ“ä½œ</li><li><strong>éƒ¨åˆ†ç´¢å¼•</strong>ï¼šåªä¸ºæ»¡è¶³ç‰¹å®šæ¡ä»¶çš„æ•°æ®åˆ›å»ºç´¢å¼•ï¼ŒèŠ‚çœç©ºé—´</li></ul><h4 id="4-3-2-æŸ¥è¯¢é‡å†™"><a href="#4-3-2-æŸ¥è¯¢é‡å†™" class="headerlink" title="4.3.2 æŸ¥è¯¢é‡å†™"></a>4.3.2 æŸ¥è¯¢é‡å†™</h4><p>é€šè¿‡é‡å†™æŸ¥è¯¢è¯­å¥ï¼Œå¯ä»¥å¼•å¯¼ä¼˜åŒ–å™¨é€‰æ‹©æ›´å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚ å¸¸ç”¨çš„æŸ¥è¯¢é‡å†™æŠ€å·§åŒ…æ‹¬ï¼š</p><ul><li>**é¿å… SELECT ***ï¼šåªé€‰æ‹©éœ€è¦çš„åˆ—ï¼Œå‡å°‘æ•°æ®ä¼ è¾“é‡</li><li><strong>ä½¿ç”¨ JOIN ä»£æ›¿å­æŸ¥è¯¢</strong>ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒJOIN æ¯”å­æŸ¥è¯¢æ›´é«˜æ•ˆ</li><li><strong>å‚æ•°åŒ–æŸ¥è¯¢</strong>ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æé«˜æ‰§è¡Œè®¡åˆ’ç¼“å­˜å‘½ä¸­ç‡</li><li><strong>CTE ä¼˜åŒ–</strong>ï¼šåˆç†ä½¿ç”¨ Common Table Expressions ä¼˜åŒ–å¤æ‚æŸ¥è¯¢</li></ul><h4 id="4-3-3-é…ç½®è°ƒä¼˜"><a href="#4-3-3-é…ç½®è°ƒä¼˜" class="headerlink" title="4.3.3 é…ç½®è°ƒä¼˜"></a>4.3.3 é…ç½®è°ƒä¼˜</h4><p>åˆç†çš„é…ç½®å‚æ•°è®¾ç½®å¯¹ PostgreSQL æ€§èƒ½è‡³å…³é‡è¦ã€‚ å…³é”®çš„é…ç½®å‚æ•°åŒ…æ‹¬ï¼š</p><ul><li><strong>shared_buffers</strong>ï¼šé€šå¸¸è®¾ç½®ä¸ºç³»ç»Ÿå†…å­˜çš„ 25%</li><li><strong>work_mem</strong>ï¼šæ ¹æ®å¹¶å‘æŸ¥è¯¢æ•°é‡å’Œå¤æ‚åº¦è®¾ç½®</li><li><strong>effective_cache_size</strong>ï¼šåæ˜ æ“ä½œç³»ç»Ÿç¼“å­˜å¤§å°</li><li><strong>maintenance_work_mem</strong>ï¼šå½±å“ VACUUMã€CREATE INDEX ç­‰æ“ä½œçš„æ€§èƒ½</li><li><strong>max_connections</strong>ï¼šæ ¹æ®åº”ç”¨éœ€æ±‚è®¾ç½®æœ€å¤§è¿æ¥æ•°</li></ul><h4 id="4-3-4-ç¡¬ä»¶ä¼˜åŒ–"><a href="#4-3-4-ç¡¬ä»¶ä¼˜åŒ–" class="headerlink" title="4.3.4 ç¡¬ä»¶ä¼˜åŒ–"></a>4.3.4 ç¡¬ä»¶ä¼˜åŒ–</h4><p>ç¡¬ä»¶é…ç½®å¯¹ PostgreSQL æ€§èƒ½æœ‰ç›´æ¥å½±å“ã€‚ ä¼˜åŒ–ç¡¬ä»¶é…ç½®åŒ…æ‹¬ï¼š</p><ul><li><strong>SSD å­˜å‚¨</strong>ï¼šä½¿ç”¨ SSD æ›¿ä»£ HDDï¼Œæ˜¾è‘—æé«˜ I&#x2F;O æ€§èƒ½</li><li><strong>è¶³å¤Ÿå†…å­˜</strong>ï¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„å†…å­˜ç”¨äºç¼“å­˜æ•°æ®</li><li><strong>å¤šæ ¸ CPU</strong>ï¼šåˆ©ç”¨å¹¶è¡ŒæŸ¥è¯¢ä¼˜åŠ¿</li><li><strong>é«˜é€Ÿç½‘ç»œ</strong>ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œé«˜é€Ÿç½‘ç»œå‡å°‘é€šä¿¡å»¶è¿Ÿ</li></ul><h2 id="äº”ã€é«˜çº§ç‰¹æ€§ä¸æœªæ¥å‘å±•æ–¹å‘"><a href="#äº”ã€é«˜çº§ç‰¹æ€§ä¸æœªæ¥å‘å±•æ–¹å‘" class="headerlink" title="äº”ã€é«˜çº§ç‰¹æ€§ä¸æœªæ¥å‘å±•æ–¹å‘"></a>äº”ã€é«˜çº§ç‰¹æ€§ä¸æœªæ¥å‘å±•æ–¹å‘</h2><h3 id="5-1-é«˜çº§ç‰¹æ€§"><a href="#5-1-é«˜çº§ç‰¹æ€§" class="headerlink" title="5.1 é«˜çº§ç‰¹æ€§"></a>5.1 é«˜çº§ç‰¹æ€§</h3><p>PostgreSQL ä¸æ–­å¼•å…¥æ–°ç‰¹æ€§ï¼Œæ‰©å±•å…¶åŠŸèƒ½è¾¹ç•Œå’Œåº”ç”¨åœºæ™¯ã€‚</p><h4 id="5-1-1-JSONB-æ”¯æŒ"><a href="#5-1-1-JSONB-æ”¯æŒ" class="headerlink" title="5.1.1 JSONB æ”¯æŒ"></a>5.1.1 JSONB æ”¯æŒ</h4><p>JSONB æ•°æ®ç±»å‹æä¾›äº†å¯¹ JSON æ–‡æ¡£çš„é«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢èƒ½åŠ›ã€‚ JSONB ä½¿ç”¨äºŒè¿›åˆ¶æ ¼å¼å­˜å‚¨ï¼Œæ”¯æŒç´¢å¼•ã€å…¨æ–‡æœç´¢ç­‰é«˜çº§åŠŸèƒ½ï¼Œä½¿å…¶æˆä¸º NoSQL å’Œå…³ç³»å‹æ•°æ®åº“ç‰¹æ€§çš„å®Œç¾ç»“åˆã€‚åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼ŒJSONB ç‰¹åˆ«é€‚åˆå­˜å‚¨åŠç»“æ„åŒ–æ•°æ®ã€‚</p><h4 id="5-1-2-é€»è¾‘å¤åˆ¶"><a href="#5-1-2-é€»è¾‘å¤åˆ¶" class="headerlink" title="5.1.2 é€»è¾‘å¤åˆ¶"></a>5.1.2 é€»è¾‘å¤åˆ¶</h4><p>é€»è¾‘å¤åˆ¶å…è®¸åŸºäºå‘å¸ƒ&#x2F;è®¢é˜…æ¨¡å‹çš„æ•°æ®å¤åˆ¶ã€‚ ä¸ç‰©ç†å¤åˆ¶ä¸åŒï¼Œé€»è¾‘å¤åˆ¶å¯ä»¥å¤åˆ¶ç‰¹å®šçš„è¡¨æˆ–è¡Œï¼Œæ”¯æŒè·¨ç‰ˆæœ¬å¤åˆ¶å’Œå¼‚æ„ç³»ç»Ÿé›†æˆã€‚é€»è¾‘å¤åˆ¶ä¸ºæ•°æ®åˆ†å‘ã€æ•°æ®ä»“åº“æ„å»ºç­‰åœºæ™¯æä¾›äº†çµæ´»çš„è§£å†³æ–¹æ¡ˆã€‚</p><h4 id="5-1-3-åˆ†åŒºè¡¨"><a href="#5-1-3-åˆ†åŒºè¡¨" class="headerlink" title="5.1.3 åˆ†åŒºè¡¨"></a>5.1.3 åˆ†åŒºè¡¨</h4><p>åˆ†åŒºè¡¨åŠŸèƒ½ä½¿å¾—å¤§è¡¨å¯ä»¥æŒ‰èŒƒå›´ã€åˆ—è¡¨æˆ–å“ˆå¸Œè¿›è¡Œåˆ†åŒºã€‚ åˆ†åŒºè¡¨çš„ä¼˜åŠ¿åŒ…æ‹¬ï¼š</p><ul><li><strong>æŸ¥è¯¢æ€§èƒ½æå‡</strong>ï¼šæŸ¥è¯¢ä¼˜åŒ–å™¨å¯ä»¥åªæ‰«æç›¸å…³åˆ†åŒº</li><li><strong>ç»´æŠ¤æ•ˆç‡æé«˜</strong>ï¼šVACUUMã€ANALYZE ç­‰æ“ä½œå¯ä»¥åœ¨åˆ†åŒºçº§åˆ«æ‰§è¡Œ</li><li><strong>æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼šå¯ä»¥è½»æ¾å½’æ¡£æˆ–åˆ é™¤æ—§åˆ†åŒº</li></ul><h4 id="5-1-4-æ—¶åºæ•°æ®ä¼˜åŒ–"><a href="#5-1-4-æ—¶åºæ•°æ®ä¼˜åŒ–" class="headerlink" title="5.1.4 æ—¶åºæ•°æ®ä¼˜åŒ–"></a>5.1.4 æ—¶åºæ•°æ®ä¼˜åŒ–</h4><p>é€šè¿‡ TimescaleDB ç­‰æ‰©å±•ï¼ŒPostgreSQL åœ¨æ—¶åºæ•°æ®å¤„ç†æ–¹é¢è¡¨ç°å‡ºè‰²ã€‚ æ—¶åºæ•°æ®ä¼˜åŒ–åŒ…æ‹¬è‡ªåŠ¨åˆ†åŒºã€æ•°æ®å‹ç¼©ã€è¿ç»­èšåˆç­‰ç‰¹æ€§ï¼Œä½¿å¾— PostgreSQL æˆä¸ºç‰©è”ç½‘ã€ç›‘æ§ç³»ç»Ÿç­‰æ—¶åºæ•°æ®åº”ç”¨çš„ç†æƒ³é€‰æ‹©ã€‚</p><h3 id="5-2-æœªæ¥å‘å±•æ–¹å‘"><a href="#5-2-æœªæ¥å‘å±•æ–¹å‘" class="headerlink" title="5.2 æœªæ¥å‘å±•æ–¹å‘"></a>5.2 æœªæ¥å‘å±•æ–¹å‘</h3><p>PostgreSQL ç¤¾åŒºæ´»è·ƒï¼Œä¸æ–­æ¨è¿›æŠ€æœ¯åˆ›æ–°å’Œå‘å±•ã€‚</p><h4 id="5-2-1-æ€§èƒ½æŒç»­ä¼˜åŒ–"><a href="#5-2-1-æ€§èƒ½æŒç»­ä¼˜åŒ–" class="headerlink" title="5.2.1 æ€§èƒ½æŒç»­ä¼˜åŒ–"></a>5.2.1 æ€§èƒ½æŒç»­ä¼˜åŒ–</h4><p>æœªæ¥ç‰ˆæœ¬å°†ç»§ç»­ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li><strong>JIT ç¼–è¯‘</strong>ï¼šé€šè¿‡ JIT ç¼–è¯‘æé«˜è¡¨è¾¾å¼è®¡ç®—æ€§èƒ½</li><li><strong>å‘é‡åŒ–æ‰§è¡Œ</strong>ï¼šæ‰©å±•å‘é‡åŒ–æ‰§è¡Œæ”¯æŒï¼Œæé«˜ OLAP æ€§èƒ½</li><li><strong>å¹¶è¡ŒæŸ¥è¯¢å¢å¼º</strong>ï¼šæ”¯æŒæ›´å¤šæ“ä½œç¬¦çš„å¹¶è¡Œæ‰§è¡Œ</li></ul><h4 id="5-2-2-äº‘åŸç”Ÿæ”¯æŒ"><a href="#5-2-2-äº‘åŸç”Ÿæ”¯æŒ" class="headerlink" title="5.2.2 äº‘åŸç”Ÿæ”¯æŒ"></a>5.2.2 äº‘åŸç”Ÿæ”¯æŒ</h4><p>éšç€äº‘è®¡ç®—çš„æ™®åŠï¼ŒPostgreSQL æ­£åœ¨å¢å¼ºäº‘åŸç”Ÿæ”¯æŒï¼š</p><ul><li><strong>è‡ªåŠ¨æ‰©ç¼©å®¹</strong>ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´èµ„æºé…ç½®</li><li><strong>å¤šåŒºåŸŸéƒ¨ç½²</strong>ï¼šæ”¯æŒè·¨åŒºåŸŸçš„é«˜å¯ç”¨éƒ¨ç½²</li><li><strong>Serverless æ¶æ„</strong>ï¼šæ”¯æŒæŒ‰éœ€å¯åŠ¨çš„ Serverless æ¨¡å¼</li></ul><h4 id="5-2-3-AI-x2F-ML-é›†æˆ"><a href="#5-2-3-AI-x2F-ML-é›†æˆ" class="headerlink" title="5.2.3 AI&#x2F;ML é›†æˆ"></a>5.2.3 AI&#x2F;ML é›†æˆ</h4><p>PostgreSQL æ­£åœ¨æ¢ç´¢ä¸ AI&#x2F;ML çš„æ·±åº¦é›†æˆï¼š</p><ul><li><strong>å†…ç½® ML å‡½æ•°</strong>ï¼šæä¾›æœºå™¨å­¦ä¹ ç®—æ³•çš„å†…ç½®æ”¯æŒ</li><li><strong>å‘é‡æœç´¢</strong>ï¼šæ”¯æŒé«˜æ•ˆçš„å‘é‡ç›¸ä¼¼åº¦æœç´¢</li><li><strong>é¢„æµ‹åˆ†æ</strong>ï¼šå†…ç½®æ—¶é—´åºåˆ—é¢„æµ‹åŠŸèƒ½</li></ul><h4 id="5-2-4-å®‰å…¨æ€§å¢å¼º"><a href="#5-2-4-å®‰å…¨æ€§å¢å¼º" class="headerlink" title="5.2.4 å®‰å…¨æ€§å¢å¼º"></a>5.2.4 å®‰å…¨æ€§å¢å¼º</h4><p>å®‰å…¨æ€§æ˜¯ PostgreSQL æŒç»­å…³æ³¨çš„é‡ç‚¹ï¼š</p><ul><li><strong>é€æ˜æ•°æ®åŠ å¯†</strong>ï¼šæ”¯æŒæ•°æ®åœ¨å­˜å‚¨å’Œä¼ è¾“è¿‡ç¨‹ä¸­çš„åŠ å¯†</li><li><strong>ç»†ç²’åº¦è®¿é—®æ§åˆ¶</strong>ï¼šæä¾›æ›´ç²¾ç»†çš„æƒé™ç®¡ç†</li><li><strong>å®¡è®¡åŠŸèƒ½å¢å¼º</strong>ï¼šå®Œå–„å®¡è®¡æ—¥å¿—å’Œç›‘æ§åŠŸèƒ½</li></ul><h2 id="å…­ã€æœ€ä½³å®è·µä¸å»ºè®®"><a href="#å…­ã€æœ€ä½³å®è·µä¸å»ºè®®" class="headerlink" title="å…­ã€æœ€ä½³å®è·µä¸å»ºè®®"></a>å…­ã€æœ€ä½³å®è·µä¸å»ºè®®</h2><h3 id="6-1-è®¾è®¡æœ€ä½³å®è·µ"><a href="#6-1-è®¾è®¡æœ€ä½³å®è·µ" class="headerlink" title="6.1 è®¾è®¡æœ€ä½³å®è·µ"></a>6.1 è®¾è®¡æœ€ä½³å®è·µ</h3><h4 id="6-1-1-æ•°æ®åº“è®¾è®¡"><a href="#6-1-1-æ•°æ®åº“è®¾è®¡" class="headerlink" title="6.1.1 æ•°æ®åº“è®¾è®¡"></a>6.1.1 æ•°æ®åº“è®¾è®¡</h4><ul><li><strong>è§„èŒƒåŒ–è®¾è®¡</strong>ï¼šéµå¾ªç¬¬ä¸‰èŒƒå¼ï¼Œæ¶ˆé™¤æ•°æ®å†—ä½™</li><li><strong>é€‚å½“åè§„èŒƒåŒ–</strong>ï¼šåœ¨æ€§èƒ½å…³é”®è·¯å¾„ä¸Šé€‚å½“åè§„èŒƒåŒ–</li><li><strong>åˆç†åˆ†åŒº</strong>ï¼šå¯¹å¤§è¡¨è¿›è¡Œåˆç†åˆ†åŒºï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½</li><li><strong>ç´¢å¼•ç­–ç•¥</strong>ï¼šæ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡ç´¢å¼•ï¼Œé¿å…è¿‡åº¦ç´¢å¼•</li></ul><h4 id="6-1-2-åº”ç”¨æ¶æ„"><a href="#6-1-2-åº”ç”¨æ¶æ„" class="headerlink" title="6.1.2 åº”ç”¨æ¶æ„"></a>6.1.2 åº”ç”¨æ¶æ„</h4><ul><li><strong>è¿æ¥æ± ä½¿ç”¨</strong>ï¼šä½¿ç”¨ pgBouncer ç­‰è¿æ¥æ± ç®¡ç†è¿æ¥</li><li><strong>è¯»å†™åˆ†ç¦»</strong>ï¼šå°†è¯»æ“ä½œè·¯ç”±åˆ°åªè¯»å‰¯æœ¬ï¼Œå‡è½»ä¸»åº“å‹åŠ›</li><li><strong>ç¼“å­˜ç­–ç•¥</strong>ï¼šåœ¨åº”ç”¨å±‚ä½¿ç”¨ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®</li><li><strong>æ‰¹é‡æ“ä½œ</strong>ï¼šä½¿ç”¨æ‰¹é‡æ’å…¥ã€æ›´æ–°æ“ä½œï¼Œå‡å°‘äº‹åŠ¡å¼€é”€</li></ul><h3 id="6-2-è¿ç»´æœ€ä½³å®è·µ"><a href="#6-2-è¿ç»´æœ€ä½³å®è·µ" class="headerlink" title="6.2 è¿ç»´æœ€ä½³å®è·µ"></a>6.2 è¿ç»´æœ€ä½³å®è·µ</h3><h4 id="6-2-1-ç›‘æ§ä¸å‘Šè­¦"><a href="#6-2-1-ç›‘æ§ä¸å‘Šè­¦" class="headerlink" title="6.2.1 ç›‘æ§ä¸å‘Šè­¦"></a>6.2.1 ç›‘æ§ä¸å‘Šè­¦</h4><ul><li><strong>å…³é”®æŒ‡æ ‡ç›‘æ§</strong>ï¼šCPUã€å†…å­˜ã€I&#x2F;Oã€è¿æ¥æ•°ã€æŸ¥è¯¢å»¶è¿Ÿç­‰</li><li><strong>æ…¢æŸ¥è¯¢ç›‘æ§</strong>ï¼šè¯†åˆ«å’Œä¼˜åŒ–æ…¢æŸ¥è¯¢</li><li><strong>ç©ºé—´ç›‘æ§</strong>ï¼šç›‘æ§è¡¨ç©ºé—´ã€ç´¢å¼•ç©ºé—´ä½¿ç”¨æƒ…å†µ</li><li><strong>è‡ªåŠ¨å‘Šè­¦</strong>ï¼šè®¾ç½®é˜ˆå€¼å‘Šè­¦ï¼ŒåŠæ—¶å‘ç°æ½œåœ¨é—®é¢˜</li></ul><h4 id="6-2-2-å¤‡ä»½ä¸æ¢å¤"><a href="#6-2-2-å¤‡ä»½ä¸æ¢å¤" class="headerlink" title="6.2.2 å¤‡ä»½ä¸æ¢å¤"></a>6.2.2 å¤‡ä»½ä¸æ¢å¤</h4><ul><li><strong>å®šæœŸå…¨é‡å¤‡ä»½</strong>ï¼šä½¿ç”¨ pg_dump æˆ–æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½</li><li><strong>WAL å½’æ¡£</strong>ï¼šå¯ç”¨ WAL å½’æ¡£ï¼Œæ”¯æŒæ—¶é—´ç‚¹æ¢å¤</li><li><strong>å¤‡ä»½éªŒè¯</strong>ï¼šå®šæœŸéªŒè¯å¤‡ä»½çš„å®Œæ•´æ€§å’Œå¯æ¢å¤æ€§</li><li><strong>ç¾éš¾æ¢å¤è®¡åˆ’</strong>ï¼šåˆ¶å®šè¯¦ç»†çš„ç¾éš¾æ¢å¤è®¡åˆ’å’Œæ¼”ç»ƒ</li></ul><h4 id="6-2-3-ç‰ˆæœ¬å‡çº§"><a href="#6-2-3-ç‰ˆæœ¬å‡çº§" class="headerlink" title="6.2.3 ç‰ˆæœ¬å‡çº§"></a>6.2.3 ç‰ˆæœ¬å‡çº§</h4><ul><li><strong>æµ‹è¯•ç¯å¢ƒéªŒè¯</strong>ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯æ–°ç‰ˆæœ¬å…¼å®¹æ€§</li><li><strong>é€æ­¥å‡çº§</strong>ï¼šé‡‡ç”¨æ»šåŠ¨å‡çº§ç­–ç•¥ï¼Œå‡å°‘åœæœºæ—¶é—´</li><li><strong>åŠŸèƒ½è¯„ä¼°</strong>ï¼šè¯„ä¼°æ–°ç‰ˆæœ¬ç‰¹æ€§å¯¹ç°æœ‰åº”ç”¨çš„å½±å“</li><li><strong>å›æ»šè®¡åˆ’</strong>ï¼šå‡†å¤‡è¯¦ç»†çš„å›æ»šè®¡åˆ’ï¼Œåº”å¯¹å‡çº§å¤±è´¥</li></ul><h3 id="6-3-æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹"><a href="#6-3-æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹" class="headerlink" title="6.3 æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹"></a>6.3 æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹</h3><h4 id="6-3-1-ç”µå•†è®¢å•ç³»ç»Ÿä¼˜åŒ–"><a href="#6-3-1-ç”µå•†è®¢å•ç³»ç»Ÿä¼˜åŒ–" class="headerlink" title="6.3.1 ç”µå•†è®¢å•ç³»ç»Ÿä¼˜åŒ–"></a>6.3.1 ç”µå•†è®¢å•ç³»ç»Ÿä¼˜åŒ–</h4><p><strong>é—®é¢˜</strong>ï¼šè®¢å•æŸ¥è¯¢å“åº”æ—¶é—´è¶…è¿‡ 2 ç§’ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ<br><strong>åˆ†æ</strong>ï¼šå‘ç°ç¼ºå°‘åˆé€‚çš„ç´¢å¼•ï¼ŒæŸ¥è¯¢æ¶‰åŠå¤šä¸ªè¡¨è¿æ¥<br><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li>ä¸ºè®¢å•è¡¨åˆ›å»ºå¤åˆç´¢å¼•(order_date, status, user_id)</li><li>é‡å†™æŸ¥è¯¢è¯­å¥ï¼Œä½¿ç”¨ JOIN ä»£æ›¿å­æŸ¥è¯¢</li><li>å¢åŠ  shared_buffers å’Œ work_mem é…ç½®<br><strong>ç»“æœ</strong>ï¼šæŸ¥è¯¢å“åº”æ—¶é—´é™ä½åˆ° 200msï¼Œæ€§èƒ½æå‡ 10 å€</li></ul><h4 id="6-3-2-ç¤¾äº¤åª’ä½“å†…å®¹æ¨èç³»ç»Ÿ"><a href="#6-3-2-ç¤¾äº¤åª’ä½“å†…å®¹æ¨èç³»ç»Ÿ" class="headerlink" title="6.3.2 ç¤¾äº¤åª’ä½“å†…å®¹æ¨èç³»ç»Ÿ"></a>6.3.2 ç¤¾äº¤åª’ä½“å†…å®¹æ¨èç³»ç»Ÿ</h4><p><strong>é—®é¢˜</strong>ï¼šå†…å®¹æ¨èæŸ¥è¯¢åœ¨é«˜å¹¶å‘ä¸‹æ€§èƒ½ä¸‹é™ä¸¥é‡<br><strong>åˆ†æ</strong>ï¼šå‘ç° JSONB å­—æ®µæŸ¥è¯¢æ•ˆç‡ä½ä¸‹ï¼Œç¼ºä¹åˆé€‚çš„ç´¢å¼•<br><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ul><li>ä¸º JSONB å­—æ®µåˆ›å»º GIN ç´¢å¼•</li><li>ä½¿ç”¨ç‰©åŒ–è§†å›¾é¢„è®¡ç®—æ¨èç»“æœ</li><li>å®ç°æŸ¥è¯¢ç»“æœç¼“å­˜</li><li>å¯ç”¨å¹¶è¡ŒæŸ¥è¯¢<br><strong>ç»“æœ</strong>ï¼šç³»ç»Ÿååé‡æå‡ 300%ï¼Œå“åº”æ—¶é—´é™ä½åˆ° 50ms ä»¥å†…</li></ul><h2 id="ä¸ƒã€ç»“è®º"><a href="#ä¸ƒã€ç»“è®º" class="headerlink" title="ä¸ƒã€ç»“è®º"></a>ä¸ƒã€ç»“è®º</h2><p>PostgreSQL ä½œä¸ºä¸€æ¬¾å¼€æºçš„å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œå‡­å€Ÿå…¶å“è¶Šçš„è®¾è®¡ç†å¿µã€å¼ºå¤§çš„åŠŸèƒ½ç‰¹æ€§å’Œä¼˜ç§€çš„æ€§èƒ½è¡¨ç°ï¼Œå·²ç»æˆä¸ºä¼ä¸šçº§åº”ç”¨çš„é¦–é€‰æ•°æ®åº“ä¹‹ä¸€ã€‚é€šè¿‡æ·±å…¥åˆ†æå…¶æ¶æ„è®¾è®¡ã€å­˜å‚¨å¼•æ“å®ç°ã€æŸ¥è¯¢å¤„ç†æœºåˆ¶å’Œæ€§èƒ½ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°ç†è§£å’Œåˆ©ç”¨è¿™ä¸€å¼ºå¤§çš„æ•°æ®åº“ç³»ç»Ÿã€‚   </p><p>PostgreSQL çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºå…¶ MVCC æ¶æ„å¸¦æ¥çš„é«˜å¹¶å‘èƒ½åŠ›ã€å¼ºå¤§çš„æŸ¥è¯¢ä¼˜åŒ–å™¨ã€ä¸¥æ ¼çš„æ•°æ®å®Œæ•´æ€§ä¿è¯ä»¥åŠçµæ´»çš„æ‰©å±•æœºåˆ¶ã€‚å°½ç®¡åœ¨å†™æ”¾å¤§ã€æ°´å¹³æ‰©å±•ç­‰æ–¹é¢å­˜åœ¨æŒ‘æˆ˜ï¼Œä½†é€šè¿‡åˆç†çš„è®¾è®¡å’Œä¼˜åŒ–ç­–ç•¥ï¼Œè¿™äº›æŒ‘æˆ˜éƒ½å¯ä»¥å¾—åˆ°æœ‰æ•ˆè§£å†³ã€‚   </p><p>æœªæ¥ï¼Œéšç€äº‘è®¡ç®—ã€AI&#x2F;MLã€æ—¶åºæ•°æ®ç­‰æ–°å…´æŠ€æœ¯çš„å‘å±•ï¼ŒPostgreSQL å°†ç»§ç»­æ¼”è¿›ï¼Œæä¾›æ›´å¼ºå¤§çš„åŠŸèƒ½å’Œæ›´å¥½çš„æ€§èƒ½ã€‚å¯¹äºæ•°æ®åº“æ¶æ„å¸ˆå’Œå¼€å‘äººå‘˜æ¥è¯´ï¼Œæ·±å…¥ç†è§£ PostgreSQL çš„å†…éƒ¨å·¥ä½œåŸç†ï¼ŒæŒæ¡å…¶æœ€ä½³å®è·µå’Œä¼˜åŒ–æŠ€å·§ï¼Œå°†æ˜¯æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯é åº”ç”¨ç³»ç»Ÿçš„å…³é”®ã€‚  </p><p>åœ¨é€‰æ‹©æ•°æ®åº“ç³»ç»Ÿæ—¶ï¼ŒPostgreSQL åº”è¯¥ä½œä¸ºä¼ä¸šçº§åº”ç”¨çš„é¦–é€‰è€ƒè™‘ã€‚å…¶å¼€æºæ€§è´¨ã€æ´»è·ƒçš„ç¤¾åŒºã€å®Œå–„çš„åŠŸèƒ½é›†å’Œä¼˜ç§€çš„æ€§èƒ½ï¼Œä½¿å…¶åœ¨æˆæœ¬æ•ˆç›Šå’ŒåŠŸèƒ½ç‰¹æ€§æ–¹é¢éƒ½å…·æœ‰æ˜¾è‘—ä¼˜åŠ¿ã€‚æ— è®ºæ˜¯ OLTPã€OLAP è¿˜æ˜¯æ··åˆå·¥ä½œè´Ÿè½½ï¼ŒPostgreSQL éƒ½èƒ½æä¾›å“è¶Šçš„æ€§èƒ½å’Œå¯é æ€§ã€‚   </p><p>æœ€åï¼Œå»ºè®®è¯»è€…åœ¨å®é™…é¡¹ç›®ä¸­ç§¯æå®è·µæœ¬æ–‡æåˆ°çš„æ¦‚å¿µå’ŒæŠ€å·§ï¼Œç»“åˆå…·ä½“çš„ä¸šåŠ¡éœ€æ±‚å’Œå·¥ä½œè´Ÿè½½ç‰¹æ€§ï¼ŒæŒç»­ä¼˜åŒ– PostgreSQL é…ç½®å’Œåº”ç”¨è®¾è®¡ã€‚é€šè¿‡ä¸æ–­å­¦ä¹ å’Œå®è·µï¼Œæ‚¨å°†èƒ½å¤Ÿå……åˆ†å‘æŒ¥ PostgreSQL çš„æ½œåŠ›ï¼Œæ„å»ºå‡ºé«˜æ€§èƒ½ã€é«˜å¯é çš„æ•°æ®é©±åŠ¨åº”ç”¨ç³»ç»Ÿã€‚   </p><h2 id="å…«ã€PostgreSQL-å¼•æ“å…³é”®æºç æ·±åº¦è§£è¯»"><a href="#å…«ã€PostgreSQL-å¼•æ“å…³é”®æºç æ·±åº¦è§£è¯»" class="headerlink" title="å…«ã€PostgreSQL å¼•æ“å…³é”®æºç æ·±åº¦è§£è¯»"></a>å…«ã€PostgreSQL å¼•æ“å…³é”®æºç æ·±åº¦è§£è¯»</h2><p>åœ¨ç†è§£ PostgreSQL çš„è®¾è®¡åŸç†å’Œæ¶æ„ä¹‹åï¼Œæ·±å…¥æºç å±‚é¢çš„åˆ†æå°†å¸®åŠ©æˆ‘ä»¬æ›´é€å½»åœ°æŒæ¡å…¶å†…éƒ¨å·¥ä½œæœºåˆ¶ã€‚æœ¬ç« èŠ‚å°†å¯¹ PostgreSQL çš„æ ¸å¿ƒæºç è¿›è¡Œè¯¦ç»†è§£è¯»ï¼Œé‡ç‚¹å…³æ³¨å­˜å‚¨å¼•æ“ã€MVCC å®ç°ã€æŸ¥è¯¢ä¼˜åŒ–å™¨å’Œæ‰§è¡Œå¼•æ“çš„å…³é”®ä»£ç ã€‚</p><h3 id="8-1-å­˜å‚¨å¼•æ“æ ¸å¿ƒæºç åˆ†æ"><a href="#8-1-å­˜å‚¨å¼•æ“æ ¸å¿ƒæºç åˆ†æ" class="headerlink" title="8.1 å­˜å‚¨å¼•æ“æ ¸å¿ƒæºç åˆ†æ"></a>8.1 å­˜å‚¨å¼•æ“æ ¸å¿ƒæºç åˆ†æ</h3><h4 id="8-1-1-heapam-cï¼šå †è¡¨è®¿é—®æ–¹æ³•å®ç°"><a href="#8-1-1-heapam-cï¼šå †è¡¨è®¿é—®æ–¹æ³•å®ç°" class="headerlink" title="8.1.1 heapam.cï¼šå †è¡¨è®¿é—®æ–¹æ³•å®ç°"></a>8.1.1 heapam.cï¼šå †è¡¨è®¿é—®æ–¹æ³•å®ç°</h4><p><code>heapam.c</code>æ˜¯ PostgreSQL å­˜å‚¨å¼•æ“çš„æ ¸å¿ƒæ–‡ä»¶ï¼Œä½äº<code>src/backend/access/heap/</code>ç›®å½•ä¸‹ï¼Œå®ç°äº†å †è¡¨çš„è®¿é—®æ–¹æ³•ã€‚è¯¥æ–‡ä»¶åŒ…å«äº†è¶…è¿‡ 7000 è¡Œä»£ç ï¼Œæ˜¯ PostgreSQL å­˜å‚¨å±‚æœ€å¤æ‚çš„ç»„ä»¶ä¹‹ä¸€ã€‚</p><p><strong>å…³é”®æ•°æ®ç»“æ„åˆ†æï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* HeapTupleDataç»“æ„å®šä¹‰ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">HeapTupleData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    uint32      t_len;          <span class="comment">/* å®é™…æ•°æ®é•¿åº¦ */</span></span><br><span class="line">    ItemPointerData t_self;     <span class="comment">/* å…ƒç»„è‡ªèº«çš„TID */</span></span><br><span class="line">    Oid         t_tableOid;     <span class="comment">/* è¡¨OID */</span></span><br><span class="line">    HeapTupleHeader t_data;     <span class="comment">/* å®é™…æ•°æ®å¤´æŒ‡é’ˆ */</span></span><br><span class="line">&#125; HeapTupleData;</span><br></pre></td></tr></table></figure><p><code>HeapTupleData</code>ç»“æ„æ˜¯ PostgreSQL ä¸­è¡¨ç¤ºæ•°æ®è¡Œçš„æ ¸å¿ƒç»“æ„ã€‚å…¶ä¸­<code>HeapTupleHeader</code>åŒ…å« MVCC å…³é”®ä¿¡æ¯ï¼š</p><ul><li><code>t_xmin</code>ï¼šåˆ›å»ºè¯¥å…ƒç»„çš„äº‹åŠ¡ ID</li><li><code>t_xmax</code>ï¼šåˆ é™¤&#x2F;æ›´æ–°è¯¥å…ƒç»„çš„äº‹åŠ¡ ID  </li><li><code>t_cid</code>ï¼šå‘½ä»¤ IDï¼Œç”¨äºåŒä¸€ä¸ªäº‹åŠ¡å†…çš„å¤šä¸ªæ“ä½œ</li><li><code>t_ctid</code>ï¼šæŒ‡å‘æ–°ç‰ˆæœ¬å…ƒç»„çš„æŒ‡é’ˆï¼ˆç”¨äºæ›´æ–°æ“ä½œï¼‰</li></ul><p><strong>æ ¸å¿ƒå‡½æ•°å®ç°ï¼š</strong></p><p><code>heap_insert</code>å‡½æ•°å®ç°äº†å…ƒç»„æ’å…¥æ“ä½œï¼Œå…¶å…³é”®ä»£ç ç‰‡æ®µå±•ç¤ºäº† MVCC çš„æ ¸å¿ƒé€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Oid</span><br><span class="line"><span class="title function_">heap_insert</span><span class="params">(Relation relation, HeapTuple tup, CommandId cid,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> options, BulkInsertState bistate)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* ä¸ºæ–°å…ƒç»„åˆ†é…äº‹åŠ¡ID */</span></span><br><span class="line">    tup-&gt;t_data-&gt;t_xmin = GetCurrentTransactionId();</span><br><span class="line">    tup-&gt;t_data-&gt;t_xmax = InvalidTransactionId;</span><br><span class="line">    tup-&gt;t_data-&gt;t_field3 = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è®¾ç½®æ’å…¥æ—¶é—´æˆ³ */</span></span><br><span class="line">    HeapTupleHeaderSetXmin(tup-&gt;t_data, GetCurrentTransactionId());</span><br><span class="line">    HeapTupleHeaderSetCmin(tup-&gt;t_data, cid);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* å®é™…æ’å…¥æ“ä½œ */</span></span><br><span class="line">    RelationPutHeapTuple(relation, buffer, tup, !options &amp; HEAP_INSERT_SKIP_WAL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* WALæ—¥å¿—è®°å½• */</span></span><br><span class="line">    <span class="keyword">if</span> (!(options &amp; HEAP_INSERT_SKIP_WAL))</span><br><span class="line">        log_heap_insert(relation, tup);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> HeapTupleGetOid(tup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æ¸…æ™°åœ°å±•ç¤ºäº† PostgreSQL åœ¨æ’å…¥æ•°æ®æ—¶å¦‚ä½•è®¾ç½® MVCC ç›¸å…³å­—æ®µï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ WAL æœºåˆ¶ç¡®ä¿æ•°æ®æŒä¹…æ€§ã€‚</p><h4 id="8-1-2-bufmgr-cï¼šç¼“å†²åŒºç®¡ç†å™¨å®ç°"><a href="#8-1-2-bufmgr-cï¼šç¼“å†²åŒºç®¡ç†å™¨å®ç°" class="headerlink" title="8.1.2 bufmgr.cï¼šç¼“å†²åŒºç®¡ç†å™¨å®ç°"></a>8.1.2 bufmgr.cï¼šç¼“å†²åŒºç®¡ç†å™¨å®ç°</h4><p><code>bufmgr.c</code>ä½äº<code>src/backend/storage/buffer/</code>ç›®å½•ï¼Œæ˜¯ PostgreSQL å†…å­˜ç®¡ç†çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†å…±äº«ç¼“å†²åŒºæ± ã€‚è¯¥æ–‡ä»¶å®ç°äº†åŸºäº Clock-Sweep ç®—æ³•çš„ç¼“å†²åŒºæ›¿æ¢ç­–ç•¥ã€‚</p><p><strong>å…³é”®å…¨å±€å˜é‡ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å…±äº«ç¼“å†²åŒºæè¿°ç¬¦æ•°ç»„ */</span></span><br><span class="line">BufferDesc *BufferDescriptors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç¼“å†²åŒºå“ˆå¸Œè¡¨ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾ */</span></span><br><span class="line">HTAB *SharedBufHash;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ—¶é’ŸæŒ‡é’ˆï¼Œç”¨äºç¼“å†²åŒºæ›¿æ¢ */</span></span><br><span class="line">int32 ClockSweepTick = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒå‡½æ•°åˆ†æï¼š</strong></p><p><code>BufferAlloc</code>å‡½æ•°æ˜¯ç¼“å†²åŒºåˆ†é…çš„æ ¸å¿ƒç®—æ³•ï¼Œå…¶å®ç°äº† Clock-Sweep æ›¿æ¢ç­–ç•¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">BufferDesc *</span><br><span class="line"><span class="title function_">BufferAlloc</span><span class="params">(SMgrRelation smgr, ForkNumber forkNum,</span></span><br><span class="line"><span class="params">            BlockNumber blockNum, <span class="type">bool</span> *foundPtr)</span></span><br><span class="line">&#123;</span><br><span class="line">    BufferTag   tag;</span><br><span class="line">    uint32      hash;</span><br><span class="line">    LWLock     *partitionLock;</span><br><span class="line">    BufferDesc *bufHdr;</span><br><span class="line">    <span class="type">int</span>         buf_id;</span><br><span class="line">    <span class="type">bool</span>        found;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è®¡ç®—ç¼“å†²åŒºå“ˆå¸Œå€¼ */</span></span><br><span class="line">    INIT_BUFFERTAG(tag, smgr-&gt;smgr_rnode, forkNum, blockNum);</span><br><span class="line">    hash = BufTableHashCode(&amp;tag);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ */</span></span><br><span class="line">    partitionLock = BufMappingPartitionLock(hash);</span><br><span class="line">    LWLockAcquire(partitionLock, LW_SHARED);</span><br><span class="line">    buf_id = BufTableLookup(&amp;tag, hash);</span><br><span class="line">    <span class="keyword">if</span> (buf_id &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* ç¼“å†²åŒºå·²å­˜åœ¨ï¼Œç›´æ¥è¿”å› */</span></span><br><span class="line">        bufHdr = GetBufferDescriptor(buf_id);</span><br><span class="line">        *foundPtr = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> bufHdr;</span><br><span class="line">    &#125;</span><br><span class="line">    LWLockRelease(partitionLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* éœ€è¦åˆ†é…æ–°ç¼“å†²åŒºï¼Œæ‰§è¡Œæ›¿æ¢ç­–ç•¥ */</span></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* è·å–æ—¶é’ŸæŒ‡é’ˆæŒ‡å‘çš„ç¼“å†²åŒº */</span></span><br><span class="line">        <span class="type">int</span> victim = ClockSweepTick % NBuffers;</span><br><span class="line">        bufHdr = GetBufferDescriptor(victim);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* æ£€æŸ¥æ˜¯å¦å¯ä»¥æ›¿æ¢ */</span></span><br><span class="line">        <span class="keyword">if</span> (bufHdr-&gt;refcount == <span class="number">0</span> &amp;&amp; !LWLockHeldByMe(bufHdr-&gt;content_lock))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* æ›¿æ¢è¯¥ç¼“å†²åŒº */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* æ—¶é’ŸæŒ‡é’ˆå‰è¿› */</span></span><br><span class="line">        ClockSweepTick++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* å†™å›è„é¡µï¼ˆå¦‚æœéœ€è¦ï¼‰ */</span></span><br><span class="line">    <span class="keyword">if</span> (bufHdr-&gt;flags &amp; BM_DIRTY)</span><br><span class="line">        FlushBuffer(bufHdr, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* é‡ç”¨è¯¥ç¼“å†²åŒº */</span></span><br><span class="line">    buf_id = bufHdr-&gt;buf_id;</span><br><span class="line">    *foundPtr = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> bufHdr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ¸…æ™°åœ°å±•ç¤ºäº† PostgreSQL å¦‚ä½•é€šè¿‡ Clock-Sweep ç®—æ³•å®ç°é«˜æ•ˆçš„ç¼“å†²åŒºç®¡ç†ï¼Œé¿å…äº†ä¼ ç»Ÿ LRU ç®—æ³•åœ¨æ‰«æå¤§è¡¨æ—¶çš„æ€§èƒ½é—®é¢˜ã€‚</p><h4 id="8-1-3-procarray-cï¼šè¿›ç¨‹æ•°ç»„å’Œäº‹åŠ¡å¯è§æ€§"><a href="#8-1-3-procarray-cï¼šè¿›ç¨‹æ•°ç»„å’Œäº‹åŠ¡å¯è§æ€§" class="headerlink" title="8.1.3 procarray.cï¼šè¿›ç¨‹æ•°ç»„å’Œäº‹åŠ¡å¯è§æ€§"></a>8.1.3 procarray.cï¼šè¿›ç¨‹æ•°ç»„å’Œäº‹åŠ¡å¯è§æ€§</h4><p><code>procarray.c</code>ä½äº<code>src/backend/storage/ipc/</code>ç›®å½•ï¼Œç»´æŠ¤äº†æ‰€æœ‰æ´»è·ƒåç«¯è¿›ç¨‹çš„æ•°ç»„ï¼Œæ˜¯ MVCC äº‹åŠ¡å¯è§æ€§åˆ¤æ–­çš„æ ¸å¿ƒã€‚</p><p><strong>å…³é”®æ•°æ®ç»“æ„ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å…¨å±€ProcArrayç»“æ„ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ProcArrayStruct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/* æ‰€æœ‰æ´»è·ƒè¿›ç¨‹çš„PGPROCæŒ‡é’ˆæ•°ç»„ */</span></span><br><span class="line">    PGPROC     *procs[FLEXIBLE_ARRAY_MEMBER];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* å½“å‰æ´»è·ƒè¿›ç¨‹æ•° */</span></span><br><span class="line">    <span class="type">int</span>         numProcs;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æœ€å°å’Œæœ€å¤§æ´»è·ƒäº‹åŠ¡ID */</span></span><br><span class="line">    TransactionId minProcXid;</span><br><span class="line">    TransactionId maxProcXid;</span><br><span class="line">&#125; ProcArrayStruct;</span><br></pre></td></tr></table></figure><p><strong>äº‹åŠ¡å¯è§æ€§åˆ¤æ–­å‡½æ•°ï¼š</strong></p><p><code>HeapTupleSatisfiesVisibility</code>å‡½æ•°æ˜¯åˆ¤æ–­å…ƒç»„æ˜¯å¦å¯¹å½“å‰äº‹åŠ¡å¯è§çš„æ ¸å¿ƒå‡½æ•°ï¼Œå…¶å®ç°äº† MVCC çš„å¯è§æ€§è§„åˆ™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span></span><br><span class="line"><span class="title function_">HeapTupleSatisfiesVisibility</span><span class="params">(HeapTuple tup, Snapshot snapshot, Buffer buffer)</span></span><br><span class="line">&#123;</span><br><span class="line">    TransactionId xmin = HeapTupleHeaderGetXmin(tup-&gt;t_data);</span><br><span class="line">    TransactionId xmax = HeapTupleHeaderGetXmax(tup-&gt;t_data);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ£€æŸ¥xminæ˜¯å¦å·²æäº¤ */</span></span><br><span class="line">    <span class="keyword">if</span> (!TransactionIdDidCommit(xmin))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* äº‹åŠ¡ä»åœ¨è¿è¡Œæˆ–å·²å›æ»š */</span></span><br><span class="line">        <span class="keyword">if</span> (TransactionIdIsCurrentTransactionId(xmin))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">/* å½“å‰äº‹åŠ¡åˆ›å»ºçš„å…ƒç»„æ€»æ˜¯å¯è§ */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (TransactionIdIsInProgress(xmin))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">/* å…¶ä»–æ´»è·ƒäº‹åŠ¡åˆ›å»ºçš„å…ƒç»„ä¸å¯è§ */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* äº‹åŠ¡å·²å›æ»šï¼Œå…ƒç»„ä¸å¯è§ */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ£€æŸ¥xmaxæ˜¯å¦å·²æäº¤ */</span></span><br><span class="line">    <span class="keyword">if</span> (TransactionIdIsValid(xmax) &amp;&amp; !TransactionIdIsCurrentTransactionId(xmax))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (TransactionIdDidCommit(xmax))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">/* å…ƒç»„å·²è¢«åˆ é™¤ */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (TransactionIdIsInProgress(xmax))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">/* åˆ é™¤æ“ä½œå°šæœªæäº¤ï¼Œå…ƒç»„ä»ç„¶å¯è§ */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ£€æŸ¥å¿«ç…§éš”ç¦»çº§åˆ« */</span></span><br><span class="line">    <span class="keyword">if</span> (snapshot-&gt;whenTaken &lt; xmin)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">/* å…ƒç»„åœ¨å¿«ç…§ä¹‹ååˆ›å»º */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ£€æŸ¥äº‹åŠ¡æ˜¯å¦åœ¨å¿«ç…§çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸­ */</span></span><br><span class="line">    <span class="keyword">if</span> (XidInSnapshot(xmin, snapshot))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">/* åˆ›å»ºäº‹åŠ¡åœ¨å¿«ç…§æ—¶ä»æ´»è·ƒ */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å®ç°äº† PostgreSQL MVCC çš„æ ¸å¿ƒé€»è¾‘ï¼Œé€šè¿‡æ£€æŸ¥äº‹åŠ¡ ID çš„çŠ¶æ€å’Œå¿«ç…§ä¿¡æ¯ï¼Œç²¾ç¡®åˆ¤æ–­å…ƒç»„çš„å¯è§æ€§ã€‚</p><h3 id="8-2-æŸ¥è¯¢ä¼˜åŒ–å™¨æºç æ·±åº¦åˆ†æ"><a href="#8-2-æŸ¥è¯¢ä¼˜åŒ–å™¨æºç æ·±åº¦åˆ†æ" class="headerlink" title="8.2 æŸ¥è¯¢ä¼˜åŒ–å™¨æºç æ·±åº¦åˆ†æ"></a>8.2 æŸ¥è¯¢ä¼˜åŒ–å™¨æºç æ·±åº¦åˆ†æ</h3><h4 id="8-2-1-planner-cï¼šæŸ¥è¯¢è§„åˆ’å™¨å®ç°"><a href="#8-2-1-planner-cï¼šæŸ¥è¯¢è§„åˆ’å™¨å®ç°" class="headerlink" title="8.2.1 planner.cï¼šæŸ¥è¯¢è§„åˆ’å™¨å®ç°"></a>8.2.1 planner.cï¼šæŸ¥è¯¢è§„åˆ’å™¨å®ç°</h4><p><code>planner.c</code>ä½äº<code>src/backend/optimizer/plan/</code>ç›®å½•ï¼Œæ˜¯ PostgreSQL æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æ ¸å¿ƒæ–‡ä»¶ï¼Œè´Ÿè´£å°†è§£ææ ‘è½¬æ¢ä¸ºæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p><strong>æŸ¥è¯¢è§„åˆ’æµç¨‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Plan *</span><br><span class="line"><span class="title function_">standard_planner</span><span class="params">(Query *parse, <span class="type">const</span> <span class="type">char</span> *query_string, <span class="type">int</span> cursorOptions,</span></span><br><span class="line"><span class="params">                  ParamListInfo boundParams)</span></span><br><span class="line">&#123;</span><br><span class="line">    PlannerGlobal *glob;</span><br><span class="line">    PlannerInfo *root;</span><br><span class="line">    Plan       *result;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–å…¨å±€è§„åˆ’çŠ¶æ€ */</span></span><br><span class="line">    glob = makeNode(PlannerGlobal);</span><br><span class="line">    glob-&gt;boundParams = boundParams;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–å•ä¸ªæŸ¥è¯¢çš„è§„åˆ’çŠ¶æ€ */</span></span><br><span class="line">    root = makeNode(PlannerInfo);</span><br><span class="line">    root-&gt;parse = parse;</span><br><span class="line">    root-&gt;glob = glob;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ‰§è¡ŒæŸ¥è¯¢é‡å†™ */</span></span><br><span class="line">    <span class="keyword">if</span> (parse-&gt;commandType == CMD_SELECT)</span><br><span class="line">        parse = rewriter_rewrite_query(parse, query_string);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* ç”Ÿæˆè·¯å¾„ */</span></span><br><span class="line">    <span class="keyword">if</span> (parse-&gt;commandType == CMD_UTILITY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* ç‰¹æ®Šå‘½ä»¤å¤„ç† */</span></span><br><span class="line">        result = plan_utility_command(parse, query_string, cursorOptions, boundParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„è®¿é—®è·¯å¾„ */</span></span><br><span class="line">        generate_base_paths(root);</span><br><span class="line">        generate_join_paths(root);</span><br><span class="line">        generate_agg_paths(root);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* é€‰æ‹©æœ€ä¼˜è·¯å¾„ */</span></span><br><span class="line">        Path *best_path = get_cheapest_path_for_pathkeys(root-&gt;upper_paths, NIL, <span class="literal">NULL</span>, TOTAL_COST, <span class="literal">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ */</span></span><br><span class="line">        result = create_plan(root, best_path);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å±•ç¤ºäº† PostgreSQL æŸ¥è¯¢ä¼˜åŒ–çš„å®Œæ•´æµç¨‹ï¼šä»æŸ¥è¯¢é‡å†™ã€è·¯å¾„ç”Ÿæˆåˆ°æœ€ç»ˆè®¡åˆ’é€‰æ‹©ã€‚</p><p><strong>æˆæœ¬ä¼°ç®—å‡½æ•°ï¼š</strong></p><p><code>cost_seqscan</code>å‡½æ•°å®ç°äº†é¡ºåºæ‰«æçš„æˆæœ¬ä¼°ç®—æ¨¡å‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">cost_seqscan</span><span class="params">(Path *path, PlannerInfo *root, RelOptInfo *baserel, ParamPathInfo *param_info)</span></span><br><span class="line">&#123;</span><br><span class="line">    Cost        startup_cost = <span class="number">0</span>;</span><br><span class="line">    Cost        run_cost = <span class="number">0</span>;</span><br><span class="line">    <span class="type">double</span>      spc_random_page_cost;</span><br><span class="line">    <span class="type">double</span>      npages;</span><br><span class="line">    <span class="type">double</span>      ntuples;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è·å–è¡¨çš„ç‰©ç†ä¿¡æ¯ */</span></span><br><span class="line">    npages = baserel-&gt;pages;</span><br><span class="line">    ntuples = baserel-&gt;tuples;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è®¡ç®—I/Oæˆæœ¬ */</span></span><br><span class="line">    spc_random_page_cost = get_tablespace_io_cost(baserel-&gt;reltablespace, <span class="literal">true</span>);</span><br><span class="line">    run_cost += npages * spc_random_page_cost;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è®¡ç®—CPUæˆæœ¬ */</span></span><br><span class="line">    startup_cost += baserel-&gt;baserestrictcost.startup;</span><br><span class="line">    run_cost += baserel-&gt;baserestrictcost.per_tuple * ntuples;</span><br><span class="line">    run_cost += cpu_tuple_cost * ntuples;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è®¾ç½®è·¯å¾„æˆæœ¬ */</span></span><br><span class="line">    path-&gt;startup_cost = startup_cost;</span><br><span class="line">    path-&gt;total_cost = startup_cost + run_cost;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä½“ç°äº† PostgreSQL æˆæœ¬æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³ï¼šç»¼åˆè€ƒè™‘ I&#x2F;O æˆæœ¬å’Œ CPU æˆæœ¬ã€‚</p><h4 id="8-2-2-syscache-cï¼šç³»ç»Ÿç¼“å­˜å®ç°"><a href="#8-2-2-syscache-cï¼šç³»ç»Ÿç¼“å­˜å®ç°" class="headerlink" title="8.2.2 syscache.cï¼šç³»ç»Ÿç¼“å­˜å®ç°"></a>8.2.2 syscache.cï¼šç³»ç»Ÿç¼“å­˜å®ç°</h4><p><code>syscache.c</code>ä½äº<code>src/backend/utils/cache/</code>ç›®å½•ï¼Œå®ç°äº† PostgreSQL çš„ç³»ç»Ÿç¼“å­˜æœºåˆ¶ï¼Œç”¨äºç¼“å­˜ç³»ç»Ÿç›®å½•ä¿¡æ¯ï¼Œé¿å…é¢‘ç¹çš„ç£ç›˜è®¿é—®ã€‚</p><p><strong>æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ç³»ç»Ÿç¼“å­˜å®šä¹‰ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SysCacheSize 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> CatCache *SysCache[SysCacheSize];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç›®å½•ç¼“å­˜ç»“æ„ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">catcache</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span>         id;            <span class="comment">/* ç¼“å­˜ID */</span></span><br><span class="line">    Oid         cc_reloid;     <span class="comment">/* å…³è”çš„ç³»ç»Ÿè¡¨OID */</span></span><br><span class="line">    <span class="type">int</span>         cc_nkeys;      <span class="comment">/* ç´¢å¼•é”®æ•°é‡ */</span></span><br><span class="line">    <span class="type">int</span>         cc_ntup;       <span class="comment">/* å½“å‰ç¼“å­˜çš„å…ƒç»„æ•° */</span></span><br><span class="line">    HTAB       *cc_hash;       <span class="comment">/* å“ˆå¸Œè¡¨ */</span></span><br><span class="line">&#125; CatCache;</span><br></pre></td></tr></table></figure><p><strong>ç¼“å­˜æŸ¥æ‰¾å‡½æ•°ï¼š</strong></p><p><code>SearchSysCache</code>å‡½æ•°å®ç°äº†é«˜æ•ˆçš„ç³»ç»Ÿç›®å½•æŸ¥æ‰¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">HeapTuple</span><br><span class="line"><span class="title function_">SearchSysCache</span><span class="params">(<span class="type">int</span> cacheId, Datum key1, Datum key2, Datum key3, Datum key4)</span></span><br><span class="line">&#123;</span><br><span class="line">    CatCache   *cache;</span><br><span class="line">    HeapTuple   result;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è·å–ç¼“å­˜å¯¹è±¡ */</span></span><br><span class="line">    cache = SysCache[cacheId];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾ */</span></span><br><span class="line">    result = CatCacheSearch(cache, key1, key2, key3, key4);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* ç¼“å­˜æœªå‘½ä¸­ï¼Œä»ç£ç›˜è¯»å– */</span></span><br><span class="line">        Relation    rel = heap_open(cache-&gt;cc_reloid, AccessShareLock);</span><br><span class="line">        ScanKeyData skey[<span class="number">4</span>];</span><br><span class="line">        SysScanDesc scan;</span><br><span class="line">        HeapTuple   tuple;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* æ„å»ºæ‰«æé”® */</span></span><br><span class="line">        ScanKeyInit(&amp;skey[<span class="number">0</span>], cache-&gt;cc_key[<span class="number">0</span>], BTEqualStrategyNumber,</span><br><span class="line">                    F_OIDEQ, key1);</span><br><span class="line">        <span class="comment">/* ... åˆå§‹åŒ–å…¶ä»–é”® ... */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* æ‰§è¡Œç´¢å¼•æ‰«æ */</span></span><br><span class="line">        scan = systable_beginscan(rel, cache-&gt;cc_indexoid, <span class="literal">true</span>,</span><br><span class="line">                                 SnapshotSelf, cache-&gt;cc_nkeys, skey);</span><br><span class="line">        </span><br><span class="line">        tuple = systable_getnext(scan);</span><br><span class="line">        <span class="keyword">if</span> (HeapTupleIsValid(tuple))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* å°†ç»“æœç¼“å­˜ */</span></span><br><span class="line">            result = heap_copytuple(tuple);</span><br><span class="line">            CatCacheInsert(cache, result);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        systable_endscan(scan);</span><br><span class="line">        heap_close(rel, AccessShareLock);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å±•ç¤ºäº† PostgreSQL å¦‚ä½•é€šè¿‡å†…å­˜ç¼“å­˜æœºåˆ¶å¤§å¹…æå‡ç³»ç»Ÿç›®å½•è®¿é—®æ€§èƒ½ï¼Œé¿å…äº†é¢‘ç¹çš„ç£ç›˜ I&#x2F;Oã€‚</p><h3 id="8-3-æ‰§è¡Œå¼•æ“æºç åˆ†æ"><a href="#8-3-æ‰§è¡Œå¼•æ“æºç åˆ†æ" class="headerlink" title="8.3 æ‰§è¡Œå¼•æ“æºç åˆ†æ"></a>8.3 æ‰§è¡Œå¼•æ“æºç åˆ†æ</h3><h4 id="8-3-1-executor-cï¼šæŸ¥è¯¢æ‰§è¡Œå™¨æ ¸å¿ƒ"><a href="#8-3-1-executor-cï¼šæŸ¥è¯¢æ‰§è¡Œå™¨æ ¸å¿ƒ" class="headerlink" title="8.3.1 executor.cï¼šæŸ¥è¯¢æ‰§è¡Œå™¨æ ¸å¿ƒ"></a>8.3.1 executor.cï¼šæŸ¥è¯¢æ‰§è¡Œå™¨æ ¸å¿ƒ</h4><p>è™½ç„¶æœç´¢ç»“æœä¸­æ²¡æœ‰ç›´æ¥æåˆ°<code>executor.c</code>ï¼Œä½†æ ¹æ® PostgreSQL æºç ç»“æ„ï¼Œæ‰§è¡Œå™¨çš„æ ¸å¿ƒå®ç°åœ¨<code>src/backend/executor/</code>ç›®å½•ä¸‹ã€‚æ‰§è¡Œå™¨é‡‡ç”¨ç«å±±æ¨¡å‹ï¼ˆVolcano Modelï¼‰ï¼Œé€šè¿‡è¿­ä»£å™¨æ¨¡å¼é€è¡Œå¤„ç†æ•°æ®ã€‚</p><p><strong>æ‰§è¡ŒèŠ‚ç‚¹æŠ½è±¡ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ‰§è¡ŒèŠ‚ç‚¹é€šç”¨ç»“æ„ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">PlanState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    NodeTag     type;           <span class="comment">/* èŠ‚ç‚¹ç±»å‹ */</span></span><br><span class="line">    Plan       *plan;           <span class="comment">/* å…³è”çš„è®¡åˆ’èŠ‚ç‚¹ */</span></span><br><span class="line">    ExprState  *qual;           <span class="comment">/* è¿‡æ»¤æ¡ä»¶ */</span></span><br><span class="line">    List       *targetlist;     <span class="comment">/* æŠ•å½±åˆ—è¡¨ */</span></span><br><span class="line">    TupleTableSlot *ps_ResultTupleSlot; <span class="comment">/* ç»“æœæ§½ */</span></span><br><span class="line">    ExprContext *ps_ExprContext; <span class="comment">/* è¡¨è¾¾å¼ä¸Šä¸‹æ–‡ */</span></span><br><span class="line">    ProjectionInfo *ps_ProjInfo; <span class="comment">/* æŠ•å½±ä¿¡æ¯ */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* èŠ‚ç‚¹ç‰¹å®šçš„çŠ¶æ€ */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        SeqScanState    seqscan;</span><br><span class="line">        IndexScanState  indexscan;</span><br><span class="line">        HashJoinState   hashjoin;</span><br><span class="line">        <span class="comment">/* ... å…¶ä»–èŠ‚ç‚¹ç±»å‹ ... */</span></span><br><span class="line">    &#125; state;</span><br><span class="line">&#125; PlanState;</span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡Œè¿­ä»£å‡½æ•°ï¼š</strong></p><p>æ¯ä¸ªæ‰§è¡ŒèŠ‚ç‚¹éƒ½å®ç°äº†<code>ExecProcNode</code>å‡½æ•°ï¼Œéµå¾ªç»Ÿä¸€çš„æ¥å£ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line"><span class="title function_">ExecProcNode</span><span class="params">(PlanState *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (nodeTag(node))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> T_SeqScanState:</span><br><span class="line">            <span class="keyword">return</span> ExecSeqScan((SeqScanState *) node);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> T_IndexScanState:</span><br><span class="line">            <span class="keyword">return</span> ExecIndexScan((IndexScanState *) node);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> T_HashJoinState:</span><br><span class="line">            <span class="keyword">return</span> ExecHashJoin((HashJoinState *) node);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">/* ... å…¶ä»–èŠ‚ç‚¹ç±»å‹ ... */</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            elog(ERROR, <span class="string">&quot;unrecognized node type: %d&quot;</span>, (<span class="type">int</span>) nodeTag(node));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§è®¾è®¡æ¨¡å¼ä½¿å¾— PostgreSQL æ‰§è¡Œå¼•æ“å…·æœ‰é«˜åº¦çš„æ‰©å±•æ€§å’Œçµæ´»æ€§ï¼Œæ–°çš„æ‰§è¡ŒèŠ‚ç‚¹ç±»å‹å¯ä»¥å¾ˆå®¹æ˜“åœ°é›†æˆåˆ°ç°æœ‰æ¡†æ¶ä¸­ã€‚</p><h4 id="8-3-2-èŠ‚ç‚¹æ‰§è¡Œç¤ºä¾‹ï¼šSeqScan"><a href="#8-3-2-èŠ‚ç‚¹æ‰§è¡Œç¤ºä¾‹ï¼šSeqScan" class="headerlink" title="8.3.2 èŠ‚ç‚¹æ‰§è¡Œç¤ºä¾‹ï¼šSeqScan"></a>8.3.2 èŠ‚ç‚¹æ‰§è¡Œç¤ºä¾‹ï¼šSeqScan</h4><p>é¡ºåºæ‰«æèŠ‚ç‚¹çš„æ‰§è¡Œå‡½æ•°<code>ExecSeqScan</code>å±•ç¤ºäº†å¦‚ä½•ä»å­˜å‚¨å¼•æ“è¯»å–æ•°æ®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">TupleTableSlot *</span><br><span class="line"><span class="title function_">ExecSeqScan</span><span class="params">(SeqScanState *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    HeapScanDesc scandesc;</span><br><span class="line">    TupleTableSlot *slot;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è·å–æ‰«ææè¿°ç¬¦ */</span></span><br><span class="line">    scandesc = node-&gt;ss.ss_currentScanDesc;</span><br><span class="line">    slot = node-&gt;ss.ss_ScanTupleSlot;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* ä»å †è¡¨ä¸­è·å–ä¸‹ä¸€è¡Œ */</span></span><br><span class="line">    <span class="keyword">if</span> (scandesc == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* é¦–æ¬¡è°ƒç”¨ï¼Œåˆå§‹åŒ–æ‰«æ */</span></span><br><span class="line">        scandesc = heap_beginscan(node-&gt;ss.ss_currentRelation,</span><br><span class="line">                                node-&gt;ss.ps.state-&gt;es_snapshot,</span><br><span class="line">                                <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        node-&gt;ss.ss_currentScanDesc = scandesc;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è·å–ä¸‹ä¸€è¡Œ */</span></span><br><span class="line">    <span class="keyword">if</span> (!HeapTupleIsValid(scandesc-&gt;rs_ctup))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* é‡ç½®æ‰«æ */</span></span><br><span class="line">        heap_rescan(scandesc, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ‰§è¡Œå®é™…æ‰«æ */</span></span><br><span class="line">    <span class="keyword">if</span> (heap_getnext(scandesc, ForwardScanDirection))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* å°†å…ƒç»„æ”¾å…¥æ§½ä¸­ */</span></span><br><span class="line">        ExecStoreTuple(scandesc-&gt;rs_ctup, slot, scandesc-&gt;rs_cbuf, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> slot;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ²¡æœ‰æ›´å¤šè¡Œï¼Œè¿”å›ç©º */</span></span><br><span class="line">    ExecClearTuple(slot);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ¸…æ™°åœ°å±•ç¤ºäº† PostgreSQL å¦‚ä½•å°†å­˜å‚¨å¼•æ“çš„å †è¡¨è®¿é—®ä¸æ‰§è¡Œå¼•æ“çš„è¿­ä»£å™¨æ¨¡å¼ç»“åˆï¼Œå®ç°é«˜æ•ˆçš„æ•°æ®è¯»å–ã€‚</p><h3 id="8-4-MVCC-æºç å®ç°æ·±åº¦å‰–æ"><a href="#8-4-MVCC-æºç å®ç°æ·±åº¦å‰–æ" class="headerlink" title="8.4 MVCC æºç å®ç°æ·±åº¦å‰–æ"></a>8.4 MVCC æºç å®ç°æ·±åº¦å‰–æ</h3><h4 id="8-4-1-äº‹åŠ¡-ID-ç®¡ç†"><a href="#8-4-1-äº‹åŠ¡-ID-ç®¡ç†" class="headerlink" title="8.4.1 äº‹åŠ¡ ID ç®¡ç†"></a>8.4.1 äº‹åŠ¡ ID ç®¡ç†</h4><p>PostgreSQL ä½¿ç”¨ 32 ä½äº‹åŠ¡ IDï¼ˆXIDï¼‰ï¼Œé€šè¿‡<code>src/backend/access/transam/xact.c</code>ä¸­çš„å‡½æ•°è¿›è¡Œç®¡ç†ã€‚å…³é”®å‡½æ•°<code>GetNewTransactionId</code>è´Ÿè´£åˆ†é…æ–°çš„äº‹åŠ¡ IDï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">TransactionId</span><br><span class="line"><span class="title function_">GetNewTransactionId</span><span class="params">(<span class="type">bool</span> isSubXact)</span></span><br><span class="line">&#123;</span><br><span class="line">    TransactionId xid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è·å–äº‹åŠ¡IDé” */</span></span><br><span class="line">    LWLockAcquire(XidGenLock, LW_EXCLUSIVE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* è·å–å½“å‰äº‹åŠ¡ID */</span></span><br><span class="line">    xid = ShmemVariableCache-&gt;nextXid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ£€æŸ¥XIDå›å· */</span></span><br><span class="line">    <span class="keyword">if</span> (TransactionIdFollowsOrEquals(xid, ShmemVariableCache-&gt;xidVacLimit))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* éœ€è¦å¼ºåˆ¶VACUUM */</span></span><br><span class="line">        LWLockRelease(XidGenLock);</span><br><span class="line">        ereport(ERROR,</span><br><span class="line">                (errcode(ERRCODE_PROGRAM_LIMIT_EXCEEDED),</span><br><span class="line">                 errmsg(<span class="string">&quot;database is not accepting commands to avoid wraparound data loss&quot;</span>),</span><br><span class="line">                 errhint(<span class="string">&quot;Stop the postmaster and vacuum the database manually.&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* é€’å¢äº‹åŠ¡ID */</span></span><br><span class="line">    ShmemVariableCache-&gt;nextXid = xid + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ */</span></span><br><span class="line">    <span class="keyword">if</span> (isSubXact)</span><br><span class="line">        ShmemVariableCache-&gt;subxidCount++;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ShmemVariableCache-&gt;xactCount++;</span><br><span class="line">    </span><br><span class="line">    LWLockRelease(XidGenLock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> xid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å±•ç¤ºäº† PostgreSQL å¦‚ä½•å®‰å…¨åœ°ç®¡ç†äº‹åŠ¡ IDï¼ŒåŒ…æ‹¬å…³é”®çš„ XID å›å·ä¿æŠ¤æœºåˆ¶ã€‚</p><h4 id="8-4-2-VACUUM-å®ç°"><a href="#8-4-2-VACUUM-å®ç°" class="headerlink" title="8.4.2 VACUUM å®ç°"></a>8.4.2 VACUUM å®ç°</h4><p><code>vacuum.c</code>æ–‡ä»¶å®ç°äº† PostgreSQL çš„ VACUUM æœºåˆ¶ï¼Œè´Ÿè´£æ¸…ç†æ­»å…ƒç»„å’Œå†»ç»“æ—§äº‹åŠ¡ IDã€‚<code>lazy_vacuum_heap</code>å‡½æ•°æ˜¯æ ¸å¿ƒæ¸…ç†é€»è¾‘ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">lazy_vacuum_heap</span><span class="params">(Relation rel, LVRelStats *vacrelstats)</span></span><br><span class="line">&#123;</span><br><span class="line">    Buffer      vmbuffer = InvalidBuffer;</span><br><span class="line">    BlockNumber blkno;</span><br><span class="line">    <span class="type">bool</span>        skipping;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* éå†æ‰€æœ‰å †å— */</span></span><br><span class="line">    <span class="keyword">for</span> (blkno = <span class="number">0</span>; blkno &lt; vacrelstats-&gt;rel_pages; blkno++)</span><br><span class="line">    &#123;</span><br><span class="line">        Buffer      buf;</span><br><span class="line">        Page        page;</span><br><span class="line">        OffsetNumber offnum,</span><br><span class="line">                    maxoff;</span><br><span class="line">        <span class="type">bool</span>        tupdead[MAXALIGN(MaxHeapTuplesPerPage)];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* è¯»å–å †å— */</span></span><br><span class="line">        buf = ReadBufferExtended(rel, MAIN_FORKNUM, blkno, RBM_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">        LockBuffer(buf, BUFFER_LOCK_EXCLUSIVE);</span><br><span class="line">        page = BufferGetPage(buf);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* æ£€æŸ¥é¡µé¢æ˜¯å¦éœ€è¦æ¸…ç† */</span></span><br><span class="line">        <span class="keyword">if</span> (PageIsAllVisible(page) &amp;&amp; !PageIsPrunable(page, OldestXmin))</span><br><span class="line">        &#123;</span><br><span class="line">            UnlockReleaseBuffer(buf);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* æ ‡è®°æ­»å…ƒç»„ */</span></span><br><span class="line">        maxoff = PageGetMaxOffsetNumber(page);</span><br><span class="line">        <span class="keyword">for</span> (offnum = FirstOffsetNumber; offnum &lt;= maxoff; offnum = OffsetNumberNext(offnum))</span><br><span class="line">        &#123;</span><br><span class="line">            ItemId      itemid = PageGetItemId(page, offnum);</span><br><span class="line">            HeapTupleData tuple;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!ItemIdIsNormal(itemid))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            </span><br><span class="line">            tuple.t_data = (HeapTupleHeader) PageGetItem(page, itemid);</span><br><span class="line">            tuple.t_len = ItemIdGetLength(itemid);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* æ£€æŸ¥å…ƒç»„æ˜¯å¦æ­»äº¡ */</span></span><br><span class="line">            <span class="keyword">if</span> (HeapTupleSatisfiesVacuum(&amp;tuple, OldestXmin, buf) == HEAPTUPLE_DEAD)</span><br><span class="line">                tupdead[offnum - <span class="number">1</span>] = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                tupdead[offnum - <span class="number">1</span>] = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* æ‰§è¡Œå®é™…æ¸…ç† */</span></span><br><span class="line">        <span class="keyword">if</span> (PageHardenPrune(page, tupdead, maxoff))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* æ ‡è®°é¡µé¢ä¸ºå…¨å¯è§ï¼ˆå¦‚æœé€‚ç”¨ï¼‰ */</span></span><br><span class="line">            <span class="keyword">if</span> (PageIsAllVisible(page))</span><br><span class="line">                visibilitymap_pin(rel, blkno, &amp;vmbuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        UnlockReleaseBuffer(buf);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ */</span></span><br><span class="line">        vacrelstats-&gt;pages_removed++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (BufferIsValid(vmbuffer))</span><br><span class="line">        ReleaseBuffer(vmbuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è¯¦ç»†å±•ç¤ºäº† PostgreSQL å¦‚ä½•è¯†åˆ«å’Œæ¸…ç†æ­»å…ƒç»„ï¼ŒåŒæ—¶ç»´æŠ¤å¯è§æ€§æ˜ å°„ï¼ˆVisibility Mapï¼‰ä»¥ä¼˜åŒ–åç»­çš„ VACUUM æ“ä½œã€‚</p><h3 id="8-5-æºç æ¶æ„æ€»ç»“ä¸æœ€ä½³å®è·µ"><a href="#8-5-æºç æ¶æ„æ€»ç»“ä¸æœ€ä½³å®è·µ" class="headerlink" title="8.5 æºç æ¶æ„æ€»ç»“ä¸æœ€ä½³å®è·µ"></a>8.5 æºç æ¶æ„æ€»ç»“ä¸æœ€ä½³å®è·µ</h3><h4 id="8-5-1-æºç ç»„ç»‡ç»“æ„"><a href="#8-5-1-æºç ç»„ç»‡ç»“æ„" class="headerlink" title="8.5.1 æºç ç»„ç»‡ç»“æ„"></a>8.5.1 æºç ç»„ç»‡ç»“æ„</h4><p>PostgreSQL çš„æºç ç»„ç»‡ä½“ç°äº†å…¶æ¨¡å—åŒ–è®¾è®¡æ€æƒ³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">â”œâ”€â”€ backend/</span><br><span class="line">â”‚   â”œâ”€â”€ access/          # è®¿é—®æ–¹æ³•ï¼ˆå †è¡¨ã€ç´¢å¼•ç­‰ï¼‰</span><br><span class="line">â”‚   â”œâ”€â”€ catalog/         # ç³»ç»Ÿç›®å½•</span><br><span class="line">â”‚   â”œâ”€â”€ commands/        # SQLå‘½ä»¤å¤„ç†</span><br><span class="line">â”‚   â”œâ”€â”€ executor/        # æŸ¥è¯¢æ‰§è¡Œå™¨</span><br><span class="line">â”‚   â”œâ”€â”€ lib/             # é€šç”¨åº“</span><br><span class="line">â”‚   â”œâ”€â”€ nodes/           # èŠ‚ç‚¹å®šä¹‰å’Œæ“ä½œ</span><br><span class="line">â”‚   â”œâ”€â”€ optimizer/       # æŸ¥è¯¢ä¼˜åŒ–å™¨</span><br><span class="line">â”‚   â”œâ”€â”€ port/            # å¹³å°ç‰¹å®šä»£ç </span><br><span class="line">â”‚   â”œâ”€â”€ postmaster/      # ä¸»è¿›ç¨‹ç®¡ç†</span><br><span class="line">â”‚   â”œâ”€â”€ replication/     # å¤åˆ¶ç›¸å…³</span><br><span class="line">â”‚   â”œâ”€â”€ storage/         # å­˜å‚¨ç®¡ç†</span><br><span class="line">â”‚   â””â”€â”€ utils/           # å·¥å…·å‡½æ•°</span><br><span class="line">â”œâ”€â”€ include/             # å¤´æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ interfaces/          # å®¢æˆ·ç«¯æ¥å£</span><br><span class="line">â””â”€â”€ ports/               # å¹³å°ç§»æ¤ä»£ç </span><br></pre></td></tr></table></figure><p>è¿™ç§ç»“æ„ä½¿å¾—å¼€å‘è€…å¯ä»¥å¿«é€Ÿå®šä½ç‰¹å®šåŠŸèƒ½çš„å®ç°ä»£ç ï¼Œä¹Ÿä¾¿äºæ–°åŠŸèƒ½çš„æ‰©å±•ã€‚  </p><h4 id="8-5-2-æºç é˜…è¯»å»ºè®®"><a href="#8-5-2-æºç é˜…è¯»å»ºè®®" class="headerlink" title="8.5.2 æºç é˜…è¯»å»ºè®®"></a>8.5.2 æºç é˜…è¯»å»ºè®®</h4><p>å¯¹äºæƒ³è¦æ·±å…¥ç†è§£ PostgreSQL æºç çš„å¼€å‘è€…ï¼Œå»ºè®®éµå¾ªä»¥ä¸‹è·¯å¾„ï¼š</p><ol><li><strong>ä»å…¥å£ç‚¹å¼€å§‹</strong>ï¼š<code>src/backend/main/main.c</code>æ˜¯ PostgreSQL çš„ä¸»å…¥å£  </li><li><strong>ç†è§£è¿›ç¨‹æ¨¡å‹</strong>ï¼š<code>postmaster.c</code>å±•ç¤ºäº†å¤šè¿›ç¨‹æ¶æ„çš„å®ç°   </li><li><strong>æŒæ¡å­˜å‚¨åŸºç¡€</strong>ï¼š<code>heapam.c</code>å’Œ<code>bufmgr.c</code>æ˜¯å­˜å‚¨å¼•æ“çš„æ ¸å¿ƒ   </li><li><strong>å­¦ä¹ äº‹åŠ¡ç®¡ç†</strong>ï¼š<code>xact.c</code>å’Œ<code>procarray.c</code>å±•ç¤º MVCC å®ç°   </li><li><strong>ç ”ç©¶æŸ¥è¯¢å¤„ç†</strong>ï¼š<code>planner.c</code>å’Œ<code>executor.c</code>å±•ç¤ºæŸ¥è¯¢ä¼˜åŒ–å’Œæ‰§è¡Œ</li></ol><h4 id="8-5-3-è°ƒè¯•å’Œæ€§èƒ½åˆ†ææŠ€å·§"><a href="#8-5-3-è°ƒè¯•å’Œæ€§èƒ½åˆ†ææŠ€å·§" class="headerlink" title="8.5.3 è°ƒè¯•å’Œæ€§èƒ½åˆ†ææŠ€å·§"></a>8.5.3 è°ƒè¯•å’Œæ€§èƒ½åˆ†ææŠ€å·§</h4><p>åœ¨åˆ†æ PostgreSQL æºç æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŠ€å·§ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘æ—¶å¯ç”¨è°ƒè¯•ç¬¦å·</span></span><br><span class="line">./configure --enable-debug --enable-cassert</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨gdbè°ƒè¯•</span></span><br><span class="line">gdb --args postgres -D data_directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€§èƒ½åˆ†æ</span></span><br><span class="line">perf record -g ./postgres -D data_directory</span><br><span class="line">perf report</span><br><span class="line"></span><br><span class="line"><span class="comment"># æºç æ³¨é‡Šåˆ†æ</span></span><br><span class="line">doxygen  <span class="comment"># ç”Ÿæˆæºç æ–‡æ¡£</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™äº›å·¥å…·ï¼Œå¯ä»¥æ·±å…¥ç†è§£ PostgreSQL çš„å†…éƒ¨å·¥ä½œåŸç†ï¼Œå®šä½æ€§èƒ½ç“¶é¢ˆï¼Œç”šè‡³ä¸ºç¤¾åŒºè´¡çŒ®ä»£ç ã€‚</p><h3 id="8-6-æºç çº§æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹"><a href="#8-6-æºç çº§æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹" class="headerlink" title="8.6 æºç çº§æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹"></a>8.6 æºç çº§æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹</h3><h4 id="8-6-1-ç¼“å†²åŒºç®¡ç†å™¨ä¼˜åŒ–"><a href="#8-6-1-ç¼“å†²åŒºç®¡ç†å™¨ä¼˜åŒ–" class="headerlink" title="8.6.1 ç¼“å†²åŒºç®¡ç†å™¨ä¼˜åŒ–"></a>8.6.1 ç¼“å†²åŒºç®¡ç†å™¨ä¼˜åŒ–</h4><p>åœ¨ PostgreSQL 9.6 ç‰ˆæœ¬ä¸­ï¼Œç¼“å†²åŒºç®¡ç†å™¨è¿›è¡Œäº†é‡å¤§ä¼˜åŒ–ã€‚åŸå§‹çš„ Clock-Sweep ç®—æ³•åœ¨æé«˜å¹¶å‘åœºæ™¯ä¸‹å­˜åœ¨é”ç«äº‰é—®é¢˜ã€‚ä¼˜åŒ–åçš„å®ç°å¼•å…¥äº†åˆ†åŒºé”æœºåˆ¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä¼˜åŒ–å‰ï¼šå…¨å±€é” */</span></span><br><span class="line">LWLockAcquire(BufferMappingLock, LW_EXCLUSIVE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä¼˜åŒ–åï¼šåˆ†åŒºé” */</span></span><br><span class="line">uint32 hash = BufTableHashCode(&amp;tag);</span><br><span class="line">LWLock *partitionLock = BufMappingPartitionLock(hash);</span><br><span class="line">LWLockAcquire(partitionLock, LW_SHARED);</span><br></pre></td></tr></table></figure><p>è¿™ç§ä¼˜åŒ–å°†å…¨å±€é”æ‹†åˆ†ä¸ºå¤šä¸ªåˆ†åŒºé”ï¼Œæ˜¾è‘—æé«˜äº†å¹¶å‘æ€§èƒ½ã€‚åœ¨ TPC-C åŸºå‡†æµ‹è¯•ä¸­ï¼Œè¿™ç§ä¼˜åŒ–ä½¿å¾—æ¯ç§’äº‹åŠ¡å¤„ç†èƒ½åŠ›æå‡äº† 40%ã€‚</p><h4 id="8-6-2-JIT-ç¼–è¯‘ä¼˜åŒ–"><a href="#8-6-2-JIT-ç¼–è¯‘ä¼˜åŒ–" class="headerlink" title="8.6.2 JIT ç¼–è¯‘ä¼˜åŒ–"></a>8.6.2 JIT ç¼–è¯‘ä¼˜åŒ–</h4><p>PostgreSQL 11 å¼•å…¥äº† JIT ç¼–è¯‘æ”¯æŒï¼Œé€šè¿‡ LLVM å°†è¡¨è¾¾å¼ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç ã€‚æ ¸å¿ƒå®ç°åœ¨<code>src/backend/jit/</code>ç›®å½•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">JitCompileExpr</span><span class="params">(ExprState *exprstate)</span></span><br><span class="line">&#123;</span><br><span class="line">    LLVMModuleRef module;</span><br><span class="line">    LLVMValueRef func;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* åˆ›å»ºLLVMæ¨¡å— */</span></span><br><span class="line">    module = LLVMModuleCreateWithName(<span class="string">&quot;expr_jit&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* ç”ŸæˆIRä»£ç  */</span></span><br><span class="line">    func = GenerateExprIR(exprstate, module);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç  */</span></span><br><span class="line">    LLVMExecutionEngineRef engine = LLVMCreateJITCompilerForModule(module);</span><br><span class="line">    <span class="type">void</span> *native_func = LLVMGetPointerToGlobal(engine, func);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æ›¿æ¢è§£é‡Šæ‰§è¡Œå‡½æ•° */</span></span><br><span class="line">    exprstate-&gt;evalfunc = (ExprEvalFunc) native_func;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¤æ‚è¡¨è¾¾å¼è®¡ç®—åœºæ™¯ä¸­ï¼ŒJIT ç¼–è¯‘å¯ä»¥å°†æ€§èƒ½æå‡ 10-100 å€ï¼Œç‰¹åˆ«æ˜¯åœ¨ OLAP å·¥ä½œè´Ÿè½½ä¸­æ•ˆæœæ˜¾è‘—ã€‚</p><h2 id="ä¹ã€ç»“è®ºä¸å±•æœ›"><a href="#ä¹ã€ç»“è®ºä¸å±•æœ›" class="headerlink" title="ä¹ã€ç»“è®ºä¸å±•æœ›"></a>ä¹ã€ç»“è®ºä¸å±•æœ›</h2><p>é€šè¿‡å¯¹ PostgreSQL å¼•æ“çš„æºç æ·±åº¦åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°å…¶å“è¶Šçš„å·¥ç¨‹è®¾è®¡å’Œå®ç°è´¨é‡ã€‚ä»å­˜å‚¨å¼•æ“çš„ MVCC å®ç°åˆ°æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æˆæœ¬æ¨¡å‹ï¼Œä»ç¼“å†²åŒºç®¡ç†çš„ Clock-Sweep ç®—æ³•åˆ°æ‰§è¡Œå¼•æ“çš„ç«å±±æ¨¡å‹ï¼Œæ¯ä¸€ä¸ªç»„ä»¶éƒ½ç»è¿‡äº†ç²¾å¿ƒè®¾è®¡å’ŒæŒç»­ä¼˜åŒ–ã€‚</p><p>PostgreSQL æºç çš„æ¨¡å—åŒ–ç»“æ„å’Œæ¸…æ™°çš„æ¥å£è®¾è®¡ï¼Œä½¿å…¶å…·æœ‰æé«˜çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚è¿™ç§è®¾è®¡å“²å­¦ä¸ä»…ä¿è¯äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä¹Ÿä¸ºç¤¾åŒºè´¡çŒ®å’Œä¼ä¸šå®šåˆ¶æä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨æºç åˆ†æä¸­çœ‹åˆ°çš„ï¼Œæ¯ä¸€ä¸ªå…³é”®å‡½æ•°éƒ½ç»è¿‡äº†æ·±æ€ç†Ÿè™‘ï¼Œå¹³è¡¡äº†æ€§èƒ½ã€å¤æ‚æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><p>æœªæ¥ï¼ŒPostgreSQL å°†ç»§ç»­åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹å‘è¿›è¡Œæºç çº§ä¼˜åŒ–ï¼š</p><ol><li><strong>å‘é‡åŒ–æ‰§è¡Œ</strong>ï¼šé€šè¿‡ SIMD æŒ‡ä»¤é›†ä¼˜åŒ–ï¼Œæå‡ OLAP æŸ¥è¯¢æ€§èƒ½  </li><li><strong>å¼‚æ­¥ I&#x2F;O</strong>ï¼šå‡å°‘ I&#x2F;O ç­‰å¾…æ—¶é—´ï¼Œæé«˜ååé‡  </li><li><strong>æ™ºèƒ½ç´¢å¼•</strong>ï¼šåŸºäºæœºå™¨å­¦ä¹ çš„ç´¢å¼•é€‰æ‹©å’Œä¼˜åŒ–  </li><li><strong>åˆ†å¸ƒå¼æ¶æ„</strong>ï¼šå¢å¼ºåŸç”Ÿåˆ†ç‰‡å’Œåˆ†å¸ƒå¼æŸ¥è¯¢èƒ½åŠ›  </li><li><strong>å†…å­˜ç®¡ç†ä¼˜åŒ–</strong>ï¼šå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæå‡ç¼“å­˜å‘½ä¸­ç‡</li></ol><p>å¯¹äºæ•°æ®åº“å¼€å‘è€…å’Œæ¶æ„å¸ˆè€Œè¨€ï¼Œæ·±å…¥ç†è§£ PostgreSQL æºç ä¸ä»…æ˜¯æŠ€æœ¯æå‡çš„å¿…ç»ä¹‹è·¯ï¼Œæ›´æ˜¯æ„å»ºé«˜æ€§èƒ½ã€é«˜å¯é æ•°æ®åº“åº”ç”¨çš„å…³é”®ã€‚é€šè¿‡æºç çº§åˆ«çš„ä¼˜åŒ–å’Œå®šåˆ¶ï¼Œå¯ä»¥å……åˆ†å‘æŒ¥ PostgreSQL çš„æ½œåŠ›ï¼Œåœ¨å„ç§å¤æ‚åœºæ™¯ä¸‹æä¾›å“è¶Šçš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</p><p>åœ¨å¼€æºæ•°æ®åº“é¢†åŸŸï¼ŒPostgreSQL æºç çš„å·¥ç¨‹è´¨é‡å’Œè®¾è®¡æ€æƒ³ä¸ºå…¶ä»–é¡¹ç›®æ ‘ç«‹äº†æ ‡æ†ã€‚å…¶æŒç»­åˆ›æ–°å’Œç¤¾åŒºé©±åŠ¨çš„å‘å±•æ¨¡å¼ï¼Œç¡®ä¿äº†å®ƒåœ¨æœªæ¥æ•°æ®åº“æŠ€æœ¯æ¼”è¿›ä¸­å°†ç»§ç»­ä¿æŒé¢†å…ˆåœ°ä½ã€‚æ— è®ºæ˜¯ä½œä¸ºå­¦ä¹ èµ„æºè¿˜æ˜¯ç”Ÿäº§ç³»ç»Ÿï¼ŒPostgreSQL æºç éƒ½å€¼å¾—æ¯ä¸€ä½æ•°æ®åº“ä»ä¸šè€…æ·±å…¥ç ”ç©¶å’Œå®è·µã€‚</p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;â€œå½“ä½ ä¸èƒ½ç”¨ç®€å•çš„è¯­è¨€æ¥æè¿°ä¸€ä»¶äº‹æƒ…æ—¶ï¼Œè¯´æ˜ä½ æ²¡å¼„æ‡‚å®ƒã€‚â€ â€”â€”â€”â€”è´¹æ›¼&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨å½“ä»Šæ•°æ®é©±åŠ¨çš„æ—¶ä»£ï¼Œæ•°æ®åº“ç³»ç»Ÿä½œä¸ºä¼ä¸šæ ¸å¿ƒåŸºç¡€è®¾æ–½çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚PostgreSQL ä½œä¸ºä¸–ç•Œä¸Šæœ€å…ˆè¿›çš„å¼€æºå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œå‡­å€Ÿå…¶å“è¶Šçš„ç¨³å®šæ€§ã€å¼ºå¤§çš„åŠŸèƒ½é›†å’Œä¼˜ç§€çš„æ€§èƒ½è¡¨ç°ï¼Œå·²ç»æˆä¸ºä¼—å¤šä¼ä¸šå’Œå¼€å‘è€…çš„é¦–é€‰ã€‚è‡ª 1986 å¹´è¯ç”Ÿä»¥æ¥ï¼ŒPostgreSQL ç»å†äº†è¿‘å››åå¹´çš„å‘å±•å†ç¨‹ï¼Œä»æœ€åˆçš„â€Ingresâ€é¡¹ç›®æ¼”å˜ä¸ºä»Šå¤©åŠŸèƒ½å®Œå¤‡çš„ä¼ä¸šçº§æ•°æ®åº“è§£å†³æ–¹æ¡ˆã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Database" scheme="https://www.wdft.com/categories/Database/"/>
    
    
    <category term="postgresql" scheme="https://www.wdft.com/tags/postgresql/"/>
    
    <category term="postgressql-engine" scheme="https://www.wdft.com/tags/postgressql-engine/"/>
    
  </entry>
  
  <entry>
    <title>postgres å’Œ mysql åœ¨è¯­æ³•çš„åŒºåˆ«ï¼ˆ PostgreSQL 16 vs MySQL 8.0+ï¼Œå…¼å®¹ 2025 å¹´ç°çŠ¶ï¼‰</title>
    <link href="https://www.wdft.com/bd534bb7.html"/>
    <id>https://www.wdft.com/bd534bb7.html</id>
    <published>2025-11-19T14:02:13.000Z</published>
    <updated>2026-01-24T16:45:03.270Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h3 id="postgres-å’Œ-mysql-åœ¨è¯­æ³•çš„åŒºåˆ«ï¼ˆ-PostgreSQL-16-vs-MySQL-8-0-ï¼Œå…¼å®¹-2025-å¹´ç°çŠ¶ï¼‰"><a href="#postgres-å’Œ-mysql-åœ¨è¯­æ³•çš„åŒºåˆ«ï¼ˆ-PostgreSQL-16-vs-MySQL-8-0-ï¼Œå…¼å®¹-2025-å¹´ç°çŠ¶ï¼‰" class="headerlink" title="postgres å’Œ mysql åœ¨è¯­æ³•çš„åŒºåˆ«ï¼ˆ PostgreSQL 16 vs MySQL 8.0+ï¼Œå…¼å®¹ 2025 å¹´ç°çŠ¶ï¼‰"></a>postgres å’Œ mysql åœ¨è¯­æ³•çš„åŒºåˆ«ï¼ˆ PostgreSQL 16 vs MySQL 8.0+ï¼Œå…¼å®¹ 2025 å¹´ç°çŠ¶ï¼‰</h3><p>ä»¥ä¸‹æ˜¯ PostgreSQL ä¸ MySQL åœ¨è¯­æ³•ä¸Šçš„ä¸»è¦åŒºåˆ«æ±‡æ€»ï¼ˆæˆªè‡³ PostgreSQL 16 &#x2F; MySQL 8.0+ï¼Œå…¼å®¹ 2025 å¹´ç°çŠ¶ï¼‰ï¼š</p><span id="more"></span><table><thead><tr><th>ç±»åˆ«</th><th>ç‰¹æ€§</th><th>PostgreSQL(v16)</th><th>MySQL(8+)</th></tr></thead><tbody><tr><td><strong>1. æ•°æ®ç±»å‹</strong></td><td>å¸ƒå°”ç±»å‹</td><td><code>BOOLEAN</code> æˆ– <code>BOOL</code>ï¼ˆåŸç”Ÿæ”¯æŒï¼Œå€¼ï¼š<code>TRUE</code>&#x2F;<code>FALSE</code>&#x2F;<code>NULL</code>ï¼‰</td><td>æ— åŸç”Ÿ <code>BOOLEAN</code>ï¼›<code>BOOL</code>&#x2F;<code>BOOLEAN</code> æ˜¯ <code>TINYINT(1)</code> çš„åˆ«åï¼ˆ0&#x2F;1ï¼‰</td></tr><tr><td></td><td>å­—ç¬¦ä¸²ç±»å‹</td><td><code>TEXT</code>ï¼ˆæ— é•¿åº¦é™åˆ¶ï¼Œæ€§èƒ½ä¸ <code>VARCHAR(n)</code> ç›¸å½“ï¼‰ï¼›<code>VARCHAR(n)</code>ï¼›<code>CHAR(n)</code></td><td><code>TEXT</code>ï¼ˆåˆ† <code>TINYTEXT</code>&#x2F;<code>TEXT</code>&#x2F;<code>MEDIUMTEXT</code>&#x2F;<code>LONGTEXT</code>ï¼‰ï¼›<code>VARCHAR(n)</code> éœ€æŒ‡å®šé•¿åº¦ï¼›<code>CHAR(n)</code></td></tr><tr><td></td><td>è‡ªå¢ä¸»é”®</td><td><code>SERIAL</code>ï¼ˆæ—§ï¼‰æˆ– <code>GENERATED BY DEFAULT AS IDENTITY</code>ï¼ˆSQL æ ‡å‡†ï¼‰</td><td><code>AUTO_INCREMENT</code>ï¼ˆä»…ç”¨äºæ•´å‹åˆ—ï¼Œéœ€é…åˆ <code>PRIMARY KEY</code> æˆ– <code>UNIQUE</code>ï¼‰</td></tr><tr><td></td><td>JSON ç±»å‹</td><td><code>JSON</code>ï¼ˆå­˜å‚¨åŸå§‹æ–‡æœ¬ï¼‰å’Œ <code>JSONB</code>ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼Œæ”¯æŒç´¢å¼•å’Œé«˜æ•ˆæŸ¥è¯¢ï¼‰</td><td><code>JSON</code>ï¼ˆå†…éƒ¨ä»¥äºŒè¿›åˆ¶å­˜å‚¨ï¼Œç±»ä¼¼ <code>JSONB</code>ï¼›æ—  <code>JSONB</code> ç±»å‹ï¼‰</td></tr><tr><td></td><td>æ•°ç»„ç±»å‹</td><td>åŸç”Ÿæ”¯æŒï¼ˆå¦‚ <code>INT[]</code>, <code>TEXT[]</code>ï¼‰ï¼Œå¯ç´¢å¼•ã€æŸ¥è¯¢</td><td>ä¸æ”¯æŒåŸç”Ÿæ•°ç»„ï¼›éœ€ç”¨ JSON æˆ–å†—ä½™è®¾è®¡æ¨¡æ‹Ÿ</td></tr><tr><td></td><td>æšä¸¾ç±»å‹</td><td><code>ENUM</code>ï¼ˆéœ€å…ˆ <code>CREATE TYPE</code> å®šä¹‰ï¼‰</td><td><code>ENUM(&#39;val1&#39;,&#39;val2&#39;,...)</code>ï¼ˆåˆ—å®šä¹‰æ—¶ç›´æ¥å£°æ˜ï¼‰</td></tr><tr><td></td><td>æ—¥æœŸ&#x2F;æ—¶é—´</td><td><code>TIMESTAMP</code> é»˜è®¤ä¸å¸¦æ—¶åŒºï¼›<code>TIMESTAMPTZ</code> å¸¦æ—¶åŒºï¼ˆæ¨èï¼‰</td><td><code>TIMESTAMP</code> é»˜è®¤ <strong>å¸¦æ—¶åŒºè½¬æ¢</strong>ï¼ˆå­˜å‚¨ä¸º UTCï¼Œæ£€ç´¢è½¬ä¸º session æ—¶åŒºï¼‰ï¼›<code>DATETIME</code> æ— æ—¶åŒº</td></tr><tr><td><strong>2. DDLï¼ˆå»ºè¡¨ä¸ä¿®æ”¹ï¼‰</strong></td><td>åˆ›å»ºè‡ªå¢åˆ—</td><td><code>id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY</code> æˆ– <code>SERIAL</code></td><td><code>id INT AUTO_INCREMENT PRIMARY KEY</code></td></tr><tr><td></td><td>ä¿®æ”¹åˆ—é»˜è®¤å€¼</td><td><code>ALTER COLUMN col SET DEFAULT value</code> &#x2F; <code>DROP DEFAULT</code></td><td><code>MODIFY COLUMN col type DEFAULT value</code> æˆ– <code>ALTER COLUMN col SET DEFAULT value</code>ï¼ˆ8.0.13+ æ”¯æŒ <code>ALTER ... SET DEFAULT</code>ï¼‰</td></tr><tr><td></td><td>åˆ é™¤åˆ—é»˜è®¤å€¼</td><td><code>ALTER COLUMN col DROP DEFAULT</code></td><td><code>ALTER COLUMN col DROP DEFAULT</code>ï¼ˆ8.0.13+ï¼‰æˆ– <code>MODIFY COLUMN col type</code></td></tr><tr><td></td><td>ä¿®æ”¹åˆ—ç±»å‹</td><td><code>ALTER COLUMN col TYPE new_type [USING expr]</code>ï¼ˆå¯åŠ  <code>USING</code> è½¬æ¢ï¼‰</td><td><code>MODIFY COLUMN col new_type</code>ï¼ˆéšå¼è½¬æ¢ï¼Œå¤±è´¥åˆ™æŠ¥é”™ï¼‰</td></tr><tr><td></td><td>é‡å‘½ååˆ—</td><td><code>ALTER TABLE t RENAME COLUMN old TO new</code></td><td><code>ALTER TABLE t RENAME COLUMN old TO new</code>ï¼ˆ8.0.4+ï¼‰ï¼›æ—§ç‰ˆç”¨ <code>CHANGE COLUMN</code></td></tr><tr><td></td><td>æ·»åŠ åˆ—å¹¶ç½®ä½ç½®</td><td>ä¸æ”¯æŒæŒ‡å®šåˆ—ä½ç½®ï¼ˆåˆ—é¡ºåºé€»è¾‘æ— å…³ï¼‰</td><td><code>ADD COLUMN col ... AFTER another_col</code> &#x2F; <code>FIRST</code></td></tr><tr><td><strong>3. DMLï¼ˆæŸ¥è¯¢ä¸æ“ä½œï¼‰</strong></td><td>å­—ç¬¦ä¸²æ‹¼æ¥</td><td>&#96;</td><td></td></tr><tr><td></td><td>å­—ç¬¦ä¸²è½¬ä¹‰</td><td><code>&#39;It&#39;&#39;s ok&#39;</code>ï¼ˆæ ‡å‡†å•å¼•å·è½¬ä¹‰ï¼‰</td><td><code>&#39;It&#39;&#39;s ok&#39;</code> æˆ– <code>&#39;It\&#39;s ok&#39;</code>ï¼ˆå–å†³äº <code>NO_BACKSLASH_ESCAPES</code> æ¨¡å¼ï¼‰</td></tr><tr><td></td><td>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</td><td><code>~</code>ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ã€<code>~*</code>ï¼ˆä¸åŒºåˆ†ï¼‰ã€<code>!~</code>&#x2F;<code>!~*</code></td><td><code>REGEXP</code> &#x2F; <code>RLIKE</code>ï¼ˆå¦‚ <code>col REGEXP &#39;pattern&#39;</code>ï¼‰ï¼Œé»˜è®¤ä¸åŒºåˆ†å¤§å°å†™ï¼ˆå–å†³äº collationï¼‰</td></tr><tr><td></td><td>LIMIT&#x2F;OFFSET</td><td><code>LIMIT n OFFSET m</code> æˆ– <code>LIMIT m, n</code>ï¼ˆ<strong>ä¸æ”¯æŒ</strong> <code>m,n</code> è¯­æ³•ï¼‰</td><td>æ”¯æŒ <code>LIMIT n OFFSET m</code> å’Œ <code>LIMIT m, n</code>ï¼ˆ<code>m</code>&#x3D;offset, <code>n</code>&#x3D;countï¼‰</td></tr><tr><td></td><td>è¿”å›æ’å…¥ ID</td><td><code>INSERT ... RETURNING id</code>ï¼ˆæ ‡å‡†ï¼Œå¯è¿”å›ä»»æ„åˆ—ï¼‰</td><td><code>LAST_INSERT_ID()</code> å‡½æ•°ï¼›æˆ– JDBC&#x2F;åº”ç”¨å±‚è·å–ï¼›<code>INSERT ... RETURNING</code>ï¼ˆ8.0.21+ å®éªŒæ€§æ”¯æŒï¼‰</td></tr><tr><td><strong>4. å‡½æ•°ä¸è¡¨è¾¾å¼</strong></td><td>å­—ç¬¦ä¸²å‡½æ•°</td><td><code>LENGTH()</code>ï¼ˆå­—ç¬¦æ•°ï¼‰ã€<code>CHAR_LENGTH()</code> åŒä¹‰ï¼›<code>OCTET_LENGTH()</code>ï¼ˆå­—èŠ‚æ•°ï¼‰</td><td><code>CHAR_LENGTH()</code> &#x2F; <code>LENGTH()</code>ï¼ˆ<strong>å­—èŠ‚æ•°</strong>ï¼æ˜“æ··æ·†ï¼‰ï¼›<code>CHARACTER_LENGTH()</code> åŒä¹‰</td></tr><tr><td></td><td>å½“å‰æ—¶é—´</td><td><code>NOW()</code>, <code>CURRENT_TIMESTAMP</code>, <code>CLOCK_TIMESTAMP()</code>ï¼ˆäº‹åŠ¡&#x2F;è¯­å¥çº§ï¼‰</td><td><code>NOW()</code>, <code>CURRENT_TIMESTAMP</code>, <code>SYSDATE()</code>ï¼ˆ<code>NOW()</code> æ˜¯äº‹åŠ¡å¼€å§‹æ—¶é—´ï¼‰</td></tr><tr><td></td><td>æ¡ä»¶è¡¨è¾¾å¼</td><td><code>CASE WHEN ... THEN ... END</code>ï¼ˆæ ‡å‡†ï¼‰ï¼›æ”¯æŒ <code>NULLIF()</code>, <code>COALESCE()</code></td><td>åŒå·¦ï¼›å¦æ”¯æŒ <code>IF(condition, t, f)</code>ï¼ˆéæ ‡å‡†ï¼‰</td></tr><tr><td></td><td>å­—ç¬¦ä¸²è¿æ¥èšåˆ</td><td><code>STRING_AGG(col, &#39;,&#39;)</code></td><td><code>GROUP_CONCAT(col SEPARATOR &#39;,&#39;)</code></td></tr><tr><td></td><td>çª—å£å‡½æ•°</td><td>å…¨é¢æ”¯æŒï¼ˆ<code>OVER()</code>, <code>PARTITION BY</code>, <code>ROWS/RANGE</code> ç­‰ï¼‰</td><td>8.0+ å…¨é¢æ”¯æŒï¼ˆåŸºæœ¬ä¸ PG ä¸€è‡´ï¼‰</td></tr><tr><td><strong>5. äº‹åŠ¡ä¸é”</strong></td><td>é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«</td><td><code>READ COMMITTED</code></td><td><code>REPEATABLE READ</code></td></tr><tr><td></td><td>å¯é‡å¤è¯»è¡Œä¸º</td><td>åŸºäº MVCCï¼Œå¯èƒ½å‘ç”Ÿå¹»è¯»ï¼ˆéåºåˆ—åŒ–ï¼‰</td><td><strong>åŸºäºé—´éš™é”ï¼ˆGap Lockï¼‰</strong>ï¼Œå®é™…æä¾› <strong>è¿‘ä¼¼ Serializable</strong> çš„å¹»è¯»é˜²æŠ¤ï¼ˆä½†éæ ‡å‡†ï¼‰</td></tr><tr><td></td><td>ä¿å­˜ç‚¹</td><td><code>SAVEPOINT s1; ROLLBACK TO s1;</code></td><td>åŒå·¦</td></tr><tr><td></td><td>æ˜¾å¼é”</td><td><code>SELECT ... FOR UPDATE</code>, <code>FOR SHARE</code>, <code>FOR NO KEY UPDATE</code> ç­‰</td><td><code>SELECT ... FOR UPDATE</code>, <code>FOR SHARE</code>ï¼ˆå³ <code>LOCK IN SHARE MODE</code> åºŸå¼ƒ â†’ <code>FOR SHARE</code>ï¼‰</td></tr><tr><td><strong>6. å…¶ä»–ç‰¹æ€§</strong></td><td>æ¨¡å¼ï¼ˆSchemaï¼‰</td><td><code>CREATE SCHEMA s;</code>ï¼Œé»˜è®¤ <code>public</code>ï¼›å¤š schema æ˜¯ä¸€ç­‰å…¬æ°‘</td><td><code>SCHEMA</code> æ˜¯ <code>DATABASE</code> çš„åŒä¹‰è¯ï¼›å®é™…æ— çœŸæ­£ schema éš”ç¦»ï¼ˆæ¯ä¸ª db ç‹¬ç«‹ï¼‰</td></tr><tr><td></td><td>åºåˆ—ç®¡ç†</td><td><code>CREATE SEQUENCE s; nextval(&#39;s&#39;)</code>, <code>currval(&#39;s&#39;)</code></td><td>æ— ç‹¬ç«‹åºåˆ—å¯¹è±¡ï¼ˆ8.0.16+ å¼•å…¥ <code>CREATE SEQUENCE</code>ï¼Œä½†é›†æˆåº¦ä½ï¼‰</td></tr><tr><td></td><td>CTEï¼ˆå…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼‰</td><td>æ”¯æŒé€’å½’ä¸éé€’å½’ï¼›é»˜è®¤æ˜¯ <strong>ç‰©åŒ–</strong>ï¼ˆå¯åŠ  <code>MATERIALIZED</code>&#x2F;<code>NOT MATERIALIZED</code>ï¼‰</td><td>8.0+ æ”¯æŒï¼›é»˜è®¤ <strong>éç‰©åŒ–</strong>ï¼ˆå†…è”å±•å¼€ï¼‰ï¼Œå¯é€šè¿‡ <code>WITH ... AS MATERIALIZED</code> å¼ºåˆ¶ï¼ˆ8.0.21+ï¼‰</td></tr><tr><td></td><td>JSON æŸ¥è¯¢</td><td><code>-&gt;</code>ï¼ˆè¿”å› JSONï¼‰ã€<code>-&gt;&gt;</code>ï¼ˆè¿”å› textï¼‰ï¼›<code>#&gt;</code>ã€<code>#&gt;&gt;</code>ï¼ˆè·¯å¾„ï¼‰ï¼›<code>@&gt;</code>ï¼ˆåŒ…å«ï¼‰</td><td><code>-&gt;</code>ï¼ˆè¿”å› JSONï¼‰ã€<code>-&gt;&gt;</code>ï¼ˆè¿”å› textï¼‰ï¼›<code>JSON_EXTRACT()</code>ï¼›<code>-&gt;</code> å’Œ <code>-&gt;&gt;</code> 8.0+ æ”¯æŒ</td></tr><tr><td></td><td>å…¨æ–‡æ£€ç´¢</td><td><code>tsvector</code>&#x2F;<code>tsquery</code> ç±»å‹ï¼›<code>to_tsvector()</code>, <code>@@</code> æ“ä½œç¬¦ï¼›æ”¯æŒå¤šè¯­è¨€</td><td><code>FULLTEXT</code> ç´¢å¼•ï¼ˆä»… MyISAM &#x2F; InnoDBï¼‰ï¼›<code>MATCH() AGAINST()</code>ï¼›ä¸­æ–‡æ”¯æŒå¼±</td></tr><tr><td></td><td>æ‰©å±•æ€§</td><td>æ”¯æŒè‡ªå®šä¹‰ç±»å‹ã€å‡½æ•°ï¼ˆC&#x2F;PL&#x2F;pgSQL&#x2F;Python ç­‰ï¼‰ã€æ“ä½œç¬¦ã€ç´¢å¼•æ–¹æ³•ï¼ˆGiST&#x2F;SP-GiST&#x2F;BRINï¼‰</td><td>æ’ä»¶å¼å­˜å‚¨å¼•æ“ï¼›è‡ªå®šä¹‰å‡½æ•°é™ SQL&#x2F;UDFï¼ˆCï¼‰ï¼›JSON&#x2F;åœ°ç†æ‰©å±•è¾ƒå¼±</td></tr></tbody></table><hr><h3 id="âš ï¸-å¸¸è§é™·é˜±ä¸¾ä¾‹ï¼š"><a href="#âš ï¸-å¸¸è§é™·é˜±ä¸¾ä¾‹ï¼š" class="headerlink" title="âš ï¸ å¸¸è§é™·é˜±ä¸¾ä¾‹ï¼š"></a>âš ï¸ å¸¸è§é™·é˜±ä¸¾ä¾‹ï¼š</h3><table><thead><tr><th>åœºæ™¯</th><th>PostgreSQL è¡Œä¸º</th><th>MySQL è¡Œä¸º</th></tr></thead><tbody><tr><td><code>INSERT INTO t (id) VALUES (NULL)</code>ï¼ˆè‡ªå¢åˆ—ï¼‰</td><td><code>SERIAL</code>&#x2F;<code>IDENTITY</code> åˆ—æ’å…¥ <code>NULL</code> â†’ è‡ªåŠ¨ç”Ÿæˆæ–°å€¼</td><td><code>AUTO_INCREMENT</code> åˆ—æ’å…¥ <code>NULL</code> â†’ è‡ªåŠ¨ç”Ÿæˆæ–°å€¼ âœ…ï¼›ä½†è‹¥æ˜¾å¼æ’å…¥ <code>0</code> ä¸” <code>NO_AUTO_VALUE_ON_ZERO</code> æœªå¼€å¯ â†’ ä¹Ÿç”Ÿæˆæ–°å€¼ï¼ˆæ˜“æ··æ·†ï¼‰</td></tr><tr><td><code>GROUP BY</code> éèšåˆåˆ—</td><td>ä¸¥æ ¼ï¼šä»…å…è®¸ <code>GROUP BY</code> åˆ—æˆ–èšåˆå‡½æ•°ï¼ˆé™¤é <code>GROUP BY</code> ä¸»é”®ï¼‰</td><td>é»˜è®¤å®½æ¾ï¼ˆ<code>sql_mode</code> ä¸å« <code>ONLY_FULL_GROUP_BY</code> æ—¶ï¼‰â†’ è¿”å›â€œä»»æ„â€å€¼ï¼Œå¯èƒ½è¯¯å¯¼</td></tr><tr><td><code>&#39;&#39;</code> vs <code>NULL</code></td><td><code>&#39;&#39;</code> æ˜¯ç©ºå­—ç¬¦ä¸² â‰  <code>NULL</code></td><td>åŒå·¦ï¼Œä½†æŸäº›æ—§ç‰ˆæœ¬&#x2F;é…ç½®ä¸‹ <code>INSERT INTO t (char_col) VALUES (&#39;&#39;)</code> å¯èƒ½è½¬ä¸º <code>NULL</code>ï¼ˆè‹¥ <code>NOT NULL</code> ä¸” <code>sql_mode</code> å« <code>STRICT</code> åˆ™æŠ¥é”™ï¼‰</td></tr><tr><td><code>COUNT(NULL)</code></td><td><code>0</code>ï¼ˆå›  <code>NULL</code> ä¸è®¡å…¥ï¼‰</td><td><code>0</code></td></tr></tbody></table><hr><p>âœ… <strong>ç›¸å…³å»ºè®®</strong>ï¼š  </p><ul><li>è¿ç§»æ—¶æ³¨æ„ï¼š<code>LIMIT</code> å†™æ³•ã€å­—ç¬¦ä¸²æ‹¼æ¥ã€æ—¥æœŸæ—¶åŒºã€è‡ªå¢æœºåˆ¶ã€<code>GROUP BY</code> ä¸¥æ ¼æ€§ã€‚  </li><li>å¼€å‘ä¸­ä¼˜å…ˆä½¿ç”¨ <strong>æ ‡å‡† SQL</strong>ï¼ˆå¦‚ <code>STRING_AGG</code> vs <code>GROUP_CONCAT</code> å¯å°è£…é€‚é…å±‚ï¼‰ã€‚  </li><li>MySQL ç”¨æˆ·è½¬ PGï¼šä¹ æƒ¯ <code>RETURNING</code>ã€<code>JSONB</code>ã€æ•°ç»„ã€Schema éš”ç¦»ã€‚  </li><li>PG ç”¨æˆ·è½¬ MySQLï¼šè­¦æƒ• <code>AUTO_INCREMENT</code> é—´éš™ã€<code>DATETIME</code> æ— æ—¶åŒºã€<code>LENGTH()</code> å­—èŠ‚é™·é˜±ã€‚</li></ul><h3 id="é™„-PostgreSQL-æœ€ä½³å®è·µ"><a href="#é™„-PostgreSQL-æœ€ä½³å®è·µ" class="headerlink" title="é™„ PostgreSQL æœ€ä½³å®è·µ"></a>é™„ PostgreSQL æœ€ä½³å®è·µ</h3><h4 id="PostgreSQL-16-å…³é”®é…ç½®å‚æ•°åŠæœ€ä½³å®è·µ"><a href="#PostgreSQL-16-å…³é”®é…ç½®å‚æ•°åŠæœ€ä½³å®è·µ" class="headerlink" title="PostgreSQL 16 å…³é”®é…ç½®å‚æ•°åŠæœ€ä½³å®è·µ"></a>PostgreSQL 16 å…³é”®é…ç½®å‚æ•°åŠæœ€ä½³å®è·µ</h4><h5 id="ä¸€ã€æ ¸å¿ƒé…ç½®æ–‡ä»¶"><a href="#ä¸€ã€æ ¸å¿ƒé…ç½®æ–‡ä»¶" class="headerlink" title="ä¸€ã€æ ¸å¿ƒé…ç½®æ–‡ä»¶"></a>ä¸€ã€æ ¸å¿ƒé…ç½®æ–‡ä»¶</h5><p>PostgreSQL 16 çš„ä¸»è¦é…ç½®æ–‡ä»¶æ˜¯<code>postgresql.conf</code>ï¼Œç”¨äºè°ƒæ•´å„ç§æ€§èƒ½å‚æ•°ï¼Œå¦‚å†…å­˜ä½¿ç”¨ã€è¿æ¥æ•°é™åˆ¶ç­‰ã€‚ å¦å¤–ï¼Œ<code>pg_hba.conf</code>æ–‡ä»¶ç”¨äºè®¾ç½®è®¿é—®æ§åˆ¶ç­–ç•¥ï¼Œæ˜¯å®‰å…¨é…ç½®çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p><h4 id="äºŒã€å…³é”®å†…å­˜é…ç½®å‚æ•°"><a href="#äºŒã€å…³é”®å†…å­˜é…ç½®å‚æ•°" class="headerlink" title="äºŒã€å…³é”®å†…å­˜é…ç½®å‚æ•°"></a>äºŒã€å…³é”®å†…å­˜é…ç½®å‚æ•°</h4><h5 id="1-shared-buffers"><a href="#1-shared-buffers" class="headerlink" title="1. shared_buffers"></a>1. shared_buffers</h5><ul><li><strong>ä½œç”¨</strong>ï¼šè®¾ç½®æ•°æ®åº“æœåŠ¡å™¨ä½¿ç”¨çš„å…±äº«å†…å­˜ç¼“å†²åŒºæ•°é‡ã€‚</li><li><strong>æ¨èå€¼</strong>ï¼šé€šå¸¸è®¾ç½®ä¸ºç³»ç»Ÿæ€»å†…å­˜çš„ 25%ã€‚ä¾‹å¦‚ï¼Œå¯¹äº 16GB å†…å­˜çš„ç³»ç»Ÿï¼Œå»ºè®®è®¾ç½®ä¸º 4GBã€‚</li><li><strong>æ³¨æ„äº‹é¡¹</strong>ï¼šä¿®æ”¹åå¿…é¡»é‡å¯æœåŠ¡å™¨æ‰èƒ½ç”Ÿæ•ˆã€‚</li></ul><h5 id="2-work-mem"><a href="#2-work-mem" class="headerlink" title="2. work_mem"></a>2. work_mem</h5><ul><li><strong>ä½œç”¨</strong>ï¼šè®¾ç½®æŸ¥è¯¢æ“ä½œï¼ˆå¦‚æ’åºæˆ–å“ˆå¸Œè¡¨ï¼‰åœ¨å†™å…¥ä¸´æ—¶ç£ç›˜æ–‡ä»¶ä¹‹å‰å¯ä»¥ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡ã€‚</li><li><strong>æ¨èå€¼</strong>ï¼šé€šå¸¸åœ¨ 10-50MB ä¹‹é—´ï¼Œå…·ä½“å–å†³äºå¹¶å‘è¿æ¥æ•°å’Œå·¥ä½œè´Ÿè½½ã€‚</li><li><strong>è®¡ç®—å…¬å¼</strong>ï¼šwork_mem Ã— max_connections ä¸åº”è¶…è¿‡ç³»ç»Ÿæ€»å†…å­˜çš„ 75%ã€‚</li></ul><h5 id="3-maintenance-work-mem"><a href="#3-maintenance-work-mem" class="headerlink" title="3. maintenance_work_mem"></a>3. maintenance_work_mem</h5><ul><li><strong>ä½œç”¨</strong>ï¼šæ§åˆ¶ç»´æŠ¤æ“ä½œï¼ˆå¦‚ VACUUMã€CREATE INDEX å’Œ ALTER TABLE ADD FOREIGN KEYï¼‰ä½¿ç”¨çš„æœ€å¤§å†…å­˜é‡ã€‚</li><li><strong>æ¨èå€¼</strong>ï¼š<ul><li>ä¸€èˆ¬ç³»ç»Ÿï¼šè®¾ç½®ä¸º 1GB</li><li>32GB ä»¥ä¸Šå†…å­˜ï¼šå»ºè®® 1GB</li><li>64GB ä»¥ä¸Šå†…å­˜ï¼šå»ºè®® 2GB</li><li>128GB ä»¥ä¸Šå†…å­˜ï¼šå»ºè®® 4GB</li></ul></li></ul><h5 id="4-effective-cache-size"><a href="#4-effective-cache-size" class="headerlink" title="4. effective_cache_size"></a>4. effective_cache_size</h5><ul><li><strong>ä½œç”¨</strong>ï¼šå½±å“æŸ¥è¯¢è®¡åˆ’å™¨çš„å†³ç­–ï¼Œè¡¨ç¤ºæ“ä½œç³»ç»Ÿå’Œ PostgreSQL å¯ä»¥ä½¿ç”¨çš„æ€»ç¼“å­˜é‡ã€‚</li><li><strong>æ¨èå€¼</strong>ï¼šé€šå¸¸è®¾ç½®ä¸ºç³»ç»Ÿæ€»å†…å­˜çš„ 75%ã€‚å¦‚æœè®¾ç½®è¿‡ä½ï¼ŒæŸ¥è¯¢è®¡åˆ’å™¨å¯èƒ½ä¼šå¿½ç•¥æŸäº›ç´¢å¼•ã€‚</li></ul><h4 id="ä¸‰ã€è¿æ¥é…ç½®å‚æ•°"><a href="#ä¸‰ã€è¿æ¥é…ç½®å‚æ•°" class="headerlink" title="ä¸‰ã€è¿æ¥é…ç½®å‚æ•°"></a>ä¸‰ã€è¿æ¥é…ç½®å‚æ•°</h4><h5 id="max-connections"><a href="#max-connections" class="headerlink" title="max_connections"></a>max_connections</h5><ul><li><strong>ä½œç”¨</strong>ï¼šè®¾ç½®æ•°æ®åº“æœåŠ¡å™¨å…è®¸çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°ã€‚</li><li><strong>æ¨èå€¼</strong>ï¼šæ ¹æ®å…·ä½“é¡¹ç›®éœ€æ±‚è®¾ç½®ï¼Œé¿å…è®¾ç½®è¿‡é«˜å¯¼è‡´å†…å­˜ä¸è¶³ã€‚</li><li><strong>æœ€ä½³å®è·µ</strong>ï¼šå¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œå»ºè®®ä½¿ç”¨è¿æ¥æ± ï¼ˆå¦‚ pgBouncerï¼‰è€Œä¸æ˜¯ç›´æ¥å¢åŠ  max_connectionsã€‚</li></ul><h5 id="å››ã€WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰ç›¸å…³å‚æ•°"><a href="#å››ã€WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰ç›¸å…³å‚æ•°" class="headerlink" title="å››ã€WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰ç›¸å…³å‚æ•°"></a>å››ã€WALï¼ˆé¢„å†™æ—¥å¿—ï¼‰ç›¸å…³å‚æ•°</h5><p>PostgreSQL 16 é€šè¿‡æ–°çš„æŸ¥è¯¢è§„åˆ’å™¨ä¼˜åŒ–æå‡äº†æ€§èƒ½ï¼ŒåŒ…æ‹¬å¹¶è¡Œæ‰§è¡Œ FULL å’Œ RIGHT è¿æ¥çš„èƒ½åŠ›ã€‚ WAL é…ç½®å¯¹æ•°æ®å®‰å…¨å’Œæ€§èƒ½è‡³å…³é‡è¦ï¼Œéœ€è¦æ ¹æ® I&#x2F;O æ€§èƒ½å’Œæ•°æ®å®‰å…¨éœ€æ±‚è¿›è¡Œè°ƒæ•´ã€‚</p><h4 id="äº”ã€æœ€ä½³å®è·µ"><a href="#äº”ã€æœ€ä½³å®è·µ" class="headerlink" title="äº”ã€æœ€ä½³å®è·µ"></a>äº”ã€æœ€ä½³å®è·µ</h4><h5 id="1-é…ç½®ç®¡ç†"><a href="#1-é…ç½®ç®¡ç†" class="headerlink" title="1. é…ç½®ç®¡ç†"></a>1. é…ç½®ç®¡ç†</h5><ul><li>ä½¿ç”¨ä¸“ç”¨é…ç½®æ–‡ä»¶ï¼šå¯ä»¥å°†å…±äº«é…ç½®æ”¾åœ¨<code>shared.conf</code>ä¸­ï¼Œå†…å­˜ç›¸å…³é…ç½®æ”¾åœ¨<code>memory.conf</code>ä¸­ï¼Œä¾¿äºä¸åŒè§„æ ¼æœåŠ¡å™¨çš„ç»Ÿä¸€ç®¡ç†ã€‚</li><li>ä¿®æ”¹é…ç½®åï¼ŒæŸäº›å‚æ•°éœ€è¦é‡å¯ç”Ÿæ•ˆï¼Œè€Œæœ‰äº›å¯ä»¥é€šè¿‡<code>pg_reload_conf()</code>é‡æ–°åŠ è½½ã€‚</li></ul><h5 id="2-æ€§èƒ½ä¼˜åŒ–"><a href="#2-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="2. æ€§èƒ½ä¼˜åŒ–"></a>2. æ€§èƒ½ä¼˜åŒ–</h5><ul><li><strong>ç¡¬ä»¶åŒ¹é…</strong>ï¼šè°ƒæ•´ PostgreSQL çš„é…ç½®å‚æ•°ä»¥åŒ¹é…æ‚¨çš„ç¡¬ä»¶èµ„æºå’Œå·¥ä½œè´Ÿè½½ã€‚</li><li><strong>ç›‘æ§è°ƒæ•´</strong>ï¼šå®šæœŸç›‘æ§æ•°æ®åº“æ€§èƒ½ï¼Œæ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´å‚æ•°ã€‚</li><li><strong>ç´¢å¼•ä¼˜åŒ–</strong>ï¼šé™¤äº†é…ç½®å‚æ•°ï¼Œåˆç†çš„ç´¢å¼•è®¾è®¡ä¹Ÿæ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®å› ç´ ã€‚</li></ul><h4 id="3-å®‰å…¨é…ç½®"><a href="#3-å®‰å…¨é…ç½®" class="headerlink" title="3. å®‰å…¨é…ç½®"></a>3. å®‰å…¨é…ç½®</h4><ul><li>é…ç½®é€‚å½“çš„å¯†ç ç­–ç•¥ï¼Œé¿å…ä½¿ç”¨å®‰å…¨ç³»æ•°ä½çš„å¯†ç ã€‚</li><li>é™åˆ¶ç½‘ç»œè®¿é—®èŒƒå›´ï¼Œå»ºè®® CIDR å‰ç¼€ä¸å°äº&#x2F;16ï¼Œæœ€å¥½å¤§äº&#x2F;19ã€‚</li><li>å¯ç”¨è®¤è¯å»¶è¿Ÿï¼ˆauth_delay.millisecondsï¼‰æ¥å¢åŠ æš´åŠ›ç ´è§£æ”»å‡»çš„éš¾åº¦ã€‚</li></ul><h5 id="4-å¤‡ä»½ç­–ç•¥"><a href="#4-å¤‡ä»½ç­–ç•¥" class="headerlink" title="4. å¤‡ä»½ç­–ç•¥"></a>4. å¤‡ä»½ç­–ç•¥</h5><ul><li>å®æ–½æ¯æ—¥å…¨é‡å¤‡ä»½ç­–ç•¥ã€‚</li><li>å®šæœŸæ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯ï¼Œå¦‚ä½¿ç”¨å‘½ä»¤ï¼š<code>grep -i error postgresql-16-main.log</code>ã€‚</li></ul><h4 id="å…­ã€é…ç½®è°ƒæ•´æ–¹æ³•"><a href="#å…­ã€é…ç½®è°ƒæ•´æ–¹æ³•" class="headerlink" title="å…­ã€é…ç½®è°ƒæ•´æ–¹æ³•"></a>å…­ã€é…ç½®è°ƒæ•´æ–¹æ³•</h4><p>ä¿®æ”¹ PostgreSQL é…ç½®æœ‰ä¸¤ç§ä¸»è¦æ–¹å¼ï¼š</p><ol><li>ç›´æ¥ç¼–è¾‘<code>postgresql.conf</code>æ–‡ä»¶ã€‚ </li><li>ä½¿ç”¨ SQL å‘½ä»¤ï¼š<code>ALTER SYSTEM SET parameter_name = &#39;value&#39;;</code></li></ol><p>å¯¹äºä¸“ç”¨æ•°æ®åº“æœåŠ¡å™¨ï¼Œå¯ä»¥å°†<code>effective_cache_size</code>è®¾ç½®ä¸ºç³»ç»Ÿæ€»å†…å­˜çš„ 75%ï¼Œå¹¶æ ¹æ®ç‰¹å®šçš„æœåŠ¡å™¨å·¥ä½œè´Ÿè½½è¿›è¡Œè°ƒæ•´ã€‚ é€šè¿‡ PGTune ç­‰å·¥å…·å¯ä»¥ä¸ºé…ç½®å‚æ•°æä¾›ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ã€‚</p><h6 id="æ³¨æ„äº‹é¡¹ï¼šæ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ˜¯æ ¹æ®å®é™…å·¥ä½œè´Ÿè½½è¿›è¡ŒæŒç»­ç›‘æ§å’Œè°ƒæ•´ï¼Œæ²¡æœ‰æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„é…ç½®æ–¹æ¡ˆã€‚"><a href="#æ³¨æ„äº‹é¡¹ï¼šæ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ˜¯æ ¹æ®å®é™…å·¥ä½œè´Ÿè½½è¿›è¡ŒæŒç»­ç›‘æ§å’Œè°ƒæ•´ï¼Œæ²¡æœ‰æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„é…ç½®æ–¹æ¡ˆã€‚" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼šæ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ˜¯æ ¹æ®å®é™…å·¥ä½œè´Ÿè½½è¿›è¡ŒæŒç»­ç›‘æ§å’Œè°ƒæ•´ï¼Œæ²¡æœ‰æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„é…ç½®æ–¹æ¡ˆã€‚"></a>æ³¨æ„äº‹é¡¹ï¼šæ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ˜¯æ ¹æ®å®é™…å·¥ä½œè´Ÿè½½è¿›è¡ŒæŒç»­ç›‘æ§å’Œè°ƒæ•´ï¼Œæ²¡æœ‰æ”¾ä¹‹å››æµ·è€Œçš†å‡†çš„é…ç½®æ–¹æ¡ˆã€‚</h6>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h3 id=&quot;postgres-å’Œ-mysql-åœ¨è¯­æ³•çš„åŒºåˆ«ï¼ˆ-PostgreSQL-16-vs-MySQL-8-0-ï¼Œå…¼å®¹-2025-å¹´ç°çŠ¶ï¼‰&quot;&gt;&lt;a href=&quot;#postgres-å’Œ-mysql-åœ¨è¯­æ³•çš„åŒºåˆ«ï¼ˆ-PostgreSQL-16-vs-MySQL-8-0-ï¼Œå…¼å®¹-2025-å¹´ç°çŠ¶ï¼‰&quot; class=&quot;headerlink&quot; title=&quot;postgres å’Œ mysql åœ¨è¯­æ³•çš„åŒºåˆ«ï¼ˆ PostgreSQL 16 vs MySQL 8.0+ï¼Œå…¼å®¹ 2025 å¹´ç°çŠ¶ï¼‰&quot;&gt;&lt;/a&gt;postgres å’Œ mysql åœ¨è¯­æ³•çš„åŒºåˆ«ï¼ˆ PostgreSQL 16 vs MySQL 8.0+ï¼Œå…¼å®¹ 2025 å¹´ç°çŠ¶ï¼‰&lt;/h3&gt;&lt;p&gt;ä»¥ä¸‹æ˜¯ PostgreSQL ä¸ MySQL åœ¨è¯­æ³•ä¸Šçš„ä¸»è¦åŒºåˆ«æ±‡æ€»ï¼ˆæˆªè‡³ PostgreSQL 16 &amp;#x2F; MySQL 8.0+ï¼Œå…¼å®¹ 2025 å¹´ç°çŠ¶ï¼‰ï¼š&lt;/p&gt;</summary>
    
    
    
    <category term="Database" scheme="https://www.wdft.com/categories/Database/"/>
    
    
    <category term="postgresql" scheme="https://www.wdft.com/tags/postgresql/"/>
    
    <category term="mysql8.x" scheme="https://www.wdft.com/tags/mysql8-x/"/>
    
  </entry>
  
  <entry>
    <title>Peter Thiel&#39;s methodology for going from zero to oneï¼ˆå½¼å¾—Â·è’‚å°”ä» 0 åˆ° 1 çš„æ–¹æ³•è®º(by æ¼”è®²)ï¼‰</title>
    <link href="https://www.wdft.com/e111b800.html"/>
    <id>https://www.wdft.com/e111b800.html</id>
    <published>2025-11-11T14:02:00.000Z</published>
    <updated>2026-01-24T17:47:47.694Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><h3 id="å½¼å¾—Â·è’‚å°”ä»-0-åˆ°-1-çš„æ–¹æ³•è®º-by-æ¼”è®²-ï¼š"><a href="#å½¼å¾—Â·è’‚å°”ä»-0-åˆ°-1-çš„æ–¹æ³•è®º-by-æ¼”è®²-ï¼š" class="headerlink" title="å½¼å¾—Â·è’‚å°”ä» 0 åˆ° 1 çš„æ–¹æ³•è®º(by æ¼”è®²)ï¼š"></a>å½¼å¾—Â·è’‚å°”ä» 0 åˆ° 1 çš„æ–¹æ³•è®º(by æ¼”è®²)ï¼š</h3><h4 id="1-æ¯ä¸€æ¬¡çœŸæ­£é‡è¦çš„åˆ›æ–°éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„"><a href="#1-æ¯ä¸€æ¬¡çœŸæ­£é‡è¦çš„åˆ›æ–°éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„" class="headerlink" title="1. æ¯ä¸€æ¬¡çœŸæ­£é‡è¦çš„åˆ›æ–°éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„"></a>1. æ¯ä¸€æ¬¡çœŸæ­£é‡è¦çš„åˆ›æ–°éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„</h4><p>ä¸‹ä¸€ä¸ªæ‰å…‹ä¼¯æ ¼ä¸ä¼šå†åšç¤¾äº¤ç½‘ç«™ï¼Œä¸‹ä¸€ä¸ªæ‹‰é‡ŒÂ·ä½©å¥‡ä¸ä¼šå†åšæœç´¢ã€‚<br>æ¨¡ä»¿ä¸ä¼šå¸¦æ¥çªç ´ï¼Œä»æ¨¡ä»¿ä¸­å­¦ä¸åˆ°åˆ›æ–°çš„æœ¬è´¨ã€‚</p><span id="more"></span><h4 id="2-å•†ä¸šä¸æ˜¯ç§‘å­¦"><a href="#2-å•†ä¸šä¸æ˜¯ç§‘å­¦" class="headerlink" title="2. å•†ä¸šä¸æ˜¯ç§‘å­¦"></a>2. å•†ä¸šä¸æ˜¯ç§‘å­¦</h4><p>ç§‘å­¦ä¾èµ–å¯é‡å¤æ€§ï¼Œè€ŒçœŸæ­£ä¼Ÿå¤§çš„ä¼ä¸šæ— æ³•é‡å¤ã€‚<br>ä¼ä¸šçš„æœ¬è´¨æ˜¯ç‹¬ç‰¹æ€§ï¼Œä» 0 åˆ° 1ï¼Œè€Œä¸æ˜¯ä» 1 åˆ° Nã€‚</p><h4 id="3-åˆ›ä¸šçš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼šä½ å‘ç°äº†åˆ«äººæ²¡æœ‰çœ‹åˆ°çš„çœŸç›¸å—ï¼Ÿ"><a href="#3-åˆ›ä¸šçš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼šä½ å‘ç°äº†åˆ«äººæ²¡æœ‰çœ‹åˆ°çš„çœŸç›¸å—ï¼Ÿ" class="headerlink" title="3. åˆ›ä¸šçš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼šä½ å‘ç°äº†åˆ«äººæ²¡æœ‰çœ‹åˆ°çš„çœŸç›¸å—ï¼Ÿ"></a>3. åˆ›ä¸šçš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼šä½ å‘ç°äº†åˆ«äººæ²¡æœ‰çœ‹åˆ°çš„çœŸç›¸å—ï¼Ÿ</h4><p>ä½ èƒ½å¦è¯´å‡ºä¸€ä¸ªä½ ç›¸ä¿¡ä½†åˆ«äººä¸è®¤åŒçš„è§‚ç‚¹ã€‚<br>ä¼Ÿå¤§çš„æœºä¼šå¾€å¾€éšè—åœ¨è¿™ç§è¢«å¿½è§†çš„â€œç§˜å¯†â€é‡Œã€‚</p><h4 id="4-ç›®æ ‡åº”æ˜¯å„æ–­ï¼Œè€Œä¸æ˜¯ç«äº‰"><a href="#4-ç›®æ ‡åº”æ˜¯å„æ–­ï¼Œè€Œä¸æ˜¯ç«äº‰" class="headerlink" title="4. ç›®æ ‡åº”æ˜¯å„æ–­ï¼Œè€Œä¸æ˜¯ç«äº‰"></a>4. ç›®æ ‡åº”æ˜¯å„æ–­ï¼Œè€Œä¸æ˜¯ç«äº‰</h4><p>ç«äº‰ä¼šæ¶ˆè€—åˆ©æ¶¦ï¼Œè®©ä½ é™·å…¥åŒè´¨åŒ–ï¼Œè¶ŠåŠªåŠ›è¶Šç´¯ã€‚<br>å„æ–­æ‰ä¼šå¸¦æ¥é•¿æœŸã€ç¨³å®šã€é«˜é¢æ”¶ç›Šã€‚<br>æˆåŠŸå…¬å¸ä¸€å®šç‹¬ç‰¹ï¼Œå¤±è´¥å…¬å¸ä¸€å®šç›¸ä¼¼ã€‚</p><h4 id="5-ç«äº‰ä¼šç¼©çª„è§†é‡"><a href="#5-ç«äº‰ä¼šç¼©çª„è§†é‡" class="headerlink" title="5. ç«äº‰ä¼šç¼©çª„è§†é‡"></a>5. ç«äº‰ä¼šç¼©çª„è§†é‡</h4><p>å½“ä½ æ²‰è¿·äºå‡»è´¥å¯¹æ‰‹æ—¶ï¼Œä¼šå¿½è§†æ›´é‡è¦çš„ä¸œè¥¿ã€‚<br>è®¸å¤šäººç•™åœ¨å…‰é²œä½†ç©ºæ´çš„è·¯å¾„ä¸Šï¼Œåªå› ä¸ºä»–ä»¬çš„èº«ä»½ä¾é™„äºç«äº‰ç»“æœã€‚</p><h4 id="6-ç¤¾ä¼šæ–‡åŒ–å€¾å‘äºå˜²ç¬‘åŸåˆ›ã€å¥–åŠ±æ¨¡ä»¿"><a href="#6-ç¤¾ä¼šæ–‡åŒ–å€¾å‘äºå˜²ç¬‘åŸåˆ›ã€å¥–åŠ±æ¨¡ä»¿" class="headerlink" title="6. ç¤¾ä¼šæ–‡åŒ–å€¾å‘äºå˜²ç¬‘åŸåˆ›ã€å¥–åŠ±æ¨¡ä»¿"></a>6. ç¤¾ä¼šæ–‡åŒ–å€¾å‘äºå˜²ç¬‘åŸåˆ›ã€å¥–åŠ±æ¨¡ä»¿</h4><p>çœŸæ­£æœ‰åŸåˆ›æƒ³æ³•çš„äººå¾€å¾€è¢«è´¨ç–‘å’ŒåŠé˜»ã€‚<br>å¤§ä¼—ä¼šæœ¬èƒ½åœ°è¿½éšè¶‹åŠ¿è€Œä¸æ˜¯æ¢ç´¢æœªçŸ¥ã€‚</p><h4 id="7-ä¸–ç•Œä¸Šä»æœ‰å¤§é‡æœªè¢«æ¢ç´¢çš„å‰æ²¿æœºä¼š"><a href="#7-ä¸–ç•Œä¸Šä»æœ‰å¤§é‡æœªè¢«æ¢ç´¢çš„å‰æ²¿æœºä¼š" class="headerlink" title="7. ä¸–ç•Œä¸Šä»æœ‰å¤§é‡æœªè¢«æ¢ç´¢çš„å‰æ²¿æœºä¼š"></a>7. ä¸–ç•Œä¸Šä»æœ‰å¤§é‡æœªè¢«æ¢ç´¢çš„å‰æ²¿æœºä¼š</h4><p>ä¸ä»…åœ¨ ITï¼Œä¹Ÿåœ¨ç”Ÿç‰©ç§‘æŠ€ã€èˆªç©ºèˆªå¤©ã€ç‰©ç†ä¸–ç•Œçš„æŠ€æœ¯ä¸­ã€‚<br>çœŸæ­£çš„çªç ´ä¸æ˜¯æ‰©å¼ ç°æœ‰æ¨¡å¼ï¼ˆå…¨çƒåŒ–ï¼‰ï¼Œè€Œæ˜¯åˆ›é€ æ–°çš„çºµå‘æŠ€æœ¯å¢é•¿ã€‚</p><h4 id="8-å…¨çƒåŒ–æ˜¯å¤åˆ¶æˆåŠŸï¼ˆä»-1-åˆ°-Nï¼‰ï¼ŒæŠ€æœ¯åˆ›æ–°æ˜¯åˆ›é€ æ–°çš„ä¸œè¥¿ï¼ˆä»-0-åˆ°-1ï¼‰"><a href="#8-å…¨çƒåŒ–æ˜¯å¤åˆ¶æˆåŠŸï¼ˆä»-1-åˆ°-Nï¼‰ï¼ŒæŠ€æœ¯åˆ›æ–°æ˜¯åˆ›é€ æ–°çš„ä¸œè¥¿ï¼ˆä»-0-åˆ°-1ï¼‰" class="headerlink" title="8. å…¨çƒåŒ–æ˜¯å¤åˆ¶æˆåŠŸï¼ˆä» 1 åˆ° Nï¼‰ï¼ŒæŠ€æœ¯åˆ›æ–°æ˜¯åˆ›é€ æ–°çš„ä¸œè¥¿ï¼ˆä» 0 åˆ° 1ï¼‰"></a>8. å…¨çƒåŒ–æ˜¯å¤åˆ¶æˆåŠŸï¼ˆä» 1 åˆ° Nï¼‰ï¼ŒæŠ€æœ¯åˆ›æ–°æ˜¯åˆ›é€ æ–°çš„ä¸œè¥¿ï¼ˆä» 0 åˆ° 1ï¼‰</h4><p>è¿‡å»å‡ åå¹´å…¨çƒåŒ–å¿«äºæŠ€æœ¯è¿›æ­¥ã€‚<br>è¦è®©å‘è¾¾å›½å®¶é‡æ–°è¿›å…¥å¢é•¿å‘¨æœŸï¼Œå¿…é¡»é‡å¯åˆ›æ–°ã€‚  </p><h3 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h3><p>ä½ è¦åšçš„ä¸æ˜¯åŠ å…¥ç«äº‰ï¼Œè€Œæ˜¯é€ƒç¦»ç«äº‰ã€‚<br>è¦å¯»æ‰¾åˆ«äººå¿½ç•¥çš„çœŸé—®é¢˜ï¼Œåšç‹¬ä¸€æ— äºŒçš„äº‹ã€‚<br>çœŸæ­£çš„ä»·å€¼æ¥è‡ªä» 0 åˆ° 1 çš„åˆ›é€ ã€‚  </p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;h3 id=&quot;å½¼å¾—Â·è’‚å°”ä»-0-åˆ°-1-çš„æ–¹æ³•è®º-by-æ¼”è®²-ï¼š&quot;&gt;&lt;a href=&quot;#å½¼å¾—Â·è’‚å°”ä»-0-åˆ°-1-çš„æ–¹æ³•è®º-by-æ¼”è®²-ï¼š&quot; class=&quot;headerlink&quot; title=&quot;å½¼å¾—Â·è’‚å°”ä» 0 åˆ° 1 çš„æ–¹æ³•è®º(by æ¼”è®²)ï¼š&quot;&gt;&lt;/a&gt;å½¼å¾—Â·è’‚å°”ä» 0 åˆ° 1 çš„æ–¹æ³•è®º(by æ¼”è®²)ï¼š&lt;/h3&gt;&lt;h4 id=&quot;1-æ¯ä¸€æ¬¡çœŸæ­£é‡è¦çš„åˆ›æ–°éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„&quot;&gt;&lt;a href=&quot;#1-æ¯ä¸€æ¬¡çœŸæ­£é‡è¦çš„åˆ›æ–°éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„&quot; class=&quot;headerlink&quot; title=&quot;1. æ¯ä¸€æ¬¡çœŸæ­£é‡è¦çš„åˆ›æ–°éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„&quot;&gt;&lt;/a&gt;1. æ¯ä¸€æ¬¡çœŸæ­£é‡è¦çš„åˆ›æ–°éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„&lt;/h4&gt;&lt;p&gt;ä¸‹ä¸€ä¸ªæ‰å…‹ä¼¯æ ¼ä¸ä¼šå†åšç¤¾äº¤ç½‘ç«™ï¼Œä¸‹ä¸€ä¸ªæ‹‰é‡ŒÂ·ä½©å¥‡ä¸ä¼šå†åšæœç´¢ã€‚&lt;br&gt;æ¨¡ä»¿ä¸ä¼šå¸¦æ¥çªç ´ï¼Œä»æ¨¡ä»¿ä¸­å­¦ä¸åˆ°åˆ›æ–°çš„æœ¬è´¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="daily" scheme="https://www.wdft.com/categories/daily/"/>
    
    <category term="business" scheme="https://www.wdft.com/categories/daily/business/"/>
    
    
    <category term="business" scheme="https://www.wdft.com/tags/business/"/>
    
  </entry>
  
  <entry>
    <title>Redis åŸç†è§£æä»¥åŠå…¥é—¨å®è·µæŠ€æœ¯é€‰å‹ä»¥åŠè§£å†³æ–¹æ¡ˆæŒ‡å—</title>
    <link href="https://www.wdft.com/f147dce8.html"/>
    <id>https://www.wdft.com/f147dce8.html</id>
    <published>2025-11-07T15:54:22.000Z</published>
    <updated>2026-01-26T09:45:32.237Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><hr><h2 id="Redis-æ¦‚è¿°"><a href="#Redis-æ¦‚è¿°" class="headerlink" title="Redis æ¦‚è¿°"></a>Redis æ¦‚è¿°</h2><p>Redis ä½œä¸ºå½“ä»Šæœ€æµè¡Œçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå‡­å€Ÿå…¶å“è¶Šçš„æ€§èƒ½å’Œä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼Œå·²æˆä¸ºç°ä»£åº”ç”¨æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„ç»„ä»¶ã€‚<br>æœ¬æ–‡å°†åŸºäº Debian 12 ç¯å¢ƒä» Redis çš„ç‰ˆæœ¬æ¼”è¿›å‡ºå‘ï¼Œå®Œæ•´éƒ¨ç½²æµç¨‹ï¼Œä»å•ä½“åˆ°é›†ç¾¤ï¼Œä»åŸºç¡€é…ç½®åˆ°é«˜çº§åº”ç”¨ï¼Œæœ€åæä¾›å¤šè¯­è¨€å®¢æˆ·ç«¯æ“ä½œç¤ºä¾‹ï¼Œå¸®åŠ©æ–°æ‰‹å…¨é¢å¿«é€ŸæŒæ¡ Redis æŠ€æœ¯æ ˆçš„åŸºæœ¬ä½¿ç”¨ï¼Œæœ‰ä¸ªç›¸å¯¹åŸºç¡€çš„æ€è·¯ã€‚</p><span id="more"></span><h2 id="ä¸€ã€Redis-ç‰ˆæœ¬å†å²ä¸ç‰¹æ€§æ¼”è¿›"><a href="#ä¸€ã€Redis-ç‰ˆæœ¬å†å²ä¸ç‰¹æ€§æ¼”è¿›" class="headerlink" title="ä¸€ã€Redis ç‰ˆæœ¬å†å²ä¸ç‰¹æ€§æ¼”è¿›"></a>ä¸€ã€Redis ç‰ˆæœ¬å†å²ä¸ç‰¹æ€§æ¼”è¿›</h2><h3 id="1-1-å¼€æºåè®®çš„é‡å¤§å˜åŒ–"><a href="#1-1-å¼€æºåè®®çš„é‡å¤§å˜åŒ–" class="headerlink" title="1.1 å¼€æºåè®®çš„é‡å¤§å˜åŒ–"></a>1.1 å¼€æºåè®®çš„é‡å¤§å˜åŒ–</h3><p>2024 å¹´ 3 æœˆ 20 æ—¥ï¼ŒRedis Labs å®£å¸ƒä» Redis 7.4 å¼€å§‹ï¼Œå°†åŸå…ˆå®½æ¾çš„ BSD ä¸‰æ¡æ¬¾è®¸å¯ä¿®æ”¹ä¸º Redis Source Available Licenseï¼ˆRSALv2ï¼‰å’Œ Server Side Public Licenseï¼ˆSSPLv1ï¼‰åŒé‡è®¸å¯åè®®ã€‚ è¿™ä¸€å˜åŒ–æ„å‘³ç€ Redis 7.4 åŠä»¥ä¸Šç‰ˆæœ¬ä¸å†ç¬¦åˆ OSIï¼ˆå¼€æ”¾æºä»£ç ä¿ƒè¿›ä¼šï¼‰å®šä¹‰çš„å¼€æºæ ‡å‡†ï¼Œå¯¹å•†ä¸šä½¿ç”¨åœºæ™¯äº§ç”Ÿäº†æ·±è¿œå½±å“ã€‚</p><h3 id="1-2-ä¸»è¦ç‰ˆæœ¬ç‰¹æ€§æ¦‚è§ˆ"><a href="#1-2-ä¸»è¦ç‰ˆæœ¬ç‰¹æ€§æ¦‚è§ˆ" class="headerlink" title="1.2 ä¸»è¦ç‰ˆæœ¬ç‰¹æ€§æ¦‚è§ˆ"></a>1.2 ä¸»è¦ç‰ˆæœ¬ç‰¹æ€§æ¦‚è§ˆ</h3><h4 id="Redis-7-0-å†å²æ€§å˜é©"><a href="#Redis-7-0-å†å²æ€§å˜é©" class="headerlink" title="Redis 7.0 - å†å²æ€§å˜é©"></a>Redis 7.0 - å†å²æ€§å˜é©</h4><ul><li><strong>ç»Ÿä¸€å‘å¸ƒç­–ç•¥</strong>ï¼šRedis 7.0 å¼•å…¥äº† Unified Redis Release ç»Ÿä¸€å‘å¸ƒç­–ç•¥ï¼Œè¿™æ˜¯ Redis å†å²ä¸Šæ”¹å˜æœ€å¤šçš„å¤§ç‰ˆæœ¬ã€‚</li><li><strong>50+ æ–°å‘½ä»¤</strong>ï¼šåŒ…å«å¤§é‡æ ¸å¿ƒæ–°ç‰¹æ€§å’Œæ”¹è¿›ï¼Œæ˜¾è‘—æå‡æ€§èƒ½ã€åŠŸèƒ½å’Œå¯é æ€§ã€‚</li><li><strong>AOF å­˜å‚¨ä¼˜åŒ–</strong>ï¼šå°† AOF æ–‡ä»¶çš„å­˜å‚¨æ–¹å¼æ”¹ä¸ºåœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹å­˜å‚¨å¤šä¸ªæ–‡ä»¶ï¼Œæå‡å†™å…¥æ€§èƒ½ã€‚</li><li><strong>RDB ç‰ˆæœ¬å‡çº§</strong>ï¼šå°†æŒä¹…åŒ–æ–‡ä»¶ RDB çš„ç‰ˆæœ¬å‡çº§ä¸º 10ï¼Œä¸ä¹‹å‰çš„ RDB æ–‡ä»¶ç‰ˆæœ¬ä¸å…¼å®¹ã€‚</li></ul><h4 id="Redis-7-2-å®¢æˆ·ç«¯ç¼“å­˜å¢å¼º"><a href="#Redis-7-2-å®¢æˆ·ç«¯ç¼“å­˜å¢å¼º" class="headerlink" title="Redis 7.2 - å®¢æˆ·ç«¯ç¼“å­˜å¢å¼º"></a>Redis 7.2 - å®¢æˆ·ç«¯ç¼“å­˜å¢å¼º</h4><ul><li><strong>Client-Side Caching</strong>ï¼šå®¢æˆ·ç«¯ç¼“å­˜åŠŸèƒ½å¤§å¹…é™ä½ç½‘ç»œå»¶è¿Ÿï¼Œæå‡è¯»å–æ€§èƒ½ã€‚</li><li><strong>åœ°ç†ç©ºé—´æŸ¥è¯¢æ”¹è¿›</strong>ï¼šä¼˜åŒ–åœ°ç†ç©ºé—´æ•°æ®æ“ä½œï¼Œæ”¯æŒæ›´å¤æ‚çš„åœ°ç†ä½ç½®è®¡ç®—ã€‚</li><li><strong>JSON æ•°æ®æ“ä½œç®€åŒ–</strong>ï¼šæä¾›æ›´ç®€æ´çš„ JSON æ•°æ®å¤„ç†æ¥å£ã€‚</li></ul><h4 id="Redis-7-4-ä¼ä¸šçº§ç‰¹æ€§"><a href="#Redis-7-4-ä¼ä¸šçº§ç‰¹æ€§" class="headerlink" title="Redis 7.4 - ä¼ä¸šçº§ç‰¹æ€§"></a>Redis 7.4 - ä¼ä¸šçº§ç‰¹æ€§</h4><ul><li><strong>å“ˆå¸Œå­—æ®µè¿‡æœŸ</strong>ï¼šæ”¯æŒå¯¹å“ˆå¸Œè¡¨ä¸­çš„å•ä¸ªå­—æ®µè®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</li><li><strong>æŒ‡æ ‡æµå¼•æ“é¢„è§ˆ</strong>ï¼šæä¾›å®æ—¶ç›‘æ§å’Œåˆ†æèƒ½åŠ›ã€‚</li><li><strong>é›†ç¾¤ç®¡ç† API å¢å¼º</strong>ï¼šæ–°å¢ç”¨äºæ£€æŸ¥æ•°æ®åº“å¯ç”¨æ€§ã€é‡æ–°å¹³è¡¡åˆ†ç‰‡ã€æ•…éšœè½¬ç§»åˆ†ç‰‡å’Œæ§åˆ¶æ•°æ®åº“æµé‡çš„ APIã€‚</li></ul><h2 id="äºŒã€Redis-åŸºæœ¬éƒ¨ç½²"><a href="#äºŒã€Redis-åŸºæœ¬éƒ¨ç½²" class="headerlink" title="äºŒã€Redis åŸºæœ¬éƒ¨ç½²"></a>äºŒã€Redis åŸºæœ¬éƒ¨ç½²</h2><ul><li>ç³»ç»Ÿæµ‹è¯•ç¯å¢ƒï¼šDebian 12</li><li>Rediså½“å‰ç¨³å®šç‰ˆæœ¬ï¼šRedis 7.4</li></ul><h3 id="2-1-ç³»ç»Ÿç¯å¢ƒå‡†å¤‡"><a href="#2-1-ç³»ç»Ÿç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1 ç³»ç»Ÿç¯å¢ƒå‡†å¤‡"></a>2.1 ç³»ç»Ÿç¯å¢ƒå‡†å¤‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°ç³»ç»ŸåŒ…åˆ—è¡¨</span></span><br><span class="line">sudo apt update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…åŸºç¡€ä¾èµ–</span></span><br><span class="line">sudo apt install -y build-essential libssl-dev libsystemd-dev</span><br></pre></td></tr></table></figure><h3 id="2-2-å®‰è£…-Redis"><a href="#2-2-å®‰è£…-Redis" class="headerlink" title="2.2 å®‰è£… Redis"></a>2.2 å®‰è£… Redis</h3><h4 id="æ–¹æ³•ä¸€ï¼šAPT-å®˜æ–¹ä»“åº“å®‰è£…ï¼ˆæ¨èï¼‰"><a href="#æ–¹æ³•ä¸€ï¼šAPT-å®˜æ–¹ä»“åº“å®‰è£…ï¼ˆæ¨èï¼‰" class="headerlink" title="æ–¹æ³•ä¸€ï¼šAPT å®˜æ–¹ä»“åº“å®‰è£…ï¼ˆæ¨èï¼‰"></a>æ–¹æ³•ä¸€ï¼šAPT å®˜æ–¹ä»“åº“å®‰è£…ï¼ˆæ¨èï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… Redis æœåŠ¡å™¨</span></span><br><span class="line">sudo apt install -y redis-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å®‰è£…çŠ¶æ€</span></span><br><span class="line">sudo systemctl status redis-server</span><br></pre></td></tr></table></figure><p>Redis å®‰è£…å®Œæˆåï¼Œé»˜è®¤å·²å¯åŠ¨å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ã€‚</p><h4 id="æ–¹æ³•äºŒï¼šæºç ç¼–è¯‘å®‰è£…ï¼ˆå®šåˆ¶éœ€æ±‚ï¼‰"><a href="#æ–¹æ³•äºŒï¼šæºç ç¼–è¯‘å®‰è£…ï¼ˆå®šåˆ¶éœ€æ±‚ï¼‰" class="headerlink" title="æ–¹æ³•äºŒï¼šæºç ç¼–è¯‘å®‰è£…ï¼ˆå®šåˆ¶éœ€æ±‚ï¼‰"></a>æ–¹æ³•äºŒï¼šæºç ç¼–è¯‘å®‰è£…ï¼ˆå®šåˆ¶éœ€æ±‚ï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…ç¼–è¯‘ä¾èµ–</span></span><br><span class="line">sudo apt install -y wget tar make gcc</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ Redis æºç </span></span><br><span class="line">wget https://download.redis.io/redis-stable.tar.gz</span><br><span class="line">tar -xzvf redis-stable.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-stable</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘å®‰è£…</span></span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯å®‰è£…</span></span><br><span class="line">redis-server --version</span><br></pre></td></tr></table></figure><p>åœ¨ Debian 12 (Bookworm) ä¸Šæ„å»ºå¹¶è¿è¡Œ Redis å¼€æºç‰ˆéœ€è¦å…ˆå®‰è£…æ‰€éœ€ä¾èµ–é¡¹ï¼Œç„¶åä¸‹è½½å¹¶æå– Redis æºä»£ç è¿›è¡Œæ„å»ºã€‚</p><h2 id="ä¸‰ã€Redis-æ ¸å¿ƒåŸç†ä¸ç‰¹æ€§"><a href="#ä¸‰ã€Redis-æ ¸å¿ƒåŸç†ä¸ç‰¹æ€§" class="headerlink" title="ä¸‰ã€Redis æ ¸å¿ƒåŸç†ä¸ç‰¹æ€§"></a>ä¸‰ã€Redis æ ¸å¿ƒåŸç†ä¸ç‰¹æ€§</h2><h3 id="3-1-æ ¸å¿ƒæ¶æ„åŸç†"><a href="#3-1-æ ¸å¿ƒæ¶æ„åŸç†" class="headerlink" title="3.1 æ ¸å¿ƒæ¶æ„åŸç†"></a>3.1 æ ¸å¿ƒæ¶æ„åŸç†</h3><p>Redis é‡‡ç”¨å•çº¿ç¨‹äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œé€šè¿‡ I&#x2F;O å¤šè·¯å¤ç”¨æŠ€æœ¯å®ç°é«˜å¹¶å‘å¤„ç†ã€‚å…¶æ ¸å¿ƒæ¶æ„åŒ…å«ï¼š</p><ul><li><strong>äº‹ä»¶å¾ªç¯</strong>ï¼šå¤„ç†å®¢æˆ·ç«¯è¿æ¥ã€å‘½ä»¤æ‰§è¡Œã€å®šæ—¶ä»»åŠ¡</li><li><strong>å†…å­˜ç®¡ç†</strong>ï¼šé«˜æ•ˆçš„å†…å­˜åˆ†é…å™¨å’Œå¯¹è±¡å…±äº«æœºåˆ¶</li><li><strong>æŒä¹…åŒ–æœºåˆ¶</strong>ï¼šRDB å¿«ç…§å’Œ AOF æ—¥å¿—ä¸¤ç§æŒä¹…åŒ–æ–¹å¼</li><li><strong>å¤åˆ¶æœºåˆ¶</strong>ï¼šä¸»ä»å¤åˆ¶ä¿è¯æ•°æ®é«˜å¯ç”¨</li></ul><h3 id="3-2-æ•°æ®ç±»å‹ä¸åº”ç”¨åœºæ™¯"><a href="#3-2-æ•°æ®ç±»å‹ä¸åº”ç”¨åœºæ™¯" class="headerlink" title="3.2 æ•°æ®ç±»å‹ä¸åº”ç”¨åœºæ™¯"></a>3.2 æ•°æ®ç±»å‹ä¸åº”ç”¨åœºæ™¯</h3><table><thead><tr><th>æ•°æ®ç±»å‹</th><th>ç‰¹ç‚¹</th><th>å…¸å‹åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>String</td><td>ç®€å•é”®å€¼å¯¹ï¼Œæ”¯æŒ INCR&#x2F;DECR</td><td>è®¡æ•°å™¨ã€ç¼“å­˜ã€åˆ†å¸ƒå¼é”</td></tr><tr><td>Hash</td><td>å­—æ®µ-å€¼æ˜ å°„è¡¨</td><td>å¯¹è±¡å­˜å‚¨ã€ç”¨æˆ·ä¿¡æ¯</td></tr><tr><td>List</td><td>åŒå‘é“¾è¡¨</td><td>æ¶ˆæ¯é˜Ÿåˆ—ã€æœ€æ–°æ¶ˆæ¯åˆ—è¡¨</td></tr><tr><td>Set</td><td>æ— åºé›†åˆï¼Œå…ƒç´ å”¯ä¸€</td><td>æ ‡ç­¾ç³»ç»Ÿã€å¥½å‹å…³ç³»</td></tr><tr><td>Sorted Set</td><td>æœ‰åºé›†åˆï¼ŒæŒ‰åˆ†æ•°æ’åº</td><td>æ’è¡Œæ¦œã€ä¼˜å…ˆçº§é˜Ÿåˆ—</td></tr><tr><td>Bitmap</td><td>ä½å›¾æ“ä½œ</td><td>ç”¨æˆ·ç­¾åˆ°ã€æ´»è·ƒåº¦åˆ†æ</td></tr><tr><td>HyperLogLog</td><td>åŸºæ•°ç»Ÿè®¡</td><td>UV ç»Ÿè®¡ã€æ•°æ®å»é‡</td></tr></tbody></table><h2 id="å››ã€redis-conf-è¯¦ç»†é…ç½®è§£æ"><a href="#å››ã€redis-conf-è¯¦ç»†é…ç½®è§£æ" class="headerlink" title="å››ã€redis.conf è¯¦ç»†é…ç½®è§£æ"></a>å››ã€redis.conf è¯¦ç»†é…ç½®è§£æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis é…ç½®æ–‡ä»¶è¯¦ç»†ä¸­æ–‡æ³¨é‡Š</span></span><br><span class="line"><span class="comment"># é€‚ç”¨äº Redis 7.x ç‰ˆæœ¬</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== åŸºæœ¬é…ç½® ========================</span></span><br><span class="line"><span class="comment"># ç»‘å®š IP åœ°å€ï¼Œæ³¨é‡Šæ‰æˆ–è®¾ç½®ä¸º 0.0.0.0 å…è®¸è¿œç¨‹è®¿é—®</span></span><br><span class="line"><span class="comment"># é»˜è®¤åªå…è®¸æœ¬åœ°è®¿é—®ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦æ ¹æ®å®‰å…¨ç­–ç•¥é…ç½®</span></span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1 ::1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿æŠ¤æ¨¡å¼ï¼Œå½“æ²¡æœ‰è®¾ç½®å¯†ç ä¸”åªç»‘å®š 127.0.0.1 æ—¶å¯ç”¨</span></span><br><span class="line">protected-mode <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡ç«¯å£å·</span></span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># TCP è¿æ¥ backlog é˜Ÿåˆ—å¤§å°</span></span><br><span class="line">tcp-backlog 511</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¶…æ—¶æ—¶é—´ï¼Œ0 è¡¨ç¤ºæ°¸ä¸è¶…æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰</span></span><br><span class="line"><span class="built_in">timeout</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># TCP keepalive æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰</span></span><br><span class="line">tcp-keepalive 300</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== å®ˆæŠ¤è¿›ç¨‹é…ç½® ========================</span></span><br><span class="line"><span class="comment"># æ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œ</span></span><br><span class="line">daemonize no</span><br><span class="line"></span><br><span class="line"><span class="comment"># PID æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">pidfile /var/run/redis/redis-server.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—çº§åˆ«ï¼šdebug, verbose, notice, warning</span></span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">logfile /var/log/redis/redis-server.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== å†…å­˜ç®¡ç† ========================</span></span><br><span class="line"><span class="comment"># æœ€å¤§å†…å­˜é™åˆ¶ï¼Œ0 è¡¨ç¤ºæ— é™åˆ¶ï¼ˆå•ä½ï¼šbytesï¼‰</span></span><br><span class="line">maxmemory 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œå½“è¾¾åˆ° maxmemory æ—¶è§¦å‘</span></span><br><span class="line"><span class="comment"># noeviction: ä¸æ·˜æ±°ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line"><span class="comment"># allkeys-lru: æ‰€æœ‰ key çš„ LRU æ·˜æ±°</span></span><br><span class="line"><span class="comment"># volatile-lru: ä»…å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key è¿›è¡Œ LRU æ·˜æ±°</span></span><br><span class="line"><span class="comment"># allkeys-random: æ‰€æœ‰ key çš„éšæœºæ·˜æ±°</span></span><br><span class="line"><span class="comment"># volatile-random: ä»…å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key è¿›è¡Œéšæœºæ·˜æ±°</span></span><br><span class="line"><span class="comment"># volatile-ttl: ä¼˜å…ˆæ·˜æ±°å‰©ä½™æ—¶é—´çŸ­çš„ key</span></span><br><span class="line">maxmemory-policy noeviction</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== æŒä¹…åŒ–é…ç½® ========================</span></span><br><span class="line"><span class="comment"># RDB æŒä¹…åŒ–é…ç½®</span></span><br><span class="line"><span class="comment"># æ ¼å¼ï¼šsave &lt;ç§’æ•°&gt; &lt;å˜åŒ–æ¬¡æ•°&gt;</span></span><br><span class="line"><span class="comment"># 900 ç§’å†…æœ‰ 1 æ¬¡å˜åŒ–åˆ™ä¿å­˜</span></span><br><span class="line"><span class="comment"># 300 ç§’å†…æœ‰ 10 æ¬¡å˜åŒ–åˆ™ä¿å­˜</span></span><br><span class="line"><span class="comment"># 60 ç§’å†…æœ‰ 10000 æ¬¡å˜åŒ–åˆ™ä¿å­˜</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># RDB æ–‡ä»¶å</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># RDB æ–‡ä»¶ä¿å­˜ç›®å½•</span></span><br><span class="line"><span class="built_in">dir</span> /var/lib/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF æŒä¹…åŒ–é…ç½®</span></span><br><span class="line"><span class="comment"># æ˜¯å¦å¯ç”¨ AOF</span></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF æ–‡ä»¶å</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AOF åŒæ­¥ç­–ç•¥</span></span><br><span class="line"><span class="comment"># always: æ¯æ¬¡å†™æ“ä½œéƒ½åŒæ­¥ï¼ˆæœ€å®‰å…¨ï¼Œæ€§èƒ½æœ€å·®ï¼‰</span></span><br><span class="line"><span class="comment"># everysec: æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼ˆæ¨èï¼Œå¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½ï¼‰</span></span><br><span class="line"><span class="comment"># no: ç”±æ“ä½œç³»ç»Ÿå†³å®šï¼ˆæ€§èƒ½æœ€å¥½ï¼Œå®‰å…¨æ€§æœ€å·®ï¼‰</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== å®‰å…¨é…ç½® ========================</span></span><br><span class="line"><span class="comment"># è®¿é—®å¯†ç ï¼Œå»ºè®®è®¾ç½®å¼ºå¯†ç </span></span><br><span class="line">requirepass your_strong_password_here</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘½ä»¤é‡å‘½åï¼Œç”¨äºç¦ç”¨å±é™©å‘½ä»¤</span></span><br><span class="line"><span class="comment"># rename-command FLUSHDB &quot;&quot;</span></span><br><span class="line"><span class="comment"># rename-command FLUSHALL &quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== é›†ç¾¤é…ç½® ========================</span></span><br><span class="line"><span class="comment"># æ˜¯å¦å¯ç”¨é›†ç¾¤æ¨¡å¼</span></span><br><span class="line">cluster-enabled no</span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤é…ç½®æ–‡ä»¶</span></span><br><span class="line">cluster-config-file nodes-6379.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== å®¢æˆ·ç«¯é…ç½® ========================</span></span><br><span class="line"><span class="comment"># æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°</span></span><br><span class="line">maxclients 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºé™åˆ¶</span></span><br><span class="line"><span class="comment"># æ ¼å¼ï¼šclient-output-buffer-limit &lt;ç±»åˆ«&gt; &lt;ç¡¬é™åˆ¶&gt; &lt;è½¯é™åˆ¶&gt; &lt;è½¯é™åˆ¶æ—¶é—´&gt;</span></span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line"></span><br><span class="line"><span class="comment"># ======================== æ€§èƒ½è°ƒä¼˜ ========================</span></span><br><span class="line"><span class="comment"># å“ˆå¸Œè¡¨å°å¯¹è±¡ä¼˜åŒ–</span></span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—è¡¨å°å¯¹è±¡ä¼˜åŒ–</span></span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†åˆå°å¯¹è±¡ä¼˜åŒ–</span></span><br><span class="line">set-max-intset-entries 512</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ‰åºé›†åˆå°å¯¹è±¡ä¼˜åŒ–</span></span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ´»è·ƒç¢ç‰‡æ•´ç†</span></span><br><span class="line">activedefrag <span class="built_in">yes</span></span><br></pre></td></tr></table></figure><p>æ‰¾åˆ° <code>bind 127.0.0.1 ::1</code> é…ç½®é¡¹ï¼Œå°†å…¶æ³¨é‡Šæ‰æˆ–ä¿®æ”¹ä¸ºå…è®¸çš„ IP åœ°å€ï¼Œç„¶åä¿å­˜å¹¶é‡å¯ Redis æœåŠ¡ã€‚</p><h2 id="äº”ã€ä»å•ä½“åˆ°é›†ç¾¤ï¼šRedis-é«˜å¯ç”¨æ¶æ„"><a href="#äº”ã€ä»å•ä½“åˆ°é›†ç¾¤ï¼šRedis-é«˜å¯ç”¨æ¶æ„" class="headerlink" title="äº”ã€ä»å•ä½“åˆ°é›†ç¾¤ï¼šRedis é«˜å¯ç”¨æ¶æ„"></a>äº”ã€ä»å•ä½“åˆ°é›†ç¾¤ï¼šRedis é«˜å¯ç”¨æ¶æ„</h2><h3 id="5-1-å•ä½“æ¶æ„éƒ¨ç½²"><a href="#5-1-å•ä½“æ¶æ„éƒ¨ç½²" class="headerlink" title="5.1 å•ä½“æ¶æ„éƒ¨ç½²"></a>5.1 å•ä½“æ¶æ„éƒ¨ç½²</h3><p>å•ä½“æ¶æ„é€‚ç”¨äºå°å‹åº”ç”¨æˆ–å¼€å‘ç¯å¢ƒï¼Œé…ç½®ç®€å•ï¼Œç»´æŠ¤æˆæœ¬ä½ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å•ä½“ Redis é…ç½®è¦ç‚¹</span></span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0              <span class="comment"># å…è®¸è¿œç¨‹è®¿é—®</span></span><br><span class="line">protected-mode no         <span class="comment"># å…³é—­ä¿æŠ¤æ¨¡å¼</span></span><br><span class="line">requirepass your_password <span class="comment"># è®¾ç½®å¼ºå¯†ç </span></span><br><span class="line">maxmemory 2gb             <span class="comment"># è®¾ç½®å†…å­˜é™åˆ¶</span></span><br><span class="line">maxmemory-policy allkeys-lru  <span class="comment"># LRU æ·˜æ±°ç­–ç•¥</span></span><br></pre></td></tr></table></figure><h3 id="5-2-ä¸»ä»å¤åˆ¶æ¶æ„"><a href="#5-2-ä¸»ä»å¤åˆ¶æ¶æ„" class="headerlink" title="5.2 ä¸»ä»å¤åˆ¶æ¶æ„"></a>5.2 ä¸»ä»å¤åˆ¶æ¶æ„</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸»èŠ‚ç‚¹é…ç½®ï¼ˆmaster.confï¼‰</span></span><br><span class="line">port 6379</span><br><span class="line">requirepass master_password</span><br><span class="line">masterauth slave_password  <span class="comment"># ç”¨äºä»èŠ‚ç‚¹éªŒè¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»èŠ‚ç‚¹é…ç½®ï¼ˆslave.confï¼‰</span></span><br><span class="line">port 6380</span><br><span class="line">slaveof 192.168.1.100 6379  <span class="comment"># ä¸»èŠ‚ç‚¹åœ°å€</span></span><br><span class="line">masterauth master_password  <span class="comment"># ä¸»èŠ‚ç‚¹å¯†ç </span></span><br><span class="line">requirepass slave_password  <span class="comment"># ä»èŠ‚ç‚¹å¯†ç </span></span><br></pre></td></tr></table></figure><h3 id="5-3-Redis-Cluster-é›†ç¾¤éƒ¨ç½²"><a href="#5-3-Redis-Cluster-é›†ç¾¤éƒ¨ç½²" class="headerlink" title="5.3 Redis Cluster é›†ç¾¤éƒ¨ç½²"></a>5.3 Redis Cluster é›†ç¾¤éƒ¨ç½²</h3><p>Redis é›†ç¾¤éœ€è¦è‡³å°‘ 6 ä¸ªèŠ‚ç‚¹ï¼ˆ3 ä¸» 3 ä»ï¼‰æ‰èƒ½ä¿è¯é«˜å¯ç”¨æ€§ã€‚</p><h4 id="éƒ¨ç½²æ­¥éª¤ï¼š"><a href="#éƒ¨ç½²æ­¥éª¤ï¼š" class="headerlink" title="éƒ¨ç½²æ­¥éª¤ï¼š"></a>éƒ¨ç½²æ­¥éª¤ï¼š</h4><ol><li><p><strong>å‡†å¤‡èŠ‚ç‚¹</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºé›†ç¾¤ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data/redis-cluster/&#123;7000,7001,7002,7003,7004,7005&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>é…ç½®æ–‡ä»¶æ¨¡æ¿</strong>ï¼ˆcluster-node.confï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">port 7000</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">protected-mode no</span><br><span class="line">cluster-enabled <span class="built_in">yes</span></span><br><span class="line">cluster-config-file nodes-7000.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">requirepass cluster_password</span><br><span class="line">masterauth cluster_password</span><br></pre></td></tr></table></figure></li><li><p><strong>å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸ºæ¯ä¸ªèŠ‚ç‚¹å¤åˆ¶é…ç½®æ–‡ä»¶å¹¶ä¿®æ”¹ç«¯å£å·</span></span><br><span class="line"><span class="keyword">for</span> port <span class="keyword">in</span> &#123;7000..7005&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cp</span> cluster-node.conf /data/redis-cluster/<span class="variable">$port</span>/redis.conf</span><br><span class="line">    sed -i <span class="string">&quot;s/port 7000/port <span class="variable">$port</span>/&quot;</span> /data/redis-cluster/<span class="variable">$port</span>/redis.conf</span><br><span class="line">    sed -i <span class="string">&quot;s/nodes-7000.conf/nodes-<span class="variable">$port</span>.conf/&quot;</span> /data/redis-cluster/<span class="variable">$port</span>/redis.conf</span><br><span class="line">    redis-server /data/redis-cluster/<span class="variable">$port</span>/redis.conf</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºé›†ç¾¤</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create \</span><br><span class="line">192.168.1.100:7000 192.168.1.100:7001 192.168.1.100:7002 \</span><br><span class="line">192.168.1.100:7003 192.168.1.100:7004 192.168.1.100:7005 \</span><br><span class="line">--cluster-replicas 1 \</span><br><span class="line">-a cluster_password</span><br></pre></td></tr></table></figure></li></ol><p>åœ¨æ¯å°æœåŠ¡å™¨ä¸Šåˆ†åˆ«åˆ›å»ºä¸‰ä¸ªä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼šRedis å®ä¾‹ 1 ç›‘å¬ç«¯å£ 7000ï¼Œä½œä¸ºé›†ç¾¤çš„ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼›Redis å®ä¾‹ 2 ç›‘å¬ç«¯å£ 7001ï¼Œä½œä¸ºé›†ç¾¤çš„ä»èŠ‚ç‚¹ã€‚</p><h2 id="å…­ã€Docker-å®¹å™¨åŒ–éƒ¨ç½²"><a href="#å…­ã€Docker-å®¹å™¨åŒ–éƒ¨ç½²" class="headerlink" title="å…­ã€Docker å®¹å™¨åŒ–éƒ¨ç½²"></a>å…­ã€Docker å®¹å™¨åŒ–éƒ¨ç½²</h2><h3 id="6-1-å•æœº-Redis-Docker-éƒ¨ç½²"><a href="#6-1-å•æœº-Redis-Docker-éƒ¨ç½²" class="headerlink" title="6.1 å•æœº Redis Docker éƒ¨ç½²"></a>6.1 å•æœº Redis Docker éƒ¨ç½²</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7.2-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-single</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">/usr/local/etc/redis/redis.conf</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_PASSWORD=your_strong_password</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><h3 id="6-2-Redis-Cluster-Docker-éƒ¨ç½²"><a href="#6-2-Redis-Cluster-Docker-éƒ¨ç½²" class="headerlink" title="6.2 Redis Cluster Docker éƒ¨ç½²"></a>6.2 Redis Cluster Docker éƒ¨ç½²</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose-cluster.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis-node-1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7.2-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-cluster-1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7000:7000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;17000:17000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cluster/7000/redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">/usr/local/etc/redis/redis.conf</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis-node-2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7.2-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-cluster-2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7001:7001&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;17001:17001&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cluster/7001/redis.conf:/usr/local/etc/redis/redis.conf</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">/usr/local/etc/redis/redis.conf</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ... é…ç½®å…¶ä»– 4 ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">redis-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ Redis å®ä¾‹æŒ‰ç…§æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚å’Œå®‰å…¨æ ‡å‡†è¿è¡Œã€‚</p><h3 id="6-3-Docker-éƒ¨ç½²æ³¨æ„äº‹é¡¹"><a href="#6-3-Docker-éƒ¨ç½²æ³¨æ„äº‹é¡¹" class="headerlink" title="6.3 Docker éƒ¨ç½²æ³¨æ„äº‹é¡¹"></a>6.3 Docker éƒ¨ç½²æ³¨æ„äº‹é¡¹</h3><ol><li><strong>æ•°æ®æŒä¹…åŒ–</strong>ï¼šå¿…é¡»æŒ‚è½½æ•°æ®å·ï¼Œé¿å…å®¹å™¨é‡å¯æ•°æ®ä¸¢å¤±</li><li><strong>ç½‘ç»œé…ç½®</strong>ï¼šé›†ç¾¤æ¨¡å¼éœ€è¦æš´éœ²é›†ç¾¤æ€»çº¿ç«¯å£ï¼ˆå®¢æˆ·ç«¯ç«¯å£ + 10000ï¼‰</li><li><strong>èµ„æºé™åˆ¶</strong>ï¼šè®¾ç½®åˆç†çš„å†…å­˜å’Œ CPU é™åˆ¶</li><li><strong>å¥åº·æ£€æŸ¥</strong>ï¼šé…ç½®å¥åº·æ£€æŸ¥ç¡®ä¿æœåŠ¡å¯ç”¨æ€§</li><li><strong>å®‰å…¨åŠ å›º</strong>ï¼šè®¾ç½®å¯†ç ã€é™åˆ¶è®¿é—® IPã€ç¦ç”¨å±é™©å‘½ä»¤</li></ol><h2 id="ä¸ƒã€å¤šè¯­è¨€å®¢æˆ·ç«¯æ“ä½œç¤ºä¾‹"><a href="#ä¸ƒã€å¤šè¯­è¨€å®¢æˆ·ç«¯æ“ä½œç¤ºä¾‹" class="headerlink" title="ä¸ƒã€å¤šè¯­è¨€å®¢æˆ·ç«¯æ“ä½œç¤ºä¾‹"></a>ä¸ƒã€å¤šè¯­è¨€å®¢æˆ·ç«¯æ“ä½œç¤ºä¾‹</h2><h3 id="7-1-PHP-æ“ä½œ-Redis"><a href="#7-1-PHP-æ“ä½œ-Redis" class="headerlink" title="7.1 PHP æ“ä½œ Redis"></a>7.1 PHP æ“ä½œ Redis</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// å®‰è£…ï¼šcomposer require predis/predis</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Predis</span>\<span class="title">Client</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿æ¥é…ç½®</span></span><br><span class="line"><span class="variable">$parameters</span> = [</span><br><span class="line">    <span class="string">&#x27;scheme&#x27;</span> =&gt; <span class="string">&#x27;tcp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;host&#x27;</span>   =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;port&#x27;</span>   =&gt; <span class="number">6379</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span> =&gt; <span class="string">&#x27;your_password&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;database&#x27;</span> =&gt; <span class="number">0</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå®¢æˆ·ç«¯</span></span><br><span class="line"><span class="variable">$client</span> = <span class="keyword">new</span> <span class="title class_">Client</span>(<span class="variable">$parameters</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­—ç¬¦ä¸²æ“ä½œ</span></span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;user:1:name&#x27;</span>, <span class="string">&#x27;å¼ ä¸‰&#x27;</span>);</span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">setex</span>(<span class="string">&#x27;user:1:token&#x27;</span>, <span class="number">3600</span>, <span class="string">&#x27;abc123&#x27;</span>); <span class="comment">// è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$name</span> = <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;user:1:name&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;ç”¨æˆ·å: &quot;</span> . <span class="variable">$name</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“ˆå¸Œè¡¨æ“ä½œ</span></span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">hset</span>(<span class="string">&#x27;user:1&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;å¼ ä¸‰&#x27;</span>);</span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">hset</span>(<span class="string">&#x27;user:1&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;zhangsan@example.com&#x27;</span>);</span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">hset</span>(<span class="string">&#x27;user:1&#x27;</span>, <span class="string">&#x27;age&#x27;</span>, <span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$userInfo</span> = <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">hgetall</span>(<span class="string">&#x27;user:1&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$userInfo</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ—è¡¨æ“ä½œ</span></span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">rpush</span>(<span class="string">&#x27;news:latest&#x27;</span>, <span class="string">&#x27;æ–°é—»1&#x27;</span>);</span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">rpush</span>(<span class="string">&#x27;news:latest&#x27;</span>, <span class="string">&#x27;æ–°é—»2&#x27;</span>);</span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">rpush</span>(<span class="string">&#x27;news:latest&#x27;</span>, <span class="string">&#x27;æ–°é—»3&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$latestNews</span> = <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">lrange</span>(<span class="string">&#x27;news:latest&#x27;</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$latestNews</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ‰åºé›†åˆæ“ä½œ</span></span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">zadd</span>(<span class="string">&#x27;leaderboard&#x27;</span>, <span class="number">100</span>, <span class="string">&#x27;player1&#x27;</span>);</span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">zadd</span>(<span class="string">&#x27;leaderboard&#x27;</span>, <span class="number">150</span>, <span class="string">&#x27;player2&#x27;</span>);</span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">zadd</span>(<span class="string">&#x27;leaderboard&#x27;</span>, <span class="number">80</span>, <span class="string">&#x27;player3&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$topPlayers</span> = <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">zrevrange</span>(<span class="string">&#x27;leaderboard&#x27;</span>, <span class="number">0</span>, <span class="number">2</span>, [<span class="string">&#x27;withscores&#x27;</span> =&gt; <span class="literal">true</span>]);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$topPlayers</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹åŠ¡æ“ä½œ</span></span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">multi</span>()</span><br><span class="line">    -&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;counter&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">incr</span>(<span class="string">&#x27;counter&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">incr</span>(<span class="string">&#x27;counter&#x27;</span>)</span><br><span class="line">    -&gt;<span class="title function_ invoke__">exec</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$counter</span> = <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;counter&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;è®¡æ•°å™¨å€¼: &quot;</span> . <span class="variable">$counter</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">disconnect</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Redis çš„æ“ä½œå¾ˆå¤šï¼ŒPHP å¤„ç† Redis çš„ä¾‹å­åŒ…æ‹¬å¸¸ç”¨çš„ä¸€äº›æ–¹æ³•ï¼Œå¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆç­‰æ•°æ®ç±»å‹çš„æ“ä½œã€‚</p><h3 id="7-2-Golang-æ“ä½œ-Redis"><a href="#7-2-Golang-æ“ä½œ-Redis" class="headerlink" title="7.2 Golang æ“ä½œ Redis"></a>7.2 Golang æ“ä½œ Redis</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/redis/go-redis/v9&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º Redis å®¢æˆ·ç«¯</span></span><br><span class="line">rdb := redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">Addr:     <span class="string">&quot;localhost:6379&quot;</span>,</span><br><span class="line">Password: <span class="string">&quot;your_password&quot;</span>,</span><br><span class="line">DB:       <span class="number">0</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•è¿æ¥</span></span><br><span class="line">pong, err := rdb.Ping(ctx).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;è¿æ¥æˆåŠŸ:&quot;</span>, pong)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­—ç¬¦ä¸²æ“ä½œ</span></span><br><span class="line">err = rdb.Set(ctx, <span class="string">&quot;user:2:name&quot;</span>, <span class="string">&quot;æå››&quot;</span>, <span class="number">0</span>).Err()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">name, err := rdb.Get(ctx, <span class="string">&quot;user:2:name&quot;</span>).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;ç”¨æˆ·å:&quot;</span>, name)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“ˆå¸Œè¡¨æ“ä½œ</span></span><br><span class="line">userData := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"><span class="string">&quot;name&quot;</span>:  <span class="string">&quot;æå››&quot;</span>,</span><br><span class="line"><span class="string">&quot;email&quot;</span>: <span class="string">&quot;lisi@example.com&quot;</span>,</span><br><span class="line"><span class="string">&quot;age&quot;</span>:   <span class="number">28</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = rdb.HMSet(ctx, <span class="string">&quot;user:2&quot;</span>, userData).Err()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">email, err := rdb.HGet(ctx, <span class="string">&quot;user:2&quot;</span>, <span class="string">&quot;email&quot;</span>).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;é‚®ç®±:&quot;</span>, email)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ—è¡¨æ“ä½œ</span></span><br><span class="line">err = rdb.RPush(ctx, <span class="string">&quot;products:hot&quot;</span>, <span class="string">&quot;æ‰‹æœº&quot;</span>, <span class="string">&quot;ç”µè„‘&quot;</span>, <span class="string">&quot;å¹³æ¿&quot;</span>).Err()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">products, err := rdb.LRange(ctx, <span class="string">&quot;products:hot&quot;</span>, <span class="number">0</span>, <span class="number">-1</span>).Result()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;çƒ­é—¨äº§å“:&quot;</span>, products)</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹åŠ¡æ“ä½œ</span></span><br><span class="line">tx := rdb.TxPipelined(ctx, <span class="function"><span class="keyword">func</span><span class="params">(pipe redis.Pipeliner)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">pipe.Set(ctx, <span class="string">&quot;order:count&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">pipe.Incr(ctx, <span class="string">&quot;order:count&quot;</span>)</span><br><span class="line">pipe.Incr(ctx, <span class="string">&quot;order:count&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := tx[<span class="number">0</span>].Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">orderCount, err := rdb.Get(ctx, <span class="string">&quot;order:count&quot;</span>).Int64()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;è®¢å•æ•°é‡:&quot;</span>, orderCount)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pipeline æ‰¹é‡æ“ä½œ</span></span><br><span class="line">pipe := rdb.Pipeline()</span><br><span class="line">pipe.Set(ctx, <span class="string">&quot;counter:view&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">pipe.Incr(ctx, <span class="string">&quot;counter:view&quot;</span>)</span><br><span class="line">pipe.Incr(ctx, <span class="string">&quot;counter:view&quot;</span>)</span><br><span class="line">pipe.Exec(ctx)</span><br><span class="line"></span><br><span class="line">viewCount, err := rdb.Get(ctx, <span class="string">&quot;counter:view&quot;</span>).Int64()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;æµè§ˆæ¬¡æ•°:&quot;</span>, viewCount)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘å¸ƒè®¢é˜…</span></span><br><span class="line">pubsub := rdb.Subscribe(ctx, <span class="string">&quot;news_channel&quot;</span>)</span><br><span class="line"><span class="keyword">defer</span> pubsub.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨ goroutine å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">ch := pubsub.Channel()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> msg := <span class="keyword">range</span> ch &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;æ”¶åˆ°æ¶ˆæ¯: %s\n&quot;</span>, msg.Payload)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘å¸ƒæ¶ˆæ¯</span></span><br><span class="line">err = rdb.Publish(ctx, <span class="string">&quot;news_channel&quot;</span>, <span class="string">&quot;Redis å‘å¸ƒè®¢é˜…ç¤ºä¾‹&quot;</span>).Err()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">time.Sleep(<span class="number">2</span> * time.Second) <span class="comment">// ç­‰å¾…æ¶ˆæ¯å¤„ç†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line">rdb.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ redis.NewClient å‡½æ•°å³å¯åˆ›å»ºä¸€ä¸ª redis å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ª redis.Options å¯¹è±¡å‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°å¯ä»¥é…ç½® redis ç›¸å…³çš„å±æ€§ã€‚</p><h3 id="7-3-Python-æ“ä½œ-Redis"><a href="#7-3-Python-æ“ä½œ-Redis" class="headerlink" title="7.3 Python æ“ä½œ Redis"></a>7.3 Python æ“ä½œ Redis</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> redis.cluster <span class="keyword">import</span> RedisCluster</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># å•æœº Redis è¿æ¥</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">connect_redis</span>():</span><br><span class="line">    <span class="keyword">return</span> redis.Redis(</span><br><span class="line">        host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">        port=<span class="number">6379</span>,</span><br><span class="line">        password=<span class="string">&#x27;your_password&#x27;</span>,</span><br><span class="line">        decode_responses=<span class="literal">True</span>,  <span class="comment"># è‡ªåŠ¨è§£ç å“åº”</span></span><br><span class="line">        db=<span class="number">0</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤ Redis è¿æ¥</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">connect_redis_cluster</span>():</span><br><span class="line">    <span class="keyword">return</span> RedisCluster(</span><br><span class="line">        host=<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">        port=<span class="number">7000</span>,</span><br><span class="line">        password=<span class="string">&#x27;cluster_password&#x27;</span>,</span><br><span class="line">        decode_responses=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">string_operations</span>(<span class="params">r</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å­—ç¬¦ä¸²æ“ä½œç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== å­—ç¬¦ä¸²æ“ä½œ ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¾ç½®é”®å€¼</span></span><br><span class="line">    r.<span class="built_in">set</span>(<span class="string">&#x27;user:3:name&#x27;</span>, <span class="string">&#x27;ç‹äº”&#x27;</span>)</span><br><span class="line">    r.setex(<span class="string">&#x27;user:3:session&#x27;</span>, <span class="number">3600</span>, <span class="string">&#x27;session_token_123&#x27;</span>)  <span class="comment"># è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–å€¼</span></span><br><span class="line">    name = r.get(<span class="string">&#x27;user:3:name&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ç”¨æˆ·å: <span class="subst">&#123;name&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ‰¹é‡æ“ä½œ</span></span><br><span class="line">    r.mset(&#123;</span><br><span class="line">        <span class="string">&#x27;user:3:age&#x27;</span>: <span class="number">30</span>,</span><br><span class="line">        <span class="string">&#x27;user:3:city&#x27;</span>: <span class="string">&#x27;åŒ—äº¬&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é€’å¢æ“ä½œ</span></span><br><span class="line">    r.<span class="built_in">set</span>(<span class="string">&#x27;counter:views&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    r.incr(<span class="string">&#x27;counter:views&#x27;</span>)</span><br><span class="line">    r.incr(<span class="string">&#x27;counter:views&#x27;</span>, <span class="number">5</span>)</span><br><span class="line">    views = r.get(<span class="string">&#x27;counter:views&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æµè§ˆæ¬¡æ•°: <span class="subst">&#123;views&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hash_operations</span>(<span class="params">r</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å“ˆå¸Œè¡¨æ“ä½œç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== å“ˆå¸Œè¡¨æ“ä½œ ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¾ç½®å“ˆå¸Œå­—æ®µ</span></span><br><span class="line">    user_key = <span class="string">&#x27;user:3&#x27;</span></span><br><span class="line">    r.hset(user_key, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;ç‹äº”&#x27;</span>)</span><br><span class="line">    r.hset(user_key, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;wangwu@example.com&#x27;</span>)</span><br><span class="line">    r.hset(user_key, <span class="string">&#x27;age&#x27;</span>, <span class="number">30</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–å•ä¸ªå­—æ®µ</span></span><br><span class="line">    email = r.hget(user_key, <span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;é‚®ç®±: <span class="subst">&#123;email&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–æ‰€æœ‰å­—æ®µ</span></span><br><span class="line">    user_info = r.hgetall(user_key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ç”¨æˆ·ä¿¡æ¯: <span class="subst">&#123;user_info&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ‰¹é‡è®¾ç½®</span></span><br><span class="line">    r.hmset(user_key, &#123;</span><br><span class="line">        <span class="string">&#x27;phone&#x27;</span>: <span class="string">&#x27;13800138000&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;åŒ—äº¬å¸‚æµ·æ·€åŒº&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å­—æ®µå­˜åœ¨æ€§æ£€æŸ¥</span></span><br><span class="line">    exists = r.hexists(user_key, <span class="string">&#x27;phone&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;phone å­—æ®µå­˜åœ¨: <span class="subst">&#123;exists&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_operations</span>(<span class="params">r</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ—è¡¨æ“ä½œç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== åˆ—è¡¨æ“ä½œ ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ·»åŠ å…ƒç´ </span></span><br><span class="line">    news_key = <span class="string">&#x27;news:latest&#x27;</span></span><br><span class="line">    r.rpush(news_key, <span class="string">&#x27;ç§‘æŠ€æ–°é—»1&#x27;</span>)</span><br><span class="line">    r.rpush(news_key, <span class="string">&#x27;ç§‘æŠ€æ–°é—»2&#x27;</span>)</span><br><span class="line">    r.rpush(news_key, <span class="string">&#x27;ç§‘æŠ€æ–°é—»3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–èŒƒå›´</span></span><br><span class="line">    latest_news = r.lrange(news_key, <span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æœ€æ–°æ–°é—»: <span class="subst">&#123;latest_news&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¼¹å‡ºå…ƒç´ </span></span><br><span class="line">    last_news = r.rpop(news_key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å¼¹å‡ºçš„æ–°é—»: <span class="subst">&#123;last_news&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆ—è¡¨é•¿åº¦</span></span><br><span class="line">    news_count = r.llen(news_key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å‰©ä½™æ–°é—»æ•°é‡: <span class="subst">&#123;news_count&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sorted_set_operations</span>(<span class="params">r</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æœ‰åºé›†åˆæ“ä½œç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== æœ‰åºé›†åˆæ“ä½œ ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    leaderboard_key = <span class="string">&#x27;game:leaderboard&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ·»åŠ æˆå‘˜</span></span><br><span class="line">    r.zadd(leaderboard_key, &#123;<span class="string">&#x27;player1&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;player2&#x27;</span>: <span class="number">150</span>, <span class="string">&#x27;player3&#x27;</span>: <span class="number">80</span>&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–æ’å</span></span><br><span class="line">    rank = r.zrank(leaderboard_key, <span class="string">&#x27;player2&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;player2 æ’å: <span class="subst">&#123;rank&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–åˆ†æ•°</span></span><br><span class="line">    score = r.zscore(leaderboard_key, <span class="string">&#x27;player2&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;player2 åˆ†æ•°: <span class="subst">&#123;score&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–å‰3å</span></span><br><span class="line">    top_players = r.zrevrange(leaderboard_key, <span class="number">0</span>, <span class="number">2</span>, withscores=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;æ’è¡Œæ¦œå‰3å:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> player, score <span class="keyword">in</span> top_players:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  <span class="subst">&#123;player&#125;</span>: <span class="subst">&#123;score&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transaction_operations</span>(<span class="params">r</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;äº‹åŠ¡æ“ä½œç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== äº‹åŠ¡æ“ä½œ ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆ›å»ºç®¡é“</span></span><br><span class="line">    pipe = r.pipeline()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># å¼€å¯äº‹åŠ¡</span></span><br><span class="line">        pipe.multi()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># äº‹åŠ¡ä¸­çš„æ“ä½œ</span></span><br><span class="line">        pipe.<span class="built_in">set</span>(<span class="string">&#x27;order:id&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line">        pipe.incr(<span class="string">&#x27;order:id&#x27;</span>)</span><br><span class="line">        pipe.incr(<span class="string">&#x27;order:id&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ‰§è¡Œäº‹åŠ¡</span></span><br><span class="line">        results = pipe.execute()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;äº‹åŠ¡æ‰§è¡Œç»“æœ: <span class="subst">&#123;results&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è·å–æœ€ç»ˆå€¼</span></span><br><span class="line">        final_id = r.get(<span class="string">&#x27;order:id&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;æœ€ç»ˆè®¢å•ID: <span class="subst">&#123;final_id&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> redis.WatchError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œæ•°æ®è¢«ä¿®æ”¹&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        pipe.reset()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pubsub_operations</span>(<span class="params">r</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å‘å¸ƒè®¢é˜…æ“ä½œç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== å‘å¸ƒè®¢é˜…æ“ä½œ ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆ›å»ºå‘å¸ƒ/è®¢é˜…å®¢æˆ·ç«¯</span></span><br><span class="line">    pubsub = r.pubsub()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¢é˜…é¢‘é“</span></span><br><span class="line">    pubsub.subscribe(<span class="string">&#x27;news_channel&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å·²è®¢é˜… news_channel é¢‘é“&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å‘å¸ƒæ¶ˆæ¯</span></span><br><span class="line">    r.publish(<span class="string">&#x27;news_channel&#x27;</span>, <span class="string">&#x27;Python Redis å‘å¸ƒè®¢é˜…ç¤ºä¾‹&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å·²å‘å¸ƒæ¶ˆæ¯åˆ° news_channel&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç­‰å¾…æ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">    message = pubsub.get_message(timeout=<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> message:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;æ”¶åˆ°æ¶ˆæ¯: <span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é€€è®¢</span></span><br><span class="line">    pubsub.unsubscribe(<span class="string">&#x27;news_channel&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å¼€å§‹æµ‹è¯• Redis æ“ä½œ: <span class="subst">&#123;datetime.now()&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è¿æ¥ Redis</span></span><br><span class="line">    r = connect_redis()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># æµ‹è¯•è¿æ¥</span></span><br><span class="line">        ping_result = r.ping()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Redis è¿æ¥çŠ¶æ€: <span class="subst">&#123;ping_result&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ‰§è¡Œå„ç§æ“ä½œ</span></span><br><span class="line">        string_operations(r)</span><br><span class="line">        hash_operations(r)</span><br><span class="line">        list_operations(r)</span><br><span class="line">        sorted_set_operations(r)</span><br><span class="line">        transaction_operations(r)</span><br><span class="line">        pubsub_operations(r)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\næµ‹è¯•å®Œæˆ: <span class="subst">&#123;datetime.now()&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        r.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>è¿æ¥ç¤ºä¾‹ä¸­ï¼Œå¯ä»¥é€šè¿‡ decode_responses&#x3D;True å‚æ•°æ¥è§£ç  Redis è¿”å›çš„äºŒè¿›åˆ¶å“åº”ã€‚</p><h2 id="å…«ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ"><a href="#å…«ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ" class="headerlink" title="å…«ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ"></a>å…«ã€å…³é”®æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ</h2><h3 id="8-1-å®‰å…¨é˜²æŠ¤"><a href="#8-1-å®‰å…¨é˜²æŠ¤" class="headerlink" title="8.1 å®‰å…¨é˜²æŠ¤"></a>8.1 å®‰å…¨é˜²æŠ¤</h3><ol><li><strong>å¯†ç ç­–ç•¥</strong>ï¼šå¿…é¡»è®¾ç½®å¼ºå¯†ç ï¼Œé¿å…ä½¿ç”¨é»˜è®¤æˆ–å¼±å¯†ç </li><li><strong>ç½‘ç»œéš”ç¦»</strong>ï¼šRedis æœåŠ¡ä¸åº”ç›´æ¥æš´éœ²åœ¨å…¬ç½‘ï¼Œåº”é€šè¿‡é˜²ç«å¢™æˆ–å®‰å…¨ç»„é™åˆ¶è®¿é—®</li><li><strong>å‘½ä»¤ç¦ç”¨</strong>ï¼šé€šè¿‡ rename-command ç¦ç”¨å±é™©å‘½ä»¤å¦‚ FLUSHDBã€FLUSHALLã€CONFIG</li><li><strong>å®šæœŸå®¡è®¡</strong>ï¼šç›‘æ§ Redis æ—¥å¿—ï¼Œæ£€æŸ¥å¼‚å¸¸è®¿é—®å’Œæ“ä½œ</li></ol><h3 id="8-2-æ€§èƒ½ä¼˜åŒ–"><a href="#8-2-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="8.2 æ€§èƒ½ä¼˜åŒ–"></a>8.2 æ€§èƒ½ä¼˜åŒ–</h3><ol><li><p><strong>å†…å­˜ç®¡ç†</strong>ï¼š</p><ul><li>åˆç†è®¾ç½® maxmemory å’Œæ·˜æ±°ç­–ç•¥</li><li>é¿å…å¤§ key æ“ä½œï¼Œå•ä¸ª value ä¸è¶…è¿‡ 10MB</li><li>ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„ï¼Œå¦‚ç”¨ Hash å­˜å‚¨å¯¹è±¡</li></ul></li><li><p><strong>è¿æ¥ç®¡ç†</strong>ï¼š</p><ul><li>ä½¿ç”¨è¿æ¥æ± ï¼Œé¿å…é¢‘ç¹åˆ›å»ºè¿æ¥</li><li>è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ŒåŠæ—¶é‡Šæ”¾ç©ºé—²è¿æ¥</li><li>ç›‘æ§è¿æ¥æ•°ï¼Œé˜²æ­¢è¿æ¥æ³„æ¼</li></ul></li><li><p><strong>æŒä¹…åŒ–ç­–ç•¥</strong>ï¼š</p><ul><li>æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹© RDBã€AOF æˆ–æ··åˆæŒä¹…åŒ–</li><li>é¿å…åœ¨é«˜å³°æ—¶æ®µæ‰§è¡Œ BGSAVE</li><li>å®šæœŸå¤‡ä»½æŒä¹…åŒ–æ–‡ä»¶</li></ul></li></ol><h3 id="8-3-é«˜å¯ç”¨ä¿éšœ"><a href="#8-3-é«˜å¯ç”¨ä¿éšœ" class="headerlink" title="8.3 é«˜å¯ç”¨ä¿éšœ"></a>8.3 é«˜å¯ç”¨ä¿éšœ</h3><ol><li><strong>é›†ç¾¤éƒ¨ç½²</strong>ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨é›†ç¾¤æ¨¡å¼ï¼Œè‡³å°‘ 3 ä¸» 3 ä»</li><li><strong>ç›‘æ§å‘Šè­¦</strong>ï¼šç›‘æ§å…³é”®æŒ‡æ ‡ï¼šå†…å­˜ä½¿ç”¨ç‡ã€è¿æ¥æ•°ã€å‘½ä¸­ç‡ã€å»¶è¿Ÿ</li><li><strong>æ•…éšœè½¬ç§»</strong>ï¼šé…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæµ‹è¯•æ•…éšœæ¢å¤æµç¨‹</li><li><strong>æ•°æ®å¤‡ä»½</strong>ï¼šå®šæœŸå¤‡ä»½æ•°æ®ï¼ŒéªŒè¯å¤‡ä»½æ–‡ä»¶å¯ç”¨æ€§</li></ol><h3 id="8-4-ç‰ˆæœ¬é€‰æ‹©å»ºè®®"><a href="#8-4-ç‰ˆæœ¬é€‰æ‹©å»ºè®®" class="headerlink" title="8.4 ç‰ˆæœ¬é€‰æ‹©å»ºè®®"></a>8.4 ç‰ˆæœ¬é€‰æ‹©å»ºè®®</h3><ol><li><strong>å¼€æºç‰ˆæœ¬é™åˆ¶</strong>ï¼šRedis 7.4 åŠä»¥ä¸Šç‰ˆæœ¬é‡‡ç”¨æ–°çš„è®¸å¯åè®®ï¼Œå•†ä¸šä½¿ç”¨éœ€è°¨æ…è¯„ä¼°</li><li><strong>ç¨³å®šç‰ˆæœ¬æ¨è</strong>ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Redis 7.0 æˆ– 7.2 ç¨³å®šç‰ˆæœ¬</li><li><strong>å…¼å®¹æ€§è€ƒè™‘</strong>ï¼šå‡çº§å‰æµ‹è¯•å®¢æˆ·ç«¯å…¼å®¹æ€§ï¼Œç‰¹åˆ«æ˜¯æ–°åè®®æ”¯æŒ</li><li><strong>é•¿æœŸæ”¯æŒ</strong>ï¼šé€‰æ‹©æœ‰é•¿æœŸæ”¯æŒçš„ç‰ˆæœ¬ï¼Œé¿å…é¢‘ç¹å‡çº§</li></ol><h2 id="ä¹ã€æ„Ÿæ‚Ÿ"><a href="#ä¹ã€æ„Ÿæ‚Ÿ" class="headerlink" title="ä¹ã€æ„Ÿæ‚Ÿ"></a>ä¹ã€æ„Ÿæ‚Ÿ</h2><p>Redis ä½œä¸ºé«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“ï¼Œåœ¨ç°ä»£åº”ç”¨æ¶æ„ä¸­æ‰®æ¼”ç€è¶Šæ¥è¶Šé‡è¦çš„è§’è‰²ã€‚ä»ç‰ˆæœ¬æ¼”è¿›æ¥çœ‹ï¼ŒRedis 7.x ç³»åˆ—å¸¦æ¥äº†ä¼—å¤šåˆ›æ–°ç‰¹æ€§ï¼Œä½†ä¹Ÿä¼´éšç€è®¸å¯åè®®çš„é‡å¤§å˜åŒ–ï¼Œéœ€è¦å¼€å‘è€…å’Œä¼ä¸šé‡æ–°è¯„ä¼°æŠ€æœ¯é€‰å‹ç­–ç•¥ã€‚</p><p>åœ¨ Debian 12 ç¯å¢ƒä¸‹éƒ¨ç½² Redisï¼Œæ— è®ºæ˜¯å•ä½“ã€ä¸»ä»è¿˜æ˜¯é›†ç¾¤æ¨¡å¼ï¼Œéƒ½éœ€è¦æ·±å…¥ç†è§£å…¶é…ç½®å‚æ•°å’Œå·¥ä½œåŸç†ã€‚é€šè¿‡åˆç†çš„é…ç½®ä¼˜åŒ–ï¼Œå¯ä»¥å……åˆ†å‘æŒ¥ Redis çš„æ€§èƒ½ä¼˜åŠ¿ï¼ŒåŒæ—¶ä¿éšœç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚</p><p>Docker å®¹å™¨åŒ–éƒ¨ç½²ä¸º Redis æä¾›äº†æ›´çµæ´»çš„éƒ¨ç½²æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¯ä»¥å¿«é€Ÿæ„å»ºå’Œæ‰©å±• Redis æœåŠ¡ã€‚å¤šè¯­è¨€å®¢æˆ·ç«¯çš„æ”¯æŒä½¿å¾— Redis èƒ½å¤Ÿæ— ç¼é›†æˆåˆ°å„ç§æŠ€æœ¯æ ˆä¸­ï¼Œä¸ºåº”ç”¨æä¾›å¼ºå¤§çš„ç¼“å­˜ã€é˜Ÿåˆ—å’Œå®æ—¶æ•°æ®å¤„ç†èƒ½åŠ›ã€‚</p><p>éšç€äº‘åŸç”Ÿå’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„å‘å±•ï¼ŒRedis çš„åº”ç”¨åœºæ™¯å°†æ›´åŠ å¹¿æ³›ã€‚æŒæ¡ Redis çš„æ ¸å¿ƒåŸç†ã€æœ€ä½³å®è·µå’Œè¿ç»´æŠ€å·§ï¼Œå°†æˆä¸ºå¼€å‘è€…å’Œæ¶æ„å¸ˆçš„å¿…å¤‡æŠ€èƒ½ã€‚åœ¨é€‰æ‹© Redis ä½œä¸ºæŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘æ€§èƒ½éœ€æ±‚ã€æˆæœ¬é¢„ç®—ã€åˆè§„è¦æ±‚ç­‰å› ç´ ï¼Œåšå‡ºæœ€é€‚åˆä¸šåŠ¡å‘å±•çš„æŠ€æœ¯å†³ç­–ã€‚</p><h4 id="é‡è¦æé†’-âš ï¸-ï¼šç”±äº-Redis-7-4-åŠä»¥ä¸Šç‰ˆæœ¬çš„è®¸å¯åè®®å˜æ›´ï¼Œå»ºè®®åœ¨å•†ä¸šé¡¹ç›®ä¸­è°¨æ…è¯„ä¼°ä½¿ç”¨é£é™©ï¼Œå¿…è¦æ—¶è€ƒè™‘å¼€æºæ›¿ä»£æ–¹æ¡ˆå¦‚-Valkeyã€DragonflyDB-ç­‰ã€‚"><a href="#é‡è¦æé†’-âš ï¸-ï¼šç”±äº-Redis-7-4-åŠä»¥ä¸Šç‰ˆæœ¬çš„è®¸å¯åè®®å˜æ›´ï¼Œå»ºè®®åœ¨å•†ä¸šé¡¹ç›®ä¸­è°¨æ…è¯„ä¼°ä½¿ç”¨é£é™©ï¼Œå¿…è¦æ—¶è€ƒè™‘å¼€æºæ›¿ä»£æ–¹æ¡ˆå¦‚-Valkeyã€DragonflyDB-ç­‰ã€‚" class="headerlink" title="é‡è¦æé†’ âš ï¸ ï¼šç”±äº Redis 7.4 åŠä»¥ä¸Šç‰ˆæœ¬çš„è®¸å¯åè®®å˜æ›´ï¼Œå»ºè®®åœ¨å•†ä¸šé¡¹ç›®ä¸­è°¨æ…è¯„ä¼°ä½¿ç”¨é£é™©ï¼Œå¿…è¦æ—¶è€ƒè™‘å¼€æºæ›¿ä»£æ–¹æ¡ˆå¦‚ Valkeyã€DragonflyDB ç­‰ã€‚"></a>é‡è¦æé†’ âš ï¸ ï¼šç”±äº Redis 7.4 åŠä»¥ä¸Šç‰ˆæœ¬çš„è®¸å¯åè®®å˜æ›´ï¼Œå»ºè®®åœ¨å•†ä¸šé¡¹ç›®ä¸­è°¨æ…è¯„ä¼°ä½¿ç”¨é£é™©ï¼Œå¿…è¦æ—¶è€ƒè™‘å¼€æºæ›¿ä»£æ–¹æ¡ˆå¦‚ Valkeyã€DragonflyDB ç­‰ã€‚</h4><hr><h2 id="åã€Redisã€Valkeyã€DragonflyDB-ä¸‰è€…æ·±åº¦å¯¹æ¯”ä¸æŠ€æœ¯é€‰å‹æŒ‡å—ï¼ˆä¸ªäººè§‚ç‚¹ï¼Œè‡ªè¡Œè¯„ä¼°âš ï¸ï¼‰"><a href="#åã€Redisã€Valkeyã€DragonflyDB-ä¸‰è€…æ·±åº¦å¯¹æ¯”ä¸æŠ€æœ¯é€‰å‹æŒ‡å—ï¼ˆä¸ªäººè§‚ç‚¹ï¼Œè‡ªè¡Œè¯„ä¼°âš ï¸ï¼‰" class="headerlink" title="åã€Redisã€Valkeyã€DragonflyDB ä¸‰è€…æ·±åº¦å¯¹æ¯”ä¸æŠ€æœ¯é€‰å‹æŒ‡å—ï¼ˆä¸ªäººè§‚ç‚¹ï¼Œè‡ªè¡Œè¯„ä¼°âš ï¸ï¼‰"></a>åã€Redisã€Valkeyã€DragonflyDB ä¸‰è€…æ·±åº¦å¯¹æ¯”ä¸æŠ€æœ¯é€‰å‹æŒ‡å—ï¼ˆä¸ªäººè§‚ç‚¹ï¼Œè‡ªè¡Œè¯„ä¼°âš ï¸ï¼‰</h2><h4 id="Redisï¼šå†…å­˜æ•°æ®åº“çš„å¼€åˆ›è€…"><a href="#Redisï¼šå†…å­˜æ•°æ®åº“çš„å¼€åˆ›è€…" class="headerlink" title="Redisï¼šå†…å­˜æ•°æ®åº“çš„å¼€åˆ›è€…"></a>Redisï¼šå†…å­˜æ•°æ®åº“çš„å¼€åˆ›è€…</h4><p>Redisè‡ª2009å¹´è¯ç”Ÿä»¥æ¥ï¼Œä¸€ç›´æ˜¯å†…å­˜æ•°æ®åº“é¢†åŸŸçš„æ ‡æ†ã€‚ç„¶è€Œåœ¨2024-2025å¹´ï¼ŒRedisç»å†äº†ä¸¤æ¬¡é‡å¤§è®¸å¯å˜æ›´ï¼Œä»å®½æ¾çš„BSDåè®®è½¬å‘å¸¦æœ‰å•†ä¸šé™åˆ¶çš„SSPLv1å’ŒRSALv2åè®®ï¼Œå¼•å‘äº†ç¤¾åŒºçš„å¹¿æ³›äº‰è®®ã€‚ 2025å¹´5æœˆï¼ŒRedis 8.0å‘å¸ƒï¼Œé‡æ–°å¼€æºï¼Œé‡‡ç”¨AGPLv3è®¸å¯è¯ä½œä¸ºä¸‰ç§è®¸å¯è¯é€‰é¡¹ä¹‹ä¸€ï¼Œè¯•å›¾ä¿®å¤ä¸ç¤¾åŒºçš„å…³ç³»ã€‚</p><h4 id="Valkeyï¼šç¤¾åŒºé©±åŠ¨çš„Redisåˆ†æ”¯"><a href="#Valkeyï¼šç¤¾åŒºé©±åŠ¨çš„Redisåˆ†æ”¯" class="headerlink" title="Valkeyï¼šç¤¾åŒºé©±åŠ¨çš„Redisåˆ†æ”¯"></a>Valkeyï¼šç¤¾åŒºé©±åŠ¨çš„Redisåˆ†æ”¯</h4><p>é¢å¯¹Redisçš„è®¸å¯å˜æ›´ï¼Œç¤¾åŒºåœ¨2024å¹´åˆ›å»ºäº†Valkeyåˆ†æ”¯ï¼Œç›®æ ‡æ˜¯ä¿æŒRedisçš„æ ¸å¿ƒç‰¹æ€§å’ŒAPIå…¼å®¹æ€§ï¼ŒåŒæ—¶å›å½’çœŸæ­£çš„å¼€æºç†å¿µã€‚åˆ°2025å¹´ï¼ŒArch Linuxç­‰ä¸»æµå‘è¡Œç‰ˆå·²å®£å¸ƒé‡‡ç”¨Valkeyå–ä»£Redisã€‚ Valkeyå®Œå…¨ç»§æ‰¿äº†Redis 7.0çš„æŠ€æœ¯åŸºç¡€ï¼Œä½†ä¿æŒäº†BSDè®¸å¯è¯ï¼Œä¸ºå¼€å‘è€…æä¾›äº†æ— å•†ä¸šé™åˆ¶çš„é€‰æ‹©ã€‚</p><h4 id="DragonflyDBï¼šæ–°ä¸€ä»£å†…å­˜æ•°æ®åº“"><a href="#DragonflyDBï¼šæ–°ä¸€ä»£å†…å­˜æ•°æ®åº“" class="headerlink" title="DragonflyDBï¼šæ–°ä¸€ä»£å†…å­˜æ•°æ®åº“"></a>DragonflyDBï¼šæ–°ä¸€ä»£å†…å­˜æ•°æ®åº“</h4><p>2022å¹´ï¼Œä¸€ä½å‰è°·æ­Œã€å‰äºšé©¬é€Šçš„å·¥ç¨‹å¸ˆæ¨å‡ºäº†DragonflyDBï¼Œç”¨C&#x2F;C++ç¼–å†™ï¼ŒåŸºäºBSLè®¸å¯åˆ†å‘ã€‚ DragonflyDBé‡‡ç”¨äº†å…¨æ–°çš„æ¶æ„è®¾è®¡ï¼Œå£°ç§°åœ¨æ€§èƒ½ä¸Šæ¯”Rediså¿«25å€ï¼Œå•å®ä¾‹å¯æ”¯æŒæ•°ç™¾ä¸‡QPSï¼Œæˆä¸ºå†…å­˜æ•°æ®åº“é¢†åŸŸçš„æ–°é”åŠ›é‡ã€‚</p><h3 id="æ ¸å¿ƒæ¶æ„å¯¹æ¯”"><a href="#æ ¸å¿ƒæ¶æ„å¯¹æ¯”" class="headerlink" title="æ ¸å¿ƒæ¶æ„å¯¹æ¯”"></a>æ ¸å¿ƒæ¶æ„å¯¹æ¯”</h3><h4 id="çº¿ç¨‹æ¨¡å‹"><a href="#çº¿ç¨‹æ¨¡å‹" class="headerlink" title="çº¿ç¨‹æ¨¡å‹"></a>çº¿ç¨‹æ¨¡å‹</h4><ul><li><strong>Redis&#x2F;Valkey</strong>ï¼šé‡‡ç”¨å•çº¿ç¨‹äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œé€šè¿‡I&#x2F;Oå¤šè·¯å¤ç”¨æŠ€æœ¯å®ç°é«˜å¹¶å‘ï¼Œä½†æ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸CPUèµ„æºã€‚</li><li><strong>DragonflyDB</strong>ï¼šé‡‡ç”¨å¤šçº¿ç¨‹ã€æ— å…±äº«ï¼ˆShared-nothingï¼‰æ¶æ„ï¼Œèƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç°ä»£å¤šæ ¸CPUçš„è®¡ç®—èƒ½åŠ›ï¼Œå®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•ã€‚</li></ul><h4 id="æ•°æ®ç»“æ„ä¸ç®—æ³•"><a href="#æ•°æ®ç»“æ„ä¸ç®—æ³•" class="headerlink" title="æ•°æ®ç»“æ„ä¸ç®—æ³•"></a>æ•°æ®ç»“æ„ä¸ç®—æ³•</h4><ul><li><strong>Redis&#x2F;Valkey</strong>ï¼šä½¿ç”¨ä¼ ç»Ÿçš„æ•°æ®ç»“æ„ï¼Œå¦‚è·³è·ƒè¡¨ã€å­—å…¸ç­‰ï¼Œåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä¼˜åŒ–è‰¯å¥½ã€‚</li><li><strong>DragonflyDB</strong>ï¼šåˆ›æ–°æ€§åœ°å®ç°äº†åä¸ºâ€dashtableâ€çš„å“ˆå¸Œè¡¨ç»“æ„ï¼Œä»¥æœ€å°åŒ–å†…å­˜å¼€é”€å’Œå»¶è¿Ÿï¼Œè¿™æ˜¯å…¶æ€§èƒ½ä¼˜åŠ¿çš„å…³é”®æ‰€åœ¨ã€‚</li></ul><p>####é›†ç¾¤ä¸æ‰©å±•æ€§</p><ul><li><strong>Redis</strong>ï¼šéœ€è¦é€šè¿‡Redis Clusterå®ç°åˆ†å¸ƒå¼ï¼Œé…ç½®ç›¸å¯¹å¤æ‚ã€‚</li><li><strong>Valkey</strong>ï¼šç»§æ‰¿Redisçš„é›†ç¾¤æ–¹æ¡ˆï¼Œä¿æŒå…¼å®¹æ€§ã€‚</li><li><strong>DragonflyDB</strong>ï¼šè‡ªå¸¦é›†ç¾¤èƒ½åŠ›ï¼Œå¯ä»¥åˆ©ç”¨å¤šæ ¸ï¼Œæ¥å£å±‚é¢å®Œå…¨å…¼å®¹Redisï¼Œç®€åŒ–äº†æ¶æ„å¤æ‚åº¦ã€‚</li></ul><h3 id="æ€§èƒ½å¯¹æ¯”åˆ†æ"><a href="#æ€§èƒ½å¯¹æ¯”åˆ†æ" class="headerlink" title="æ€§èƒ½å¯¹æ¯”åˆ†æ"></a>æ€§èƒ½å¯¹æ¯”åˆ†æ</h3><h4 id="åŸºå‡†æµ‹è¯•ç»“æœ"><a href="#åŸºå‡†æµ‹è¯•ç»“æœ" class="headerlink" title="åŸºå‡†æµ‹è¯•ç»“æœ"></a>åŸºå‡†æµ‹è¯•ç»“æœ</h4><p>æ ¹æ®å®˜æ–¹åŸºå‡†æµ‹è¯•æ•°æ®ï¼ŒDragonflyDBåœ¨å…¸å‹å·¥ä½œè´Ÿè½½ä¸‹å®ç°äº†25å€äºRedisçš„æ€§èƒ½æå‡ï¼Œå•ä¸ªDragonflyæœåŠ¡å™¨æ¯ç§’å¯ä»¥å¤„ç†æ•°ç™¾ä¸‡ä¸ªè¯·æ±‚ã€‚ åœ¨5GBå­˜å‚¨æµ‹è¯•ä¸­ï¼ŒDragonflyæ‰€éœ€çš„å†…å­˜ä¹Ÿæ˜¾è‘—ä½äºRedisï¼Œå±•ç°å‡ºæ›´é«˜çš„å†…å­˜æ•ˆç‡ã€‚</p><h4 id="å®é™…åº”ç”¨åœºæ™¯è¡¨ç°"><a href="#å®é™…åº”ç”¨åœºæ™¯è¡¨ç°" class="headerlink" title="å®é™…åº”ç”¨åœºæ™¯è¡¨ç°"></a>å®é™…åº”ç”¨åœºæ™¯è¡¨ç°</h4><ul><li><strong>é«˜å¹¶å‘è¯»å†™åœºæ™¯</strong>ï¼šDragonflyDBåœ¨éœ€è¦è¶…é«˜QPSçš„åœºæ™¯ï¼ˆå¦‚ç§’æ€ã€å®æ—¶æ¨èï¼‰ä¸­è¡¨ç°å“è¶Šï¼Œå•å®ä¾‹æ”¯æŒç™¾ä¸‡é‡çº§QPSã€‚</li><li><strong>å†…å­˜å¯†é›†å‹åº”ç”¨</strong>ï¼šDragonflyDBåœ¨åº”å¯¹TBçº§åˆ«çš„å†…å­˜æ•°æ®é›†æ—¶ï¼Œå†…å­˜æ•ˆç‡ä¼˜åŠ¿æ˜æ˜¾ã€‚</li><li><strong>ä¼ ç»Ÿä¸šåŠ¡åœºæ™¯</strong>ï¼šRedis&#x2F;Valkeyåœ¨å¸¸è§„ç¼“å­˜ã€ä¼šè¯ç®¡ç†ç­‰åœºæ™¯ä¸­ä»ç„¶è¡¨ç°å‡ºè‰²ï¼Œä¸”ç”Ÿæ€ç³»ç»Ÿæ›´åŠ æˆç†Ÿã€‚</li></ul><h3 id="è®¸å¯åè®®å¯¹æ¯”"><a href="#è®¸å¯åè®®å¯¹æ¯”" class="headerlink" title="è®¸å¯åè®®å¯¹æ¯”"></a>è®¸å¯åè®®å¯¹æ¯”</h3><h4 id="Redis-è®¸å¯è¯æ¼”å˜"><a href="#Redis-è®¸å¯è¯æ¼”å˜" class="headerlink" title="Redis è®¸å¯è¯æ¼”å˜"></a>Redis è®¸å¯è¯æ¼”å˜</h4><ul><li><strong>å†å²</strong>ï¼šä»BSD 3-Clauseåˆ°åŒé‡è®¸å¯è¯ï¼ˆRSALv2&#x2F;SSPLv1ï¼‰ï¼Œå†åˆ°Redis 8.0çš„ä¸‰è®¸å¯è¯æ¨¡å¼ï¼ˆRSALv2&#x2F;SSPLv1&#x2F;AGPLv3ï¼‰ã€‚</li><li><strong>ç°çŠ¶</strong>ï¼šè™½ç„¶æ¢å¤äº†AGPLv3ä½¿å…¶é‡æ–°è·å¾—å¼€æºåˆ†ç±»ï¼Œä½†å¤æ‚çš„è®¸å¯ç»“æ„ç»™ä¼ä¸šå¸¦æ¥åˆè§„é£é™©ã€‚</li></ul><p>####Valkey è®¸å¯è¯</p><ul><li><strong>åè®®ç±»å‹</strong>ï¼šBSDè®¸å¯è¯ï¼Œå®Œå…¨å¼€æºï¼Œæ— å•†ä¸šé™åˆ¶ã€‚</li><li><strong>ä¼˜åŠ¿</strong>ï¼šç¬¦åˆå¼€æºç†å¿µï¼Œä¼ä¸šå¯ä»¥è‡ªç”±ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘ï¼Œæ— è®¸å¯åˆè§„é£é™©ã€‚</li></ul><p>####DragonflyDB è®¸å¯è¯</p><ul><li><strong>åè®®ç±»å‹</strong>ï¼šBSLï¼ˆBusiness Source Licenseï¼‰ï¼Œä¸€ç§â€æºç å¯ç”¨â€ä½†éä¸¥æ ¼å¼€æºçš„åè®®ã€‚</li><li><strong>é™åˆ¶</strong>ï¼šåœ¨ç‰¹å®šæ¡ä»¶ä¸‹ï¼ˆå¦‚å•†ä¸šç”¨é€”ã€å¤§è§„æ¨¡éƒ¨ç½²ï¼‰å¯èƒ½éœ€è¦è´­ä¹°å•†ä¸šè®¸å¯ã€‚</li><li><strong>ä¼˜åŠ¿</strong>ï¼šåœ¨å¼€å‘é˜¶æ®µå’Œå°è§„æ¨¡éƒ¨ç½²æ—¶å…è´¹ï¼Œé™ä½äº†å…¥é—¨é—¨æ§›ã€‚</li></ul><h3 id="ç”Ÿæ€ç³»ç»Ÿä¸å…¼å®¹æ€§"><a href="#ç”Ÿæ€ç³»ç»Ÿä¸å…¼å®¹æ€§" class="headerlink" title="ç”Ÿæ€ç³»ç»Ÿä¸å…¼å®¹æ€§"></a>ç”Ÿæ€ç³»ç»Ÿä¸å…¼å®¹æ€§</h3><h4 id="API-å…¼å®¹æ€§"><a href="#API-å…¼å®¹æ€§" class="headerlink" title="API å…¼å®¹æ€§"></a>API å…¼å®¹æ€§</h4><ul><li><strong>Valkey</strong>ï¼š100%å…¼å®¹Redisåè®®ï¼Œç°æœ‰Rediså®¢æˆ·ç«¯å’Œå·¥å…·æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨ã€‚</li><li><strong>DragonflyDB</strong>ï¼šæ¥å£å±‚é¢å®Œå…¨å…¼å®¹Redisï¼Œæ”¯æŒå¤§éƒ¨åˆ†Rediså‘½ä»¤ï¼Œä½†åœ¨æŸäº›é«˜çº§ç‰¹æ€§ï¼ˆå¦‚æ¨¡å—ã€ç‰¹å®šæ•°æ®ç»“æ„ï¼‰ä¸Šå¯èƒ½å­˜åœ¨å·®å¼‚ã€‚</li></ul><h4 id="å·¥å…·é“¾æ”¯æŒ"><a href="#å·¥å…·é“¾æ”¯æŒ" class="headerlink" title="å·¥å…·é“¾æ”¯æŒ"></a>å·¥å…·é“¾æ”¯æŒ</h4><ul><li><strong>Redis</strong>ï¼šæ‹¥æœ‰æœ€å®Œå–„çš„ç”Ÿæ€ç³»ç»Ÿï¼ŒåŒ…æ‹¬ç›‘æ§å·¥å…·ï¼ˆRedisInsightï¼‰ã€ç®¡ç†å·¥å…·ã€å®¢æˆ·ç«¯åº“ç­‰ã€‚</li><li><strong>Valkey</strong>ï¼šç»§æ‰¿Redisçš„å·¥å…·é“¾ï¼Œå¤§éƒ¨åˆ†Rediså·¥å…·å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</li><li><strong>DragonflyDB</strong>ï¼šç”Ÿæ€ç³»ç»Ÿç›¸å¯¹è¾ƒæ–°ï¼Œå·¥å…·é“¾ä»åœ¨å®Œå–„ä¸­ï¼Œä½†å‘å±•è¿…é€Ÿã€‚</li></ul><p>####äº‘æœåŠ¡æ”¯æŒ</p><ul><li><strong>Redis</strong>ï¼šæ‰€æœ‰ä¸»æµäº‘æœåŠ¡å•†éƒ½æä¾›æ‰˜ç®¡RedisæœåŠ¡ï¼ˆå¦‚AWS ElastiCacheã€Azure Cache for Redisï¼‰ã€‚</li><li><strong>Valkey</strong>ï¼šäº‘æœåŠ¡å•†æ­£åœ¨é€æ­¥å¢åŠ æ”¯æŒï¼Œä½†è¦†ç›–èŒƒå›´æœ‰é™ã€‚</li><li><strong>DragonflyDB</strong>ï¼šéƒ¨åˆ†äº‘æœåŠ¡å•†å¼€å§‹æä¾›æ‰˜ç®¡æœåŠ¡ï¼Œä½†æ™®åŠåº¦è¾ƒä½ã€‚</li></ul><h3 id="æŠ€æœ¯é€‰å‹å»ºè®®"><a href="#æŠ€æœ¯é€‰å‹å»ºè®®" class="headerlink" title="æŠ€æœ¯é€‰å‹å»ºè®®"></a>æŠ€æœ¯é€‰å‹å»ºè®®</h3><h4 id="é€‰æ‹©-Redis-çš„åœºæ™¯"><a href="#é€‰æ‹©-Redis-çš„åœºæ™¯" class="headerlink" title="é€‰æ‹© Redis çš„åœºæ™¯"></a>é€‰æ‹© Redis çš„åœºæ™¯</h4><ul><li><strong>å·²æœ‰RedisæŠ•èµ„</strong>ï¼šå·²ç»æ·±åº¦ä½¿ç”¨Redisï¼Œæœ‰æˆç†Ÿçš„è¿ç»´ä½“ç³»å’Œå¼€å‘ä¹ æƒ¯ã€‚</li><li><strong>ä¼ä¸šçº§æ”¯æŒéœ€æ±‚</strong>ï¼šéœ€è¦å®˜æ–¹å•†ä¸šæ”¯æŒå’ŒSLAä¿éšœã€‚</li><li><strong>å¤æ‚ç‰¹æ€§éœ€æ±‚</strong>ï¼šéœ€è¦Redis Modulesï¼ˆå¦‚RediSearchã€RedisJSONï¼‰ç­‰é«˜çº§ç‰¹æ€§ã€‚</li><li><strong>æ··åˆè®¸å¯æ¥å—åº¦</strong>ï¼šèƒ½å¤Ÿæ¥å—Redis 8.0çš„ä¸‰é‡è®¸å¯æ¨¡å¼ï¼Œä¸”æœ‰æ³•åŠ¡å›¢é˜Ÿè¿›è¡Œåˆè§„å®¡æŸ¥ã€‚</li></ul><h4 id="é€‰æ‹©-Valkey-çš„åœºæ™¯"><a href="#é€‰æ‹©-Valkey-çš„åœºæ™¯" class="headerlink" title="é€‰æ‹© Valkey çš„åœºæ™¯"></a>é€‰æ‹© Valkey çš„åœºæ™¯</h4><ul><li><strong>å¼€æºåˆè§„ä¼˜å…ˆ</strong>ï¼šä¼ä¸šæœ‰ä¸¥æ ¼çš„å¼€æºåˆè§„è¦æ±‚ï¼Œæ— æ³•æ¥å—SSPL&#x2F;RSALç­‰é™åˆ¶æ€§åè®®ã€‚</li><li><strong>å¹³æ»‘è¿ç§»éœ€æ±‚</strong>ï¼šå¸Œæœ›ä»Redisæ— ç¼è¿ç§»ï¼Œé¿å…ä»£ç é‡æ„å’Œæ¶æ„è°ƒæ•´ã€‚</li><li><strong>ç¤¾åŒºé©±åŠ¨åå¥½</strong>ï¼šä¿¡ä»»ç¤¾åŒºé©±åŠ¨çš„å¼€æºé¡¹ç›®ï¼Œè€Œéå•ä¸€å•†ä¸šå…¬å¸çš„æ§åˆ¶ã€‚</li><li><strong>ç¨³å®šæ€§è¦æ±‚é«˜</strong>ï¼šéœ€è¦ç»è¿‡å……åˆ†éªŒè¯çš„ç¨³å®šç‰ˆæœ¬ï¼Œè€Œéå®éªŒæ€§æ–°æŠ€æœ¯ã€‚</li></ul><h4 id="é€‰æ‹©-DragonflyDB-çš„åœºæ™¯"><a href="#é€‰æ‹©-DragonflyDB-çš„åœºæ™¯" class="headerlink" title="é€‰æ‹© DragonflyDB çš„åœºæ™¯"></a>é€‰æ‹© DragonflyDB çš„åœºæ™¯</h4><ul><li><strong>æè‡´æ€§èƒ½éœ€æ±‚</strong>ï¼šåº”ç”¨åœºæ™¯éœ€è¦è¶…é«˜QPSï¼ˆ&gt;100Kï¼‰æˆ–ä½å»¶è¿Ÿï¼ˆ&lt;1msï¼‰ã€‚</li><li><strong>æˆæœ¬æ•æ„Ÿå‹åº”ç”¨</strong>ï¼šé€šè¿‡å•å®ä¾‹çš„é«˜æ€§èƒ½é™ä½ç¡¬ä»¶æˆæœ¬å’Œè¿ç»´å¤æ‚åº¦ã€‚</li><li><strong>å¤šæ ¸CPUç¯å¢ƒ</strong>ï¼šæœåŠ¡å™¨é…ç½®äº†å¤šæ ¸CPUï¼Œå¸Œæœ›å……åˆ†åˆ©ç”¨ç¡¬ä»¶èµ„æºã€‚</li><li><strong>æ–°å…´æŠ€æœ¯æ¥å—åº¦é«˜</strong>ï¼šæ„¿æ„å°è¯•æ–°æŠ€æœ¯ï¼Œèƒ½å¤Ÿæ‰¿æ‹…æ—©æœŸé‡‡ç”¨è€…çš„é£é™©ã€‚</li></ul><h3 id="æ•´ä½“æœªæ¥å‘å±•è¶‹åŠ¿é¢„ä¼°"><a href="#æ•´ä½“æœªæ¥å‘å±•è¶‹åŠ¿é¢„ä¼°" class="headerlink" title="æ•´ä½“æœªæ¥å‘å±•è¶‹åŠ¿é¢„ä¼°"></a>æ•´ä½“æœªæ¥å‘å±•è¶‹åŠ¿é¢„ä¼°</h3><h4 id="æŠ€æœ¯æ¼”è¿›æ–¹å‘"><a href="#æŠ€æœ¯æ¼”è¿›æ–¹å‘" class="headerlink" title="æŠ€æœ¯æ¼”è¿›æ–¹å‘"></a>æŠ€æœ¯æ¼”è¿›æ–¹å‘</h4><ul><li><strong>Redis&#x2F;Valkey</strong>ï¼šå°†ç»§ç»­ä¼˜åŒ–å•çº¿ç¨‹æ¨¡å‹ï¼Œå¢å¼ºé›†ç¾¤ç®¡ç†å’Œè‡ªåŠ¨åŒ–è¿ç»´èƒ½åŠ›ã€‚</li><li><strong>DragonflyDB</strong>ï¼šå°†è¿›ä¸€æ­¥å®Œå–„å¤šçº¿ç¨‹æ¶æ„ï¼Œæå‡å†…å­˜æ•ˆç‡å’Œæ°´å¹³æ‰©å±•èƒ½åŠ›ã€‚</li></ul><h4 id="å¸‚åœºæ ¼å±€é¢„æµ‹"><a href="#å¸‚åœºæ ¼å±€é¢„æµ‹" class="headerlink" title="å¸‚åœºæ ¼å±€é¢„æµ‹"></a>å¸‚åœºæ ¼å±€é¢„æµ‹</h4><ul><li><strong>çŸ­æœŸ</strong>ï¼ˆ1-2å¹´ï¼‰ï¼šRedisä»å°†ä¿æŒå¸‚åœºä¸»å¯¼åœ°ä½ï¼ŒValkeyåœ¨å¼€æºç¤¾åŒºå¿«é€Ÿå¢é•¿ï¼ŒDragonflyDBåœ¨æ€§èƒ½æ•æ„Ÿåœºæ™¯è·å¾—é‡‡ç”¨ã€‚</li><li><strong>ä¸­æœŸ</strong>ï¼ˆ3-5å¹´ï¼‰ï¼šå¯èƒ½å‡ºç°ä¸‰è¶³é¼ç«‹çš„å±€é¢ï¼Œä¸åŒåœºæ™¯é€‰æ‹©ä¸åŒæŠ€æœ¯æ ˆã€‚</li><li><strong>é•¿æœŸ</strong>ï¼šæ¶æ„åˆ›æ–°ï¼ˆå¦‚DragonflyDBçš„å¤šçº¿ç¨‹æ¨¡å‹ï¼‰å¯èƒ½æˆä¸ºä¸»æµï¼Œæ¨åŠ¨æ•´ä¸ªè¡Œä¸šæŠ€æœ¯æ¼”è¿›ã€‚</li></ul><h3 id="è¿ç§»ç­–ç•¥å»ºè®®"><a href="#è¿ç§»ç­–ç•¥å»ºè®®" class="headerlink" title="è¿ç§»ç­–ç•¥å»ºè®®"></a>è¿ç§»ç­–ç•¥å»ºè®®</h3><h4 id="Redis-â†’-Valkey"><a href="#Redis-â†’-Valkey" class="headerlink" title="Redis â†’ Valkey"></a>Redis â†’ Valkey</h4><ul><li><strong>éš¾åº¦</strong>ï¼šæä½ï¼Œå‡ ä¹æ— ç¼è¿ç§»ã€‚</li><li><strong>æ­¥éª¤</strong>ï¼šå¤‡ä»½æ•°æ® â†’ åœæ­¢RedisæœåŠ¡ â†’ å®‰è£…Valkey â†’ æ¢å¤æ•°æ® â†’ éªŒè¯åŠŸèƒ½ã€‚</li><li><strong>é£é™©</strong>ï¼šå‡ ä¹ä¸ºé›¶ï¼ŒValkeyæ‰¿è¯º100%å…¼å®¹Redisã€‚</li></ul><h4 id="Redis-â†’-DragonflyDB"><a href="#Redis-â†’-DragonflyDB" class="headerlink" title="Redis â†’ DragonflyDB"></a>Redis â†’ DragonflyDB</h4><ul><li><strong>éš¾åº¦</strong>ï¼šä¸­ç­‰ï¼Œéœ€è¦éªŒè¯å‘½ä»¤å…¼å®¹æ€§ã€‚</li><li><strong>æ­¥éª¤</strong>ï¼šåŠŸèƒ½éªŒè¯ â†’ æ€§èƒ½æµ‹è¯• â†’ è¯•ç‚¹è¿ç§» â†’ å…¨é‡åˆ‡æ¢ã€‚</li><li><strong>é£é™©</strong>ï¼šæŸäº›é«˜çº§ç‰¹æ€§å¯èƒ½ä¸æ”¯æŒï¼Œéœ€è¦ä»£ç è°ƒæ•´ã€‚</li></ul><h4 id="æ··åˆéƒ¨ç½²ç­–ç•¥"><a href="#æ··åˆéƒ¨ç½²ç­–ç•¥" class="headerlink" title="æ··åˆéƒ¨ç½²ç­–ç•¥"></a>æ··åˆéƒ¨ç½²ç­–ç•¥</h4><p>åœ¨å…³é”®ä¸šåŠ¡ä¸­ï¼Œå¯ä»¥è€ƒè™‘æ··åˆéƒ¨ç½²ç­–ç•¥ï¼š</p><ul><li>æ ¸å¿ƒä¸šåŠ¡ä½¿ç”¨Valkeyç¡®ä¿ç¨³å®šæ€§å’Œå…¼å®¹æ€§</li><li>é«˜æ€§èƒ½åœºæ™¯ä½¿ç”¨DragonflyDBå¤„ç†çƒ­ç‚¹æ•°æ®</li><li>é€šè¿‡æ•°æ®åŒæ­¥æˆ–åˆ†å±‚æ¶æ„å®ç°æ— ç¼é›†æˆ</li></ul><h2 id="åä¸€ã€ä¸ªäººå¿ƒå¾—"><a href="#åä¸€ã€ä¸ªäººå¿ƒå¾—" class="headerlink" title="åä¸€ã€ä¸ªäººå¿ƒå¾—"></a>åä¸€ã€ä¸ªäººå¿ƒå¾—</h2><p>åœ¨2026å¹´çš„æŠ€æœ¯æ ¼å±€ä¸­ï¼ŒRedisã€Valkeyå’ŒDragonflyDBå„è‡ªä»£è¡¨äº†ä¸åŒçš„æŠ€æœ¯å“²å­¦å’Œå‘å±•è·¯å¾„ï¼š</p><ul><li><strong>Redis</strong>ï¼šæˆç†Ÿçš„å•†ä¸šå¼€æºæ¨¡å¼ï¼ŒåŠŸèƒ½ä¸°å¯Œä½†è®¸å¯å¤æ‚</li><li><strong>Valkey</strong>ï¼šç¤¾åŒºé©±åŠ¨çš„çœŸæ­£å¼€æºï¼Œå…¼å®¹ç¨³å®šä½†ç¼ºä¹åˆ›æ–°çªç ´  </li><li><strong>DragonflyDB</strong>ï¼šæ¶æ„åˆ›æ–°çš„æ€§èƒ½ç‹è€…ï¼Œå‰æ™¯å¹¿é˜”ä½†ç”Ÿæ€å¾…å®Œå–„</li></ul><p><strong>é€‰å‹å†³ç­–æ¡†æ¶</strong>ï¼š</p><ol><li><strong>å…ˆçœ‹è®¸å¯è¦æ±‚</strong>ï¼šä¼ä¸šåˆè§„ &gt; æŠ€æœ¯ç‰¹æ€§</li><li><strong>å†çœ‹æ€§èƒ½éœ€æ±‚</strong>ï¼šQPS&#x2F;å»¶è¿ŸæŒ‡æ ‡ &gt; æ¶æ„åå¥½  </li><li><strong>æœ€åçœ‹ç”Ÿæ€æˆç†Ÿåº¦</strong>ï¼šè¿ç»´æˆæœ¬ &gt; å­¦ä¹ æ›²çº¿</li></ol><p>æŠ€æœ¯é€‰å‹æ²¡æœ‰ç»å¯¹çš„å¯¹é”™ï¼Œåªæœ‰æœ€é€‚åˆå½“å‰ä¸šåŠ¡åœºæ™¯çš„é€‰æ‹©ã€‚<br>å»ºè®®åœ¨åšå‡ºå†³ç­–å‰ï¼Œè¿›è¡Œå……åˆ†çš„æ¦‚å¿µéªŒè¯ï¼ˆPoCï¼‰æµ‹è¯•ï¼Œç»“åˆå…·ä½“çš„ä¸šåŠ¡éœ€æ±‚ã€å›¢é˜ŸæŠ€èƒ½å’Œé•¿æœŸæˆ˜ç•¥è¿›è¡Œç»¼åˆè¯„ä¼°ã€‚<br>éšç€æŠ€æœ¯çš„å¿«é€Ÿå‘å±•ï¼Œä¿æŒæ¶æ„çš„çµæ´»æ€§å’Œå¯è¿ç§»æ€§ï¼Œæ¯”ç»‘å®šå•ä¸€æŠ€æœ¯æ ˆæ›´ä¸ºé‡è¦ã€‚   </p><p>âš ï¸ è¡¥å……è¯´æ˜ï¼šå› ç‰ˆæœ¬æ›´æ–°ç»„å»ºå˜åŒ–å¿«ï¼Œå¦‚æœ‰äº‰è®®ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†ã€‚<a href="https://redis.io/docs/latest/">Redis Docs</a></p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;hr&gt;
&lt;h2 id=&quot;Redis-æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#Redis-æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;Redis æ¦‚è¿°&quot;&gt;&lt;/a&gt;Redis æ¦‚è¿°&lt;/h2&gt;&lt;p&gt;Redis ä½œä¸ºå½“ä»Šæœ€æµè¡Œçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå‡­å€Ÿå…¶å“è¶Šçš„æ€§èƒ½å’Œä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼Œå·²æˆä¸ºç°ä»£åº”ç”¨æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„ç»„ä»¶ã€‚&lt;br&gt;æœ¬æ–‡å°†åŸºäº Debian 12 ç¯å¢ƒä» Redis çš„ç‰ˆæœ¬æ¼”è¿›å‡ºå‘ï¼Œå®Œæ•´éƒ¨ç½²æµç¨‹ï¼Œä»å•ä½“åˆ°é›†ç¾¤ï¼Œä»åŸºç¡€é…ç½®åˆ°é«˜çº§åº”ç”¨ï¼Œæœ€åæä¾›å¤šè¯­è¨€å®¢æˆ·ç«¯æ“ä½œç¤ºä¾‹ï¼Œå¸®åŠ©æ–°æ‰‹å…¨é¢å¿«é€ŸæŒæ¡ Redis æŠ€æœ¯æ ˆçš„åŸºæœ¬ä½¿ç”¨ï¼Œæœ‰ä¸ªç›¸å¯¹åŸºç¡€çš„æ€è·¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="nosql" scheme="https://www.wdft.com/categories/nosql/"/>
    
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="nosql" scheme="https://www.wdft.com/tags/nosql/"/>
    
    <category term="Redis" scheme="https://www.wdft.com/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Golang CHANGELOG History(æˆªè‡³ 2025.11.07 çš„å®Œæ•´å˜æ›´æ—¥å¿— Changelog)</title>
    <link href="https://www.wdft.com/3ba902b3.html"/>
    <id>https://www.wdft.com/3ba902b3.html</id>
    <published>2025-11-07T14:13:07.000Z</published>
    <updated>2025-12-24T09:46:05.292Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><p>Golang Changelog**ï¼š</p><hr><h1 id="Go-è¯­è¨€ç‰ˆæœ¬å˜æ›´æ—¥å¿—ï¼ˆæˆªè‡³-2025-11-07-çš„å˜æ›´æ—¥å¿—ï¼‰"><a href="#Go-è¯­è¨€ç‰ˆæœ¬å˜æ›´æ—¥å¿—ï¼ˆæˆªè‡³-2025-11-07-çš„å˜æ›´æ—¥å¿—ï¼‰" class="headerlink" title="Go è¯­è¨€ç‰ˆæœ¬å˜æ›´æ—¥å¿—ï¼ˆæˆªè‡³ 2025.11.07 çš„å˜æ›´æ—¥å¿—ï¼‰"></a>Go è¯­è¨€ç‰ˆæœ¬å˜æ›´æ—¥å¿—ï¼ˆæˆªè‡³ 2025.11.07 çš„å˜æ›´æ—¥å¿—ï¼‰</h1><h2 id="Go-1-25-2025-å¹´-8-æœˆ-12-æ—¥å‘å¸ƒ"><a href="#Go-1-25-2025-å¹´-8-æœˆ-12-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.25 (2025 å¹´ 8 æœˆ 12 æ—¥å‘å¸ƒ)"></a>Go 1.25 (2025 å¹´ 8 æœˆ 12 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2025 å¹´ 8 æœˆ 12 æ—¥<br><strong>ç‰ˆæœ¬å‘¨æœŸ</strong>: è·ç¦» Go 1.24 å‘å¸ƒå…­ä¸ªæœˆ<br><strong>å…¼å®¹æ€§</strong>: ä¿æŒ Go 1 çš„å…¼å®¹æ€§æ‰¿è¯º </p><span id="more"></span><h3 id="ä¸»è¦ç‰¹æ€§ä¸æ”¹è¿›"><a href="#ä¸»è¦ç‰¹æ€§ä¸æ”¹è¿›" class="headerlink" title="ä¸»è¦ç‰¹æ€§ä¸æ”¹è¿›:"></a>ä¸»è¦ç‰¹æ€§ä¸æ”¹è¿›:</h3><ul><li><p><strong>è¯­è¨€ä¸ç¼–è¯‘å™¨</strong>: </p><ul><li>å¤§éƒ¨åˆ†æ›´æ”¹é›†ä¸­åœ¨å·¥å…·é“¾ã€è¿è¡Œæ—¶å’Œåº“çš„å®ç°ä¼˜åŒ– </li><li>æ²¡æœ‰å¼•å…¥ç ´åæ€§çš„è¯­è¨€å˜åŒ–</li></ul></li><li><p><strong>æ ‡å‡†åº“å¢å¼º</strong>:</p><ul><li>æ–°å¢<code>encoding/json/v2</code>åŒ…ï¼ˆé€šè¿‡<code>GOEXPERIMENT=jsonv2</code>æ ‡å¿—å¯ç”¨ï¼‰ï¼Œå¸¦æ¥æ˜¾è‘—æ€§èƒ½æ”¹è¿› </li><li>ä¿®å¤äº†<code>crypto/subtle</code>ã€<code>encoding/pem</code>ã€<code>net/url</code>å’Œ<code>os</code>ç­‰åŒ…çš„å¤šä¸ªé—®é¢˜</li></ul></li><li><p><strong>è¿è¡Œæ—¶ä¼˜åŒ–</strong>:</p><ul><li>å®¹å™¨æ„ŸçŸ¥è¿è¡Œæ—¶ï¼Œæ›´å¥½åœ°é€‚åº”å®¹å™¨åŒ–ç¯å¢ƒ </li><li>å®éªŒæ€§åŠŸèƒ½æ”¯æŒï¼Œä¸ºæœªæ¥ç‰ˆæœ¬å¥ å®šåŸºç¡€</li></ul></li><li><p><strong>æ€§èƒ½æ”¹è¿›</strong>:</p><ul><li>è¿è¡Œæ—¶æ€§èƒ½æ˜¾è‘—ä¼˜åŒ–ï¼Œæä¾›æ›´é«˜æ•ˆçš„æ‰§è¡Œä½“éªŒ </li><li>å†…å­˜ç®¡ç†å’Œåƒåœ¾å›æ”¶è¿›ä¸€æ­¥ä¼˜åŒ–</li></ul></li></ul><h2 id="Go-1-24-2025-å¹´-2-æœˆ-6-æ—¥å‘å¸ƒ"><a href="#Go-1-24-2025-å¹´-2-æœˆ-6-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.24 (2025 å¹´ 2 æœˆ 6 æ—¥å‘å¸ƒ)"></a>Go 1.24 (2025 å¹´ 2 æœˆ 6 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2025 å¹´ 2 æœˆ 6 æ—¥<br><strong>ç‰ˆæœ¬å‘¨æœŸ</strong>: è·ç¦» Go 1.23 å‘å¸ƒå…­ä¸ªæœˆï¼Œå¼€å‘å‘¨æœŸä» 2024 å¹´ 7 æœˆå¼€å§‹ï¼Œ11 æœˆä¸‹æ—¬å†»ç»“ï¼Œç»è¿‡ 3 ä¸ªæœˆæµ‹è¯•å®Œå–„ </p><h3 id="ä¸»è¦ç‰¹æ€§ä¸æ”¹è¿›-1"><a href="#ä¸»è¦ç‰¹æ€§ä¸æ”¹è¿›-1" class="headerlink" title="ä¸»è¦ç‰¹æ€§ä¸æ”¹è¿›:"></a>ä¸»è¦ç‰¹æ€§ä¸æ”¹è¿›:</h3><ul><li><p><strong>è¯­è¨€ç‰¹æ€§</strong>:</p><ul><li><strong>æ³›å‹ç±»å‹åˆ«å</strong>: å®Œå…¨æ”¯æŒæ³›å‹ç±»å‹åˆ«åï¼Œå…è®¸å¼€å‘è€…ä»¥ä¸å®šä¹‰æ³›å‹ç›¸åŒçš„æ–¹å¼å‚æ•°åŒ–ç±»å‹åˆ«å </li><li><strong>å¼±æŒ‡é’ˆæ”¯æŒ</strong>: å¼•å…¥å…¨æ–°çš„<code>weak</code>åŒ…ï¼Œæ”¯æŒå¼±æŒ‡é’ˆåŠŸèƒ½ </li><li><strong>ç»ˆç»“å™¨å¢å¼º</strong>: æ”¹è¿›å¯¹è±¡æ¸…ç†æœºåˆ¶ï¼Œæä¾›æ›´æ™ºèƒ½çš„èµ„æºç®¡ç†</li></ul></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong>:</p><ul><li><strong>CPU æ€§èƒ½æå‡</strong>: CPU å¼€é”€å¹³å‡é™ä½ 2-3% </li><li><strong>Map å®ç°é‡æ„</strong>: åŸºäº Swiss Tables çš„å…¨æ–°å†…ç½® map å®ç°ï¼Œå¤§å¹…æå‡ map æ“ä½œæ€§èƒ½ </li><li><strong>å†…å­˜åˆ†é…ä¼˜åŒ–</strong>: æ›´é«˜æ•ˆçš„å°å¯¹è±¡å†…å­˜åˆ†é…ç­–ç•¥ </li><li><strong>åƒåœ¾å›æ”¶æ”¹è¿›</strong>: æ›´æ™ºèƒ½çš„åƒåœ¾å›æ”¶ä¸å¯¹è±¡æ¸…ç†æœºåˆ¶</li></ul></li><li><p><strong>å·¥å…·é“¾æ›´æ–°</strong>:</p><ul><li>æ›´æ™ºèƒ½çš„ä¾èµ–ç®¡ç† </li><li>æ„å»ºç³»ç»Ÿå’Œæµ‹è¯•å·¥å…·çš„å¤šé¡¹æ”¹è¿›</li></ul></li><li><p><strong>æ–‡ä»¶ç³»ç»Ÿè®¿é—®</strong>:</p><ul><li>ç›®å½•èŒƒå›´çš„æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ§åˆ¶ </li><li>å¢å¼ºçš„æ–‡ä»¶æ“ä½œå®‰å…¨æ€§å’Œæ€§èƒ½</li></ul></li></ul><h3 id="ç‰ˆæœ¬ç»´æŠ¤"><a href="#ç‰ˆæœ¬ç»´æŠ¤" class="headerlink" title="ç‰ˆæœ¬ç»´æŠ¤:"></a>ç‰ˆæœ¬ç»´æŠ¤:</h3><ul><li>å®šæœŸå®‰å…¨æ›´æ–°ï¼Œå¦‚ go1.24.5ï¼ˆ2025 å¹´ 7 æœˆ 8 æ—¥å‘å¸ƒï¼‰åŒ…å« go å‘½ä»¤çš„å®‰å…¨ä¿®å¤ï¼Œä»¥åŠç¼–è¯‘å™¨ã€é“¾æ¥å™¨ã€è¿è¡Œæ—¶å’Œ go å‘½ä»¤çš„é”™è¯¯ä¿®å¤</li></ul><h2 id="Go-1-23-2024-å¹´-8-æœˆ-6-æ—¥å‘å¸ƒ"><a href="#Go-1-23-2024-å¹´-8-æœˆ-6-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.23 (2024 å¹´ 8 æœˆ 6 æ—¥å‘å¸ƒ)"></a>Go 1.23 (2024 å¹´ 8 æœˆ 6 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2024 å¹´ 8 æœˆ 6 æ—¥</p><h3 id="è¯­è¨€ç‰¹æ€§"><a href="#è¯­è¨€ç‰¹æ€§" class="headerlink" title="è¯­è¨€ç‰¹æ€§"></a>è¯­è¨€ç‰¹æ€§</h3><ul><li><strong>è¿­ä»£å™¨è¯­æ³•è½¬æ­£</strong>ï¼šfor-range å¾ªç¯æ”¯æŒä½¿ç”¨å‡½æ•°ä½œä¸º range è¡¨è¾¾å¼ï¼Œæ ‡å‡†åº“ slices å’Œ maps åŒ…æ–°å¢è¿­ä»£å™¨æ”¯æŒ</li><li><strong>æ³›å‹ç±»å‹åˆ«åé¢„è§ˆ</strong>ï¼šå¯ç”¨<code>GOEXPERIMENT=aliastypeparams</code>åå¯åœ¨åŒ…å†…ä½¿ç”¨æ³›å‹ç±»å‹åˆ«å</li><li><strong>åŒ…çº§å˜é‡åˆå§‹åŒ–æ¬¡åºæ˜ç¡®åŒ–</strong>ï¼šä¿®æ­£å¹¶æ˜ç¡®åŒ…çº§å˜é‡åˆå§‹åŒ–é¡ºåº</li><li><strong>æœ¯è¯­è§„èŒƒ</strong>ï¼šæ¾„æ¸…â€ä¸¥æ ¼å¯æ¯”è¾ƒâ€å’Œâ€ç±»å‹çº¦æŸâ€ç­‰æœ¯è¯­ï¼Œç¦æ­¢åŒ¿åæ¥å£ç±»å‹çš„å¾ªç¯å®šä¹‰</li></ul><h3 id="å·¥å…·é“¾"><a href="#å·¥å…·é“¾" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>æ–°å¢ go telemetry å‘½ä»¤</strong>ï¼šå¯é€‰çš„é¥æµ‹ç³»ç»Ÿï¼Œæ”¯æŒ on&#x2F;local&#x2F;off ä¸‰ç§æ¨¡å¼</li><li><strong>æ„å»ºç»“æœ JSON åŒ–</strong>ï¼š<code>go build -json</code>æ”¯æŒç»“æ„åŒ–è¾“å‡º</li><li><strong>ç§»é™¤ GOROOT_FINAL æ”¯æŒ</strong></li></ul><h3 id="è¿è¡Œæ—¶ä¸ç¼–è¯‘å™¨"><a href="#è¿è¡Œæ—¶ä¸ç¼–è¯‘å™¨" class="headerlink" title="è¿è¡Œæ—¶ä¸ç¼–è¯‘å™¨"></a>è¿è¡Œæ—¶ä¸ç¼–è¯‘å™¨</h3><ul><li><strong>Timer&#x2F;Ticker æ”¹è¿›</strong>ï¼š<ul><li>æœªå¼•ç”¨çš„ Timer&#x2F;Ticker å¯è¢« GC ç«‹å³å›æ”¶ï¼Œæ— éœ€æ‰‹åŠ¨ Stop</li><li>Timer&#x2F;Ticker çš„ channel æ”¹ä¸ºæ— ç¼“å†²ï¼Œä¿è¯ Stop&#x2F;Reset åä¸æ¥æ”¶æ—§å€¼</li></ul></li><li><strong>PGO ä¼˜åŒ–</strong>ï¼šé€šè¿‡é‡å å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„æ ˆå¸§æ§½ä½å‡å°‘æ ˆä½¿ç”¨ï¼Œæ”¹å–„ç¼–è¯‘æ—¶é—´</li><li><strong>æ¶æ„æ”¯æŒ</strong>ï¼šæ–°å¢ GOARM64 å’Œ GORISCV64 ç¯å¢ƒå˜é‡ï¼Œæ”¯æŒ openbsd&#x2F;riscv64 å®éªŒæ€§ç«¯å£</li></ul><h3 id="ç³»ç»Ÿè¦æ±‚"><a href="#ç³»ç»Ÿè¦æ±‚" class="headerlink" title="ç³»ç»Ÿè¦æ±‚"></a>ç³»ç»Ÿè¦æ±‚</h3><ul><li>macOS æœ€ä½ç‰ˆæœ¬è¦æ±‚æå‡è‡³ 11 Big Sur</li><li>æœ€åä¸€ä¸ªæ”¯æŒ Linux 2.6.32 çš„ç‰ˆæœ¬ï¼ˆGo 1.24 å°†è¦æ±‚ Linux 3.17+ï¼‰</li></ul><hr><h2 id="Go-1-22-2024-å¹´-2-æœˆ-6-æ—¥å‘å¸ƒ"><a href="#Go-1-22-2024-å¹´-2-æœˆ-6-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.22 (2024 å¹´ 2 æœˆ 6 æ—¥å‘å¸ƒ)"></a>Go 1.22 (2024 å¹´ 2 æœˆ 6 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2024 å¹´ 2 æœˆ 6 æ—¥</p><h3 id="è¯­è¨€ç‰¹æ€§-1"><a href="#è¯­è¨€ç‰¹æ€§-1" class="headerlink" title="è¯­è¨€ç‰¹æ€§"></a>è¯­è¨€ç‰¹æ€§</h3><ul><li><strong>For å¾ªç¯å˜é‡ä½œç”¨åŸŸä¿®å¤</strong>ï¼šæ¯æ¬¡è¿­ä»£åˆ›å»ºæ–°å˜é‡ï¼Œè§£å†³å¾ªç¯å˜é‡æ„å¤–å…±äº«é—®é¢˜</li><li><strong>æ•´æ•°èŒƒå›´æ”¯æŒ</strong>ï¼šæ”¯æŒ<code>for i := range n</code>è¯­æ³•ï¼ˆn ä¸ºæ•´æ•°ï¼‰</li></ul><h3 id="æ ‡å‡†åº“"><a href="#æ ‡å‡†åº“" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>æ–°å¢ math&#x2F;rand&#x2F;v2 åŒ…</strong>ï¼šæ›´ç®€æ´çš„ APIï¼Œæ›´é«˜è´¨é‡çš„ä¼ªéšæœºç®—æ³•</li><li><strong>æ–°å¢ go&#x2F;version åŒ…</strong>ï¼šç‰ˆæœ¬ä¿¡æ¯ç®¡ç†</li><li><strong>net&#x2F;http è·¯ç”±å¢å¼º</strong>ï¼šæ”¯æŒæ–¹æ³•ï¼ˆGET&#x2F;POST ç­‰ï¼‰å’Œé€šé…ç¬¦ï¼ˆå¦‚<code>/task/&#123;id&#125;/</code>ï¼‰</li><li><strong>database&#x2F;sql æ–°å¢ Null[T]ç±»å‹</strong>ï¼šæ›´å¥½çš„å¯ç©ºåˆ—å¤„ç†</li><li><strong>slices åŒ…æ–°å¢ Concat å‡½æ•°</strong>ï¼šè¿æ¥å¤šä¸ªåˆ‡ç‰‡</li></ul><h3 id="å·¥å…·é“¾-1"><a href="#å·¥å…·é“¾-1" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>go vet å¢å¼º</strong>ï¼šæ£€æµ‹å¾ªç¯å˜é‡å¼•ç”¨ã€log&#x2F;slog é”®å€¼ä¸åŒ¹é…ç­‰é—®é¢˜</li><li><strong>go env -changed</strong>ï¼šåˆ—å‡ºéé»˜è®¤ç¯å¢ƒé…ç½®</li><li><strong>go mod tidy -diff</strong>ï¼šé¢„è§ˆæ–‡ä»¶å˜æ›´è€Œä¸å®é™…ä¿®æ”¹</li></ul><h3 id="è¿è¡Œæ—¶"><a href="#è¿è¡Œæ—¶" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>GC å…ƒæ•°æ®ä¼˜åŒ–</strong>ï¼šæå‡ 1-3% CPU æ€§èƒ½ï¼Œå‡å°‘çº¦ 1%å†…å­˜å¼€é”€</li><li><strong>Windows&#x2F;AMD64 å¢å¼º</strong>ï¼šæ”¯æŒ SetUnhandledExceptionFilter æ•è·æœªå¤„ç†å¼‚å¸¸</li></ul><hr><h2 id="Go-1-21-2023-å¹´-8-æœˆ-8-æ—¥å‘å¸ƒ"><a href="#Go-1-21-2023-å¹´-8-æœˆ-8-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.21 (2023 å¹´ 8 æœˆ 8 æ—¥å‘å¸ƒ)"></a>Go 1.21 (2023 å¹´ 8 æœˆ 8 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2023 å¹´ 8 æœˆ 8 æ—¥</p><h3 id="ä¸»è¦ç‰¹æ€§"><a href="#ä¸»è¦ç‰¹æ€§" class="headerlink" title="ä¸»è¦ç‰¹æ€§"></a>ä¸»è¦ç‰¹æ€§</h3><ul><li><strong>min&#x2F;max å†…ç½®å‡½æ•°</strong>ï¼šæ”¯æŒä»»æ„å¯æ¯”è¾ƒæœ‰åºç±»å‹</li><li><strong>clear å†…ç½®å‡½æ•°</strong>ï¼šæ¸…ç©º map æˆ–åˆ‡ç‰‡</li><li><strong>ç»“æ„åŒ–æ—¥å¿—å®Œå–„</strong>ï¼šlog&#x2F;slog åŒ…æ€§èƒ½ä¼˜åŒ–</li><li><strong>panic è°ƒç”¨æ ˆæ”¹è¿›</strong>ï¼šä¼˜åŒ–é”™è¯¯ä¿¡æ¯å±•ç¤º</li></ul><h3 id="å·¥å…·é“¾-2"><a href="#å·¥å…·é“¾-2" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>Go å·¥å…·é“¾æ¨¡å—åŒ–</strong>ï¼šgo å‘½ä»¤ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶</li><li>**åŸºäºé…ç½®æ–‡ä»¶ä¼˜åŒ–(PGO)**ï¼šæ­£å¼ç¨³å®šæ”¯æŒ</li><li><strong>go test è¦†ç›–ç‡æ”¹è¿›</strong>ï¼šæ”¯æŒé›†æˆæµ‹è¯•è¦†ç›–ç‡æ”¶é›†</li></ul><h3 id="æ ‡å‡†åº“-1"><a href="#æ ‡å‡†åº“-1" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>æ–°å¢ maps åŒ…</strong>ï¼šmap ç›¸å…³æ“ä½œå‡½æ•°</li><li><strong>æ–°å¢ slices åŒ…</strong>ï¼šåˆ‡ç‰‡æ“ä½œå‡½æ•°ï¼ˆå®éªŒæ€§ï¼‰</li></ul><h3 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h3><ul><li><strong>åƒåœ¾å›æ”¶å™¨ä¼˜åŒ–</strong>ï¼šæŸäº›ç¨‹åºæ€§èƒ½æå‡å¯è¾¾ 40%</li><li><strong>å†…å­˜åˆ†é…å™¨ä¼˜åŒ–</strong>ï¼šå‡å°‘é”ç«äº‰</li></ul><hr><h2 id="Go-1-20-2023-å¹´-2-æœˆ-1-æ—¥å‘å¸ƒ"><a href="#Go-1-20-2023-å¹´-2-æœˆ-1-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.20 (2023 å¹´ 2 æœˆ 1 æ—¥å‘å¸ƒ)"></a>Go 1.20 (2023 å¹´ 2 æœˆ 1 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2023 å¹´ 2 æœˆ 1 æ—¥</p><h3 id="è¯­è¨€ç‰¹æ€§-2"><a href="#è¯­è¨€ç‰¹æ€§-2" class="headerlink" title="è¯­è¨€ç‰¹æ€§"></a>è¯­è¨€ç‰¹æ€§</h3><ul><li><strong>åˆ‡ç‰‡è½¬æ•°ç»„æŒ‡é’ˆç®€åŒ–</strong>ï¼šè¯­æ³•æ›´ç®€æ´ï¼Œæ— éœ€ unsafe åŒ…</li></ul><h3 id="å·¥å…·é“¾-3"><a href="#å·¥å…·é“¾-3" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>åº”ç”¨è¦†ç›–ç‡æŠ¥å‘Š</strong>ï¼šæ‰©å±•<code>go test -cover</code>æ”¯æŒåº”ç”¨æ•´ä½“è¦†ç›–ç‡ç»Ÿè®¡</li><li><strong>åºŸå¼ƒ-i æ ‡å¿—</strong>ï¼šgo build&#x2F;install&#x2F;test ä¸å†æ”¯æŒ-i æ ‡å¿—</li></ul><h3 id="æ ‡å‡†åº“-2"><a href="#æ ‡å‡†åº“-2" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>æ–°å¢ http.ResponseController</strong>ï¼šæ”¯æŒå¯¹æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚è¿›è¡Œæ›´ç²¾ç»†æ§åˆ¶</li><li><strong>æ–°å¢ crypto&#x2F;ecdh åŒ…</strong>ï¼šæ¤­åœ†æ›²çº¿ Diffie-Hellman å¯†é’¥äº¤æ¢</li></ul><h3 id="è¿è¡Œæ—¶-1"><a href="#è¿è¡Œæ—¶-1" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>å¯åŠ¨æ—¶é—´ä¼˜åŒ–</strong>ï¼šå‡å°‘çº¦ 25%å¯åŠ¨æ—¶é—´</li><li><strong>GC æš‚åœæ—¶é—´æ”¹å–„</strong>ï¼šå¤§éƒ¨åˆ†ç¨‹åºæš‚åœæ—¶é—´&lt;100 å¾®ç§’</li></ul><hr><h2 id="Go-1-19-2022-å¹´-8-æœˆ-2-æ—¥å‘å¸ƒ"><a href="#Go-1-19-2022-å¹´-8-æœˆ-2-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.19 (2022 å¹´ 8 æœˆ 2 æ—¥å‘å¸ƒ)"></a>Go 1.19 (2022 å¹´ 8 æœˆ 2 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2022 å¹´ 8 æœˆ 2 æ—¥</p><h3 id="è¯­è¨€ç‰¹æ€§-3"><a href="#è¯­è¨€ç‰¹æ€§-3" class="headerlink" title="è¯­è¨€ç‰¹æ€§"></a>è¯­è¨€ç‰¹æ€§</h3><ul><li><strong>å†…å­˜æ¨¡å‹ä¿®è®¢</strong>ï¼šä¸ C&#x2F;C++&#x2F;Java ç­‰ä¸»æµè¯­è¨€å†…å­˜æ¨¡å‹ä¿æŒä¸€è‡´</li><li><strong>sync&#x2F;atomic æ–°ç±»å‹</strong>ï¼šæ–°å¢ Bool, Int32, Int64, Uint32, Uint64, Uintptr, Pointer ç­‰ç±»å‹</li></ul><h3 id="è¿è¡Œæ—¶-2"><a href="#è¿è¡Œæ—¶-2" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>æ–°å¢ SetMemoryLimit</strong>ï¼šruntime&#x2F;debug.SetMemoryLimit é™åˆ¶ Go å†…å­˜ä½¿ç”¨</li><li><strong>æ–‡æ¡£æ³¨é‡Šå¢å¼º</strong>ï¼šæ”¯æŒé“¾æ¥ã€åˆ—è¡¨å’Œæ›´æ¸…æ™°çš„æ ‡é¢˜</li></ul><h3 id="æ ‡å‡†åº“-3"><a href="#æ ‡å‡†åº“-3" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>net&#x2F;http è¶…æ—¶æ”¹è¿›</strong>ï¼šServer.ConnContext æ”¯æŒè®¾ç½®è¿æ¥çº§è¶…æ—¶</li></ul><h3 id="ç§»æ¤æ€§"><a href="#ç§»æ¤æ€§" class="headerlink" title="ç§»æ¤æ€§"></a>ç§»æ¤æ€§</h3><ul><li><strong>æ–°å¢ LoongArch 64 ä½æ”¯æŒ</strong>ï¼šlinux&#x2F;loong64 ç«¯å£</li></ul><hr><h2 id="Go-1-18-2022-å¹´-3-æœˆ-15-æ—¥å‘å¸ƒ"><a href="#Go-1-18-2022-å¹´-3-æœˆ-15-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.18 (2022 å¹´ 3 æœˆ 15 æ—¥å‘å¸ƒ)"></a>Go 1.18 (2022 å¹´ 3 æœˆ 15 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2022 å¹´ 3 æœˆ 15 æ—¥</p><h3 id="è¯­è¨€ç‰¹æ€§-4"><a href="#è¯­è¨€ç‰¹æ€§-4" class="headerlink" title="è¯­è¨€ç‰¹æ€§"></a>è¯­è¨€ç‰¹æ€§</h3><ul><li><strong>æ³›å‹æ­£å¼å‘å¸ƒ</strong>ï¼šæ”¯æŒç±»å‹å‚æ•°ã€ç±»å‹çº¦æŸï¼Œå®ç°ç®—æ³•å¤ç”¨</li><li><strong>å‡½æ•°è¿­ä»£å™¨é¢„è§ˆ</strong>ï¼šrange over funcï¼ˆéœ€ GOEXPERIMENT&#x3D;rangefuncï¼‰</li></ul><h3 id="å·¥å…·é“¾-4"><a href="#å·¥å…·é“¾-4" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>Fuzzing æµ‹è¯•</strong>ï¼šé¦–ä¸ªå°†æ¨¡ç³Šæµ‹è¯•é›†æˆåˆ°æ ‡å‡†å·¥å…·é“¾çš„ä¸»è¦è¯­è¨€</li><li><strong>å·¥ä½œåŒºæ¨¡å¼</strong>ï¼šè§£å†³æœ¬åœ°å¤šæ¨¡å—å¼€å‘ä¾èµ–é—®é¢˜ï¼ˆgo work å‘½ä»¤ï¼‰</li><li><strong>ç¼–è¯‘æ€§èƒ½</strong>ï¼šAMD64 æ¶æ„æ€§èƒ½æå‡ 20%ï¼ˆå¯„å­˜å™¨ ABI æ‰©å±•ï¼‰</li></ul><h3 id="æ ‡å‡†åº“-4"><a href="#æ ‡å‡†åº“-4" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>æ–°å¢ net&#x2F;netip åŒ…</strong>ï¼šæ›´é«˜æ•ˆçš„ IP åœ°å€å¤„ç†</li><li><strong>crypto&#x2F;tls</strong>ï¼šé»˜è®¤ä½¿ç”¨ TLS 1.2+</li><li><strong>crypto&#x2F;x509</strong>ï¼šé»˜è®¤æ‹’ç» SHA-1 ç­¾åè¯ä¹¦</li></ul><h3 id="æ€§èƒ½æ”¹è¿›"><a href="#æ€§èƒ½æ”¹è¿›" class="headerlink" title="æ€§èƒ½æ”¹è¿›"></a>æ€§èƒ½æ”¹è¿›</h3><ul><li><strong>CPU æ€§èƒ½æå‡</strong>ï¼šARM64 å’Œ PowerPC64 ä¸Šæå‡é«˜è¾¾ 20%</li></ul><hr><h2 id="Go-1-17-2021-å¹´-8-æœˆ-16-æ—¥å‘å¸ƒ"><a href="#Go-1-17-2021-å¹´-8-æœˆ-16-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.17 (2021 å¹´ 8 æœˆ 16 æ—¥å‘å¸ƒ)"></a>Go 1.17 (2021 å¹´ 8 æœˆ 16 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2021 å¹´ 8 æœˆ 16 æ—¥</p><h3 id="è¯­è¨€ç‰¹æ€§-5"><a href="#è¯­è¨€ç‰¹æ€§-5" class="headerlink" title="è¯­è¨€ç‰¹æ€§"></a>è¯­è¨€ç‰¹æ€§</h3><ul><li><strong>åˆ‡ç‰‡è½¬æ•°ç»„æŒ‡é’ˆ</strong>ï¼šæ”¯æŒ<code>(*[N]T)(slice)</code>è¯­æ³•ï¼Œè¿è¡Œæ—¶è¾¹ç•Œæ£€æŸ¥</li></ul><h3 id="å·¥å…·é“¾-5"><a href="#å·¥å…·é“¾-5" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>æ„å»ºçº¦æŸæ–°è¯­æ³•</strong>ï¼šå¼•å…¥<code>//go:build</code>æ›¿ä»£æ—§çš„<code>// +build</code></li><li><strong>æ¨¡å—å›¾è£å‰ª</strong>ï¼šgo.mod æ›´ç²¾ç®€</li></ul><h3 id="è¿è¡Œæ—¶-3"><a href="#è¿è¡Œæ—¶-3" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>å¯„å­˜å™¨ ABI æ‰©å±•</strong>ï¼š64 ä½ ARM æ¶æ„æ€§èƒ½æå‡ 10%+</li><li><strong>åƒåœ¾å›æ”¶ä¼˜åŒ–</strong>ï¼šæš‚åœæ—¶é—´è¿›ä¸€æ­¥é™ä½</li></ul><h3 id="æ ‡å‡†åº“-5"><a href="#æ ‡å‡†åº“-5" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>æ–°å¢ io&#x2F;fs åŒ…</strong>ï¼šæŠ½è±¡æ–‡ä»¶ç³»ç»Ÿæ¥å£</li><li><strong>embed åŒ…è½¬æ­£</strong>ï¼šæ­£å¼æ”¯æŒé™æ€èµ„æºåµŒå…¥</li></ul><hr><h2 id="Go-1-16-2021-å¹´-2-æœˆ-16-æ—¥å‘å¸ƒ"><a href="#Go-1-16-2021-å¹´-2-æœˆ-16-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.16 (2021 å¹´ 2 æœˆ 16 æ—¥å‘å¸ƒ)"></a>Go 1.16 (2021 å¹´ 2 æœˆ 16 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2021 å¹´ 2 æœˆ 16 æ—¥</p><h3 id="è¯­è¨€ç‰¹æ€§-6"><a href="#è¯­è¨€ç‰¹æ€§-6" class="headerlink" title="è¯­è¨€ç‰¹æ€§"></a>è¯­è¨€ç‰¹æ€§</h3><ul><li><strong>embed åŒ…</strong>ï¼šé™æ€èµ„æºç¼–è¯‘æ—¶åµŒå…¥</li><li><strong>io&#x2F;fs åŒ…</strong>ï¼šæ–‡ä»¶ç³»ç»ŸæŠ½è±¡</li></ul><h3 id="å·¥å…·é“¾-6"><a href="#å·¥å…·é“¾-6" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>Module æˆä¸ºé»˜è®¤</strong>ï¼šGO111MODULE é»˜è®¤å¼€å¯</li><li><strong>Mac Apple Silicon æ”¯æŒ</strong>ï¼šdarwin&#x2F;arm64 ç«¯å£</li></ul><h3 id="æ ‡å‡†åº“-6"><a href="#æ ‡å‡†åº“-6" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>net&#x2F;http</strong>ï¼šHTTP&#x2F;2 æ¨é€æ”¯æŒæ”¹è¿›</li><li><strong>archive&#x2F;zip</strong>ï¼šæ€§èƒ½ä¼˜åŒ–</li></ul><hr><h2 id="Go-1-15-2020-å¹´-8-æœˆ-11-æ—¥å‘å¸ƒ"><a href="#Go-1-15-2020-å¹´-8-æœˆ-11-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.15 (2020 å¹´ 8 æœˆ 11 æ—¥å‘å¸ƒ)"></a>Go 1.15 (2020 å¹´ 8 æœˆ 11 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2020 å¹´ 8 æœˆ 11 æ—¥</p><h3 id="è¿è¡Œæ—¶-4"><a href="#è¿è¡Œæ—¶-4" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>GC ä¼˜åŒ–</strong>ï¼šå…¸å‹ GC æš‚åœæ—¶é—´&lt;1ms</li><li><strong>é“¾æ¥å™¨ä¼˜åŒ–</strong>ï¼šé“¾æ¥é€Ÿåº¦æå‡ 20%ï¼ŒäºŒè¿›åˆ¶ä½“ç§¯å‡å°</li></ul><h3 id="æ ‡å‡†åº“-7"><a href="#æ ‡å‡†åº“-7" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>time åŒ…æ€§èƒ½æå‡</strong>ï¼šT å‰Šå¼±å¯¹ cgo çš„ä¾èµ–</li></ul><hr><h2 id="Go-1-14-2020-å¹´-2-æœˆ-25-æ—¥å‘å¸ƒ"><a href="#Go-1-14-2020-å¹´-2-æœˆ-25-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.14 (2020 å¹´ 2 æœˆ 25 æ—¥å‘å¸ƒ)"></a>Go 1.14 (2020 å¹´ 2 æœˆ 25 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2020 å¹´ 2 æœˆ 25 æ—¥</p><h3 id="è¿è¡Œæ—¶-5"><a href="#è¿è¡Œæ—¶-5" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>goroutine æŠ¢å è°ƒåº¦</strong>ï¼šåŸºäºä¿¡å·çš„å¼‚æ­¥æŠ¢å ï¼Œè§£å†³é•¿æ—¶é—´å ç”¨ CPU é—®é¢˜</li><li><strong>defer æ€§èƒ½æå‡</strong>ï¼šdefer æ€§èƒ½æå‡ 30%</li></ul><h3 id="å·¥å…·é“¾-7"><a href="#å·¥å…·é“¾-7" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>Module æ”¯æŒç”Ÿäº§ç¯å¢ƒ</strong>ï¼šæ¨¡å—ç¼“å­˜æ”¹è¿›</li></ul><hr><h2 id="Go-1-13-2019-å¹´-9-æœˆ-3-æ—¥å‘å¸ƒ"><a href="#Go-1-13-2019-å¹´-9-æœˆ-3-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.13 (2019 å¹´ 9 æœˆ 3 æ—¥å‘å¸ƒ)"></a>Go 1.13 (2019 å¹´ 9 æœˆ 3 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2019 å¹´ 9 æœˆ 3 æ—¥</p><h3 id="å·¥å…·é“¾-8"><a href="#å·¥å…·é“¾-8" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>æ•°å­—å­—é¢é‡è¯­æ³•</strong>ï¼šæ”¯æŒ 0b äºŒè¿›åˆ¶ã€0o å…«è¿›åˆ¶ã€0x åå…­è¿›åˆ¶åŠä¸‹åˆ’çº¿åˆ†éš”</li><li><strong>é”™è¯¯åŒ…è£…</strong>ï¼šæ ‡å‡†åº“æ”¯æŒ%w æ ¼å¼åŒ–åŠ¨è¯</li></ul><h3 id="æ ‡å‡†åº“-8"><a href="#æ ‡å‡†åº“-8" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>æ–°ç‰ˆ TLS 1.3</strong>ï¼šcrypto&#x2F;tls é»˜è®¤å¯ç”¨ TLS 1.3</li></ul><hr><h2 id="Go-1-12-2019-å¹´-2-æœˆ-25-æ—¥å‘å¸ƒ"><a href="#Go-1-12-2019-å¹´-2-æœˆ-25-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.12 (2019 å¹´ 2 æœˆ 25 æ—¥å‘å¸ƒ)"></a>Go 1.12 (2019 å¹´ 2 æœˆ 25 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2019 å¹´ 2 æœˆ 25 æ—¥</p><h3 id="è¿è¡Œæ—¶-6"><a href="#è¿è¡Œæ—¶-6" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>GC ä¼˜åŒ–</strong>ï¼šå†™å…¥å±éšœä¼˜åŒ–ï¼Œå‡å°‘çº¦ 10-30%å†…å­˜å ç”¨</li></ul><h3 id="å·¥å…·é“¾-9"><a href="#å·¥å…·é“¾-9" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>Module å®éªŒæ€§æ”¯æŒ</strong>ï¼šGO111MODULE å¼•å…¥</li></ul><h3 id="æ ‡å‡†åº“-9"><a href="#æ ‡å‡†åº“-9" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>crypto&#x2F;tls</strong>ï¼šæ€§èƒ½å’Œå®‰å…¨æ”¹è¿›</li></ul><hr><h2 id="Go-1-11-2018-å¹´-8-æœˆ-24-æ—¥å‘å¸ƒ"><a href="#Go-1-11-2018-å¹´-8-æœˆ-24-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.11 (2018 å¹´ 8 æœˆ 24 æ—¥å‘å¸ƒ)"></a>Go 1.11 (2018 å¹´ 8 æœˆ 24 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2018 å¹´ 8 æœˆ 24 æ—¥</p><h3 id="ä¸»è¦ç‰¹æ€§-1"><a href="#ä¸»è¦ç‰¹æ€§-1" class="headerlink" title="ä¸»è¦ç‰¹æ€§"></a>ä¸»è¦ç‰¹æ€§</h3><ul><li><strong>Modules</strong>ï¼šå¼•å…¥ Go æ¨¡å—ç³»ç»Ÿï¼Œè§£å†³ GOPATH ä¾èµ–ç®¡ç†é—®é¢˜</li><li><strong>WebAssembly æ”¯æŒ</strong>ï¼šå®éªŒæ€§æ”¯æŒ Go ç¼–è¯‘ä¸º Wasm</li></ul><hr><h2 id="Go-1-10-2018-å¹´-2-æœˆ-16-æ—¥å‘å¸ƒ"><a href="#Go-1-10-2018-å¹´-2-æœˆ-16-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.10 (2018 å¹´ 2 æœˆ 16 æ—¥å‘å¸ƒ)"></a>Go 1.10 (2018 å¹´ 2 æœˆ 16 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2018 å¹´ 2 æœˆ 16 æ—¥</p><h3 id="å·¥å…·é“¾-10"><a href="#å·¥å…·é“¾-10" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>æ„å»ºç¼“å­˜</strong>ï¼šgo build å¼•å…¥æ„å»ºç¼“å­˜ï¼Œå¤§å¹…æå‡æ„å»ºé€Ÿåº¦</li><li><strong>æµ‹è¯•ç¼“å­˜</strong>ï¼šgo test ç»“æœç¼“å­˜</li></ul><h3 id="æ ‡å‡†åº“-10"><a href="#æ ‡å‡†åº“-10" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>strings.Builder</strong>ï¼šé«˜æ•ˆå­—ç¬¦ä¸²æ„å»º</li></ul><hr><h2 id="Go-1-9-2017-å¹´-8-æœˆ-24-æ—¥å‘å¸ƒ"><a href="#Go-1-9-2017-å¹´-8-æœˆ-24-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.9 (2017 å¹´ 8 æœˆ 24 æ—¥å‘å¸ƒ)"></a>Go 1.9 (2017 å¹´ 8 æœˆ 24 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2017 å¹´ 8 æœˆ 24 æ—¥</p><h3 id="æ ‡å‡†åº“-11"><a href="#æ ‡å‡†åº“-11" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>type alias æ­£å¼æ”¯æŒ</strong>ï¼šç±»å‹åˆ«åè¯­æ³•ç¨³å®š</li><li><strong>sync.Map</strong>ï¼šå¹¶å‘å®‰å…¨çš„ map å®ç°</li></ul><h3 id="è¿è¡Œæ—¶-7"><a href="#è¿è¡Œæ—¶-7" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>åƒåœ¾å›æ”¶ä¼˜åŒ–</strong>ï¼šå¹¶è¡Œ GCï¼Œå‡å°‘ STW æ—¶é—´</li></ul><hr><h2 id="Go-1-8-2017-å¹´-2-æœˆ-16-æ—¥å‘å¸ƒ"><a href="#Go-1-8-2017-å¹´-2-æœˆ-16-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.8 (2017 å¹´ 2 æœˆ 16 æ—¥å‘å¸ƒ)"></a>Go 1.8 (2017 å¹´ 2 æœˆ 16 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2017 å¹´ 2 æœˆ 16 æ—¥</p><h3 id="æ ‡å‡†åº“-12"><a href="#æ ‡å‡†åº“-12" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>context åŒ…è¿›å…¥æ ‡å‡†åº“</strong>ï¼šæä¾›å–æ¶ˆå’Œè¶…æ—¶æœºåˆ¶</li><li><strong>sort.Slice</strong>ï¼šåŸºäºå›è°ƒçš„åˆ‡ç‰‡æ’åº</li></ul><h3 id="è¿è¡Œæ—¶-8"><a href="#è¿è¡Œæ—¶-8" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>GC å»¶è¿Ÿä¼˜åŒ–</strong>ï¼šSTW æ—¶é—´é™è‡³æ¯«ç§’çº§</li><li><strong>defer æ€§èƒ½æ”¹è¿›</strong>ï¼šå»¶è¿Ÿè°ƒç”¨å¼€é”€é™ä½</li></ul><hr><h2 id="Go-1-7-2016-å¹´-8-æœˆ-15-æ—¥å‘å¸ƒ"><a href="#Go-1-7-2016-å¹´-8-æœˆ-15-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.7 (2016 å¹´ 8 æœˆ 15 æ—¥å‘å¸ƒ)"></a>Go 1.7 (2016 å¹´ 8 æœˆ 15 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2016 å¹´ 8 æœˆ 15 æ—¥</p><h3 id="ä¸»è¦ç‰¹æ€§-2"><a href="#ä¸»è¦ç‰¹æ€§-2" class="headerlink" title="ä¸»è¦ç‰¹æ€§"></a>ä¸»è¦ç‰¹æ€§</h3><ul><li><strong>context åŒ…å¼•å…¥</strong>ï¼ˆå®éªŒæ€§ï¼‰</li><li><strong>ç¼–è¯‘å™¨ä¼˜åŒ–</strong>ï¼šç¼–è¯‘é€Ÿåº¦æå‡ï¼ŒäºŒè¿›åˆ¶ä½“ç§¯ç¼©å° 20-30%</li></ul><h3 id="ç§»æ¤æ€§-1"><a href="#ç§»æ¤æ€§-1" class="headerlink" title="ç§»æ¤æ€§"></a>ç§»æ¤æ€§</h3><ul><li><strong>Linux on IBM z Systems</strong>ï¼šæ–°å¢ linux&#x2F;s390x ç«¯å£</li></ul><hr><h2 id="Go-1-5-2015-å¹´-8-æœˆ-19-æ—¥å‘å¸ƒ"><a href="#Go-1-5-2015-å¹´-8-æœˆ-19-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.5 (2015 å¹´ 8 æœˆ 19 æ—¥å‘å¸ƒ)"></a>Go 1.5 (2015 å¹´ 8 æœˆ 19 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2015 å¹´ 8 æœˆ 19 æ—¥</p><h3 id="é‡å¤§å˜é©"><a href="#é‡å¤§å˜é©" class="headerlink" title="é‡å¤§å˜é©"></a>é‡å¤§å˜é©</h3><ul><li><strong>è‡ªä¸¾ç¼–è¯‘</strong>ï¼šGo ç¼–è¯‘å™¨å®Œå…¨ç”¨ Go é‡å†™ï¼Œä¸å†ä¾èµ– C è¯­è¨€</li><li><strong>GC é‡å†™</strong>ï¼šå¼•å…¥å¹¶å‘ GCï¼ŒSTW æ—¶é—´å¤§å¹…ç¼©çŸ­</li></ul><hr><h2 id="Go-1-4-2014-å¹´-12-æœˆ-10-æ—¥å‘å¸ƒ"><a href="#Go-1-4-2014-å¹´-12-æœˆ-10-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.4 (2014 å¹´ 12 æœˆ 10 æ—¥å‘å¸ƒ)"></a>Go 1.4 (2014 å¹´ 12 æœˆ 10 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2014 å¹´ 12 æœˆ 10 æ—¥</p><h3 id="å·¥å…·é“¾-11"><a href="#å·¥å…·é“¾-11" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h3><ul><li><strong>go generate</strong>ï¼šä»£ç ç”Ÿæˆå·¥å…·å¼•å…¥</li><li><strong>internal åŒ…</strong>ï¼šæ”¯æŒ internal ç›®å½•å¯è§æ€§çº¦æŸ</li></ul><hr><h2 id="Go-1-3-2014-å¹´-6-æœˆ-18-æ—¥å‘å¸ƒ"><a href="#Go-1-3-2014-å¹´-6-æœˆ-18-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.3 (2014 å¹´ 6 æœˆ 18 æ—¥å‘å¸ƒ)"></a>Go 1.3 (2014 å¹´ 6 æœˆ 18 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2014 å¹´ 6 æœˆ 18 æ—¥</p><h3 id="è¿è¡Œæ—¶-9"><a href="#è¿è¡Œæ—¶-9" class="headerlink" title="è¿è¡Œæ—¶"></a>è¿è¡Œæ—¶</h3><ul><li><strong>æ ˆç®¡ç†ä¼˜åŒ–</strong>ï¼šåˆ†æ®µæ ˆæ”¹ä¸ºè¿ç»­æ ˆ</li></ul><h3 id="æ ‡å‡†åº“-13"><a href="#æ ‡å‡†åº“-13" class="headerlink" title="æ ‡å‡†åº“"></a>æ ‡å‡†åº“</h3><ul><li><strong>sync.Pool</strong>ï¼šå¯¹è±¡æ± æœºåˆ¶å¼•å…¥</li></ul><hr><h2 id="Go-1-2-2013-å¹´-12-æœˆ-1-æ—¥å‘å¸ƒ"><a href="#Go-1-2-2013-å¹´-12-æœˆ-1-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.2 (2013 å¹´ 12 æœˆ 1 æ—¥å‘å¸ƒ)"></a>Go 1.2 (2013 å¹´ 12 æœˆ 1 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2013 å¹´ 12 æœˆ 1 æ—¥</p><h3 id="è¯­è¨€ç‰¹æ€§-7"><a href="#è¯­è¨€ç‰¹æ€§-7" class="headerlink" title="è¯­è¨€ç‰¹æ€§"></a>è¯­è¨€ç‰¹æ€§</h3><ul><li><strong>ä¸‰ç´¢å¼•åˆ‡ç‰‡</strong>ï¼šintroduced <code>slice[low:high:max]</code> syntax</li><li><strong>æµ‹è¯•è¦†ç›–ç‡</strong>ï¼šgo test æ”¯æŒè¦†ç›–ç‡ç»Ÿè®¡</li></ul><hr><h2 id="Go-1-1-2013-å¹´-5-æœˆ-13-æ—¥å‘å¸ƒ"><a href="#Go-1-1-2013-å¹´-5-æœˆ-13-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.1 (2013 å¹´ 5 æœˆ 13 æ—¥å‘å¸ƒ)"></a>Go 1.1 (2013 å¹´ 5 æœˆ 13 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2013 å¹´ 5 æœˆ 13 æ—¥</p><h3 id="ä¸»è¦æ”¹è¿›"><a href="#ä¸»è¦æ”¹è¿›" class="headerlink" title="ä¸»è¦æ”¹è¿›"></a>ä¸»è¦æ”¹è¿›</h3><ul><li><strong>æ€§èƒ½å¤§å¹…æå‡</strong>ï¼šç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶ä¼˜åŒ–</li><li><strong>Method values</strong>ï¼šæ”¯æŒå°†æ–¹æ³•ä½œä¸ºå‡½æ•°å€¼</li></ul><hr><h2 id="Go-1-0-2012-å¹´-3-æœˆ-28-æ—¥å‘å¸ƒ"><a href="#Go-1-0-2012-å¹´-3-æœˆ-28-æ—¥å‘å¸ƒ" class="headerlink" title="Go 1.0 (2012 å¹´ 3 æœˆ 28 æ—¥å‘å¸ƒ)"></a>Go 1.0 (2012 å¹´ 3 æœˆ 28 æ—¥å‘å¸ƒ)</h2><p><strong>å‘å¸ƒæ—¥æœŸ</strong>: 2012 å¹´ 3 æœˆ 28 æ—¥</p><h3 id="é‡Œç¨‹ç¢‘"><a href="#é‡Œç¨‹ç¢‘" class="headerlink" title="é‡Œç¨‹ç¢‘"></a>é‡Œç¨‹ç¢‘</h3><ul><li><strong>é¦–ä¸ªç¨³å®šç‰ˆæœ¬</strong>ï¼šGo 1 å…¼å®¹æ€§æ‰¿è¯ºå¼€å§‹</li><li><strong>è¯­è¨€è§„èŒƒç¡®å®š</strong>ï¼šå¥ å®šåç»­ç‰ˆæœ¬åŸºç¡€</li></ul><hr><h2 id="ç‰ˆæœ¬å‘å¸ƒå‘¨æœŸ"><a href="#ç‰ˆæœ¬å‘å¸ƒå‘¨æœŸ" class="headerlink" title="ç‰ˆæœ¬å‘å¸ƒå‘¨æœŸ"></a>ç‰ˆæœ¬å‘å¸ƒå‘¨æœŸ</h2><ul><li><strong>å¸¸è§„å‘¨æœŸ</strong>ï¼šæ¯å¹´ 2 æœˆã€8 æœˆå‘å¸ƒä¸¤ä¸ªç‰ˆæœ¬</li><li><strong>ç»´æŠ¤ç­–ç•¥</strong>ï¼šå½“å‰ç‰ˆæœ¬ bug ä¿®å¤ï¼Œå‰ä¸¤ä¸ªç‰ˆæœ¬å®‰å…¨æ›´æ–°</li><li><strong>å…¼å®¹æ€§</strong>ï¼šéµå¾ª Go 1 å…¼å®¹æ€§æ‰¿è¯ºï¼Œä¿è¯å‘åå…¼å®¹</li></ul><hr><h2 id="å®˜æ–¹-Release-CHANGELOG-å‚è€ƒ"><a href="#å®˜æ–¹-Release-CHANGELOG-å‚è€ƒ" class="headerlink" title="å®˜æ–¹ Release CHANGELOG å‚è€ƒ"></a>å®˜æ–¹ Release CHANGELOG å‚è€ƒ</h2><p><a href="https://go.dev/doc/devel/release">go.dev&#x2F;doc&#x2F;devel&#x2F;release</a></p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;


&lt;p&gt;Golang Changelog**ï¼š&lt;/p&gt;
&lt;hr&gt;
&lt;h1 id=&quot;Go-è¯­è¨€ç‰ˆæœ¬å˜æ›´æ—¥å¿—ï¼ˆæˆªè‡³-2025-11-07-çš„å˜æ›´æ—¥å¿—ï¼‰&quot;&gt;&lt;a href=&quot;#Go-è¯­è¨€ç‰ˆæœ¬å˜æ›´æ—¥å¿—ï¼ˆæˆªè‡³-2025-11-07-çš„å˜æ›´æ—¥å¿—ï¼‰&quot; class=&quot;headerlink&quot; title=&quot;Go è¯­è¨€ç‰ˆæœ¬å˜æ›´æ—¥å¿—ï¼ˆæˆªè‡³ 2025.11.07 çš„å˜æ›´æ—¥å¿—ï¼‰&quot;&gt;&lt;/a&gt;Go è¯­è¨€ç‰ˆæœ¬å˜æ›´æ—¥å¿—ï¼ˆæˆªè‡³ 2025.11.07 çš„å˜æ›´æ—¥å¿—ï¼‰&lt;/h1&gt;&lt;h2 id=&quot;Go-1-25-2025-å¹´-8-æœˆ-12-æ—¥å‘å¸ƒ&quot;&gt;&lt;a href=&quot;#Go-1-25-2025-å¹´-8-æœˆ-12-æ—¥å‘å¸ƒ&quot; class=&quot;headerlink&quot; title=&quot;Go 1.25 (2025 å¹´ 8 æœˆ 12 æ—¥å‘å¸ƒ)&quot;&gt;&lt;/a&gt;Go 1.25 (2025 å¹´ 8 æœˆ 12 æ—¥å‘å¸ƒ)&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;å‘å¸ƒæ—¥æœŸ&lt;/strong&gt;: 2025 å¹´ 8 æœˆ 12 æ—¥&lt;br&gt;&lt;strong&gt;ç‰ˆæœ¬å‘¨æœŸ&lt;/strong&gt;: è·ç¦» Go 1.24 å‘å¸ƒå…­ä¸ªæœˆ&lt;br&gt;&lt;strong&gt;å…¼å®¹æ€§&lt;/strong&gt;: ä¿æŒ Go 1 çš„å…¼å®¹æ€§æ‰¿è¯º &lt;/p&gt;</summary>
    
    
    
    <category term="Go" scheme="https://www.wdft.com/categories/Go/"/>
    
    
    <category term="Go" scheme="https://www.wdft.com/tags/Go/"/>
    
    <category term="changelog" scheme="https://www.wdft.com/tags/changelog/"/>
    
    <category term="History" scheme="https://www.wdft.com/tags/History/"/>
    
  </entry>
  
  <entry>
    <title>ä» 0 åˆ° 1ï¼šPython ç³»ç»Ÿæ€§å­¦ä¹ æŒ‡å— - ä»åŸºç¡€åˆ°å®Œæ•´ Web CRUD åº”ç”¨(è´¹æ›¼å­¦ä¹ æ³•)</title>
    <link href="https://www.wdft.com/6f7c84b1.html"/>
    <id>https://www.wdft.com/6f7c84b1.html</id>
    <published>2025-10-31T15:11:01.000Z</published>
    <updated>2026-01-26T09:44:40.982Z</updated>
    
    <content type="html"><![CDATA[<!-- toc --><blockquote><p><strong>æ ¸å¿ƒè§‚ç‚¹</strong>ï¼šå­¦ä¹ ç¼–ç¨‹ä¸æ˜¯ä¸ºäº†æŒæ¡è¯­æ³•ï¼Œè€Œæ˜¯ä¸ºäº†åˆ›é€ ä»·å€¼ã€‚æœ¬æ–‡æä¾›ä¸€æ¡æ¸…æ™°çš„å­¦ä¹ è·¯å¾„ï¼Œè®©ä½ ä» Python åŸºç¡€è¯­æ³•èµ·æ­¥ï¼Œæœ€ç»ˆèƒ½å¤Ÿç‹¬ç«‹å¼€å‘å®Œæ•´çš„ Web CRUD åº”ç”¨ã€‚</p></blockquote><span id="more"></span><h2 id="ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ç³»ç»Ÿæ€§å­¦ä¹ ï¼Ÿ"><a href="#ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ç³»ç»Ÿæ€§å­¦ä¹ ï¼Ÿ" class="headerlink" title="ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ç³»ç»Ÿæ€§å­¦ä¹ ï¼Ÿ"></a>ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ç³»ç»Ÿæ€§å­¦ä¹ ï¼Ÿ</h2><p>å¾ˆå¤šåˆå­¦è€…é™·å…¥â€è¯­æ³•éƒ½ä¼šï¼Œé¡¹ç›®ä¸ä¼šâ€çš„å›°å¢ƒï¼Œæ ¹æœ¬åŸå› åœ¨äºï¼š</p><ul><li><strong>ç¢ç‰‡åŒ–å­¦ä¹ </strong>ï¼šåªå­¦é›¶æ•£è¯­æ³•ï¼Œç¼ºä¹æ•´ä½“æ¶æ„æ€ç»´</li><li><strong>é¡¹ç›®ç»éªŒç¼ºå¤±</strong>ï¼šæ²¡æœ‰å°†çŸ¥è¯†ç‚¹ä¸²è”æˆå®Œæ•´è§£å†³æ–¹æ¡ˆ</li><li><strong>å­¦ä¹ è·¯å¾„æ¨¡ç³Š</strong>ï¼šä¸çŸ¥é“ä¸‹ä¸€æ­¥è¯¥å­¦ä»€ä¹ˆ</li></ul><p>æœ¬æ–‡æä¾›ä¸€æ¡ç»è¿‡éªŒè¯çš„å­¦ä¹ è·¯å¾„å»ºè®®ï¼Œ<strong>1-2 æœˆ</strong>å†…è®©ä½ å…·å¤‡å¼€å‘å®Œæ•´ Web åº”ç”¨çš„èƒ½åŠ›ã€‚</p><h2 id="äºŒã€å­¦ä¹ è·¯çº¿å›¾ï¼ˆ5-ä¸ªæ ¸å¿ƒé˜¶æ®µï¼‰"><a href="#äºŒã€å­¦ä¹ è·¯çº¿å›¾ï¼ˆ5-ä¸ªæ ¸å¿ƒé˜¶æ®µï¼‰" class="headerlink" title="äºŒã€å­¦ä¹ è·¯çº¿å›¾ï¼ˆ5 ä¸ªæ ¸å¿ƒé˜¶æ®µï¼‰"></a>äºŒã€å­¦ä¹ è·¯çº¿å›¾ï¼ˆ5 ä¸ªæ ¸å¿ƒé˜¶æ®µï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">é˜¶æ®µ1ï¼šPythonåŸºç¡€è¯­æ³•ï¼ˆ1å‘¨ï¼‰â†’ é˜¶æ®µ2ï¼šæ ¸å¿ƒæ¦‚å¿µæ·±åŒ–ï¼ˆ1å‘¨ï¼‰â†’ </span><br><span class="line">é˜¶æ®µ3ï¼šWebå¼€å‘åŸºç¡€ï¼ˆ1-2å‘¨ï¼‰â†’ é˜¶æ®µ4ï¼šæ•°æ®åº“é›†æˆï¼ˆ1å‘¨ï¼‰â†’ </span><br><span class="line">é˜¶æ®µ5ï¼šå®Œæ•´CRUDé¡¹ç›®å®æˆ˜ï¼ˆ2-3å‘¨ï¼‰</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€é˜¶æ®µè¯¦è§£ä¸å®æˆ˜ä»£ç "><a href="#ä¸‰ã€é˜¶æ®µè¯¦è§£ä¸å®æˆ˜ä»£ç " class="headerlink" title="ä¸‰ã€é˜¶æ®µè¯¦è§£ä¸å®æˆ˜ä»£ç "></a>ä¸‰ã€é˜¶æ®µè¯¦è§£ä¸å®æˆ˜ä»£ç </h2><h3 id="é˜¶æ®µ-1ï¼šPython-åŸºç¡€è¯­æ³•ï¼ˆå¤¯å®æ ¹åŸºï¼‰"><a href="#é˜¶æ®µ-1ï¼šPython-åŸºç¡€è¯­æ³•ï¼ˆå¤¯å®æ ¹åŸºï¼‰" class="headerlink" title="é˜¶æ®µ 1ï¼šPython åŸºç¡€è¯­æ³•ï¼ˆå¤¯å®æ ¹åŸºï¼‰"></a>é˜¶æ®µ 1ï¼šPython åŸºç¡€è¯­æ³•ï¼ˆå¤¯å®æ ¹åŸºï¼‰</h3><p><strong>å­¦ä¹ é‡ç‚¹</strong>ï¼šå˜é‡ã€æ•°æ®ç±»å‹ã€æ§åˆ¶æµã€å‡½æ•°ã€æ¨¡å—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šåŸºç¡€è¯­æ³•ç»¼åˆåº”ç”¨</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_student_grade</span>(<span class="params">scores</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è®¡ç®—å­¦ç”Ÿæˆç»©ç­‰çº§</span></span><br><span class="line"><span class="string">    :param scores: æˆç»©å­—å…¸ &#123;&#x27;math&#x27;: 90, &#x27;english&#x27;: 85, ...&#125;</span></span><br><span class="line"><span class="string">    :return: ç­‰çº§å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    total = <span class="built_in">sum</span>(scores.values())</span><br><span class="line">    average = total / <span class="built_in">len</span>(scores)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> average &gt;= <span class="number">90</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> average &gt;= <span class="number">80</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> average &gt;= <span class="number">70</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;D&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">student_scores = &#123;</span><br><span class="line">    <span class="string">&#x27;math&#x27;</span>: <span class="number">88</span>,</span><br><span class="line">    <span class="string">&#x27;english&#x27;</span>: <span class="number">92</span>,</span><br><span class="line">    <span class="string">&#x27;science&#x27;</span>: <span class="number">85</span></span><br><span class="line">&#125;</span><br><span class="line">grade = calculate_student_grade(student_scores)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;å­¦ç”Ÿç­‰çº§: <span class="subst">&#123;grade&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>é˜¶æ®µç»ƒä¹ </strong>ï¼š</p><ol><li>å®ç°ä¸€ä¸ªç®€æ˜“è®¡ç®—å™¨ï¼ˆåŠ å‡ä¹˜é™¤ï¼‰</li><li>ç¼–å†™æ–‡ä»¶å†…å®¹ç»Ÿè®¡å·¥å…·ï¼ˆè¡Œæ•°ã€å•è¯æ•°ã€å­—ç¬¦æ•°ï¼‰</li><li>åˆ¶ä½œä¸€ä¸ªçŒœæ•°å­—æ¸¸æˆ</li></ol><h3 id="é˜¶æ®µ-2ï¼šæ ¸å¿ƒæ¦‚å¿µæ·±åŒ–ï¼ˆå»ºç«‹ç¼–ç¨‹æ€ç»´ï¼‰"><a href="#é˜¶æ®µ-2ï¼šæ ¸å¿ƒæ¦‚å¿µæ·±åŒ–ï¼ˆå»ºç«‹ç¼–ç¨‹æ€ç»´ï¼‰" class="headerlink" title="é˜¶æ®µ 2ï¼šæ ¸å¿ƒæ¦‚å¿µæ·±åŒ–ï¼ˆå»ºç«‹ç¼–ç¨‹æ€ç»´ï¼‰"></a>é˜¶æ®µ 2ï¼šæ ¸å¿ƒæ¦‚å¿µæ·±åŒ–ï¼ˆå»ºç«‹ç¼–ç¨‹æ€ç»´ï¼‰</h3><p><strong>å­¦ä¹ é‡ç‚¹</strong>ï¼šé¢å‘å¯¹è±¡ç¼–ç¨‹ã€å¼‚å¸¸å¤„ç†ã€æ–‡ä»¶æ“ä½œã€æ ‡å‡†åº“</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šé¢å‘å¯¹è±¡+å¼‚å¸¸å¤„ç†çš„ç»¼åˆåº”ç”¨</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å­¦ç”Ÿç®¡ç†ç±»ï¼Œå¤„ç†å­¦ç”Ÿæ•°æ®çš„å¢åˆ æ”¹æŸ¥&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_file=<span class="string">&#x27;students.json&#x27;</span></span>):</span><br><span class="line">        self.data_file = Path(data_file)</span><br><span class="line">        self.students = self._load_data()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_load_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŠ è½½å­¦ç”Ÿæ•°æ®ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºç©ºæ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self.data_file.exists():</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(self.data_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">return</span> json.load(f)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;åŠ è½½æ•°æ®å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_save_data</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä¿å­˜å­¦ç”Ÿæ•°æ®åˆ°æ–‡ä»¶&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.data_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                json.dump(self.students, f, indent=<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;ä¿å­˜æ•°æ®å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_student</span>(<span class="params">self, name, age, grade</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ·»åŠ å­¦ç”Ÿ&quot;&quot;&quot;</span></span><br><span class="line">        student = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: <span class="built_in">len</span>(self.students) + <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">            <span class="string">&#x27;age&#x27;</span>: age,</span><br><span class="line">            <span class="string">&#x27;grade&#x27;</span>: grade</span><br><span class="line">        &#125;</span><br><span class="line">        self.students.append(student)</span><br><span class="line">        self._save_data()</span><br><span class="line">        <span class="keyword">return</span> student</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_all_students</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è·å–æ‰€æœ‰å­¦ç”Ÿ&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.students</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">manager = StudentManager()</span><br><span class="line">manager.add_student(<span class="string">&quot;å¼ ä¸‰&quot;</span>, <span class="number">18</span>, <span class="string">&quot;A&quot;</span>)</span><br><span class="line">manager.add_student(<span class="string">&quot;æå››&quot;</span>, <span class="number">19</span>, <span class="string">&quot;B&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(manager.get_all_students())</span><br></pre></td></tr></table></figure><p><strong>é˜¶æ®µç»ƒä¹ </strong>ï¼š</p><ol><li>å®ç°ä¸€ä¸ªå›¾ä¹¦ç®¡ç†ç³»ç»Ÿï¼ˆç±»è®¾è®¡+æ–‡ä»¶æŒä¹…åŒ–ï¼‰</li><li>ç¼–å†™æ—¥å¿—åˆ†æå·¥å…·ï¼ˆæ­£åˆ™è¡¨è¾¾å¼+æ–‡ä»¶æ“ä½œï¼‰</li><li>åˆ¶ä½œå¤©æ°”æ•°æ®çˆ¬å–å’Œåˆ†æè„šæœ¬ï¼ˆrequests åº“+æ•°æ®å¤„ç†ï¼‰</li></ol><h3 id="é˜¶æ®µ-3ï¼šWeb-å¼€å‘åŸºç¡€ï¼ˆè¿›å…¥-Web-ä¸–ç•Œï¼‰"><a href="#é˜¶æ®µ-3ï¼šWeb-å¼€å‘åŸºç¡€ï¼ˆè¿›å…¥-Web-ä¸–ç•Œï¼‰" class="headerlink" title="é˜¶æ®µ 3ï¼šWeb å¼€å‘åŸºç¡€ï¼ˆè¿›å…¥ Web ä¸–ç•Œï¼‰"></a>é˜¶æ®µ 3ï¼šWeb å¼€å‘åŸºç¡€ï¼ˆè¿›å…¥ Web ä¸–ç•Œï¼‰</h3><p><strong>æŠ€æœ¯æ ˆé€‰æ‹©</strong>ï¼š<strong>Flask</strong>ï¼ˆè½»é‡ã€æ˜“å­¦ã€åŠŸèƒ½å®Œæ•´ï¼‰ä½œä¸ºå…¥é—¨æ¡†æ¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šFlaskåŸºç¡€åº”ç”¨</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect, url_for</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨</span></span><br><span class="line">students = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;é¦–é¡µï¼Œæ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿ&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, students=students)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/add&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_student</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ·»åŠ å­¦ç”Ÿé¡µé¢&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        name = request.form.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        age = request.form.get(<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line">        grade = request.form.get(<span class="string">&#x27;grade&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">and</span> age <span class="keyword">and</span> grade:</span><br><span class="line">            student = &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: <span class="built_in">len</span>(students) + <span class="number">1</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">                <span class="string">&#x27;age&#x27;</span>: <span class="built_in">int</span>(age),</span><br><span class="line">                <span class="string">&#x27;grade&#x27;</span>: grade</span><br><span class="line">            &#125;</span><br><span class="line">            students.append(student)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;add.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/delete/&lt;int:student_id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_student</span>(<span class="params">student_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ é™¤å­¦ç”Ÿ&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> students</span><br><span class="line">    students = [s <span class="keyword">for</span> s <span class="keyword">in</span> students <span class="keyword">if</span> s[<span class="string">&#x27;id&#x27;</span>] != student_id]</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p><strong>HTML æ¨¡æ¿ç¤ºä¾‹</strong>ï¼ˆtemplates&#x2F;index.htmlï¼‰ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">table</span> &#123; <span class="attribute">border-collapse</span>: collapse; <span class="attribute">width</span>: <span class="number">100%</span>; &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">th</span>, <span class="selector-tag">td</span> &#123; <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ddd</span>; <span class="attribute">padding</span>: <span class="number">8px</span>; <span class="attribute">text-align</span>: left; &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">th</span> &#123; <span class="attribute">background-color</span>: <span class="number">#f2f2f2</span>; &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.delete-btn</span> &#123; <span class="attribute">color</span>: red; <span class="attribute">text-decoration</span>: none; &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>å­¦ç”Ÿåˆ—è¡¨<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;add_student&#x27;) &#125;&#125;&quot;</span>&gt;</span>æ·»åŠ å­¦ç”Ÿ<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>ID<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>å§“å<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>å¹´é¾„<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>ç­‰çº§<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>æ“ä½œ<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">            &#123;% for student in students %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; student.id &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; student.name &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; student.age &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123; student.grade &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;delete_student&#x27;, student_id=student.id) &#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;delete-btn&quot;</span>&gt;</span>åˆ é™¤<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>é˜¶æ®µç»ƒä¹ </strong>ï¼š</p><ol><li>å®ç°ä¸€ä¸ªå¾…åŠäº‹é¡¹åˆ—è¡¨ï¼ˆTodo Listï¼‰</li><li>åˆ›å»ºä¸ªäººåšå®¢ç³»ç»Ÿï¼ˆæ–‡ç« åˆ—è¡¨+è¯¦æƒ…é¡µï¼‰</li><li>åˆ¶ä½œç”¨æˆ·æ³¨å†Œç™»å½•é¡µé¢ï¼ˆè¡¨å•å¤„ç†+ä¼šè¯ç®¡ç†ï¼‰</li></ol><h3 id="é˜¶æ®µ-4ï¼šæ•°æ®åº“é›†æˆï¼ˆæŒä¹…åŒ–æ•°æ®ï¼‰"><a href="#é˜¶æ®µ-4ï¼šæ•°æ®åº“é›†æˆï¼ˆæŒä¹…åŒ–æ•°æ®ï¼‰" class="headerlink" title="é˜¶æ®µ 4ï¼šæ•°æ®åº“é›†æˆï¼ˆæŒä¹…åŒ–æ•°æ®ï¼‰"></a>é˜¶æ®µ 4ï¼šæ•°æ®åº“é›†æˆï¼ˆæŒä¹…åŒ–æ•°æ®ï¼‰</h3><p><strong>æŠ€æœ¯æ ˆ</strong>ï¼šFlask + SQLAlchemyï¼ˆORMï¼‰+ SQLiteï¼ˆå¼€å‘ç¯å¢ƒï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šæ•°æ®åº“é›†æˆ</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect, url_for</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///students.db&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ•°æ®æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">100</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    age = db.Column(db.Integer, nullable=<span class="literal">False</span>)</span><br><span class="line">    grade = db.Column(db.String(<span class="number">10</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;&lt;Student <span class="subst">&#123;self.name&#125;</span>&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®åº“è¡¨</span></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    db.create_all()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    students = Student.query.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, students=students)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/add&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_student</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        name = request.form.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        age = request.form.get(<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line">        grade = request.form.get(<span class="string">&#x27;grade&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">and</span> age <span class="keyword">and</span> grade:</span><br><span class="line">            new_student = Student(</span><br><span class="line">                name=name,</span><br><span class="line">                age=<span class="built_in">int</span>(age),</span><br><span class="line">                grade=grade</span><br><span class="line">            )</span><br><span class="line">            db.session.add(new_student)</span><br><span class="line">            db.session.commit()</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;add.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/edit/&lt;int:id&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_student</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    student = Student.query.get_or_404(<span class="built_in">id</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        student.name = request.form.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        student.age = <span class="built_in">int</span>(request.form.get(<span class="string">&#x27;age&#x27;</span>))</span><br><span class="line">        student.grade = request.form.get(<span class="string">&#x27;grade&#x27;</span>)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;edit.html&#x27;</span>, student=student)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/delete/&lt;int:id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_student</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    student = Student.query.get_or_404(<span class="built_in">id</span>)</span><br><span class="line">    db.session.delete(student)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p><strong>é˜¶æ®µç»ƒä¹ </strong>ï¼š</p><ol><li>é‡æ„ä¹‹å‰çš„å¾…åŠäº‹é¡¹åº”ç”¨ï¼Œä½¿ç”¨æ•°æ®åº“å­˜å‚¨</li><li>å®ç°åšå®¢ç³»ç»Ÿçš„æ–‡ç« ç®¡ç†åŠŸèƒ½ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰</li><li>åˆ›å»ºç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼ˆæ³¨å†Œã€ç™»å½•ã€ä¼šè¯ç®¡ç†ï¼‰</li></ol><h3 id="é˜¶æ®µ-5ï¼šå®Œæ•´-CRUD-é¡¹ç›®å®æˆ˜ï¼ˆå­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿï¼‰"><a href="#é˜¶æ®µ-5ï¼šå®Œæ•´-CRUD-é¡¹ç›®å®æˆ˜ï¼ˆå­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿï¼‰" class="headerlink" title="é˜¶æ®µ 5ï¼šå®Œæ•´ CRUD é¡¹ç›®å®æˆ˜ï¼ˆå­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿï¼‰"></a>é˜¶æ®µ 5ï¼šå®Œæ•´ CRUD é¡¹ç›®å®æˆ˜ï¼ˆå­¦ç”Ÿæˆç»©ç®¡ç†ç³»ç»Ÿï¼‰</h3><p><strong>é¡¹ç›®æ¶æ„</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">student_management/</span><br><span class="line">â”œâ”€â”€ app.py                  # ä¸»åº”ç”¨æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ config.py               # é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ models.py               # æ•°æ®æ¨¡å‹</span><br><span class="line">â”œâ”€â”€ routes/                 # è·¯ç”±æ¨¡å—</span><br><span class="line">â”‚   â”œâ”€â”€ __init__.py</span><br><span class="line">â”‚   â”œâ”€â”€ auth.py            # è®¤è¯è·¯ç”±</span><br><span class="line">â”‚   â”œâ”€â”€ students.py        # å­¦ç”Ÿç®¡ç†è·¯ç”±</span><br><span class="line">â”‚   â””â”€â”€ grades.py          # æˆç»©ç®¡ç†è·¯ç”±</span><br><span class="line">â”œâ”€â”€ templates/              # HTMLæ¨¡æ¿</span><br><span class="line">â”‚   â”œâ”€â”€ base.html          # åŸºç¡€æ¨¡æ¿</span><br><span class="line">â”‚   â”œâ”€â”€ auth/</span><br><span class="line">â”‚   â”œâ”€â”€ students/</span><br><span class="line">â”‚   â””â”€â”€ grades/</span><br><span class="line">â”œâ”€â”€ static/                 # é™æ€æ–‡ä»¶</span><br><span class="line">â”‚   â”œâ”€â”€ css/</span><br><span class="line">â”‚   â”œâ”€â”€ js/</span><br><span class="line">â”‚   â””â”€â”€ images/</span><br><span class="line">â”œâ”€â”€ requirements.txt        # ä¾èµ–åŒ…</span><br><span class="line">â””â”€â”€ instance/</span><br><span class="line">    â””â”€â”€ config.py           # å®ä¾‹é…ç½®</span><br></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒä»£ç ç¤ºä¾‹</strong>ï¼ˆapp.pyï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect, url_for, flash, session</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> werkzeug.security <span class="keyword">import</span> generate_password_hash, check_password_hash</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = os.urandom(<span class="number">24</span>)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///student_management.db&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    password = db.Column(db.String(<span class="number">120</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    is_admin = db.Column(db.Boolean, default=<span class="literal">False</span>)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">100</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    age = db.Column(db.Integer, nullable=<span class="literal">False</span>)</span><br><span class="line">    class_name = db.Column(db.String(<span class="number">50</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line">    grades = db.relationship(<span class="string">&#x27;Grade&#x27;</span>, backref=<span class="string">&#x27;student&#x27;</span>, lazy=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Grade</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    student_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;student.id&#x27;</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    subject = db.Column(db.String(<span class="number">50</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    score = db.Column(db.Float, nullable=<span class="literal">False</span>)</span><br><span class="line">    semester = db.Column(db.String(<span class="number">20</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–æ•°æ®åº“</span></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    db.create_all()</span><br><span class="line">    <span class="comment"># åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> User.query.filter_by(username=<span class="string">&#x27;admin&#x27;</span>).first():</span><br><span class="line">        admin = User(</span><br><span class="line">            username=<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">            password=generate_password_hash(<span class="string">&#x27;admin123&#x27;</span>),</span><br><span class="line">            is_admin=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        db.session.add(admin)</span><br><span class="line">        db.session.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·¯ç”±è£…é¥°å™¨</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;user_id&#x27;</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;home.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/dashboard&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dashboard</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;user_id&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    total_students = Student.query.count()</span><br><span class="line">    total_grades = Grade.query.count()</span><br><span class="line">    avg_score = db.session.query(db.func.avg(Grade.score)).scalar() <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;dashboard.html&#x27;</span>, </span><br><span class="line">                         total_students=total_students,</span><br><span class="line">                         total_grades=total_grades,</span><br><span class="line">                         avg_score=<span class="built_in">round</span>(avg_score, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¤è¯ç›¸å…³è·¯ç”±</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        user = User.query.filter_by(username=username).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">and</span> check_password_hash(user.password, password):</span><br><span class="line">            session[<span class="string">&#x27;user_id&#x27;</span>] = user.<span class="built_in">id</span></span><br><span class="line">            session[<span class="string">&#x27;username&#x27;</span>] = user.username</span><br><span class="line">            session[<span class="string">&#x27;is_admin&#x27;</span>] = user.is_admin</span><br><span class="line">            flash(<span class="string">&#x27;ç™»å½•æˆåŠŸï¼&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flash(<span class="string">&#x27;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;auth/login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session.clear()</span><br><span class="line">    flash(<span class="string">&#x27;å·²æˆåŠŸé€€å‡ºï¼&#x27;</span>, <span class="string">&#x27;info&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;home&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­¦ç”Ÿç®¡ç†è·¯ç”±</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/students&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">student_list</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;user_id&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    students = Student.query.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;students/list.html&#x27;</span>, students=students)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/students/add&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_student</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;user_id&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        name = request.form.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        age = request.form.get(<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line">        class_name = request.form.get(<span class="string">&#x27;class_name&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">and</span> age <span class="keyword">and</span> class_name:</span><br><span class="line">            new_student = Student(</span><br><span class="line">                name=name,</span><br><span class="line">                age=<span class="built_in">int</span>(age),</span><br><span class="line">                class_name=class_name</span><br><span class="line">            )</span><br><span class="line">            db.session.add(new_student)</span><br><span class="line">            db.session.commit()</span><br><span class="line">            flash(<span class="string">&#x27;å­¦ç”Ÿæ·»åŠ æˆåŠŸï¼&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;student_list&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flash(<span class="string">&#x27;è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;students/add.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆç»©ç®¡ç†è·¯ç”±</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/grades/&lt;int:student_id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">student_grades</span>(<span class="params">student_id</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;user_id&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    student = Student.query.get_or_404(student_id)</span><br><span class="line">    grades = Grade.query.filter_by(student_id=student_id).<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;grades/list.html&#x27;</span>, student=student, grades=grades)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2 id="å››ã€å­¦ä¹ èµ„æºæ¨è"><a href="#å››ã€å­¦ä¹ èµ„æºæ¨è" class="headerlink" title="å››ã€å­¦ä¹ èµ„æºæ¨è"></a>å››ã€å­¦ä¹ èµ„æºæ¨è</h2><h3 id="åŸºç¡€å­¦ä¹ "><a href="#åŸºç¡€å­¦ä¹ " class="headerlink" title="åŸºç¡€å­¦ä¹ "></a>åŸºç¡€å­¦ä¹ </h3><ul><li><strong>å®˜æ–¹æ–‡æ¡£</strong>ï¼šPython å®˜æ–¹æ•™ç¨‹ã€Flask å®˜æ–¹æ–‡æ¡£</li><li><strong>ä¹¦ç±</strong>ï¼šã€ŠPython Crash Courseã€‹ã€ã€ŠFlask Web Developmentã€‹</li><li><strong>è§†é¢‘è¯¾ç¨‹</strong>ï¼šCorey Schafer çš„ Python å’Œ Flask ç³»åˆ—ï¼ˆYouTubeï¼‰</li></ul><h3 id="é¡¹ç›®å®æˆ˜"><a href="#é¡¹ç›®å®æˆ˜" class="headerlink" title="é¡¹ç›®å®æˆ˜"></a>é¡¹ç›®å®æˆ˜</h3><ul><li><strong>GitHub é¡¹ç›®</strong>ï¼š<ul><li>æœç´¢å…³é”®è¯ï¼š<code>python flask crud tutorial</code></li><li>ä¼˜ç§€é¡¹ç›®ï¼š<code>flask-realworld-example-app</code></li></ul></li><li><strong>åœ¨çº¿ç»ƒä¹ å¹³å°</strong>ï¼š<ul><li>LeetCodeï¼ˆç®—æ³•åŸºç¡€ï¼‰</li><li>HackerRankï¼ˆPython ä¸“é¡¹ï¼‰</li><li>FreeCodeCampï¼ˆWeb å¼€å‘é¡¹ç›®ï¼‰</li></ul></li></ul><h3 id="è¿›é˜¶å­¦ä¹ "><a href="#è¿›é˜¶å­¦ä¹ " class="headerlink" title="è¿›é˜¶å­¦ä¹ "></a>è¿›é˜¶å­¦ä¹ </h3><ul><li><strong>éƒ¨ç½²</strong>ï¼šDockerã€Nginxã€Gunicorn</li><li><strong>å‰ç«¯</strong>ï¼šBootstrapã€Vue.js&#x2F;React åŸºç¡€</li><li><strong>æµ‹è¯•</strong>ï¼špytestã€unittest</li><li><strong>æ€§èƒ½</strong>ï¼šRedis ç¼“å­˜ã€æ•°æ®åº“ä¼˜åŒ–</li></ul><h2 id="äº”ã€å­¦ä¹ å»ºè®®ä¸é¿å‘æŒ‡å—"><a href="#äº”ã€å­¦ä¹ å»ºè®®ä¸é¿å‘æŒ‡å—" class="headerlink" title="äº”ã€å­¦ä¹ å»ºè®®ä¸é¿å‘æŒ‡å—"></a>äº”ã€å­¦ä¹ å»ºè®®ä¸é¿å‘æŒ‡å—</h2><h3 id="âœ…-æ­£ç¡®å­¦ä¹ æ–¹æ³•"><a href="#âœ…-æ­£ç¡®å­¦ä¹ æ–¹æ³•" class="headerlink" title="âœ… æ­£ç¡®å­¦ä¹ æ–¹æ³•"></a>âœ… æ­£ç¡®å­¦ä¹ æ–¹æ³•</h3><ol><li><strong>é¡¹ç›®é©±åŠ¨å­¦ä¹ </strong>ï¼šæ¯ä¸ªé˜¶æ®µéƒ½è¦åšå¯¹åº”çš„é¡¹ç›®</li><li><strong>ä»£ç é‡æ„</strong>ï¼šå…ˆè®©ä»£ç å·¥ä½œï¼Œå†è®©ä»£ç ä¼˜é›…</li><li><strong>ç‰ˆæœ¬æ§åˆ¶</strong>ï¼šä»ç¬¬ä¸€å¤©å¼€å§‹ä½¿ç”¨ Git</li><li><strong>æ–‡æ¡£ä¹ æƒ¯</strong>ï¼šä¸ºæ¯ä¸ªå‡½æ•°å†™ docstringï¼Œä¸ºé¡¹ç›®å†™ README</li></ol><h3 id="âŒ-å¸¸è§è¯¯åŒº"><a href="#âŒ-å¸¸è§è¯¯åŒº" class="headerlink" title="âŒ å¸¸è§è¯¯åŒº"></a>âŒ å¸¸è§è¯¯åŒº</h3><ol><li><strong>è¿½æ±‚å®Œç¾</strong>ï¼šä¸è¦ä¸€å¼€å§‹å°±è¿½æ±‚æœ€ä½³å®è·µï¼Œå…ˆå®Œæˆå†å®Œå–„</li><li><strong>è¿‡åº¦è®¾è®¡</strong>ï¼šå°é¡¹ç›®ä¸éœ€è¦å¤æ‚çš„æ¶æ„è®¾è®¡</li><li><strong>ä¾èµ–æ•™ç¨‹</strong>ï¼šæ•™ç¨‹æ˜¯æ‹æ–ï¼Œè¦å­¦ä¼šç‹¬ç«‹æ€è€ƒå’Œè§£å†³é—®é¢˜</li><li><strong>å¿½è§†æµ‹è¯•</strong>ï¼šæµ‹è¯•æ˜¯ä¿è¯ä»£ç è´¨é‡çš„å…³é”®</li></ol><h3 id="ğŸš€-åŠ é€Ÿå­¦ä¹ æŠ€å·§"><a href="#ğŸš€-åŠ é€Ÿå­¦ä¹ æŠ€å·§" class="headerlink" title="ğŸš€ åŠ é€Ÿå­¦ä¹ æŠ€å·§"></a>ğŸš€ åŠ é€Ÿå­¦ä¹ æŠ€å·§</h3><ol><li><strong>è´¹æ›¼å­¦ä¹ æ³•</strong>ï¼šå­¦å®Œä¸€ä¸ªæ¦‚å¿µåï¼Œå°è¯•ç”¨è‡ªå·±çš„è¯è§£é‡Šç»™åˆ«äººå¬</li><li><strong>20%åŸåˆ™</strong>ï¼š80%çš„åŠŸèƒ½æ¥è‡ª 20%çš„æ ¸å¿ƒç‰¹æ€§ï¼Œå…ˆæŒæ¡æ ¸å¿ƒ</li><li><strong>ç¤¾åŒºå‚ä¸</strong>ï¼šåœ¨ Stack Overflow å›ç­”é—®é¢˜ï¼Œåœ¨ GitHub æäº¤ PR</li><li><strong>å¤ç›˜æ€»ç»“</strong>ï¼šæ¯å‘¨æ€»ç»“å­¦åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œå»ºç«‹çŸ¥è¯†ä½“ç³»</li></ol><h2 id="å…­ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®"><a href="#å…­ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®" class="headerlink" title="å…­ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®"></a>å…­ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®</h2><p><strong>ç¬¬ 1 å‘¨</strong>ï¼šå®Œæˆé˜¶æ®µ 1-2 çš„å­¦ä¹ ï¼Œå®ç°ä¸€ä¸ªå‘½ä»¤è¡Œç‰ˆçš„å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ<br><strong>ç¬¬ 2 å‘¨</strong>ï¼šå­¦ä¹  Flask åŸºç¡€ï¼Œå®ç°ä¸€ä¸ªé™æ€çš„ç½‘é¡µç‰ˆå­¦ç”Ÿåˆ—è¡¨<br><strong>ç¬¬ 3 å‘¨</strong>ï¼šé›†æˆæ•°æ®åº“ï¼Œå®ç°å­¦ç”Ÿä¿¡æ¯çš„å¢åˆ æ”¹æŸ¥<br><strong>ç¬¬ 4 å‘¨</strong>ï¼šå®Œå–„é¡¹ç›®ï¼Œæ·»åŠ ç”¨æˆ·è®¤è¯ã€æˆç»©ç®¡ç†ã€æŠ¥è¡¨ç»Ÿè®¡ç­‰åŠŸèƒ½</p><p><strong>å…³é”®è¡ŒåŠ¨</strong>ï¼š</p><ol><li>ä»Šå¤©å°±åœ¨ GitHub åˆ›å»ºä¸€ä¸ªä»“åº“ï¼Œå‘½åä¸º<code>python-learning-path</code></li><li>ä»é˜¶æ®µ 1 å¼€å§‹ï¼Œæ¯å¤©æäº¤ä»£ç ï¼Œè®°å½•å­¦ä¹ å¿ƒå¾—</li><li>åŠ å…¥ä¸€ä¸ª Python å­¦ä¹ ç¾¤ï¼Œæ‰¾åˆ°å­¦ä¹ ä¼™ä¼´</li><li>æ¯å®Œæˆä¸€ä¸ªé˜¶æ®µï¼Œå†™ä¸€ç¯‡æŠ€æœ¯åšå®¢æ€»ç»“</li></ol><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>å­¦ä¹ ç¼–ç¨‹å°±åƒå»ºé€ æˆ¿å­ï¼šè¯­æ³•æ˜¯ç –å—ï¼Œç®—æ³•æ˜¯è®¾è®¡å›¾ï¼Œé¡¹ç›®ç»éªŒæ˜¯æ–½å·¥ç»éªŒã€‚æœ¬æ–‡æä¾›çš„è·¯å¾„ç»è¿‡å¤§é‡å¼€å‘è€…éªŒè¯ï¼Œå…³é”®åœ¨äº<strong>æŒç»­è¡ŒåŠ¨</strong>ã€‚</p><p>è®°ä½ï¼š<strong>æ¯ä¸ªå¤æ‚çš„ç³»ç»Ÿéƒ½æ˜¯ç”±ç®€å•çš„ç»„ä»¶æ„æˆçš„</strong>ã€‚å½“ä½ è§‰å¾—å›°éš¾æ—¶ï¼ŒæŠŠé—®é¢˜æ‹†è§£åˆ°è¶³å¤Ÿå°ï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªè§£å†³ã€‚</p><blockquote><p><strong>æœ€åä¸€å¥å¿ å‘Š</strong>ï¼šä¸è¦ç­‰å¾…â€å®Œç¾æ—¶æœºâ€å¼€å§‹é¡¹ç›®ã€‚ä»Šå¤©ç”¨æœ€ç®€å•çš„ä»£ç å®ç°æœ€åŸºç¡€çš„åŠŸèƒ½ï¼Œæ˜å¤©å†é€æ­¥å®Œå–„ã€‚å®Œæˆæ¯”å®Œç¾æ›´é‡è¦ã€‚</p></blockquote><p><strong>ä½ çš„ä¸‹ä¸€æ­¥</strong>ï¼šç°åœ¨å°±æ‰“å¼€ç¼–è¾‘å™¨ï¼Œåˆ›å»ºç¬¬ä¸€ä¸ª Python æ–‡ä»¶ï¼Œå†™ä¸‹<code>print(&quot;Hello, World!&quot;)</code>ï¼Œç„¶åå¼€å§‹ä½ çš„ç³»ç»Ÿæ€§å­¦ä¹ ä¹‹æ—…ï¼</p><hr><h3 id="ğŸ”—å¼•ç”¨èµ„æºï¼šPython-è¯­æ³•æŒ‡å¯¼å¤§å…¨-Quick-Reference"><a href="#ğŸ”—å¼•ç”¨èµ„æºï¼šPython-è¯­æ³•æŒ‡å¯¼å¤§å…¨-Quick-Reference" class="headerlink" title="ğŸ”—å¼•ç”¨èµ„æºï¼šPython è¯­æ³•æŒ‡å¯¼å¤§å…¨(Quick Reference)"></a>ğŸ”—å¼•ç”¨èµ„æºï¼šPython è¯­æ³•æŒ‡å¯¼å¤§å…¨(Quick Reference)</h3><p><a href="https://ref.wdft.com/">Python Quick Reference</a></p>]]></content>
    
    
    <summary type="html">&lt;!-- toc --&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒè§‚ç‚¹&lt;/strong&gt;ï¼šå­¦ä¹ ç¼–ç¨‹ä¸æ˜¯ä¸ºäº†æŒæ¡è¯­æ³•ï¼Œè€Œæ˜¯ä¸ºäº†åˆ›é€ ä»·å€¼ã€‚æœ¬æ–‡æä¾›ä¸€æ¡æ¸…æ™°çš„å­¦ä¹ è·¯å¾„ï¼Œè®©ä½ ä» Python åŸºç¡€è¯­æ³•èµ·æ­¥ï¼Œæœ€ç»ˆèƒ½å¤Ÿç‹¬ç«‹å¼€å‘å®Œæ•´çš„ Web CRUD åº”ç”¨ã€‚&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="python" scheme="https://www.wdft.com/categories/python/"/>
    
    
    <category term="Tutorial" scheme="https://www.wdft.com/tags/Tutorial/"/>
    
    <category term="python" scheme="https://www.wdft.com/tags/python/"/>
    
  </entry>
  
</feed>
